Draft version September 14, 2018
Typeset using LATEX twocolumn style in AASTeX61

CASTING THE CORONAL MAGNETIC FIELD RECONSTRUCTION TOOLS IN 3D USING MHD BIFROST
MODEL

Gregory Fleishman1, Sergey Anfinogentov2, Maria Loukitcheva1,3,4, Ivan Mysh’yakov2, and
Alexey Stupishin3∗

(Accepted September 14, 2018)

ABSTRACT

Quantifying coronal magnetic ﬁeld remains a central problem in solar physics. Nowadays the coronal magnetic ﬁeld
is often modelled using nonlinear force-free ﬁeld (NLFFF) reconstructions, whose accuracy has not yet been compre-
hensively assessed. Here we perform a detailed casting of the NLFFF reconstruction tools, such as π-disambiguation,
photospheric ﬁeld preprocessing, and volume reconstruction methods using a 3D snapshot of the publicly available full-
ﬂedged radiative MHD model. Speciﬁcally, from the MHD model we know the magnetic ﬁeld vector in the entire 3D
domain, which enables us to perform ”voxel-by-voxel” comparison of the restored and the true magnetic ﬁeld in the 3D
model volume. Our tests show that the available π-disambiguation methods often fail at the quiet sun areas dominated
by small-scale magnetic elements, while they work well at the AR photosphere and (even better) chromosphere. The
preprocessing of the photospheric magnetic ﬁeld, although does produce a more force-free boundary condition, also
results in some eﬀective ‘elevation’ of the magnetic ﬁeld components. This ‘elevation’ height is diﬀerent for the longitu-
dinal and transverse components, which results in a systematic error in absolute heights in the reconstructed magnetic
data cube. The extrapolations performed starting from actual AR photospheric magnetogram are free from this sys-
tematic error, while have other metrics comparable with those for extrapolations from the preprocessed magnetograms.
This ﬁnding favors the use of extrapolations from the original photospheric magnetogram without preprocessing. Our
tests further suggest that extrapolations from a force-free chromospheric boundary produce measurably better results,
than those from the photospheric boundary.

Keywords: Sun: magnetic ﬁelds—Sun:

corona—Sun:

chromosphere—Sun: photosphere—Sun:

general—magnetohydrodynamics (MHD)

8
1
0
2

p
e
S
3
1

]

R
S
.
h
p
-
o
r
t
s
a
[

3
v
0
6
3
6
0
.
3
0
7
1
:
v
i
X
r
a

∗ 1Physics Department, Center for Solar-Terrestrial Research, New Jersey Institute of Technology Newark, NJ, 07102-1982

2Institute of Solar-Terrestrial Physics (ISZF), Lermontov st., 126a, Irkutsk, 664033 Russia
3Saint Petersburg State University, 7/9 Universitetskaya nab., St. Petersburg, 199034 Russia
4Max-Planck-Institut f¨ur Sonnensystemforschung, Justus-von-Liebig-Weg 3, 37077 G¨ottingen, Germany

 
 
 
 
 
 
2

Fleishman et al.

1. INTRODUCTION

The magnetic structure of the solar corona plays a key
role in all of the solar activity, yet direct measurements
of the coronal magnetic ﬁeld are extremely diﬃcult to
make. Instead, the ﬁeld strength and direction are mea-
sured at the photospheric (or possibly chromospheric)
boundary; speciﬁcally, the vector ﬁelds are measured
from full-Stokes polarized intensity of Zeeman sensitive
spectral lines with circular polarization providing line-
of-sight ﬁeld strength and linear polarization providing
the transverse ﬁeld. Then, to assess the coronal mag-
netic ﬁeld, these measured photospheric ﬁelds are ex-
tended into the corona through potential or force-free
ﬁeld extrapolations. Starting with Sakurai (1981), these
extrapolations have reached nowadays a high level of so-
phistication (see reviews by Sakurai 1989; Amari et al.
1997; Wiegelmann 2008; Wiegelmann & Sakurai 2012;
Wiegelmann et al. 2014).

Although most of the extrapolation methods work
well on reproducing available analytical NLFFF solu-
tions (e.g., Low & Lou 1990), which are static and rel-
atively simple morphologically, the assessment of the
methods on realistic dynamical cases having a lot of
spatial complexity is still limited (De Rosa et al. 2009).
Since a straightforward ’voxel-by-voxel’ comparison be-
tween the NLFFF reconstructed data cube and real data
cannot be performed given the lack of the coronal mag-
netic ﬁeld diagnostics, a number of indirect tests is typ-
ically employed. These can be comparison of a subset
of a selected magnetic ﬁeld lines with the EUV loops
or computing various metrics describing the ﬁeld ‘force-
freeness’. However, comparison with the bright EUV
loops allows for only a morphological comparison and
only for a small fraction of the volume, where such loops
are present, but does not allow quantitative assessment
of the magnetic ﬁeld vector components. Force-free met-
rics computed for various instances of the extrapolated
data cubes are comparably imperfect and, thus, they do
not oﬀer an easy way of favoring one or another ex-
trapolation method. DeRosa et al. (2015) considered
the eﬀect of the spatial resolution of the base mag-
netogram on the quality of the coronal magnetic ﬁeld
reconstruction with alternative extrapolation methods.
They found that the result of an extrapolation is sensi-
tive to the spatial resolution of the input base map and
the alternative codes yield noticeably diﬀerent magnetic
data cubes. Thus, the casting of the competing extrap-
olation methods using available coronal diagnostics re-
mains inconclusive, since no true comparison of the re-
constructed and real magnetic ﬁeld can be performed
in 3D domain. Nevertheless, direct tests of the NLFFF
coronal reconstruction tool performance with the use of

modern, highly realistic spatially complex 3-dimensional
(3D) MHD models of a fragment of solar atmosphere can
be performed and, thus, are called for.

In this study we employ a publicly available outcome

(en024048 hion, http://sdc.uio.no/search/simulations,
Carlsson et al. 2016) of an advanced 3D radiation mag-
netohydrodynamic (RMHD) code Bifrost (Gudiksen et al.
2011)
to perform comprehensive tests of various
steps used for the coronal magnetic modeling: (i) π-
disambiguation of the measured transverse magnetic
ﬁeld; (ii) preprocessing of the photospheric magnetic
ﬁeld; and (iii) NLFFF extrapolation from the bottom
boundary up to the coronal volume.
In each step we
make a comparison between available alternative codes:
either two diﬀerent methods or two alternative imple-
mentations of the same methods for the steps mentioned
above.

2. RMHD MODEL DATA CUBE

Bifrost is a ﬂexible and massively parallel code for gen-
eral purposes developed by Gudiksen et al. (2011). The
Bifrost-based RMHD Model of Carlsson et al. (2016),
en024048 hion, represents realistic simulations of the
solar outer atmosphere with a magnetic ﬁeld topology
similar to an enhanced network area on the Sun. The
simulation data cubes used in this work were obtained
from the Hinode Science Data Centre Europe for the
publicly available timespan of 1590 s.

2.1. Overview of the Data Cube

The simulation covers a physical extent of 24 × 24 × 16.8 Mm,

with a grid of 504 × 504 × 496 cells, extending from
–2.4 Mm below the photosphere, which corresponds to
Z = 0 Mm, to 14.4 Mm above the photosphere.
It
encompasses the upper convection zone, photosphere,
chromosphere, and the lower corona. The horizontal
axes have an equidistant grid spacing of 48 km, the
vertical grid spacing is non-uniform, with a spacing of
19 km between Z = −1 Mm and Z = 5 Mm. The
spacing increases toward the top of the computational
domain to a maximum of 98 km. The magnetic topology
is deﬁned by two opposite polarity patches separated by
8 Mm with an average unsigned strength of ∼50 G in
the photosphere, representing two patches of quiet-Sun
network. The simulation includes optically thick radia-
tive transfer in the photosphere and low chromosphere,
parameterized radiative losses in the upper chromo-
sphere, transition region and corona, thermal conduc-
tion along magnetic ﬁeld lines, and an equation of state
that includes the eﬀects of non-equilibrium ionization
of hydrogen. The Bifrost code solves the equations of
resistive MHD on a staggered Cartesian grid but the

NLFFF–MHD CASTING

3

published data cubes for en024048 hion have the vari-
ables speciﬁed at the cell centers.

One of the simulation snapshots, the snapshot 385,
has already been used in a series of papers to investigate
the formation of the IRIS diagnostics (Leenaarts et al.
2013a,b; Pereira et al. 2013, 2015; Rathore & Carlsson
2015; Rathore et al. 2015; Lin & Carlsson 2015), the
formation of other chromospheric lines (Leenaarts et al.
2012, 2015; de la Cruz Rodr´ıguez et al. 2013; ˇStˇep´an et al.
2012, 2015), as well as to model continuum free-free
emission from solar chromosphere (Loukitcheva et al.
2015a) with the perspective of ALMA observations
(Loukitcheva et al. 2015b, 2017).

As has been said, the available en024048 hion data
cubes are speciﬁed on a nonuniform grid in the verti-
cal direction, although most of the NLFFF approaches
employ a regular grid, which has a number of computa-
tional advances including uniform precision of the spa-
In order to make the en024048 hion
tial derivatives.
model compatible with the extrapolated data cubes, the
original model grid was transformed to a uniform grid
(with 48 km step along all three axes) by applying linear
interpolation in vertical direction.

Given that the applicability of the force-free magnetic
modeling relies on the dominant role of the Lorentz force
in the overall balance of forces, we start with analysis of
height distribution of the plasma parameter β = pkin/pB
in the model volume. In Figure 1 we plot the range of
the β values as a function of the model height using the
original nonuniform grid and demarcate a number of
characteristic levels for further references. Level H = 0
corresponds to the nominal photosphere in the model
data cube. Since the model has been created to describe
an enhanced network of the quiet sun, rather than a typ-
ical AR, the β values at the level of the nominal photo-
sphere are, not surprisingly, much larger than those for
an AR (Gary 2001). Such a boundary condition, having
an overall weak magnetic ﬁeld with small-scale inserts of
a larger ﬁeld, represents a big challenge for the currently
available methods of the coronal force-free modeling de-
signed for ARs with relatively large-scale areas of the
strong magnetic ﬁeld, where the plasma parameter β
although larger than one, is not exceptionally large.

Therefore, to emulate a photospheric boundary rep-
resentative of a typical AR, we select a higher level,
where the distribution of the plasma β is similar to
that in a typical AR (Gary 2001); we call this level a
‘typical AR β photosphere,’ or just β-photosphere for
short. Speciﬁcally, we deﬁne this layer as the lowest
layer above the nominal photosphere, where 95% of the
nodes have β < 102. This level roughly corresponds to
Hβ−ph ≈ 1 Mm; the exact height varies between the

Figure 1. Distribution of maximal and minimal values of
plasma β at diﬀerent altitudes. Vertical solid lines mark
altitude range where β-photosphere levels for diﬀerent bin
factors are located. Dashed vertical lines mark range of chro-
mosphere levels.

data cubes obtained with diﬀerent binning factors (see
section 2.2). Then, we deﬁne a chromospheric inter-
face as the lowest layer where 95% of the nodes have
β < 10−1, which is supposed to oﬀer an ideal boundary
condition for the force-free modeling. This level roughly
corresponds to the height Hchr ≈ 2.5 Mm. We return
to more speciﬁc deﬁnition of these levels in the next sec-
tion, while introducing rebinned data cubes with a lower
spatial resolution.

2.2. Setup for the Testing

From the original magnetic data cube we initially cre-
ated a new, uniform data cube with full resolution over
x, y coordinates and a regular grid in z direction with
the voxel height of 48 km equal to the pixel sizes in x, y
direction, while entirely discarding the subphotospheric
part of the data cube. This yields a new full-resolution
data cube with a regular grid having cubic voxels, con-
venient for further manipulation and analysis, to which
we refer to as ‘original regular’ data cube hereafter.

This new original data cube was then rebinned to pro-
duce lower-resolution data cubes1 with the binning fac-
tors n = 2, 3, 4, 6, 7, 9. Apparently, a lower-resolution
voxel includes n3 original voxels. Therefore, for each
new voxel we assign the mean values of the magnetic
ﬁeld components to represent these values in the center
of the new voxel such as

Bα =

1
n3

n3

i=1
X

Bα[i],

α = x, y, or z,

(1)

1 All these data cubes with regular spacing as well as
standard deviations are available at our project web-site:
http://www.ioffe.ru/LEA/SF_AR/files/Magnetic_data_cubes/Bifrost/index.html

4

Fleishman et al.

and the standard deviations δBα, where

250

200

150

100

l

]
s
e
x
p
[

i

Y

50

0

80

60

40

20

l

]
s
e
x
p
[

i

Y

0

0

250

200

150

l

]
s
e
x
p

i

δB2

α =

1
n3 − 1

n3

i=1
X

−2000

(Bα[i] − Bα)2,

α = x, y, or z.

−1000

0
LOS field [Gauss]

1000

(a)

2

150

(b)

3

100

l

]
s
e
x
p
[

i

l

]
s
e
x
p
[

i

Y

50

Y

0 50 100 150 200 250
X [pixels]

(d)

6

50
100
X [pixels]

150

(e)

7

0

0

60

40

l

]
s
e
x
p
[

i

l

]
s
e
x
p
[

i

Y

20

80

0

0

20

40

60

X [pixels]

Y

20

40
X [pixels]

60

(2)

4

2000

125

100

(c)

75

50

25

0

50

40

30

20

10

0

0 25 50 75 100 125
X [pixels]

(f)

9

0 10 20 30 40 50
X [pixels]

−300

−200

−100

0
LOS field [Gauss]

100

200

300

(a)

2

150

(b)

3

100

l

]
s
e
x
p

i

(c)

4

125

100

75

l

]
s
e
x
p

i

[

Y

100

[

Y

50

50

0

0

80

60

40

20

0

0

50 100 150 200 250

X [pixels]

(d)

6

l

]
s
e
x
p

i

[

Y

20

40
X [pixels]

60

80

0

0

60

40

20

0

0

l

]
s
e
x
p

i

[

Y

[

Y

50

25

50

100
X [pixels]

150

0

0

25

75 100 125

50
X [pixels]

(e)

7

50

(f)

9

l

]
s
e
x
p

i

[

Y

20

40

60

X [pixels]

40

30

20

10

0

0

−60

−40

−20

0
20
LOS field [Gauss]

40

60

250

200

150

100

50

l

]
s
e
x
p
[

i

Y

(a)

2

150

(b)

3

100

l

]
s
e
x
p
[

i

l

]
s
e
x
p
[

i

Y

50

Y

125

100

75

50

25

0

0

80

60

40

20

0

0

50 100 150 200 250

X [pixels]

(d)

6

l

]
s
e
x
p
[

i

Y

20

40
X [pixels]

60

80

0

0

60

40

20

0

0

50

100
X [pixels]

150

0

0

25

75 100 125

50
X [pixels]

(e)

7

50

(f)

9

40

30

l

]
s
e
x
p
[

i

Y

20

10

0

0

10 20 30 40 50
X [pixels]

20

40

60

X [pixels]

l

]
s
e
x
p
[

i

Y

Figure 2. Line-of-sight (Bz) magnetograms at the level
of nominal photosphere (top), β-photosphere (middle), and
chromosphere (bottom) in the magnetic data cubes obtained
from the original Bifrost model by rebinning the volume by
factors of 2, 3, 4, 6, 7, and 9. Each set of six panels uses the
same scale shown above the set.

10 20 30 40 50
X [pixels]

(c)

4

This set of the data cubes with diﬀerent resolutions
represents the input for our tests. The distributions of
z-component of the magnetic ﬁeld for diﬀerent binning
factors at the nominal and β-photospheres and at the
chromosphere are shown in Figure 2.

2.3. Volume Properties of the Regular Data Cubes

There are a number of numerical characteristics, sim-
ilar to those introduced by Wheatland et al. (2000);
Schrijver et al. (2006), which are used to evaluate to
what extent the reconstructed magnetic ﬁeld matches
the force-free criterion:

θ = arcsin

N
i σi
N !

  P

,

θj = arcsin

|j × B|i
|j|i |B|i
and the divergence-free criterion:

σi =

,

N
i

|j|i σi
N
|j|i !
i

  P
P

f =

1
N

N

i
X

|∇B|i
6 |B|i

dx,

,

(3)

(4)

where B is the model ﬁeld; j is the corresponding elec-
tric current density, the summation is performed over
the voxels of the computational grid (excluding bound-
aries), dx is the grid spacing; σi is the sine of the angle
between the magnetic ﬁeld and the current density at
the i-th node of the computational grid; θ is the angle
averaged over all nodes, in the ideal case of the force-
free ﬁeld it must be zero; θj is a similar metrics but
weighted with the electric current that means that con-
tributions form strong currents dominate this metrics;
f is a parameter characterizing the accuracy with which
the magnetic ﬁeld is divergence-free.

Here we compute these metrics for the original reg-
ular data cube and for the data cubes obtained after
the rebinning. Table 1 presents the metrics, calculated
for the data cube set. For each data cube we present
three sets of metrics. The ﬁrst one is calculated for the
entire data cube volume starting from the nominal pho-
tosphere. The two others are for subdomains that start
at either β-photosphere or chromosphere levels. Inde-
pendently of the binning factor, each metrics displays
the same trend as a function of the subdomain used
from the full data cube to the
for the computation:
chromosphere-limited subdomain, θ shows a minor de-
crease, while θj decreases signiﬁcantly, which is not sur-
prising. Indeed, θj is weighted with the current density,
while the strongest currents concentrate near the bottom
boundary. If this bottom boundary is located below the
chromosphere, then the contribution from the non-force-
free ﬁeld region dominates. Above the chromosphere the

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
NLFFF–MHD CASTING

5

ﬁeld corresponds to a force-free conﬁguration with a rea-
sonably high accuracy, though not exactly. It is interest-
ing, that the divergence-free parameter f also improves
when only the subdomain located above the chromo-
sphere is taken into account, which, perhaps, originates
from regridding the original nonuniform vertical grid to
the uniform one used here. In addition, the prominent
small-scale structure of magnetic ﬁeld at the lower levels
results in more signiﬁcant errors in diﬀerential schemes
used here to compute spatial derivatives.

All metrics are getting worse with the increase of the
binning factor. The reason for that is the unavoidable
increase of numerical errors of derivative computation.
Indeed, rebinning the model data causes distortions and,
thus, an increase of the divergence-free metrics f .

3. π-DISAMBIGUATION TESTS

Reconstruction of the coronal magnetic ﬁeld starts
typically from the magnetic vector data on the pho-
tospheric or, less common, chromospheric levels of the
solar atmosphere. The magnetic vector measurements
are performed using spectropolarimetry of Zeeman split-
ting of magnetic-sensitive optical or IR lines with circu-
lar polarization providing the line-of-sight component,
while linear polarization providing the transverse com-
ponent of the magnetic ﬁeld vector. Apparently, only
the azimuth angle, but not direction of the transverse
component is being measured. This uncertainty of the
transverse component direction is commonly called π-
ambiguity (180◦-ambiguity), thus a method resolving
this π-ambiguity is called for.

3.1. π-disambiguation methods

A number of disambiguation methods have been pro-
posed (Metcalf 1994; Georgoulis 2005; Gosain & Pevtsov
2013; Crouch 2013; Rudenko & Anﬁnogentov 2014),
which diﬀer in their approaches, performance, and
speed. The detailed comparison of diﬀerent methods
can be found in comprehensive reviews (Metcalf et al.
2006; Leka et al. 2009). For our tests we selected the
minimum energy (ME) solution (Metcalf 1994), the
so-called super fast and quality disambiguation (SFQ)
method (Rudenko & Anﬁnogentov 2014) also known
as new disambiguation method (NDA), and an acute
angle (AA) method, which makes a choice by com-
parison of the azimuth with that of a ‘reference’ ﬁeld
(Metcalf et al. 2006). The reference ﬁeld can be a po-
tential or linear force-free ﬁeld, for example, but we
employ a simple version of the AA method that uti-
lizes a naive approach where the true transverse ﬁeld
direction is selected to be closer to the potential ﬁeld.

The ME disambiguation2 is based on simulated an-
nealing (Metropolis et al. 1953) and is regarded as pro-
viding the highest disambiguation quality among other
methods. However this method is rather computation-
ally expensive. Our implementation of the ME method
follows Metcalf (1994) with an improvement suggested
by Leka et al. (2009), namely with the initial ‘temper-
ature’ varying from pixel to pixel depending on max-
imum temperature among all possible combinations of
transversal ﬁeld orientation of the neighbor pixels. In
addition, this implementation adopts that for any pixel
keeping its transverse ﬁeld orientation reasonably long
(typically, during 100 consecutive iterations), the am-
biguity is treated “resolved” and the algorithm do not
change its state over the remaining iterations. Thus, the
number of analyzed pixels decreases with the number of
iteration, which reduces the annealing time.

The SFQ method (Rudenko & Anﬁnogentov 2014) in-
cludes two steps: a preliminary disambiguation and a
“cleaning” procedure. The former is a local compari-
son of the observed ambiguous ﬁeld with the reference
(potential) one. The comparison procedure is similar to
that in the AA method. The discontinuities in this ﬁrst
order approximate solution are then cleaned out with
an iterative procedure. On each iteration the transverse
magnetic ﬁeld is compared with its local average and
inverted in those pixels where the alternative value is
closer to the smoothed ﬁeld.

3.2. Performance metrics for the π-disambiguation

methods

To test the quality of π-disambiguation methods we
used the following metrics (Metcalf et al. 2006): pixel
error Epix and ﬂux error Eﬂux :

Epix =

Nerr
N

,

Eﬂux =

err Bτ (x, y)
all Bτ (x, y)

,

P
P

where N is the total number of pixels and Nerr is the
number of pixels where disambiguation method fails,
Bτ (x, y) is the absolute value of the transversal mag-
all are summations
netic ﬁeld in pixel (x, y),
over those pixels where the disambiguation failed and
over all pixels in the magnetogram, respectively, as well
as the typical computation time.

err and

P

P

2 http://www.cora.nwra.com/AMBIG/

6

Fleishman et al.

Table 1. Numerical characteristics of diﬀerent domains depending on binning
factor.

Binning factor

Volume above

layer #

θ◦

θ◦
j

f × 106

1

2

3

4

6

7

9

Nominal photosphere

β-photosphere

chromosphere

Nominal photosphere

β-photosphere

chromosphere

Nominal photosphere

β-photosphere

chromosphere

Nominal photosphere

β-photosphere

chromosphere

Nominal photosphere

β-photosphere

chromosphere

Nominal photosphere

β-photosphere

chromosphere

Nominal photosphere

β-photosphere

chromosphere

0

17

42

0

8

21

0

6

14

0

4

11

0

3

7

0

3

6

0

2

5

19.23

48.60

17.21

18.65

16.23

5.59

568

158

107

18.59

46.00

1573

16.65

18.57

15.55

5.97

401

245

18.48

43.93

2594

16.32

14.70

15.37

6.41

609

410

18.62

42.41

3315

16.67

16.53

15.49

6.84

934

583

19.12

39.53

16.94

13.53

15.87

7.60

19.40

38.24

16.93

11.37

16.12

7.94

20.03

36.13

17.82

13.63

16.64

8.58

3690

1315

951

3671

1415

1135

4057

1939

1482

Note— In the ”layer” column for each particular layer showed its level in the
corresponding rebinned grid. BIFROST photosphere always correspond to
zero level.

3.3. Comparison of the alternative approaches.

The π-disambiguation methods described above have
been applied to all reference layers and all rebinned data
cubes. Here we summarize there performance.

For the nominal photosphere (see Table 2), all tested
methods fail to provide acceptable result. Both ﬂux
and pixel errors are of the order of 20 – 30%, with only
exception of large bin-factors and SFQ method, where

the errors are about 10%; see Figure 3. In most cases
(but not always), both methods work better in areas of
stronger magnetic ﬁeld but fail in areas of weak small-
scale ﬁeld. This failure of all these methods originates
from the fact that none of the methods is capable of
correctly processing the very small magnetic elements
with the size of the order of one pixel (salt and pepper
patterns). This might have important implications for

NLFFF–MHD CASTING

7

Table 2. π-disambiguation results for the nominal photosphere

Pixel error, %

Flux error, % Computation time

Bin

SFQ ME AA SFQ ME AA SFQ

ME

2

3

4

6

7

9

19.5

20.5

30.3

18.8

14.8

28.4

19.0

23.9

30.3

19.2

16.4

27.7

19.2

27.6

29.6

20.4

18.7

26.6

2.9s

1.4s

0.7s

14.3

34.2

28.0

14.0

27.0

25.3

0.38s

12.3

33.0

26.8

12.8

26.2

23.9

0.31s

8.6

33.0

23.5

9.1

27.8

19.0

0.18s

13m57s

6m30s

4m04s

1m46s

1m18s

48s

Table 3. π-disambiguation results for the AR β photosphere

Pixel error, %

Flux error, % Computation time

Bin

SFQ ME AA SFQ ME

AA SFQ

ME

2

3

4

6

7

9

1.7

1.3

1.3

0.76

5.8

3.1

2.3

0.4

0.46

0.21

0.63

0.35

8.1

6.3

6.7

5.7

5.8

5.6

0.6

0.4

0.4

2.3

1.0

0.71

0.15

0.045

0.11

0.016

0.21

0.027

3.5

2.5

2.7

2.1

2.0

2.0

1.1s

0.37s

0.18s

0.09s

0.09s

0.02s

8m38s

3m39s

2m11s

3m56s

3m39s

26s

Table 4. π-disambiguation results for the chromosphere

Pixel error, %

Flux error, %

Computation time

Bin

SFQ ME

AA

SFQ

ME

AA SFQ

ME

2

3

4

6

7

9

0.005

0.007

0.03

0.06

0.06

0.03

0

0

0.013

0.014

0

0

5.0

4.9

4.6

4.7

4.6

4.4

0.0001

0.0003

0

0

0.006

0.0004

0.014

0.0005

0.02

0.01

0

0

1.5

1.4

1.3

1.4

1.3

1.3

0.73s

0.3s

0.13s

0.07s

0.05s

0.04s

6m03s

2m35s

1m28s

40s

30s

19s

π-disambiguation of the magnetic ﬁeld at the quiet sun
areas, which is, in particular, a substantial part of the
full-disk disambiguation in the SDO/HMI pipeline.

Table 3 shows the test results for the level of typi-
cal AR β photosphere. At this level, the magnetic ﬁeld
becomes noticeably smoother than that at the nomi-
nal photosphere, and all methods improve their recovery
success rate by at least an order of magnitude. AA pixel

Bx, ME

By, ME

Bz, ME

50

40

30

l

]
s
e
x
p
[

i

50

40

30

l

]
s
e
x
p
[

i

50

40

30

l

]
s
e
x
p
[

i

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Bx, SFQ

By, SFQ

Bz, SFQ

50

40

30

l

]
s
e
x
p
[

i

50

40

30

50

40

30

l

]
s
e
x
p
[

i

l

]
s
e
x
p
[

i

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Figure 3. Comparison of the disambiguation results of
the ME (top row) and SFQ (bottom row) codes for the
BIFROST ﬁeld with the binning factor 9 at the level of nom-
inal photosphere. Pixels with the disambiguation errors are
indicated in the semitransparent red. Blue contours enclose
regions with almost vertical magnetic ﬁeld (inclination an-
gle < 15 degrees). Green contours enclose weak ﬁeld regions
where B < 50 G. Ticks on the contours show the direction
towards the lower values.

Bx, ME

By, ME

Bz, ME

50

40

30

l

]
s
e
x
p
[

i

50

40

30

l

]
s
e
x
p
[

i

50

40

30

l

]
s
e
x
p
[

i

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Bx, SFQ

By, SFQ

Bz, SFQ

50

40

30

50

40

30

l

]
s
e
x
p
[

i

50

40

30

l

]
s
e
x
p
[

i

l

]
s
e
x
p
[

i

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Y

20

10

0

0

10 20 30 40 50
X [pixels]

Figure 4. Comparison of the disambiguation results of
the ME (top row) and SFQ (bottom row) codes for the
BIFROST ﬁeld with the binning factor 9 at the level of
correct β photosphere. Pixels with the disambiguation er-
rors are indicated in the semitransparent red. Blue contours
enclose regions with almost vertical magnetic ﬁeld (inclina-
tion angle < 15 degrees). Green contours enclose weak ﬁeld
regions where B < 50 G. Ticks on the contours show the
direction towards the lower values.

errors exceed 5% and the ﬂux errors exceed 2%. SFQ
and ME results are much better. On the ﬁnest grid the
best quality is provided by SFQ, while the output of ME
method contains an extended area where the transverse
ﬂux is inverted. For the grids with lower resolutions (bin
6 – 9) this artefact disappears and ME outperforms SFQ.
However, both SFQ (all bins) and ME (bins 3 – 9) give

 
 
 
 
 
 
 
 
 
 
 
 
8

Fleishman et al.

ﬂux error of 1% or less and, thus, their results can be
used as boundary conditions for NLFFF extrapolations.
In principle, it is tempting to use the π-disambiguation
mismatches between the diﬀerent disambiguation meth-
ods to reprocess those pixels, where two methods give
opposite results, to improve the solution. However, as
clearly seen from Figure 4, there are a number of pixels,
where both methods fail to recover the ﬁeld azimuth,
even though the total number of those ‘bad’ pixels is
very small. Figure 4 demonstrates that the failures are
not random, but occur in the areas, where the ﬁeld is
either weak or almost vertical or both.

At the chromospheric level (Table 4), the magnetic
ﬁeld is more horizontal and smooth enough, so it is dis-
ambiguated perfectly by ME (there are errors in several
pixels only for bins 4 and 6). The SFQ method also
works excellent and fails only in several tens of pixels
giving ﬂux error from 0.0001% to 0.01%, depending on
the binning. AA also perform better on the smooth
chromospheric (than the photospheric) ﬁeld with the
ﬂux error about 1.5% for all bins.

These tests validate both ME and SFQ disambigua-
tion methods at the β-photosphere and the chromo-
sphere. This permits us to adopt that the π-ambiguity
has been resolved perfectly, while performing further
tests on the ﬁeld preprocessing and extrapolation. Note,
that in the present article we do not study depen-
dence of the disambiguation accuracy on position of
the data cube at the solar disk. Most of the disam-
biguation approaches tend to generate more errors to-
wards the solar limb. Here, the SFQ method has an
advantage. According to tests on real magnetograms
observed close to the disk center and artiﬁcially rotated
towards the limb, it maintains high accuracy even there
(Rudenko & Anﬁnogentov 2014), while other methods
often produce artifacts in the transverse ﬁeld compo-
nents.

4. PREPROCESSING TESTS

Even the photospheric magnetic vector data with a
perfectly resolved π-ambiguity represent a substantial
challenge for the coronal magnetic ﬁeld reconstruction.
The problem is that the coronal modeling relies on the
magnetic ﬁeld force-freeness in the corona, which is
dominated by the magnetic pressure (the plasma β is
less than 1), while the photospheric magnetic ﬁeld is
not force-free given that β ≫ 1 there. To overcome
this mismatch it has been proposed (Wiegelmann et al.
2006; Fuhrmann et al. 2007, 2011; Jiang & Feng 2014)
to modify the measured photospheric magnetogram in
such a way that a new, ‘preprocessed,’ magnetogram
is representative of a higher, chromospheric, height and,

thus, more force-free than the original photospheric one.
An appropriately performed preprocessing can facilitate
the coronal ﬁeld reconstruction by providing a boundary
condition that is more suitable for a NLFFF extrapola-
tion. The tests performed using available chromospheric
diagnostics (Jing et al. 2010) conﬁrm that the prepro-
cessing is doing reasonably well; here we perform the
tests of various available approaches to the preprocess-
ing using the same modeling data cubes as above.

4.1. Preprocessing approaches

Wiegelmann et al. (2006) proposed to preprocess the
photospheric vector magnetogram data to drive the
observed non-force-free photospheric data towards the
suitable boundary condition in the chromosphere by
minimizing a functional Lprep:

Lprep = µ1L1 + µ2L2 + µ3L3 + µ4L4 ,

(5)

where

z − ˜B2

x − ˜B2
y)

2

L1 = (Σp ˜Bx ˜Bz)2+(Σp ˜By ˜Bz)2+

Σp( ˜B2
(cid:16)
y))2 + (Σpy( ˜B2
x − ˜B2
2
,

z − ˜B2
L2 = (Σpx( ˜B2
Σp(y ˜Bx ˜Bz − x ˜By ˜Bz)
L3 = Σp( ˜Bx − Bx)2 + Σp( ˜By − By)2 + Σp( ˜Bz − Bz)2 ,
(cid:17)
L4 = Σp(∆ ˜Bx)2 + Σp(∆ ˜By)2 + Σp(∆ ˜Bz)2 .

x − ˜B2

z − ˜B2

(cid:17)
y))2 +

,

(cid:16)

Here, minimizing L1 and L2 terms ensures that the ﬁ-
nal magnetogram corresponds, as close as possible, to
the force-free and torque-free conditions, respectively.
L3 term is responsible for the similarity of the pre-
processed data to the original magnetogram, while L4
term is responsible for the smoothing. Summations Σp
represent the surface integrals over all available grid
nodes p at the bottom boundary; ∆ stands for the
two-dimensional (2D) Laplace operator. The idea is
to minimize Lprep at once, so that all terms Ln are
getting small simultaneously. The weights µn are un-
known a priori; Wiegelmann et al. (2006) tested vari-
ous choices for µn and came up with a strategy on how
to choose these weights; the default set of the weights
is µ = [1, 1, 10−3, 10−2]. Minimization of the func-
tional is performed iteratively using Newton-Raphson
scheme3 (Press et al. 2007). Hereafter, we refer to our
implementation of the preprocessing method developed
by Wiegelmann et al. (2006) as TW preprocessing.

Fuhrmann et al. (2007) proposed another form of
functional (5) to be minimized. The distinctions are in

3 The iteration step s is being optimized itself during the min-
imization given that s can be considered as one of the arguments
of the functional; the optimum step is selected by the standard
“golden section” method (Press et al. 2007) at each iteration step.

NLFFF–MHD CASTING

9

the form of L4 term (the smoothing was performed using
a median ﬁlter instead of the diﬀerential Laplas operator
in Wiegelmann et al. (2006)), in varying the ﬁeld only
inside a given range deﬁned by a ﬁeld threshold value in-
stead of considering L3, and in the minimization method
selected—annealing simulation. Fuhrmann et al. (2011)
have shown that the Wiegelmann et al. (2006) method
gives smoother preprocessed ﬁeld. Since both methods
have a similar nature and show comparable ﬁnal results,
we only consider the Wiegelmann et al. (2006) method
for further testing.

Jiang & Feng (2014) proposed a slightly diﬀerent ap-
proach to the preprocessing that consists of two distinct
steps. The ﬁrst step produces a potential extrapolation
starting from the photospheric vertical magnetic ﬁeld
component Bz. Then, at a certain level, typically one
pixel above the photosphere, the Bz component is taken
from the potential extrapolation, while a functional sim-
ilar to Eq. (5) is formed for the transverse ﬁeld compo-
nents only, and is being minimized at the second step of
the method. An apparent advantage of this approach is
the ability to control the height level, to which the pre-
processed magnetogram must correspond. For our tests
we used the preprocessing code provided by the authors
(Jiang & Feng 2014) with the default set of the weights
µ = [1, 1, 10−3, 1] and with a few cosmetic modiﬁca-
tions needed to ease the code running. In what follows,
we refer to the preprocessing method of Jiang & Feng
(2014) as JF preprocessing.

4.2. Performance metrics for the preprocessing codes

Preprocessing methods are supposed to modify the
magnetic ﬁeld vector measured at the photosphere to
make it more compatible with the force-freeness of the
magnetic ﬁeld model in the corona. The corresponding
modiﬁcation of the photospheric ﬁeld could either result
in removing the force component from the magnetic ﬁeld
distribution without any noticeable change of the ﬁeld
strength, or, in addition to this removal, may yield the
corresponding decrease of the ﬁeld strength emulating
an eﬀective “elevation” of the ﬁeld distribution up to
a higher chromospheric level where the magnetic ﬁeld
does become a force free one.

Thus, we assess the preprocessing methods in the

three following respects:

1. Has the magnetic ﬁeld become signiﬁcantly more

force free after the preprocessing?

2. How close is the preprocessed ﬁeld to the magnetic

ﬁeld in the BIFROST model?

3. Does the preprocessing cause an eﬀective “eleva-
tion” of the ﬁeld distribution up to a higher level?

The force-freeness of the preprocessed magnetic ﬁeld
is assessed using the L1 and L2 terms from (5). In this
work, we quantitatively measure the preprocessing eﬃ-
ciency by calculating the logarithmic ratio of L1 and L2
L0
1
parameters before and after the preprocessing: log10
Lp
1

L0
2
Lp
2

and log10
. The higher values of these parameters in-
dicate more eﬃcient removal of the force-carrying mag-
netic ﬁeld component.

The consistency of the preprocessed magnetic ﬁeld
with the model one at a given level of the data cube
can straightforwardly be assessed using the L3 metrics
in Eq. (5). To assess if any eﬀective elevation has hap-
pened, we calculate this metrics using the Bifrost data
from the same level and a few higher levels. We also use
a few more useful metrics deﬁned below:

• Normalized discrepancy between the preprocessed

and observed ﬁeld components

˜L3 =

s

L3
p B2 ,

(6)

• Normalized discrepancy between the absolute

P

value of the preprocessed and observed ﬁelds

p( ˜B − B)2
p B2

,

(7)

EB =

P

v
u
u
t

P

• Average angle between the preprocessed and ob-

served ﬁeld

A = arccos

˜B · B
˜BB

/N

,

!

p
X

(8)

• Slope of the regression dependence ˜B = SB + b

S =

p

˜BB −
p B2 − (
P

p

p B/N

˜B
p B)2/N
P

P

(9)

• Correlation coeﬃcient

P

P

R =

˜BB −

p

˜B

p

˜B2 − (
P

p

˜B)2/N
P

p

p B/N
p B2 − (
P

qP

P

qP

P

p B)2/N
(10)

Better preprocessing method is expected to give lower
values of ˜L3, while the preferable values of the slope
S and the correlation coeﬃcient R are those closer to
unity.
If the preprocessed and the original ﬁelds are
substantially diﬀerent, ˜L3 will have a larger value. For
instance, if ˜B ≡ 0 the ˜L3 metric will be equal to unity

 
Fleishman et al.

10

τ

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

Level 0

JF preprocessing

Level +1

Level 0

TW preprocessing

Level +1

τ

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

τ

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

τ

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

−60−40−20 0 20 40 60
  Model   Bτ

−60−40−20 0 20 40 60
  Model   Bτ

−60−40−20 0 20 40 60
  Model   Bτ

−60−40−20 0 20 40 60
  Model   Bτ

Level 0

Level +1

Level 0

Level +1

z

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

z

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

z

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

z

B
d
e
s
s
e
c
o
r
p
e
r
P

60

40

20

0

−20

−40

−60

−60−40−20 0 20 40 60
  Model   Bz

−60−40−20 0 20 40 60
  Model   Bz

−60−40−20 0 20 40 60
  Model   Bz

−60−40−20 0 20 40 60
  Model   Bz

Figure 5. Dependence of the magnetic ﬁeld preprocessed
with the JF (left panel) and TW (right panel) preprocessing
codes on the initial ﬁeld on the β-photosphere for bin=9.

Y

for any B. Therefore we will interpret the preprocessing
results with ˜L3 ≥ 0.5 as unacceptable. Additionally, we
calculate metrics (6)—(10) for the model magnetic ﬁeld
taken at the height of one voxel to nail down a possible
eﬀective elevation that can be a side or intended eﬀect
of the preprocessing.

4.3. Comparison of the alternative approaches.

Tables 6, 5, and 6 show the metrics describing how
force-free are the boundary conditions produced by the
two codes. For the nominal photosphere, all results
have ˜L3 > 0.5 meaning that the preprocessed ﬁeld
is strongly diﬀerent from the original magnetogram.
Therefore, we interpret the preprocessing results ob-
tained for the nominal photosphere as incorrect and do
not analyse them in what follows. For all levels and bin-
ning factors our implementation of the TW preprocess-
ing (Wiegelmann et al. 2006) outperforms the JF pre-
processing code (Jiang & Feng 2014) providing signiﬁ-
cantly more force-free results. However, the L3 metrics
are nearly the same for both codes, meaning that both
solutions are comparably close to the input magnetic
ﬁeld.

The detailed quantitative comparison of the prepro-
cessing results and the magnetic ﬁeld in the Bifrost
model is given in Tables 8 and 9. We assess separately
the full vector and the longitudinal and transverse com-
ponents at two levels: the same level as the initial mag-
netogram and one level higher. EB metric (Eq. 7) in-
dicates the discrepancy between the absolute values of
the preprocessed and modeled magnetic ﬁeld, while the
diﬀerence in the directions of the ﬁelds is shown by A
metric (Eq. 8). This metric shows that there is an ef-
fective ﬁeld elevation caused by any of the JF (all bins)
and TW (bins 4–9) preprocessing methods. The eﬀect is
more pronounced for the JF preprocessing especially at
low spatial resolution (bin 9). However, the mean angle
between the preprocessed and Bifrost ﬁeld shows diﬀer-
ent behavior. One level elevation does not improve the

l

]
s
e
x
p
[

i

Y

l

]
s
e
x
p
[

i

l

]
s
e
x
p
[

i

Y

Model

JF preprocessing

TW preprocessing

50

40

30

20

10

0

50

40

30

20

10

0

50

40

30

20

10

0

l

]
s
e
x
p
[

i

Y

Bx

0 10 20 30 40 50
X [pixels]

l

]
s
e
x
p
[

i

Y

By

0 10 20 30 40 50
X [pixels]

l

]
s
e
x
p
[

i

Y

Bz

0 10 20 30 40 50
X [pixels]

50

40

30

20

10

0

50

40

30

20

10

0

50

40

30

20

10

0

l

]
s
e
x
p
[

i

Y

Bx

0 10 20 30 40 50
X [pixels]

l

]
s
e
x
p
[

i

Y

By

0 10 20 30 40 50
X [pixels]

l

]
s
e
x
p
[

i

Y

Bz

0 10 20 30 40 50
X [pixels]

50

40

30

20

10

0

50

40

30

20

10

0

50

40

30

20

10

0

Bx

0 10 20 30 40 50
X [pixels]

By

0 10 20 30 40 50
X [pixels]

Bz

0 10 20 30 40 50
X [pixels]

Figure 6. Comparison of the original (left column) Bifrost
ﬁeld at the β-photosphere level with the results of JF (middle
column) and TW (right column) preprocessing for bin=9.

mean angle metric for the JF preprocessing, while the
TW method demonstrates slight improvement of it at
bins 7 and 9. Being applied to the chromospheric level
(even though this might not be needed in practice), JF
preprocessing again demonstrates eﬀective elevation in
EB, while TW method shows no improvement at higher
level in either absolute value discrepancy or in angle.

JF and TW methods preprocess longitudinal and
transverse magnetic ﬁeld components diﬀerently. There-
fore we assess the ﬁeld components separately. For both
longitudinal and transverse components we calculate the
slope (Eq. 9) and correlation (Eq. 10) metrics. The for-
mer characterizes the absolute value of the ﬁeld while
the latter is to assess the spatial structuring of the ﬁeld.
Both slope and correlation metrics show the presence
of an eﬀective elevation in the longitudinal component
preprocessed using the JF method. Indeed, such a be-
havior is rather expected because the JF preprocessing
ﬁxes the longitudinal component to be equal to the po-
tential ﬁeld extrapolation results and does not optimize
it. The transverse component is, however, elevated by
a height exceeding the one voxel size (but less than the
two voxel sizes). Therefore, there is a mismatch in the
heights to where the longitudinal and transverse com-
ponents are elevated in the JF method. This mismatch
is primarily responsible for the mismatch in the angle
between the preprocessed and the (one level up) model
ﬁeld mentioned above.

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
NLFFF–MHD CASTING

11

Table 5. Results of the preprocessing test at
the nominal photosphere

Table 6. Results of the preprocessing tests
at the β-photosphere

log10

Lo
1
Lp
1

log10

Lo
2
Lp
2

L3

log10

Lo
1
Lp
1

log10

Lo
2
Lp
2

L3

Bin

JF

TW JF

TW JF

TW

Bin

JF

TW JF

TW JF

TW

2

3

4

6

7

9

4.55

11.26

5.42

11.28

0.60

0.72

4.50

10.68

5.42

10.80

0.67

0.79

4.35

10.42

5.32

10.89

0.70

0.83

4.20

4.11

3.99

9.80

9.59

9.24

4.97

10.16

0.74

0.85

4.72

4.29

9.96

9.58

0.74

0.85

0.74

0.85

2

3

4

6

7

9

2.64

11.02

2.65

10.28

0.24

0.19

2.07

10.79

2.09

2.38

10.33

2.41

1.79

1.30

1.60

9.61

9.35

9.56

1.82

1.29

1.60

9.59

8.94

8.35

8.51

7.81

0.24

0.20

0.31

0.29

0.30

0.30

0.27

0.27

0.34

0.37

After the TW preprocessing, the value of the longitu-
dinal ﬁeld becomes underestimated for the original level
(S < 1) but overestimated for the +1 voxel level (S > 1),
meaning that some eﬀective elevation is present, but the
elevation height is somewhere between 0 and 1 voxel.
In contrast, the transverse component displays an ele-
vation very close to the one voxel height; thus, the TW
preprocessing also results in a mismatch in the elevation
heights for the longitudinal and transverse components,
likewise the JF method.

The JF preprocessing demonstrates better cross-
correlation metric R for the longitude component for all
levels and binning factors, both at the photospheric and
chromospheric heights. The cross-correlation coeﬃcient
for the transverse ﬁeld is worth for both methods at all
levels and heights. At high resolutions (bins 2-4) JF and
TW show very similar results, while at low resolution
(bins > 4), JF demonstrates higher correlation with
the modeled ﬁeld. This behavior is also demonstrated
in Figure 5 in the form of two-dimensional histograms
showing the scatter of the preprocessed ﬁeld components
versus the modeled ones.

Our tests show that both methods have their own
advantages and disadvantages. TW preprocessing im-
proves force-freeness metrics by many orders of magni-
tude, but signiﬁcantly changes the ﬁeld structure, espe-
cially for lower spatial resolutions, Figure 6. It also eﬀec-
tively elevates the ﬁeld, but the elevation height seams
to diﬀer from one voxel and diﬀers for the longitudi-
nal and transverse components. The JF preprocessing
better saves the ﬁeld structure for low resolution grids
and more distinctly elevates the longitudinal ﬁeld to the
height of one voxel, but the output is not as force-free
as for the TW method; in addition, the transverse com-
ponent is eﬀectively elevated by a height larger than the
size of one voxel. These mismatches in the elevation
heights for the ﬁeld components revealed in both meth-

Table 7. Results of the preprocessing tests at
the chromosphere

log10

Lo
1
Lp
1

log10

Lo
2
Lp
2

L3

Bin

JF

TW JF

TW JF

TW

2

3

4

6

7

9

0.67

9.37

0.57

9.22

0.08

0.039

0.67

10.25

0.57

11.04

0.10

0.060

0.64

10.31

0.55

10.53

0.12

0.088

0.66

0.66

0.62

9.67

9.47

9.24

0.57

0.56

0.53

9.81

9.55

9.11

0.16

0.17

0.20

0.12

0.13

0.15

ods, will then have negative impact on the ﬁdelity of the
NLFFF extrapolations.

5. NLFFF TESTS

Diﬀerent approaches and algorithms of the NLFFF
reconstruction proposed so far include the vertical in-
tegration method, the boundary integral method, the
Euler potential method, the Grad-Rubin methods, and
various kind of evolutionary methods, such as mag-
netofrictional and optimization methods (see, e.g., brief
overview in Aschwanden 2005, Section 5.3.3). Cor-
respondingly, a variety of computing codes employing
one or another version of these methods have been
implemented. Although it is certainly interesting to
cast all or most of the available NLFFF reconstruc-
tion methods vs realistic MHD models, such a study
would be highly excessive for a single paper. Here we
focus on two diﬀerent implementations of the optimiza-

12

Fleishman et al.

Table 8. Photosphere eﬀective elevation test

Full vector

Longitudinal component

Transversal components

EB

A

S

R

S

R

Bin

level

JF

TW JF

TW JF

TW JF

TW

JF

TW JF

TW

2

3

4

6

7

9

+0

+1

+0

+1

+0

+1

+0

+1

+0

+1

+0

+1

0.25

0.16

11.55

10.85

0.882

0.960

0.990

0.9897

0.709

0.816

0.980

0.9821

0.14

0.13

22.62

22.44

0.982

1.065

0.994

0.9895

0.812

0.936

0.961

0.9646

0.23

0.15

12.32

12.79

0.868

0.946

0.988

0.9851

0.723

0.842

0.978

0.9752

0.10

0.11

19.68

19.43

0.984

1.070

0.994

0.9891

0.859

1.003

0.975

0.9740

0.33

0.24

15.21

16.18

0.814

0.890

0.978

0.9667

0.645

0.754

0.962

0.9472

0.13

0.13

23.62

23.22

0.980

1.075

0.992

0.9841

0.827

0.983

0.955

0.9562

0.32

0.25

14.12

16.11

0.799

0.867

0.976

0.9586

0.645

0.748

0.960

0.9266

0.09

0.12

17.95

17.02

0.985

1.081

0.994

0.9877

0.863

1.023

0.975

0.9637

0.28

0.21

11.92

13.91

0.813

0.891

0.981

0.9664

0.679

0.797

0.968

0.9327

0.07

0.12

12.29

11.69

0.985

1.090

0.996

0.9903

0.880

1.053

0.987

0.9685

0.39

0.33

14.02

16.69

0.754

0.816

0.969

0.9324

0.596

0.685

0.949

0.8774

0.08

0.15

14.53

13.28

0.984

1.095

0.995

0.9841

0.862

1.040

0.980

0.9516

Table 9. Chromosphere eﬀective elevation test

Full vector

Longitudinal component

Transversal components

EB

A

S

R

S

R

Bin

level

JF

TW JF

TW JF

TW

JF

TW

JF

TW

JF

TW

2

3

4

6

7

9

+0

+1

+0

+1

+0

+1

+0

+1

+0

+1

+0

+1

0.08

0.03

2.93

1.23

0.963

1.000

0.9994

0.9999

0.888

0.957

0.9990

0.9985

0.05

0.03

4.12

3.48

0.996

1.033

0.9995

0.9995

0.928

0.998

0.9995

0.9979

0.10

0.05

3.73

2.60

0.946

0.998

0.9989

0.9995

0.866

0.960

0.9977

0.9934

0.05

0.06

5.02

4.38

0.994

1.048

0.9991

0.9989

0.924

1.021

0.9987

0.9922

0.12

0.07

4.20

3.83

0.931

0.994

0.9985

0.9985

0.847

0.961

0.9965

0.9854

0.05

0.08

5.48

4.93

0.993

1.059

0.9988

0.9981

0.920

1.041

0.9976

0.9838

0.16

0.09

5.33

5.39

0.899

0.986

0.9971

0.9966

0.806

0.956

0.9933

0.9762

0.05

0.10

6.65

6.16

0.990

1.086

0.9982

0.9968

0.913

1.079

0.9952

0.9752

0.18

0.10

5.72

6.03

0.884

0.982

0.9965

0.9955

0.788

0.953

0.9918

0.9721

0.05

0.12

7.03

6.64

0.989

1.098

0.9979

0.9962

0.910

1.096

0.9942

0.9706

0.21

0.11

5.56

6.86

0.860

0.976

0.9959

0.9940

0.758

0.952

0.9893

0.9622

0.06

0.14

6.24

7.38

0.988

1.121

0.9975

0.9953

0.904

1.129

0.9914

0.9594

tion method4 (Wheatland et al. 2000) performed by our

4 We

do

not

consider modiﬁcations

by
Wiegelmann & Inhester
to
address imperfection of real data because our paper attempts
to evaluate the best achievable performance of the NLFFF
extrapolation codes themselves,
i.e., not aﬀected by possible
negative inﬂuence of the measurement errors or lacking data.

(2010); Wiegelmann et al.

proposed

(2012)

team members Alexey Stupishin (hereafter AS, following
Wiegelmann 2004) and Ivan Myshyakov (hereafter IM,
following Rudenko & Myshyakov 2009). The IM code
was used for magnetic modeling to address various prob-
lems by Kaltman et al. (2015); Livshits et al. (2016),
while AS code by Kaltman et al. (2012); Bogod et al.
(2012); Yasnov et al. (2016).

NLFFF–MHD CASTING

13

Table 10. Performance of the magnetic ﬁeld reconstruction methods

Bin

Impl

Chromosphere

β-photosphere

θ◦
m

θ◦
mj

θ◦

θ◦
j

θ◦
m

θ◦
mj

θ◦

β-photosphere,
JF preprocessed

θ◦
j

θ◦
m

θ◦
mj

β-photosphere,
TW preprocessed

θ◦

θ◦
j

θ◦
m

θ◦
mj

θ◦

9.3

24.4

IM

AS

IM 10.7

AS

24.9

θ◦
j

4.5

8.7

5.4

9.4

17.8

11.4

16.4

11.1

30.5

20.9

11.5

13.7

28.2

19.5

12.4

13.7

26.7

18.8

22.2

12.7

33.8

14.9

24.5

20.6

35.9

19.0

24.5

19.5

33.8

18.2

24.3

20.1

18.1

11.5

18.9

13.4

34.3

22.3

13.0

16.5

28.5

21.2

13.7

16.9

27.1

20.3

21.9

12.4

34.5

16.3

24.5

20.7

36.6

21.3

24.3

20.0

34.5

20.8

24.1

20.5

IM 10.6

5.9

16.0

10.0

18.2

13.4

27.2

17.4

13.7

16.9

23.4

15.8

15.1

18.9

22.6

16.4

AS

26.8

10.7

21.6

12.0

34.3

18.1

23.4

18.2

39.8

25.5

23.4

15.4

34.2

24.2

23.0

16.9

IM 11.0

6.3

15.8

9.8

14.3

10.6

21.3

13.2

12.5

14.2

20.2

13.5

14.0

17.9

19.4

14.2

AS

28.3

11.5

21.6

11.8

39.1

21.1

23.0

17.1

42.0

25.9

23.0

14.4

38.8

27.7

22.4

15.1

IM 11.8

7.0

15.1

9.4

17.7

14.7

24.2

15.2

16.2

20.2

20.7

13.9

19.4

26.2

20.0

14.6

AS

30.1

13.3

22.1

12.2

43.0

26.1

24.0

18.9

46.1

32.6

24.1

14.9

42.8

35.0

23.2

15.8

3

4

6

7

9

Note— Bin – is binnging factor. Impl – is implementation of the optimization method. Four subsequent large columns
contain numerical characteristics of reconstructed ﬁeld. Column’s title provide information of the starting layer and
whether preprocessing was applied.

5.1. Description of the NLFFF optimization methods

In both implementations used in this paper the
NLFFF reconstructions are performed following the op-
timization method (Wheatland et al. 2000). The main
idea of the optimization method is to transform some
trial conﬁguration of the magnetic ﬁeld (usually a po-
tential extrapolation from the bottom boundary) to a
ﬁnal force-free ﬁeld conﬁguration. This is achieved by
minimization of the following, positively deﬁned, func-
tional:

L =

−2 [[∇ × B] × B]2 + |∇ · B|2

B

w(x, y, z)dV,

ZV h

i

(11)

where w(x, y, z) is a ’weight’ function deﬁned below.

It is obvious that if the magnetic ﬁeld B has a force-
free conﬁguration everywhere in the volume of interest
V then L must be zero. In practice, the solution with
L = 0 is hardly achievable, so minimization of the func-
tional leads to an approximate force-free solution for
the magnetic conﬁguration. Solving the minimization
problem (see Appendixes in Wheatland et al. (2000);
Wiegelmann (2004), for the detailed math) yields two

equations, which optimize the magnetic ﬁeld in the in-
ner volume and on the boundaries of the computational
domain.

The two implementations of the optimization method
used in our study are diﬀerent in how the bound-
ary zone is treated.
IM implementation takes into
account both optimization equations as detailed by
Rudenko & Myshyakov (2009) such as the magnetic
ﬁeld is allowed to reconﬁgure everywhere in the vol-
ume of interest including its top and side boundaries;
w ≡ 1 in this implementation. The magnetic ﬁeld at the
bottom boundary, which represents the input magne-
togram, remains ﬁxed during the optimization. Having
variable magnetic ﬁeld at the top and side boundaries
is potentially helpful, because, given that the NLFFF
reconstruction is initiated with a potential conﬁgura-
tion, ﬁxing the potential ﬁeld at these boundaries may
have negative impact on the force-freeness of the recon-
structed magnetic ﬁeld.

The alternative, AS implementation follows Wiegelmann

function:
(2004) approach in selecting the weight
w(x, y, z) = wx(x)wy(y)wz(z), where the factors wx(x)
and wy(y) are both equal to 1 in the internal area of
the simulation cube (0.1 − 0.9) · Lx,y. In the buﬀer zone

14

Fleishman et al.

outside this internal area the factors wx(x) and wy(y)
decrease towards zero as the cos-functions. The other
factor, wz(z) = 1 for the heights (0 − 0.9) · Lz and then
goes to zero as the cos-function. The magnetic ﬁeld
at the top and side boundaries is frozen to be the po-
tential one; the same as has been used to initialize the
optimization. After each successful iteration the step
is increased by a factor of 1.03, while after each unsuc-
cessful iteration the step is reduced by the factor of 0.8.
The optimization ends when the step has become less
than 0.01 of the initial step.

One modiﬁcation of the AS implementation relative
to the original method is the selection of initial approx-
imation for the magnetic ﬁeld (that follows a multigrid
extension proposed by Metcalf et al. 2008): for the most
sparse grid (bin 9 in our tests) the initial approximation
is the potential ﬁeld, while for each next, denser grid
the initial ﬁeld is taken as an appropriate interpolation
of the ﬁnal (NLFFF) state of the previous grid. The
mentioned modiﬁcations optimize the simulation time
but have almost no eﬀect on the ﬁnal metrics of the
reconstructed NLFFF cube.

Alternative implementations has diﬀerent time perfor-
mances. Both codes spend comparable time for a single
iteration. For example, in case of bin 9, IM code does
≈ 770 iterations per second, while the speed of AS code
is ∼ 200 iterations per second (calculations were per-
formed on 4 core 3.4 GHz processor). However, AS code
has to make only about 2, 500 iterations in total to get
the ﬁnal result for bin=9 due to dynamically changed
time step; the number of required iterations is getting
signiﬁcantly smaller (several hundreds) for the higher-
resolution grids as they use interpolated solution of the
scarcer grid as the initial condition, which is a much
better approximation to the reality than the potential
extrapolation used for bin=9 case. IM code has a ﬁxed
time step, makes 105 iterations in total and even more
for lower bin factors. Therefore AS implementation re-
quires a considerably shorter computational time.

5.2. Metrics for evaluation of the NLFFF method

performance

There are two questions we want to answer about the
performance of our NLFFF extrapolation codes: (1) how
close the ﬁnal data cubes are to the targeted force-free
state and (2) how well they reproduce the original ﬁeld
in the entire 3D domain. To address the ﬁrst question
we use the same metrics as we have used to evaluate the
force-freeness of the original model ﬁeld itself, Eqns (3)–
(4).

To assess how close the NLFFF extrapolated data
cube is to the corresponding model data cube, we use

the “angular” metrics similar to Eqn (3):

θm = arccos

N
i τi
N !

  P

,

θmj = arccos

N
i

|j|i τi
N
|j|i !
i

,

  P
P

τi =

BNLFFF, i · Bi
|BNLFFF|i |B|i

,

(12)

where j is the electric current density, computed for re-
constructed ﬁeld, the summation is performed over the
voxels of the analyzed volume subdomain, τi is the co-
sine of the angle between the restored and model mag-
netic ﬁeld at the i-th node of the computational grid; θm
is the angle averaged over all nodes, in the ideal case of
the force-free ﬁeld it must be zero; θmj is a similar met-
rics but weighted with the restored electric current that
ensures that the contribution form nodes with strong
electric current dominates this metrics. For a voxel-to-
voxel inspection we compute the local error (residual)
∆α[j], the local relative error δα[j], and local normal-
ized residual χ2

α[j] as

∆α[j] = BNLFFF,α[j] − Bα[j],

δα[j] =

BNLFFF,α[j] − Bα[j]
hBα[j]i

,

α = x, y, or z, (13)

χ2

α[j] =

(BNLFFF,α[j] − Bα[j])2
δB2

α[j]

,

α = x, y, or z,

(14)
where j is the number of a given voxel, hBαi =

2
α + δB2

B

α, Bα[j] and δB2

α are deﬁned for each bin-
ning factor by Equations (1) and (2), while BNLFFF,α
q
is the corresponding component of the magnetic ﬁeld
obtained from the extrapolation. Here, to compute the
relative error we take into account that after the cube
rebinning the magnetic ﬁeld in each voxel is only known
to the accuracy of Bα ± δBα. Thus, in the denominators
of δα[j] in Eq. (13) we use hBαi rather than Bα; other-
wise, in ‘singular’ points, where Bα in the denominator
is very close to zero, such a metrics would artiﬁcially
underestimate the accuracy. However, to compute a
similar metrics for the absolute value of the magnetic
ﬁeld vector, we do not add any δB because the absolute
value is never too close to zero in the analyzed volume.
To characterize the extrapolation performance in a
given subdomain, which can be, for example, a given
layer or the entire data cube, we use the normalized
rms residual ∆rms, the normalized rms error δrms, and
’eﬀective χ2’ metrics deﬁned as

NLFFF–MHD CASTING

15

∆rms,α =

∆2

α[j]

2
α[j]

B

Nvox

j=1
P
Nvox

j=1
P

v
u
u
u
u
u
u
t

,

α = x, y, or z,

(15)

δrms,α =

1
Nvox

Nvox

j=1
X

v
u
u
t

δ2
α[j],

α = x, y, or z,

(16)

χ2

eﬀ,α =

1
Nvox

Nvox

j=1
X

χ2

α[j],

α = x, y, or z,

(17)

where the summation is performed over the subdomain
of the data cube5 used for the analysis; Nvox is the to-
tal number of voxels in the selected subdomain. The
normalized rms residual, Eq. (15), is similar to metrics
(7) used to evaluate the preprocessing performance; this
metric gives more weight to the voxels, where the mag-
netic ﬁeld is strong. In contrast, metric (16) gives equal
weight to any voxel, with either strong or weak ﬁeld.
The χ2 metrics weights the voxel in accordance with
the uncertainty to which the magnetic ﬁeld is known in
the given voxel.

5.2.1. NLFFF extrapolations from the chromospheric

boundary

We expect that any extrapolation approach will per-
form best if the bottom boundary condition is close to
being force-free. Thus, testing the extrapolation per-
formance from the nearly force-free chromospheric layer
will characterize the true potential of the given extrapo-
lation code itself. For this reason we begin our tests from
the NLFFF data cubes extrapolated from the chromo-
spheric level.

Table 10 presents angular metrics that characterize
the force-freeness of the reconstructed ﬁeld (the angles
θ and θj) and its closeness to the original model ﬁeld
(the angles θm and θmj) computed for the entire 3D
volume above the bottom boundary and excluding the
top and side buﬀer zones. It is interesting that the IM
code provides a more force-free magnetic ﬁeld than the
one in the model: the corresponding values θ and θj in
Table 10 are systematically lower than those in Table 1.
This implies that the dynamics and the ﬁnite gas pres-
sure in the coronal volume described by the MHD model

50

25

0

-25

-50

50

25

0

-25

-50

G

,
z
B
d
e
r
o
t
s
e
R

G

,
z
B
d
e
r
o
t
s
e
R

G

,
z
B
d
e
r
o
t
s
e
R

G

,
x
B
d
e
r
o
t
s
e
R

G

,
x
B
d
e
r
o
t
s
e
R

G

,
x
B
d
e
r
o
t
s
e
R

(a) IM chr

bin3

(b) AS chr
bin3

50

25

0

-25

-50

(c) IM ph (d) AS ph

bin3

bin3

100

50

0

-50

-100

100

50

0

-50

-100

-50 -25 0

25 50

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

50

25

0

-25

-50

bin6

bin6

50

25

0

-25

-50

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

-50 -25 0

25 50

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

bin9

bin9

50

25

0

-25

-50

50

25

0

-25

-50

100

50

0

-50

-100

bin9

bin9

100

50

0

-50

-100

-50 -25 0

25 50

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

Model Bz, G

Model Bz, G

Model Bz, G

Model Bz, G

Figure 7. 2D histograms of Bz reconstruction obtained
using two methods, IM & AS, from the chromosphere and the
β-photosphere without preprocessing—in 3D volume. The
buﬀer zone is discarded everywhere.

(a) IM chr

bin3

(b) AS chr
bin3

50

25

0

-25

-50

(c) IM ph (d) AS ph

bin3

bin3

100

50

0

-50

-100

100

50

0

-50

-100

-50 -25 0

25 50

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

50

25

0

-25

-50

bin6

bin6

50

25

0

-25

-50

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

-50 -25 0

25 50

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

bin9

bin9

50

25

0

-25

-50

50

25

0

-25

-50

100

50

0

-50

-100

bin9

bin9

100

50

0

-50

-100

-50 -25 0

25 50

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

Model Bx, G

Model Bx, G

Model Bx, G

Model Bx, G

Figure 8. 2D histograms of Bx reconstruction obtained
using two methods, IM & AS, from the chromosphere and the
β-photosphere without preprocessing—in 3D volume. The
buﬀer zone is discarded everywhere.

produce a measurable deviation of the coronal magnetic
ﬁeld from the force-free state, while the NLFFF opti-
mization drives the magnetic data cube towards another,
more force-free, solution. Nevertheless, the extrapolated
ﬁeld is reasonably close to the model one; see θm and
θmj metrics. In contrast, the ﬁeld restored with the AS
code is less force-free than the model one, which is likely
a negative eﬀect of the ﬁxed top and side boundary con-
ditions and the buﬀer zone employed in this method.

5

All
study

reconstructed
are

data
at

cubes

obtained

in
web-site:

our
http://www.ioffe.ru/LEA/SF_AR/files/Magnetic_data_cubes/Extrapolations-Bifrost/index.html.

available

project

our

 
 
 
 
 
 
 
 
 
 
 
 
Fleishman et al.

G

,
y
B
d
e
r
o
t
s
e
R

G

,
y
B
d
e
r
o
t
s
e
R

G

,
y
B
d
e
r
o
t
s
e
R

16

(a) IM chr

bin3

50

25

0

-25

-50

-50 -25 0

25 50

(b) AS chr
bin3

50

25

0

-25

-50

(c) IM ph (d) AS ph

bin3

bin3

100

50

0

-50

-100

100

50

0

-50

-100

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

50

25

0

-25

-50

bin6

bin6

50

25

0

-25

-50

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

-50 -25 0

25 50

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

50

25

0

-25

-50

bin9

bin9

50

25

0

-25

-50

bin9

bin9

100

50

0

-50

-100

100

50

0

-50

-100

-50 -25 0

25 50

Model By, G

-50 -25 0

25 50

-100 -50 0

50 100

-100 -50 0

50 100

Model By, G

Model By, G

Model By, G

Figure 9. 2D histograms of By reconstruction obtained
using two methods, IM & AS, from the chromosphere and the
β-photosphere without preprocessing—in 3D volume. The
buﬀer zone is discarded everywhere.

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

Bz, G at 2.14Mm

-10

-5

0

5

10

Bz, G at 5.86Mm

-10

-5

0

5

10

Bz, G at 10.86Mm

-10

-5

0

5

10

    48.97

    31.53

    14.09

    -3.35

   -20.79

   -38.23

   -55.67

    11.68

     7.84

     4.00

     0.16

    -3.68

    -7.51

   -11.35

     2.74

     1.81

     0.89

    -0.04

    -0.96

    -1.88

    -2.81

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

IM ∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

     2.25

     1.57

     0.90

     0.23

    -0.45

    -1.12

    -1.79

     2.82

     1.80

     0.78

    -0.24

    -1.26

    -2.27

    -3.29

     2.29

     1.51

     0.73

    -0.05

    -0.84

    -1.62

    -2.40

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

IM δ

Z, %

-10

-5

0

5

10

δ
Z, %

-10

-5

0

5

10

δ
Z, %

-10

-5

0

5

10

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

AS ∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

     2.25

     1.57

     0.90

     0.23

    -0.45

    -1.12

    -1.79

     2.82

     1.80

     0.78

    -0.24

    -1.26

    -2.27

    -3.29

     2.29

     1.51

     0.73

    -0.05

    -0.84

    -1.62

    -2.40

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

AS δ

Z, %

-10

-5

0

5

10

δ

Z, %

-10

-5

0

5

10

δ

Z, %

-10

-5

0

5

10

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

Figure 10. The model Bz ﬁeld distributions (left column)
and performance of the IM (next two columns) and AS (two
right columns) NLFFF extrapolations (Bz component) from
the chromospheric level (bin=3) at three levels (their height
are shown at the panel titles); second and fourth columns:
residual between the extrapolated and the model ﬁeld; third
and ﬁfth column: relative error. The residual is within 2–3 G
at all levels, while the relative error increases with height,
because the ﬁeld strength decreases with the height. The
relative error is also bigger along the ‘neutral lines,’ where
the ﬁeld is close to zero. The results for other components
and other binning factors are similar to those shown in this
ﬁgure. The animated version of this ﬁgure shows the same
information but for all layers of the reconstructed Bz data
cubes separately for the IM and AS extrapolations. Each
frame of the animations shows four panels at a given layer:
(a) the model ﬁeld, (b) the restored ﬁeld, (c) the residual,
and (d) the relative error.

Likewise in the preprocessing tests, we are looking if
the restored values of the magnetic ﬁeld components (or
the absolute values) correlate with the model ones and
what is the scatter around the cross-correlation curves.
Figures 7—9, two left columns, display these cross-

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

By, G at 2.14Mm

-10

-5

0

5

10

By, G at 5.86Mm

-10

-5

0

5

10

By, G at 10.86Mm

-10

-5

0

5

10

    25.82

    18.11

    10.41

     2.71

    -4.99

   -12.69

   -20.39

     6.19

     4.27

     2.36

     0.45

    -1.47

    -3.38

    -5.30

     1.69

     1.19

     0.69

     0.19

    -0.31

    -0.81

    -1.31

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

IM ∆

Y, G

-10

-5

0

5

10

∆

Y, G

-10

-5

0

5

10

∆

Y, G

-10

-5

0

5

10

     2.79

     1.94

     1.10

     0.26

    -0.59

    -1.43

    -2.27

     3.15

     2.35

     1.55

     0.75

    -0.05

    -0.86

    -1.66

     1.71

     1.29

     0.87

     0.45

     0.03

    -0.38

    -0.80

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

IM δ

Y, %

-10

-5

0

5

10

δ
Y, %

-10

-5

0

5

10

δ
Y, %

-10

-5

0

5

10

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

AS ∆

Y, G

-10

-5

0

5

10

∆

Y, G

-10

-5

0

5

10

∆

Y, G

-10

-5

0

5

10

     2.79

     1.94

     1.10

     0.26

    -0.59

    -1.43

    -2.27

     3.15

     2.35

     1.55

     0.75

    -0.05

    -0.86

    -1.66

     1.71

     1.29

     0.87

     0.45

     0.03

    -0.38

    -0.80

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

AS δ

Y, %

-10

-5

0

5

10

δ

Y, %

-10

-5

0

5

10

δ

Y, %

-10

-5

0

5

10

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

Figure 11. The model By ﬁeld distributions (left column)
and performance of the IM (next two columns) and AS (two
right columns) NLFFF extrapolations (By component) from
the chromospheric level (bin=3) at three levels (their height
are shown at the panel titles); second and fourth columns:
residual between the extrapolated and the model ﬁeld; third
and ﬁfth column: relative error. The residual is within 2–3 G
at all levels, while the relative error increases with height,
because the ﬁeld strength decreases with the height. The
relative error is also bigger along the ‘neutral lines,’ where
the ﬁeld is close to zero. The results for other components
and other binning factors are similar to those shown in this
ﬁgure. The animated version of this ﬁgure shows the same
information but for all layers of the reconstructed By data
cubes separately for the IM and AS extrapolations. Each
frame of the animations shows four panels at a given layer:
(a) the model ﬁeld, (b) the restored ﬁeld, (c) the residual,
and (d) the relative error.

correlation plots in the form of 2D histograms super-
imposed on the y = x diagonal line. These plots suggest
that the performance of the extrapolations improves for
higher binning factors; in particular the ‘clouds‘ in the
area of poorer restored weak ﬁeld values (around zero)
are bigger for the smaller binning factors. Comparison
between the two methods suggests that the IM approach
works better for small magnetic ﬁeld values, while for
large magnetic ﬁeld both methods perform comparably
or, sometimes, the AS method performs marginally bet-
ter. We will return to this comparison later.

Figures 10, 11 give a clear visual idea of the optimiza-
tion code performance at three layers: one close to the
bottom of the cube, another one—in a middle height,
and the last one—close to the top buﬀer zone in the AS
code (for fair comparison of the methods we exclude the
same buﬀer zone in both AS and IM cases). The error
(2nd and 4th columns) of the magnetic ﬁeld reconstruc-
tion slightly increases with height: although the scale of
the error variation is almost the same at all of the three
presented levels, −2 G . ∆z . 2 G, the areas occupied
by blue or red colors (indicating bigger errors) increase
with the height. As a result, the relative error (3rd and
5th columns) increases with the height noticeably: the
green area where the relative error is within ±10% is
getting smaller with height. The relative error is get-

 
 
 
 
 
 
NLFFF–MHD CASTING

17

ting large at neutral lines (i.e., where the magnetic ﬁeld
is about zero) at any layer, even at the one closest to
the bottom.

At the low heights the two competing methods per-
form comparably well: although the AS methods shows
smaller error in the middle of the plot, where the mag-
netic ﬁeld is reasonably large, it also produces some
artifacts close to the boundaries, which is not surpris-
ing given that the method employs a buﬀer zone at the
boundary regions. It is, however, interesting, that at the
intermediate heights the AS method provides a bigger
green area in the plot, where the relative error of the ﬁeld
reconstruction is within 10 %, than the IM method, al-
though the IM method outperforms the AS one at higher
heights. A qualitatively similar picture is observed for
two other components of the magnetic ﬁeld: By (Fig. 11)
and Bx (not shown).

The fact that we created our model data cubes by
rebinning the original data cube implies that the mag-
netic ﬁeld value Bα in a given voxel is only known to
the accuracy Bα ± δBα deﬁned by Eqns (1), (2); thus,
even the most precise ﬁeld reconstruction would only
recover the ﬁeld to this accuracy. Stated another way,
an ideally perfect reconstruction would have χ2
α[j] ∼ 1
eﬀ,α ∼ 1. We evaluated the χ2
and χ2
eﬀ,α metrics for
our extrapolation data cubes and found them to be
much larger than 1 in all cases.
Inspection of the in-
puts used to compute χ2
eﬀ,α metrics shows that the δBα
from Eqn. (2) are very small implying that the magnetic
ﬁeld in the model volume is known with very high ac-
curacy even after rebinning. No reconstruction can be
performed with that high accuracy; so the formal χ2 test
fails.

However, the reconstruction often provides the accu-
racy of 10—30% (see Figures 10, 11), which is fully
acceptable for most of the practical applications, even
though it is not that perfect as the accuracy of the orig-
inal model ﬁeld. To further quantify that, Figure 12a,b
shows the height dependence for the normalized rms
error of the absolute value and all components of the
magnetic ﬁeld for a representative set of three diﬀerent
binnings. A few observations can be made from this Fig-
ure. Firstly, the performance of both methods improves
from small to large bin factors. Given that Figures 10
and 11 contain domains with the local error larger than
70%, the rms error can be rather large, especially at
higher heights. Secondly, reconstruction of the By com-
ponent is not that good as for Bx or Bz components.
This is an outcome of asymmetry of the original model,
in which the By values are systematically smaller than
other components. Thirdly, the absolute value of the
magnetic ﬁeld is recovered much better than any single

(a) IM chr

bin3

(b) AS chr
bin3

(c) IM ph (d) AS ph

bin3

bin3

Bx
By
Bz
|B|

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

0

2

6
4
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

bin6

bin6

bin6

bin6

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

0

2

6
4
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

bin9

bin9

bin9

bin9

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

%

,
s
m

r

δ

300
250
200
150
100
50
0

0

2

6
4
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

0

2

4
6
Height, Mm

8 10 12

Figure 12. Relative rms error in a layer as a function of
height for the NLFFF reconstructions obtained using two
methods, IM & AS, from the chromosphere and the β-
photosphere without preprocessing. The side buﬀer zones
are discarded everywhere, while the height of the top buﬀer
zone is shown by the dashed vertical line.

component of the ﬁeld, which looks unexpected but as
we show below this is an outcome of large errors coming
from the weak ﬁeld contributions. And ﬁnally, we ﬁnd
that the IM code works on average better than the AS
code, while extrapolation is being made starting from
the chromospheric magnetogram; see Table 11 for the
level-by-level comparison of the normalized rms error in
the case of bin=9. We believe, this is a direct outcome
of taking into account the equations for the force-free
ﬁeld boundaries of the modeling cube: having an al-
most force-free ﬁeld bottom boundary conditions at the
chromospheric level is better consistent with the force-
free boundaries (IM) than with the buﬀer zone with the
potential boundaries (AS).

The absolute values of the normalized rms errors are
rather large, which is the outcome of large errors in re-
covering small (close to zero) values of the ﬁeld com-
ponents. To explicitly demonstrate that, we turn to
the normalized rms residual, which is weighted with
the strong ﬁeld contributions. Figure 13a,b displays
the height dependence of the normalized rms residuals
for IM and AS codes respectively; see Table 12 for the
level-by-level comparison of the normalized rms residual
in the case of bin=9. This plot and the Table conﬁrm
that the magnetic ﬁeld is recovered more accurately in
the voxels with the large magnetic ﬁeld. In particular,
now the absolute value of the ﬁeld and its components
are restored with a comparable accuracy (although the
transverse components often display a bigger error than
the longitudinal component). This metric only slightly
depends on the grid resolution because the most numer-
ous voxels with a weak ﬁeld (which are more numer-

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
Table 11. Normalized rms error at a given level for bin-factor 9.

δrms(B)

δrms(Bx)

δrms(By)

δrms(Bz)

chromo

β-photo

chromo

β-photo

chromo

β-photo

chromo

β-photo

Level, Mm

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

0.86

1.29

1.71

2.14

2.57

3.00

3.43

3.86

4.29

4.71

5.14

5.57

6.00

6.43

6.86

7.29

7.71

8.14

8.57

9.00

9.43

9.86

10.29

10.71

11.14

-

-

-

0.00

1.43

2.34

3.25

4.31

5.33

6.25

7.08

7.93

8.72

9.63

-

-

-

0.00

2.21

4.38

6.40

7.09

8.55

8.98

9.97

0.00

0.00

13.22

15.80

11.83

19.44

-

-

-

-

-

-

11.28

17.82

0.00

0.00

11.27

16.83

12.60

13.75

11.26

17.54

19.70

27.23

11.43

16.50

24.16

33.32

12.03

17.02

25.46

38.36

0.00

41.50

54.58

52.36

45.84

46.90

46.40

47.57

0.00

51.53

77.71

83.10

73.84

79.76

79.76

91.95

-

-

-

-

-

-

0.00

0.00

48.41

64.89

68.40

122.66

-

-

-

0.00

0.00

76.79

150.87

0.00

18.60

45.44

98.33

177.45

11.36

31.38

144.01

147.28

259.00

22.30

48.00

184.75

190.45

280.19

32.75

67.50

157.94

172.51

230.89

33.39

12.84

16.35

29.48

48.58

55.01

102.57

71.85

125.21

147.31

178.25

35.67

13.75

16.65

33.59

57.48

65.65

113.74

75.95

129.38

156.30

184.49

39.86

14.79

16.05

33.71

68.16

62.19

125.21

85.61

169.44

185.57

221.02

45.60

10.28

16.08

16.36

35.51

84.52

61.14

138.04

114.93

203.77

233.19

252.55

53.54

11.19

17.46

16.22

37.03

81.69

60.85

139.94

138.18

226.76

273.98

261.13

55.65

11.73

18.86

16.85

40.70

93.39

68.74

153.62

160.61

257.38

319.05

290.81

55.29

10.47

12.36

19.81

16.87

44.69

106.27

77.61

165.73

138.80

221.37

285.29

243.29

56.07

11.34

13.21

21.22

18.02

46.95

119.11

84.25

177.37

148.52

228.13

309.66

251.31

58.98

-

-

-

0.00

11.21

20.17

28.91

32.08

50.82

53.36

63.24

70.00

74.83

77.39

86.16

95.69

0.00

28.98

30.94

34.28

32.92

33.03

43.18

49.91

57.52

72.54

82.46

94.02

98.34

95.58

0.00

32.92

55.48

37.58

35.95

42.88

56.51

65.25

76.18

83.33

84.68

91.71

92.08

94.24

89.36

101.62

85.24

111.87

12.30

14.66

22.99

19.37

49.63

132.08

92.43

189.03

170.13

246.65

344.42

266.38

64.64

113.54

83.16

129.34

13.37

16.07

24.90

21.19

53.43

145.35

100.12

198.74

189.50

260.63

370.92

282.46

74.22

137.59

82.77

154.39

14.41

17.74

27.06

22.95

57.27

158.31

109.08

210.81

200.99

267.05

392.14

287.85

83.27

156.08

85.29

173.00

15.50

19.49

29.60

25.21

61.65

171.14

119.76

220.42

217.77

287.73

431.59

311.45

84.57

155.05

82.42

171.96

16.92

21.85

32.90

27.76

66.06

181.68

127.53

228.34

243.57

325.13

497.96

348.70

90.25

159.59

84.62

176.12

18.70

24.49

37.03

30.87

68.89

189.89

136.12

231.95

258.39

339.71

539.04

364.20

107.26

177.86

96.88

195.19

20.69

27.21

41.73

33.76

72.72

197.35

147.00

236.25

258.66

316.44

528.81

336.67

129.45

197.34

108.42

215.54

23.21

30.01

47.38

36.83

79.75

210.62

162.30

245.62

282.73

328.77

564.24

348.96

160.20

220.26

130.77

238.96

26.26

32.92

54.07

39.79

87.27

225.24

179.17

255.57

315.55

345.40

591.32

368.48

198.86

246.45

159.97

265.59

1
8

F
l
e
i
s
h
m
a
n

e
t

a
l
.

Table 12. Normalized rms residual at a given level for bin-factor 9.

∆rms(B)

∆rms(Bx)

∆rms(By)

∆rms(Bz)

chromo

β-photo

chromo

β-photo

chromo

β-photo

chromo

β-photo

Level, Mm

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

0.86

1.29

1.71

2.14

2.57

3.00

3.43

3.86

4.29

4.71

5.14

5.57

6.00

6.43

6.86

7.29

7.71

8.14

8.57

9.00

9.43

9.86

10.29

10.71

11.14

-

-

-

0.00

0.82

1.61

2.43

3.27

4.12

5.01

5.92

6.84

7.79

8.74

9.65

10.47

11.22

11.92

12.57

13.19

-

-

-

0.00

0.82

1.59

2.17

2.74

3.32

3.89

4.52

5.13

5.72

6.24

6.74

7.18

7.66

8.22

8.90

9.73

0.00

5.16

4.34

4.02

4.25

4.85

5.66

6.62

7.70

8.87

10.10

11.34

12.54

13.68

14.79

15.90

17.03

0.00

5.95

6.09

4.95

4.64

4.72

4.74

5.08

5.31

5.87

6.27

6.94

7.35

7.93

8.34

9.06

9.71

-

-

-

0.00

3.41

5.22

6.62

7.75

8.58

9.74

-

-

-

0.00

3.25

5.91

8.71

0.00

0.00

10.47

11.99

10.26

14.07

10.00

14.95

10.35

15.24

11.21

16.83

-

-

-

-

-

-

0.00

6.29

8.48

0.00

5.87

9.47

0.00

0.00

14.83

16.32

16.27

20.13

16.45

21.28

17.80

22.35

19.20

23.70

12.19

18.68

11.19

12.73

20.84

25.71

10.45

13.32

20.55

14.39

15.33

23.85

28.95

13.20

14.85

23.71

14.30

18.39

25.44

30.09

16.56

17.05

27.22

15.72

21.65

28.52

32.70

11.25

20.00

19.54

31.35

17.90

27.42

33.43

37.25

-

-

-

0.00

2.37

4.17

5.48

6.27

7.28

8.46

9.52

-

-

-

0.00

2.01

3.28

4.39

5.63

6.95

8.28

9.54

0.00

5.72

6.43

7.03

8.12

9.42

10.95

0.00

6.52

9.65

8.04

8.26

8.91

9.69

12.33

10.69

13.96

11.56

15.83

12.86

17.73

13.89

12.75

23.50

21.99

35.14

19.98

32.22

39.22

41.67

10.51

10.86

19.57

15.18

14.38

26.84

24.59

39.05

22.80

37.90

46.14

46.25

11.52

12.36

21.36

16.41

16.09

30.25

27.22

42.38

26.35

42.63

53.99

50.05

12.59

13.90

23.07

17.87

17.65

33.24

29.66

45.49

30.74

47.13

62.82

53.38

13.64

15.46

24.67

19.30

18.88

36.20

31.71

48.31

36.20

51.63

71.56

57.49

14.59

17.02

26.12

20.77

20.02

39.07

33.60

51.25

39.73

54.41

77.35

59.64

15.51

18.43

27.53

22.09

18.20

10.73

21.30

42.53

35.82

54.56

41.81

55.22

81.15

60.63

16.33

19.82

28.93

23.35

19.49

11.74

22.77

45.91

38.20

57.75

44.67

57.16

85.70

62.17

16.97

20.92

30.34

24.39

21.00

13.11

23.99

48.98

40.15

60.23

47.68

59.17

91.25

64.35

17.88

22.33

32.16

25.74

13.93

10.83

22.86

14.53

25.10

51.61

41.95

62.20

50.31

60.94

96.05

65.71

19.40

24.04

34.69

27.57

14.82

12.18

25.18

16.29

26.07

54.19

43.69

63.82

52.47

61.42

100.18

66.14

21.48

26.32

38.13

29.97

15.86

13.80

28.03

18.12

26.99

56.54

45.50

65.12

54.51

61.29

104.38

65.47

24.13

29.03

42.77

33.04

17.17

15.63

31.58

20.18

27.87

59.03

47.44

66.23

56.75

60.18

108.74

64.02

27.54

32.55

49.08

36.91

18.96

17.74

35.95

22.37

29.07

61.01

49.48

66.74

59.80

58.38

113.66

61.87

32.25

37.10

57.94

41.99

N
L
F
F
F
–
M
H
D
C
A
S
T
I
N
G

1
9

20

Fleishman et al.

(a) IM chr

(b) AS chr

(c) IM ph

(d) AS ph

bin3
Bx
By
Bz
|B|

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

bin6

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

bin9

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

Figure 13. Relative rms residual in a layer as a func-
tion of height for the NLFFF reconstructions obtained us-
ing two methods, IM & AS, from the chromosphere and the
β-photosphere without preprocessing. The side buﬀer zones
are discarded everywhere, while the height of the top buﬀer
zone is shown by the dashed vertical line.

ous for higher resolution data cubes) give only a weak
contribution to this metric. The two methods recover
the absolute value and Bz component comparably well,
but the IM code outperforms the AS one in recovering
the transverse components (especially, Bx). In all cases
the normalized rms residual for the absolute value |B|
and vertical component Bz is within 20% while for the
transverse components—within 40%. Overall, we can
conclude that these extrapolations from the force-free
chromospheric level work rather well.

5.2.2. NLFFF extrapolations from the β-photospheric

boundary

For the extrapolation from the β-photosphere bound-
ary (without preprocessing) we computed the same met-
rics as for the chromospheric case. The angular metrics
Table 10 show generally the same trends as for the chro-
mosphere, but with larger values of the angles, which
is expected. Again, the IM code often produces more
force-free data cube than the model one. Figures 7—
9c,d display the cross-correlation between the restored
and model ﬁeld in the volume above the β-photosphere
(the buﬀer zone excluded). Although the scatter around
the y = x diagonal is larger than in the chromospheric
case, the distribution follows the y = x dependence re-
markably well for all components of the magnetic ﬁeld.
This is highly important because this tells us that the
NLFFF extrapolations, even when start from a non-
force-free photospheric boundary, preserve the correct
height scale, which is essential for all tasks that include
the model-to-data comparison.

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

Bz, G at 1.00Mm

-10

-5

0

5

10

Bz, G at 5.86Mm

-10

-5

0

5

10

Bz, G at 10.71Mm

-10

-5

0

5

10

   138.64

    85.75

    32.87

   -20.02

   -72.90

  -125.79

  -178.67

    11.68

     7.84

     4.00

     0.16

    -3.68

    -7.51

   -11.35

     2.86

     1.89

     0.93

    -0.03

    -1.00

    -1.96

    -2.92

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

IM ∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

     2.25

     1.57

     0.90

     0.23

    -0.45

    -1.12

    -1.79

     2.82

     1.80

     0.78

    -0.24

    -1.26

    -2.27

    -3.29

     2.29

     1.51

     0.73

    -0.05

    -0.84

    -1.62

    -2.40

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

IM δ

Z, %

-10

-5

0

5

10

δ
Z, %

-10

-5

0

5

10

δ
Z, %

-10

-5

0

5

10

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

AS ∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

∆

Z, G

-10

-5

0

5

10

     2.25

     1.57

     0.90

     0.23

    -0.45

    -1.12

    -1.79

     2.82

     1.80

     0.78

    -0.24

    -1.26

    -2.27

    -3.29

     2.29

     1.51

     0.73

    -0.05

    -0.84

    -1.62

    -2.40

10

5

0

-5

-10

10

5

0

-5

-10

10

5

0

-5

-10

AS δ

Z, %

-10

-5

0

5

10

δ
Z, %

-10

-5

0

5

10

δ
Z, %

-10

-5

0

5

10

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

>70

50

30

10

-10

-30

-50

<-70

Figure 14. The model Bz ﬁeld distributions (left column)
and performance of the IM (next two columns) and AS (two
right columns) NLFFF extrapolations (Bz component) from
the β-photospheric level (bin=3) at three levels (their height
are shown at the panel titles); second and fourth columns:
residual between the extrapolated and the model ﬁeld; third
and ﬁfth column: relative error. The residual is within 2–3 G
at all levels, while the relative error increases with height,
because the ﬁeld strength decreases with the height. The
relative error is also bigger along the ‘neutral lines,’ where
the ﬁeld is close to zero. The results for other components
and other binning factors are similar to those shown in this
ﬁgure. The animated version of this ﬁgure shows the same
information but for all layers of the reconstructed Bz data
cubes separately for the IM and AS extrapolations. Each
frame of the animations shows four panels at a given layer:
(a) the model ﬁeld, (b) the restored ﬁeld, (c) the residual,
and (d) the relative error.

Not surprisingly, the normalized rms error and resid-
ual are bigger, while extrapolating from the photosphere
In particular,
compared with the chromospheric case.
Figure 13c,d that the normalized rms residual metrics
for the photospheric case are roughly by a factor of two-
three larger that those for the chromospheric case. A
qualitative diﬀerence between the former and the latter
is that now we see a relatively big jump at the curves just
above the bottom boundary. This jump is an immediate
result from the conﬂict between the forced photospheric
boundary, which is not allowed to change, and the im-
plied force-free condition above this level: in fact, a few
more layers above the β-photosphere are also not force-
free; thus, the restored ﬁeld noticeably deviates from the
model one there.

Another interesting observation is that here the AS
method works better than the IM one for the absolute
value |B| and the vertical component Bz, although not
so well for the transverse components, especially—for
Bx, while the By component is recovered comparably
imperfect by both methods. This mismatch in the ac-
curacy of restoration of various components of the mag-
netic ﬁeld is a likely cause of the large angle error in the
AS extrapolation code. We conclude that the extrap-
olation from the (β-)photospheric level works accept-
ably well for many practical applications, even though

 
 
 
 
 
 
 
 
 
 
 
 
(a) IM chr

(b) AS chr

(c) IM ph (d) AS ph

(a) IM chr

(b) AS chr

(c) IM ph (d) AS ph

NLFFF–MHD CASTING

21

bin3

bin3

G

,
z
B
d
e
r
o
t
s
e
R

G

,
z
B
d
e
r
o
t
s
e
R

G

,
z
B
d
e
r
o
t
s
e
R

bin3

bin3

100

50

0

-50

-100

100

50

0

-50

-100

bin3

100

50

0

-50

-100

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

bin9

100

50

0

-50

-100

100

50

0

-50

-100

bin9

bin9

100

50

0

-50

-100

bin9

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

Model Bz, G

Model Bz, G

Model Bz, G

-100 -50 0

50 100

Model Bz, G

100

50

0

-50

-100

G

,
x
B
d
e
r
o
t
s
e
R

G

,
x
B
d
e
r
o
t
s
e
R

G

,
x
B
d
e
r
o
t
s
e
R

bin3

100

50

0

-50

-100

100

50

0

-50

-100

bin3

bin3

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

bin9

bin9

100

50

0

-50

-100

100

50

0

-50

-100

100

50

0

-50

-100

bin9

bin9

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

Model Bx, G

Model Bx, G

Model Bx, G

Model Bx, G

Figure 15. 2D histograms of Bz reconstruction obtained
using two methods, IM & AS, from the β-photosphere with
a preprocessing—in 3D volume. The buﬀer zone is discarded
everywhere.

Figure 16. 2D histograms of Bx reconstruction obtained
using two methods, IM & AS, from the β-photosphere with
a preprocessing—in 3D volume. The buﬀer zone is discarded
everywhere.

measurably less perfect than the extrapolation from the
chromospheric level; see Tables 11 and 12 for the level-
by-level comparison of the normalized rms error and
residual in the case of bin=9.

5.2.3. NLFFF extrapolations from a preprocessed boundary

Finally, we tested extrapolations from the photo-
spheric level after its preprocessing; speciﬁcally, we used
both preprocessed methods for both IM and AS extrap-
olation codes. Now, unlike the cases without prepro-
cessing, we include the bottom (preprocessed) layer in
the metrics computation given that it was modiﬁed com-
pared to the original model ﬁeld. Table 10 shows that
there is no coherent behavior of the metrics vs model
grid resolution. Sometimes, but not always, the overall
ﬁeld is getting more force-free than without preprocess-
ing (better θ metric), while less force-free in the sub-
volume with a strong electric ﬁeld (worse θj metric).

For the IM code the use of any preprocessing im-
proves agreement between the restored and model ﬁeld
for smaller binning factors (higher grid resolution): the
TW preprocessing works better for the bins 3 and 4,
while the JF one works better for larger bin factors,
where the extrapolation with the preprocessings shows
only marginal improvement (if any) compared with the
extrapolation without preprocessing.

However, the prize we pay for this marginally im-
proved angular metrics is the corrupted height scale,
which is vividly demonstrated by Figures 15—17.
Speciﬁcally, the magnetic ﬁeld extrapolated from the
JF preprocessed boundary condition shows a nice y = x
pattern for the Bz component, while deviates from that

(a) IM chr

(b) AS chr

(c) IM ph (d) AS ph

bin3

bin3

100

50

0

-50

-100

100

50

0

-50

-100

100

50

0

-50

-100

bin3

bin3

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

bin6

100

50

0

-50

-100

100

50

0

-50

-100

bin6

bin6

bin6

100

50

0

-50

-100

100

50

0

-50

-100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

bin9

100

50

0

-50

-100

100

50

0

-50

-100

bin9

bin9

bin9

100

50

0

-50

-100

100

50

0

-50

-100

G

,
y
B
d
e
r
o
t
s
e
R

G

,
y
B
d
e
r
o
t
s
e
R

G

,
y
B
d
e
r
o
t
s
e
R

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

-100 -50 0

50 100

Model By, G

Model By, G

Model By, G

Model By, G

Figure 17. 2D histograms of By reconstruction obtained
using two methods, IM & AS, from the photosphere with a
preprocessing—in 3D volume. The buﬀer zone is discarded
everywhere.

for both Bx and By components, which underestimate
the magnetic ﬁeld in the volume. In contrast, the use of
the TW preprocessed boundary condition overestimates
the magnetic ﬁeld components, but not equally:
the
Bz component is clearly stronger overestimated than
the transverse ones, which almost follow the y = x
regression in some cases.

Figure 18 reveals one more problem with the ﬁeld re-
construction starting from a preprocessed boundary: the
ﬁeld restoration error is large starting from the very bot-
tom layer with the normalized rms residual exceeding
10–15% in many cases, especially for the case of TW

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
Table 13. Normalized rms error after preprocessing at a given level for bin-factor 9.

∆rms(B)

∆rms(Bx)

∆rms(By)

∆rms(Bz)

JF

TW

JF

TW

JF

TW

JF

TW

Level, Mm

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

1.29

1.71

2.14

2.57

3.00

3.43

3.86

4.29

4.71

5.14

5.57

6.00

6.43

6.86

7.29

7.71

8.14

8.57

9.00

9.43

9.86

10.29

10.71

11.14

11.74

11.74

18.52

18.52

49.39

10.20

10.62

15.88

16.19

57.55

11.65

14.66

17.41

57.71

12.26

13.99

18.46

55.86

12.49

13.30

18.31

59.76

12.83

12.71

18.49

63.75

12.91

12.32

18.34

68.76

9.26

8.86

8.69

8.79

9.24

9.81

49.39

60.68

63.22

62.28

64.16

67.47

76.11

59.91

63.15

66.38

68.84

73.87

79.79

87.46

59.91

67.46

72.56

71.48

67.36

53.99

58.04

53.99

75.16

62.80

67.31

62.80

81.91

43.53

42.61

63.11

112.86

71.07

128.83

40.51

66.53

157.49

76.49

174.11

37.28

86.77

219.79

99.08

244.61

36.86

71.74

115.00

264.09

123.13

295.16

42.79

74.34

119.52

209.52

125.65

238.25

44.34

13.12

11.95

18.28

77.17

86.33

101.38

84.83

119.39

166.58

125.54

192.68

48.39

10.40

13.17

11.42

18.37

92.92

98.20

125.24

95.05

120.45

166.99

128.14

193.75

51.69

11.06

13.13

10.92

18.17

86.43

105.57

119.66

101.92

136.51

201.81

147.75

237.17

58.54

11.84

13.23

10.69

18.36

82.65

117.65

116.60

112.03

173.13

229.95

178.85

268.30

70.34

12.71

13.46

10.75

18.53

76.01

120.13

109.49

115.10

206.64

241.49

205.23

285.48

76.77

13.74

13.87

11.15

19.07

78.13

133.96

106.72

129.77

243.42

268.11

245.12

312.53

77.84

14.67

14.01

11.54

19.34

84.33

146.48

104.80

141.80

210.74

223.94

204.64

263.12

78.33

43.53

40.57

42.27

42.30

43.26

58.30

58.69

78.24

75.26

82.58

86.36

88.02

89.20

97.22

56.00

49.65

47.20

43.73

45.01

54.18

57.04

59.27

57.69

58.61

64.69

69.53

71.81

56.00

47.24

53.71

52.01

45.72

57.00

56.78

78.25

71.12

84.14

89.18

92.58

95.07

74.96

103.99

15.73

14.64

12.25

20.48

87.35

158.28

100.91

154.88

225.33

229.43

217.68

266.84

79.19

105.43

74.85

113.87

16.96

15.73

13.23

21.98

92.34

169.14

108.47

166.54

254.39

243.45

251.71

284.09

86.63

122.39

77.93

132.37

18.36

16.89

14.46

23.76

95.86

179.78

111.08

179.02

274.37

257.53

280.08

299.48

101.12

144.44

84.03

157.78

19.88

18.29

15.87

25.53

100.29

190.13

113.97

189.64

287.52

262.93

300.73

305.69

115.77

162.48

90.98

177.24

21.59

19.83

17.45

27.68

106.53

200.27

121.84

200.94

306.10

283.20

335.13

327.94

116.86

160.11

89.20

175.69

23.76

21.92

19.41

30.11

112.49

206.55

129.09

208.11

328.16

318.05

374.39

367.12

123.33

163.78

90.70

179.46

26.38

24.33

21.73

33.08

119.47

211.15

135.16

215.00

325.05

331.21

380.54

379.92

143.46

180.35

104.73

198.94

29.27

26.70

24.18

35.67

127.75

215.23

143.72

220.97

303.74

306.72

356.55

350.54

168.32

198.96

123.37

219.53

32.69

29.16

27.12

38.61

136.22

224.39

164.62

233.03

321.87

317.83

380.88

361.37

204.36

219.73

157.59

243.95

36.57

31.54

30.78

41.03

150.26

233.82

196.81

246.27

330.97

336.39

402.63

380.18

248.93

243.80

202.33

270.82

2
2

F
l
e
i
s
h
m
a
n

e
t

a
l
.

Table 14. Normalized rms residual after preprocessing at a given level for bin-factor 9.

∆rms(B)

∆rms(Bx)

∆rms(By)

∆rms(Bz)

JF

TW

JF

TW

JF

TW

JF

TW

Level, Mm

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

IM

AS

0.86

1.29

1.71

2.14

2.57

3.00

3.43

3.86

4.29

4.71

5.14

5.57

6.00

6.43

6.86

7.29

7.71

8.14

8.57

9.00

9.43

9.86

10.29

10.71

11.14

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

0.00

29.29

29.29

26.56

26.56

45.63

45.63

45.25

45.25

55.17

55.17

56.91

56.91

39.50

39.50

45.92

45.92

21.60

22.08

14.34

14.73

32.32

33.14

25.63

26.07

38.78

39.05

33.85

34.23

25.75

26.57

24.67

25.13

19.45

19.37

18.64

18.57

18.40

18.08

18.38

17.94

18.50

17.72

18.68

17.64

18.88

17.42

19.16

17.31

19.46

17.13

8.92

6.59

5.91

5.92

6.26

6.78

7.40

8.22

9.16

19.77

16.99

10.16

20.16

16.82

11.28

20.66

16.73

12.50

21.18

16.53

13.69

21.71

16.31

14.82

22.28

15.96

15.92

22.83

15.56

16.93

23.43

14.99

17.90

8.78

6.49

5.60

5.54

5.54

5.72

5.86

6.16

6.45

6.78

7.12

7.51

7.86

8.27

8.68

9.17

9.71

31.00

31.60

20.03

20.51

32.92

33.22

25.70

26.96

21.46

21.44

15.89

15.80

29.58

30.49

17.55

18.96

31.95

33.25

22.89

25.30

19.50

19.95

11.61

11.93

29.15

30.36

17.13

19.01

32.66

34.19

23.21

26.27

18.94

19.39

10.23

10.45

29.74

31.01

17.96

20.47

33.52

35.64

24.69

28.71

18.89

19.62

10.14

10.72

30.72

32.31

19.16

22.23

34.65

37.27

27.35

31.74

19.15

19.89

10.83

11.20

32.15

33.68

20.42

23.73

35.77

39.20

30.40

35.03

19.44

20.50

11.71

12.29

33.71

36.13

21.42

26.79

34.55

38.45

29.45

35.50

19.88

21.01

12.88

13.22

35.22

38.30

22.60

29.64

35.13

39.57

30.17

37.11

20.43

21.86

14.23

14.61

37.10

41.45

24.16

33.71

37.05

42.99

32.86

41.66

20.84

22.48

15.50

15.61

38.85

43.93

25.62

36.87

40.38

46.37

36.50

45.82

21.09

23.30

16.69

16.84

40.78

46.74

27.34

40.45

44.86

51.05

41.18

51.15

21.23

24.01

17.90

17.94

43.30

49.32

29.58

43.44

49.93

53.92

46.11

54.96

21.29

24.96

19.12

19.35

46.06

52.16

32.05

46.76

55.65

56.38

51.60

58.07

21.27

25.80

20.30

20.73

48.53

54.39

34.25

49.37

62.31

59.58

58.46

61.74

21.14

26.66

21.31

22.17

50.98

56.81

36.37

52.40

67.37

61.75

63.85

63.70

21.04

27.27

22.19

23.48

53.37

58.99

38.39

55.26

72.32

63.43

68.75

65.06

20.92

27.76

22.75

24.70

56.15

61.07

40.59

58.11

78.44

66.49

74.81

67.90

20.79

27.76

22.88

25.63

24.26

14.50

18.96

10.40

59.99

62.86

43.22

60.53

83.43

68.34

79.91

70.10

21.38

27.94

23.14

26.82

25.53

14.05

20.28

11.35

64.48

64.39

45.93

62.70

87.81

69.48

84.18

71.38

23.46

28.34

24.00

28.56

27.35

13.90

21.94

12.46

69.77

65.58

48.90

64.60

91.45

69.47

87.28

71.56

27.39

29.31

25.68

30.80

29.65

13.84

23.96

13.88

76.15

66.75

52.43

66.50

93.72

67.87

88.76

69.95

33.51

30.68

28.42

33.85

32.36

14.19

26.68

15.25

83.72

67.72

56.88

68.36

95.79

65.31

89.83

67.26

42.24

32.93

32.76

37.38

N
L
F
F
F
–
M
H
D
C
A
S
T
I
N
G

2
3

24

Fleishman et al.

(a) IM JF

(b) AS JF

(c) IM TW

(d) AS TW

bin3
Bx
By
Bz
|B|

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

bin6

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

bin9

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

%

,
s
m

r

∆

60

40

20

0

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

0

2

4

6
Height, Mm

8 10 12

Figure 18. Relative rms residual in a layer as a function
of height for the NLFFF reconstructions obtained using two
methods, IM & AS, from the photosphere with a preprocess-
ing. The side buﬀer zones are discarded everywhere, while
the height of the top buﬀer zone is shown by the dashed
vertical line.

preprocessing. We believe that this happens because
the magnetic ﬁeld becomes overly smooth due to the
preprocessing (this smoothing is stronger for the TW
preprocessing, see Section 4 and, speciﬁcally, Fig. 6; the
amount of smoothing can be reduced by lowering the µ4
parameter; however, it is well beyond our study to op-
timize the choice of the preprocessing parameters). At
somewhat higher layers, where the ﬁeld in the model
is smooth itself, the metric decreases and, thus, the
ﬁeld is more accurately reconstructed at the interme-
diate heights compared with the low height; see Ta-
bles 13 and 14 for the quantitative level-by-level compar-
ison of the normalized rms error and residual in the case
of bin=9 reconstruction from the preprocessed bound-
aries. Overall, the whole variety of the tests does not jus-
tify the use of preprocessing of the photospheric bound-
ary given that a marginal or no improvement in the vol-
umetric metrics is achieved at the expense of the height
scale corruption.

6. DISCUSSION & CONCLUSIONS

Here we have demonstrated that a realistic MHD
model, in the presented case—a en024048 hion simu-
lation (Carlsson et al. 2016) obtained with the Bifrost
code (Gudiksen et al. 2011), can be very eﬃciently used
to cast various tools used for the coronal magnetic
ﬁeld reconstruction.
In particular, we have evaluated
the performance of the π-disambiguation codes, mag-
netogram preprocessing codes, and NLFFF extrapola-
tion codes developed following the optimization method
(Wheatland et al. 2000).

We have found that the currently used π-disambiguation

codes work pretty well at the AR photosphere and chro-
mosphere, but often fail at the quiet sun photosphere.
This can become important when the question of the
magnetic ﬁeld at the quiet sun is speciﬁcally addressed.
Here we are primarily interested in the performance of
the reconstruction tools in ARs; thus, we adopted that
the π-ambiguity has been perfectly resolved.

Then, we have assessed the performance of two dif-
ferent preprocessing approaches aimed to improve the
bottom boundary condition toward force-freeness. Al-
though the tested preprocessing codes do produce a
more force-free boundary, there is an unsolicited byprod-
uct of these preprocessings—the poorly controlled eleva-
tion of the magnetic ﬁeld components, which are diﬀer-
ent for the longitudinal and transverse ﬁeld components.
This mismatch results in a poorly controlled systematic
error in the height scale in the extrapolated data cube.
On the other hand, comparison between the volumet-
ric metrics of the magnetic data cubes extrapolated from
the photospheric level either with or without prepro-
cessing are not much diﬀerent from each other, while
extrapolation without preprocessing preserves the cor-
rect height scale. From this perspective, we conclude
that the use of NLFFF extrapolation from the actual
photospheric magnetogram (without any preprocessing,
at least, when noise in the data does not represent a
problem) is preferable. We have to note, however, that
this conclusion is based only on the tests performed with
the ‘standard’ parameters µi, i = 1...4, speciﬁed for the
two alternative preprocessing method. It is well possi-
ble that there are combinations of the parameters µi,
which ensure a consistent elevation of the magnetic vec-
tor components by exactly one voxel (or another integer
number of voxels) along with suppressing noise in the
data, which might be helpful. But searching for such
optimized combinations is clearly beyond the scope of
this study.

Finally, we compared to each other the results of
NLFFF extrapolation using two diﬀerent versions of
the optimization method—one that uses the weighting
function and the other one that employs the full set of
NLFFF equations (including the one for the top and
side boundaries). Although we found the metrics of the
two codes to be comparable, still the codes that utilizes
the full set of the NLFFF equations works systemati-
cally better than the one with the weighting function.
We believe that this is because the use of the full set
of equations is better consistent with the assumption of
the ﬁeld force-freeness than the presence of the bound-
ary buﬀer zone with the potential boundary conditions
at the top and side boundaries.

 
 
 
 
 
 
 
 
 
 
 
 
NLFFF–MHD CASTING

25

This work was supported in part by NSF grants
AGS-1250374, AGS-1262772, and AST-1312802, and
NASA grants NNX14AK66G, and NNX14AC87G to
New Jersey Institute of Technology and RFBR grants
15-02-01077, 15-02-01089, 15-02-03717, 15-02-03835, 15-

02-08028, 16-02-00254, 16-02-00749, and 16-32-00315.
This study was supported by the Program of basic re-
search of the RAS Presidium No. 9. Authors acknowl-
edge the Marie Curie PIRSES-GA-2011-295272 Radio-
Sun project.

REFERENCES

Amari, T., Aly, J. J., Luciani, J. F., Boulmezaoud, T. Z., &

Loukitcheva, M., Solanki, S. K., Carlsson, M., & White,

Mikic, Z. 1997, SoPh, 174, 129

S. M. 2015a, A&A, 575, A15

Aschwanden, M. J. 2005, Physics of the Solar Corona. An
Introduction with Problems and Solutions (2nd edition)

Bogod, V. M., Stupishin, A. G., & Yasnov, L. V. 2012,

SoPh, 276, 61

Carlsson, M., Hansteen, V. H., Gudiksen, B. V., Leenaarts,

Loukitcheva, M., Solanki, S. K., White, S. M., & Carlsson,

M. 2015b, in Astronomical Society of the Paciﬁc
Conference Series, Vol. 499, Revolution in Astronomy
with ALMA: The Third Year, ed. D. Iono, K. Tatematsu,
A. Wootten, & L. Testi, 349

J., & De Pontieu, B. 2016, A&A, 585, A4

Loukitcheva, M., White, S. M., Solanki, S. K., Fleishman,

Crouch, A. D. 2013, SoPh, 282, 107
de la Cruz Rodr´ıguez, J., De Pontieu, B., Carlsson, M., &
Rouppe van der Voort, L. H. M. 2013, ApJL, 764, L11

De Rosa, M. L., et al. 2009, ApJ, 696, 1780
DeRosa, M. L., et al. 2015, ApJ, 811, 107
Fuhrmann, M., Seehafer, N., & Valori, G. 2007, A&A, 476,

349

Fuhrmann, M., Seehafer, N., Valori, G., & Wiegelmann, T.

G. D., & Carlsson, M. 2017, ArXiv e-prints
Low, B. C., & Lou, Y. Q. 1990, ApJ, 352, 343
Metcalf, T. R. 1994, SoPh, 155, 235
Metcalf, T. R., et al. 2006, SoPh, 237, 267
—. 2008, SoPh, 247, 269
Metropolis, N., Rosenbluth, A. W., Rosenbluth, M. N.,
Teller, A. H., & Teller, E. 1953, JChPh, 21, 1087
Pereira, T. M. D., Carlsson, M., De Pontieu, B., &

2011, A&A, 526, A70

Hansteen, V. 2015, ApJ, 806, 14

Gary, G. A. 2001, SoPh, 203, 71
Georgoulis, M. K. 2005, ApJL, 629, L69
Gosain, S., & Pevtsov, A. A. 2013, SoPh, 283, 195
Gudiksen, B. V., Carlsson, M., Hansteen, V. H., Hayek, W.,
Leenaarts, J., & Mart´ınez-Sykora, J. 2011, A&A, 531,
A154

Pereira, T. M. D., Leenaarts, J., De Pontieu, B., Carlsson,

M., & Uitenbroek, H. 2013, ApJ, 778, 143

Press, W. H., Teukolsky, S. A., Vetterling, W. T., &

Flannery, B. P. 2007, Numerical Recipes 3rd Edition:
The Art of Scientiﬁc Computing, 3rd edn. (New York,
NY, USA: Cambridge University Press)

Jiang, C., & Feng, X. 2014, SoPh, 289, 63
Jing, J., Yuan, Y., Wiegelmann, T., Xu, Y., Liu, R., &

Rathore, B., & Carlsson, M. 2015, ApJ, 811, 80
Rathore, B., Carlsson, M., Leenaarts, J., & De Pontieu, B.

Wang, H. 2010, ApJL, 719, L56

2015, ApJ, 811, 81

Kaltman, T. I., Bogod, V. M., Stupishin, A. G., & Yasnov,

Rudenko, G. V., & Anﬁnogentov, S. A. 2014, SoPh, 289,

L. V. 2012, Astronomy Reports, 56, 790

1499

Kaltman, T. I., Kochanov, A. A., Myshyakov, I. I.,

Maksimov, V. P., Prosovetsky, D. V., & Tokhchukova,
S. K. 2015, Geomagnetism and Aeronomy, 55, 1124
Leenaarts, J., Carlsson, M., & Rouppe van der Voort, L.

2012, ApJ, 749, 136
—. 2015, ApJ, 802, 136
Leenaarts, J., Pereira, T. M. D., Carlsson, M., Uitenbroek,

Rudenko, G. V., & Myshyakov, I. I. 2009, SoPh, 257, 287
Sakurai, T. 1981, SoPh, 69, 343
—. 1989, SSRv, 51, 11
Schrijver, C. J., et al. 2006, SoPh, 235, 161
ˇStˇep´an, J., Trujillo Bueno, J., Carlsson, M., & Leenaarts, J.

2012, ApJL, 758, L43

ˇStˇep´an, J., Trujillo Bueno, J., Leenaarts, J., & Carlsson, M.

H., & De Pontieu, B. 2013a, ApJ, 772, 89

2015, ApJ, 803, 65

—. 2013b, ApJ, 772, 90
Leka, K. D., Barnes, G., Crouch, A. D., Metcalf, T. R.,
Gary, G. A., Jing, J., & Liu, Y. 2009, SoPh, 260, 83

Lin, H.-H., & Carlsson, M. 2015, ApJ, 813, 34
Livshits, M. A., Grigoryeva, I. Y., Myshyakov, I. I., &
Rudenko, G. V. 2016, Astronomy Reports, 60, 939

Wheatland, M. S., Sturrock, P. A., & Roumeliotis, G. 2000,

ApJ, 540, 1150

Wiegelmann, T. 2004, SoPh, 219, 87
—. 2008, Journal of Geophysical Research (Space Physics),

113, A03S02

Wiegelmann, T., & Inhester, B. 2010, A&A, 516, A107

26

Fleishman et al.

Wiegelmann, T., Inhester, B., & Sakurai, T. 2006, SoPh,

Wiegelmann, T., Thalmann, J. K., & Solanki, S. K. 2014,

233, 215

Wiegelmann, T., & Sakurai, T. 2012, Living Reviews in

Solar Physics, 9

Wiegelmann, T., Thalmann, J. K., Inhester, B., Tadesse,
T., Sun, X., & Hoeksema, J. T. 2012, SoPh, 281, 37

A&A Rv, 22, 78

Yasnov, L. V., Karlick´y, M., & Stupishin, A. G. 2016,

SoPh, 291, 2037

