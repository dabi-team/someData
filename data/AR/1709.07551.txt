7
1
0
2

p
e
S
2
2

]

V
C
.
s
c
[

1
v
1
5
5
7
0
.
9
0
7
1
:
v
i
X
r
a

Virtual Blood Vessels in Complex Background using Stereo X-ray Images

Qiuyu Chen
University of Washington
Seattle, WA, US
qiuyuchen14@gmail.com

Ryoma Bise
Kyushu University
Fukuoka, Japan
bise@ait.kyushu-u.ac.jp

Lin Gu
National Institute of Informatics
Tokyo, Japan
lingu.edu@gmail.com

Yinqiang Zheng
National Institute of Informatics
Tokyo, Japan
yqzheng@nii.ac.jp

Imari Sato
National Institute of Informatics
Tokyo, Japan
imarik@nii.ac.jp

Jenq-Neng Hwang
University of Washington
Seattle, WA, US
hwang@uw.edu

Nobuaki Imanishi
Keio University
Tokyo, Japan
nimanmed@z5.keio.jp

Sadakazu Aiso
Keio University
Tokyo, Japan
aiso@a3.keio.jp

Abstract

We propose a fully automatic system to reconstruct and
visualize 3D blood vessels in Augmented Reality (AR) sys-
tem from stereo X-ray images with bones and body fat. Cur-
rently, typical 3D imaging technologies are expensive and
carrying the risk of irradiation exposure. To reduce the po-
tential harm, we only need to take two X-ray images before
visualizing the vessels. Our system can effectively recon-
struct and visualize vessels in following steps. We ﬁrst con-
duct initial segmentation using Markov Random Field and
then reﬁne segmentation in an entropy based post-process.
We parse the segmented vessels by extracting their center-
lines and generating trees. We propose a coarse-to-ﬁne
scheme for stereo matching, including initial matching us-
ing afﬁne transform and dense matching using Hungarian
algorithm guided by Gaussian regression. Finally, we ren-
der and visualize the reconstructed model in a HoloLens
based AR system, which can essentially change the way
of visualizing medical data. We have evaluated its perfor-
mance by using synthetic and real stereo X-ray images, and
achieved satisfactory quantitative and qualitative results.

1. Introduction

Over years, advanced Augmented Reality (AR) and Vir-
tual Reality (VR) techniques have been utilized to train
surgeons, prepare operation procedure, improve the diag-
nosis, provide intraoperative data[3] and even remote ex-

amination [22]. The VR system provides stereoscopic 3D
visualization of vascular [3], micro calciﬁcations [9], liver
[20] etc. which could be rotated, translated and zoomed by
the user in an immerse environment. When detecting the
offending vessels in neurovascular compression syndrome,
AR/VR system has offered signiﬁcantly improvement over
traditional 2D images [14].

As shown in Fig.1, we propose a novel hololens1 based
AR system that reconstructs and visualizes 3D structure of
blood vessels to facilitate the medical research. Visualiza-
tion of vessels would allow practitioners to establish correct
diagnosis and further reduce the threat of diseases like car-
diovascular and cancer [2, 21]. To reconstruct blood ves-
sels in 3D, current methods usually use 3D volume data
captured by computed tomography angiographic (CTA) or
magnetic resonance imaging (MRI). Since CTA typically
requires multiple X-ray scans of the target area, whose ra-
diation exposure is much larger than that of single X-ray
imaging. Methods like biplane angiography usually need
pre-deﬁned models or use adopt point-based reconstruction
methods in the absence of complex background [7, 11]. In
recent years, simpler imaging systems have been developed.
For example, Hoshino et al [12] proposed an X-ray stereo
imaging system that can record simultaneously X-ray stereo
images using two beam paths. Though this system can eas-
ily take X-ray stereo images, it further requires a stereo
matching method that reconstruct 3D vascular structures
from two images. However, vessel detection and matching

1https://www.microsoft.com/en-us/hololens

1

 
 
 
 
 
 
(a) HoloLens system

(b) Virtual blood vessel from z-axis

(c) Virtual blood vessel from y-axis

Figure 1: Visualized 3D blood vessels in our Augmented Reality system

Figure 2: a. Equipment for stereo X-ray images. b. System workﬂow with examples for each steps

in the presence of complex background itself is extremely
challenging.

We illustrate our pipeline in Fig.2. The X-ray imaging
system, based on the Softex C2 system, used in this work is
shown in Fig.2. With the planner detector and object ﬁxed,
we capture a pair of stereo images by moving the X-ray tube
from position -a and +a. From raw stereo X-ray images,
we automatically reconstruct the 3D vessels in the follow-
ing four step: 1. Given a pair of X-ray images with com-
plex background of vessels (Fig.2.b1), we ﬁrst apply vessel

2http://www.softex-kk.co.jp/

segmentation to extract centerlines (red and blue label in
Fig.2.b2). 2. Stereo matching is then conducted to match a
pair of vessel centerlines (Fig.2.b3). Speciﬁcally, this step
can be divided into initial matching and dense matching.
Initial matching (Fig.2.b3-left) only matches bifurcations
using afﬁne transform generated by SIFT [17] on raw im-
ages. 3. Dense matching uses the Hungarian algorithm with
Gaussian regression [23] to assign each pair of correspon-
dence along every edge linking between two matched bifur-
cations, as shown as green lines in Fig.2.b3-Right. 4. Using
the correspondence disparity in two stereo images, we can
generate 3D point clouds and further render 3D vessel mod-

els as shown in Fig.2.b4. Finally we establish a HoloLens
based AR system (Fig.1.a) which allows user to view the
reconstructed 3D vessels in an interactive immerse virtual
environments. Users can rotate the model and check the
vessel structure from different views (Fig.1.bc)

In this paper, we have following four major contribu-

tions:

1. We develop an effective segmentation method to detect
vessels under complex background mixed with bones
and body fat.

2. By properly parsing the 2D vascular structure, we pro-
pose a new stereo matching method that outperforms
the state-of-the-art.

3. Our stereo based system could obtain 3D vascular
structures, with much less health risk due to radiation
exposure, shorter imaging time and signiﬁcantly sim-
pliﬁed procedures.

4. The reconstructed 3D models could be visualized in

AR system.

2. Robust Segmentation of Blood Vessels under

Complex Background

Segmentation is an essential step to extract the vessel
from an input raw image. We apply a Contrast Limited
Adapted Histogram Equalization (CLAHE) [24] method,
then we apply Markov Random Field [13] to divide the en-
hanced image into several segmentations with labels. Based
on the observation from raw images that vessel regions con-
tribute slightly higher intensity, we look for pixels with high
intensity and associate them with segmentation labels. The
majority of labels in this set indicates the label of segmen-
tation for vessel regions.

Blood vessel segmentation has been studied for many
years. One of the widely used vessel segmentation methods
is proposed by Frangi et al. [10] that measures the vessel-
ness by computing the eigenvalues of Hessian at a certain
scale. The possibility of tubular structure is the maximum
vesselness response across several selected scales which
could be automatically determined by [18] using Markov
random ﬁeld (MRF). However, existing Frangi ﬁlter [10]
and its combination with MRF [18] suffer from two limita-
tions, especially in current application: 1. Low vesselness
response at vessel bifurcations where shapes are complex as
illustrated in the yellow box in Fig.3.d. 2. High vesselness
response at background bone edge due to its high intensity
illustrated in the green box in Fig.3.d and Fig.3.e.

Since these two types of errors would seriously spoil the
succeeding stereo matching and 3D reconstruction steps de-
scribed in Sec3, our segmentation method can reliably en-
hance the vessel from complex background such as high

intensity bones. Adaptive Histogram Equalization (AHE)
enhances the contrast between bones and vessels by ampli-
fying the vicinity of each pixel by its neighborhood cumula-
tive distribution function (CDF). Since some noise may also
be over ampliﬁed, CLAHE further limits the CDF, to help
equally redistribute among all histogram bins.

To further remove the noise such as bone edges and tiny
vessels, we conduct series of entropy based morphological
post-process. The vessel should show relative lower entropy
because it is usually smoother than the bone. Therefore,
we compute the local entropy on the raw image masked
by initial segmentation and remove any pixel that has high
entropy. This would also help us to remove thin vessels
since vessel edges also have high entropy. The minimum
thickness of the reconstructed vessel depends on the seg-
mentation and smoothing process. Then we only extract
largest segmentation and ﬁll holes through a morphological
reconstruction algorithm in Matlab toolbox [16]. Finally,
ﬁne vessel centerlines are generated using thinning rule in
[15]. A graphic tree for each vessel centerline, which is rep-
resented by bifurcation nodes and edge nodes, is generated
by a graph-based tracing method proposed by [8].

3. 3D Reconstruction of Blood Vessels

In order to get 3D model of the blood vessel, we ﬁrst do
stereo matching in a coarse-to-ﬁne scheme. In the initial
matching, we match bifurcations using afﬁne transform and
then obtain dense correspondences using Hungarian Algo-
rithm. We are able to reconstruct the correspondences in 3D
point clouds and then render them into 3D models.

3.1. Stereo Matching

Stereo Matching involves two steps: Initial Matching for
bifurcations and Dense Matching for all the other nodes.
Let P and Q represent bifurcation sets on warped image and
target image, pi and qi represent bifurcation i on warped and
target image.

3.1.1

Initial Matching:

In order to predict the correspondences on target image, we
ﬁrst calculate 3 × 3 afﬁne transform using SIFT [17, 4] on
the raw image. At each bifurcation (px, py) on warped im-
age, we predict its correspondence (q(cid:48)x, q(cid:48)y) (Fig4.a). We
use homogeneous coordinates to represent afﬁne transform
in a 3 × 3 matrix and homogeneous vector for each bifurca-
tion pixel:







q(cid:48)x
q(cid:48)y
1

 =

(cid:21)

(cid:20)R T
1
0







px
py
1



(1)

where R is a 2 × 2 rotation matrix while T is a 2 × 1 trans-
lation vector. For each prediction, we then search for it’s

Figure 3: Segmentation Evaluation using Different Methods. a: raw image. b. Initial Segmentation using CLAHE and MRF.
c: MRF. d:Frangi Filter e:MRF multi-label Optimization.

Figure 4: Stereo Matching Process. a. Initial prediction of corresponding bifurcation nodes using afﬁne transform. b. Search
for bifurcation nodes with minimum euclidean distance on targeted tree. Initial alignment.Blue dots represent warped image
while red dots represent target image. c. Junction nodes matching. d. Remove branches with unmatched bifurcations

nearest bifurcation in Q within a range r (Fig.4b,c). We then
remove edges between each unmatched bifurcation and it’s
connected terminal nodes (Fig.4.d) and ﬁnally update trees
for two images with NJ matched bifurcations.

3.1.2 Dense Matching:

The matched bifurcations suggest an initial mapping be-
tween two trees. A ﬁne alignment approach using Hungar-
ian algorithm guided by Gaussian regression was proposed
by [23] to establish new matches between the edge points
of the two paths. If we deﬁne the tree of warped image and
targeted image as XA and XB, then the correspondence set
i ↔ xB
can be written as: π = {xA
i }1 ≤ i ≤ N , N is the num-
ber of correspondence. Use Gaussian non-linear regression,
we can predict the location of new correspondence of points

in XA by:

mπ(xB) = kT C−1
π XA
π ,
σ2(xB) = k(xB, xB) + β−1 − kT C−1
π k

where β is the measurement noise variance, k is a non-linear
kernel function deﬁned by Eq.2 and Cπ is N × N matrix
with element Ci,j = k(xB
j ) + β−1δi,j, k is the vector
i , xB
1 , xB), ..., k(xB
[k(xB

N , xB)]T , with the kernel deﬁned as

k(xi, xj) = θ0 + θ1xT

i xj + θ2 exp {−

θ3
2

(cid:107)xi − xj(cid:107)2} (2)

which can implicitly deﬁne a mapping function consist of
both non-linear and afﬁne transform in biomedical warping.
Here θ0, θ1, θ2 and θ3 are hyperparameters, which are used
for adjusting deformation weights.

Figure 5: 3D reconstruction from stereo X-ray images of human hand. We ﬁrst use CLAHE based MRF to segment blood
vessels, and then extract largest connected segment and ﬁnally do standard morphological dilation and ﬁlling holes proce-
dures.

We initialize the mapping using NJ sets of correspon-
dences from initial matching: π = {pi ↔ qi}1 ≤ i ≤ NJ .
Following steps of ﬁne alignment in [23], for each pair of
edges connected by matched bifurcation, we ﬁnd new cor-
respondences. To evaluate dense mapping, we calculate the
Euclidean distance between the point and its predicted cor-
respondence. We associate it with Hungarian matrix and by
ﬁnding minimum total cost and ﬁnally obtain dense match-
ing [23].

3.2. Reconstruction

After we get correspondences:

i ↔
xB
i }1 ≤ i ≤ N , we estimate each point in world coordinate
XA
w and XB
w using intrinsic matrix of the camera M, pro-
vided by the manufacturer:

π = {xA

Xw =


 = M−1





xw
yw
1





xi
yi
1





(3)

As shown in Fig.2a, we assume X-ray light rail is parallel to
image plane. If we deﬁne hx is the height of X-ray source,
hs is the height of the samples, and depth z is hx-hs, we can
get Eq.4 based on similar triangles theorems:

2a
d

=

hx − hs
hs

=

z
hx − z

(4)

where d is the distance between two correspondences. Since
two X-ray lights are symmetric to the sample position, ﬁ-
nally we estimate a 3D point [x, y, z]T as:





x
y
z



 =

1
2

× (XA

w + XB

w ) +






2a ×

0
0
hx
d + 2a






− 1

(5)

We further smooth the reconstruction by averaging depth
within a step size along each branch in the 3D tree. We ap-
proximate the blood vessels as a series of small cylinders

and thus described by SWC format, a widely used format to
deﬁne the neuron and vessel structure. At each node of the
vessel model, the radius vessel can be calculated by search-
ing the ﬁrst non-vessel pixel along the normal vector in the
segmentation. Finally, 3D rendering is done by approxi-
mating a cylinder with estimated radius at each connection
between two adjacent nodes in the tree. This step is done in
Matlab Trees Toolbox.

4. Visualizing 3D Models using Augmented Re-

ality System

4.1. HoloLens System

Augmented reality headsets,

such as Microsoft
HoloLens [1], move data visualization from 2D screen to
3D hologram-like interface. It can project a mixed-reality
overlay on real world, and may lead to a large impact in
medical applications. To facilitate the diagnosis, we import
the reconstructed 3D vessel model in the virtual reality
system where doctors could view the vessel of interest in
any angle.

In order to visualize vessel, after computing the recon-
structed data from stereo X-ray images, we would upload
the 3D vessel model into the cloud and import into 3D
viewer beta in HoloLens. Speciﬁcally, since the HoloLens
system visualizes the target by rendering the 3D model of
fbx format in front of the user, we have to build the model
in DXF ﬁle format before converting into fbx 2013 format.
Finally, as shown in Fig.1, users could rotate, zoom, and
move the reconstructed vessels from raw images to better
assist doctors’ work.

Figure 6: Experiments on 5 X-ray stereo images with bones. The ﬁrst line shows 5 raw images, the second line shows their
corresponding 3D rendering results using our method

Figure 7: Synthetic Experiments: First row: Ground truth generated by Matlab Tree Toolbox. Second row: 3D reconstruction
using our system.

5. Experiment

5.1. 3D Vessel Reconstruction and Visualization

from X-ray Stereo Images

To begin with, we demonstrates the results of our sys-
tem on real world data collected by our X-ray imaging
equipment (Fig.2.a) for clinic practice.
In Fig.5, we can
observe that the raw input images contain a huge portion
of bone in the background. The vessels also assume lit-
tle surface texture, which would frustrate existing standard
stereo matching methods, either sparse or dense. Our ves-
sel segmentation method successfully localizes main ves-

sels despite the presence of complex background. We ﬁrst
apply CLAHE on two stereo X-ray images and use MRF
for multi-labeled segmentation. We search for pixels with
highest intensity from raw images and associate them with a
MRF label. Then we only extract pixels with that label and
remove small segments by extracting largest connected pix-
els. Finally, we do dilation and ﬁll holes in order to get tree
structures. Our stereo matching and reconstruction method
captures the disparity properly, and the reconstructed 3D
vessels look reasonable and satisfactory. We also show our
reconstruction results in ﬁve small regions from X-ray im-
ages in Fig.6. Our system works well for large and less oc-

Figure 8: Accuracy Evaluations for our method, CPD and ICP and fullﬂow.

cluded vessels. However, due to the restriction of view an-
gles, it may fail for heavily occluded vessels. In our dataset,
the minimum thickness of vessels is about 10 pixels.

5.2. Quantitative Evaluation of Stereo Matching

To evaluate the accuracy of our novel stereo matching
algorithm, we compare our results with CT scan. A z-slice
image (512) was reconstructed from the 2496 signals cap-
tured by 64 array sensor (GE Discovery CT750 HD). We
simulate a pair of stereo images by projecting the 3D vol-
ume data into two planes. Due to high occlusion of bones
and low resolution, we manually segment vessels and test
accuracy of method in section 4.2. We associate our points
with nearest human-labeled points on 2D CT image and
evaluate each depth accuracy. We only care about the rela-
tive depth in this test so both CT and our results are normal-
ized. We compare our results with state-of-art stereo match-
ing methods: Fullﬂow [6] and the other non-rigid point
matching methods including Coherent Point Drift (CPD)
[19] and Iterative Closest Point (ICP) [5]. At each point,
we deﬁne error as e% = |Depth−GT |
, where depth is the
calculated depth result z while ground truth is depth ob-
tained by CTA. For each method, we calculate the average

(cid:115) n
(cid:80)
e2
i
i=1
n , n is the number of points.
error of all the points:
Fig.8 is the error histogram, which is generated by counting
how many points have errors within this value. We achieve
72.6% points with less than 30% error, with an average ac-

GT

curacy of 71.8%.

5.3. Synthetic Experiment

We also design four synthetic vessel skeletons and ren-
der them as ground truth in Matlab Trees Toolbox as shown
in Fig.7. We deﬁne locations of nodes and width of ves-
sels and connect them by cylinders.
In order to validate
the robustness of our reconstruction system, we speciﬁcally
introduce several corners and large angle in the synthetic
vessels which is challenging for stereo vision. We simu-
late the experiment based on the principle of our equipment
and project the 3D skeleton model into two stereo images.
Because the projected stereo skeleton might be sparse, we
further generate ﬁne centerlines using morphological pro-
cess. Using methods described in Section3, we generate
corresponding 3D models and compare them with ground
truth qualitatively.

6. Conclusion

In this paper, we propose an Augmented Reality (AR)
system to reconstruct and visualize 3D blood vessels from
stereo X-ray image under complex backgrounds. Our
system could obtain 3D vascular structures, with much
less health risk due to radiation exposure, shorter imaging
time and signiﬁcantly simpliﬁed procedures. Comparing
with state-of-the-art, our novel stereo matching algorithm
achieves a higher accuracy on both real and synthetic data.

[16] S. Laporte, W. Skalli, J. D. Guise, F. Lavaste, and D. Mitton.
A biplanar reconstruction method based on 2d and 3d con-
tours: Application to the distal femur. Computer Methods in
Biomechanics and Biomedical Engineering, 6(1):1–6, 2003.
3

[17] D. G. Lowe. Object recognition from local scale-invariant
features. In Proceedings of the Seventh IEEE International
Conference on Computer Vision, volume 2, pages 1150–
1157 vol.2, 1999. 2, 3

[18] H. Mirzaalian and G. Hamarneh. Vessel scale-selection us-
ing mrf optimization. In 2010 IEEE Computer Society Con-
ference on Computer Vision and Pattern Recognition, pages
3273–3279, June 2010. 3

[19] A. Myronenko and X. Song. Point set registration: Coher-
ent point drift. IEEE Transactions on Pattern Analysis and
Machine Intelligence, 32(12):2262–2275, Dec 2010. 7
[20] P. Pessaux, M. Diana, L. Soler, T. Piardi, D. Mutter, and
J. Marescaux. Towards cybernetic surgery: robotic and aug-
mented reality-assisted liver segmentectomy. Langenbeck’s
archives of surgery, 400(3):381385, April 2015. 1

[21] H. Qin and Z. Li. Three dimentional reconstruction of blood
vessels and evaluation of vascular stenosis based on dsa. In
International Conference on Advanced Materials and com-
puter science, 2016. 1

[22] E. Ruffaldi, A. Filippeschi, F. Brizzi, J. M. Jacinto, and C. A.
Avizzano. Encountered haptic augmented reality interface
In 2015 IEEE Symposium on 3D
for remote examination.
User Interfaces (3DUI), pages 179–180, March 2015. 1
[23] E. Serradell, M. A. Pinheiro, R. Sznitman, J. Kybic,
F. Moreno-Noguer, and P. Fua. Non-rigid graph registration
IEEE Transactions on Pattern
using active testing search.
Analysis and Machine Intelligence, 37(3):625–638, March
2015. 2, 4, 5

[24] K. Zuiderveld. Graphics gems iv. chapter Contrast Lim-
ited Adaptive Histogram Equalization, pages 474–485. Aca-
demic Press Professional, Inc., San Diego, CA, USA, 1994.
3

Acknowledgement

This work was funded by ImPACT Program of Coun-
cil for Science, Technology and Innovation (Cabinet Ofﬁce,
Government of Japan).

References

[1] The

leader

reality
https://www.microsoft.com/en-us/hololens. 5

mixed

in

technology.

[2] A. Al Moussawi, C. Galusinski, and C. Nguyen. 3d re-
construction of blood vessels. Engineering with Computers,
31(4):775–790, 2015. 1

[3] A. Alaraj, M. G. Lemole, J. H. Finkle, R. Yudkowsky,
A. Wallace, C. Luciano, P. P. Banerjee, S. H. Rizzi, and F. T.
Charbel. Virtual reality training in neurosurgery: Review of
current status and future applications. Surg Neurol Int, 2:52,
2011. 1

[4] M. Berger. Geometry (vols. 1-2), 1987. 3
[5] P. Bergstr¨om and O. Edlund. Robust registration of point sets
using iteratively reweighted least squares. Computational
Optimization and Applications, 58(3):543–561, 2014. 7
[6] Q. Chen and V. Koltun. Full ﬂow: Optical ﬂow estimation by
global optimization over regular grids. In 2016 IEEE Confer-
ence on Computer Vision and Pattern Recognition (CVPR),
pages 4706–4714, June 2016. 7

[7] S.-Y. J. Chen and C. E. Metz. Improved determination of bi-
plane imaging geometry from two projection images and its
application to three-dimensional reconstruction of coronary
arterial trees. Medical Physics, 24(5):633–654, 1997. 1
[8] J. De, H. Li, and L. Cheng. Tracing retinal vessel trees by
transductive inference. BMC Bioinformatics, 15(20):1–20,
2014. 3

[9] D. Douglas, J. Boone, E. Petricoin, L. Liotta, and E. Wilson.
Augmented reality imaging system: 3d viewing of a breast
cancer. Journal of nature and science, 2016. 1

[10] A. F. Frangi, W. J. Niessen, K. L. Vincken, and M. A.
Viergever. Multiscale vessel enhancement ﬁltering, pages
130–137. Springer Berlin Heidelberg, Berlin, Heidelberg,
1998. 3

[11] L. Gu and L. Cheng. Learning to boost ﬁlamentary struc-
ture segmentation. In The IEEE International Conference on
Computer Vision (ICCV), December 2015. 1

[12] M. Hoshino, K. Uesugi, J. Pearson, T. Sonobe, M. Shirai,
and N. Yagi. Development of an x-ray real-time stereo imag-
ing technique using synchrotron radiation. Journal of syn-
chrotron radiation, 18(4):569–574, 2011. 1

[13] Z. Kato and T.-C. Pong. A Markov Random Field Image Seg-
mentation Model Using Combined Color and Texture Fea-
tures, pages 547–554. Springer Berlin Heidelberg, Berlin,
Heidelberg, 2001. 3

[14] T. KIN. Prediction of surgical view of neurovascular decom-
pression using interactive computer graphics. Neurosurgery,
65:121–129, 2009. 1

[15] L. Lam, S. W. Lee, and C. Y. Suen. Thinning methodologies-
a comprehensive survey. IEEE Transactions on Pattern Anal-
ysis and Machine Intelligence, 14(9):869–885, Sep 1992. 3

