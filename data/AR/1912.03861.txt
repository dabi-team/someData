DAILYDATAASSIMILATIONOFAHYDROLOGICMODELUSINGTHEENSEMBLEKALMANFILTERAPREPRINTSamiA.MalekUCBerkeley,DepartmentofElectricalEngineeringandComputerSciencessami.malek@berkeley.eduAlexandreM.BayenUCBerkeley,DepartmentofElectricalEngineeringandComputerSciencesUCBerkeley,DepartmentofCivilEngineeringUCBerkeley,InstituteforTransportationStudiesbayen@berkeley.eduStevenD.GlaserUCBerkeley,DepartmentofCivilEngineeringbayen@berkeley.eduDecember10,2019ABSTRACTAccuraterunoffforecastingiscrucialforreservoiroperatorsasitallowsoptimizedwatermanagement,ﬂoodcontrolandhydropowergeneration.Landsurfacemodelsinmountainousregionsdependonclimaticinputssuchasprecipitation,temperatureandsolarradiationtomodelthewaterandenergydynamicsandproducerunoffasoutput.Withtherapiddevelopmentofcheapelectronicsappliedinvarioussystems,suchasWirelessSensorNetworks(WSNs),satelliteandairbornetechnologies,theprospectofpracticallymeasuringspatialSnowWaterEquivalentinadensetemporalscaleisincreasing.WepresentaframeworkforupdatingthePrecipitationRunoffModelingSystem(PRMS)withSnowWaterEquivalent(SWE)mapsandrunoffmeasurementsonadailytimescalebasedontheEnsembleKalmanFilter(ENKF).ResultsshowthatbyassimilatingSWEdaily,themodeledSWEgetsupdatedaccordingly,howevernoimprovementisobservedattherunoffmodeloutput.Instead,adeteriorationconsistentlyoccurs.Augmentingthestatespacewithmodelparametersandrunoffmodeloutputallowsforﬁlterupdatewithpreviousdaymeasuredrunoffusingthejointstate-parametermethod,andshowedaconsiderableimprovementinthedailyrunoffoutputofupto60%reductioninRMSEforthewetwateryear2011relativetothenoassimilationscenario,andimprovementofupto28%comparedtoanaiveautoregressiveAR(1)ﬁlter.Additionalsimulationyearsshowedconsistentimprovementcomparedtonoassimilation,butvariedrelativetothepreviousdayautoregressiveforecastduringthedryyear2014.KeywordsFiltering·EnKF·DataAssimilation·RunoffModel·Sensors·Hydrology·Forecasting·Estimation·PRMS1IntroductionThisresearchworkﬁtsintoalargerobjectiveofattainingconsistentlymoreaccuratesnowmeltrunoffforecastresilienttoclimatechangeandextremeweatherconditions.Presently,reservoiranddamoperatorsrelyonforecastslargelybasedonhistoricalmethods.NumerousstudiesshowthatclimatechangeeffectsarechallengingthestationarityassumptionarXiv:1912.03861v1  [eess.SY]  9 Dec 2019APREPRINT-DECEMBER10,2019ofthisstatisticalapproach.Thepastcannolongerpredictthefutureaswellasitdidbefore.Otherstudiesshowasystematicrecedingdateforsnowmeltduringtheyear.[1,2,3,4]AmandatoryevacuationorderwasissuedinFebruary2017aftertheOrovilledamcrisisbecauseofhazardouswateroverﬂowattheOrovillereservoir.TheDepartmentofWaterResources(DWR)publishedareportshowingthatreservoirwaterlevelsroseearlierandhigherthanprevious16years.OrovilleisthepouringpointoftheNorthForkFeatherRiverwhere3daysearlier,recentlydeployedsensorsshowedanonsetofrapidsnowmeltupto1cmperhourmostprobablyduetoarainonsnowevent.Unlikestatisticalmodels,aphysicallybasedforecastmodelthatincorporatesthesenewdatashouldbeabletocapturesuchinﬂowsurges.Inadditiontoﬂoodcontrol,runoffforecastingallowsforbetterreservoirmanagementandpotentiallymoreefﬁcientpowergeneration.Stakeholders,suchasPaciﬁcGas&Electric(PG&E)havealreadystartedshiftingtowardsphysicallybasedforecastmodels.Thesemodelsthoughlessvulnerabletoclimatechange,requiredenseandaccuratedataaswellasamethodologytoseamlesslyintegratesensormeasurementsofdifferenttemporalandspatialscales.RecenteffortstoincreasehydrologicinstrumentationintheEastBranchoftheNorthForkFeatherRiverbasinbyapartnershipbetweentheUniversityofCaliforniaatBerkeley,theDepartmentofWaterResourcesandtheCaliforniaEnergyCommission(CEC)ledtothedeploymentoffour1km2scalestate-of-the-artremoteautonomousgroundmeasurementsystemsbasedonWirelessSensorNetworkstechnologytocollecttemperature,humidity,solarradiation,snowdepth,soiltemperatureandsoilmoisturemeasurementsata15minutescale.Thesenewdeploymentswouldsupplementtheexistingmeasurementsystemconsistingof8snowpillowsreportingdailySWEmeasurementsandthemonthlymanualsnowcourselocations.MoreovertheNASAairbornesnowobservatory,inpartnershipwithDWRareusingairborneLiDARsystemtoproduceunprecedentedbi-weeklybasin-wideSWEmapsoftheTuolumneandMercedriverbasinsat50meterspatialresolution[5].Theobjectiveofthisstudyistodesignapracticaldataassimilationframeworkforreal-timerunoffforecastingusingPRMSthatcanleveragesensordatafromtheexisting,state-of-the-artandfuturehydrologicmeasurementsystemsatdifferenttemporalandspatialscales.AfterdescribingthePRMSmodeldynamics,wepresentexistingﬁlteringtechniques,thenwedevelopapracticaldataassimilationframeworktointegrateinreal-timesimulatedmeasurementsofSWEandrealmeasurementsofstreamﬂowinthemodelusingtheEnsembleKalmanFilter.2PrecipitationRunoffModelingSystemThePrecipitationRunoffModelingSystemisahydrologicmodeloriginallydescribedbyLeavesley(1983).Itsimulatessnowaccumulationandablationprocessesaswellassoil-zoneandstreamﬂowwaterdynamics.ThewatershedorbasinisdiscretizedintoHydrologicResponseUnits(HRUs)basedontopography,landuse,climate,soilproperties,andgeologicunitsinformation[6].SampleHRUsfortheEastBranchoftheFeatherRiverbasinareshowninFig.1.Themodelrunsonadailytimediscretization,withsomeprocesseshavinghalf-dayresolution.Themodeltakesdailyprecipitation,minimumandmaximumairtemperatureandoptionallyshort-wavesolarradiationasinputs.PRMSisamodulebasedsystem:itcanhandleotherdatainputsaswellasdifferentmodelingmodules.Werestrictthisstudytowhatiscurrentlybeingoperationallyusedinourspeciﬁcapplication.EachHRUconsistsofasystemofabstractwatercontainers(orstorages)interconnectedbywaterﬂowsasshowninFig.2.Variableswithsubscripts“h"inthisreportindicatethatthosevariablesareuniqueforeachHRU.ThecomponentsareInterception(Sinth),Snowpack(SWEhandHh),ImperviousZoneReservoir(Simph),SoilZoneReservoir(Sszh,subdividedintoRechargeSsrehandLowerzoneSslh),SubsurfaceReservoir(Sssh)andtheGround-WaterReservoir(Sgwh).Foreachwaterstorage,thewatermassbalanceequationissatisﬁed.∆(S)∆t=XF(1)whereSandFdenotewaterstorageandﬂowrespectively.∆(Sint)∆t=XFintin−XFintout(2)whereFintinconsistsofprecipitation,andFintoutconsistsofevaporation,sublimationandthrougfall.∆(SWE)∆t=XFswein−XFsweout(3)2APREPRINT-DECEMBER10,2019Figure1:HydrologicResponseUnits(HRUs)oftheEastBranchoftheFeatherRiveroverlaidonaSWEmapfrom1998.whereFsweinconsistsofprecipitationonnon-vegetatedareas,throughfallfromcanopycoveredregions,andFsweoutconsistsofsublimationandsnowmelt.∆(Ssz)∆t=XFszin−XFszout(4)whereFszinconsistsofsnowmelt,rain,andﬂowfrominterceptiononperviousregions,andFszoutconsistsofsurfacerunoff,evapotranspirationandexcessSzwater.∆(Sss)∆t=XFssin−XFssout(5)whereFssinconsistsofrechargefromSsz,subsurfaceﬂowtostreamﬂow,andpercolationtothegroundwaterreservoirs(Sgw).∆(Sgw)∆t=XFsgwin−XFsgwout(6)whereFsgwinconsistsofrechargefromSoilZoneandfromsubsurfacereservoirsandFsgwoutconsistsofgroundwatersinkandgroundwaterﬂowtosreamﬂowoutput.3APREPRINT-DECEMBER10,2019Figure2:SchematicdiagramofPRMSanditsinputs[7]FortheSnowpackstorage(SWE),meltoccurswhenthesnowpackreachesisothermalconditions(H=0).Anadditionalenergybalanceequationissatisﬁedthatdealswiththeatmosphericandtemperaturegradientandenergyﬂuxes(f)interactionsandcanbewrittenas:∆(H)∆t=Xf(7)SymbolPRMSsymbolTypeQuantityUnitsDescriptionPhru_pptdailyperHRUinchestotalprecipitationTmax,itmaxdailyoneoFmaxtemperatureatHRUiTmin,itmindailyoneoFmintemperatureatHRUiTable1:ModelInputs2.1ModelInputsModelinputsconsistofdailytime-seriesofprecipitationforeachHRUandminimumandmaximumairtemperaturefor1HRUthatcontainsatemperaturestation.Thedailyshort-waveradiation(Rsw)isestimatedinternallybythemodel.Theyaredetailedbelow:Short-WaveRadiation:Aconstantsolartableconsistingofdailyestimatesofthepotential(clearsky)short-wavesolarradiation(Rpsw)foreachHRU(theyarederivedfromcalculationsofdurationofsunexposureandlatitudeforeachHRUandeachday[7]).Suchvaluesarethenadjusteddailybasedonamodiﬁcationofthe“degree-day"methodtogettheshort-waveradiationdescribedinmoredetailsin[7].Themethodconsistsofderivingadegree-daycoefﬁcient(dd)andthenaratioofactual-to-potentialradiationforahorizontalsurface(r).Thefollowingparametriclinearcurveisusedtoﬁnddd:dd=φm·Tmaxf+βm(8)4APREPRINT-DECEMBER10,2019SymbolPRMSsymbolQuantityUnitsDescriptionSintintcp_storperHRUinchesinterceptionstorageSliqfreeh2operHRUinchesliquidwatersnowpackstorageρpk_denperHRUg/cm3snowpackaveragedensitySWEpkwater_equivperHRUinchestotalwatersnowpackstorageSicepk_iceperHRUinchesfrozenwatersnowpackstorageDpk_depthperHRUinchessnowpackdepthHpk_defperHRULangleyssnowpackheatdeﬁcitTpkpk_tempperHRUoFsnowpacktemperaturefscasnowcov_areaperHRU-snowcoverareaSgwgwres_storperGWRinchesgroundwaterstorageSimpimperv_storperHRUinchesimperviousstorageSsresoil_rechrperHRUinchessoilrechargestorageSszsoil_moistperHRUinchestotalsoil-zonestorage(soil-moisture)Sssssres_storperSSRinchessub-surfacestorageSWEmaxpstperHRUinchestracksmaxSWEofpackforfscaalbedoTable2:ModelStateswhereφmandβmareparametersandTmaxfisaninput.Fromdd,rhisretrievedviaanon-linearrelationshipofddinfunctionofrh.FinallytheactualsolarradiationisadjustedaccordingtoeachHRUslope.Rswh=rh×γcos(arctan(δh))·Rpswh(9)whereγ=γsduringsummerdays&PgreaterthanPminγwduringwinterdays&PgreaterthanPmin1PlessthanPminbecauseRpswhiscalculatedfordayswithoutprecipitation.AirTemperatureThesingletemperatureinputatHRUiwithelevationeiisspatiallydistributedfortheremainingHRUsaccordingtothefollowingequation(andsimilarlyforTmin)indegreesFahrenheit.Tmaxh=Tmaxhi−λ1month×(cid:18)eh−ehi1000(cid:19)−β1h(10)Tminh=Tminhi−λ2month×(cid:18)eh−ehi1000(cid:19)−β2h(11)PrecipitationPrecipitationPhforeachHRUareinputstothemodel.Theprecipitationphaseisdeterminedsolelybasedontemperature.IftheHRUmaximumairtemperature(Tmaxh)islessthanorequaltotheparameterTs,allprecipitationissnow.IfTminhandTmaxharegreaterthanorequaltoTsandTrrespectively,precipitationisassumedtobeallrain.Otherwise,Pisconsideredamixtureofrainandsnow.TherainfractionofPiscomputedas:frh=(cid:18)Tmaxh−TsTmaxh−Tminh(cid:19)·ζm(12)Avaluegreaterthan1isconsideredanallrainevent.2.2InterceptionPortionsoftheHRUwithcanopycoverinterceptprecipitation.Differentcanopycoverdensityvaluesareusedforthesummer(dsh)andwinter(dwh).Onlywhentheprecipitationamountexceedsthecanopystoragecapacity(Sc)doesitreachthegroundasthroughfall(Pth).Forexamplethenetprecipitationreachingthegroundduringsummeris:Pnh=Pth·dsh+(1.0−dsh)×Ph(13)5APREPRINT-DECEMBER10,2019wherethethroughfallPthiscomputedas:Pth=(Ph−SchAh·dsh:Ph>SchAh·dsh0.0:otherwise(14)wherethecanopystoragecapacitySchis:Sch=(Crsh−Sinth)·Ah·dsh(15)ParametersdshandCrwhareusedduringwinter.Asimilarprocessismodeledforsnow.Sinthisamodelstateholdinginterceptedprecipitation.CrshandCrwharethesummerandwinterraininterceptionstoragecapacityforthemajorvegetationtypeforeachHRU.Cshisusedforsnow.Interceptedrain,(orsnow)evaporates(orsublimates)atafree-watersurfacerate.2.3EvapotranspirationTheJensen-Haiseformulation[7]isusedtocomputethepotentialevapotranspiration:ETh=jc·(Th−jch)·Rswh2.54·(597.3−(0.5653·Th))(16)wherethecoefﬁcientjchisapproximatedtobe:jch=22−eh1000(17)Asﬁgure2shows,evapotranspirationoccursinmultiplereservoirs.2.4SnowpackSnowpackdynamicsaremodeledusingwaterandenergybalancesforeachHRU.Thesnowpackisabstractedas2layers.Theenergyexchangesthatoccurbetweenthesnowpackandtheatmosphereareradiative,conductiveandconvective.Theenergybalanceatthesnow-atmosphereinterfaceiscomputedtwiceperday,forboththedayandnightperiodsas:dEdt=Ih+Qvh+Rh(18)EisthesurfaceenergyofthesnowpackThenetshortwaveradiationRhin(18)iscomputedfromRswh(9)afteraccountingforthereﬂectedportionoftheradiationusingthesurfacealbedoαandthatlimitedbythevegetativetransmissioncoefﬁcientparameterψh.Rh=(1−αh)·ψh·Rswh(19)Whereαisobtainedfromanon-linearcurvethatisafunctionofthesnowdynamicsphaseandtimesincelastnewsnowindays.ThenetincominglongwaveradiationIhoriginatesfromtheatmosphereandlandcover:Ih=cwh·Iph+(cid:0)1−cwh(cid:1)·(cid:15)·Iph(20)where(cid:15)istheemissivity,aprecipitationsituation-dependentparameter(between0.0and1.0dependentonstormtype),andIphistheperfectblack-bodyemission:Iph=5.85·10−8·(Th+273.16)4(21)Thecombinedconvectionandlatentheatﬂuxfromcondensationismodeledaslinearfunctionoftemperature.Qvh=ω·Th(22)When(18)isnegative,heatﬂowoccursbyconductiononly(ex:potentiallyrefreezesnowatisothermal)anddependsonthesnowpackdensityandlayertemperaturegradient:Qch=2·0.5·σs0.0077·ρ2h·∆tσ·ρh·(Th−Tpkh)(23)6APREPRINT-DECEMBER10,2019whereσisthespeciﬁcheatofice(inCelsiusCal.m−3.oC−1).Apositiveenergyexchangetranslatesintosnowmeltatthesurfaceofthesnowpack,thattransportsheat∆Eintothelowersnowpackbymasstransfer.Thepotentialmeltfromsuchheatis:Mh=∆E203.2·scah(24)wherescah=fscah·AhistheHRUsnowcoveredarea.Theenergystateofthelowerlayerisrepresentedasaheatdeﬁcit.Thesnowpackheatdeﬁcit(H)foreachHRUrepresentstheamountofheatnecessarytobringthesnowpacktoisothermal0oC.Snowmeltoccursonlywhentheheatdeﬁcitreacheszeroandthesnowpackfree-waterstorageisexceeded.Otherwise,potentialmeltis“refrozen"bythedecreaseintheheatdeﬁcit.Storagewithinthesnowpackistrackedintwostates:ice(solid)andfreewater(liquid),thesumofwhichistermedSnowWaterEquivalent(SWE),andquantiﬁesthevolumeofwaterobtainedifallsnowismelted.Meltdecreasestheicestorageofthesnowpack,andoncetheamountoffreewatersurpassesthemaximumcapacity,waterexitsthesnowpack.Sublimationlossfromthesnowpackoccursaccordingtothefollowingequation:Bh=ξ·ETh·fscah(25)whereEThisthepotentialevapotranspirationdescribedin2.3Theprocesslowersthenon-isothermalheatdeﬁcitby:Tpkh·ETh·1.27calories.Theevolutionofthesnowdepth(D)isapproximatedfromtheordinarydifferentialequation[7]:dDhdt+τ·Dh=Pnshρinit+(cid:18)τ·SWEh+Pnshρmax(cid:19)(26)andiscalculatedas:∆Dh=∆t·(cid:18)Pnshρinit+τ·(cid:18)SWEh+Pnshρmax−Dh(cid:19)(cid:19)(27)Whereρinitandρmaxareparametersforinitialandmaximumdensityofnewsnowfall,respectively.Pnshisthenetnewsnowfallafterinterception.Thesnowpackdensityisthen:ρh=SWEhDh(28)Thesnow-coveredareaisdeterminedbyamulti-modaldepletioncurve[7]thatdescribestheevolutionofthefractionalsnow-coveredarea(fsca)infunctionofthefractionofmaximumSWE.ParameterAcurvespeciﬁesthe11valuesofthecurve.ThedepletioncurveisusedwhenHRUSWEislessthanthemaximumSWEcorrespondingtototalsnowcoverspeciﬁedbyparameterSWEmax.Wateravailableatthesoilsurface(frommeltandrain)proceedtobothinﬁltratingthesoilreservoirandﬁllingtheimperviouszonereservoir.2.5ImperviousZoneReservoirTheimperviouszonereservoir(Simp)constitutesthefractionoftheHRUspeciﬁedbytheparameterfiwithnosoil-inﬁltrationcapacity.Itreceivesfifractionofthetotalwaterfromsnowmelt(M)andrainthroughfall(Pnr)foreachHRUandhasmaximumretentioncapacityofSimax,abovewhichwaterﬂowsdirectlyassurfacerunoffFsridescribedin2.7.Theprocessisdescribedinthefollowingdiscretizeddynamicequation:Simp=Simpt−1+(Pnrh+Mh)·fih−Fsrih−eih(29)whereeiisthewaterdepletedbyevaporation:eih=ETah·(1−fscah)·fih(30)whereETahistheavailablepotentialforevapotranspirationremaininginthesystemafteraccountingforevapotranspi-rationandsublimationlossesthatalreadyoccured(interception,..).2.6SoilZoneReservoirThesoilzonereservoir(Ssz)representstheactivesoilproﬁleanditsdepthisconsideredtobetheaveragerootingdepthofthepredominantvegetationontheHRU.Itreceivespartofthewaterfromsnowmeltandrain.ItcanholduptotheparameterSszmax.Theupperlayeristermedtherechargezone(Ssre)andthelowerlayeristermedthelowerzone(Ssl).Whilewaterislostthroughbothevaporationandtranspirationfromtheupperlayer,itisonlylostthroughtranspirationfromthelowerlayer.EvaporationislimitedbybothhowmuchpotentialofETisleftinETahforthedayandbytheavailabilityofwater.Waterneedstoﬁlltherechargelayerbeforeitcanproceedtothelowerlayer.ThesoilwatercontentrepresentedbySszisalsodeﬁnedasthe“soilmoisture".AmaximumofFzgwmaxhpercolatesfromSsztoSgw,andtheremaindertoSssasexcess.7APREPRINT-DECEMBER10,20192.7SurfaceRunoffBoththepervioussoilzoneandtheimperviousreservoirscontributetosurfacerunoffFsrasFsrpandFsrirespectively.Fsrh=(1−fih)·Fsrph+fih·Fsrih(31)Theperviousrunoffismodeledusingthefollowingnon-linearparametricequationinfunctionofsoilmoisture,netrainprecipitationandsnowmelt[7]:Fsrph=maxhα1h·10θ1h·Ssz·(0.5·Pnh),Asri·(Pnrh+Mh)(32)WherePnhisnetprecipitation(13),α1h,θ1handAsraremodelparameters.TheimperviousrunoffisequaltotheamountofwaterexceedingSimaxin(29).2.8SubsurfaceReservoirThesubsurfacereservoirmodelstherelativelyrapidwatermovementoftheunsaturatedsoilzonestowardsastreamﬂowchannel.Suchbehaviorishighlightedtypicallyduringandafterarainfallorsnowmeltevent.Areservoirroutingsystemisusedtomodeltheﬂowfromthesubsurfacereservoir.TheﬂowFssisthesolutionthatsatisﬁesboththemasscontinuityequation:Fsss,t=Fsss,t−1−d(Sss)dt(33)andtheempiricalquadraticrelation:Fsss,t=α3s·Ssss+β3s·Sss2s(34)whereα2sandβ2sareroutingcoefﬁcients.AnotherSssdischargeroutetransferswatertotheSgwreservoirthroughtheparametricpowerequation:Fss_gws=α2s·(cid:20)Sssssmaxs(cid:21)θ2s(35)whereα2s,smaxandθ2saremodelparameters.2.9Ground-WaterReservoirOncethesoilzonereservoirissaturated,excesswaterstartsﬁllingtheground-water(Sgw)reservoiratamaximumdailyrechargerateFzgwmaxh,aparameterdeﬁnedforeachHRU.Fsz_gw=min(Fzgwmaxh,Ssz_excess)(36)Waterleavingtheground-waterreservoireitherﬂowslaterally(Fgw)contributingtothebaseﬂowportionofthestreamﬂoworislostfromthesystemviathegroundwatersink,bothatalinearrate:Fgwh=α4g·Sgwg(37)Fgsnkh=α5g·Sgwg(38)2.10ModelOutput:StreamﬂowBasinstreamﬂow,whichconsitituesthemodeloutput,iscomputedasanareaweightedaverageofallthereservoirﬂowoutputsdescribedabove:Fbasin=NhXh=1FsrhAh+NsXs=1FsssAs+NgXg=1FgwgAg(39)ImprovingthedailyforecastaccuracyofFbasinistheultimateobjectiveofthisreport.8APREPRINT-DECEMBER10,20193FilteringTechniquesModelsaresimpliﬁcationsofphysicalprocessesandareinherentlyimperfectrepresentationsofreality.Combiningrelatedmeasurementswithmodeledestimatesthroughdataassimilationwouldproducemoreaccurateoutcomes.Assimilationapproacheswereintroducedinoceanographyandmeteorology[8,9]withdifferentschemesusedsuchasthevariationalmethods[10]andtheﬁlteringtechniquesincludingnudging[11],optimalinterpolation[12]andKalmanﬁlteringwithitsvariantsthatarepresentedbelow.BayesianFilteringBayesianinference[13]istheunderliningprincipleforallthedataassimilationapproacheswewilldescribeinthissection.Theystemfromthetwofollowingprobabilityrules:marginalization(sum)rule:Givenfxy(x,y),wedeﬁne:fx(x):=Xy(cid:15)Yfxy(x,y)(40)andtheconditioning,orproductruledeﬁnedas:fx|y(x,y):=fxy(x,y)fy(y)(41)forfy(y)6=0WecanformulatethefollowingforecastandupdatesystemintheBayesianframework,wherexrepresentsthemodelstate,zrepresentthemeasurementsandkisthediscretetimestep:Priorupdate(orforecast):f(x(k)|z(1:k−1))=Zf(x(k)|x(k−1))·f(x(k−1)|z(1:k−1))dx(k−1)(42)wheretheﬁrstitemintheintegralistheprocessmodelandtheseconditemistheprevioustimestepmeasurementupdateresult.Measurementupdate(orupdate):f(x(k)|z(1:k))=f((z(k)|x(k))·f(x(k)|z(1:k−1)Rf(z(k)|x(k))f(x(k)|z(1:k−1))dx(k)(43)wheretheﬁrstandseconditemsofthenumeratorarethemeasurementmodelandtheprior(42),respectively,andthedenominatoristhenormalizationf(z(k)|z(1:k−1)).KalmanFilterItcanbeshown[14,15,16]thatgiventhesystemofequationswithalinearprocessmodelAandindependentGaussiandistributionsforerrorsv(k−1)andw(k)andprior:assuminginitialization:ˆxa(0)=x0,Pa(0)=P0x(k):=A(k)·x(k−1)+u(k−1)+v(k−1)(44)y(k):=H(k)x(k)+w(k)(45)theanalyticalsolutiontotheBayesianstateestimationproblemin(42)and(43)istheKalmanFilter(KF)andcanbewritteninarecursiveformwhilekeepingtrackofthedistributions’meanandcovarianceas:Priorupdate/Forecaststep:ˆxf(k)=A(k−1)ˆxa(k−1)+u(k−1)(46)Pf(k)=A(k−1)Pa(k−1)AT(k−1)+Q(k−1)(47)APosterioriupdate/Analysisstep:ˆxa(k)=ˆxf(k)+Pa(k)HT(k)R−1(k)(z(k)−H(k)ˆxf(k))(48)Pa(k)=(cid:16)P−1f(k)+HT(k)R−1(k)H(k)(cid:17)−1(49)withouttheneedtostoreallpreviousobservationsandstates.ItiscommonlyreferredtoPa(k)HT(k)R−1(k)in(48)astheKalmangainK(k).Themaximumaposterioriestimate(MAP)ofthenormallydistributedanalysiscoincideswiththemean:xMAPa(k)=ˆxa(k)andthusischosenasthebestestimateofthesystemstateattimek.9APREPRINT-DECEMBER10,2019ThebasicKalmanFilter(KF)algorithmthatisrestrictedforonlylinearmodelsconsistsoftwosteps,apredictstepfollowedbyanupdatestep.TheKFanditsvariantshavenumerousapplicationsinthephysicalsciences,primarilyintheguidance[17],navigationandcontrolofvehicles[18],time-seriesanalysis[19]androbotics[20].ExtendedKalmanFilterTheExtendedKalmanFilter(EKF)isanextensiontotheKFfornon-linearsystems.Theapproachistolinearizethenon-linearprocessmodelaroundthemeanusingﬁrstorderTaylorexpansion.Itthusbecomesanapproximationoftheexactsolution.TheJacobianisthenusedtoadvancetheerrorcovariancematrixintime.Itrequiresthemodeltobecontinuouslydifferentiableandisshowntohavebadperformancewhenthesystemexhibitsstrongnon-linearities.Forinstance,theEKFwassuccessfullyusedtointegrateGPS-derivedﬂowvelocitymeasurementsfromdrifterstoimprovethenon-linearhydrodynamicsstateestimatesinacontrolledchannelpilotexperiment[21].UnscentedKalmanFilterTheUnscentedKalmanFilter(UKF),alsoreferredtoasSigma-PointKF,triestosolvethelinearityproblemusinganotherapproach.Itworksbyﬁrstdeterministicallysamplingusinganalgorithmsigmapointsfromthedistributionandassigningtoeachpointaweight.Ateverytimestepthepointsareindividuallypropagatedthroughthenon-linearmodel,andﬁnallytheresultingmeanandcovarianceiscomputedfromtheforecastedsigmapoints.UnliketheEKF,notonlythemeanisadvancedintime,butalsomanypointssampledfromthedistribution.ThemethodrequiresN=2r+1sigmapointswhereristhesystemdimension.[22]showsthattheUKF,withthesamecomplexity,isabetterﬁlterthantheEKFfornon-linearmodelscapturingsigmapoints’meanandcovarianceaccuratelyuptothethirdorder(inTaylorseriesexpansionterms)whiletheEKFonlytotheﬁrst.UsingUKFinsteadofEKFhalfedtheRMSEinestimatingvehicleandwheelangularvelocityoftheanti-lockbrakingsystem(ABS)in[23].EnsembleKalmanFilterTheEnKFrepresentsthedistributionasarandomsampleofpointscalledensemblemembers.Intheforecaststep,eachensemblememberisintegratedforwardintimewithanadditionalprocessnoise.Theforecastederrorcovariancematrixisapproximatedatanytimestepbytheensemblesamplecovariance.TheerrorcovariancematrixisthusimplicitlypropagatedsavingthehighcomputationalrequirementsassociatedwithitsstorageandforwardintegrationsuchasinKFandEKF.Theupdatestageconsistsofupdatingeveryensemblememberusingsamplecovarianceasanapproximationofthetruecovariance.Theensemblemembersareneverresampledfromthedistributionthuspreservingtheensembleskewness,kurtosis,clustering,etc.IntheEnKFupdate,theupdatedensembleisobtainedbyshiftingandre-scalingtheforecastensemble.ParticleFilterTheSequentialImportanceResampling(SIR)ParticleFilter(PF),samplespointscalledparticlesfromthedistributiontogeneratesystemstatesrealizations.Theseparticlesareassignedweightsthatrepresenttheirlikelihood.ThesamplingisdonerandomlyliketheEnKF,butnotnecessarilyfromnormaldistributions.Onupdate,theparticleweightsareadjusted.Higherweightsareassignedtothosethataresupportedbysensordataandviceversa.TheParticleFiltersuffersfromaproblemwithsampledegeneracyandimpoverishment,inthatsomescenariosendupwithveryfewhigh-weightparticleswhiletheothermajorityofparticleshavealmostzeroweights.Anotherdisadvantageisthatthenumberofparticlesrequiredforgoodperformancescalesexponentiallywiththemodeldimension.ThemethoddoesnotrequireGaussiandistributionsnormodellinearity[24].Itthusworkswellwithdistributionsthathavecomplexshapeandmultiplepeaks.Exampleapplicationsincludevehiclelocalization[25],indooroccupantpositioningusingaRadioFrequencyIdentityRFIDandreceivers[26],etc.FilterSelectionTheKalmanFilterinitsbasicformcannotbeappliedtoourmodelingsystembecausethelatterisnon-linear.Themodelisalsonotcontinuouslydifferentiable,whicheliminatestheoptionofusingtheExtendedKalmanFilter.Forexample,differentphysicalconditionscanleadtotheuseoftotallydifferentprocessequations.Forourapplication,usingeitherofUKF,EnKForPFistheoreticallyvalid.Accordingto[27],UKFwouldrequire2337sigmapointstofullyrepresentthemeanandvarianceofthesystem.In[28],theUKFwasusedinasimilarapplicationasoursbutusingalgorithmstoreducethenumberofsigmapointston+2.Multiplestudiesintheliteraturepertainingtogeophysics,oceanographyandhydrologyhaveshownthattheEnKFperformswellevenwhentheensemblesizeisordersofmagnitudesmallerthanthesystemdimension[29,30].EnKFoutperformedPFintheassimilationofaconceptualrainfall-runoffin[31]andthejustiﬁcationwasthatitis“lesssensitivetomisspeciﬁcationofthemodelanduncertainties",andin[32],ithadsimilarperformance.Giventheabovespeciﬁedreasonsandthelimitationinresourcesavailablethatwillrestrictthenumberofmodelrealizations,wechoosetheEnKF.10APREPRINT-DECEMBER10,20193.1EnKF&State-spaceTheEnsembleKalmanFilter[33]wasintroducedin[34]asanalternativetoEKFtoovercomespeciﬁcdifﬁcultieswithnonlinearstateevolutionmodels,includingnon-differentiabilityofthemodelandclosureproblems.Asdescribedabove,EnKFusesMonteCarlo(orensembleintegrations)andhasthesamestandardupdateequationsoftheKF,withstatemeanandcovariancereplacedbyanestimatedensemblesamplemeanandcovariancerespectively[35].TheEnKFandmoregenerallystatisticalinversionschemesweregreatlyadvancedin[36],mainlyinthecontextofTomography.Aframeworkforsamplingasmoothpriorispresented,especiallywhenstructuralinformationabouttheensemble(correlationsbetweenpixels)isknownapriori.Suchtechniquescanalsobeusedintheperturbationsofspatialdatasuchasclimatologicinputs,modelerroretc.Forinstancethesetechniqueswereusedtogeneratesmoothinitialspatialmodelstatesensemblein[37]withoutshocks.[38]showsthatusinganon-trivialstatecovariancematrixinthestatenoiseyieldsmuchbetterperformancethanastationaryone.WiththeKalmanSmoother,stateestimationwasappliedinElectricalImpedanceTomography(EIT)toreconstructrapidlytime-varyingcross-sectionalbodyscansinferredfromboundaryvoltageandcurrentmeasurements[39],[40].Similarly,ElectricalResistanceTomography(ERT)measurementswereusedtoinferwatersaturationlevelsinsoilusingEKFassimilationofaweaklynon-linearmodel[41].Time-dependentnoisewasusedin[42]infergastemperaturefromresistancemeasurements.[37]providedaframeworkforassimilatingreadilyavailableGPSmeasurementsofvehiclespeedandvelocityintoatrafﬁcmodel[43]usingtheEnKFaspartofthetheMobileMillenniumtrafﬁc-monitoringsystem[44].Resultsofanunprecedentedscaleexperiment[37],whereGPSspeedandpositiondatafrom100-vehicleswereassimilatedintothetrafﬁcmodel,showedimprovedestimatesofthetrafﬁcstateevenwithverylowpercentageofGPS-equippedvehiclesparticipating.WenowpresenttheconceptualalgorithmoftheEnKF:Letsbethesystemdimension.Hydrologicmodelstypicallytakeinputs.Letibethenumberofinputsandobethenumberofobservations.LetxbethestatevectorandMthenon-linearmodel.Thediscretetimekforwardintegrationequationcanberepresentedas:xk=M(xk−1,bk)(50)Wherethemodelobservedstatesare:yk=Hxk(51)ThelocalizedEnKFassimilationschemecanbesummarizedbythealgorithmbelow:1.Initialization:DrawNensemblerealizationsx0a(e)(withe∈[1,...,N])fromaprocesswithamean¯x0aandcovarianceC0a2.Forecast:Ateachtimestepn,updateeachoftheNensemblemembersaccordingtoPRMSforwardsimulationmodel.Thenupdatetheensemblemeanandcovarianceaccordingto:xkf(e)=M[xk−1f(e),bk(e)]+ηk(e)(52)¯xkf=1NNXe=1xkf(e)Ckens,f=1N−1NXe=1(cid:0)xkf(e)−¯xkf(cid:1)(cid:0)xkf(e)−¯xkf(cid:1)T3.Analysis:Assumingameasurementisobtainedattimen,localizesamplecovariance,computetheKalmangain,andupdatethenetworkforecast:Ckens,f,L=L◦Ckens,fKkens=Ckens,f,L(cid:0)Hk(cid:1)T(cid:16)HkCkens,f,L(cid:0)Hk(cid:1)T+Ckobs(cid:17)−1xka(e)=xkf(e)+Kkens(cid:0)ykobs−Hkxkf(e)+χk(e)(cid:1)(53)4.Returnto2.where:skfistheensembleofstatesforecastattimek,[sxN]11APREPRINT-DECEMBER10,2019Misthemodeloperator(PRMS)bkistheperturbedensembleinput,[ixN]ηkisthewhiteprocessnoisewithcovarianceQ,[sxN]¯skfistheensemblesamplemeanofthestatesforecastattimek,[s]Ckens,fistheensemblestatesforecastsamplecovarianceattimek,[sxs]Hkistheobservationmatrixattimek,[oxs]KkensistheKalmangain,[sxo]Rkobsisthemeasurementerrorcovariance,[oxo]xkaistheensemblestatesafteranalysisattimek,[sxN]ykobsisthevectorofobservations,[ox1]χkisthemeasurementperturbationswith0mean&covarianceRnobs,[o,N]Onecanreferto[45]formoredetailsandforpracticalimplementation.ModelConstraintsThemodeldescribedabovehasphysicalconstraintsforinputs,states,observationsandparametersasdescribedinsection4.DuringtheperturbationofsuchquantitieswithnormallydistributednoiseandaftertheupdatestepoftheEnKF,invalidscenariosarelikelytoarise.Tocircumventthisissue,ahardboundarycheckisimplementedaftereachanalysisstep.Anyvaluesoutsidetherangearesettothecorrespondingmaximumorminimumofthatstate.MajordeterminantsofEnKFperformancearetheensemblesizeandtheerrorstatistics.EnsembleSizeWithaninﬁniteensemblesize,theEnKFapproximationwillreachthetrueKFsolution.Wechooseanensemblesizeof100forpracticalreasonsdetailedinSection4.Additionallyduetothesmallensemblesizecomparedtothestatespacesize,itmightbenecessarytouselocalizationwhenusingtheEnKFwhenspuriouscorrelationsbetweenphysicallyuncorrelatedstates(ex:geographicallydistantstates)affecttheﬁlterperformance[46,30].Distancebasedlocalizationweightsusinglinear,exponentialorGaussiandecorrelationfunctionsaretypicallyusedtoattenuatethecorrelationsbetweendistantstatesandobservations.Forthisstudy,wedonotuseanylocalizationastheimpactontheoutﬂowisassumedtobenegligiblecomparedtotheschemeintroducedinsection5.2.InputsandModelErrorStatisticsTheadditivenoiseηkintheintegrationequationattimek(52)ismodeledasafractionofthemeanoftheensemble.Thisschemewaschosenbecausethemajorityofstatesarestoragestatesandhavezerolowerbound.Simultaneouslyforcingsuchboundariesasdescribedaboveandaddingdailyzeromeannormalnoisewouldintroducebiastothemodel.Thedownsideofsucherrormodelingisthatthemodelisassumedtohaveperfectestimatesforstateswithzeromeans.ηk∼N(µ=0,σ=α¯xkf)(54)Inputs(andpotentiallyparameters)perturbationpropagatesmodelerrorsthatareconsistentwiththephysicsofthemodel,comparedtoonlyasimpledailyadditionofwhitenoisetotheensemble.Inputsandobservationserrorperturbationsaremodeledasindependentnormaldistributionswithstandarddeviationscomputedasthefollowing:Forinputprecipitation:σP=0.4·P(55)Pens∼N(µ=P,σ2=(0.4·P)2)(56)ForsimulatedSWEmeasurement:σSWE=0.1·SWE(57)Thestandarddeviationfortemperatureisassumedtobeaconstant:σT=2oC(58)Tens∼T+N(µ=0,σ2=22)(59)12APREPRINT-DECEMBER10,2019Varianceinﬂationisrequiredwhenthemodelforecasterrorisknowntobeunderestimated.Withoutvarianceinﬂation,theﬁltertendstodivergeandtheobservationfailstoinﬂuencethemodelforecastbecauseoftheunderestimatedspreadintheensemblestateforecastduetopreviousupdateevents.Multiplestudiesimplementvarianceinﬂationdifferently[46]andsomeuseadaptiveinﬂationthatispre-computedatanalysisstepasafunctionoftheerrorbetweentheforecastedstateandtheobservation[47].Inthisstudywewilluseapost-analysisinﬂationprocedurewithconstantαi=0.9similarto[48].x0a,infl=(1−αi)x0a+αi·x0f(60)wheretheprimex0denotestheensembleanomaly(x−¯x).4ModelFeaturesAscanbeseenbyequationsinsection1,themodelisextremelynonlinear(ex:equations21,32,and35...)andthereisfrequentuseofthresholdstodeterminewhatsituationalequationsareappropriatetouse(ex:equation12).Thosethresholdfunctionsalsomaketheresultingsystemnotcontinuouslydifferentiable.Therearesomeexplicitconstraintsformodelinputs,statesandparametersshownintables1,2andS.1.Theseconstraintsmustbesatisﬁedforthemodeltorunandtogetaphysicallyrealisticbehavior.Themodelisspatiallydistributedandrunsindependentlyoneachsub-basin.Eachsub-basinisdividedintoHRUs(forsurface),SSRsandGWRs(forsub-surface)spatialunits.Thebasin-levelmodeldimensiondependsonthenumberofthesesub-units.Toquantifythemodeldimensioninthisstudy,wefocusontheregionofinterest,whichistheEastBranchoftheNorthForkoftheFeatherRiversub-basin,highlightedinFig.1.111HRUshavebeenaprioriselectedandtheyarespatiallyco-locatedwiththeground-layersubsurfacereservoirs(SSRs)andgroundwaterreservoirs(GWRs).Wewillthuscallthe111regionsHRUsintheremainderofthisstudy.ThisimpliesthatAh=As=Agin(39).EachHRUhasatotalof12states,showninTable2.Inourcase,modelparameterscanbebasin-wide(i.e.ﬁxedandconstantvalueforallHRUs)ordifferentforeachHRU.Someparametersareconstantandotherschangemonthlyorseasonally.Thedimensionofthemodelintheregionofinterestisthen1332.DataInthisstudy,modelinputsaregeneratedbyvariouscooperatorsandareobtainedfromPaciﬁcGas&Electric(PG&E).TheywereestimatedusingtheParameter-ElevationRelationshipsonIndependentSlopesModel(PRISM)’shistoricalmonthlymaps[49]anddailyprecipitationgauges.Moredetailsareavailablein[6].SWEmeasurementsaresimulatedbyaveragingforeachHRUfromthe90meterresolutiondailyhistoricalproductin[50].OthermeasurementsavailablearethestreamﬂowF_basininequation39downstreamofthebasintochecktheoutputperformance.Themodelparametersusedarethoseobtainedfromthepreviouscalibrationstudyofthemodelandcanbefoundin[6].Theaveragewateryear2006waschosenforsimulation.Additionalwateryears(2011,2014)aresimulatedandtheirresultscanbefoundintheSupplement.2014wasadryyearwhile2011wasawetwateryear[51].Weﬁrstrunthemodelwiththecalibratedparameters[6]whicharepresentlyusedoperationallywithoutanyassimilationtoserveasareference.Next,weproceedtoassimilatetheSWEstateofthemodelinSection5.1.Theexperimentresultsmotivateanewjoint-stateparameterassimilationschemewithfeedbackthatisexplainedandsimulatedinSection5.2.PerformanceMetricsTheRootMeanSquaredErrorisusedtocomparethestreamﬂowmodeloutputfromtheassimilationexperimentswiththemeasuredstreamﬂow.RMSE=1TTXt=1q(Fbasinmeas,t−Fbasinsim,t)2(61)TheRMSEofallexperimentsconductedaresummarizedintables4and5.Forensemblesize,weusethemaximumpossibleensemblenumberof100thatispracticaltorunonatypicaluseraccessiblecomputer.ThelimitingfactorforincreasingtheensemblesizeinourcaseisthetimeneededtoreadandwritestatevaluestoanensembleofPRMSﬁles.ThePRMSusedisavailableasapre-compiledbinariesofaFortrancodeandissetuptoread/writestatedatafrom/toﬁles.Toimprovethelatencyoftheseprocedures,theﬁleswerestored13APREPRINT-DECEMBER10,2019Figure3:Wateryear2006basinstreamﬂowoutput.onRAMinsteadofdiskandtheensemblemodelforecastsweregeneratedinparallelinamulti-threadedwrapper.Simulationtimeforonewateryearwithdailyassimilationisaroundonehour.5Results5.1SWEStateAssimilationFigure4showsthattheanalysisSWEfollowscloselythe“measured"SWE.ThisisexpectedsinceinﬂationwasusedtoincreasetheuncertaintyoftheSWEstateforecast,andthusdailyobservationsofSWEhavearelativelysmalleruncertaintyduringthemajorityofthesimulationdays.TheremainingwateryeargraphsareavailableintheSupplement.SincetheSWEobservationuncertaintywasmodeledasapercentageoftheobservationvalue,itpeaksduringthepeaksnowseasonandisillustratedbythegreyensemblespreadintheplot.Figure3showsadeteriorationintheperformanceintermsofrunoffoutput.Thisisconsistentforallsimulationyears,asindicatedinTable4andinFiguresS.1andS.4intheSupplement.Themainexplanationforsuchoutcomeisthatthemodelparametersusedarethosethatwerecalibratedbasedoninputsandoutputonly.Theformeraretemperatureandprecipitationwhilethelatteristhemeasuredrunoff.NoSWEdatawereinvolvedinthecalibration,whichimpliesthatupdatingthemodelSWEtoamoreaccurateestimatewillnotnecessarilyimprovethemodeloutput.WeshouldalsonotethattheSWEusedasobservationisnotdirectlymeasured,butamodeledproduct.However,weassumethisisnotthereasonofdeterioration.Furthermore,therunoffoutputensemblespreadisnotaslargeasdesired,sincethemeasuredrunoffisnotwithintheensembleforthemajorityofthedays.GiventhattheSWEensemblespreadisrelativelylarge,thattheparametersusedwerecalibratedwithoutSWEknowledge,weconcludethatitwouldbeadvantageoustoperturbthemodelparametersandestimatethemaswellina14APREPRINT-DECEMBER10,2019Figure4:Wateryear2006basinaverageSWE.jointstate-parametersassimilationscheme.Moreoverafeedbackconsistingoftheprevious-daymeasuredrunoffwouldbenecessarytoestimatethoseparametersmostlyinvolvedinrunoffgenerationdynamics.5.2SWEandRunoffJointState-ParameterAssimilation5.2.1NewStateSpaceResultsofthepreviousexperimentimplythatparametersneedtobealtered.Modelparameterscanbeappendedtothestatevectorandupdatedonlineonassimilationeventsinwhatistermeda“Jointstate-parameterestimation".Insuchmethod,thereisnoneedtoaprioritrainthemodeltoﬁndtheoptimalparameterswhichmightnotbetime-independent.Instead,therangeofeachparametermustbeknown.Parametersareindirectlyupdatedthroughthecross-correlationbetweentheparameterandthe“state"beingobservedintheKalmangainmatrix.Jointparameter-stateassimilationhasbeenusedinmanyapplicationswithcomplexmodelsandspansdifferentﬁeldstonameafew:assimilationofmeasuredbloodconcentrationintoametabolicmodeltoupdatethenumerousmodelparametersaswellasotherunobservedstates[52],assimilationofmeasuredvelocityﬁeldsfromGPS-equippeddriftersintoashallowwatermodeltoupdatemodelparameters[53],andassimilationofmeasureddisplacementsintogasstoragegeomechanicalmodeltoreduceuncertaintyofsomemodelparameters[54].Resultsin[41]showedthatsimultaneousparameterestimationisnecessarywhenthemodelperturbedbydailyadditivewhitenoiseisfarfromthetruth.Parametersinvolvedinmodeldynamicsfrommodelstatestostreamﬂowoutputrequirestreamﬂowmeasurementstobeupdated.Parametersthatareincludedinthestatespacewerechosenbasedonthesensitivityresultsobtainedfromthestudyin[55].Wechoosetheparametersthatscorehighondailystreamﬂowstatisticsofmean,CVandAR1indicatingsensitivityofparameterstoeachprocess.Processeschosenweresnowmelt(assimilatingSWE)andrunoff(assimilating15APREPRINT-DECEMBER10,2019SymbolPRMSsymbolQuantityTypeRangeUnitsDescriptionTmstmax_allsnow1constant-10,40oFtemperaturebelowwhichPisallsnowTmrtmax_allrain1monthly-8,60oFtemperatureabovewhichPisallrainα1smidx_coefperHRUconstant0.001,0.06-linearsurfacerunoff(Fsr)coeﬁcientAsrcarea_maxperHRUconstant0.0,1.0-maxarealfractioncontributingtosurfacerunoffFsrβdday_intcp1monthly-60.0,10.0odayinterceptofdegree-dayequationjcjh_coef1monthly0.005,0.06/oFcoef.usedinETpSszmaxsoilmoist_maxperHRUconstant0.001,60.0inchesmaximumsoilzonewaterholdingcapacityα4gwﬂow_coefperGWRconstant0.001,0.5-/daylinearcoefﬁcientroutingSgwtostreamﬂowFzgwmaxsoil2gw_maxperHRUconstant0.0,5.0inchesmaxsoilexcesswaterroutedtogwStrα5gwsink_coefperGWRconstant0.0,1.0-/daylinearcoefﬁcientforgroundwatersinkα2ssr2gw_rateperSSRconstant0.05,0.8-/daylinearcoefﬁcientroutingSsstoSgwα3ssrcoef_sqperSSRconstant0.0,1.0-coeﬁcientroutingSsstostreamﬂowβ3ssrcoef_linperSSRconstant0.0,1.0-/daylinearcoeﬁcientroutingSsstostreamﬂowTable3:Perturbedandupdatedparameters.Figure5:Wateryear2006basinaveragestreamﬂow.runoff),withemphasisonrunoff.Chosenparamtersinclude9parametersperHRUand4globalparametersandareshowninTable3.Thestatevectorisaugmentedwiththeseparameters.Exponentialparametersareexcluded(ex:smidx_exp)tomaintainapproximateGaussianensembledistributions,arequirementoftheEnKF.Initialparameterperturbationsaremodeledproportionallytotheirrange,suchthat:σp=0.25·|pmax−pmin|(62)Parametersareinﬂatedpost-analysissimilarlytostatesasdescribedin(60).Parametersdonotchangeduringmodelintegration,thuswhentheparameterensemblenearscollapse-ie.whenthestandarddeviationbecomeslessthan16APREPRINT-DECEMBER10,2019WaterYearnoassim.SWEupdate∆(%)JointSWE/Fbasin∆(%)AR(1)∆(%)20061228184550889-281235120118701891117360-59430-512014198996404177-10126-36Table4:ExperimentsperformanceintermsofstreamﬂowoutputRMSEWaterYearnoassim.SWEupdate∆(%)JointSWE&Stream∆(%)20061.080.02-980.04-9620111.970.05-970.05-9820140.200.01-930.01-95Table5:Experimentsvalidationintermsofbasin-meanSWERMSE.σtarget,inﬂationisperformedbyre-scalingtheparameterensembleperturbationstoσtarget:σtarget=0.25·σp(63)whereσpisthestandarddeviationoftheinitialparameterperturbation.Next,weadditionallyaugmentthestate-spacewiththeprevious-dayupdatedrunoff,sothatitcanbeupdatedonthenextanalysisdaybytheprevious-daymeasuredrunoff.Thecurrentdaysimulatedstreamﬂowisalsoappended.Finally,thedimensionoftheaugmentedstate-spacebecomes2337.Theobservationvectoryobsisaugmentedbytheprevious-daymeasuredrunoffandcorrespondingly,anewrowisappendedtotheobservationmatrixHintheanalysisequation(52).Theprevious-daymeasuredrunoffisavailableinpracticalapplications,becauseweareupdatingtheSWEstatedaily.Themeasuredstreamﬂowisassumednearperfectandperturbedwithanindependentnormallydistributederrorwithascalingstandarddeviation:σF=0.005·Fbasinmeas(64)5.3ResultsAsreference,wecomparetheresultstoboththeestimatedstreamﬂowwithnoassimilation,whichisthegreenplotshowninFigure5,andanadditionalestimatewhichissimplytheprevious-daymeasuredstreamﬂow(notvisualized),alsotermedautoregressiveAR(1)ﬁlterwithequation:Fbasinsim,t=Fbasinmeas,t−1(65)ResultsofbothexperimentsaresummarizedinTables4and5andshowaconsistentimprovementinsimulatedstreamﬂowcomparedtothenoassimilationparameter-calibratedcase,withupto60%reductioninRMSEforthewetwateryear2011.Resultswereoccasionallybetterthanthenaiveprevious-dayAR(1)forecastsuchastheaveragewateryear2006(28%),butworseduringthedrywateryear2014.Forallassimilationexperiments,theRMSEofthebasin-meanSWEstatewassubstantiallyreduced(>90%)asexpected,sinceitisthestatebeing“measured"with10%uncertainty.SWEresultsconstituteavalidationoftheEnKFanalysisprocedure.6ConclusionTheEnKFdataassimilationframeworkpresentedsucceededinupdatingthemodeledSWEduringanalysisstep.SWEstateassimilationalonedoesnotimproverunoffinaheavilyparameterizedmodel,wheretheparametershavebeencalibratedbasedoninputs/outputwithouttakingintoconsiderationtheSWEstatebeingupdated.Furthermore,resultsshowthatdeteriorationinaccuracycanoccur.WepostulateSWEassimilationinanon-parametricmodelislikelytoimprovestreamﬂowforecastaccuracy.Jointstate-parameterassimilationusingthepreviousdaymeasuredstreamﬂowasfeedbackshowsasubstantialimprovementintheaccuracyofthedailyestimateofstreamﬂow(30%reductioninRMSEforwateryear2006)comparedtothecalibratedno-assimlationscenario,andcomparedtothesimpleprevious-dayAR(1)estimator(30%reductioninRMSEforwateryear2006)duringaveragewateryears.Inreality,streamﬂowmeasurementsarenotasaccurateasassumedinthisstudy.Itistypicallycomputedfromtheriverstagemeasurementsassumingconstantcrosssectionareaandotherapproximationsthatshouldbeaccountedfor.Streamﬂowmeasurementuncertainty,ifwellknown,canbemodeledandaccountedforin64.Nevertheless,what17APREPRINT-DECEMBER10,2019thisstudyshowsisthatwithanear-perfectmeasurementofstreamﬂow,theEnKFframeworkpresentedimprovestheaccuracyofthestreamﬂowestimate.Moreaccuratemeasurementmethodsdoexistsuchascurrentmetersorthe“AcousticDopplerCurrentProﬁler",butaremoreexpensive.Althoughthepreviousdayestimator(AR(1))wasbetterforthedryyear2014,ithasdisadvantagesoverusingthephysicalmodel-basedassimilationframeworkinthatitisnotareliablemethod,especiallywhenthepreviousstreamﬂowmeasurementisnotavailableorseverelyinaccurateduetosensorfailureorenvironmentalevents,whereastheEnKFframeworkwouldprovideamorerobustandphysicallysoundestimatewhenmeasurementsaremissing.Infact,theonlychangerequiredwhenpreviousdaymeasurementofstreamﬂowisnotavailableistodeleteonerowfromtheobservationmatrix.Moreover,theEnKFwithPRMSframeworkispreferredtothenaiveAR(1)methodgiventheforecasttimewindowtheformercanpotentiallyachieve.Wesuggestthatamoresophisticatedfullydata-drivenmodelthatconsidersatleastinputdataisrequiredtomatchitspotentiallong-termforecastaccuracysuchasanartiﬁcialrecurrentneuralnetwork(ex:Longshort-termmemory,LSTMs).Wesuggestasfutureworktoreplicatethestudyforallyearswheredataisavailable.Alongerforecastwindowstudyisalsoofinteresttostakeholdersandwouldbeanaturalcontinuationofthisreport,wheremultipledaysinthefutureareﬁrstsimulatedwithmodelinputsfromweatherpredictions(forecaststep),afterwhichtheirstreamﬂowoutputsareupdatedwithmeasurementsofSWEandstreamﬂowavailableatthecurrentday(updatestep).Thiswouldincreasethestatedimensionsonlybythenumberofdaysinthepredictionwindow,keepingtheassimilationtractable.WithparametersupdatedbymeasurementsofstreamﬂowandstatessuchasSWE,current-daymeasurementsofSWE(andpotentiallyotherstates)shouldhaveastrongimpactonthestreamﬂowpredictionaccuracyforalongpredictionwindow.AcknowledgementThisworkwaspartiallysupportedbytheCivilSystemsdepartmentatUCBerkeley,CaliforniaEnergyCommissionthroughthegrant“ImprovingHydrologicalSnowpackForecastingforHydropowerGenerationUsingIntelligentInformationSystems”(EPC-14-067),PaciﬁcGasandElectricCo(PG&E),theCaliforniaDepartmentofWaterResourcesandUCWater.IwouldliketothankProf.StevenGlaserforrecommendingmetopursuethisresearchworkandtothankProf.AlexandreM.Bayenforhisadviceandwordsofencouragement.Finally,specialthankstoKevinRichards(PG&E)forsharingstreamﬂowmeasurementsandFeatherriverdatapertainingtoPRMSsuchasHRUsandcalibratedparameters.References[1]CaliforniaDepartmentofWaterResources,“ClimateChange,”2017.[Online].Available:http://www.water.ca.gov/climatechange/[2]R.Bales,N.P.Molotch,T.H.Painter,M.D.Dettinger,R.Rice,andJ.Dozier,“MountainhydrologyofthewesternUnitedStates,”WaterResourcesResearch,vol.42,p.W08432,2006.[3]I.T.Stewart,D.R.Cayan,andM.D.Dettinger,“Changesinsnowmeltrunofftiminginwesternnorthamericaundera‘businessasusual’climatechangescenario,”ClimaticChange,vol.62,no.1,pp.217–232,Jan2004.[Online].Available:https://doi.org/10.1023/B:CLIM.0000013702.22656.e8[4]——,“Changestowardearlierstreamﬂowtimingacrosswesternnorthamerica,”JournalofClimate,vol.18,no.8,pp.1136–1155,2005.[Online].Available:https://doi.org/10.1175/JCLI3321.1[5]T.H.Painter,D.F.Berisford,J.W.Boardman,K.J.Bormann,J.S.Deems,F.Gehrke,A.Hedrick,M.Joyce,R.Laidlaw,D.Marks,C.Mattmann,B.McGurk,P.Ramirez,M.Richardson,S.M.K.Skiles,F.C.Seidel,andA.Winstral,“TheAirborneSnowObservatory:Fusionofscanninglidar,imagingspectrometer,andphysically-basedmodelingformappingsnowwaterequivalentandsnowalbedo,”RemoteSensingofEnvironment,vol.184,pp.139–152,2016.[Online].Available:http://dx.doi.org/10.1016/j.rse.2016.06.018[6]K.M.Koczot,A.E.Jeton,Bruce,McGurk,andM.D.Dettinger,“Precipitation-runoffprocessesinthefeatherriverbasin,northeasterncalifornia,andstreamﬂowpredictability,wateryears1971-97.”[Online].Available:https://pubs.usgs.gov/sir/2004/5202/[7]S.L.Markstrom,R.S.Regan,L.E.Hay,andR.J.Viger,“Prms-iv,theprecipitation-runoffmodelingsystem,version4.”[Online].Available:https://pubs.usgs.gov/tm/6b7/18APREPRINT-DECEMBER10,2019[8]R.A.Anthes,“Dataassimilationandinitializationofhurricanepredictionmodels,”JournaloftheAtmosphericSciences,vol.31,no.3,pp.702–719,1974.[Online].Available:https://doi.org/10.1175/1520-0469(1974)031<0702:DAAIOH>2.0.CO;2[9]F.COUNILLONandL.BERTINO,“Ensembleoptimalinterpolation:multivariatepropertiesinthegulfofmexico,”TellusA,vol.61,no.2,pp.296–308,2009.[Online].Available:https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1600-0870.2008.00383.x[10]F.-X.L.DIMETandO.TALAGRAND,“Variationalalgorithmsforanalysisandassimilationofmeteorologicalobservations:theoreticalaspects,”TellusA,vol.38A,no.2,pp.97–110,1986.[Online].Available:https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1600-0870.1986.tb00459.x[11]C.Paniconi,M.Marrocu,M.Putti,andM.Verbunt,“Newtoniannudgingforarichardsequation-baseddistributedhydrologicalmodel,”AdvancesinWaterResources,vol.26,no.2,pp.161–178,2003.[Online].Available:http://www.sciencedirect.com/science/article/pii/S0309170802000994[12]A.T.Lorenzo,M.Morzfeld,W.F.Holmgren,andA.D.Cronin,“Optimalinterpolationofsatelliteandgrounddataforirradiancenowcastingatcityscales,”SolarEnergy,vol.144,pp.466–474,2017.[Online].Available:http://www.sciencedirect.com/science/article/pii/S0038092X17300555[13]M.BayesandM.Price,“Anessaytowardssolvingaprobleminthedoctrineofchances.bythelaterev.mr.bayes,f.r.s.communicatedbymr.price,inalettertojohncanton,a.m.f.r.s.”PhilosophicalTransactions(1683-1775),vol.53,pp.370–418,1763.[Online].Available:http://www.jstor.org/stable/105741[14]R.Kalman,“Anewapproachtolinearﬁlteringandpredictionproblems,”JournalofBasicEngineering(ASME),vol.82D,pp.35–45,011960.[15]N/A,“Thekalmanﬁlterasbestlinearestimator,”UniversityLecture,2018.[Online].Available:https://berkeley-me233.github.io/[16]J.KaipioandE.Somersalo,Statisticalandcomputationalinverseproblems.Springer,2010.[17]J.Fonseca,R.Oliveira,J.Abreu,E.Ferreira,andM.Machado,“Kalmanﬁlterembeddedinfpgatoimprovetrackingperformanceinballisticrockets,”042013,pp.606–610.[18]R.KasperandS.Schmidt,“Sensor-data-fusionforanautonomousvehicleusingakalman-ﬁlter,”in20086thInternationalSymposiumonIntelligentSystemsandInformatics,Sep.2008,pp.1–5.[19]T.ChoudhryandH.Wu,“Forecastingtheweeklytime-varyingbetaofukﬁrms:Garchmodelsvs.kalmanﬁltermethod,”TheEuropeanJournalofFinance,vol.15,no.4,pp.437–444,2009.[Online].Available:https://doi.org/10.1080/13518470802604499[20]P.ZarchanandH.Musoff,FundamentalsofKalmanﬁltering:apracticalapproach.AmericanInst.ofAeronauticsandAstronautics,2005.[21]A.Tinka,M.Raﬁee,andA.M.Bayen,“Floatingsensornetworksforriverstudies,”IEEESystemsJournal,vol.7,no.1,pp.36–49,March2013.[22]E.WanandR.VanDerMerwe,“Theunscentedkalmanﬁlterfornonlinearestimation,”vol.153-158,022000,pp.153–158.[23]D.Kun,L.Kaijun,andX.Qunsheng,“Applicationofunscentedkalmanﬁlterforthestateestimationofanti-lockbrakingsystem,”in2006IEEEInternationalConferenceonVehicularElectronicsandSafety,Dec2006,pp.130–133.[24]M.S.Arulampalam,S.Maskell,N.Gordon,andT.Clapp,“Atutorialonparticleﬁltersforonlinenonlinear/non-gaussianbayesiantracking,”IEEETransactionsonSignalProcessing,vol.50,no.2,pp.174–188,Feb2002.[25]A.U.Peker,O.Tosun,andT.Acarman,“Particleﬁltervehiclelocalizationandmap-matchingusingmaptopology,”in2011IEEEIntelligentVehiclesSymposium(IV),June2011,pp.248–253.[26]K.Weekly,H.Zou,L.Xie,Q.Jia,andA.M.Bayen,“Indooroccupantpositioningsystemusingactiverﬁddeploymentandparticleﬁlters,”in2014IEEEInternationalConferenceonDistributedComputinginSensorSystems,May2014,pp.35–42.[27]Y.ChengandZ.Liu,“Optimizedselectionofsigmapointsintheunscentedkalmanﬁlter,”in2011InternationalConferenceonElectricalandControlEngineering,Sept2011,pp.3073–3075.[28]P.Jiang,Y.Sun,andW.Bao,“StateestimationofconceptualhydrologicalmodelsusingunscentedKalmanﬁlter,”HydrologyResearch,vol.50,no.2,pp.479–497,122018.[Online].Available:https://doi.org/10.2166/nh.2018.03819APREPRINT-DECEMBER10,2019[29]Zhang,Hongjuan,H.Franssen,Harrie-Jan,J.A.,andHarry,“Stateandparameterestimationoftwolandsurfacemodelsusingtheensemblekalmanﬁlterandtheparticleﬁlter,”Sep2017.[Online].Available:https://www.hydrol-earth-syst-sci.net/21/4927/2017[30]J.Rasmussen,H.Madsen,K.H.Jensen,andJ.C.Refsgaard,“Dataassimilationinintegratedhydrologicalmodelingusingensemblekalmanﬁltering:evaluatingtheeffectofensemblesizeandlocalizationonﬁlterperformance,”HydrologyandEarthSystemSciences,vol.19,no.7,pp.2999–3013,2015.[Online].Available:https://www.hydrol-earth-syst-sci.net/19/2999/2015/[31]A.H.WeertsandG.Y.H.ElSerafy,“Particleﬁlteringandensemblekalmanﬁlteringforstateupdatingwithhydrologicalconceptualrainfall-runoffmodels,”WaterResourcesResearch,vol.42,no.9,2006.[Online].Available:https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2005WR004093[32]D.Plaza,K.R.De,andV.Pauwels,“Fromtheensemblekalmanﬁltertotheparticleﬁlter:acomparativestudyinrainfall-runoffmodels*,”IFACProceedingsVolumes,vol.44,no.1,pp.14201–14206,2011,18thIFACWorldCongress.[Online].Available:http://www.sciencedirect.com/science/article/pii/S1474667016459082[33]G.Evensen,“Theensemblekalmanﬁlter:theoreticalformulationandpracticalimplementation,”OceanDynamics,vol.53,no.4,pp.343–367,Nov2003.[Online].Available:https://doi.org/10.1007/s10236-003-0036-9[34]——,“Sequentialdataassimilationwithanonlinearquasi-geostrophicmodelusingmontecarlomethodstoforecasterrorstatistics,”JournalofGeophysicalResearch:Oceans,vol.99,no.C5,pp.10143–10162,1994.[Online].Available:https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/94JC00572[35]G.Burgers,P.JanvanLeeuwen,andG.Evensen,“Analysisschemeintheensemblekalmanﬁlter,”MonthlyWeatherReview,vol.126,no.6,pp.1719–1724,1998.[Online].Available:https://doi.org/10.1175/1520-0493(1998)126<1719:ASITEK>2.0.CO;2[36]J.KaipioandE.Somersalo,Statisticalandcomputationalinverseproblems.Springer,2010.[37]D.Work,O.-P.Tossavainen,S.Blandin,A.Bayen,T.Iwuchukwu,andK.Tracton,“Anensemblekalmanﬁlteringapproachtohighwaytrafﬁcestimationusinggpsenabledmobiledevices,”012008,pp.5062–5068.[38]A.Seppänen,M.Vauhkonen,E.Somersalo,andJ.P.Kaipio,“Statespacemodelsinprocesstomography—approximationofstatenoisecovariance,”InverseProblemsinEngineering,vol.9,no.5,pp.561–585,2001.[Online].Available:https://doi.org/10.1080/174159701088027781[39]J.P.KAIPIO,P.A.KARJALAINEN,E.SOMERSALO,andM.VAUHKONEN,“Stateestimationintime-varyingelectricalimpedancetomography,”AnnalsoftheNewYorkAcademyofSciences,vol.873,no.1,pp.430–439,1999.[Online].Available:https://nyaspubs.onlinelibrary.wiley.com/doi/abs/10.1111/j.1749-6632.1999.tb09492.x[40]A.Seppänen,M.Vauhkonen,P.JVauhkonen,E.Somersalo,andJ.Kaipio,“Stateestimationwithﬂuiddynamicalevolutionmodelsinprocesstomography:Eitapplication,”InverseProblems-INVERSEPROBL,vol.17,082000.[41]A.Lehikoinen,S.Finsterle,A.Voutilainen,M.Kowalsky,andJ.Kaipio,“Dynamicalinversionofgeophysicalertdata:stateestimationinthevadosezone,”InverseProblemsinScienceandEngineering,vol.17,no.6,pp.715–736,2009.[Online].Available:https://doi.org/10.1080/17415970802475951[42]D.Baroudi,J.Kaipio,andE.Somersalo,“Dynamicalelectricwiretomography:atimeseriesapproach,”InverseProblems,vol.14,no.4,pp.799–813,aug1998.[43]D.B.Work,S.Blandin,O.-P.Tossavainen,B.Piccoli,andA.M.Bayen,“ATrafﬁcModelforVelocityDataAssimilation,”AppliedMathematicsResearcheXpress,vol.2010,no.1,pp.1–35,042010.[Online].Available:https://doi.org/10.1093/amrx/abq002[44]“Mobilemillennium.”[Online].Available:http://trafﬁc.berkeley.edu/[45]G.Evensen,DataAssimilationTheEnsembleKalmanFilter.SpringerBerlin,2014.[46]A.J.MajdaandX.T.Tong,“Performanceofensemblekalmanﬁltersinlargedimensions,”CommunicationsonPureandAppliedMathematics,vol.71,no.5,pp.892–937.[Online].Available:https://onlinelibrary.wiley.com/doi/abs/10.1002/cpa.21722[47]H.H.Bauser,D.Berg,O.Klein,andK.Roth,“Inﬂationmethodforensemblekalmanﬁlterinsoilhydrology,”HydrologyandEarthSystemSciencesDiscussions,pp.1–18,032018.[48]Y.Shi,K.J.Davis,F.Zhang,C.J.Duffy,andX.Yu,“Parameterestimationofaphysically-basedlandsurfacehydrologicmodelusinganensemblekalmanﬁlter:Amultivariatereal-dataexperiment,”AdvancesinWaterResources,vol.83,pp.421–427,2015.[Online].Available:http://www.sciencedirect.com/science/article/pii/S030917081500135920APREPRINT-DECEMBER10,2019[49]C.Daly,M.Halbleib,J.I.Smith,W.P.Gibson,M.K.Doggett,G.H.Taylor,J.Curtis,andP.P.Pasteris,“Physiographicallysensitivemappingofclimatologicaltemperatureandprecipitationacrosstheconterminousunitedstates,”InternationalJournalofClimatology,vol.28,no.15,pp.2031–2064,2008.[Online].Available:https://rmets.onlinelibrary.wiley.com/doi/abs/10.1002/joc.1688[50]S.A.Margulis,G.Cortés,M.Girotto,andM.Durand,“Alandsat-erasierranevadasnowreanalysis(1985–2015),”JournalofHydrometeorology,vol.17,no.4,pp.1203–1221,2016.[Online].Available:https://doi.org/10.1175/JHM-D-15-0177.1[51]L.S.HuningandS.A.Margulis,“Climatologyofseasonalsnowfallaccumulationacrossthesierranevada(usa):Accumulationrates,distributions,andvariability,”WaterResourcesResearch,vol.53,no.7,pp.6033–6049.[Online].Available:https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1002/2017WR020915[52]A.Arnold,D.Calvetti,andE.Somersalo,“Parameterestimationforstiffdeterministicdynamicalsystemsviaensemblekalmanﬁlter,”InverseProblems,vol.30,no.10,p.105008,sep2014.[53]M.Raﬁee,A.Tinka,J.Thai,andA.M.Bayen,“Combinedstate-parameterestimationforshallowwaterequations,”inProceedingsofthe2011AmericanControlConference,June2011,pp.1333–1339.[54]C.Zoccarato,D.Baù,M.Ferronato,G.Gambolati,A.Alzraiee,andP.Teatini,“Dataassimilationofsurfacedisplacementstoimprovegeomechanicalparametersofgasstoragereservoirs,”JournalofGeophysicalResearch:SolidEarth,vol.121,no.3,pp.1441–1461,2016.[Online].Available:https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1002/2015JB012090[55]H.StevenL.,L.E.,Clark,andM.P.,“Towardssimpliﬁcationofhydrologicmodeling:identiﬁcationofdominantprocesses,”Nov2016.[Online].Available:https://www.hydrol-earth-syst-sci.net/20/4655/2016/21SUPPLEMENTTOTHEPAPER“DAILYDATAASSIMILATIONOFAHYDROLOGICMODELUSINGTHEENSEMBLEKALMANFILTER"APREPRINTSamiA.MalekDepartmentofElectricalEngineeringandComputerScienceUniversityofCaliforniaatBerkeleyBerkeley,CA94704sami.malek@berkeley.eduDecember10,20191ModelParametersReferenceThissectionconsistsofTable1.2ModelVariablesReferenceThissectionconsistsofTable2.3WaterYear2011Results3.1SWEupdateThissectionconsistsofFigure1.3.2JointupdateThissectionconsistsofFigures2and3.4WaterYear2014Results4.1SWEupdateThissectionconsistsofFigure4.4.2JointupdateThissectionconsistsofFigures5and6.arXiv:1912.03861v1  [eess.SY]  9 Dec 2019APREPRINT-DECEMBER10,2019SymbolPRMSsymbolQuantityTypeRangeUnitsDescriptionPminppt_rad_adj1monthly0.0,0.5inchesminimumPtoadjustsolarradiationφdday_slope1monthly0.2,0.9oday/oFslopeofdegree-dayequationβdday_intcp1monthly-60.0,10.0odayinterceptofdegree-dayequationγsradj_sppt1constant0.0,1.0-adjustmentfactorforsummersolarradwithP>Pminγwradj_wppt1constant0.0,1.0-adjustmentfactorforwintersolarradwithP>Pminλ2tmin_lapse1monthly-10.0,10.0oF/mileslopeofminimumtemperatureinterpolationλ1tmax_lapse1monthly-10.0,10.0oF/mileslopeofmaximumtemperatureinterpolationβ2tmin_adjperHRUconstant-10.0,10.0oFphysiographicadjustmenttominimumTβ1tmax_adjperHRUconstant-10.0,10.0oFphysiographicadjustmenttomaximumTdscovden_sumperHRUconstant0.0,1.0-vegetationarealcoverageduringsummerdwcovden_winperHRUconstant0.0,1.0-vegetationarealcoverageduringwinterTmstmax_allsnow1monthly-10.0,40.0oFTmaxbelowwhichallPissnowTmrtmax_allrain1constant-8.0,60.0oFTmaxabovewhichallPisrainζadjmix_rain1monthly0.6,1.4-rainfractionofmixedrain-snowPCrssrain_intcpperHRUconstant0.0,1.0inchescanopysummerraininterceptionstoragecapacityCrwwrain_intcpperHRUconstant0.0,1.0inchescanopywinterraininterceptionstoragecapacityCssnow_intcpperHRUconstant0.0,1.0inchescanopywintersnowinterceptionstoragecapacityjcjh_coef1monthly0.005,0.06/oFcoef.usedinETpαalbedoperHRUconstant0.0,1.0-fractionofradiationreﬂectedbysnowψrad_trncfperHRUconstant0.0,1.0-transmissioncoefﬁcientforRswthroughwintercanopy(cid:15)emis_noppt1constant0.757,1.0-emissivityofairwithnoPωcecn_coef1monthly2.0,10.0cal/oCconvection&condensationcoefﬁcientξpotet_sublim1constant0.0,1.0-fractionofETpsublimatedρinitden_init1constant0.01,0.5g/cm3densityofnewsnowPρmaxden_max1constant0.1,0.8g/cm3maximumaveragesnowpackdensityτsettle_const1constant0.01,0.5-settlementtimeconstantforsnowpackﬁhru_percent_impervperHRUconstant0.0,0.999-HRUimperviousfractionSimaximperv_stor_maxperHRUconstant0.0,0.1inchesmaximumSimpSszmaxsoilmoist_maxperHRUconstant0.001,60.0inchesmaximumsoilzonewaterholdingcapacityα1smidx_coefperHRUconstant0.001,0.06-linearsurfacerunoff(Fsr)coeﬁcientθ1smidx_expperHRUconstant0.1,0.51/inchexponentialsurfacerunoffcoeﬁcientα3ssrcoef_sqperSSRconstant0.0,1.0-coeﬁcientroutingSsstostreamﬂowβ3ssrcoef_linperSSRconstant0.0,1.0-/daylinearcoeﬁcientroutingSsstostreamﬂowα2ssr2gw_rateperSSRconstant0.05,0.8-/daylinearcoefﬁcientroutingSsstoSgwθ2ssr2gw_expperSSRconstant0.0,3.0-exponentialcoefﬁcientroutingSsstoSgwsmaxssrmax_coefperSSRconstant1.0,20.0inchescoefﬁcientroutingSsstoSgwα4gwﬂow_coefperGWRconstant0.001,0.5-/daylinearcoefﬁcientroutingSgwtostreamﬂowα5gwsink_coefperGWRconstant0.0,1.0-/daylinearcoefﬁcientforgroundwatersinkFzgwmaxsoil2gw_maxperHRUconstant0.0,5.0inchesmaxsoilexcesswaterroutedtogwStrAcurvesnarea_curve11constant0.0,1.0-snowareadepletioncurve:fscavsSWEmaxSWEmaxsnarea_threahperHRUconstant0.0,200.0inchesmaxSWEforeachHRUbelowwhichsnowpatchoccursAsrcarea_maxperHRUconstant0.0,1.0-maxarealfractioncontributingtosurfacerunoffFsrTable1:Modelparameters2APREPRINT-DECEMBER10,2019SymbolPRMSsymbolQuantityUnitsDescriptionRswswradperHRULangleysshortwaveradiationrsolfperHRU-ratioofactualtopotentialdailysolarradiationPnppt_netperHRUinchestotalnetprecipitationPtthroughfallperHRUinchesprecipitationthroughfallafterinterceptionScAvailCanStperHRUacre-inchavailablestorageincanopyETppotetperHRUinchespotentialevapotranspirationETpaapetperHRUinchesavailablepotentialevapotranspiration∆EtcalperHRULangleysnetsnowpackenergybalanceIcalperHRULangleystotalincominglongwaveQvcecsubperHRULangleysconvectionandlatentheatfromcondensationRnswnperHRULangleysnetshortwaveradiationIplwpperHRULangleysperfectblack-bodyemissionTavgtempperHRUoFaveragetemperatueQcqcondperHRULangleysconductedheatBsubperHRUinchessublimationPnsnet_snowperHRUinchessnowportionofPnDpk_depthperHRUinchessnowdepthMsnowmeltperHRUinchessnowmeltfsasnowcov_areaperHRU.fractionalsnowcoveredareaPnrnet_rainperHRUinchesrainportionofPnPsrihru_srofﬁperHRUinchesimpervioussurfacerunoffeihru_impervevapperHRUinchesimpreviousregionevaporationTable2:ModelvariablesFigure1:Wateryear2011basinaveragestreamﬂow(SWEupdate).3APREPRINT-DECEMBER10,2019Figure2:Wateryear2011basinaverageSWE.(SWEorJointupdate)4APREPRINT-DECEMBER10,2019Figure3:Wateryear2011basinaveragestreamﬂow(Jointupdate).5APREPRINT-DECEMBER10,2019Figure4:Wateryear2014basinaveragestreamﬂow(SWEupdate).6APREPRINT-DECEMBER10,2019Figure5:Wateryear2014basinaverageSWE.(SWEorJointupdate)7APREPRINT-DECEMBER10,2019Figure6:Wateryear2014basinaveragestreamﬂow.(Jointupdate)8