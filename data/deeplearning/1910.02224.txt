Transductive Episodic-Wise Adaptive Metric for Few-Shot Learning

Limeng Qiao1,4, Yemin Shi2,4, Jia Li3,4∗, Yaowei Wang4, Tiejun Huang2,4 and Yonghong Tian2,4∗,
1 Center for Data Science, AAIS, Peking University
2 National Engineering Laboratory for Video Technology, School of EE&CS, Peking University
3 State Key Laboratory of Virtual Reality Technology and Systems, SCSE, Beihang University
4 Peng Cheng Laborotory, Shenzhen, China

9
1
0
2

t
c
O
5

]

G
L
.
s
c
[

1
v
4
2
2
2
0
.
0
1
9
1
:
v
i
X
r
a

Abstract

Few-shot learning, which aims at extracting new con-
cepts rapidly from extremely few examples of novel classes,
has been featured into the meta-learning paradigm recently.
Yet, the key challenge of how to learn a generalizable clas-
siﬁer with the capability of adapting to speciﬁc tasks with
severely limited data still remains in this domain. To this
end, we propose a Transductive Episodic-wise Adaptive
Metric (TEAM) framework for few-shot learning, by inte-
grating the meta-learning paradigm with both deep met-
ric learning and transductive inference. With exploring the
pairwise constraints and regularization prior within each
task, we explicitly formulate the adaptation procedure into
a standard semi-deﬁnite programming problem. By solv-
ing the problem with its closed-form solution on the ﬂy
with the setup of transduction, our approach efﬁciently tai-
lors an episodic-wise metric for each task to adapt all fea-
tures from a shared task-agnostic embedding space into a
more discriminative task-speciﬁc metric space. Moreover,
we further leverage an attention-based bi-directional sim-
ilarity strategy for extracting the more robust relationship
between queries and prototypes. Extensive experiments on
three benchmark datasets show that our framework is supe-
rior to other existing approaches and achieves the state-of-
the-art performance in the few-shot literature.

1. Introduction

Deep neural networks have achieved great success on
many practical applications recently and even have sur-
passed humans in image recognition domain [8, 15, 28].
However, these successes largely beneﬁt from tens of thou-
sands of labeled data, enormous number of parameters and
sophisticated training strategies. In terms of the low-data
scenarios, such as medical images classiﬁcation and ma-

∗Correspondence should be addressed to Yonghong Tian and Jia Li.

(yhtian@pku.edu.cn and jiali@buaa.edu.cn).

Figure 1. The left part shows a general framework of previous ap-
proaches based on meta learning. The model embeds all samples
into a task-independent metric space with a shared CNN. How-
ever, considering the distinctive information within each task, we
further learn an episodic-wise adaptive metric for classiﬁcation.
The right part illustrates the motivation of our approach brieﬂy.

rine biological recognition, deep neural networks will be
over-ﬁtting and severely collapse because only rare labeled
samples are provided for training. To this end, by explor-
ing the exciting idea that tries to learn new concepts rapidly
and generalize well with extremely few examples, or even
single, few-shot learning has attracted signiﬁcant research
interest recently [5, 19, 24, 27, 29, 35, 38].

Concretely, we focus on the case of few-shot classiﬁca-
tion with the meta-learning paradigm, which leverages a
series of independent and identically distributed few-shot
tasks to learn a desired classiﬁer at training time and applies
the model directly to non-overlap unseen target classiﬁca-
tion problem during testing phase. The so-called episodic-
training strategy, which has been widely developed in many
previous work [29, 35], keeps the consistency between the
training and real test scenario and improve the generaliza-
tion performances. In each task (or episode), only a hand-
ful of labeled examples per classes (the support set) are
provided to the classiﬁer for training and then plenty of
unlabeled points (the query set) need to be assigned la-
bels for prediction. Speciﬁcally, [29, 35, 38] jointed the
meta-learning with metric learning as a feed-forward man-

1

 
 
 
 
 
 
these

ner, with optimizing a shared distance metric across all
tasks. Moreover, [5] proposed to learn a general initializa-
tion strategy and [17, 24] learned to update the parameters
of learner directly with a higher-level meta-optimizer (e.g.
LSTM).
While

approaches based on meta-learning
paradigm have made signiﬁcant advances in few-shot
classiﬁcation, they do suffer from two distinct limitations.
One is that all examples from various different tasks are
embedded into a task-independent metric space indiscrimi-
nately, see Fig. 1 (left). Namely, this assumption does not
take the task-level information (meta-data) into account but
example-level feature only, which neglects the speciﬁcity of
different tasks. Actually, what is missing of this idea is an
adaptive module that tailors the metric space for each task.
The other is that most current methods follow the setup
of inductive inference, that is, training the meta-learner
with severely limited support data and predicting queries
one by one in each task. Obviously, this process does not
adequately consider the interaction between the support set
and unlabeled test set and thus weakens the advantages of
meta-learning.

To deal with the key challenge of how to learn a gen-
eralizable classiﬁer with the capability of adapting to spe-
ciﬁc tasks with severely limited data, we propose a novel
meta-learning framework for few-shot classiﬁcation, named
as Transductive Episodic-wise Adaptive Metric (TEAM),
which efﬁciently tailors an episodic-wise metric space with
applying the idea of transductive inference. Speciﬁcally, we
put forward not only to learn a task-agnostic instance em-
bedding model end-to-end over a pool of few-shot tasks as
a meta-learning manner, but also constructs a task-speciﬁc
distance metric explicitly for each task with the distinctive
information, such as the pairwise constraints and regulariza-
tion prior, see Fig. 1 (right). Furthermore, we formulate the
optimization process for task-speciﬁc metric into a standard
semi-deﬁnite programming (SDP) problem [2] and ﬁnally
acquire the closed-form solution by solving the SDP prob-
lem on the ﬂy. Hereafter all features generated by the task-
agnostic model are adapted into task-speciﬁc metric spaces
where samples from the same class are closer and differ-
ent classes are farther apart. According to the transformed
embeddings, we then perform a novel attention-based bi-
directional similarity strategy to compute more robust re-
lationship between each unlabeled query and class proto-
types, which further improves the performance of our ap-
proach. In addition, by utilizing the convex combination of
all samples within each task to construct auxiliary training
tasks, we propose a task-level data augmentation technique
for boosting the generalization of the embedding model.
The whole framework is illustrated in Fig. 2 in details.

The main contribution is summarized as threefold. (1)
We propose a general meta-learning framework of apply-

ing the transductive inference on formulating the adaptation
procedure into a SDP problem and tailoring the episodic-
wise metric in each task for few-shot learning, which can
also be directly extended to other existing methods and
even semi-supervised learning. (2) We identify a novel bi-
directional similarity strategy for extracting the more robust
relationship between queries and prototypes. (3) The exper-
imental results on three benchmark datasets show that our
framework is superior to other state-of-the-art approaches.

2. Related Work

Meta-learning in Few-shot Learning. Meta-learning, or
learning to learn [31], is the technique of observing how
different machine learning approaches perform on a wide
range of tasks rather than batches of data points, and then
starting from this experience, or meta-data, to learn new
tasks much faster and obtain higher performance. In recent
few-shot learning literature, more and more approaches fol-
low the idea of meta-learning to alleviate over-ﬁtting. Meta-
LSTM [24] aims to learn efﬁcient parameter updating rules
for training neural network (learner) with a LSTM-based
meta-learner. MAML [5], on the other hand, tries to learn
a good model parameter initialization strategy that gener-
alizes better to similar tasks. Similarly, Reptile [21] is an
approximation of MAML that executes stochastic gradient
descent with a ﬁrst-order form. Meta-SGD [17] goes fur-
ther in meta-learning by arguing to learn the weights initial-
ization, gradient update direction and learning rate within
a single step. However, these approaches mentioned above
suffer from the issue of ﬁne-tuning. In contrast, after opti-
mizing a meta-learner over a series of tasks, our approach
solves unseen target tasks in an feed-forward manner with-
out any further model updates and just optimize an episodic-
wise distance metric efﬁciently for each task, thus avoiding
gradient computation and serious overﬁtting.
Distance Metric Learning Approaches. Another cate-
gory of approach focus on obtaining a generalizable embed-
ding model to transform all samples into a common metric
space where can perform simple classiﬁers such as nearest
neighbor directly. Matching Network [35] integrates metric
learning with meta-learning for the ﬁrst time by training a
learnable nearest neighbor classiﬁer with deep neural net-
works. Prototypical Network [29] utilizes class prototype
representations to assign labels for query points and formu-
lates the ﬁnal loss function with euclidean distance directly.
Later, this work is extended to semi-supervised few-shot
scenario by [25], unlabeled data are used to reﬁne the class
prototypes. Relation Network [38] trains an auxiliary net-
work to compute the similarity score between each query
and the support set, which is equivalent to further learn a
non-linear metric. These approaches assume all samples
are embedded into a task-agnostic metric space.
Instead,
our framework intends to emphasize the speciﬁcity among

Figure 2. The architecture of Transductive Episodic-wise Adaptive Metric (TEAM) framework for few-shot learning. The whole training
data is reorganized into a pool of few-shot tasks (meta-training set) ﬁrstly and then the task-level data augmentation technique (TIM) per-
forms the convex combination between all samples in each task. After that, the augmented episodic data is fed into the CNN and the EAM
module constructs a task-speciﬁc distance metric M †
t explicitly for each task on the ﬂy with the pairwise constraints and regularization
prior. The symbol ⊗ in Bi-SIM module indicates that each query is assigned a label using the bi-directional similarity.

different tasks, that is, samples from different tasks should
be embedded into a more discriminative task-speciﬁc space.

Task Adaptation Approaches. The third family of ap-
proaches, which aims to mine the task adaptability with the
meta-learning paradigm, is currently a hot research direc-
tion for few-shot learning. MT-Net [16] proposes that the
meta-learner learns on each layers activation space and the
task-speciﬁc learner performs gradient descent on a sub-
space, which is more sensitive to task identity. TADAM
[22] proposes a Task Encoding Network to produce scaling
and shift vectors for each layer weights, leading to a task-
dependent metric space. Our approach is slightly similar
to these methods in the sense that we all focus on the idea
of task adaptation. However, without imposing auxiliary
network or applying complicated training strategy, our pro-
posed framework formulates the adaptation procedure into
a standard SDP problem under the transductive inference
setting, which is more efﬁcient and convenient.

Transductive Inference. Transductive inference [34] fol-
lows the setting of generalizing from the training set to the
test set directly and avoiding the intermediate problem of
estimating a function. In data-scarce scenario, it can signif-
icantly improve the performance over inductive methods.
Reptile [21], which implicitly shared information between
all test samples via batch normalization [11], is the ﬁrst
work of applying the transductive setting in few-shot learn-
ing. TPN [18] models the transductive inference explicitly
by learning a graph construction module, which propagates
labels from labeled instances to unlabeled query points di-
rectly. Different from using example-wise parameters for
the static Euclidean distance in [18], our approach explores
the episodic-wise distance metric by integrating the small
support set with the entire query set for transduction.

3. Transductive Episodic-wise Adaptive Metric

In this section, we describe the deﬁnition of few-shot
learning problem (FSL) and then introduce the Transduc-
tive Episodic-wise Adaptive Metric (TEAM) in details.

3.1. Problem Formulation

Just like what is employed in various previous works
[25, 29, 35, 38], we organize the learning procedure into the
form of episodic paradigm, which gradually collects meta-
knowledge across a pool of source tasks and performs adap-
tation on target tasks quickly. Under this setting, the ulti-
mate goal of our algorithm is to train models with a large
labeled dataset Dtrain, which is composed of a set of seen
classes Ctrain, and apply the classiﬁers on a novel testing
set Dtest with many unseen classes Ctest. Note that there
are only a few labeled examples for each category in Ctest
and Ctest ∩ Ctrain = ∅. In order to mimic the few-shot
test scenario during the training procedure and take full ad-
vantage of the large quantities of labeled Dtrain, we reor-
ganize all examples in Dtrain as a series of N -way K-shot
tasks (or episodes). Concretely, N -way K-shot task is usu-
ally constructed by ﬁrst selecting N classes from Ctrain
randomly and then generate a support set and a query set
from the selected classes. The support set includes K sam-
ples per classes, termed as S = {(xi, yi)}N ×K
, and whilst
the query set Q = {(ˆx1, ˆy1), . . . , (ˆxM , ˆyM )} contains dif-
ferent samples from the same label space with S. In each
episode, we train the learner with small labeled support set
S and minimize the loss on the large query set Q. After
training episode by episode until convergence, the learned
model can perform pretty well on novel few-shot tasks.

i=1

However, we argue that it is not ideal to apply the
learned model to all target tasks directly without consid-
ering the speciﬁcity of them. Our approach proposes an
episodic-wise metric construction module to transform the

task-agnostic embeddings into a task-speciﬁc metric space,
namely episodic adaptation. Moreover, in order to mitigate
the data-scarce problem of support set and construct a more
generalizable task-adaptive metric, we follow the paradigm
of transductive inference and consider the query set as a
whole for prediction, instead of one by one.

Speciﬁcally, our few-shot classiﬁcation framework (see
Fig. 2) is composed of three modules: (1) learning a task-
agnostic feature extractor to embed raw inputs into a shared
embedding space, this procedure includes a loss function
to drive the parameters update and a novel task-level aug-
mentation strategy to boost the generalization, (2) tailoring
an episodic-wise adaptive metric for each task by solving
a standard SDP problem efﬁciently and (3) performing a
novel bi-directional similarity strategy in the task-speciﬁc
space to assign label for each query. It is worth noting that
the latter two modules utilize the setting of transduction.
We describe the details of each module in the following sec-
tions.

3.2. Task-agnostic Feature Extractor

Learning Embedding Function. Our approach ﬁrst em-
ploys an embedding function fθ to extract feature of an in-
stance x, where fθ(x) refers to the embedding of x and θ
indicates the parameters of deep model. Given the few-shot
task sequence T from Dtrain, we train the feature extractor
fθ episode by episode with minimizing the negative log-
probability of true label for each sample via SGD as:

argmin
fθ

(cid:88)

(cid:88)

Ti(cid:118)T

(x,y) ∈ TIM(Ti)

−log p(y | fθ(x, MTi)) (1)

where Ti is a few-shot episode sampled from task sequence
randomly, TIM(·) is the novel task-level data augmentation
operation and MTi stands for the episodic-wise adaptation
metric of Ti. Until convergence, the optimal embedding
model f ∗
θ is applied directly to unseen target tasks which
are sampled from Dtest instead of Dtrain.
Task Internal Mixing Augmentation Strategy. Recently,
some data augmentation techniques, such as ﬂipping, rota-
tion or distorting the inputs, follow the learning principle
named Vicinal Risk Minimization (VRM) [3] to improve
the generalization performance of deep neural networks. In-
spired by [10, 39], we further propose a task-level data aug-
mentation technique which is termed as Task Internal Mix-
ing (TIM), performing the convex combination between all
support samples in each task to synthesize new episodes. To
be concrete, for each instance (xi, yi) in a source task, we
randomly select another sample (xj, yj) from the same task
and synthesize new training examples (˜x, ˜y) as follows:

˜x = ω · xi + (1 − ω) · xj, ˜y = yi
(2)
where ω (cid:118) U (l, h) and 0.5 (cid:54) l < h (cid:54) 1.0. Note xi and
xj are just the raw input tensors instead of features. Then
we handle each instance a few times with Eq. (2) to form a

virtual task (i.e. TIM(Ti) in Eq. (1) ) for training. In essence,
TIM extends the source task distribution by incorporating
the prior that if two samples are similar to each other in the
original pixel space, then they are likely to be closer in the
feature space. As such, xi and ˜x are more similar to each
other than xj and ˜x in Eq. (2) because of ω > 0.5, which
leads to the synthetic label ˜y should be yi instead of yj.

3.3. Episodic-wise Adaptive Metric

Distance with Metric Mt. Given two embeddings xi and
xj in vector space V ∈ Rd, we denote the distance between
them with the metric Mt as follows:

dMt(xi, xj) =

tr(cid:104)Mt(xi − xj)(xi − xj)T(cid:105)

(3)

(cid:113)

where tr(cid:104)·(cid:105) stands for the trace operator and Mt is a sym-
metric positive semi-deﬁnite matrix, which ensures that
dMt satisﬁes the properties of a pseudo-distance [1]. In gen-
eral, the matrix Mt parameterizes a family of Mahalanobis
distances in the vector space V. In particular, the dMt in Eq.
(3) will degenerate into the popular Euclidean distance if we
set Mt = I, that is, assuming all features are equally scaled
and equally relevant [32]. Inspired by these observations,
we proposed to explicitly construct episodic-wise adaptive
metric by leveraging the speciﬁc information of each task,
such as the pairwise constraints and the regularization prior.
Pair-constrained Loss. Given a few-shot task, our goal
is to minimize the mean of distances between all similar
sample pairs (must-link constraints, denoted with M) while
keeping the mean of distances between all dissimilar sample
pairs (cannot-link constraints, denoted with C) larger than 1
at meanwhile. Motivated by the above idea, we formulate
the Min-Max principle as a convex optimization problem in
Eq. (4) by adopting the square distance in terms of its effec-
tiveness and efﬁciency.
(cid:88)

min
Mt(cid:23)0

s.t.

1
|M|
1
|C|

(xi,xj )∈M

(cid:88)

(xi,xj )∈ C

d2
Mt

(xi, xj)

d2
Mt

(xi, xj) ≥ 1

(4)

Based on Eq. (3) and the methods of lagrange multiplier, we
rewrite the Eq. (4) into a pair-constrained loss function as:

LC(Mt | (cid:102)M, (cid:101)C) = tr(Mt · (cid:102)M) − λ · tr(Mt · (cid:101)C )

(5)

where λ is the multiplier, (cid:102)M and (cid:101)C have the following form:

(cid:102)M =

(cid:101)C =

1
|M|
1
| C |

(cid:88)

(xi,xj )∈M

(cid:88)

(xi,xj )∈ C

(xi − xj)(xi − xj)T

(xi − xj)(xi − xj)T

(6)

Furthermore, given a N -way K-shot task with support set
S = {(xi, yi)}N K
i=1 and its query set Q, we ﬁrst shrink the
support set S to a prototype set P = {pc}N

c=1 by:

pc =

1
|Sc|

(cid:88)

(xi, yi)∈Sc

xi

(7)

where Sc is the subset which contains the samples with the
same label c in S. The we deﬁne the similar and dissimilar
constraints with M = {xi ∈ Sc, xj ∈ Sc, i (cid:54)= j} ∪ {xi ∈
Sc, xj ∈ Pc} ∪ {xi ∈ Sc, xj ∈ N (xi, k, Q)} and C =
{xi ∈ Pc, xj ∈ Pc(cid:48), c (cid:54)= c(cid:48)} ∪ {xi ∈ Pc, xj ∈ PT } where
Pc is a prototype with label c in P, N (xi, k, Q) is a set of
k nearest neighbors of xi in the query set Q and PT is the
prototype set from the seen classes Ctrain.

Regularization Loss. Without imposing any restrictions or
prior information into the Eq. (5), we have d2 parameters to
be optimized for each task due to Mt ∈ Rd×d, while we can
only construct a few pairwise constraints in few-shot sce-
nario. From the perspective of machine learning theory, this
inconsistency will lead to severe over-ﬁtting of our models.
To this end, we propose the second principle to regularize
the episodic-wise metric Mt to be close to a given metric
M0, which is associated with the prior across all few-shot
tasks. Speciﬁcally, we try to minimize the Bregman diver-
gence DΦ(Mt(cid:107)M0) = Φ(Mt)−Φ(M0)−(cid:104)∇Φ(M0), Mt −
M0(cid:105) between Mt and M0 with the log-determinant function
Φ(M ) = −log det(M ), which is a strict convex, continu-
ously differentiable divergence function. Then we formu-
late the regularization loss function LR(Mt |M0) as:
0 Mt(cid:105) − log det(Mt)

(8)
where tr(cid:104)·(cid:105) means the trace operator on matrix and Eq. (8)
ignores the constant term regarding M0. More precisely,
with the information-theory, optimizing LR is equivalent
to minimizing the KL divergence between two multivari-
ate Gaussian distributions parameterized by Mt and M0.
Episodic-wise Adaptive Metric. By integrating two prin-
ciples mentioned above, we formulate a novel episodic-wise
adaptive metric (EAM) loss function for each task as:

LR(Mt | M0) = tr(cid:104)M −1

min
Mt(cid:23)0

LR(Mt | M0) + γ · LC(Mt | (cid:102)M, (cid:101)C )

(9)

where LC and LR are deﬁned in Eq. (5) and Eq. (8) re-
spectively, γ is a positive trade-off parameter. In general,
minimizing Eq. (9) with SGD-based optimizers or other ex-
isting convex optimization solvers [30] will produce a local
optimal solution for each task. However, due to the high
time complexity of SDP solvers and requiring too many it-
erations with SGD-based optimizers, this sub-optimization
procedure within each task will lead to an inefﬁcient learn-
ing process. Here, we propose a faster and more efﬁcient
approach to construct the episodic-wise metric for each
task. Concretely, we ﬁrst reformulate the Eq. (9) as follows:
0 +γ · (cid:102)M−γλ· (cid:101)C)(cid:105)−log det(Mt) (10)

tr(cid:104)Mt ·(M−1

min
Mt(cid:23)0

Based on the Lemma (1), we get the optimal solution M ∗
t
by letting Y = M−1
0 + γ · (cid:102)M − γλ · (cid:101)C and assuming Y (cid:31) 0,
(11)
And the assumption of Y (cid:31) 0 can always hold if we pick
up a positive deﬁnite matrix as prior metric M0. In addition

0 + γ · (cid:102)M − γλ · (cid:101)C )−1

t = (M−1

M ∗

to considering the pairwise constraints and regularization
prior, we further introduce the feature correlation informa-
tion into the ﬁnal metric M †
t with the task covariance matrix
(cid:80)n
Σt = 1
n−1
M †
t = (M−1

i=1 (Xi − ¯X)(Xi − ¯X)T , which results in:

0 + γ · (cid:102)M − γλ · (cid:101)C)−1 + α · Σt

(12)

where α, λ, γ are positive trade-off parameters and (cid:102)M, (cid:101)C
are from Eq.
(6). Moreover, with the insights of trans-
duction, we calculate the task covariance matrix Σt with
both the support set and query set in each episode. Ob-
viously, the Eq. (12) only involves simple matrix opera-
tions, such as inversion and transpose, which is more ef-
ﬁcient than SGD-based optimizers and naive SDP solvers.
In addition, as a symmetric positive deﬁnite matrix, another
insights into the nature of the learned episodic-wise metric
is an adaptive linear projection layer by expressing M †
t as
TLt, then the dMt(xi, xj) in Eq.(3) can be formulated as
Lt
(cid:112)tr(cid:104)(Ltxi − Ltxj)T(Ltxi − Ltxj)(cid:105), where Lt ∈ Rr×d is
a task-speciﬁc transformation matrix.

Lemma 1 Let X , Y be two symmetric positive-deﬁne ma-
trices of the same size, then the function f (X ) = tr(X Y) −
log det(X ) is minimized uniquely by: X ∗ = Y −1.

Proof. See supplementary material for more details.

3.4. Bi-directional Similarity

Assuming all samples have been transformed into a task-
speciﬁc embedding space with the learned feature extractor
fφ and the episodic-wise adaptive metric M †
t in Eq. (12),
we then perform a novel bi-directional similarity strategy
(Bi-SIM) to calculate the probability that each query be-
longs to each category.
In detail, after shrinking the the
support set S to a prototype set with Eq.(7), we formulate
the positive-direction similarity si→c between query xi and
each prototype pc with the softmax function:
exp(−dMt(xi, pc))
c(cid:48) exp(−dMt(xi, pc(cid:48)))

si→c =

(13)

(cid:80)

Most previous methods used this similarity as the ﬁnal prob-
ability of the query xi belonging to each category. However,
taking the entire query set into account with transductive in-
ference, we further compute the probability of prototype pc
belonging to each query xi with the following equation:

sc→i =

exp(−dMt(pc, xi))
i(cid:48) exp(−dMt(pc, xi(cid:48)))

(cid:80)

(14)

We termed sc→i as the negative-direction similarity which
can be interpreted as an attention-based weight of the pro-
totype pc over the whole query set Q. At last, we perform
the product of si→c and sc→i as the ﬁnal bi-directional sim-
ilarity (denoted with Bi-Sim) between the query xi and the
prototype pc, i.e. si↔c = sc→i · si→c. Essentially, the basic
idea behind the Bi-Sim strategy is that if a query is sim-
ilar to one prototype and the prototype is also similar to
the query, then we argue that they are more matching with

each other. Without increasing any computational burden
or requiring any human interaction, our proposed strategy
calculates more robust similarity efﬁciently.

4. Experiments

In this section, we detail our experimental setting and
compare TEAM with state-of-the-art approaches on three
challenging datasets, i.e. miniImageNet [35], Cifar-100 [14]
and CUB [36], which are widely used as few-shot classiﬁ-
cation benchmarks in the literature.

4.1. Datasets

The miniImageNet dataset is the most
miniImageNet.
popular benchmark in few-shot learning community, which
is proposed by [35] originally. This dataset is composed
of 100 classes selected from ImageNet [15] randomly, and
each class has 600 images, which are resized to 84×84 pix-
els for fast training and inference. Note that we follow the
setup provided by [24] which splits the total 100 classes into
64 classes, 16 classes and 20 classes for training, validation
and evaluation respectively. The validation set is only used
for tracking model generalization in all experiments.
Cifar-100. The Cifar-100 [14] is a simple dataset for im-
age classiﬁcation and consists of 100 categories, each hav-
ing 600 RGB images (32 × 32). We further split the whole
dataset into 64 classes as seen categories for training, 16 and
20 classes for validation and testing respectively [40]. Com-
pared with miniImageNet, Cifar-100 keeps the simplicity of
dataset and decreases the inference complexity.
CUB. CUB [36], which is a benchmark dataset for ﬁne-
grain classiﬁcation initially, is composed of 11788 images
over 200 birds classes. Follow the same partition as [9], we
use 100 classes for training, and another two 50 classes as
unseen classes for validation and evaluation. And all images
are cropped with the provided bounding box [33].

4.2. Experimental Settings

Backbone Networks. For fair and comprehensive com-
parison with previous baselines, we employ two backbone
networks as our embedding function. 1) A four-layers con-
volution network (ConvNet) and 2) A standard deep resid-
ual network (ResNet-18) are widely adopted in the few-shot
learning literature. Speciﬁcally, the ConvNet contains 4 re-
peated convolutional blocks, where each block is composed
of a convolution layer with 64 ﬁlters (3 × 3 kernel), a batch
normalization layer [11], a ReLU non-linearity and a max-
pooling layer with size 2. In addition, we empirically add
a global average pooling layer as last for accelerating the
convergence of the model and reducing the dimensional-
ity of the features. All inputs are resized to 84 × 84 × 3
uniformly and the ﬁnal output dimension is 256 for each
image accordingly. For ResNet, we utilize the standard ar-
chitecture proposed by [8] and remove the last fc-layer for

reducing parameters. Furthermore, all inputs are resized to
224 × 224 × 3 like many previous works. After the last av-
erage pooling layer, it leads to a 512 vector for each image.
Training Strategy. All backbone networks are optimized
via SGD by Adam [13] end-to-end on DGX-1. Follow the
strategy in [23, 26], we pre-train the ConvNet to classify
all seen classes and utilizing the optimal weights for model
initialization, and we train ResNet from scratch for simplic-
ity. Moreover, We perform TIM strategy in all experiments
and set l = 0.5 and h = 1.0 for U(l, h).
Inspired by
[10], we start TIM strategy after 5000 episodes and inter-
mittently disable it during training procedure, that is, per-
forming task mixing for Y episodes and then close it for the
next Z episodes. We empirically set Y = 4 and Z = 1
in our experiments. We decay the learning rate half every
10000 episodes and set the patience of early stopping as
20000.
Parameter Setup in M †
t .
In Eq. (9), we set the trade-off
parameters as α = 2, γ = 0.2, λ = 0.01 and the prior met-
ric as M0 = I in all experiments. In general, the choice
of M0 is not ﬁxed and has an important inﬂuence on gen-
eralization of the learned episodic-wise metric. However,
based on the following two observation, we argue the iden-
tity matrix is a quite natural choice for M0. Firstly, learn-
ing from the Euclidean distance provides the most unbiased
prior across all few-shot tasks, that is, assuming all features
from the task-agnostic embedding space are equally scaled
and equally relevant. Secondly, we observe that the optimal
adaptive metric for each few-shot task is close to the iden-
tity matrix, which has been illustrated in Fig. 3 of the paper.
Please zoom in the Fig. 3 or refer appendix for more details.

4.3. Few-shot Learning Results

To verify the effectiveness of our approach for few-shot
classiﬁcation, we compare the proposed TEAM framework
with our re-implemented baseline (ProtoNet [29]) and many
state-of-the-art methods in various setting on three bench-
mark datasets (miniImageNet, Cifar-100 and CUB). For fair
comparison with previous works, we focus on two popular
few-shot learning settings, namely 5-way 1-shot and 5-way
5-shot tasks, which both contain 15 queries per episode for
validation. In addition to the above setup, we also exper-
imente with the transductive setting in all datasets, where
the model utilizes the entire query set in each task. Specif-
ically, we consider two types of transduction in our experi-
ments. 1) Transductive batch normalization [5, 21], which
shares information between all test examples via batch nor-
malization layer, denoted with BN in all tables and 2) ex-
plicit transduction, which is ﬁrst introduced into the few-
shot learning by [18]. Moreover, to make the evaluation
more convincing, we report the ﬁnal mean accuracy over
1000 test trails for all experiments and present 95% conﬁ-
dence intervals of all results in our supplementary material.

Table 1. Few-shot classiﬁcation accuracy on miniImageNet. All
results are averaged over 1000 test tasks which are randomly se-
lected from the testing set. Tran: different type of transduction.

Model

Tran.

5-Way 1-Shot

5-Way 5-Shot

ConvNet

ResNet

ConvNet

ResNet

MatchNet [35]
MAML [5]
MAML+ [18]
Reptile [21]
ProtoNet [29]
GNN [6]
RelationNet [38]
PFA [23]
TADAM [22]
adaResNet [20]
LEO [26]
TPN [18]
Baseline (Ours)
TEAM (Ours)

No
BN
Yes
BN
No
No
BN
No
No
No
No
Yes
No
Yes

43.56
48.70
50.83
49.97
49.42
50.33
50.44
54.53
-
-
-
55.51
51.68
56.57

-
-
-
-
-
-
-
59.60
58.50
56.88
60.06
59.46
55.25
60.07

55.31
63.10
66.19
65.99
68.20
64.02
65.32
67.87
-
-
-
69.86
68.71
72.04

-
-
-
-
-
-
-
73.74
76.70
71.94
75.72
75.65
70.58
75.90

Please refer our appendix for more complete results.
Results on miniImageNet.
Experimental results on
miniImageNet are shown in Table 1, where we can see that
our model achieves state-of-the-art performance with Con-
vNet backbone and competitive results with ResNet archi-
tecture. We re-implement ProtoNet as our baseline with the
simple pre-train strategy proposed by [23], and achieve bet-
ter performance than previously reported ones in [29]. Tak-
ing ConvNet as an example, we get 51.68% and 68.71%
for 5-way 1-shot and 5-way 5-shot respectively, which are
slightly better than 49.42% and 68.20% in [29]. After ap-
plying the TEAM framework on the baseline, the perfor-
mance has been further improved signiﬁcantly. For exam-
ple, the absolute promotion of TEAM over published state-
of-the-art is 1.06% for 1-shot and 2.18% for 5-shot, over
our baseline is 4.89% and 3.33% respectively. Note that
the comparisons with PFA [23], LEO[26] and TADAM [22]
are a bit unfair since we train the TEAM(ResNet) without
any pre-train weights or including a classiﬁcation objective,
however, our model still achieves the best performance on
1-shot task.
Results on Cifar-100. Next we turn to the rich experi-
ments evaluated on the Cifar-100, and all results are shown
in Table 2 for comparison in detail. Note that all results
of MatchNet [35], MAML [5] and DEML [40] in Table 2
refer to the reported performance in [40]. Compared with
our baseline, whose accuracy is slightly higher than pre-
vious points, we notice that our TEAM(ConvNet) increases
by 6.24 % on 1-shot tasks and 2.65 % on 5-shot tasks, which
demonstrates the effectiveness of our approach.
Results on CUB. The CUB dataset [36] is proposed for
ﬁne-grain recognition initially and also widely utilized in
current few-shot classiﬁcation literature. From Table 3, we
observe that the performance of our baseline is far better
than the previous ProtoNet [29], that is because we pre-
process all images with the provided bounding boxes [33]

Table 2. Few-shot classiﬁcation performance on Cifar-100.

Model

Tran.

5-Way 1-Shot

5-Way 5-Shot

ConvNet

ResNet

ConvNet

ResNet

MatchNet [35]
MAML [5]
ProtoNet [29]
DEML [7]
Baseline (Ours)
TEAM (Ours)

No
BN
No
No
No
Yes

50.53
49.28
56.66
-
57.83
64.07

-
-
-
61.62
66.30
70.43

60.30
58.30
76.29
-
76.40
79.05

-
-
-
77.94
80.46
81.25

Table 3. Few-shot classiﬁcation performance on CUB.

Model

Tran.

5-Way 1-Shot

5-Way 5-Shot

ConvNet

ResNet

ConvNet

ResNet

MatchNet [35]
MAML [5]
ProtoNet [29]
RelationNet [38]
DEML [7]
TriNet [4]
Baseline (Ours)
TEAM (Ours)

No
BN
No
BN
No
No
No
Yes

56.53
50.45
58.43
62.45
-
-
69.39
75.71

-
-
-
-
66.95
69.61
74.55
80.16

63.54
59.60
75.22
76.11
-
-
82.78
86.04

-
-
-
-
77.11
84.10
85.98
87.17

to reduce the impact of background on ﬁnal performance.
Comparing the TEAM with our re-implemented baseline,
both ConvNet and ResNet backbones achieve outstanding
performance over 1-shot and 5-shot tasks.
Further Analysis. All results which are summarized in
the Table 1 - 3 indicate that our approach can consistently
improve the few-shot learning performance on different
datasets. This conﬁrms that, under the setting of transduc-
tive inference, our model can efﬁciently tailor an episodic-
wise adaptive metric for each task and perform a suitable
similarity between all samples. Furthermore, we notice that
the performance promotion of our approach in 1-shot sce-
nario is more signiﬁcant than that in 5-shot. This observa-
tion agrees with the nature of transduction [12, 18], where
more training data are available, the less performance im-
provement will be. With regards to this, we then perform 5-
way k-shot (k=1, 3, 5, 7, 9) experiments on mini-ImageNet
and all results are shown in Table. 6. As the number of
shots increases, we notice that our TEAM consistently out-
performs our baseline with a large margin, but the perfor-
mance improvement from TEAM decreases slightly, which
further veriﬁes the above analysis about transductive infer-
ence.

4.4. Ablation Study

Effectiveness of Different Modules. According to the pre-
vious analysis, the proposed TEAM framework is far supe-
rior to our baseline and becomes the new state-of-the-art ap-
proach in few-shot classiﬁcation literature. As a necessary
step to the ablation study, we ﬁrst analyze how much each
module (TIM, EAM and Bi-Sim) contributes to the ultimate
performance. All results are shown in Table 4 in great de-
tails. Note that our baseline (ProtoNet) uses the ConvNet as

Table 4. Few-shot classiﬁcation performance for ablation study.
the baseline. TEAM‡: baseline+TIM. TEAM†:
Proto (Ours):
baseline+TIM+EAM. TEAM: baseline+TIM+EAM+Bi-SIM.

Model

miniImageNet

Cifar-100

CUB

1-shot

5-shot

1-shot

5-shot

1-shot

5-shot

Proto [35]
Proto (Ours)
TEAM‡
TEAM†
TEAM

49.42
51.68
52.97
55.35
56.57

68.20
68.71
70.45
71.59
72.04

56.66
57.83
59.56
62.76
64.07

76.29
76.40
77.65
78.80
79.05

58.43
69.39
70.27
75.06
75.71

75.22
82.78
84.68
86.06
86.04

Table 5. semi-Supervised comparison on miniImageNet

Methods

5-way 1-shot

5-way 5-shot

Soft k-Means [25]
Soft k-Means+Cluster [25]
Masked Soft k-Means [25]
TPN-semi [18]
TEAM-semi (Ours)

50.09 ± 0.45
49.03 ± 0.24
50.41 ± 0.31
52.78 ± 0.27
54.81 ± 0.59

64.59 ± 0.28
63.08 ± 0.18
64.39 ± 0.24
66.42 ± 0.21
68.92 ± 0.38

backbone network and achieves higher performance on all
three datasets (see the second row in Table 4) than previous
performance because of the pre-train weights initialization.
Furthermore, we perform various setting of TEAM frame-
work as follows. 1) TEAM‡ adds the TIM strategy into our
baseline, 2) TEAM† utilizes the TIM strategy and episodic-
wise adaptive metric (EAM) simultaneously and 3) TEAM
combines all three modules together to get the ultimate per-
formance. By comparing the second and third rows in Table
4, we observe that the TIM strategy can consistently im-
prove the performance of all few-shot tasks. Then we fur-
ther compare the TEAM‡ and TEAM†, where the only dif-
ference between them is whether using EAM module. Tak-
ing 1-shot task of miniImageNet as an example, TEAM† is
2.38% higher than TEAM‡, which demonstrates that it is
feasible to construct an episodic-wise adaptive metric for
each task in few-shot learning. And the last row of Table 4
further shows the effectiveness of our entire framework.
Comparison with semi-Supervised Few-shot Learning.
From the perspective of unlabeled data, transductive in-
ference is a special case of semi-supervised learning, that
is, the former one directly uses test set as unlabeled data
and the latter uses more auxiliary unlabeled data. As such,
we propose a semi-supervised version of the TEAM frame-
work, namely TEAM-semi, to compare it with other semi-
supervised few-shot approaches. Speciﬁcally, following the
labeled/unlabeled data split in [25], we use 40% and 60% in
each class as labeled and unlabeled data respectively. Note
that the support/query examples in each task are both ran-
domly sampled from the labeled set only for fair compar-
ison. All results, which are averaged over 10 random la-
beled/unlabeled partition of the training set, are reported in
Table 5 in details. Compared with the previous state-of-the-
art approaches TPN [18], our TEAM-semi framework in-
creases by 2.03% and 2.50% for 1-shot/5-shot respectively,

Figure 3. This ﬁgure illustrates the sparsity nature of the metric in
few-shot learning. Left: The heatmap of the oracle metric (Please
zoom in it for more details). Right: The values distribution in
different position of the matrix (sorted by descending order).

Table 6. 5-way performance with various training/testing shots.

Methods

1-shot

3-shot

5-shot

7-shot

9-shot

Baseline (Ours)
TEAM (Ours)

Accuracy (+)

51.68
56.57

4.89

63.87
67.64

3.77

68.71
72.04

3.33

71.28
73.47

2.19

73.35
75.04

1.69

which veriﬁes its ability to handle both supervised and semi-
supervised few-shot classiﬁcation.
Sparsity Nature of Episodic-wise Adaptive Metric.
In
this section we explore the sparsity nature of the episodic-
wise adaptive metric in few-shot learning. Take a 5-way
5-shot task as an example, we set 15-queries in each class
and exploit the classic LMNN algorithm [37] with all sup-
port and query samples to optimize an oracle metric, which
ensures all examples in this task can be completely distin-
guished. Then we scale all elements of the metric into the
region [0, 1] and visualize its heatmap in Fig. 3 (left). We
observe that diagonal elements always maintain larger val-
ues (close to red) than off-diagonal elements (close to blue).
After reorganizing all values with numerical descending or-
der in Fig. 3 (right), we further notice that there is a large
value gap between the diagonal elements and off-diagonal
elements. These practical observations indicate that, due
to the low-data setup, we cannot have enough prior to ﬁnd
accurate correlations between all dimensions, except strong
self-correlation in diagonal, which leads to the sparsity na-
ture of episodic-wise adaptive metric. Moreover, from this
practical viewpoint, we further verify that it is reasonable to
set the identity matrix as prior metric M0 in Eq. (12).

5. Conclusions

We have proposed Transductive Episodic-wise Adaptive
Metric (TEAM) for few-shot learning, which is a simple
and efﬁcient framework based on meta-learning. It not only
learns a shared embedding model across all tasks end-to-
end but also further tailors an episodic-wise metric by tak-
ing more distinctive information within each task into ac-
count. Moreover, with using the entire query set at once for
inference, we leverage a bi-directional similarity strategy
for extracting more robust relationship between queries and

prototypes. Our TEAM achieves the state-of-the-art per-
formance on three few-shot benchmark datasets and is eas-
ily extended to semi-supervised version. The extensions of
TEAM on other few-shot approaches could be future work.

Acknowledgement. This work is partially supported by
grants from the National Key R&D Program of China
under grant 2017YFB1002400, the National Natural Sci-
ence Foundation of China under contract No.U1611461,
No.61825101 and No.61672072, also supported by grants
from NVIDIA and the NVIDIA DGX-1 AI Supercomputer,
and Beijing Nova Program (Z181100006218063).

References

[1] Aur´elien Bellet, Amaury Habrard, and Marc Sebban. A
survey on metric learning for feature vectors and structured
data. arXiv:1306.6709, 2013.

[2] Stephen Boyd and Lieven Vandenberghe. Convex optimiza-

tion. Cambridge university press, 2004.

[3] Olivier Chapelle, Jason Weston, L´eon Bottou, and Vladimir
Vapnik. Vicinal risk minimization. In NIPS, pages 416–422,
2001.

[4] Zitian Chen, Yanwei Fu, Yinda Zhang, Yu-Gang Jiang, Xi-
angyang Xue, and Leonid Sigal. Semantic feature augmen-
tation in few-shot learning. arXiv:1804.05298, 2018.

[5] Chelsea Finn, Pieter Abbeel, and Sergey Levine. Model-
agnostic meta-learning for fast adaptation of deep networks.
In ICML, 2017.

[6] Victor Garcia and Joan Bruna. Few-shot learning with graph

neural networks. In ICLR, 2017.

[7] Bharath Hariharan and Ross B Girshick. Low-shot vi-
sual recognition by shrinking and hallucinating features. In
ICCV, pages 3037–3046, 2017.

[8] Kaiming He, Xiangyu Zhang, Shaoqing Ren, and Jian Sun.
In CVPR,

Deep residual learning for image recognition.
pages 770–778, 2016.

[9] Nathan Hilliard, Lawrence Phillips, Scott Howland, Art¨em
Yankov, Courtney D Corley, and Nathan O Hodas. Few-
shot learning with metric-agnostic conditional embeddings.
arXiv:1802.04376, 2018.

[10] Hiroshi Inoue. Data augmentation by pairing samples for

images classiﬁcation. arXiv:1801.02929, 2018.

[11] Sergey Ioffe and Christian Szegedy. Batch normalization:
Accelerating deep network training by reducing internal co-
variate shift. In ICML, 2015.

[12] Thorsten Joachims. Transductive inference for text classiﬁ-
cation using support vector machines. In ICML, volume 99,
pages 200–209, 1999.

[16] Yoonho Lee and Seungjin Choi. Gradient-based meta-
learning with learned layerwise metric and subspace.
In
ICML, 2018.

[17] Zhenguo Li, Fengwei Zhou, Fei Chen, and Hang Li. Meta-
learning.

sgd: Learning to learn quickly for few shot
arXiv:1707.09835, 2017.

[18] Yanbin Liu, Juho Lee, Minseop Park, Saehoon Kim, Eunho
Yang, Sung Ju Hwang, and Yi Yang. Learning to propagate
labels: Transductive propagation network for few-shot learn-
ing. In ICLR, 2018.

[19] Tsendsuren Munkhdalai and Hong Yu. Meta networks. In

ICML, 2017.

[20] Tsendsuren Munkhdalai, Xingdi Yuan, Soroush Mehri, and
Adam Trischler. Rapid adaptation with conditionally shifted
neurons. In ICML, pages 3661–3670, 2018.

[21] Alex Nichol, Joshua Achiam, and John Schulman. On ﬁrst-
order meta-learning algorithms. CoRR, abs/1803.02999, 2,
2018.

[22] Boris Oreshkin, Pau Rodr´ıguez L´opez, and Alexandre La-
coste. Tadam: Task dependent adaptive metric for improved
few-shot learning. In NIPS, pages 719–729, 2018.

[23] Siyuan Qiao, Chenxi Liu, Wei Shen, and Alan Yuille. Few-
shot image recognition by predicting parameters from acti-
vations. In CVPR, volume 2, 2017.

[24] Sachin Ravi and Hugo Larochelle. Optimization as a model

for few-shot learning. ICLR, 2016.

[25] Mengye Ren, Eleni Triantaﬁllou, Sachin Ravi, Jake Snell,
Kevin Swersky, Joshua B Tenenbaum, Hugo Larochelle, and
Richard S Zemel. Meta-learning for semi-supervised few-
shot classiﬁcation. In ICLR, 2018.

[26] Andrei A Rusu, Dushyant Rao, Jakub Sygnowski, Oriol
Vinyals, Razvan Pascanu, Simon Osindero, and Raia Had-
sell. Meta-learning with latent embedding optimization. In
ICLR, 2019.

[27] Adam Santoro, Sergey Bartunov, Matthew Botvinick, Daan
Wierstra, and Timothy Lillicrap. Meta-learning with
memory-augmented neural networks. In ICML, pages 1842–
1850, 2016.

[28] Karen Simonyan and Andrew Zisserman. Very deep convo-
lutional networks for large-scale image recognition. In ICLR,
2015.

[29] Jake Snell, Kevin Swersky, and Richard Zemel. Prototypical
networks for few-shot learning. In NIPS, pages 4077–4087,
2017.

[30] Jos F Sturm. Using sedumi 1.02, a matlab toolbox for opti-
mization over symmetric cones. Optimization methods and
software, 11(1-4):625–653, 1999.
[31] Sebastian Thrun and Lorien Pratt.

Learning to learn.

Springer Science & Business Media, 2012.

[13] Diederik P Kingma and Jimmy Ba. Adam: A method for

[32] Lorenzo Torresani and Kuang-chih Lee. Large margin com-

stochastic optimization. In ICLR, 2015.

ponent analysis. In NIPS, pages 1385–1392, 2007.

[14] Alex Krizhevsky and Geoffrey Hinton. Learning multiple
layers of features from tiny images. Technical report, Uni-
versity of Toronto, 2009.

[15] Alex Krizhevsky, Ilya Sutskever, and Geoffrey E Hinton.
Imagenet classiﬁcation with deep convolutional neural net-
works. In NIPS, pages 1097–1105, 2012.

[33] Eleni Triantaﬁllou, Richard Zemel, and Raquel Urtasun.
Few-shot learning through an information retrieval lens. In
NIPS, pages 2255–2265, 2017.

[34] Vladimir N Vapnik. An overview of statistical learning the-
ory. IEEE transactions on neural networks, 10(5):988–999,
1999.

[35] Oriol Vinyals, Charles Blundell, Tim Lillicrap, Daan Wier-
stra, et al. Matching networks for one shot learning. In NIPS,
pages 3630–3638, 2016.

[36] Catherine Wah, Steve Branson, Peter Welinder, Pietro Per-
ona, and Serge Belongie. The caltech-ucsd birds-200-2011
dataset. Technical Report CNS-TR-2011-001, 2011.

[37] Kilian Q Weinberger, John Blitzer, and Lawrence K Saul.
Distance metric learning for large margin nearest neighbor
classiﬁcation. In NIPS, pages 1473–1480, 2006.

[38] Flood Sung Yongxin Yang, Li Zhang, Tao Xiang, Philip HS
Torr, and Timothy M Hospedales. Learning to compare: Re-
lation network for few-shot learning. In CVPR, 2018.
[39] Hongyi Zhang, Moustapha Cisse, Yann N Dauphin, and
David Lopez-Paz. mixup: Beyond empirical risk minimiza-
tion. In ICLR, 2018.
[40] Fengwei Zhou, Bin Wu,

Deep
meta-learning: Learning to learn in the concept space.
arXiv:1802.03596, 2018.

and Zhenguo Li.

