Combining SchNet and SHARC: The
SchNarc machine learning approach for
excited-state dynamics

Julia Westermayr,1 Michael Gastegger,2 and Philipp
Marquetand1,3

1University of Vienna, Institute of Theoretical Chemistry, Währinger Str. 17, 1090 Vienna,
Austria
2Machine Learning Group, Technical University of Berlin, 10587 Berlin, Germany
3Vienna Research Platform on Accelerating Photoreaction Discovery, University of Vienna,
Währinger Str. 17, 1090 Vienna, Austria.
E-mail: philipp.marquetand@univie.ac.at; michael.gastegger@tu-berlin.de

In recent years, deep learning has become a part of our everyday life
and is revolutionizing quantum chemistry as well. In this work, we show
how deep learning can be used to advance the research ﬁeld of photochem-
istry by learning all important properties for photodynamics simulations.
The properties are multiple energies, forces, nonadiabatic couplings and
spin-orbit couplings. The nonadiabatic couplings are learned in a phase-
free manner as derivatives of a virtually constructed property by the deep
learning model, which guarantees rotational covariance. Additionally, an
approximation for nonadiabatic couplings is introduced, based on the po-
tentials, their gradients and Hessians. As deep-learning method, we em-
ploy SchNet extended for multiple electronic states. In combination with
the molecular dynamics program SHARC, our approach termed SchNarc is
tested on a model system and two realistic polyatomic molecules and paves
the way towards eﬃcient photodynamics simulations of complex systems.

1

0
2
0
2

b
e
F
7
1

]
h
p
-
m
e
h
c
.
s
c
i
s
y
h
p
[

1
v
4
6
2
7
0
.
2
0
0
2
:
v
i
X
r
a

 
 
 
 
 
 
Excited-state dynamics simulations are powerful tools to predict, understand and
explain photo-induced processes, especially in combination with experimental studies.
Examples of photo-induced processes range from photosynthesis, DNA photodamage
as the starting point of skin cancer, to processes that enable our vision [1–5]. As they
are part of our everyday lives, their understanding can help to unravel fundamental
processes of nature and to advance several research ﬁelds, such as photovoltaics [6, 7],
photocatalysis [8] or photosensitive drug design [9].

Since the full quantum mechanical treatment of molecules remains challenging, exact
quantum dynamics simulations are limited to systems containing only a couple of
atoms, even if ﬁtted potential energy surfaces (PESs) are used [10–16, 16–26]. In order
to treat larger systems in full dimensions, i.e., systems with up to 100s of atoms, and
on long time scales, i.e., in the range of several 100 picoseconds, excited-state machine
learning (ML) molecular dynamics (MD), where the ML model is trained on quantum
chemistry data, has evolved as a promising tool in the last couple of years [27–33].

Such nonadiabatic MLMD simulations are in many senses analog to excited-state ab
initio molecular dynamics simulations. The only diﬀerence is that the costly electronic
structure calculations are mostly replaced by a ML model, providing quantum prop-
erties like the PESs and the corresponding forces. The nuclei are assumed to move
classically on those PESs. This mixed quantum-classical dynamics approach allows for
a very fast on-the-ﬂy evaluation of the necessary properties at the geometries visited
during the dynamics simulations.

In order to account for nonadiabatic eﬀects, i.e., transitions from one state to an-
other, further approximations have to be introduced [34]. One method, which is fre-
quently used to account for such transitions, is the surface-hopping method originally
developed by Tully [35]. A popular extension for this method including not only nona-
diabatic couplings (NACs) but also other couplings, e.g., spin-orbit couplings (SOCs),
is the SHARC (surface hopping including arbitrary couplings) approach [36–38]. Im-
portantly, NACs, also called derivative couplings, are used to determine the hopping
directions and probabilities between states of same spin multiplicity [36, 37, 39–41].
The NAC vector (denoted as C NAC) between two states, i and j, can be computed
as [39, 42, 43]

C NAC

ij ≈ (cid:104)Ψi |

∂
∂R

Ψj(cid:105) =

1
Ei − Ej

(cid:104)Ψi |

∂Hel
∂R

| Ψj(cid:105)

for i (cid:54)= j,

(1)

where the second-order derivatives are neglected. As a further diﬃculty, NACs are
often missing from quantum chemistry implementations and are thus often approxi-
mated [44–52]. SOCs (denoted as C SOC) are present between states of diﬀerent spin
multiplicity,

ij = (cid:104)Ψi | ˆH SO | Ψj(cid:105)
C SOC
and determine the rate of intersystem crossing. They are obtained as oﬀ-diagonal
elements of the Hamiltonian matrix in standard electronic-structure calculations [37,
53].

(2)

Most of the recent studies involving ML dynamics deal with ground-state MD
simulations, see e.g. Refs. [54–78], where one of the most promising ML models is
SchNet [79, 80], a deep continuous-ﬁlter convolutional-layer neural network.

2

Only a small but quickly increasing number of studies deal with the treatment of
excited states and their properties using ML [15, 16, 16–28, 31, 33, 81]. An arising
diﬃculty compared to ground state energies and properties is that not only one, but
several PESs as well as the couplings between them have to be taken into account.
Additionally, the learning of couplings proves challenging due to the fact that proper-
ties resulting from electronic wave functions of two diﬀerent states, Ψi and Ψj, have
their sign dependent on the phase of the wave functions [32, 33, 82, 83]. Since the
wave function phase is not uniquely deﬁned in quantum chemistry calculations, ran-
dom phase jumps occur, leading to sign jumps of the coupling values along a reaction
path. Hence, the couplings can not be learned directly as obtained from a quantum
chemistry calculation. An option is to use a phase correction algorithm to pre-process
data and remove these random phase jumps. Assuming that the eﬀect of the Berry
phase remains minor on the training set, smooth properties are obtained that are
learnable by ML models [32]. However, this approach is expensive and many quantum
chemistry reference computations are necessary to generate the training set. In cases
of large poly-atomic molecules with many close lying energetic states, this approach
might even be infeasible.

The aim of this letter is to provide a framework to carry out eﬃcient excited-state
MLMD simulations and to combine two popular methods for this purpose: the SHARC
approach for photodynamics with states of diﬀerent multiplicity and SchNet to eﬃ-
ciently and accurately ﬁt potential energies and other molecular properties. We call
this combination the SchNarc approach and adapted SchNet for the treatment of
excited state potentials, their forces and couplings for this purpose. The SchNarc ap-
proach can overcome the current limitations of existing MLMD simulations for excited
states by allowing (i) a phase-free training to omit the costly pre-processing of raw
quantum chemistry data and, to treat (ii) rotationally covariant NACs, which can ei-
ther be trained, or (iii) alternatively be approximated from only ML potentials, their
gradients, and Hessians, and to treat (iv) SOCs.

To validate the phase-free training, a new loss function termed phase-less loss func-
tion is developed and tested for the methylenimmonium cation, CH2NH+
2 , of which
we take a phase corrected training set from Ref. [32]. Using the same level of theory
(MR-CISD(6,4)/aug-cc-pVDZ) with the program COLUMBUS [84], the training set
is recomputed without applying phase correction to train ML models also on raw data
obtained directly from quantum chemistry programs. The ML models are trained on
energies, gradients, and NACs for three singlet states using 3,000 data points. This
molecular system features singlet-only dynamics and ultrafast transitions.

The phase-less loss is based on the standard L2 loss, but here, the squared error
of the predicted properties is computed 2NS −1-times with NS being the total number
states. The value of each property, LP (i.e. LSOC and LN AC), that enters the loss
function is the minimum function of all possible squared errors εk
P :

LP = min (cid:0){εk

P }(cid:1) with 0 ≤ k ≤ 2NS −1

(3)

3

with

εk
P =

(cid:40) 1
N 2
S
1
N 2
S

(cid:80)NS
i
(cid:80)NS
i

(cid:80)NA

(cid:80)NS
j(cid:54)=i
(cid:80)NS

1
NA
j(cid:54)=i || P QC

m || P QC
ij − P M L

ij,m · pk
ij,m − P M L
j ||2
i · pk

· pk

ij

i · pk

j ||2

if dim(P) ≥ 3

if dim(P) ≤ 2

(cid:41)

(4)

for vectorial and non-vectorial properties, respectively. The error εk
P for a speciﬁc
phase is computed as the mean squared error of a property P from quantum chemistry
(index QC) and machine learning (index M L). The property P couples diﬀerent states,
indicated by i and j. Since the wave function of each of the states can have an arbitrary
phase, the property Pij that couples state i and j has to be multiplied with a product
of the phases for these states, pi · pj. The phases for all states together form a vector
p with entries of either +1 and -1. Which of the 2NS −1 possible combinations for p is
chosen, is indicated by the index k, also deﬁned in eq. (3). The relative signs within
one vector remain and must be predicted correctly for successful training.

The overall loss function used in this work is a combination of such phase-less loss
functions and mean squared errors obtained for all properties with a trade-oﬀ factor to
account for their relative magnitude (a detailed description of the implementation is
given in the SI). This loss function removes the inﬂuence of the arbitrary phase during
the learning process of a ML model and further reduces the computational costs for
the training set generation.

Results are given in Figure 1, which shows the population schemes of CH2NH+
2
obtained after excitation to the second excited singlet state, S2. The SchNarc models
are all trained on energies, forces, and NACs for the three considered singlet states.
The populations obtained from SchNarc models (panels A and C) trained on a data set
that is not phase corrected, i.e. it contains couplings that can randomly switch their
sign, are compared to populations obtained from models trained on phase corrected
data (panels B and D). As can be seen, the L2 loss function, as used in the upper
plots, leads to an accurate ML model to reproduce ultrafast transitions only in the
case of phase corrected data (panel C), whereas this loss can not be used when trained
on raw quantum chemistry data (panel A). In comparison, a SchNarc simulation with
a ML model that applies the phase-less loss function is successful in reproducing the
populations for both training sets.

ij

= C NAC
ij

In those simulations, the NACs are multiplied with the corresponding energy gaps,
i.e., (cid:101)C NAC
· ∆Eij, to get rid of singularities [21, 33]. These smooth cou-
ij
plings (cid:101)C NAC
are not directly learned, but rather constructed as the derivative of a vir-
tual property, analogously to forces that are predicted as derivatives of an energy-ML
model. The virtual property is the multi-dimensional anti-derivative of the rightmost
expression in equation (1), (cid:104)Ψi | ∂Hel
R | Ψj(cid:105) (a derivation is given in the SI). Com-
pared to previous ML models for NACs [29, 30, 32, 33], where NACs are learned and
predicted as direct outputs or even single values, this approach provides rotational
and translational covariance, which has recently been achieved in a similar way for the
electronic friction tensor [85].

However, even without the need of pre-processing the training set, the costly com-
putations of NAC vectors for the training set generation remain. Approximations

4

Figure 1: Populations obtained from 90 QC (MR-CISD(6,4)/aug-cc-pVDZ) trajecto-
ries are shown by continuous lines and are compared to (A) populations
resulting from 1000 initially excited trajectories obtained from SchNet (dot-
ted lines) that is trained on not phase corrected data and takes the L2 norm
as loss function, (B) a similar SchNet model, but trained on phase corrected
data, (C) a SchNet model trained on not phase corrected data, but using
the new phase-less loss function, and (D) a SchNet model trained on phase
corrected data using the new phase-less loss function .

5

of NACs exist and often involve the computation of the squared energy-gap Hes-
sian [11, 86–90]. Their use in dynamics simulations is rather impracticable with quan-
tum chemistry methods, especially in the case of complex systems, due to the expenses
of computing second-order derivatives.

Here, we take advantage of the eﬃciency for second-order derivative computation
from ML models with respect to atomic coordinates to obtain the Hessians of the ﬁtted
PESs:

∂2(∆Eij)2
∂R2

=

1
2

(cid:32)

∆Eij ·

∂2∆Eij
∂R2 +

(cid:18) ∂∆Eij
∂R

(cid:19)2(cid:33)

(5)

with R being the atomic coordinates of a molecular system. Note that Hessians are
also employed in quantum dynamics simulations [91, 92], which might open further
applications for our implementation.

The squared energy-gap Hessian can be further obtained as the sum of two symmetric
dyads, that deﬁne the branching space [90]. Hence, this Hessian can be employed to
obtain the symmetric dyad of the smooth NACs via [11, 93]:

∂2(∆Eij)2

(cid:101)C NAC

ij ⊗ (cid:101)C NAC

ij ≈

2∂R2 −
After singular value decomposition, the hopping direction can be computed as the
eigenvector, vij, of the largest non-zero eigenvalue [90, 93, 94] with the corresponding
eigenvalue, λij, as the squared magnitude of the ML smooth coupling, (cid:101)C NAC
. The
ﬁnal approximated NAC vectors, C aNAC

, between two states are then:

(6)

⊗

ij

.

∂∆Eij
∂R

∂∆Eij
∂R

ij

C aNAC
ij

= vij ·

(cid:112)λij
∆Eij

.

(7)

The approximated NAC vectors can be employed in the vicinity of a conical in-
tersection, otherwise the output becomes too noisy. For the latter reason, we de-
ﬁne thresholds of 0.5 eV and 1.0 eV for the energy gaps to compute approximated
NACs between coupled singlet-singlet states and triplet-triplet states, respectively. It
is worth mentioning that the ML models slightly overestimate the energy gaps [32],
since, in contrast to quantum chemistry PESs, the ML PESs are smooth everywhere.
In Ref. [94], approximated NACs were applied for a 1D system and their usefulness in
combination with ML was already anticipated.

We turn this idea into reality and show ML excited-state dynamics with approxi-
mated NACs for a linear vibronic coupling (LVC) model [10, 95] of sulfur dioxide, SO2,
which we use as a reference system to assess the quality of approximated NACs and
also include triplet states to treat SOCs. The LVC model of sulfur dioxide, SO2,[95]
contains 3 singlet states and 3 triplet states, with symmetry allowed NACs between
the ﬁrst and second excited singlet states as well as the ﬁrst and third triplet states,
and is used to train two ML models: One, where the NACs are learned and another,
where the NACs are approximated according to equation (7). The ML models for

6

dynamics simulations with approximated (trained) NACs are built up from energies,
gradients, and SOCs (plus NACs) using 5,000 (20,000 for singlet only or 200,000 for
singlet and triplet states) randomly selected data points from training sets consisting
of 280,200 data points.

In addition, we also apply the NAC approximation to two systems, where the data is
obtained directly with ab initio methods: the methylenimmonium cation, CH2NH+
2 , as
presented before, and thioformaldehyde, CSH2. CSH2, is used, because it shows slow
population transfer [96], in contrast to the fast population transfer in CH2NH+
2 . The
training set is built up of 4,703 data points with two singlet states and two triplet states
after initial sampling of normal modes and adaptive sampling with simple multi-layer
feed-forward neural networks as done in Ref. [32] for CH2NH+
2 . The program MOL-
PRO [97] is used for these calculations with CASSCF(6,5)/def2-SVP. The dynamics
simulations are carried out after excitation to the ﬁrst excited singlet state for 3000
fs. A detailed analysis on the reference computations as well as information on the
timing of the Hessian evaluation is given in the SI in sections S2 and S3.1 respectively.
None of the data points from the ab initio MD simulations, to which we compare our
SchNarc models, are included in the training sets and, thus, the dynamics simulations
can be seen as a direct test.

Results for the LVC model are depicted in Fig. 2. The potential energy curves along
the asymmetric stretching mode of the singlet states (left plot) and the triplet states
(right plot) are shown along with the norm of the respective NAC vectors. As can
be seen, the shape as well as the height of the peak of the norm of trained NACs
(dashed lines) and approximated NACs (dotted lines) are comparable to those of the
LVC model (continuous lines). The approximated NACs approach zero faster than
the trained NACs, which is due to the applied threshold that is set for the energy gap
to compute NACs. Noticeably, the learned NACs between the triplet states show a
decrease, when the corresponding triplet energies are close to each other. This might
be an eﬀect due to the Berry phase, that can not be captured with our approach
leading to artifacts in some regions.

Importantly, the NACs can be predicted accurately with ML in most of the regions
around the conical intersections. We ﬁrst consider a singlet-only model in order to
support this assumption with dynamics simulations, see Fig. 3. LVC populations show
minor population transfer between the second excited singlet state and the ﬁrst excited
singlet state, which can be reproduced with both SchNarc models (upper panels).

Also when including triplet states, the SchNarc models can reproduce the dynamics
(lower panels). Here, population is mostly transferred from the ﬁrst excited singlet
state to the triplet states. Note that populations in surface hopping are often only
accurate to within 10%, such that we judge the deviations of the ML populations from
the LVC reference as small (see Ref. 33 for examples, where dynamics is not reproduced
by ML although potentials seemingly are).

The application of the NAC approximation is further tested on more realistic sys-
tems with properties obtained from quantum chemistry data including fast as well as
slow population transfer. CH2NH+
2 serves as a testsystem for the former case, where
ultrafast transitions from the second excited singlet state back to the ground state take
place after excitation within 100 femtoseconds [32, 98], which is only possible to repro-

7

Figure 2: Potential energy curves and the norm of the NAC vectors between singlet
states (A) and triplet states (B) along the asymmetric stretching mode of
SO2. Continuous line represent LVC(MR-CISD) and dotted (dashed) lines
show results obtained from SchNarc models trained on only energies and
gradients (as well as NACs for comparison) of 3 singlets and 3 triplet states.

Figure 3: Quantum populations using LVC(MR-CISD) (left panels), SchNarc trained
on NACs (middle panels) and SchNarc using approximated NACs from en-
ergies and gradients (right panels). Dynamics are shown of 1000 initially
excited conﬁgurations considering only singlet states (upper line) and addi-
tionally triplet states (lower line).

8

Figure 4: Quantum populations of the methylenimmonium cation obtained from (A)
90 trajectories using MR-CISD/aug-cc-pVDZ (QC) and (B) 1000 trajectories
using SchNarc (ML) as well as populations up to 3,000 fs of the thioformalde-
hyde molecule obtained from (C) 100 trajectories using CASSCF(6,5)/def2-
SVP (QC) and (D) 9590 trajectories using SchNarc (ML).

duce with accurate NACs [33]. In contrast, the CSH2 molecule serves as a testsystem
for slow populations transfer and shows intersystem crossing strongly dependent on
the accuracy of the underlying potentials [96]. Inaccurate ML models would thus be
unable to reproduce the reference dynamics.

The populations of both systems are given in Fig. 4. The reference populations (left
panels) are compared to SchNarc simulations with ML models trained on energies and
gradients (panel B) as well as SOCs (panel D) for CH2NH+
2 and CSH2, respectively.
As can be seen, the fast and the slow population transfer can be reproduced accurately,
which proves the validity of our ML approach.

In summary, the SchNarc framework combines the SHARC [37] approach for surface
hopping and the SchNet [80] approach for ML. The training of ML models is facilitated
by using the phase-less loss and the NAC approximation, avoiding quantum chemical
NAC calculations at all. Thus, photodynamics simulations are possible solely based
on ML PESs, their derivatives and SOCs. Furthermore, this method allows for a very
eﬃcient computation of the Hessians of all the excited states at each time step. Hence,
SchNarc allows for eﬃcient nonadiabatic dynamics simulations of excited states and
light-induced processes including internal conversion and intersystem crossing.

9

Acknowledgement

This work was ﬁnancially supported by the AustrianScience Fund, W 1232 (MolTag),
the uni:docs program of the University of Vienna (J.W.), the HPC-Europa3 program
(J.W.), and the European Union Horizon 2020 research and innovation program under
the Marie Sklodowska-Curie grant agreement NO 792572 (M.G.). The computational
results presented have been achieved in part using the Vienna Scientiﬁc Cluster (VSC).
All authors thank Univ.-Prof. Dr. Klaus-Robert Müller for hosting the visit of J.W.
in the frame of HPC-Europa 3. P. M. thanks the University of Vienna for continu-
ous support, also in the frame of the research platform ViRAPID. J.W. and P. M.
are grateful for an NVIDIA Hardware Grant and thank Sebastian Mai for helpful
discussions concerning the phase-free training algorithm.

Data availability

The data sets are partly available [32] and will be partly made available on github.com/schnarc.
The molecular geometries and corresponding properties are saved in a database format
provided by the atomic simulation environment [99].

Code availability

All code developed in this work will be made available on github.com/schnarc.

Supplementary Information

1 SchNet for excited states

As a machine learning (ML) model, the deep continuous-ﬁlter convolutional neural
network SchNet, that is described in detail in Ref. [79, 80] is used and adapted for
excited states to train excited-state energies, forces, spin-orbit couplings (SOCs), and
nonadiabatic couplings (NACs).

The molecular descriptor is constructed by SchNet [79] that treats atoms in their
chemical and structural environment. A cutoﬀ is deﬁned to specify the environment
that is included for the description of an atom. Hence the molecular properties are ob-
tained as atom-wise contributions. A continuous-ﬁlter convolutional layer and several
additional interaction layers deﬁne and optimize the atom representations. These rep-
resentations are mapped to diﬀerent properties via fully connected layers with shifted
softplus activation functions. These prediction blocks, which use a common descriptor
network, are separately designed for energies, SOCs, and NACs, whereas the forces
are derived with respect to atomic coordinates from outputs of the ML model for en-
ergies. The loss function is a combined loss function of all the properties. A trade-oﬀ
is deﬁned to weigh the properties according to their magnitude. The properties that

10

should be learned have to be speciﬁed along with the corresponding trade-oﬀ in an
additional input ﬁle.

1.1 Standard loss function, L2

The overall L2 loss function as implemented in SchNet for excited states, reads:

SOC − CM L

L2 = tE || EQC − EM L ||2 +tF || F QC − F M L ||2 +
tSOC || C QC
NAC ||2,

SOC ||2 +tNAC || C QC
where tE, tF , tSOC, and tN AC deﬁne the trade-oﬀs for the properties E (energies), F
(forces), CSOC (SOCs), and CNAC (NACs), respectively. Corresponding labels with an
index "QC" refer to the reference value and with an index "ML" to the the SchNet
predictions.

NAC − CM L

(8)

1.2 Phase-less loss function, Lph

In order to train on inconsistent SOCs and NACs with respect to their sign, we have
developed a phase-less loss-function. This is based on the L2 loss, but here, the squared
error of the predicted properties, P , is computed more often, i.e. 2NS −1-times with
NS being the total number states. The value, LP , that enters the overall loss function,
Lph, is the minimum function of all possible squared errors, εk
P , for a given property,
P :

LP = min (cid:0){εk

P }(cid:1) with 0 ≤ k ≤ 2NS −1

with

εk
P =

(cid:40) (cid:80)NS
i
(cid:80)NS
i

(cid:80)NS
j(cid:54)=i
(cid:80)NS

1
NA
j(cid:54)=i || P QC

(cid:80)NA
m || P QC
ij − P M L

ij,m · pk
ij,m − P M L
j ||2
i · pk

· pk

ij

i · pk

j ||2

(cid:41)

if dim(P) ≥ 3
if dim(P) ≤ 2

(9)

(10)

for vectorial and non-vectorial properties, respectively. The error εk
P for a speciﬁc
phase is computed as the mean squared error of a property P from quantum chemistry
(index QC) and machine learning (index M L). The property P couples diﬀerent states,
indicated by i and j. Since the wave function of each of the states can have an arbitrary
phase, the property Pij that couples state i and j has to be multiplied with a product
of the phases for these states, pi · pj. The phases for all states together form a vector
p with entries of either +1 and -1. Which of the 2NS −1 possible combinations for p is
chosen, is indicated by the index k, also deﬁned in eq. (9). Since we are free to choose
one of the phases, we set the phase of the ﬁrst state always to +1. The relative signs
within one vector remain and must be predicted correctly for successful training.

The overall loss function used in this work is a combination of such phase-less errors
and mean squared errors obtained for all properties with a trade-oﬀ factor to account
for their relative magnitude (as already speciﬁed in equation 8):

Lph = tE || EQC − EM L ||2 +tF || F QC − F M L ||2 +tSOC · LSOC + tN AC · LN AC (11)

11

This cost function removes the inﬂuence of the arbitrary phase during the learning
process of a ML model and further reduces the computational costs for the training
set generation.

We tested on several alternatives, such as a loss function that additionally includes
the norm of a vector, variations of a minimum function and another type of phase-
free loss function, that can be used if only one type of coupling, i.e. SOCs or NACs,
or dipole moments are trained. This error is also implemented in SchNet for excited
states and the error of a property that couples state i and j, εk
P is computed as follows:

(cid:40)

εk,±
P =

|| P QC
1
NA

ij ± P M L
||2
(cid:80)NA
m || P QC

ij

ij,m ± P M L

ij,m ||2

if dim(P) ≤ 2
if dim(P) ≥ 3

(12)

As can be seen, the error is computed twice – once assuming a correct phase of predicted
properties and once a phase switch, that are both combined subsequently in case
dim(P) ≥ 3:

P = εk,−
ek

p

· C +

ij + εk,+

p

· C −
ij

with

C ±

ij =

εk,±
p
p + εk,+
εk,−

p

.

(13)

(14)

The value, LP , that enters the loss function is then either a combination of both
possibilities for vectorial properties or a minimum function of the two possible errors,
εk,±
P . This variation gives comparably accurate results and also leads to a phase-free
in the case of the SO2 molecule –
training. Experiments have shown, that – e.g.
more data points, but shorter training is necessary. This alternative error can be
more favorable in cases, where only one coupling type is needed and many states are
involved, since computation of all possible combinations can be omitted. All other
tested variations turned out to be less successful in learning the shape of couplings.

1.3 Machine learning models

The model parameters for each molecular system are given in Table 1 including the
number of data points and states trained. The errors for the remaining test set (i.e.
the data points not used for training and validation) are listed as mean absolute values
resulting from all states. For the CH2NH+
2 and CSH2 models, the ML predictions reach
chemical accuracy and in some cases the error is even below 0.043 eV (1 kcal/mol).
If not stated otherwise, 256 features with 3 hidden layers are used for each model.
The batch size ranges from 20 to 50 and is set in order to comply with the maximum
allowed memory of a used GPU. The learning rate is set to 0.0001 and is reduced by
a factor of 0.8 down to a value of 0.000001 with a patience of 15 steps. The maximum
number of epochs is set to 5000. The trade-oﬀ for each property is deﬁned, so that
the mean squared errors in the ﬁrst few epochs is equally large for all properties.

12

Table 1: Parameters for the trained SchNet models for excited states. For SO2, CSH2,
and CH2NH+
2 200-5,000, 200 and 100 data points are used for validation,
respectively, hence at least 50,000, 503, and 900 data points are used for
testing. The MAEs and RMSEs are reported in eV, eV/Å, and a.u.
for
energies, gradients and all type of couplings, respectively. If not mentioned
otherwise, the data sets are not phase corrected.

S/T properties (t)

cutoﬀ Loss

MAE (RMSE)

Molecule

SO2

SO2

training
points
5,000

3/0

20,000

3/0

SO2

5,000

3/3

SO2

20,000

3/3

CH2NH+
2

3,000

3/0

CH2NH+
2

3,000

3/0

CH2NH+
2

CH2NH+
2

CH2NH+
2

3,000
phase
corrected
3,000
phase
corrected
3,000

CSH2

4,000

3/0

3/0

3/0

2/2

[Å]
5.0

L2

8 .0

Lph

5.0

Lph

8.0

Lph

10.0

L2

10.0

Lph

10.0

L2

10.0

Lph

10.0

L2

10.0

Lph

0.069 (0.20)
0.20 (0.67)
0.062 (0.184)
0.24 (0.65)
0.13 (1.15)
0.029 (0.068)
0.12 (0.26)
7.7 · 10−6 (3.1 · 10−5)
0.027 (0.068)
0.11 (0.26)
0.52 (23.8)
1.2 · 10−5 (4.4 · 10−5)
0.059 (0.13)
0.15 (0.30)
0.22 (0.89)
0.059 (0.14)
0.14 (0.32)
0.15 (0.55)
0.042 (0.087)
0.096 (0.22)
0.21 (0.83)
0.050 (0.16)
0.13 (0.32)
0.15 (1.1)
0.048 (0.12)
0.13 (0.30)
4.1 · 10−4 (6.1 · 10−4)
6.2 · 10−4 (1.1 · 10−3)
6.1 · 10−6 (1.6 · 10−5)

E (1.0)
F (0.25)
E (1.0)
F (0.1)
NAC (0.004)
E (1.0)
F (0.25)
SOC (300)
E (1.0)
F (0.25)
NAC (0.0001)
SOC (300)
E (1.0)
F(1.0)
NAC (0.001)
E (1.0)
F(1.0)
NAC (0.004)
E (1.0)
F(1.0)
NAC (0.0001)
E (1.0)
F(1.0)
NAC (0.004)
E (1.0)
F(1.0)
E (1.0)
F(1.0)
SOC (500)

13

2 Training sets and reference computations

2.1 Training set generation

SchNet models for excited states are trained on a linear vibronic coupling model (LVC)
of SO2 [10, 95], the methylenimmonium cation, CH2NH+
2 and thioformaldehyde, CSH2.
The molecular geometries and corresponding properties are saved in a database
format provided by the atomic simulation environment [99]. No data points of the
dynamics simulations to which we compare SchNarc models are included in the training
sets. The phase corrected training set for the methylenimmonium cation, CH2NH+
2 , is
taken from Ref. [32] and consists of 4000 data points. The geometries of this training
set were recomputed with the same level of theory, MR-CISD(6,4)/aug-cc-pVDZ, but
without applying any pre-processing, such as phase correction, in order to provide a
non-phase corrected training set. The program suite COLUMBUS [84] was used for
this purpose, resulting in 3998 converged single point calculations. For the dynamics
simulations with SchNarc, 1000 trajectories (resulting from 20,000 initial conditions
sampled from a Wigner distribution [100]) are propagated for 100 fs using a time step
of 0.5 fs.

The training set for thioformaldehyde, CSH2, is generated in the same way as it
is done in Ref. [32] for CH2NH+
2 . Initial conﬁgurations are sampled via scans of dif-
ferent reaction coordinates, such as normal modes. Additionally, adaptive sampling
for excited states is carried out using two simple multi-layer feed-forward neural net-
works. At a number of 4855 data points, the networks seem to be converged and
dynamics simulations up to 3 ps can be reproduced. The training set consists of 4703
data points, where samples showing a smaller energy gap than 0.01 H between triplet-
triplet states are sorted out due to problematic data points in those regions. Without
these points the NNs converge much better, in about half of the time. The RMSE
of forces is slightly larger, the rest of the errors are comparable. The level of theory
is CASSCF(6,5)/def2-SVP and 2 singlet and 2 triplet states are included. Quantum
chemistry calculations are carried out using Molpro [97].
In addition to energies,
forces, SOCs, and NACs, the permanent and transition dipole moments are included
in the training set. For the dynamics simulations of CSH2, 40,000 initial conditions
are sampled from a Wigner distribution [100] and excited to the ﬁrst excited singlet
state (2.0-2.5 eV). 100 trajectories are propagated with the reference method for 3 ps
with a time step of 0.5 fs. The resulting populations are compared to 959 trajectories
obtained from SchNarc.

For the SO2 molecule, we refer to dynamics simulations with the reference method
to generate the training set, which is based on a "one-shot" LVC model [95]. 10,000
initial conditions are sampled from a Wigner distribution [100] and excited between
0 and 10 eV. Surface hopping molecular dynamics simulations are carried out with
SHARC after excitation of 1200 initially sampled geometries. They are propagated
with NAC vectors for 700 fs with a time step of 0.5 fs. The ﬁrst 200 trajectories
are taken for the training set generation. This procedure is done twice - once only
singlet states are considered and once singlet and triplet states are taken into account,
resulting in 280,200 data points for each training set. The remaining 1000 trajectories

14

serve for comparison to SchNarc dynamics. Due to symmetry, the SO2 model contains
NACs only between the S1 state and the S2 state as well as between the T1 state and
the T3 state. We considered this restriction for the SchNarc computations by setting
the other couplings to zero.

It is worth mentioning that SO2 needs more data points for training than CSH2 and
CH2NH+
2 , since for the latter molecules, adaptive sampling was applied and for SO2
we used data directly from dynamics simulations with the LVC model. The dynamics
with the LVC model are extremely fast and hence for the training set generation the
usual adaptive sampling approach [32, 60, 101] is far more costly and time-intensive.
Since reference computations are even cheaper than ML predictions, it is not our goal
to provide a perfect training set with a minimum number of data points for this model,
but rather to provide an easy-to-use but yet challenging test system to validate our
method.

2.2 Surface hopping molecular dynamics

In order to compute nonadiabatic molecular dynamics simulations, the SHARC [36–
38] method, an extension of Tully’s fewest switches algorithm [35], is applied. This
mixed quantum-classical approach allows for on-the-ﬂy computation of the PESs with
electronic structure methods, on which the nuclei move according to Newton’s second
equation of motion. In order to account for nonadiabatic transitions between states of
same spin multiplicity, instantaneous switches from one state to the others are allowed
in regions of high hopping probability. After every simulation, the trajectories are
analyzed using the SHARC diagnostic tools to check improper behaviour, such as
energy ﬂuctuations. A few reference trajectories are sorted out in each case – mainly
due to improper convergence of quantum chemistry calculations in critical regions of
the potential energy surfaces. Decoherence correction is applied [102] and the hopping
probabilities are computed from SOCs and NACs from electronic structure calculations
in case of reference dynamics or from ML models in case of SchNarc dynamics [38].
The velocities are corrected along the direction of the NAC vectors in each simulation
and for dynamics with quantum chemistry, the phase is tracked along an independent
trajectory.

3 Nonadiabatic couplings

As mentioned in the main text, NACs are either approximated or derived from a
virtual property built by SchNarc.
In order to deﬁne the virtual property, which
SchNarc builds internally, we start by the derivative of the electronic Hamiltonian,
Hel, with respect to the atomic coordinates of a molecule, R:

15

∂Helij (r, R)
∂R

=

∂
∂R

(cid:104)Ψi | Hel(r, R) | Ψj(cid:105)

(15)

= (cid:104)

∂
∂R

Ψi | Hel(r, R) | Ψj(cid:105) + (cid:104)Ψi |

∂Hel(r, R)
∂R

| Ψj(cid:105) + (cid:104)Ψi | Hel(r, R) |

∂
∂R

Ψj(cid:105)

Since the adiabatic wavefunctions are eigenfunctions of Hel(r, R), we can reformulate

equation (15):

= Ej(cid:104)

∂
∂R

Ψi | Ψj(cid:105) + (cid:104)Ψi |

∂Hel(r, R)
∂R

∂Helij (r, R)
∂R
∂
∂R

Ψj(cid:105)

| Ψj(cid:105) + Ei(cid:104)Ψi |

By using the relation, (cid:104)Ψi | ∂

∂R Ψj(cid:105) = −(cid:104) ∂

∂R Ψi | Ψj(cid:105), we can write:

∂Helij (r, R)
∂R

= (Ei − Ej) · (cid:104)Ψi |

∂
∂R

Ψj(cid:105) + (cid:104)Ψi |

∂Hel
∂R

| Ψj(cid:105).

(16)

(17)

Applying the Hellmann-Feynman theorem [103], we obtain the diagonal elements as

the gradients,

∂
∂R

Helij = ∇Eij

f or i = j,

(18)

and obtain the NAC terms as properties that are inversely proportional to the corre-
sponding energy gap of two adiabatic electronic states:

C NAC

ij ≈ (cid:104)Ψi |

∂
∂R

Ψj(cid:105) =

1
Ei − Ej

(cid:104)Ψi |

∂Hel
∂R

| Ψj(cid:105)

for i (cid:54)= j.

(19)

The virtual property that SchNarc is generating is then the multi-dimensional anti-
derivative of the latter expression in equation 19, (cid:104)Ψi | ∂Hel
R | Ψj(cid:105). Noticeably, due
to the Berry phase [12, 104, 105] the NAC vector ﬁeld is not conservative [11] and a
line integral remains path dependent. Hence this approach does not include the eﬀects
of the Berry phase, which is also neglected in approaches such as the Zhu-Nakamura
approximation [51, 52] that does not contain a phase at all, or the phase correction
algorithm [32, 82]. The mixed ML-classical dynamics are thus assumed to be mostly
unaﬀected [32, 82], which might not be the case in quantum dynamics simulations.

3.1 NAC approximation and timing

The approximation of NAC vectors, as explained in the main text and adapted from
Refs. [11, 93, 94], relies on the approximation of the Hessian from energy potentials
It is especially powerful for ML models trained on quantum
between two states.
chemistry methods, where implementations of NAC vectors are largely missing, such

16

as linear-response methods and here especially between the ﬁrst excited state and the
ground state, with the ADC(2) method being a prominent example [106]. Such an ML
approach could further be used to pave the way towards eﬃcient Hessian computations
for all the states treated in quantum dynamics simulations using the variational multi-
conﬁgurational Gaussian method, where the direct Hessian computation often remains
the time limiting step [91, 107].

The used NAC approximation is valid in the vicinity of a conical intersection and
hence relies on a threshold to deﬁne the energy gap, for which the approximation
is applied.
In order to avoid additional computations, the Hessians are thus only
computed if one of the energy diﬀerences between all possible singlet-singlet or triplet-
triplet potentials is within the given threshold (as default we set 0.5 eV and 1.0 eV for
singlet-singlet and triplet-triplet gaps). Since the gaps of the PESs are overestimated
in case of CH2NH+
2 [32], this threshold is increased by 30%. This means, that based
on this pre-deﬁned threshold, SchNarc decides whether NAC vectors are computed
or not. In all other cases, the NAC vectors are set to zero. It is advisable to check
the used thresholds for certain cases and adapt them, where necessary. It is worth
mentioning, that this approach is limited to same-symmetry electronic states, which
are, nevertheless, the most probable avoided state crossings in case of real, polyatomic
systems [94].

Timing

For the thioformaldehyde molecule, the evaluation of the 4 Hessians takes approxi-
mately 2 seconds, for the methylenimmonium cation, the computation of 3 Hessians
takes 3-4 seconds, both on a CPU. A test computation of a 24 atom molecule was
further carried out with SchNarc, which showed that the evaluation of 1 Hessian took
around 45 sec on a CPU, which could be reduced to 14 sec on a GPU. In future work,
we thus seek to adapt the code in order to compute only the relevant Hessians, i.e.,
those of close-lying states with respect to the active state during a dynamics simula-
tion. To this aim, we seek to give the information of the active state to the SchNarc
model, which is not yet implemented for our pySHARC [32, 95] wrapper (python wrap-
per for the SHARC code, which avoids heavy ﬁle I/O). Hence the Hessians would only
be computed for the states that are close enough to the active state and the dynamics
simulations are then still very eﬃcient compared to pure quantum chemistry dynamics
simulations. A comparison of the timings of 100 time steps for a dynamics simulation
with the current SchNarc implementations and SHARC is given in Table 2.

As can be seen, the LVC dynamics using the pySHARC wrapper are very cheap and
only serve as a test system. It is however clearly visible that the training of NACs in
this case needs way more data points and hence it takes longer to train the models.
The dynamics of the CH2NH+
2 molecule using the MR-CISD method are expensive and
ML can substantially decrease the simulation time. It can be seen that the Hessian
computation with ML becomes more expensive, the larger the molecule becomes or
the more states are involved in a simulation.

17

Table 2: Comparison of the timings of 100 steps of a dynamics simulations using
SchNarc with learned and approximated NACs as well as SHARC with quan-
tum chemistry or the LVC model for SO2.

#
States
S/T
3/0
3/3
2/2
3/0

SO2
SO2
CSH2
CH2NH+
2

References

100 time steps [s/CPU] (Training[h/GPU]/data points)
SchNarc
NAC excluded
6 (3.7/5,000 )
17(18.3/5,000 )
8 (12.9/4,000 )
126 (11.1/3,000 )

SchNarc
NAC learned
5 (50.8/20,000 )
13 (308/200,000 )
7 (13.0/4,000 )
12 (19.9/3,000 )

1-2
1-2
52
37,112

SHARC

[1] G. Cerullo, D. Polli, G. Lanzani, S. De Silvestri, H. Hashimoto, R. J. Cogdell,
Photosynthetic Light Harvesting by Carotenoids: Detection of an Intermediate
Excited State, Science, 298, 2395–2398 (2002).

[2] T. Schultz, E. Samoylova, W. Radloﬀ, I. V. Hertel, A. L. Sobolewski, W. Domcke,
Eﬃcient Deactivation of a Model Base Pair via Excited-State Hydrogen Transfer,
Science, 306, 1765–1768 (2004).

[3] W. J. Schreier, T. E. Schrader, F. O. Koller, P. Gilch, C. E. Crespo-Hernández,
V. N. Swaminathan, T. Charell, W. Zinth, B. Kohler, Thymine Dimerization in
DNA Is an Ultrafast Photoreaction, Science, 315, 625–629 (2007).

[4] C. Rauer, J. J. Nogueira, P. Marquetand, L. González, Cyclobutane Thymine
Photodimerization Mechanism Revealed by Nonadiabatic Molecular Dynamics,
J. Am. Chem. Soc., 138, 15911–15916 (2016).

[5] E. Romero, V. I. Novoderezhkin, R. v. Grondelle, Quantum design of photosyn-

thesis for bio-inspired solar-energy conversion, Nature, 543, 355 (2017).

[6] S. Mathew, A. Yella, P. Gao, R. Humphry-Baker, B. F. E. Curchod, N. Ashari-
Astani, I. Tavernelli, U. Rothlisberger, M. K. Nazeeruddin, M. Grätzel, Dye-
sensitized solar cells with 13through the molecular engineering of porphyrin sen-
sitizers, Nat Chem (2014).

[7] A. P. Bartók, S. De, C. Poelking, N. Bernstein, J. R. Kermode, G. Csányi,
M. Ceriotti, Machine learning uniﬁes the modeling of materials and molecules,
Sci. Adv., 3 (2017).

[8] B. Sanchez-Lengeling, A. Aspuru-Guzik, Inverse molecular design using ma-
chine learning: Generative models for matter engineering, Science, 361, 360–365
(2018).

18

[9] I. Ahmad, S. Ahmed, Z. Anwar, M. A. Sheraz, M. Sikorski, Photostability and
Photostabilization of Drugs and Drug Products, Int. J. Photoenergy, 2016, 1–19
(2016).

[10] H. Köppel, W. Domcke, L. S. Cederbaum, Multimode molecular dynamics be-
yond the Born-Oppenheimer approximation, Adv. Chem. Phys., 57, 59–246
(1984).

[11] H. Köppel, J. Gronki, S. Mahapatra, Construction scheme for regularized dia-

batic states, J. Chem. Phys., 115, 2377–2388 (2001).

[12] G. A. Worth, L. S. Cederbaum, Beyond Born-Oppenheimer: Molecular Dynam-
ics Through a Conical Intersection, Ann. Rev. Phys. Chem., 55, 127–158 (2004).

[13] J. M. Bowman, T. Carrington, H. Meyer, Variational quantum approaches for
computing vibrational energies of polyatomic molecules, Mol. Phys., 106, 2145–
2182 (2008).

[14] H.-D. Meyer, F. Gatti, G. A. Worth, Multidimensional Quantum Dynamics,

Wiley-VCH Verlag GmbH & Co. KGaA (2009).

[15] J. P. Alborzpour, D. P. Tew, S. Habershon, Eﬃcient and accurate evaluation of
potential energy matrix elements for quantum dynamics using Gaussian process
regression, J. Chem. Phys., 145, 174112 (2016).

[16] G. W. Richings, S. Habershon, Direct grid-based quantum dynamics on prop-
agated diabatic potential energy surfaces, Chemical Physics Letters, 683, 228
– 233 (2017), ahmed Zewail (1946-2016) Commemoration Issue of Chemical
Physics Letters.

[17] F. Liu, L. Du, D. Zhang, J. Gao, Direct Learning Hidden Excited State In-
teraction Patterns from ab initio Dynamics and Its Implication as Alternative
Molecular Mechanism Models, Sci. Rep., 7, 1–12 (2017).

[18] G. W. Richings, S. Habershon, MCTDH on-the-ﬂy: Eﬃcient grid-based quantum
dynamics without pre-computed potential energy surfaces, J. Chem. Phys., 148,
134116 (2018).

[19] D. M. G. Williams, W. Eisfeld, Neural network diabatization: A new ansatz for
accurate high-dimensional coupled potential energy surfaces, J. Chem. Phys.,
149, 204106 (2018).

[20] C. Xie, X. Zhu, D. R. Yarkony, H. Guo, Permutation invariant polynomial neu-
ral network approach to ﬁtting potential energy surfaces. IV. Coupled diabatic
potential energy matrices, J. Chem. Phys., 149, 144107 (2018).

[21] Y. Guan, D. H. Zhang, H. Guo, D. R. Yarkony, Representation of cou-
pled adiabatic potential energy surfaces using neural network based quasi-
diabatic Hamiltonians: 1,2 2A’ states of LiFH, Phys. Chem. Chem. Phys.,
DOI:10.1039/C8CP06598E (2019).

19

[22] G. W. Richings, C. Robertson, S. Habershon, Improved on-the-Fly MCTDH
Simulations with Many-Body-Potential Tensor Decomposition and Projection
Diabatization, J. Chem. Theory Comput., 15, 857–870 (2019).

[23] I. Polyak, G. W. Richings, S. Habershon, P. J. Knowles, Direct quantum dynam-
ics using variational Gaussian wavepackets and Gaussian process regression, J.
Chem. Phys., 150, 041101 (2019).

[24] Y. Guan, H. Guo, D. R. Yarkony, Neural network based quasi-diabatic Hamil-
tonians with symmetry adaptation and a correct description of conical intersec-
tions, J. Chem. Phys., 150, 214101 (2019).

[25] Y. Wang, C. Xie, H. Guo, D. R. Yarkony, A Quasi-Diabatic Representation of
the 1,21A States of Methylamine, J. Phys. Chem. A, 123, 5231–5241 (2019).

[26] Y. Guan, H. Guo, D. R. Yarkony, Extending the Representation of Multistate
Coupled Potential Energy Surfaces To Include Properties Operators Using Neu-
ral Networks: Application to the 1,21A States of Ammonia, J. Chem. Theory
Comput., 16, 302–313 (2020).

[27] J. Behler, K. Reuter, M. Scheﬄer, Nonadiabatic eﬀects in the dissociation of
oxygen molecules at the Al(111) surface, Phys. Rev. B, 77, 115421 (2008).

[28] C. Carbogno, J. Behler, K. Reuter, A. Groß, Signatures of nonadiabatic O2
dissociation at Al(111): First-principles fewest-switches study, Phys. Rev. B,
81, 035410 (2010).

[29] D. Hu, Y. Xie, X. Li, L. Li, Z. Lan, Inclusion of Machine Learning Kernel Ridge
Regression Potential Energy Surfaces in On-the-Fly Nonadiabatic Molecular Dy-
namics Simulation, J. Phys. Chem. Lett., 9, 2725–2732 (2018).

[30] P. O. Dral, M. Barbatti, W. Thiel, Nonadiabatic Excited-State Dynamics with

Machine Learning, J. Phys. Chem. Lett., 9, 5660–5663 (2018).

[31] W.-K. Chen, X.-Y. Liu, W.-H. Fang, P. O. Dral, G. Cui, Deep Learning for Nona-

diabatic Excited-State Dynamics, J. Phys. Chem. Lett., 9, 6702–6708 (2018).

[32] J. Westermayr, M. Gastegger, M. F. S. J. Menger, S. Mai, L. González, P. Mar-
quetand, Machine learning enables long time scale molecular photodynamics
simulations, Chem. Sci., 10, 8100–8107 (2019).

[33] J. Westermayr, F. A. Faber, A. S. Christensen, O. von Lilienfeld, P. Marque-
tand, Neural networks and kernel ridge regression for excited states dynamics of
CH2NH+
2 : From single-state to multi-state representations and multi-property
machine learning models, arXiv:1912.08484 [physics.chem–ph] (2019).

[34] L. M. Ibele, A. Nicolson, B. F. E. Curchod, Excited-state dynamics of
molecules with classically driven trajectories and Gaussians, Molecular Physics,
DOI:10.1080/00268976.2019.1665199 (2019).

20

[35] J. C. Tully, Molecular Dynamics with Electronic Transitions, J. Chem. Phys.,

93, 1061–1071 (1990).

[36] M. Richter, P. Marquetand, J. González-Vázquez, I. Sola, L. González, SHARC:
Ab Initio Molecular Dynamics with Surface Hopping in the Adiabatic Represen-
tation Including Arbitrary Couplings, J. Chem. Theory Comput., 7, 1253–1258
(2011).

[37] S. Mai, P. Marquetand, L. González, Nonadiabatic Dynamics: The SHARC

Approach, WIREs Comput. Mol. Sci., 8, e1370 (2018).

[38] S. Mai, M. Richter, M. Ruckenbauer, M. Oppel, P. Marquetand, L. González,
SHARC2.0: Surface Hopping Including Arbitrary Couplings – Program Package
for Non-Adiabatic Dynamics, sharc-md.org (2018).

[39] N. L. Doltsinis, Molecular Dynamics Beyond the Born-Oppenheimer Approxi-
mation: Mixed Quantum-Classical Approaches, volume 31 of NIC Series, John
von Neuman Institut for Computing (2006).

[40] J.-K. Ha, I. S. Lee, S. K. Min, Surface Hopping Dynamics beyond Nonadiabatic
Couplings for Quantum Coherence, J. Phys. Chem. Lett., 9, 1097–1104 (2018).

[41] S. Mai, L. González, Molecular Photochemistry: Recent Developments in The-

ory, Angew. Chem. Int. Edit., n/a.

[42] M. Baer, Introduction to the theory of electronic non-adiabatic coupling terms

in molecular systems, Phys. Rep., 358, 75–142 (2002).

[43] H. Lischka, M. Dallos, P. G. Szalay, D. R. Yarkony, R. Shepard, Analytic Eval-
uation of Nonadiabatic Coupling Terms at the MR-CI Level. I. Formalism, J.
Chem. Phys., 120, 7322–7329 (2004).

[44] J. R. Rubbmark, M. M. Kash, M. G. Littman, D. Kleppner, Dynamical eﬀects
at avoided level crossings: A study of the Landau-Zener eﬀect using Rydberg
atoms, Phys. Rev. A, 23, 3107–3117 (1981).

[45] G. A. Hagedorn, Proof of the Landau-Zener formula in an adiabatic limit with
small eigenvalue gaps, Communications in Mathematical Physics, 136, 433–449
(1991).

[46] C. Wittig, The Landau-Zener Formula, J. Phys. Chem. B, 109, 8428–8430

(2005).

[47] L. Zhu, V. Kleiman, X. Li, S. P. Lu, K. Trentelman, R. J. Gordon, Ultrafast
Coherent Control and Destruction of Excitons in Quantum Wells, Phys. Rev.
Lett., 75, 2598–2601 (1995).

[48] C. Zhu, H. Kamisaka, H. Nakamura, Signiﬁcant improvement of the trajectory
surface hopping method by the ZhuâĂŞNakamura theory, J. Chem. Phys., 115,
11036–11039 (2001).

21

[49] C. Zhu, H. Kamisaka, H. Nakamura, New implementation of the trajectory sur-
face hopping method with use of the ZhuâĂŞNakamura theory. II. Application
to the charge transfer processes in the 3D DH2+ system, J. Chem. Phys., 116,
3234–3247 (2002).

[50] A. Kondorskiy, H. Nakamura, Semiclassical theory of electronically nonadia-
batic chemical dynamics: Incorporation of the ZhuâĂŞNakamura theory into the
frozen Gaussian propagation method, J. Chem. Phys., 120, 8937–8954 (2004).

[51] P. Oloyede, G. MilâĂŹnikov, H. Nakamura, Generalized trajectory surface hop-
ping method based on the Zhu-Nakamura theory, J. Chem. Phys., 124, 144110
(2006).

[52] T. Ishida, S. Nanbu, H. Nakamura, Clariﬁcation of nonadiabatic chemical dy-
namics by the Zhu-Nakamura theory of nonadiabatic transition: from tri-atomic
systems to reactions in solutions, Int. Rev. Phys. Chem., 36, 229–285 (2017).

[53] G. Granucci, M. Persico, G. Spighi, Surface hopping trajectory simulations with
spin-orbit and dynamical couplings, J. Chem. Phys., 137, 22A501 (2012).

[54] A. P. Bartók, M. C. Payne, R. Kondor, G. Csányi, Gaussian Approximation
Potentials: The Accuracy of Quantum Mechanics, without the Electrons, Phys.
Rev. Lett., 104, 136403 (2010).

[55] Z. Li, J. R. Kermode, A. De Vita, Molecular Dynamics with On-the-Fly Machine
Learning of Quantum-Mechanical Forces, Phys. Rev. Lett., 114, 096405 (2015).

[56] M. Gastegger, P. Marquetand, High-Dimensional Neural Network Potentials for
Organic Reactions and an Improved Training Algorithm, J. Chem. Theory Com-
put., 11, 2187–2198 (2015).

[57] M. Rupp, Machine learning for quantum mechanics in a nutshell, Int. J. Quan-

tum Chem., 115, 1058–1073 (2015).

[58] J. Behler, Perspective: Machine learning potentials for atomistic simulations, J.

Chem. Phys., 145, 170901 (2016).

[59] M. Gastegger, C. Kauﬀmann, J. Behler, P. Marquetand, Comparing the accu-
racy of high-dimensional neural network potentials and the systematic molecular
fragmentation method: A benchmark study for all-trans alkanes, J. Chem. Phys.,
144, 194110 (2016).

[60] M. Gastegger, J. Behler, P. Marquetand, Machine learning molecular dynamics

for the simulation of infrared spectra, Chem. Sci., 8, 6924–6935 (2017).

[61] V. L. Deringer, G. Csányi, Machine learning based interatomic potential for

amorphous carbon, Phys. Rev. B, 95, 094203 (2017).

[62] V. Botu, R. Batra, J. Chapman, R. Ramprasad, Machine Learning Force Fields:
Construction, Validation, and Outlook, J. Phys. Chem. C, 121, 511–522 (2017).

22

[63] J. S. Smith, O. Isayev, A. E. Roitberg, ANI-1: an extensible neural network
potential with DFT accuracy at force ﬁeld computational cost, Chem. Sci., 8,
3192–3203 (2017).

[64] J. Behler, First Principles Neural Network Potentials for Reactive Simulations of
Large Molecular and Condensed Systems, Angew. Chem. Int. Edit., 56, 12828–
12840 (2017).

[65] H. Zong, G. Pilania, X. Ding, G. J. Ackland, T. Lookman, Developing an inter-
atomic potential for martensitic phase transformations in zirconium by machine
learning, npj Comput Mater, 4 (2018).

[66] A. P. Bartók, J. Kermode, N. Bernstein, G. Csányi, Machine Learning a General-
Purpose Interatomic Potential for Silicon, Phys. Rev. X, 8, 041048 (2018).

[67] S. Chmiela, H. E. Sauceda, K.-R. Müller, A. Tkatchenko, Towards exact molec-
ular dynamics simulations with machine-learned force ﬁelds, Nat. Commun., 9,
3887 (2018).

[68] G. Imbalzano, A. Anelli, D. Giofré, S. Klees, J. Behler, M. Ceriotti, Automatic
selection of atomic ﬁngerprints and reference conﬁgurations for machine-learning
potentials, J. Chem. Phys., 148, 241730 (2018).

[69] L. Zhang, J. Han, H. Wang, W. A. Saidi, R. Car, E. Weinan, End-to-end Sym-
metry Preserving Inter-atomic Potential Energy Model for Finite and Extended
Systems, in: Proceedings of the 32Nd International Conference on Neural Infor-
mation Processing Systems, NIPS’18, 4441–4451, Curran Associates Inc., USA
(2018).

[70] L. Zhang, J. Han, H. Wang, R. Car, W. E, Deep Potential Molecular Dynamics:
A Scalable Model with the Accuracy of Quantum Mechanics, Phys. Rev. Lett.,
120, 143001 (2018).

[71] H. Chan, B. Narayanan, M. J. Cherukara, F. G. Sen, K. Sasikumar, S. K. Gray,
M. K. Y. Chan, S. K. R. S. Sankaranarayanan, Machine Learning Classical
Interatomic Potentials for Molecular Dynamics from First-Principles Training
Data, J. Phys. Chem. C, 123, 6941–6957 (2019).

[72] A. S. Christensen, F. A. Faber, O. A. von Lilienfeld, Operators in quantum
machine learning: Response properties in chemical space, J. Chem. Phys., 150,
064105 (2019).

[73] H. Wang, W. Yang, Toward Building Protein Force Fields by Residue-Based Sys-
tematic Molecular Fragmentation and Neural Network, J. Chem. Theory Com-
put., 15, 1409–1417 (2019).

[74] S. Chmiela, H. E. Sauceda, I. Poltavsky, K.-R. Müller, A. Tkatchenko, sGDML:
Constructing accurate and data eﬃcient molecular force ﬁelds using machine
learning, Comput. Phys. Commun., 240, 38 – 45 (2019).

23

[75] G. Carleo, I. Cirac, K. Cranmer, L. Daudet, M. Schuld, N. Tishby, L. Vogt-
Maranto, L. Zdeborová, Machine learning and the physical sciences (2019).

[76] R. V. Krems, Bayesian machine learning for quantum molecular dynamics, Phys.

Chem. Chem. Phys., 21, 13392–13410 (2019).

[77] V. L. Deringer, M. A. Caro, G. Csányi, Machine Learning Interatomic Poten-
tials as Emerging Tools for Materials Science, Advanced Materials, 31, 1902765
(2019).

[78] K. T. Schütt, M. Gastegger, A. Tkatchenko, K.-R. Müller, R. J. Maurer, Uni-
fying machine learning and quantum chemistry with a deep neural network for
molecular wavefunctions, Nat. Commun., 10, 5024 (2019).

[79] K. T. Schütt, H. E. Sauceda, P.-J. Kindermans, A. Tkatchenko, K.-R. Müller,
SchNet – A deep learning architecture for molecules and materials, J. Chem.
Phys., 148, 241722 (2018).

[80] K. T. Schütt, P. Kessel, M. Gastegger, K. A. Nicoli, A. Tkatchenko, K.-R. Müller,
SchNetPack: A Deep Learning Toolbox For Atomistic Systems, J. Chem. Theory
Comput., 15, 448–455 (2019).

[81] F. Häse, S. Valleau, E. Pyzer-Knapp, A. Aspuru-Guzik, Machine learning exciton

dynamics, Chem. Sci., 7, 5139–5147 (2016).

[82] A. V. Akimov, A Simple Phase Correction Makes a Big Diﬀerence in Nonadia-

batic Molecular Dynamics, J. Phys. Chem. Lett., 9, 6096–6102 (2018).

[83] N. Bellonzi, G. R. Medders, E. Epifanovsky, J. E. Subotnik, Conﬁguration inter-
action singles with spin-orbit coupling: Constructing spin-adiabatic states and
their analytical nuclear gradients, J. Chem. Phys., 150, 014106 (2019).

[84] H. Lischka, R. Shepard, R. M. Pitzer, I. Shavitt, M. Dallos, T. Müller, P. G. Sza-
lay, M. Seth, G. S. Kedziora, S. Yabushita, Z. Zhang, High-Level Multireference
Methods in the Quantum-Chemistry Program System COLUMBUS: Analytic
MR-CISD and MR-AQCC Gradients and MR-AQCC-LRT for Excited States,
GUGA Spin-Orbit CI and Parallel CI Density, Phys. Chem. Chem. Phys., 3,
664–673 (2001).

[85] Y. Zhang, R. J. Maurer, B. Jiang, Symmetry-Adapted High Dimensional Neural
Network Representation of Electronic Friction Tensor of Adsorbates on Metals,
J. Phys. Chem. C, 124, 186–195 (2020).

[86] A. Thiel, H. Köppel, Proposal and numerical test of a simple diabatization

scheme, J. Chem. Phys., 110, 9371–9383 (1999).

[87] H. Köppel, B. Schubert, The concept of regularized diabatic states for a general

conical intersection, Mol. Phys., 104, 1069–1079 (2006).

24

[88] S. Maeda, K. Ohno, K. Morokuma, Updated Branching Plane for Finding Con-
ical Intersections without Coupling Derivative Vectors, J. Chem. Theory Com-
put., 6, 1538–1545 (2010).

[89] J. A. Kammeraad, P. M. Zimmerman, Estimating the Derivative Coupling Vector

Using Gradients, J. Phys. Chem. Lett., 7, 5074–5079 (2016).

[90] B. Gonon, A. Perveaux, F. Gatti, D. Lauvergnat, B. Lasorne, On the applicabil-
ity of a wavefunction-free, energy-based procedure for generating ﬁrst-order non-
adiabatic couplings around conical intersections, J. Chem. Phys., 147, 114114
(2017).

[91] T. J. Frankcombe, Using Hessian update formulae to construct modiﬁed Shepard
interpolated potential energy surfaces: Application to vibrating surface atoms,
J. Chem. Phys., 140, 114108 (2014).

[92] G. Richings, I. Polyak, K. Spinlove, G. Worth, I. Burghardt, B. Lasorne, Quan-
tum dynamics simulations using Gaussian wavepackets: the vMCG method, Int.
Rev. Phys. Chem., 34, 269–308 (2015).

[93] H. An, K. K. Baeck, Practical and reliable approximation of nonadiabatic cou-
pling terms between triplet electronic states using only adiabatic potential ener-
gies, Chem. Phys. Lett., 696, 100 – 105 (2018).

[94] K. K. Baeck, H. An, Practical approximation of the non-adiabatic coupling terms
for same-symmetry interstate crossings by using adiabatic potential energies only,
J. Chem. Phys., 146, 064107 (2017).

[95] F. Plasser, S. GÃşmez, M. F. S. J. Menger, S. Mai, L. González, Highly eﬃcient
surface hopping dynamics using a linear vibronic coupling model, Phys. Chem.
Chem. Phys., 21, 57–69 (2019).

[96] S. Mai, A. J. Atkins, F. Plasser, L. González, The Inﬂuence of the Electronic
Structure Method on Intersystem Crossing Dynamics. The Case of Thioformalde-
hyde, J. Chem. Theory Comput., 15, 3470–3480 (2019).

[97] H.-J. Werner et al., MOLPRO, version 2012.1, A Package of Ab Initio Programs

(2012), see http://www.molpro.net.

[98] M. Barbatti, A. J. A. Aquino, H. Lischka, Ultrafast two-step process in the
non-adiabatic relaxation of the CH2NH2 molecule, Mol. Phys., 104, 1053–1060
(2006).

[99] A. H. Larsen, J. J. Mortensen, J. Blomqvist, I. E. Castelli, R. Christensen,
M. Dułak, J. Friis, M. N. Groves, B. Hammer, C. Hargus, E. D. Hermes, P. C.
Jennings, P. B. Jensen, J. Kermode, J. R. Kitchin, E. L. Kolsbjerg, J. Kubal,
K. Kaasbjerg, S. Lysgaard, J. B. Maronsson, T. Maxson, T. Olsen, L. Pastewka,
A. Peterson, C. Rostgaard, J. Schiøtz, O. Schütt, M. Strange, K. S. Thygesen,
T. Vegge, L. Vilhelmsen, M. Walter, Z. Zeng, K. W. Jacobsen, The atomic

25

simulation environment—a Python library for working with atoms, J. Phys.:
Condens. Matter, 29, 273002 (2017).

[100] E. Wigner, On The Quantum Correction For Thermodynamic Equilibrium,

Phys. Rev., 40, 749–750 (1932).

[101] J. Behler, Constructing high-dimensional neural network potentials: A tutorial

review, Int. J. Quantum Chem., 115, 1032–1050 (2015).

[102] G. Granucci, M. Persico, A. Zoccante, Including quantum decoherence in surface

hopping, J. Chem. Phys., 133, 134111 (2010).

[103] R. P. Feynman, Forces in Molecules, Phys. Rev., 56, 340–343 (1939).

[104] G. Herzberg, H. C. Longuet-Higgins, Intersection of potential energy surfaces in

polyatomic molecules, Discuss. Faraday Soc., 35, 77–82 (1963).

[105] I. G. Ryabinkin, L. Joubert-Doriol, A. F. Izmaylov, Geometric Phase Eﬀects in
Nonadiabatic Dynamics near Conical Intersections, Acc. Chem. Res., 50, 1785–
1793 (2017).

[106] A. Dreuw, M. Wormit, The algebraic diagrammatic construction scheme for the
polarization propagator for the calculation of excited states, WIREs Comput.
Mol. Sci., 5, 82–95 (2015).

[107] G. Richings, I. Polyak, K. Spinlove, G. Worth, I. Burghardt, B. Lasorne, Quan-
tum dynamics simulations using Gaussian wavepackets: the vMCG method, Int.
Rev. Phys. Chem., 34, 269–308 (2015).

26

