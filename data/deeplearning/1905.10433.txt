9
1
0
2

y
a
M
4
2

]

V

I
.
s
s
e
e
[

1
v
3
3
4
0
1
.
5
0
9
1
:
v
i
X
r
a

Three dimensions, two microscopes, one code:
automatic differentiation for x-ray nanotomography
beyond the depth of focus limit

Ming Du1, Youssef S. G. Nashed2, Saugat Kandel3,
Dog˘a G¨ursoy4, and Chris Jacobsen4,5,6,∗
1Department of Materials Science, Northwestern University, Evanston, IL 60208, USA
2Mathematics and Computer Science Division, Argonne National Laboratory, Lemont, Illinois 60439, USA
3Applied Physics Program, Northwestern University, Evanston, IL 60208, USA
4Advanced Photon Source, Argonne National Laboratory, Argonne, IL 60439, USA
5Department of Physics and Astronomy, Northwestern University, Evanston, IL 60208, USA
6Chemistry of Life Processes Institute, Northwestern University, Evanston, IL 60208, USA

∗To whom correspondence should be addressed; E-mail: cjacobsen@anl.gov

Conventional tomographic reconstruction algorithms assume that one has ob-
tained pure projection images, involving no within-specimen diffraction effects
nor multiple scattering. Advances in x-ray nanotomography are leading to-
wards the violation of these assumptions, by combining the high penetration
power of x-rays which enables thick specimens to be imaged, with improved
spatial resolution which decreases the depth of focus of the imaging system.
We describe a reconstruction method where multiple scattering and diffrac-
tion effects in thick samples are modeled by multislice propagation, and the
3D object function is retrieved through iterative optimization. We show that
the same proposed method works for both full-ﬁeld microscopy, and for co-
herent scanning techniques like ptychography. Our implementation utilizes
the optimization toolbox and the automatic differentiation capability of the
open-source deep learning package TensorFlow, which demonstrates a much
straightforward way to solve optimization problems in computational imag-
ing, and endows our program great ﬂexibility and portability.

1

 
 
 
 
 
 
1

Introduction

Depending on the photon energy used, X rays are able to penetrate into samples with a thickness
ranging from micrometers to centimeters. At the same time, x-ray microscopes are beginning to
be able to deliver images with sub-10 nanometer spatial resolution (1–4). However, combining
these characteristics is complicated by the fact that any imaging method with spatial resolution
δr has a depth of focus DOF limit (5, 6) of

DOF =

2
0.612

δ2
r
λ

(cid:39) 5.4δr

δr
λ

.

(1)

This is straightforward to understand in lens-based imaging systems. However, even when lens-
less imaging methods involving wavefront recovery are employed, the depth of focus limit of
Eq. 1 gives the axial distance over which features can be considered to all lie within a common
transverse plane before subsequent waveﬁeld propagation effects are taken into account. That
is, Eq. 1 represents the limit of validity of the pure projection approximation, within which a
depth-extended object can be treated as producing a simple pure projection image when viewed
from one illumination direction. For objects thicker than the depth of focus (DOF) limit, one
must instead account for wave propagation effects within the specimen. This will be espe-
cially important for fully exploiting the dramatic increases in coherent x-ray ﬂux that the next
generation of synchrotron light sources will provide (7).

One approach to simulate wave propagation in a complex object is the ﬁnite-difference
method (8). However, due to the need to solve a series of partial differential equations, the
efﬁciency of this method relies on the availability of distributed differential equation solvers,
which are usually sophisticated to implement. On the other hand, Multislice wave propagation
(9) is a historic, simple but still powerful method allowing one to account for wave diffraction
in a inhomogeneous medium. The multislice simulation method subdivides the propagation
problem into a series of elemental modulation and propagation operations, and accounts for the
change of the probe wave throughout the object instead of assuming a constant probe. Hence, it
can provide accurate numerical results propagation through a complicated object, and remains
valid over a much larger object thickness compared to diffraction tomography models assuming
single scattering (10, 11). The incorporation of multislice propagation could stand as a novel
and reliable strategy for the reconstruction of beyond-DOF objects.

We describe here an approach for imaging objects that extend beyond the DOF limit, and
within which multiple scattering might take place. We formulated the 3D object reconstruction
problem as a minimization problem which incorporates a data ﬁdelity term (L2-norm of sim-
ulated and measured data) and a regularization term (L1-norm of the object and its gradient),
where the multislice wave propagation is used to accurately model the exit wave leaving the
object. Because the new model better captures the wave-object interactions for any object size,
the same model can be applied to reconstruct either near-ﬁeld imaging with propagation phase
contrast or ptychography (Fig. 1) without the need for any modiﬁcation. We used the Adap-
tive Moment Estimation (Adam) optimizer that is implemented in TensorFlow, which is Google

2

Figure 1: Schematic representation of the two different microscope types used in our demonstra-
tion. In the full-ﬁeld mode (a), phase contrast is incorporated by allowing the waveﬁeld leaving
the object to undergo Fresnel propagation over a distance d before that plane is imaged by a lens
(with 1/f = 1/s + 1/s(cid:48)) onto a detector. In ptychography, a small coherent beam spot (probe)
is scanned through the object and the far-ﬁeld diffraction intensities are recorded for each probe
position. The schematic here shows Fresnel zone plates as lenses for quasimonochromatic x-ray
beams.

Brains open-source software library. The automatic differentiation capability in TensorFlow al-
lows us to implement the optimization problems with minor tweaks. With this approach, we are
able to use one computer code for two different types of microscopes to reconstruct 3D objects
beyond the DOF limit.

It is worthwhile noticing that while there exist several multislice-based reconstruction method
which have proven success in several imaging scenarios (12–14), our method differs from them
in a few aspects. Our implementation provides both a ptychography mode and a full-ﬁeld mode,
while the above methods are concerned with ptychography alone. In addition, instead of requir-
ing planes that are axially separated by 1 DOF of more, in our method the spacing between
slices can be equal to the lateral pixel width which allows for an isotropic voxel size. Finally,
the method for updating the object function is different. In (12), slices are updated sequentially
using an update function that resembles the modulus replacement operation in ePIE, a recon-
struction engine for 2D ptychography. In (13), the ﬁrst method described is similarly based on
modulus replacement, while the second method involves the minimization of a loss function that
has a similar form of ours. However, in our approach to full-ﬁeld microscopy, the loss equation
is constructed also with a sparsity constraint, and non-negative and ﬁnite support constraints are
applied to the object function throughout the minimization process. This also distinguishes our

3

(a) Near-field propagation phase contrastdNΔzNΔz(b) Far-field ptychographyss′work with (14). Lastly, our employment of automatic differentiation through the widely used
software package TensorFlow renders the implementation highly accessible and ﬂexible. On
the top of the ﬁrst reports of using AD in phase retrieval problems (15–17), our work reinforces
the vast potential of AD for a large variety of computational imaging tasks.

2

Imaging beyond the depth-of-focus limit

Present-day x-ray nanotomography is usually done within the depth of focus limit of Eq. 1
(18–26), such as with 1 µm resolution at 25 keV (giving λ = 0.050 nm and DOF=110 mm), or
20 nm resolution at 6.2 keV (giving λ = 0.20 nm and DOF=11 µm). In these cases, one can
obtain an image that represents a pure projection through the specimen at each rotation angle
by using standard phase retrieval methods based on the inversion of the Transport-of-Intensity
equation (27); one can then use standard tomographic reconstruction algorithms such as ﬁltered
backprojection. For objects that are thicker and/or interact more strongly, the complete solution
of the wave function of electromagnetic wave within an inhomogeneous scattering potential
ﬁeld results in an recursive equation. With the ﬁrst iteration, one arrives at the ﬁrst Born ap-
proximation, which physically accounts for single scattering within the sample. On this basis,
one can approximate the imaging of thicker specimens by acknowledging the fact that the far-
ﬁeld diffraction pattern of an object provides information on the surface of the Ewald sphere
corresponding to the beam energy and viewing direction (28). This re-mapping of Fourier space
information from a plane (pure projection), to the surface of the Ewald sphere, is used in ﬁl-
tered backpropagation algorithms in diffraction tomography (11). It has been widely applied in
tomographic diffractive microscopy with visible light (29) and has been demonstrated in x-ray
coherent diffraction imaging (30).

One approach that has been developed for imaging beyond the DOF limit is multislice pty-
chography (12). In standard ptychography (31, 32), one scans a ﬁnite sized coherent beam with
overlap across a planar sample and separates or factorizes the probe from the optical modu-
lation at each scan position. Multislice ptychography is based on utilization of the multislice
method (9) (also known as the beam propagation method (33)) to propagate a beam through
a thick object, where the refractive effect of the ﬁrst thin slab of the object is applied to the
incident waveﬁeld, the waveﬁeld is free-space-propagated to the next slab position, and the pro-
cess is repeated until one obtains the exit wave leaving the object (which can then be free-space
propagated to a far-ﬁeld detector, for example). If the object is in fact comprised of a series
of discrete planes separated axially by 1 DOF or more, one can factorize the probe from both
transverse positions, and axial planes as well. One can also account for violation of the Born
approximation, in that the object-modulated exit wave from the upstream plane is propagated
to the next axial plane in a recursive manner through all planes. This approach has been used
with success in ptychography using visible light (34), X rays (13, 35, 36), and electrons (37). It
has also been used for tomographic imaging of more continuous specimens by assuming that
the object could be represented by discrete axial planes separated by the DOF (38). However,

4

this assumption is only approximately true, since one can often see image contrast variations
with defocus settings of less than 1 DOF (or the separation of the slices), especially in phase
contrast which is the dominant contrast mechanism in transmission x-ray microscopy (39). In
that case, variation of features along the beam axis between each two adjacent slices will not
be captured. In addition, multislice ptychographic tomography as implemented above requires
phase-unwrapping of individual (40) or the summation (38) of phase contrast images obtained
prior to their use in tomographic reconstruction, and this phase unwrapping process can some-
times present difﬁculties or inaccuracies.

Therefore it can be advantageous to use reconstruction methods that use a forward model
of multislice propagation in a continuous object and retrieve directly the refractive indices of
the objects instead of the phase of the exiting waves, so that multiple scattering effects are
included and no phase unwrapping is required. Calculations for x-ray imaging of biological
specimens show that one must begin to account for multiple scattering effects at a specimen
thickness of a few µm in soft x-ray imaging at 0.5 keV, and a few tens of µm in hard x-ray
imaging at 15 keV (41). The need for the inclusion of multiple scattering effects is well known
in optical diffraction microscopy (29), and we have shown that this approach can be used for
x-ray microscopy as well (14). What we describe below is a new approach that is different than
the above: it uses the method of automatic differentiation to carry out the reconstruction, which
offers greater ﬂexibility on imaging method and for incorporating various constraints on the
object as numerical optimization regularizers.

3 Formulation of the image reconstruction problem

Our approach is to treat image reconstruction of objects beyond the DOF limit as an numerical
optimization problem. That is, we wish to ﬁnd the optimal parameter set n0 of the forward
model f by minimizing an objective function L, leading to a solution of

n0 = arg min

n

L[f (n), y], subject to n ∈ Φ

(2)

where the observable y is the set of experimental measurements (near-ﬁeld images or far-ﬁeld
diffraction patterns), and Φ is the manifold of contraints that n is subject to. The parameter set
n will be deﬁned in Eq. 5 below to be proportional to the x-ray refractive index (RI) distribution
within the object’s voxel grid positions r. This refractive index is written as

n(r) = 1 − δ(r) − iβ(r).

(3)

where the values of δ and β for various materials are readily obtained from tabulations (42).
Except at photon energies right near x-ray absorption edges where anomalous dispersion effects
can appear, δ and β have small positive values (typically δ (cid:39) 10−4 and β (cid:39) 10−5 to 10−6) so
a positivity constraint can be applied to their solution. One can also apply a sparsity constraint
for objects that are relatively discrete in space (43), and in most cases tomography experiments

5

are designed so that the object ﬁts within the ﬁeld of view so one can also apply a ﬁnite support
constraint on the solution of n(r).

Because the size of the optimization problem is high, efﬁcient mechanisms must be used
to ﬁnd gradients for each iteration of the ﬁrst-order solver used in optimizing Eq. 2. If one is
always considering one type of imaging experiment, one can calculate derivatives of the cost
function and indeed this approach has been used with success for simulations of x-ray ptycho-
graphic reconstruction of objects beyond the DOF limit (14). However, if one wishes to be
able to treat multiple imaging methods (so as to compare or benchmark their properties and
performances, for example) and include a variety of regularizers, other approaches that place
the burden of ﬁnding minimization strategies on a computer rather than a scientist can have ad-
vantages. One approach is to represent multislice propagation with a computational architecture
resembling a convolutional neural network and use mathematical formulations that are common
in machine learning to solve for the object that matches the observations, as has been demon-
strated for diffraction microscopy using visible light (44). Automatic differentiation (AD) (45)
provides another approach which was suggested for use in phase retrieval problems (46), and
then successfully implemented for x-ray ptychography (15, 16). More recently, the adaptabil-
ity of automatic differentiation to a variety of coherent diffraction imaging methods has been
demonstrated (17), and a variety of software toolkits are now available to utilize this method
(spurred on by their use for constructing the trainer module in supervised machine learning
programs). We use this AD approach to reconstruct beyond-depth-of-ﬁeld imaging in two suc-
cessful imaging methods, and thus gain insight on their relative advantages and complications.
As noted above, in x-ray ptychography one scans a ﬁnite sized coherent beam through a
series k of overlapping probe positions across the specimen, and collects the far-ﬁeld diffraction
pattern from each. Because the extent of the far-ﬁeld diffraction pattern is determined by the
scattering properties of the object rather than the spatial resolution of the probe, one can obtain
reconstructed x-ray images with a spatial resolution far ﬁner than the size of the probe (47, 48).
In contrast, point projection x-ray microscopy (49), where an object is placed downstream of a
point source of radiation, provides geometric magniﬁcation of the object with a penumbral blur
limit given by the source size, plus diffraction blurring that can be compensated for by near-ﬁeld
wave backpropagation (23, 50). Because near-ﬁeld diffraction blurring is localized to a region
given by the ﬁnest reconstructed feature size times the propagation distance divided by the
wavelength, one can make use of illumination with a coherence width equal to this region rather
than the entire illumination ﬁeld as required for ptychography, and thus make more complete
use of partially coherent sources. Since the advancing of x-ray imaging instruments has granted
considerable potential to both techniques in their imaging applications for thick samples with
high resolution, it is of interest to understand the beyond-DOF imaging properties of both of
these approaches.

6

Figure 2: Illustration of multislice propagation.

4 Algorithm implementation

4.1 The forward model

We use the multislice method (9) to calculate the wave exiting the object, since it incorpo-
rates multiple scattering while also accounting for effects such as waveguide phenomena (51)
(with the sole limitation of ignoring backscattering which is neglible for all cases except Bragg
diffraction from perfect crystals or synthetic multilayers). As illustrated in Fig. 2, in multislice
propagation, the object is divided into J slices along the beam axis. The waveﬁeld ψj,k(x, y, zj)
from probe position k (for full-ﬁeld, k = 0 for the ﬁrst and only probe position) entering the jth
slice with thickness ∆z is modulated by the slice to yield a waveﬁeld ψ(cid:48)

j,k(x, y, zj) of
(cid:105)
i[1 − δ(x, y, zj) − iβ(x, y, zj)]

(cid:104)
j,k(x, y, zj) = ψj,k(x, y, zi) exp

ψ(cid:48)

−

= ψj,k(x, y, zi) exp

(cid:16)

−

(cid:17)

i

exp(nj)

2π∆z
λ
2π∆z
λ

with

nj =

2π(∆z)
λ

[iδ(x, y, zj) − β(x, y, zj)].

(4)

(5)

We will denote the RI distribution of the entire object by vector n in the following text.

The wavefront is then free-space propagated to the next slice according to the Fresnel

diffraction integral given by

ψj+1,k(x, y, zj+1) = ψ(cid:48)

j,k(x, y, zj) ∗ h∆z(x, y)

(6)

7

12......j......Jψj,kψ’j,kψj+1,kAn,θ,jPΔzPropagation directionwhere ∗ denotes the convolution operator, and h∆z(x, y) is the Fresnel propagator given by

h∆z(x, y) = exp

(cid:104)
−i

π
λ∆z

(cid:105)
(x2 + y2)

.

(7)

∆z ≤

(∆x)2
λ

This process is repeated for all J slices until one obtains the exit wave leaving the object.
Here the slice thickness ∆z can be equal to the transverse pixel size ∆x, or for computational
speed one can combine multiple slices from the 3D volume together provided one satisﬁes the
condition of

2˜nQ
π
where ˜n is the mean RI, ∆x is the pixel size, and Q is the Klein-Cook parameter for which
values of Q (cid:46) 1 represent the case of plane grating rather than volume grating diffraction (52).
In fact, multislice propagation is only one of several steps that must be combined in the
forward model of tomography beyond the DOF limit. Tomography acquisition requires the
illumination of the object from multiple rotation angles θ. Our approach to account for the
rotation is to rotate the object onto a constant wave propagation direction, rather than to rotate
the illumination; this is done with a rotation operator Rθ. After carrying out the sequence of J
multislice propagation steps through the rotated object, we then need to apply the operator Pd
to take the exit wave ψJ,k from the object to the plane of the detector, either using free space
propagation as described by ψJ,k ∗h(x, y, d) for near-ﬁeld propagation of distance d, or a simple
Fourier transform for far-ﬁeld propagation (in the Fraunhofer approximation). This leads us to
a combined forward operation of

(8)

f (n, θ, k, ∆z, d) = PdMn,θ,∆zψ0,k.

(9)

In Eq. 9, Mn,θ,∆z is the multislice propagation operator which is a function of the 3D object and
the incident probe. Mn,θ,∆z describes the exit wave that leaves the depth-extended specimen.
It can be compactly written as

with

Mn,θ,∆z =

J
(cid:89)

j

P∆zAn,θ,j

An,θ,j = exp[diag(SjRθn)]

(10)

(11)

where Sj is a matrix that samples the j-th slice of column vector Rθn. If the total number of
voxels of the object function is Nv, and the number of pixels in the detector is Np, then n is a
Nv × 1 column vector, Rθ is a Nv × Nv square matrix, and Sj is in the shape of Np × Nv, so that
it yields an Np × 1 column vector, which is of the same size as the wavefront ψ0,k. Multiplying
diagonal matrix An,θ,j with the wavefront vector ψ0,k is exactly the wavefront modulation given
in Eq. 4.

8

4.2 Constrained loss function minimization

It has been pointed out for conventional 2D coherent diffraction imaging that since only magni-
tude information is available in the detected far-ﬁeld diffraction pattern, a reconstructable object
should be spatially isolated, with prior knowledge about the geometry of the object incorporated
into the reconstruction through zeroing out pixels out of the object boundaries. This is known
as a “ﬁnite support” constraint (53). Ptychography does not require a ﬁnite support constraint
applied in object space because the bounded probe itself is already a form of ﬁnite support
constraint, and furthermore the overlap between adjacent probe positions supplies sufﬁcient
information to solve for all object unknowns.

In our work where a 3D object is retrieved, the same criteria are followed. As will be shown
in the results section, the ptychography reconstruction of the object using our algorithm does not
need prior knowledge about the spatial extent of the sample. However, a ﬁnite support constraint
was found to be necessary for the full-ﬁeld case. The initial ﬁnite support mask is determined
following the procedures below. First, single-distance near-ﬁeld phase retrieval (54) is applied
to all projection images to obtain a ﬁrst guess of the weak phase contrast projection through
the object. We then use the tomographic set of these projections to obtain a rough guess of the
object support using the standard ﬁltered backprojection tomographic reconstruction algorithm.
The reconstructed volume is then Gaussian ﬁltered to remove noise and local discontinuities.
A Boolean mask is subsequently obtained by thresholding the ﬁltered object, which yields a
support mask denoted by set Θ. During the iterative reconstruction process, the ﬁnite support is
contracted to exclude low-value pixels for every epoch, a technique known as “shrink-wrap” in
conventional CDI processing (55).

We then wish to compare the present guess of the detected amplitude of |f (n, θ, k, ∆z, d)|
yθ,k measured in the experiment, and minimize the difference between

√

against the amplitude
the two as expressed in a cost function of

L =

1
NθNpNk

(cid:88)

θ,k

(cid:13)
(cid:13)|f (n, θ, k, ∆z, d)| −

√

yθ,k

(cid:13)
2
2 + αδ|nδ|1 + αβ|nβ|1 + γTV(nδ).
(cid:13)

(12)

That is, the solution of the object function should be given by

n0 = arg min

n

(L)

subject to nw = 0 for nw (cid:54)∈ Θ and nw ≥ 0 for nw ∈ Θ.

(13)

Here, nw is the w-th element in n, yθ,k is the measured intensity at orientation angle θ, Nθ
is the number of projection angles, Np is the number of pixels in each yθ,k, Nk is the number of
probe positions for each projection angle (equals 1 for full-ﬁeld), and αδ and αβ are the scalar
normalizing coefﬁcients added to the L1-norm regularization terms for the δ-part and β-part of
n respectively. The separated regularization for the two parts of the object is necessary since
δ(r) and β(r) of the same material typically differ by a few orders of maginitudes. Together,
these two L1-norm terms enhance the sparsity of the object function, which is useful when

9

the object is spatially discrete or contains a lot of empty space (such as a dispersion of cells,
or a hollow structure). Finally, the anisotropic total variation TV(n), weighted by coefﬁcient
γ, enhances the sparsity of the gradient of the object function, which suppresses noises and
unwanted heterogeneities (56). This regularizer is expressed as

TV(n) =

(cid:88)

l,m,n

[|xl+1,m,n − xl,m,n| + |xl,m+1,n − xl,m,n| + |xl,m,n+1 − xl,m,n|]

(14)

where l, m, and n are indices along the three axes of n. The TV regularizer is only applied to
nδ because it usually carriers higher contrast and better structural information than nβ when
hard X rays are used.

The successful retrieval of n requires the simultaneous pixel-wise update of it, guided by
∇nL, which is the gradient of loss function L in the parameter space of n. We use Tensor-
Flow (57), a deep learning package ﬁrst initiated by Google but now available as an open-source
toolkit, for carrying out our AD reconstruction. It provides a user-friendly Python application
programming interface (API), and the ability to write a reconstruction code of relative simplic-
ity and with easy implementation on a variety of computing platforms. The AD algorithm uses
the so-called “back-propagation” method to derive the partial derivatives in a semi-analytical
fashion (45). Here, the loss function L is ﬁrst evaluated in the forward direction using Eq. 14,
during which the intermediate variables produced by every algebraic operation are computed
and stored. After that, the algorithm calculates the derivative of L with regards to the interme-
diate variables immediately before L using the values saved in memory. This is repeated back
through the entire computation model, and the gradient of L with regards to n, ∇nL, is then
found based on the chain rule of differentiation. Compared to symbolic differentiation which
attempts to acquire the closed-form expression of ∇nL before doing any numerical calculation,
AD is free from the problem of expression swell when the forward model is complicated. On
the other hand, AD is also more accurate than the ﬁnite difference method, which approximates
with ∂f /∂xi ≈ [f (n + hei) − f (n)]/h for a small h (58).
∇nL =
We use the well-established optimization algorithm ADAM (ADAptive Moment estimation) to
update n (59). A brief description of the algorithm is provided in the supplementary material.

∂f /∂x1, ..., ∂f /∂xn

(cid:17)

(cid:16)

4.3 Computational performance enhancements

Like conventional tomography, the dataset acquired for reconstruction would generally involve
a large number of rotation angles Nθ (though in multislice reconstruction methods one can
reduce Nθ from below the number one would have expected from the Crowther criterion (60)).
The large value of Nθ can lead to the use of considerable computation power in the iterative
update of n. To reduce this, we note that the ﬁrst term in Eq. 14 is essentially an expectation
value of error per pixel, and it can be adequately approximated by calculating the error over a
subset of Nθ. This technique, known as “minibatching” (or “ordered-subsets” in tomography
literature (61)), can speed up the convergence of the algorithm by several times. For each

10

minibatch, the subset of Nθ to be processed is chosen randomly without replacement, so that
the entire collection of Nθ will be fully gone through after a certain number of minibatches are
completed. We hereafter refer to this process as an “epoch,” using terminology drawn from the
machine learning community.

In an actual experiment, the presence of noise typically induces uncertainty in the “sub-loss
function” obtained from each minibatch. In this case, a true global minimum is ill-deﬁned,
which causes n to dangle at the late stage of the optimization and thus prevents a stable con-
vergence. For this reason, users of TensorFlow have the option to aggregate the gradients cal-
culated from several minibatches, and apply them to the optimizer after the completion of all
of these minibatches. The larger sample amount for gradient calculation reduces the statistical
ﬂuctuation induced by noise and guarantees a more stable solution.

A multiscale technique is also used in this work to further improve reconstruction speed
and accuracy. While the algorithm requires that n has the same number of lateral pixels as
the measured data, instead of directly reconstructing the object with the same pixel size as the
acquired projections, both n and yθ,k are downsampled by a factor of 2m, where m is an integer
so that the lateral dimension of n is not larger than 64 pixels. The voxel size of the object is
thus accordingly enlarged by 2m times. A ﬁrst pass reconstruction of n is therefore computed
rapidly. The result is upsampled by a factor of 2, and then used as the initial guess for the next
pass, where the scale of the object and projections are doubled. This process is repeated until
the object is reconstructed with the acquired voxel size. By initializing n with the result from
a coarse pass for a higher-resolution pass, the optimization begins at a location closer to the
global minimum in the parameter space of L, so that fewer iterations are required to converge.
This may also reduce the chance for the optimizer to get trapped in a remote local minimum.

4.4 Parallelization

In view of the huge number of unknowns (3.4 × 107 for a 2563 object because of the presence of
both the δ and β parts of the RI) to be solved in our algorithm, parallelized computation is nec-
essary to guarantee a reasonable computational walltime (within a few hours for a 2563 object).
We use a TensorFlow add-on called Horovod (62) to implement distributed parallelization using
the message passing interface (MPI) standard for inter-rank (or inter-process) communication,
rather than the TCP/IP protocol used by native TensorFlow (MPI is faster on tightly bound high
performance computer clusters). Each thread (or worker) initializes and keeps its own object
function, and process a minibatch simultaneously with other threads. When a rank ﬁnishes its
minibatch, it waits for other threads to ﬁnish theirs, after which the gradients obtained by all
threads are averaged. The averaged gradient is then used to update the object functions in all
threads. Since the volume of samples used for gradient calculation is effectively enlarged by a
factor that equals the number of threads nthrds, this means that the actual learning rate (59) for
the ADAM optimizer is multiplied by nthrds.

The code used in this work has been made publicly available on GitHub in the repository

11

named “Adorym”1, which is an acronym for “Automatic Differentiation-based Object Retrieval
with dYnamic Modeling.”

4.5 Reference reconstructions

In order to compare the outcomes of the proposed algorithm with methods that are convention-
ally used for phase retrieval, the full-ﬁeld data demonstrated in this work are also processed
and reconstructed by ﬁrst performing an iterative 2D phase retrieval method termed error re-
duction (ER; widely used in coherent diffraction imaging (53)) for every projection image. The
workﬂow of ER can be summarized as follows:

1. Propagate the initial guess of the exit wavefront ψ0 to the detector plane as

ψ(cid:48)

0 = Pdψ0;

2. Replace the magnitude of the wavefront with the modulus of the measured intensity Iθ as

ψ(cid:48)(cid:48)

0 =

ψ(cid:48)
0
|ψ(cid:48)
0|

(cid:112)

Iθ;

3. Backpropagate the wavefront to the exiting plane as

ψ(cid:48)(cid:48)(cid:48)
0 = P−dψ(cid:48)(cid:48)
0 ;

4. Mask out the pixels of the wavefront that do not belong to the ﬁnite support Θ2 by doing

ψ1 =

(cid:110) ψ(cid:48)(cid:48)(cid:48)
0,

0 (r), r ∈ Θ2
r (cid:54)∈ Θ2

.

5. The above processes are then repeated until the mean square error between the calculated

intensity and the measured intensity converges.

The ﬁltered backprojection or FBP tomographic reconstruction method is then applied to phase-
retrieved images to obtain a 3D reconstruction result. This ER+FBP approach will be subse-
quently referred to as “pure projection tomography.”

5 Computational experiment

Our Adorym approach was tested in simulations of thick objects that would normally involve
multiple scattering along the beam path. Two virtual samples were investigated: one that is

1https://github.com/mdw771/adorym.

12

described below, and a protein sample that is presented in Supplementary Material. The re-
constructions of the silicon cone sample shown here were performed on the computing cluster
Cooley at the Argonne Leadership Computing Facility. Each node of this cluster is equipped
with two 2.4 GHz Intel Haswell E5-2620 v3 CPUs (12 cores total) and 384 GB RAM. Due to
the limit of memory, we did not use GPU acceleration on this machine. TensorFlow version
1.4.0 was used as the computational engine for our routine. For the ADAM optimizer built with
TensorFlow, we used a step size of λ = 10−7, and ﬁrst and second moment exponential decay
rates of β1 = 0.9 and β2 = 0.999, respectively.

We carried out computational experiments on a cone object created using the optical sim-
ulation package XDesign (63). In order to exceed the depth of focus limit within a moderate
array size, we chose to create a (256)3 voxel grid with 1 nm voxel size, and to use 5 keV x-ray
beam energy. As a result, the x-ray wavelength was 0.248 nm and the depth of focus given
by Eq. 1 was DOF=21.8 nm. (Present-day x-ray microscopes achieve a spatial resolution of
more typically 15–30 nm as noted in the introduction, but 1 nm represents a goal for the future).
Therefore the reconstruction grid was almost 12 times larger than the depth of focus, so the
object signiﬁcantly excedes the depth-of-focus limit. Within this grid, a hollow cone of silicon
was computationally created so as to resemble a thin-walled capillary heated and then pulled.
The tube has a top diameter of 80 nm and a bottom diameter of 200 nm, so that neither end
ﬁts within the DOF limit. To examine the algorithm’s capability to restore ﬁne details, we also
placed 50 TiO2 nanospheres with radii ranging from 2 to 4 nm on the outer wall of the tube,
as well as 10 larger spheres (5–13 nm in radius) inside the tube. The refractive indices of both
materials were generated using the open-source database package Xraylib (64). In addition,
we added spherical bubbles, or “grains,” whose refractive indices ﬂuctuate within 30% of the
original material, into the cone’s body as a means to test the ability of the algorithm to retrieve
internal structure. These grains also served as marks in assessing the inﬂuence of photon noise
on ptychography results as will be discussed below. The phase shifting part δ of the x-ray RI
for this computationally-created object is shown in the top row of Fig. 3.

In x-ray full-ﬁeld imaging, a variety of methods are available to obtain a phase contrast
image from detected intensities (66), but propagation-based phase contrast is the simplest to
achieve experimentally. We therefore assumed that the x-ray waveﬁeld exiting the object prop-
agated downstream by a sample-detector distance d of 1 µm before the resulting waveﬁeld was
imaged without loss by a 1 nm resolution lens onto a detector, as shown in Fig. 1. This is
beyond the state of the art with present-day x-ray optics, but as noted above we chose param-
eters so as to signiﬁcantly exceed the depth of focus limit within a small array size. Within
this optical conﬁguration, we simulated the recording of 500 images over a single-axis rotation
range of 360◦ in one case, and 180◦ in another case. The purpose of distinguishing 360◦- and
180◦-rotation is that when diffraction is present in the sample, the image obtained from θ and
θ + 180◦ can be different, unlike conventional tomography. In order to acquire high-quality
results, we conducted a series of experiments to determine that the optimal values for the reg-
ularizer weights in Eq. 14 were αδ = 1.5 × 10−8 for the stronger phase-shifting part of the
x-ray RI, and αβ = 1.5 × 10−9 for the weaker absorptive part. The total variation minimization

13

Figure 3: Cone object used for computational experiments in beyond depth-of-focus x-ray
imaging. The inset between column 2 and 3 shows a near-ﬁeld diffraction image used in full-
ﬁeld reconstruction. The object (top row) and various reconstructed images (subsequent rows)
are shown, displaying only the phase-shifting part δ of the x-ray RI since it provides higher
contrast than the absorptive part β. In keeping with the convention of most synchrotron to-
mography experiments, the object is assumed to be rotated around the vertical or y axis. The
ﬁrst column shows a single-plane section of the object in the yz plane, with the location of
the section shown by the green dashed line in the third column. The second column shows a
projection or summation through the 3D grid in that same direction, while the third column
shows a projection or summation through the 3D grid viewed from above. The fourth column
shows the surface of the object, as rendered using Vaa3D (65). Both the full-ﬁeld (b) and the
ptychography (d) reconstructions of data acquired over a 360◦ rotation angle range reproduce
the object with high ﬁdelity. In the full-ﬁeld reconstruction from 180◦ rotation data (c), voids
appear where there is supposed to be material within the cone (in this case the illumination was
incident from top, to right, to bottom in the perspective of the third and fourth columns, though
the same type of behavior was observed with different 180◦ illumination ranges). In the pure
projection tomographic reconstruction shown in the bottom row (e), one obtains an image with
14
lower resolution and greater differences from the true object: the ﬁne TiO2 spheres on the out-
side of the cone object are blurred out, and the reconstruction shows spurious material inside
the cone. These images are all of a 256×256 nm2 ﬁeld of view.

(a)(b)(c)(e)(d)YZ-cross sectionProj. (front)Proj. (top)Surface (top)TrueobjectPure projectiontomographyPtychography360°Full-field360°Full-field180°Voidregularizer term of Eq. 14 was made small by setting γ = 1 × 10−11. The x-ray RI grid was
initialized to a Gaussian distribution with a mean of δ = 8.7 × 10−7 and β = 5.1 × 10−8 with
standard deviations of about a tenth of the mean. These values are lower than the expected
values but gave better reconstruction starts than values of zero; the reconstructions were not
sensitive to the exact non-zero initialization values. In TensorFlow, we used a minibatch size
of 10, and set the iterator to stop automatically once the incremental decrease of the total loss
function of Eq. 14 fell below 3%. Parallelized with 4 threads, using 3 levels of multiscaling,
and running on CPUs, the full-ﬁeld reconstruction ﬁnished with 10, 10, and 6 epochs for the
three passes with 4×, 2×, and 1× (original resolution) downsampling. The entire computation
took approximately 5.0 hours of wall clock time, and 120 core hours.

For ptychography, we assumed that an x-ray optic was used to focus a beam on the en-
trance of the object volume with a Gaussian proﬁle beam proﬁle with σx = σy = 6 nm, and
a maximum probe phase of 0.5 radians. A total of 23 × 23 = 529 probe positions were used
to illuminate the specimen from each viewing angle, as shown in Fig. 1. The sparsity and
smoothening constraints in ptychography are relaxed by probe overlap, so that a different set of
regularizer values for Eq. 14 were used, with αδ = 1 × 10−9, αβ = 1 × 10−10, and γ = 1 × 10−9.
The x-ray RI grid was initialized in the same way as the full-ﬁeld case. The minibatch size was
set to 1 rather than 10 so as to allow all data from one projection angle to ﬁt in computer mem-
ory. For this larger data set with far-ﬁeld diffraction intensity recordings, the reconstruction
was parallelized with 20 threads, and required 4 epochs to yield a high quality result over a wall
clock time of 46 hours, or 16,500 core hours.

Figure 3 shows the true object in row (a), and the reconstruction results for these various
approaches in rows (b) through (e). In the 360◦ full-ﬁeld reconstruction shown in row (b), and
the 360◦ ptychographic reconstruction shown in row (d), the object boundaries are sharp, and
features within the object are nicely reproduced. This is decidedly not the case for the ER+FBP
or conventional tomographic reconstruction shown in row (e), where the small spheres on the
outside of the object are poorly reproduced in the surface view of the fourth column, and the
projection images of columns two and three do not accurately reproduce the true object. In vi-
sual appearance, one can argue that the ptychography reconstruction shown in row (d) is slightly
sharper and has least “ghost” structure present in what are supposed to be empty voids inside
the cone compared to the full-ﬁeld reconstruction shown in row (b). This may be due to the
fact that the large number of spatially separate illumination patterns used in ptychography help
limit the regions that contribute scattering signal to each of the 529 individual data recordings
acquired per rotation angle. On the other hand, the ptychographic reconstruction shows some
slight fringe artifacts at the bottom of the cone, which might arise from the fact that the data are
recorded in the far rather than the near ﬁeld. More quantitative comparisons will be presented
below, using the Fourier shell correlation (FSC) method (67,68) which measures the consistency
between images as a function of spatial frequency (resolution in the Fourier transform).

In conventional tomography within the pure projection approximation, projections obtained
180◦ apart are identical after projection reversal, so that data collected over a 180◦ range are
sufﬁcient for an accurate reconstruction. This is not the case when diffractive effects come

15

Figure 4: Fourier shell correlation (FSC) measurement of the resolution of full-ﬁeld reconstruc-
tions using 500 rotation angles distributed over 360◦ [Fig. 3(b)] versus only 180◦ [Fig. 3(c)].
The FSC measurement shows a considerable loss in spatial resolution over a wide range of
spatial frequencies, but especially at the highest spatial frequencies corresponding to the ﬁnest
features. The FSC was calculated by comparing the phase shifting part of the x-ray RI δ between
two separate iterative reconstructions of the same full-ﬁeld recording dataset.

into play, as has long been known in diffraction tomography (11) and as was observed in our
previous study of ptychographic reconstructions of an object with depth-of-focus effects in-
cluded (14). Modulations on the waveﬁeld can be produced both by Fresnel diffraction from
upstream features, and refractive modulation from features at downstream planes; one cannot
unambiguously distinguish between these two effects using a single viewing angle. To illustrate
this, we have carried out a simulation of full-ﬁeld imaging where the same 500 rotation angles
used in the 360◦ case were instead distributed over a 180◦ angular range, giving the results
shown in row (c). This leads to the presence of a number of voids in the reconstructed refractive
index distribution, presumably because of the ambiguity noted above; the voids remained in
the same position even if the 180◦ illumination angles were shifted to a different range, and is
not related to the shrink-wrap of the ﬁnite support. By removing the positivity constraint on
the RI distribution and examining the intermediate object function as it was updated after each
minibatch, we noticed that the values in the void regions became negative and kept decreasing.
We therefore speculate that the voids might arise as the optimizer attempts to compensate for
the loss function under information deﬁciency. The resolution of the 180◦ and 360◦ full-ﬁeld
reconstructions was evaluated using the FSC between two independent reconstructions with the
same parameter settings, and the result shown in Fig. 4 clearly shows the loss of resolution that
results from using the same number of projection angles distributed over 180◦ only.

In order to understand the robustness of our reconstruction method in the presence of noise

16

0.00.20.40.60.81.0Normalized spatial frequency (1 / Nyquist)0.650.700.750.800.850.900.951.00Fourier shell correlation (FSC)180°360°due to limited exposure, we carried out full-ﬁeld reconstructions where the recorded diffrac-
tion intensities were modiﬁed to incorporate noise. (Other studies have considered the noise
robustness of simple coherent diffraction imaging against zone plate imaging (69) or against
near-ﬁeld imaging (70) with somewhat differing conclusions; we leave a comparison of full-
ﬁeld imaging and ptychography for future work). This was done by setting a quantity nph to
be the total number of incident photons that intersect the object support with the object at each
of the 500 projection angles. The object support is characterized by an area overdetermination
ratio (AOR) of

(15)

(16)

σAOR =

N 2
Nsupport

Npix,θ =

nph
σAOR × N 2

where Nsupport represents the total number of pixels within the ﬁnite support (71). The Gaussian-
blurred “shrink-wrap” procedure described above led to σAOR (cid:39) 57% for the simulated cone
object. With these factors considered, the number of photons Npix,θ incident on each of the
N 2 = 2562 pixels is given by

for each of the Nθ viewing directions such that nph = 1 × 109 corresponds to Npix,θ = 2.7 × 104.
The detected intensity images at each of the Nθ angles, generated by a normalized plane incident
wave with unity magnitude, were scaled by Npix,θ before Poisson noise was applied to them. We
then obtained reconstructions from the Poisson-degraded datasets, and compared them using the
Fourier shell correlation (FSC) method (68).

Given the normalized image intensity one would expect from a feature-present versus a
feature-absent voxel, one can estimate the exposure required to see that object with a speciﬁed
signal-to-noise ratio (SNR). Using the phase contrast imaging expression of Eq. 39 of (41) for
t = 1 nm thick Si at 5 keV, we obtain an exposure estimate of Npix,θ = 5.0 × 107 for SNR=5
imaging. Dose fractionation (72) tells us that this dose can be distributed over all Nθ viewing
angles as 3D object statistics are built up from tomographic projections, so one would expect
that to achieve full resolution at SNR=5 one would require Npix,θ/Nθ = 1.0 × 105, which
from Eq. 16 translates to nph = 3.7 × 109 per viewing angle. Because this exposure scales
as SNR2, reducing nph from 3.7 × 109 to 1.0 × 109 corresponds to a decrease of SNR from
5 to 5/(cid:112)3.7/1.0 = 2.6. Alternatively, because the radiation dose that must be necessarily
imparted to a specimen for imaging at a speciﬁed SNR scales as the inverse fourth power of
spatial resolution (41, 73), a decrease of nph from 3.7 × 109 to {1 × 107, 1 × 108, 1 × 19} would
be expected to correspond to a reduction in spatial resolution from 1 to {4.4, 2.5, 1.4} nm. If
one translates this into a fraction of the Nyquist sampling limit, the corresponding fractions are
{0.23, 0.41, 0.72}. These fractions of the Nyquist sampling limit are shown via dashed lines
in Fig. 6, and they are consistent with a FSC in the 0.5–0.6 range as a measure of the spatial
resolution limit.

17

Figure 5: Near-ﬁeld propagation images as would be recorded by the camera in Fig. 1(a) (top
row), and reconstructed images (middle and bottom rows) in the presence of simulated Poisson
noise with a total number of photons nph used in data recording. The middle row projection
images correspond to the second column image of row (b) in Fig. 3, while the bottom row slice
images correspond to the ﬁrst column image of row (b) in Fig. 3. As can be seen, reducing
the number of photons nph within the object (and thus the incident number of photons per pixel
per viewing angle Npix,θ as given by Eq. 16) leads to a decrease in image ﬁdelity and signal to
noise ratio at the single pixel level. One can also evaluate this as a loss of spatial resolution with
decreasing exposure, as shown in Fig. 6.

18

Noise free1×1091×1081×107Figure 6: The Fourier shell correlation (FSC) for the fullﬁeld results with varying photon ex-
posure nph as shown in Fig. 5. For each exposure, two different datasets were generated with
different Poisson-distributed random noise, after which the same reconstruction algorithm with
the same parameters was applied to each noisy dataset before performing the Fourier shell cor-
relation. As discussed in the text, one would expect the SNR to decline at normalized spatial
frequencies of {0.23, 0.41, 0.72} times the normalized spatial frequency for photon exposures
of nph = {1 × 107, 1 × 108, 1 × 109}. The dashed lines at these normalized spatial frequencies
are all at roughly consistent decreases of the FSC to about 0.5–0.6 for the respective exposures,
corresponding to a spatial resolution estimate of {4.4, 2.5, 1.4} nm.

19

No noisenph=1×109nph=1×108nph=1×1070.00.20.40.60.81.0Spatial frequency (1 / Nyquist)0.00.20.40.60.81.0Fourier shell correlation (FSC)0.720.410.236 Discussion

We have shown here an approach (which we call Adorym, as noted above) whereby one can
use automatic differentiation and a multislice propagation forward model to reconstruct 3D
objects in two different microscope types, with only minor branchpoints in one computer code
base. Our approach has the following characteristics which are shared with another related
non-automatic-differentiation approach (14), as well as with other multislice learning (44) and
optimization-based (43) approaches:

• In standard diffraction tomography approaches, one assumes that the 3D object can be
decomposed into volume gratings so that data from one viewing angle is projected not
onto a ﬂat plane in Fourier space (as would be the case for a pure projection image), but
the surface of the Ewald sphere. These assumptions are valid for the case where there is
no multiple scattering in the specimen, but it can be shown (see for example Figs. 2 and
3 in (41)) that multiple scattering can play a role in x-ray imaging of thick specimens.
In other words, the illumination of downstream planes can be affected by the presence
of strong features in upstream planes. Because our approach involves a full multislice
forward calculation along each viewing angle, it can incorporate these effects correctly.

• In previous multislice ptychography approaches (12), it has been assumed that the object
can be decomposed into a set Na of planes along the illumination direction with those
planes separated by a depth of focus distance or more. This separation is required for
allowing the combination of propagated probe, and discrete object plane, to be decom-
posed into into sufﬁciently different results along the propagation direction. By allowing
for an isotropic forward model where the plane separation distance can be the same as the
transverse resolution distance, our approach is better able to represent the subtle contrast
variations that occur in imaging over distances that are a reasonable fraction of the depth
of focus. It should also be noted that the use of multislice methods to reconstruct Na
planes along the illumination direction means one can reduce the number of illumination
angles used (60) from what one might have expected based on the Crowther criterion (74).

• In previous ptychographic tomography (40) and multislice ptychographic tomography
approaches (38), phase unwrapping methods have been used to generate a pure projec-
tion image with a linear response. No phase unwrapping is required in our approach,
eliminating any potential errors and ambiguities that can sometimes occur with phase
unwrapping.

One would expect these characteristics to allow for the reconstruction of beyond-depth-of-focus
3D objects with greater ﬁdelity than one would have with multislice ptychographic tomography
approaches; exploration of this hypothesis could be the topic of future work.

Our use of automatic differentiation in a numerical optimization approach has several fea-

tures:

20

• For ptychography, it lets one phase the far-ﬁeld Fourier magnitudes as was ﬁrst suggested
(46) and then demonstrated (15) in prior work. For near-ﬁeld imaging, it avoids the
approximations of uniform material type implicit in one commonly-employed approach
(54).

• It allows one to easily switch between different imaging modes (in this example, both
near-ﬁeld imaging and ptychography) within the same code framework, and it lets one
explore different types of loss functions and regularizers without needing to rebuild the
optimzer. This can be very useful for benchmarking different imaging and reconstruction
techniques.

• Several software packages that provide automatic differentiation capabilities (such as
TensorFlow and Autograd) are already built for parallelized operation on large compute
clusters. As an example, an automated diffrentiation based ptychography reconstruction
code was demonstrated in (15). We carried out a direct test of our TensorFlow based
AD approach for ptychography against our previous result (14) using manual differen-
tiation of the cost function, and implementation in C++. The approach used here took
8.25 core hours/iteration/angle, compared to 6.48 core hours/iteration/angle. One pays a
modest penalty in computer time in this example, but arguably uses less researcher time
because automatic differentiation does not require one to re-calculate derivatives as the
cost function is modiﬁed.

• It also allows one to trivially compare and switch between synchronous and asynchronous
schemes of optimization. In the synchronous scheme, object functions are broadcasted
and synchronized among all threads for each several iterations.
In the asynchronous
scheme, each threads does the optimization own its own, and the object functions con-
In the example discussed in (15), the
tained by them are only combined at the end.
synchronous approach took slightly longer to complete but gave more accurate results.
The default scheme that we used to generate the above demonstrative data is a variant
of the synchronous approach. Here, each thread keeps its own object function, but the
gradient obtained by a thread is broadcasted and averaged along with the results of all
other threads before being used to update the object function.

The above stated characteristics have led to increasing attention to automatic differentiation
in the optics community, and other work has explored the use of automatic differentiation for
several other coherent diffraction imaging modalities (17).

Another point needing attention is that while the full-ﬁeld mode and the ptychography mode
are different in terms of acquisition method and processing wall time, the results they give are
sometimes not equivalent as well. This is most obvious for diffusive features without clear
boundaries, as in the case demonstrated in Fig. S1 in the supplementary material. In this test
case, a protein molecule (originally acquired using electron microscopy tomography) was nu-
merically reconstructed by our algorithm using both full-ﬁeld mode and ptychography mode.

21

The result shows that the full-ﬁeld reconstruction “throws away” the diffusive halo around the
molecule, which on the other hand is correctly restored by ptychography reconstruction.

While the proposed method has been implemented for both full-ﬁeld microscopy and for
ptychography, a special note should be given to the former. In the absence of the oversampling
constraint in ptychography, we explored the use of ﬁnite support constraint and sparsity con-
straint in 3D space, which would provide more insights to the iterative retrieval of a bounded
3D object by solving an underdetermined system. The algorithm, when combined with non-
scanning high-resolution imaging techniques, can potentially become the launchpad for a high-
throughput imaging pipeline for measuring thick samples with sub-100-nm resolution. One of
such possible paths is to apply the algorithm to point-projection microscopy (75, 76). While
far-ﬁeld diffraction patterns suffer a loss of speckle contrast as one goes from fully coherent to
decreasingly partially coherent illumination (with the best results obtained when the coherence
width of the beam equals the size of the object array (77)), with near-ﬁeld wave propagation one
only needs to have the spatial coherence match the distance λz/(∆x) over which one has the
ability to record near-ﬁeld fringes. Thus point-projection near-ﬁeld imaging is able to make use
of a greater fraction of partially coherent sources, such as today’s synchrotron light sources. At
the same time, if one does have full spatial coherence, the separation of subregions of the object
into separate experimental recordings (diffraction patterns from limited-size illumination spots)
gives reconstructions with better ﬁdelity even with a more relaxed imposition of regularizers.
Moreover, application of the proposed method to detection methods beyond X rays – for ex-
ample, broadband radiation used for atmospheric transmission (78) and seismology (79), might
also be exploited to better model the dynamic diffraction of waves propagating in complicated
media over long distances.

7 Conclusion

We have developed and demonstrated a novel 3D reconstruction algorithm for objects beyond
the depth-of-focus limit. The algorithm uses multislice propagation as the forward model, and
retrieve the RI map of the object by minimizing a loss function containing the squared differ-
ence between the amplitudes of the forward-propagated wavefront and the measured signals at
all viewing angles. We implemented the algorithm for both full-ﬁeld and ptychography imaging,
and compared them in terms of computation walltime and reconstruction ﬁdelity. Investigation
on the full-ﬁeld version allowed us to explore the constraint requirements for reconstructing of
bounded 3D objects with non-scanning imaging techniques, where sparsity and ﬁnite-support
constraints are used to ensure a successful reconstruction. Another novelty of our method lies
on the use of automatic differentiation, which not only prevents the laborious manual differen-
tiation involved in numerical optimization, but also makes the computational model extremely
adaptable and ﬂexible. Numerical studies of the algorithm using simulated objects indicate that
the proposed method is capable of recovering a thick object with high spatial resolution and
good accuracy. Further validation of the approach with experimental data will be our subse-

22

quent step, which would examine the capability of the method in handling noises and help us
identify practical challenges such as probe alignment (80). The ultimate goal is to combine the
algorithm with high-resolution imaging techniques, which, for full-ﬁeld imaging, could be the
point-projection microscopy. The combination of the two could potentially lead to the develop-
ment of a high-throughput pipeline for imaging thick samples.

8 Acknowledgement

This research used resources of the Advanced Photon Source and the Argonne Leadership Com-
puting Facility, which are U.S. Department of Energy (DOE) Ofﬁce of Science User Facilities
operated for the DOE Ofﬁce of Science by Argonne National Laboratory under Contract No.
DE-AC02-06CH11357. We thank the National Institute of Mental Health, National Institutes
of Health, for support under grant R01 MH115265.

References

1. H. Mimura, et al., Nature Physics 6, 122 (2010).

2. W. Chao, P. Fischer, T. Tyliszczak, S. Rekawa, Optics Express 20, 9777 (2012).

3. I. Mohacsi, et al., Scientiﬁc Reports 7, 43624 (2017).

4. S. Bajt, et al., Light: Science and Applications 7, e17162 (2018).

5. M. Born, E. Wolf, Principles of Optics (Cambridge University Press, Cambridge, 1999),

seventh edn.

6. Y. Wang, C. Jacobsen, J. Maser, A. Osanna, Journal of Microscopy 197, 80 (2000).

7. M. Eriksson, J. F. van der Veen, C. Quitmann, Journal of Synchrotron Radiation 21, 837

(2014).

8. L. Melchior, T. Salditt, Optics Express 25, 32090 (2017).

9. J. M. Cowley, A. F. Moodie, Acta Crystallographica 10, 609 (1957).

10. A. J. Devaney, Optics Letters 6, 374 (1981).

11. A. J. Devaney, Ultrasonic Imaging 4, 336 (1982).

12. A. M. Maiden, M. J. Humphry, J. M. Rodenburg, Journal of the Optical Society of America

A 29, 1606 (2012).

23

13. E. H. R. Tsai, I. Usov, A. Diaz, A. Menzel, M. Guizar-Sicairos, Optics Express 24, 29089

(2016).

14. M. A. Gilles, Y. S. G. Nashed, M. Du, C. Jacobsen, S. M. Wild, Optica 5, 1078 (2018).

15. Y. S. G. Nashed, T. Peterka, J. Deng, C. Jacobsen, Procedia Computer Science 108, 404

(2017).

16. S. Ghosh, Y. S. G. Nashed, O. Cossairt, A. Katsaggelos, 2018 IEEE International Confer-

ence on Computational Photography (ICCP) (IEEE, 2018), pp. 1–10.

17. S. Kandel, et al., Optics Express 0, 0 (2019).

18. G. Lovric, et al., Journal of Applied Crystallography 46, 1 (2013).

19. A. Shahbazi, et al., Scientiﬁc Reports 8, 1448 (2018).

20. B. Yu, et al., Optics Express pp. 1–15 (2018).

21. P. Barriobero-Vila, et al., Materials 10, 268 (2017).

22. M. Krenkel, et al., Scientiﬁc Reports 5, 1 (2016).

23. R. Mokso, P. Cloetens, E. Maire, W. Ludwig, J. Y. Bufﬁere, Applied Physics Letters 90,

144104 (2007).

24. F. C. Lussani, R. F. d. C. Vescovi, T. D. d. Souza, C. A. P. Leite, C. Giles, Review of

Scientiﬁc Instruments 86, 063705 (2015).

25. A. Groso, R. Abela, M. Stampanoni, Optics Express 14, 8103 (2006).

26. S. E. Hieber, et al., Scientiﬁc Reports 6, 32156 (2016).

27. A. Burvall, U. Lundstrom, P. A. C. Takman, D. H. Larsson, H. M. Hertz, Optics Express

19, 10359 (2011).

28. E. Wolf, Optics Communications 1, 153 (1969).

29. O. Haeberl´e, K. Belkebir, H. Giovaninni, A. Sentenac, Journal of Modern Optics 57, 686

(2010).

30. H. N. Chapman, et al., Journal of the Optical Society of America A 23, 1179 (2006).

31. W. Hoppe, Acta Crystallographica A 25, 495 (1969).

32. H. M. L. Faulkner, J. Rodenburg, Physical Review Letters 93, 023903 (2004).

24

33. J. Van Roey, J. van der Donk, P. E. Lagasse, Journal of the Optical Society of America 71,

803 (1981).

34. T. M. Godden, R. Suman, M. J. Humphry, J. M. Rodenburg, A. M. Maiden, Optics Express

22, 12513 (2014).

35. A. Suzuki, et al., Physical Review Letters 112, 053903 (2014).

36. H. ¨Ozt¨urk, et al., Optica 5, 601 (2018).

37. S. Gao, et al., Nature Communications 8, 163 (2017).

38. P. Li, A. Maiden, Scientiﬁc Reports 8, 2049 (2018).

39. G. Schmahl, D. Rudolph, X-ray Microscopy: Instrumentation and Biological Applications,

P. C. Cheng, G. J. Jan, eds. (Springer-Verlag, Berlin, 1987), pp. 231–238.

40. M. Dierolf, et al., Nature 467, 436 (2010).

41. M. Du, C. Jacobsen, Ultramicroscopy 184, 293 (2018).

42. B. L. Henke, E. M. Gullikson, J. C. Davis, Atomic Data and Nuclear Data Tables 54, 181

(1993).

43. U. S. Kamilov, et al., IEEE Transactions on Computational Imaging 2, 59 (2016).

44. U. S. Kamilov, et al., Optica 2, 517 (2015).

45. L. B. Rall, Automatic Differentiation: Techniques and Applications, vol. 120 (Springer

Berlin Heidelberg, Berlin, Heidelberg, 1981).

46. A. S. Jurling, J. R. Fienup, Journal of the Optical Society of America A 31, 1348 (2014).

47. J. Rodenburg, et al., Physical Review Letters 98, 034801 (2007).

48. P. Thibault, et al., Science 321, 379 (2008).

49. V. E. Cosslett, W. C. Nixon, Nature 168, 24 (1951).

50. P. Cloetens, et al., Applied Physics Letters 75, 2912 (1999).

51. K. Li, M. Wojcik, C. Jacobsen, Optics Express 25, 1831 (2017).

52. W. R. Klein, B. D. Cook, IEEE Transactions on Sonics and Ultrasonics 14, 123 (1967).

53. J. R. Fienup, Optics Letters 3, 27 (1978).

25

54. D. Paganin, S. C. Mayo, T. E. Gureyev, P. R. Miller, S. W. Wilkins, Journal of Microscopy

206, 33 (2002).

55. S. Marchesini, et al., Physical Review B 68, 140101 (2003).

56. Grasmair, Markus, Lenzen, Frank, Applied Mathematics & Optimization 62, 323 (2010).

57. M. Abadi, et al., CoRR cs.DC, arXiv:1603.04467 (2016).

58. A. Griewank, A. Walther, Evaluating Derivatives, Principles and Techniques of Algorith-
mic Differentiation (Society for Industrial and Applied Mathematics, 2008), second edn.

59. D. P. Kingma, J. Ba, 3rd International Conference on Learning Representations (San

Diego, 2015), pp. 1–15.

60. C. Jacobsen, Optics Letters 43, 4811 (2018).

61. H. M. Hudson, R. S. Larkin, IEEE Transactions on Medical Imaging 13, 601 (1994).

62. A. Sergeev, M. D. Balso, arXiv preprint arXiv:1802.05799 (2018).

63. D. J. Ching, D. G¨ursoy, Journal of Synchrotron Radiation 24, 537 (2017).

64. T. Schoonjans, et al., Spectrochimica Acta Part B: Atomic Spectroscopy 66, 776 (2011).

65. H. Peng, Z. Ruan, F. Long, J. H. Simpson, E. W. Myers, Nature Biotechnology 28, 348

(2010).

66. S. W. Wilkins, et al., Philosophical Transactions of the Royal Society of London A 372,

20130021 (2014).

67. W. O. Saxton, W. Baumeister, Journal of Microscopy 127, 127 (1982).

68. M. van Heel, M. Schatz, Journal of Structural Biology 151, 250 (2005).

69. X. Huang, et al., Optics Express 17, 13541 (2009).

70. J. Hagemann, T. Salditt, Journal of Applied Crystallography 50, 531 (2017).

71. J. Miao, D. Sayre, H. N. Chapman, Journal of the Optical Society of America A 15, 1662

(1998).

72. R. Hegerl, W. Hoppe, Zeitschrift f¨ur Naturforschung 31 a, 1717 (1976).

73. M. Howells, et al., Journal of Electron Spectroscopy and Related Phenomena 170, 4 (2009).

74. R. A. Crowther, D. J. DeRosier, A. Klug, Proceedings of the Royal Society of London A

317, 319 (1970).

26

75. W. Nixon, Proceedings of the Royal Society of London A 232, 475 (1955).

76. K. M. Sowa, B. R. Jany, P. Korecki, Optica 5, 577 (2018).

77. J. C. H. Spence, U. Weierstall, M. R. Howells, Ultramicroscopy 101, 149 (2004).

78. J. A. Rubio, A. Belmonte, A. Comer´on, Optical Engineering 38, 1462 (1999).

79. A. J. Devaney, IEEE Transactions on Geoscience and Remote Sensing 22, 3 (1984).

80. M. Guizar-Sicairos, J. R. Fienup, Optics Express 16, 7264 (2008).

27

