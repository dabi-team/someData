1
2
0
2

c
e
D
1

]
E
M

.
t
a
t
s
[

1
v
8
7
2
0
0
.
2
1
1
2
:
v
i
X
r
a

Synthetic Design: An Optimization Approach to

Experimental Design with Synthetic Controls∗

Nick Doudchenko†

Khashayar Khosravi†

Jean Pouget-Abadie

Sebastien Lahaie

Google Research

Google Research

Google Research

Google Research

Miles Lubin

Vahab Mirrokni

Jann Spiess

Guido Imbens

Google Research

Google Research

Stanford GSB

Stanford GSB

December 2, 2021

Abstract

We investigate the optimal design of experimental studies that have pre-treatment outcome

data available. The average treatment eﬀect is estimated as the diﬀerence between the

weighted average outcomes of the treated and control units. A number of commonly used

approaches ﬁt this formulation, including the diﬀerence-in-means estimator and a variety of

synthetic-control techniques. We propose several methods for choosing the set of treated units

in conjunction with the weights. Observing the NP-hardness of the problem, we introduce

a mixed-integer programming formulation which selects both the treatment and control

sets and unit weightings. We prove that these proposed approaches lead to qualitatively

∗We are grateful to Alberto Abadie, participants at the 2021 Conference on Digital Experimentation @ MIT

(CODE@MIT), the 2021 Design and Analysis of Experiments (DAE) conference and New Economic School

economics seminar, as well as the anonymous referees at NeurIPS 2021 for comments and suggestions.

†Equal contributions.

1

 
 
 
 
 
 
diﬀerent experimental units being selected for treatment. We use simulations based on

publicly available data from the US Bureau of Labor Statistics that show improvements in

terms of mean squared error and statistical power when compared to simple and commonly

used alternatives such as randomized trials.

1

Introduction

Randomized experiments have long been a staple of applied causal inference. In his seminal paper,

Rubin (1974) suggests that “given a choice between the data from a randomized experiment and

an equivalent nonrandomized study, one should choose the data from the experiment, especially

in the social sciences where much of the variability is often unassigned to particular causes.”

Using the language of Rubin’s potential-outcomes framework, randomization guarantees that

the treatment status is independent of the potential outcomes and that a simple and intuitive

estimator that compares the average outcomes of the treatment and control units is an unbiased

estimator of the average treatment eﬀect (ATE). If both the treatment and control samples are

suﬃciently large, the hope is that this diﬀerence-in-means estimate is close to the population

mean of the treatment eﬀect.

Another crucial property of randomized experimental designs is their robustness to alternative

assumptions about the data generating process—a completely randomized experiment does

not take into account any features of the observed data. Perhaps not surprisingly, when the

researchers are willing to incorporate additional probabilistic assumptions in their design decisions,

they can improve on the statistical properties of the average treatment eﬀect estimators (see, for

example, Kasy, 2016). These improvements, however, do not come for free and the performance

of the estimators may suﬀer if the incorporated assumptions are violated (Banerjee et al., 2020).

For these reasons randomized experiments are widely used in academic and clinical settings,

as well as industrial applications. However, not every practically important question can be

easily answered using an experiment on a large sample of experimental units. For instance, the

evaluation of major policies targeting large geographic areas has long been of interest in social

and political sciences. One of the traditional approaches is to compare the aﬀected unit—such as

2

a metropolitan area or a state—to the average across a sample of carefully picked control units

which are deemed to be suitable comparisons (Card, 1990). A more recent alternative, called

synthetic control, ﬁrst introduced by Abadie and Gardeazabal (2003) and later developed in

Abadie et al. (2010) and Abadie et al. (2015), compares the unit of interest to a weighted average

of the units unaﬀected by the treatment, where the weights are selected in a way that achieves a

good ﬁt on pre-treatment outcome variables as well as potentially other observed covariates.

While originally developed by academics for evaluating the eﬀects of policies, approaches

similar to the synthetic-control methodology have recently gained popularity in industry as well in

cases when applied researchers decide to run experiments targeting larger units often representing

geographic areas. This decision may be justiﬁed when more granular experiments are either

unavailable (for example, television advertising can only be targeted at the media-market level)

or are unlikely to capture the relevant eﬀects due to interference or equilibrium concerns (Sobel,

2006; Rosenbaum, 2007; Hudgens and Halloran, 2008). For instance, a company like Uber may

want to evaluate some of the possible treatments at the market level rather than at the driver

level if the treatment in question is likely to aﬀect the driver supply. Moreover, launching an

experiment targeting even a single unit may be so expensive that the researchers try to minimize

the required number of treated units. Privacy and fairness concerns may also make treatment

assignment at a more granular level problematic.

Synthetic control and similar approaches may be attractive as estimation procedures in

those cases, but they fail to address the equally if not more important aspect of the optimal

choice of experimental units (see, for example, Rubin et al., 2008). We attempt to narrow this

gap in the current paper. We consider a panel-data setting in which the researcher observes

the outcome metric of interest for a number of units in a number of time periods and has to

decide: (i) which units to experiment on and (ii) how to estimate the treatment eﬀects after

collecting the outcome data in the experimental time periods. The main diﬀerence between

this setting compared to a typical synthetic-control study is that the treated units are not

ﬁxed, but rather chosen by the researcher. Proving that the underlying optimization problem is

NP-hard, we rule out the possibility of designing polynomial-time algorithms for the problem

under P(cid:54)=NP. Therefore, we formulate this combined design-and-analysis problem as a mixed-

3

integer program (MIP). Depending on the particular estimands of interest, we propose one of the

several formulations and discuss their advantages and drawbacks. We motivate the choice of the

optimization objectives and discuss the selection of experimental units each of the objectives

leads to. The MIP formulation allows for an easy inclusion of additional constraints as long as

those are linear. For instance, it is easy to restrict the overall number of treated units, exclude

speciﬁc units from treatment, or enforce a budget constraint if there is a varying cost to treat

diﬀerent units.

Using publicly available state-level unemployment data from the US Bureau of Labor Statistics,

we compare the proposed methodology to a randomized design that utilizes either the conventional

diﬀerence-in-means estimator or the synthetic-control approach. We estimate the average as well

as individual state-level treatment eﬀects in a simulated experiment and ﬁnd that our approach

substantially reduces the root mean squared error (RMSE) of the estimates. We show that our

MIP-based design-and-analysis procedures consistently outperform the more traditional baselines

regardless of whether the treatment eﬀects are homogeneous or heterogeneous and whether the

number of units selected for treatment is small or large relative to the total number of units in

the sample. We also suggest a permutation-based inference procedure that follows Chernozhukov

et al. (2021). We verify in our simulations that this procedure leads to correct test sizes and

improved statistical power for testing the sharp null hypothesis of zero treatment aﬀects across

all treated units, when used in conjunction with the proposed estimators. We provide theoretical

guarantees—albeit under rather strong assumptions—which ensure that the proposed tests have

proper sizes.

To our knowledge, this is one of the ﬁrst papers to study experimental design in the context

of synthetic control and adjacent estimation techniques. Doudchenko et al. (2019) consider

the case when the underlying eﬀects are homogeneous and only a single unit can be treated;

they suggest searching for the unit that delivers the highest statistical power when testing the

hypothesis of zero treatment eﬀect with an artiﬁcially applied treatment. In an independent

work, Abadie and Zhao (2021) also consider optimal design in settings where synthetic-control

estimators are used for estimation. However, there are a few important aspects that diﬀerentiate

the current paper from theirs. First, Abadie and Zhao (2021) use both pre-treatment unit-level

4

covariates as well as the outcomes from some—but not necessarily all—of the pre-treatment

periods whereas we focus exclusively on the outcome variable and utilize all of the pre-treatment

outcome data. As a result, the inference procedure proposed by Abadie and Zhao (2021) does

not apply to our approach. Second, we discuss formal hardness results. Finally—and, perhaps,

most importantly—Abadie and Zhao (2021) choose an objective function that ﬁxes a priori the

target average treatment eﬀect, as either the population average treatment eﬀect or a weighted

version thereof. In contrast, the objective function we use focuses on the average treatment

eﬀect only for the units we choose for the treatment, making the target estimand stochastic, but

potentially easier to estimate and requiring diﬀerent assumptions.

The rest of the paper is organized as follows. Section 2 introduces the setting and the proposed

estimation approaches. Section 3 introduces the mixed-integer formulation of the suggested

estimators. Section 4 presents some of the theoretical unit-selection results and the intuition

behind them. Section 5 reports the empirical results obtained through simulations. Section 6

discusses some of the practical consideration that should accompany applied work that uses the

proposed methodology. Section 7 concludes and outlines the directions of future research.

2 Setting

Let the researcher observe the outcome metric of interest, Y , for N units during T time periods,

such that the observed data can be represented as an N × T matrix of values Yit. At time t = T

the researcher decides—based on the data observed up until that point—which units should

be treated and assigns a binary treatment described by variables Di ∈ {0, 1}, i = 1, . . . , N .

The outcomes are then observed for an additional S − T time periods t = T + 1, . . . , S and

the treatment-eﬀect estimates are constructed. Each unit i = 1, . . . , N in each time period

t = T + 1, . . . , S is associated with two potential outcomes (Yit(0), Yit(1)) which are considered

random. The potential outcome Yit(0) is realized if Di = 0 and Yit(1) is realized if Di = 1 so

that the observed outcome is Yit = Yit(Di) = Yit(0)(1 − Di) + Yit(1)Di.

Recall that, given a setting where a single unit i = N has received the treatment in a single

time period t = T + 1 = S, the synthetic-control literature (Abadie et al., 2010, among others)

5

suggests constructing a counterfactual estimate for unit N as a weighted average of the other
units’ observed outcomes: ˆYN,T +1(0) = (cid:80)N −1

i=1 wiYi,T +1. In the previous equation, the wi’s are
weights learned from the data observed during the pre-treatment periods t = 1, 2, . . . , T , often by
minimizing (cid:80)T
i=1 wiYit)2 under some constraints on the weights. Assuming that the
treatment eﬀect, τN , for this unit is additive, it can then be estimated as ˆτN = YN,T +1 − ˆYN,T +1(0).

t=1(YN t − (cid:80)N −1

We now consider a more general setting where K units have received the treatment, with

outcomes given by

Yit(0) = µit + εit

and Yit = Yit(0) + Diτi

with homoscedastic noise εit that has mean zero and variance σ2 and additive treatment eﬀects

τi. In order to estimate the treatment eﬀect in this more general setting, we can apply a separate

synthetic control method to each treated unit i, learning an appropriate set of weights {wi
each treated unit i individually: ˆYi,T +1(0) = (cid:80)
then estimated as ˆτi = Yi,T +1 − ˆYi,T +1(0).

jYj,T +1. The treatment eﬀect for unit i is

j : Dj =0 wi

j} for

Rather than considering each weight-ﬁtting optimization problem separately, we can express

the (conditional) mean squared error (MSE) of the resulting estimator of the treatment eﬀect as:

E (cid:2)(ˆτi − τi)2 (cid:12)

(cid:12){Dj, wi

j}N

j=1





2



(cid:3) =

µi,T +1 −

(cid:88)

wi

jµj,T +1



+ σ2

1 +

j : Dj =0



(cid:88)

(wi

j)2

 .

j : Dj =0

A proof is included in the supplementary materials. The synthetic-control literature often

operates in settings where the treated units are given. Here, we allow the experimenter to

select which units should receive the treatment. The mean-squared-error formula above leads

us to consider the following optimization problem over the weights {wi

j}N
i=1 under some appropriate constraints on the weights {wi

variables {Di}N

i,j=1 and the treatment
j}N

i,j=1. The objective

below can be seen as the empirical analog of the right-hand side of the population equation

above in the pre-treatment period averaged across time and across the treated units.

min
j }N

{Di,{wi

j=1}N

i=1

1
KT

N
(cid:88)

T
(cid:88)

i=1

t=1

(cid:32)

Di

Yit −

N
(cid:88)

j=1

wi

j(1 − Dj)Yjt

(cid:33)2

+

σ2
K

N
(cid:88)

N
(cid:88)

i=1

j=1

Di

(cid:1)2

(cid:0)wi

j

(per-unit)

6

Note that we can safely sum across all units, not just the control ones, in the second term since

the optimal values wi

j for units j with Dj = 1 will be equal to zero in an optimal solution.

In essence, this optimization problem attempts to minimize the discrepancy between the

pre-treatment outcomes of the units chosen for treatment and the weighted averages of the

outcomes of the units left as controls. At the same time, due to the second term, the objective

attempts to balance the unit weights themselves.

The term σ2 is unlikely to be known to the researcher and should be chosen based on the

observed data. One possible way is to set it equal to the sample variance of the observed outcomes.

We further discuss the selection of the penalty parameter in Section 6. Penalizing the weights

is not uncommon in the synthetic-control literature. For example, Doudchenko and Imbens

(2016) use the elastic-net penalty on the weights and Abadie and L’Hour (2021) introduce a

lasso-style penalty in which the nonnegative weight, wi

j, is multiplied by the squared distance

between the vectors of the covariates used for matching the units. This way, depending on the

magnitude of the penalty hyperparameter, they can balance between the synthetic-control ﬁt and

the nearest-neighbor ﬁt that puts all the weight on unit j closest to i in terms of the observed

covariates.

In many applications, the researcher may be interested in estimating some weighted average

of the unit-level treatment eﬀects on the treated units. Rather than considering each treated

unit separately and then computing the weighted average of the estimated individual treatment

eﬀects, practitioners may wish to construct a synthetic-control-type estimate for the weighed

average of the treated units directly.

Consider a set of treatment assignments {Di}N

i=1 and weights {wi}N

i=1 on outcomes at time

T + 1, and assume that we wish to estimate the weighted average treatment eﬀect on the
treated (wATET), τ = (cid:80)
i : Di=1 wiYi,T +1 − (cid:80)
(cid:80)

i=1 Diwiτi, as a diﬀerence in weighted means: ˆτ =
i : Di=0 wiYi,T +1. Then, under the same outcomes model as presented above,

i : Di=1 wiτi = (cid:80)N

the (conditional) mean squared error of the diﬀerence-in-(weighted)-means estimator is

E (cid:2)(ˆτ − τ )2 (cid:12)

(cid:12){Di, wi}N
i=1

(cid:3) =

(cid:32)

(cid:88)

i : Di=1

wiµi,T +1 −

(cid:88)

i : Di=0

(cid:33)2

wiµi,T +1

+ σ2

N
(cid:88)

i=1

w2
i .

As before, our setting allows the experimenter to optimally select which units should receive

7

the treatment as well as which particular weighting scheme should be used. This is especially

appropriate when the treatment eﬀects are homogeneous and τi = τ for all i = 1, . . . , N . In that

case, any weighted average of the unit-level treatment eﬀects is equal to τ and the weights can

be chosen in a way that minimizes the mean squared error.

The population equation above suggests solving the following optimization problem on the

weights {wi}N

i=1 and the treatment variables {Di}N

i=1 based on the data observed in periods

t = 1, . . . , T :

min
{Di,wi}N

i=1

1
T

(cid:32)

T
(cid:88)

(cid:88)

wiYit −

(cid:88)

(cid:33)2

wiYit

+ σ2

t=1

i : Di=1

i : Di=0

N
(cid:88)

i=1

w2
i .

(two-way global)

So far, we have not considered speciﬁc constraints on the weights, {wi}N

i=1. If σ2 > 0, wi = 0
for all i = 1, . . . , N is the unique optimal solution to the two-way global problem above if the

weights are not constrained in any way. In order to avoid this clearly undesirable solution, we

assume that the weights {wi}N

i : Di=0 wi = 1. While not
strictly required, another reasonable set of constraints motivated by estimating a proper weighted

i=1 are normalized: (cid:80)

i : Di=1 wi = (cid:80)

average is requiring all weights to be nonnegative, wi ≥ 0 for all i = 1, . . . , N .

Similar constraints can be imposed in the context of the per-unit problem: wi

j ≥ 0 for all

i, j = 1, . . . , N and (cid:80)

j : Dj =0 wi

j = 1 for all i = 1, . . . , N such that Di = 1.

Finally, the weights on the treated units may be ﬁxed if a speciﬁc weighted average—for

example, a simple average with equal weighting—needs to be estimated. This constraint is

particularly justiﬁed when the treatment eﬀects are heterogeneous and diﬀerent weighting schemes

lead to diﬀerent estimands. For that reason, we formulate another variation of the global problem:

min
{Di,wi}N

i=1

1
T

(cid:32)

T
(cid:88)

(cid:88)

wiYit −

(cid:88)

(cid:33)2

wiYit

+ σ2

t=1

i : Di=1

i : Di=0

N
(cid:88)

i=1

w2
i

(one-way global)

subject to an additional set of constraint that require wi = wj for all i, j = 1, . . . , N such that

Di = Dj = 1.

It is possible to obtain other design-and-estimation approaches as special cases of these

problems—something that we utilize later in the paper. For instance, the standard diﬀerence-

in-means approach under randomized design can be viewed as the special case of the one-way

global problem with the treatment indicators, Di, set randomly and the weights on the control

8

units restricted to be equal, wi = wj for all i, j = 1, . . . , N such that Di = Dj = 0. Likewise, the

synthetic-control estimator can be viewed as the per-unit problem with the treatment indicators

set according to the experimental design of choice—for example, randomly.

3 Mixed-integer formulation

The three optimization problems introduced in the ﬁrst part of Section 2: the per-unit, the

two-way global, and the one-way global problems can all be formulated as mixed-integer programs.

We now describe the speciﬁc optimization problems we use in the empirical section of the paper.

The per-unit problem is formulated as:

min
j }N

{Di,{wi

j=1}N

i=1

1
KT

N
(cid:88)

T
(cid:88)

i=1

t=1

(cid:32)

Di

Yit −

N
(cid:88)

j=1

wi

j(1 − Dj)Yjt

(cid:33)2

+

λ
K

N
(cid:88)

N
(cid:88)

i=1

j=1

Di

(cid:1)2

(cid:0)wi

j

s.t. wi

j ≥ 0, Di ∈ {0, 1} for i, j = 1, . . . , N,
N
(cid:88)

N
(cid:88)

Di = K,

wi

j(1 − Dj) = 1 for i = 1, . . . , N such that Di = 1.

i=1

i=1

The two-way global problem can be formulated as:

min
{Di,wi}N

i=1

1
T

T
(cid:88)

(cid:32) N
(cid:88)

t=1

i=1

wiDiYit −

N
(cid:88)

i=1

(cid:33)2

wi(1 − Di)Yit

+ λ

N
(cid:88)

i=1

w2
i

s.t. wi ≥ 0, Di ∈ {0, 1} for i = 1, . . . , N,

N
(cid:88)

i=1

Di = K,

N
(cid:88)

i=1

wiDi = 1,

N
(cid:88)

i=1

wi(1 − Di) = 1

and the one-way global problem is simply the two-way global problem with an additional set of

constraints: wi = wj for all i, j = 1, . . . , N such that Di = Dj = 1.

All three problems require additional auxiliary variables representing the products of the

weights and the treatment indicators as well as additional constraints in order to have a

representation with a quadratic objective and only linear constraints so that they can be easier

to solve by one of the academic or commercial MIP solvers.1 See the supplementary materials

for the exact formulations.

1We use SCIP (Gamrath et al., 2020) when generating the empirical results in Sections 4 and 5.

9

The term λ that is used in all three objectives is a nonnegative penalty factor. Its selection is

discussed in Section 6.

Note that the global versions of the problem can be solved without the constraint on the

number of treated units, (cid:80)N

i=1 Di = K, but the per-unit problem requires it—without the
constraint the per-unit problem will tend to select fewer treatment units unless the objective is
divided by (cid:80)N

i=1 Di which introduces a nonlinearity. See the supplementary materials where we
introduce an alternative formulation that allows to circumvent this by imposing an additional

quadratic constraint.

4 Design

The three optimization problems introduced in Section 2—the one-way and two-way global and

the per-unit problems—tend to select certain treatment units in terms of their location within

the distribution of the observed outcome data. In this section we illustrate that behavior using

a simple example motivated by the objectives from Section 2. To simplify the analysis, we let

T = 1 and denote ai = Yi1. We also do not restrict the unit weights to be nonnegative to allow

for simpler closed form solutions.2 Speciﬁcally, we consider the following per-unit problem:

min
j }N

{Di,{wi

j=1}N

i=1

1
K

N
(cid:88)

i=1

(cid:32)

Di

ai −

N
(cid:88)

j=1

wi

j(1 − Dj)aj

(cid:33)2

+

σ2
K

N
(cid:88)

N
(cid:88)

i=1

j=1

Di(wi

j)2

s.t Di ∈ {0, 1} for i, j = 1, . . . , N,

N
(cid:88)

i=1

Di = K,

N
(cid:88)

j=1

wi

j(1 − Dj) = 1 for i = 1, . . . , N.

2In some cases the nonnegativity constraint will not be binding, while in other cases the optimal weights

without the constraint may actually turn out to be negative. This implies that only a subset of all units will have

strictly positive weights in the optimal constrained solution.

10

A similarly simpliﬁed two-way global problem can be written as:

min
{Di,wi}N

i=1

(cid:32) N
(cid:88)

i=1

wiDiai −

N
(cid:88)

i=1

(cid:33)2

wi(1 − Di)ai

+ σ2

N
(cid:88)

i=1

w2
i

s.t Di ∈ {0, 1} for i, j = 1, . . . , N,

N
(cid:88)

i=1

Di = K,

N
(cid:88)

i=1

wiDi = 1,

N
(cid:88)

i=1

wi(1 − Di) = 1.

This becomes a one-way global problem if we impose an additional set of constraints requiring

that wi = 1/K for all i = 1, . . . , N such that Di = 1. When the unit weights are optimized (see

the supplementary materials for the derivation), the optimal values of the objectives can be

written in closed-form as functions of the set of treated units, I.

Theorem 1. Let I denote the set of treated units and ¯I = {1, . . . , N } \ I denote the set
of control units. Let aI = (cid:80)
i∈I ai/|I| be the average outcome within the treatment group,
I = (cid:80)
V 2
i∈I(ai − aI)2 a quantity proportional to the sample variance of the outcomes within the
treatment group, and the corresponding quantities for set ¯I deﬁned similarly. After the unit

weights are optimized away, the per-unit objective can be written as:

Jper-unit(I) = σ2

(cid:18) 1

N − K

+

(aI − a ¯I)2 + K −1V 2
I
σ2 + V 2
¯I

(cid:19)

,

the two-way global objective can be written as:

J2-way(I) = σ2

(cid:18) 1
K

+

1
N − K

+

(aI − a ¯I)2

σ2 + V 2

I + V 2
¯I

(cid:19)

,

and the one-way global objective can be written as:

J1-way(I) = σ2

(cid:18) 1
K

+

1
N − K

+

(aI − a ¯I)2
σ2 + V 2
¯I

(cid:19)

.

It is evident from the objectives that all problems aim to select units in such a way that

averages of the observed outcomes for the treatment and control groups are similar—the squared

diﬀerence between the average outcomes within each group appears in the numerators of all

three objectives. The problems diﬀer in terms of how they approach the sample variances of

the two groups. The per-unit problem maximizes the sample variance of the control units while

11

minimizing that of the treated units—the term V 2

¯I appears in the denominator while the term
V 2
I appears in the numerator. The intuition for the latter is that the per-unit objective tries

to simultaneously model each treated unit with a combination of control units, while keeping

weight variance small, so it is best to keep treated units as homogeneous as possible. The

two-way problem attempts to maximize both (taking into account that they are, of course,

interdependent), the sample variances of the outcomes of the control and treated groups—both

quantities appear in the denominator. The one-way problem maximizes the sample variance of

the outcomes of the control units only, as the weights for the treated units are ﬁxed—only the

term V 2

¯I appears in the denominator.

To illustrate the same patterns visually, we solve a per-unit problem and a two-way global

problem for a simulated dataset with N = 25 units, T = 2 pre-treatment periods and the

outcomes Yit drawn from a standard normal distribution independently across i and t. This

allows 2-d plotting of the units in the space of observed pre-treatment outcomes (Yi1, Yi2). We
select either K = 3 or K = 25 − 3 = 22 treated units and we use λ = (cid:80)N
i=1(Yi1 − Yi2)2/(4N )
(which is the average two-period sample variance across all units). Figure 1 shows the units

selected by each of the problems.

The results align with the intuition presented using the simple model with T = 1 above.

Speciﬁcally, the per-unit problem maximizes the spread of the control units which is particularly

apparent from the plot corresponding to K = 22 while keeping the treatment units as close

to each other as possible (see the plot for K = 3). Since the control and the treatment units

have symmetric roles in the two-way global objective, the three treatment units selected by the

problem when K = 3 are the same as the three control units selected when K = 22. The control

and treatment groups have similar average outcomes and both groups are relatively spread out.

5 Empirical results

To evaluate the performance of the methods proposed in Section 2 we compare several design-

and-estimation procedures: (i) the per-unit problem, (ii) the two-way global problem, (iii) the

one-way global problem, (iv) the per-unit problem with randomly chosen treatment units, and

12

(a) per-unit problem, K = 3

(b) per-unit problem, K = 22

(c) two-way global problem, K = 3

(d) two-way global problem, K = 22

Note: The units are plotted in the space of observed pre-treatment outcome data, (Yi1, Yi2); ‘o’ denote

the selected control units and ‘+’ denote the selected treatment units.

Figure 1: Units selected by the two-way global and per-unit problems.

13

Yi1Yi2Yi1Yi2Yi1Yi2Yi1Yi2(v) the standard randomized experiment which randomly assigns the treatment and estimates the

average treatment eﬀect on the treated as the diﬀerence in means between the two groups. It is

important to note that approach (iv) is equivalent to using the synthetic-control method3 for each

randomly chosen treatment unit separately and then either averaging the unit-level treatment

eﬀect estimates or using the individual estimates directly. Taking this into account, comparing

(i) to (iv) amounts to evaluating the role of optimal design in a synthetic-control study, while

comparing (iv) to (v) evaluates the synthetic-control approach relative to the diﬀerence-in-means

estimator.

To run a number of simulated experiments, we take publicly available data from the US

Bureau of Labor Statistics (BLS) which contain unemployment rates of 50 states in 40 consecutive

months.4 We run 500 simulations such that each simulation utilizes a 10-by-10 matrix sampled

from the original 50-by-40 dataset. Speciﬁcally, we randomly select 10 units and the ﬁrst time

period. The remaining 9 time periods are the consecutive months that follow. In each simulation

we treat K units (equal to 3 in one set of simulations and 7 in another) which are chosen based

on the data in the ﬁrst 7 periods—or chosen randomly in cases (iv) and (v)—and the treatment is

applied in the last 3 of the 10 periods. We either assign each treated unit the additive treatment

eﬀect of 0.05 (the homogeneous treatment case) or assume that the treatment eﬀects increase

linearly from 0 to 0.1 from the ﬁrst unit in the (randomly selected) 10-by-10 matrix to the

last one (the heterogeneous treatment case). This implies that the true value of the ATET

changes depending on the identity of the units selected for treatment. However, the (overall)

ATE remains 0.05.

We estimate the average treatment eﬀect on the treated as well as the unit-level treatment

eﬀects. Only the per-unit problem, (i), and the synthetic control, (iv), allow for nontrivial

estimation of heterogeneous treatment eﬀects while the remaining approaches estimate all

unit-level eﬀects as being equal to the estimate of the average treatment eﬀect on the treated.

3The only diﬀerence compared to the traditional synthetic-control methodology used, for example, in Abadie

et al. (2010) is that no additional covariates are used and the weights are obtained using the outcome data

alone—the approach similar to the one taken in, for instance, Doudchenko and Imbens (2016).

4The data are available from the BLS website, but the speciﬁc dataset we use is taken from https://github.

com/synth-inference/synthdid/blob/master/experiments/bdm/data/urate_cps.csv.

14

We then compare approaches (i)–(v) in terms of the root-mean-square error (RMSE), where

the squared diﬀerences between the true values of the treatment eﬀects and the respective

estimates are computed for each treatment period (and each treatment unit in case of the

unit-level eﬀects) and averaged. The square roots of these quantities are the RMSE’s in question.

Table 1 reports the RMSE’s averaged across all simulations.

The speciﬁc improvements in terms of the RMSE over the baselines (iv) and (v)—the

randomized synthetic control and the randomized diﬀerence-in-means—depend on the data

and the true treatment eﬀects. The main takeaways, however, are more general. The per-unit

problem consistently outperforms the other methods when the underlying treatment eﬀects are

heterogeneous. For homogeneous treatment eﬀects the diﬀerence between the per-unit and the

global problems either vanishes, or the two-way approach starts outperforming the alternatives

since any weighting scheme leads to the same value of the ATET. Moreover, in the homogeneous

treatment case the global problems always outperform the baselines when estimating the average

treatment eﬀect on the treated.

For the particular simulations we run, the one-way and two-way global objectives provide

improvements over the baselines that vary from 12% to 31% in the homogeneous treatment

case and from 11% to 30% in the heterogeneous treatment case when estimating the average

treatment eﬀect on the treated. The per-unit approach, (i), performs well across the board while

being particularly eﬀective when estimating the unit-level eﬀects in the heterogeneous treatment

case and providing an improvement of over 13% relative to the synthetic control approach, (iv),

when the number of treated units is small and 16% when the number of treated units is large. It

is not surprising that the per-unit problem provides a smaller improvement over the synthetic

control when K = 3 because in that case the donor pool of units that are used for comparison

with the treated units is large relative to the overall number of units and the probability that we

will not be able to ﬁnd a good synthetic comparison is relatively low. The situation is diﬀerent

when we only have 3 control units that are used for constructing synthetic outcomes for the

remaining 7 treatment units. Section 4 provides an additional discussion of the optimal design

when the number of treatment units changes. Neither is surprising that the per-unit approach

performs poorly relative to the global problems and even the randomized diﬀerence-in-means

15

Table 1: Root-mean-square errors of the average and unit-level treatment eﬀect estimates

Homogeneous treatment

K = 3

K = 7

ATET RMSE Unit-level RMSE ATET RMSE Unit-level RMSE

(i) Per-unit

(ii) Two-way global

(iii) One-way global

(iv) Synthetic control

(random treat.)

8.5

8.4

8.5

9.7

(v) Diﬀ-in-means

12.1

(random treat.)

Heterogeneous treatment

13.9

8.4

8.5

15.9

12.1

8.3

8.4

8.5

10.3

11.5

16.0

8.4

8.5

19.0

11.5

K = 3

K = 7

ATET RMSE Unit-level RMSE ATET RMSE Unit-level RMSE

(i) Per-unit

(ii) Two-way global

(iii) One-way global

(iv) Synthetic control

(random treat.)

8.5

8.6

8.5

9.7

(v) Diﬀ-in-means

12.1

(random treat.)

13.9

27.6

27.6

15.9

29.7

8.3

8.9

8.5

10.3

11.5

16.0

32.5

32.5

19.0

33.6

Note: The reported RMSE’s are multiplied by 103 for readability. The values in bold are the lowest in

the respective columns and correspond to the methods that perform best.

16

estimator (but not the synthetic control) when estimating unit-level eﬀects in the homogeneous

treatment case. Since all treatment eﬀects are the same, it is more eﬃcient to pool all the data

together and estimate the constant eﬀect on the full sample rather than estimating the same

quantity for each unit individually. What is important though, is the robustness of the per-unit

approach which provides similar performance in the case of either homogeneous or heterogeneous

treatment eﬀects while the global problems and the randomized diﬀerence-in-means perform

poorly when estimating unit-level eﬀects in the heterogeneous treatment case.

6 Practice

There are a number of practical considerations that need to be addressed when using the proposed

design and analysis approaches.

Formulating the mixed-integer programs. Both the per-unit problem and the global

problems can be formulated as mixed-integer programs with quadratic objectives and linear

constraints. As discussed in Section 2, the per-unit problem requires either an additional linear

constraint that ﬁxes the number of treated units, K, or an additional quadratic constraint that

allows optimizing over the number of treated units. In addition to that, the per-unit problem

uses more variables that need to be optimized since sets of weights vary across treatment units

allowing separate estimation of every unit-level treatment eﬀect. This implies that the per-unit

problem is generally harder to solve and is only tractable for a smaller number of experimental

units, N , compared to the global problems.

Choosing the penalty factor. The penalty factor, λ, used by all of the optimization problems

can be chosen using cross-validation. Speciﬁcally, the pre-treatment time periods can be split

into the consecutive training and validation time periods and the value of λ can be chosen by

minimizing the RMSE over the validation period in a simulated experiment that is similar to

the one we conduct in Section 5. An alternative approach motivated by the setting in Section 2

uses an estimate of the variance of the outcome variable. For example, the approach we take

in Sections 4 and 5 computes the sample variances for every unit i across pre-treatment time

17

periods t = 1, . . . , T and then uses the average of those quantities across all units as the penalty

factor, λ.

Quantifying the uncertainty. Most applied settings require evaluating the uncertainty in

the obtained estimates of the treatment eﬀects. We suggest the permutation-based approach for

testing the sharp null hypothesis of zero treatment eﬀects across all treated units proposed by

Chernozhukov et al. (2021). See the supplementary materials for the detailed description of the

proposed inference procedure as well as a theoretical result that guarantees its validity—albeit

under rather strong assumptions—and the power curves constructed using a simulated setting

similar to that from Section 5. When the proposed procedure is used in conjunction with the

per-unit or global problems it provides the correct (or conservative) test sizes and improves the

power relative to the synthetic-control and diﬀerence-in-means approaches.

Computational complexity. Solving the global and the per-unit problems in their mixed-

integer formulations becomes computationally burdensome as the total number of units increases,

especially if the exact optimal solutions are required. In our simulations we were able to solve

problems for N = 50 units—which is a meaningful threshold corresponding to the number of

states, a typical experimental unit in synthetic-control-type studies—on a single machine within

hours. However, we prove that the underlying optimization problem is NP-hard (by providing a

reduction to the partitioning problem; for the exact proof see the supplementary materials), and

therefore exact solutions to substantially larger problems are unlikely.

7 Conclusion

In this paper we evaluate the role of optimal experimental design in panel-data settings where

traditionally the average treatment eﬀect on the treated might be estimated using randomized

design and the diﬀerence-in-means estimator. We propose several design-and-analysis procedures

that can be solved as mixed-integer programs. Our empirical evaluations show that these

procedures lead to a substantial improvement in terms of the root-mean-square error relative to

the randomized diﬀerence-in-means as well as the randomized synthetic-control approaches.

18

We discuss the roles that underlying assumptions about the nature of the treatment eﬀects,

the estimands of interest, and the computational considerations play when deciding which

approach should be used. We propose a permutation-based inference procedure that is shown

to deliver the correct test sizes in simulations. We also discuss practical considerations when

applying this methodology as well as its current limitations.

References

Abadie, A., A. Diamond, and J. Hainmueller (2010). Synthetic control methods for comparative

case studies: Estimating the eﬀect of california’s tobacco control program. Journal of the

American statistical Association 105 (490), 493–505.

Abadie, A., A. Diamond, and J. Hainmueller (2015). Comparative politics and the synthetic

control method. American Journal of Political Science 59 (2), 495–510.

Abadie, A. and J. Gardeazabal (2003). The economic costs of conﬂict: A case study of the

basque country. American Economic Review 93 (1), 113–132.

Abadie, A. and J. L’Hour (2021). A penalized synthetic control estimator for disaggregated data.

Journal of the American Statistical Association (just-accepted), 1–34.

Abadie, A. and J. Zhao (2021). Synthetic controls for experimental design. arXiv preprint

arXiv:2108.02196 .

Banerjee, A. V., S. Chassang, S. Montero, and E. Snowberg (2020). A theory of experimenters:

Robustness, randomization, and balance. American Economic Review 110 (4), 1206–30.

Bottmer, L., G. Imbens, J. Spiess, and M. Warnick (2021). A design-based perspective on

synthetic control methods. arXiv preprint arXiv:2101.09398 .

Card, D. (1990). The impact of the mariel boatlift on the miami labor market. ILR Review 43 (2),

245–257.

19

Chernozhukov, V., K. Wüthrich, and Y. Zhu (2021). An exact and robust conformal infer-

ence method for counterfactual and synthetic controls. Journal of the American Statistical

Association, 1–16.

Cieliebak, M., S. J. Eidenbenz, A. Pagourtzis, and K. Schlude (2008). On the complexity of

variations of equal sum subsets. Nord. J. Comput. 14 (3), 151–172.

Doudchenko, N., D. Gilinson, S. Taylor, and N. Wernerfelt (2019). Designing experiments with

synthetic controls. Working paper .

Doudchenko, N. and G. W. Imbens (2016). Balancing, regression, diﬀerence-in-diﬀerences and

synthetic control methods: A synthesis. Technical report, National Bureau of Economic

Research.

Gamrath, G., D. Anderson, K. Bestuzheva, W.-K. Chen, L. Eiﬂer, M. Gasse, P. Gemander,

A. Gleixner, L. Gottwald, K. Halbig, G. Hendel, C. Hojny, T. Koch, P. Le Bodic, S. J. Maher,

F. Matter, M. Miltenberger, E. Mühmer, B. Müller, M. E. Pfetsch, F. Schlösser, F. Serrano,

Y. Shinano, C. Tawﬁk, S. Vigerske, F. Wegscheider, D. Weninger, and J. Witzig (2020, March).

The SCIP Optimization Suite 7.0. Technical report, Optimization Online.

Hudgens, M. G. and M. E. Halloran (2008). Toward causal inference with interference. Journal

of the American Statistical Association 103 (482), 832–842.

Kasy, M. (2016). Why experimenters might not always want to randomize, and what they could

do instead. Political Analysis 24, 324–338.

Rosenbaum, P. R. (2007). Interference between units in randomized experiments. Journal of the

American Statistical Association 102 (477), 191–200.

Rubin, D. B. (1974). Estimating causal eﬀects of treatments in randomized and nonrandomized

studies. Journal of Educational Psychology 66 (5), 688.

Rubin, D. B. et al. (2008). For objective causal inference, design trumps analysis. Annals of

Applied Statistics 2 (3), 808–840.

20

Sobel, M. E. (2006). What do randomized studies of housing mobility demonstrate? causal

inference in the face of interference. Journal of the American Statistical Association 101 (476),

1398–1407.

21

A Supplementary materials

A.1 Conditional MSE of the treatment eﬀect estimator

The expression for the conditional mean squared error used in Section 2 can be derived as follows.

First, for a treated unit i,

E (cid:2)(ˆτi − τi)2 (cid:12)

(cid:12){Dj, wi

j}N

j=1

(cid:3) = var (cid:0)ˆτi

(cid:12)
(cid:12){Dj, wi

j}N

j=1

(cid:1) + (cid:0)E (cid:2)ˆτi − τi

(cid:12)
(cid:12){Dj, wi

j}N

j=1

(cid:3)(cid:1)2

.

Next,

ˆτi − τi = Yi,T +1 −

(cid:88)

j : Dj =0

wi

jYj,T +1 − τi

= µi,T +1 + τi + εi,T +1 −

(cid:88)

wi

j(µj,T +1 + εj,T +1) − τi



=

µi,T +1 −

(cid:88)

j : Dj =0

j : Dj =0




wi

jµj,T +1

 +

εi,T +1 −



wi

jεj,T +1

 .

(cid:88)

j : Dj =0

Treating ε’s as the only source of randomness in the above expression and assuming that

they are independent across units,

(cid:12)
(cid:12){Dj, wi

j}N

j=1

var (cid:0)ˆτi

and

(cid:1) = σ2 +

(cid:88)

(cid:0)wi

j

(cid:1)2 σ2

j : Dj =0





2

(cid:0)E (cid:2)ˆτi − τi

(cid:12)
(cid:12){Dj, wi

j}N

j=1

(cid:3)(cid:1)2

=

µi,T +1 −

(cid:88)

wi

jµj,T +1



j : Dj =0

which lead to the equation in Section 2.

Similarly, for another ATET estimator ˆτ = (cid:80)

i : Di=1 wiYi,T +1 − (cid:80)

i : Di=0 wiYi,T +1:

ˆτ − τ =

(cid:88)

wiYi,T +1 −

wiYi,T +1 − τ

(cid:88)

i : Di=0

(cid:88)

i : Di=0

i : Di=1
(cid:32)

(cid:88)

=

wiµi,T +1 −

i : Di=1
(cid:88)

+

i : Di=1

wiτi − τ

(cid:33)

(cid:32)

wiµi,T +1

+

(cid:88)

wiεi,T +1 −

(cid:88)

wiεi,T +1

i : Di=1

i : Di=0

(cid:33)

22

and, assuming that we are estimating τ = (cid:80)

i : Di=1 wiτi, we arrive at the conditional mean
squared error formula from Section 2 using the same logic as we used for the unit-level treatment

eﬀects.

It is important to point out that unless this assumption about the average treatment eﬀect of

interest is made, another term,

(cid:32)

(cid:88)

i : Di=1

(cid:33)2

wiτi − τ

,

remains as part of the MSE. In the current paper we make no claims about this term apart from

the case when the treatment eﬀects are homogeneous and the term vanishes.

Empirical analogs. The empirical analogs of the population-level equations above were

presented in Section 2. While we do not provide any theoretical guarantees for the estimators

obtained as solutions to the corresponding optimization problems, there are two types of

assumptions that are likely necessary for a formal result. First, those that guarantee that

the weights obtained based on the pre-treatment data provide good approximations for the

counterfactual outcomes in the treatment periods—these types of assumptions are typically used

in the synthetic-control literature, such as the assumption that the underlying data generating

process is described by a latent factor model (e.g. Abadie et al., 2010), or the assumption that

treatment periods are themselves chosen at random and are thus comparable to the control

periods (Bottmer et al., 2021, e.g.). Second, those that guarantee that the average is a good

approximation of the corresponding conditional expectation which are likely satisﬁed when T

goes to inﬁnity.

A.2 Exact mixed-integer formulations

In this section we present the exact mixed-integer programming formulations that can be used

for solving the proposed models in one of the available academic or commercial solvers. We use

SCIP (Gamrath et al., 2020) which can handle mixed-integer nonlinear programs (MINLP’s)

with constraints that can be written as “expressions” with certain operations. It is preferable,

23

however, that the constraints are quadratic or linear.5

Note that a general nonlinear objective f (x) can be replaced by a linear objective y with an

auxiliary variable y and an additional constraint y ≥ f (x) (for a minimization problem).

Per-unit problem. The per-unit problem was formulated as

min
j }N

{Di,{wi

j=1}N

i=1

1
K

N
(cid:88)

i=1



Di



1
T

(cid:32)

T
(cid:88)

t=1

Yit −

N
(cid:88)

j=1

(cid:33)2

wi

j(1 − Dj)Yjt

+ λ





(cid:1)2

(cid:0)wi

j

N
(cid:88)

j=1

s.t. wi

j ≥ 0, Di ∈ {0, 1} for i, j = 1, . . . , N,
N
(cid:88)

Di = K,

i=1
N
(cid:88)

i=1

wi

j(1 − Dj) = 1 for i = 1, . . . , N such that Di = 1

which can be rewritten by introducing auxiliary variables qij = wi

j(1 − Dj) for i, j = 1, . . . , N

with a few additional constraints. Speciﬁcally, we impose qij ≥ 0, qij ≤ 1 − Dj, qij ≤ wi

j, and

qij ≥ wi

j − Dj. Indeed, when Dj = 1, qij has to be equal to 0 given the constraints qij ≥ 0 and

qij ≤ 1 − Dj = 0 while the constraints qij ≤ wi

j and qij ≥ wi

j − Dj = wi

When Dj = 0, on the other hand, qij has to be equal to wi

j since qij ≤ wi

j − 1 are non-binding.
j − Dj = wi
j

j and qij ≥ wi

while qij ≤ 1 − Dj = 1 and qij ≥ 0 are non-binding.

We need two additional observations to formulate the problem as a quadratic objective with

linear constraints. First, since Di ∈ {0, 1}, D2

i = Di and therefore Di’s can be carried inside the

parentheses. Second, wi

j need to be able to take nonzero values only for such i’s that have Di = 1.

By imposing additional constraints wi

j ≤ Di for i, j = 1, . . . , N we can use wi

j instead of wi

jDi.

By utilizing an additional set of auxiliary variables, zit, the per-unit problem can be written

5See https://www.scipopt.org/doc/html/FAQ.php#minlptypes for more details.

24

as

{Di,{wi

j ,qij }N

min
j=1,{zit}T

t=1}N

i=1

1
KT

N
(cid:88)

T
(cid:88)

i=1

t=1

z2
it +

λ
K

N
(cid:88)

N
(cid:88)

i=1

i=1

(cid:1)2

(cid:0)wi

j

qij ≥ 0, Di ∈ {0, 1} for i, j = 1, . . . , N,

s.t. wi

j ≥ 0,
N
(cid:88)

Di = K,

i=1
N
(cid:88)

j=1

qij = Di

for i = 1, . . . , N,

qij ≤ 1 − Dj,

qij ≤ wi
j,

qij ≥ wi

j − Dj

for i, j = 1, . . . , N,

wi

j ≤ Di

for i, j = 1, . . . , N,

zit = YitDi −

N
(cid:88)

j=1

qijYjt

for i = 1, . . . , N and t = 1, . . . , T

which has a quadratic objective with a positive semi-deﬁnite Hessian and linear constraints.

The constraint on the number of treated units, (cid:80)N

i=1 Di = K, can be removed from the per-unit
problem too if we recall the technique used for formulating general nonlinear objectives. Suppose
(cid:1) /K. Let us introduce
that the objective written above is denoted as f (cid:0){{wi
(cid:1)
an auxiliary variable y and two additional constraints: y (cid:80)N
(which is quadratic as long as f is quadratic) and (cid:80)N

t=1}N
i=1
i=1 Di ≥ f (cid:0){{wi

i=1 Di ≥ 1 which ensures that we are not

j=1, {zi}T

j=1, {zi}T

t=1}N
i=1

j}N

j}N

normalizing by zero in the objective that we are actually trying to minimize.

Two-way global problem. The two-way global problem was formulated in the following way

in the main part of the paper:

min
{Di,wi}N

i=1

1
T

T
(cid:88)

(cid:32) N
(cid:88)

t=1

i=1

wiDiYit −

N
(cid:88)

i=1

(cid:33)2

wi(1 − Di)Yit

+ λ

N
(cid:88)

i=1

w2
i

s.t. wi ≥ 0, Di ∈ {0, 1} for i = 1, . . . , N,

N
(cid:88)

i=1
N
(cid:88)

i=1

Di = K,

wiDi = 1,

N
(cid:88)

i=1

wi(1 − Di) = 1

25

This can be rewritten in a slightly diﬀerent way that utilizes auxiliary variables zt, qi = wiDi

and the constraints similar to those used for the per-unit problem:

min

{Di,wi,qi}N

i=1, {zt}T

t=1

1
T

T
(cid:88)

t=1

z2
t + λ

N
(cid:88)

i=1

w2
i

s.t. wi ≥ 0,

qi ≥ 0, Di ∈ {0, 1} for i = 1, . . . , N,

N
(cid:88)

i=1
N
(cid:88)

i=1

Di = K,

qi = 1,

N
(cid:88)

i=1

wi = 2,

qi ≤ Di,

qi ≤ wi,

qi ≥ wi − (1 − Di) for i = 1, . . . , N,

N
(cid:88)

(2qi − 1)Yit

zt =

i=1

for t = 1, . . . , T,

where the inequality constraints on variables qi enforce the nonlinear equality constraints

qi = wiDi.

The problem above has a quadratic objective with a positive semi-deﬁnite (diagonal, in fact)

Hessian and linear constraints.

Note that the constraint on the number of treated units, (cid:80)N

i=1 Di = K, can be safely removed

without complicating any of the other constraints.

One-way global problem.

i=1 Di = K, is
imposed, the problem above becomes the one-way global problem as soon as we impose additional

If the constraint on the number of treated units, (cid:80)N

constraints

qi =

Di
K

for i = 1, . . . , N.

Indeed, both sides are equal to zero when Di = 0 and when Di = 1 the constraint is equivalent

to wi = 1/K.

The problem becomes more complicated when there is no constraint on the number of treated

units. We want to impose

qi =

Di
j=1 Dj

(cid:80)N

for i = 1, . . . , N

26

which are nonlinear.6 These constraints can be rewritten as linear by multiplying both sides

by the denominator of the right-had side and introducing additional variables rij = qiDj for

i, j = 1, . . . , N and enforcing this equality in the same way that we used for qi = wiDi. This,

however, substantially increases the number of required variables from O(N ) to O(N 2).

A.3 Proof of Theorem 1

In this section we provide a proof of Theorem 1. To derive the formulas presented in this theorem,

we solve for the optimal set of weights in each optimization problem. We will start with the

proofs for the two- and one-way global problems which are then utilized in the proof for the

per-unit problem.

Two-way global problem.

In this case, we can deﬁne the Lagrangian of the relaxed objective—

recall that we allowed weights to be negative—as follows:

L(w, λ1, λ2) =





(cid:88)

i∈I

aiwi −

(cid:88)

j∈ ¯I



2

ajwj



+ σ2

n
(cid:88)

i=1

w2

i − λ1

(cid:32)

(cid:88)

i∈I

(cid:33)



wi − 1

− λ2





wj − 1

 .

(cid:88)

j∈ ¯I

Taking a derivative with respect to wl where l ∈ I and equating it to zero gives us

∂L(w, λ1, λ2)
∂wl



= 2al



(cid:88)

i∈I

aiwi −

(cid:88)

j∈ ¯I


 + 2σ2wl − λ1 = 0.

ajwj

Similarly, for l ∈ ¯I we have:


∂L(w, λ1, λ2)
∂wl

= 2al



(cid:88)

j∈ ¯I

ajwj −

(cid:88)

i∈I


 + 2σ2wl − λ2 = 0.

aiwi

(1)

(2)

These equations together with (cid:80)

j∈ ¯I wj = 1 lead to a (linear) system of equations
with N + 2 variables which can be solved. We claim that the solution to this system is given by:

i∈I wi = 1 and (cid:80)

w∗

l =

1
K

+

w∗

l =

1
N − K

−

(¯aI − ¯a ¯I)(¯aI − al)

σ2 + V 2

I + V 2
¯I
(¯aI − ¯a ¯I)(¯a ¯I − al)

σ2 + V 2

I + V 2
¯I

for l ∈ I,

for l ∈ ¯I .

6We do not need to worry about (cid:80)N

j=1 Dj = 0 which is ruled out by other constraints.

27

It is easy to show that (cid:80)

l∈I w∗

l = (cid:80)

l∈ ¯I w∗

l = 1. Now it remains to show that for a suitable

choice of λ1 and λ2, Eq. (1) and (2) are satisﬁed. For any l ∈ I, we can write



2al

(cid:88)



aiwi −

i∈I

(cid:88)

j∈ ¯I


 + 2σ2wl

ajwj



= 2al (¯aI − ¯a ¯I)

1 +

1
I + V 2
σ2 + V 2
¯I
(cid:19)





(cid:88)

(¯aI − ai)ai +

i∈I

.





(¯a ¯I − aj)aj





(cid:88)

j∈ ¯I

+ 2σ2

(cid:18) 1
K

+

(¯aI − ¯a ¯I)(¯aI − al)

σ2 + V 2

I + V 2
¯I

For simplicity, denote ¯aI − ¯a ¯I = A and σ2 + V 2

I + V 2

¯I = B. Then, noting that

(cid:88)

(¯aI − ai)ai = −V 2
I ,

i∈I
(cid:88)

j∈ ¯I

(¯a ¯I − aj)aj = −V 2
¯I ,

the above is equal to:

(cid:18)

2alA

1 −

(cid:19)

I + V 2
V 2
¯I
B

+

2σ2
K

+

(2σ2A)(¯aI − al)
B

= 2σ2

which is independent of the index l. In particular, if we let

λ1 = 2σ2

(cid:18) 1
K

+ ¯aI

(cid:19)

,

A
B

+

2σ2A
B

¯aI − 2alA

σ2
B

= 2alA(

) +

σ2
B
(cid:18) 1
K

2σ2
K
A
B

(cid:19)

+ ¯aI

then for all l ∈ I, the condition in Eq. (1) is satisﬁed. Similarly, it can be shown that for

λ2 = 2σ2

(cid:18) 1

N − K

− ¯a ¯I

(cid:19)

,

A
B

28

Eq. (2) is satisﬁed for all l ∈ ¯I. Given the computed sets of weights, we can now calculate the

optimal objective value as follows:

J2-way(I) =





(cid:88)

i∈I

aiw∗

i −

(cid:88)

j∈ ¯I



2

ajw∗
j



+ σ2



= (¯aI − ¯a ¯I)2

1 +

1
I + V 2
σ2 + V 2
¯I

2

w∗
i

n
(cid:88)

i=1


(cid:88)



(¯aI − ai)ai +

i∈I





2

(¯aI − aj)aj





(cid:88)

j∈ ¯I

1
K

+

(cid:88)

(¯aI − ¯a ¯I)2(¯aI − ai)2

(cid:33)

(σ2 + V 2

I + V 2

¯I )2

i∈I

(cid:32)





+ σ2

+ σ2

1
N − K

+

= σ2

= σ2

= σ2

(cid:18) 1
K
(cid:18) 1
K

+

+

1
N − K

1
N − K

(cid:32)

1
K

+

1
N − K





(cid:88)

(¯aI − ¯a ¯I)2(¯a ¯I − aj)2

I + V 2

¯I )2

j∈ ¯I
(cid:19)

(σ2 + V 2
(cid:34)(cid:18) σ2
B

(cid:19)2

+ A2

+ σ2

(cid:18) V 2

I + V 2
¯I
B2

(cid:19)(cid:35)

+

+

(cid:19)

A2
B
(¯aI − ¯a ¯I)2

σ2 + V 2

I + V 2
¯I

(cid:33)

where we used A = ¯aI − ¯a ¯I and B = σ2 + V 2

I + V 2

¯I . This completes the proof for the two-way

problem.

One-way global problem. The derivation here is similar to the two-way problem. Indeed,

the Lagrangian can be written as



L(w, λ) =

¯aI −



2

ajwj



+

(cid:88)

j∈ ¯I

σ2
K

+ σ2 (cid:88)
j∈ ¯I





w2

j − λ



(cid:88)

j∈ ¯I

wj − 1

 .

For any l ∈ ¯I, the weights need to satisfy

∂L(w, λ)
∂wl



= 2al



(cid:88)

j∈ ¯I

ajwj −

(cid:88)

i∈I


 + 2σ2wl − λ = 0.

aiwi

(3)

This, together with the condition that (cid:80)

l∈ ¯I wl = 1, leads to a system of equations that can be
solved. Similarly to the two-way problem, we claim that the following set of weights satisfy the

29

ﬁrst-order conditions:

w∗

l =

w∗

l =

1
K

for l ∈ I,

1
N − K

−

(¯aI − ¯a ¯I)(¯a ¯I − al)
σ2 + V 2
¯I

for l ∈ ¯I .

It is straightforward to verify that (cid:80)

l∈ ¯I w∗

l = 1. Also, for any l ∈ ¯I we can write:



2al

(cid:88)



j∈ ¯I


 + 2σ2wl

ajwj − ¯aI



(¯a ¯I − aj)aj




 + 2σ2



(cid:88)



j∈ ¯I

(cid:18) 1

N − K

+

(¯a ¯I − ¯aI)(¯a ¯I − al)
σ2 + V 2
¯I

(cid:19)



= 2al (¯a ¯I − ¯aI)

1 +

1
σ2 + V 2
¯I
(cid:19)

al

(cid:20)(cid:18) σ2

σ2 + V 2
¯I

= 2 (¯a ¯I − ¯aI)

= 2σ2

(cid:20) (¯a ¯I − ¯aI)¯a ¯I
σ2 + V 2
¯I

+

1
N − K

+ σ2 ¯a ¯I − al
σ2 + V 2
¯I
(cid:21)

(cid:21)

+

2σ2
N − K

which is independent of l. Hence, for

λ = 2σ2

(cid:20)(¯a ¯I − ¯aI)¯a ¯I
σ2 + V 2
¯I

(cid:21)

+

1
N − K

Eq. (3) is satisﬁed for all l ∈ ¯I. Substituting these optimal weights into the formula for the

one-way objective yields

J1-way(I) =





(cid:88)

i∈I

aiw∗

i −

(cid:88)

j∈ ¯I



2

ajw∗
j



+ σ2

n
(cid:88)

i=1

2

w∗
i



= (¯aI − ¯a ¯I)2

1 +

1
σ2 + V 2
¯I





(cid:88)

j∈ ¯I

(¯aI − aj)aj





1
N − K

+ σ2

(cid:88)

+

(¯aI − ¯a ¯I)2(¯a ¯I − aj)2
(σ2 + V 2





2





+ σ2

(cid:19)

(cid:18) 1
K





j∈ ¯I
(cid:19)

¯I )2
(cid:34)(cid:18) σ2

= σ2

(cid:18) 1
K

+

1
N − K

+ (¯aI − ¯a ¯I)2

(cid:19)2

+ σ2

(cid:35)

V 2
¯I
(σ2 + V 2

¯I )2

σ2 + V 2
¯I

(cid:32)

= σ2

1
K

+

1
N − K

+

(cid:33)

(¯aI − ¯a ¯I)2
σ2 + V 2
¯I

which completes the proof for the one-way problem.

30

Per-unit problem. The per-unit problem can be thought of as solving K separate two-way

(or one-way) global problems where in each sub-problem, a single treated unit is selected as set I
and all N − K control units are in the set ¯I. Hence, using our derivation for the one-way global
problem, in each sub-problem with units in P and ¯P where P = {i} for i ∈ I and ¯P = ¯I the

optimal weights are given by

wi

j =

1
N − K

−

(ai − ¯a ¯I)(¯a ¯I − aj)
σ2 + V 2
¯I

.

Note that we can also use our derivation for the one-way global problem to calculate the optimal

objective within each sub-problem, with a single change that in the per-unit objective we do

not penalize the weight of the single treated unit in P . In other words, the term σ2/1 of the

objective will not show up in the calculations. Hence, denoting J ∗

i as the optimal value of this

sub-problem, we have

J ∗
i = σ2

(cid:32)

1
N − K

+

(ai − ¯a ¯I)2
σ2 + V 2
¯I

(cid:33)

.

Furthermore, for the per-unit objective we can write Jper-unit(I) = (cid:80)

i∈I J ∗

i /K which implies

Jper-unit(I) =

1
K

(cid:88)

i∈I

J ∗
i =

=

=

=

(cid:32)

(cid:88)

σ2

1
K

1
N − K

+

i∈I
σ2
N − K
σ2
N − K
σ2
N − K
(cid:32)

+

+

+

σ2
σ2 + V 2
¯I
σ2
σ2 + V 2
¯I
σ2
σ2 + V 2
¯I

·

·

(cid:20)

1
N − K

+

(cid:33)

(ai − ¯a ¯I)2
σ2 + V 2
¯I
i∈I(ai − ¯a ¯I)2
K

(cid:80)

(cid:80)

i∈I(ai − ¯aI + ¯aI − ¯a ¯I)2
K

(cid:21)

(¯aI − ¯a ¯I)2 +

V 2
I
K
(¯aI − ¯a ¯I)2 + K −1V 2
σ2 + V 2
¯I

I

(cid:33)

.

= σ2

A.4

Inference

A standard way of performing permutation-based inference for synthetic-control procedures

suggested in Abadie et al. (2010) involves permuting which units receive the treatment—or

choosing placebo treated units among the control units—to obtain a reference distribution of

31

treatment-eﬀect estimates under the sharp null hypothesis of no eﬀect on any of the units in the

treated periods. However, our method chooses the treated units themselves which makes this type

of permutation infeasible. Instead we focus on inference methods that permute the treatment

periods closely following the methodology suggested by Chernozhukov et al. (2021)—subsequently

CWZ.

Speciﬁcally, we draw bootstrap samples (without replacement) of the S time periods (including

both the pre-treatment periods and the treatment periods). CWZ suggest using one of the two

permutation regimes: (i) iid permutations which allow for an arbitrary order of the time periods

in the bootstrap sample or (ii) moving block permutations in which every bootstrap sample is a

cyclic shift of the original sample over the time periods. While the conditions that ensure the

validity of the second approach are less strict than those required by the ﬁrst approach, the

second approach only generates at most S unique bootstrap samples, and therefore requires more

data for convergence. While the overall size of our dataset, N × S = 50 × 40, is relatively small,

we present the results obtained using both permutation schemes. For each bootstrap sample we

re-estimate the average treatment eﬀect on the treated (ATET) assuming that the same number

of periods at the end of the bootstrap sample are treated as the number of treatment periods

in the original sample. Following CWZ, we use the absolute value of the estimate divided by

the square root of the number of treatment periods as the test statistic, denoted U (Y ), and

construct its permutation distribution under the sharp null hypothesis of all individual treatment

eﬀects being equal to zero in all of the treatment time periods. We reject the null hypothesis

at a signiﬁcance level 1 − α if the original test statistic is larger than the 1 − α fraction of the

computed bootstrap values.

As a baseline, we note that both permutation procedures lead to a valid test for the sharp

null of no treatment eﬀects if time periods are exchangeable in the following sense:

Proposition 1. Assume that across time periods t = 1, . . . , S the vector of potential outcomes

Yt(0) = (Y1t(0), . . . , YN t(0)) of all units at time t in the absence of the treatment is drawn

independently and identically, and that the test statistic U (Y ) permits a bounded density function.

Then the test of the sharp null H0 : Yit(1) = Yit(0) for all i = 1, . . . , N in all treatment periods

t = T + 1, . . . , S of no treatment eﬀects is unbiased in size, in the sense that it rejects a true null

32

hypothesis with probability α.

Note that this proposition follows directly from permutation invariance of the outcome

vectors Yt(0), and does not require that units themselves are exchangeable or that treatment is

assigned randomly across units. Nevertheless, the assumption that the distribution of the full

vector of potential control outcomes is independently drawn across time periods, including the

treated periods, is unrealistic in many time series settings. A more realistic treatment would

establish exchangeability only for the regression residuals. While a rigorous proof of a version of

Proposition 1 under such weaker assumptions is beyond the scope of the current paper, CWZ

state suﬃcient conditions for valid inference in a similar setting where treatment units are

ﬁxed. Speciﬁcally, they require that: (i) the estimator used for the construction of individual

counterfactual outcomes in the absence of the treatment is unbiased for Yit(0), (ii) the treatment

eﬀects are ﬁxed (nonrandom) and additive, Yit(1) = Yit(0) + τit (this would not be required to

test the null hypothesis Yit(1) = Yit(0), but allows for constructing of conﬁdence sets and testing

other sharp hypotheses), and (iii) the remaining noise variables, ˆεit, equal to the diﬀerences

between the estimators of Yit(0) and the values themselves, are mean zero and either i.i.d. across

units and time (justifying the iid permutations) or i.i.d. across units and following a stationary

weakly dependent process across time (in which case moving block permutations should be used).

CWZ also provide suﬃcient conditions on commonly used estimators satisfying assumption (i).

We construct power curves using simulated data and both types of permutations. Figure 2

plots the probability of rejecting the sharp null hypothesis of zero treatment eﬀects as a function

of the true value of the ATET. It presents two types of inference results. First, for the true

treatment eﬀects equal to zero across all units and all time periods the plots show the fraction of

simulations that reject the sharp null hypothesis of zero treatment eﬀects at the 90% signiﬁcance

level. This provides an estimate of the actual size of the nominally 10% size test. Second, the

plots show how the rejection probabilities change as the true value of the average treatment

eﬀect on the treated increases.

Speciﬁcally, we run 100 simulations. The data for each simulation include 10 units that are

chosen randomly (out of 50 available) and all 40 of the available time periods. We assume that

the treatment is applied in the last 5 time periods to the 3 chosen treatment units. Depending on

33

the method, the treatment units are chosen either randomly or using a mixed-integer program.

The treatment eﬀects are assumed to be heterogeneous and equal to 0, τ /2, and τ (implying the

average treatment eﬀect on the treated of τ /2) for the chosen treatment units in the order that

corresponds to their order in the sampled data.7 The average treatment eﬀect on the treated

is estimated as described in Section 5 of the paper. Within each simulation, we repeat this

procedure for each of the 40 permuted samples and compute the 90% quantile of the bootstrap

distribution of the test statistic.8 If the test statistic computed on the originally sampled data

(before the bootstrap) exceeds that quantile, we reject the sharp null hypothesis. Notably, the

methods proposed in the paper—the per unit problem as well as the two- and one-way global

problems—have test sizes at most as large and the power generally exceeding those of the

randomized methods.9

A.5 Hardness

We prove that the presented optimization problems are indeed NP-Hard. We do so by providing

a formal reduction from a variant of the partitioning problem that is known to be NP-hard. In an

instance of the equal-size partitioning problem, we are given a set of numbers B = {b1, b2, · · · , bn}.
Let T = (cid:80)n

i=1 bi. The equal-size partitioning problem is to decide if there exists a subset S ⊂ B
of n/2 items with total sum of elements equal to T /2. This decision problem is NP-complete

(Cieliebak et al., 2008). We show that we can distinguish between a “YES” and “NO” instance of

this problem using an optimal algorithm for our optimization problems, hence proving that our

problem is also NP-hard.

7This setting is diﬀerent from the one used in Section 5 where the treatment eﬀects did not depend on the

identity of the treated units. The setting we use here can still be formulated in terms of the potential outcomes

framework. However, it will require the potential outcomes under treatment to depend on the total number of

treated units as well as the order of the treated units introducing interference. We use this setting to guarantee

that the true value of the average treatment eﬀect on the treated remains constant across all simulations and

methods allowing us to minimize the noise while using a relatively small number of simulations.

8We limit the number of bootstrap samples to 40 to make the inference results obtained using either of the

permutation schemes more easily comparable since the maximum number of distinct samples that the moving

block permutations allow is equal to S = 40.

9Note that the eﬀect size of 0.05 corresponds to roughly the average outcome value observed in the data.

34

(a) iid permutations

(b) moving-block permutations

Figure 2: Power curves.

35

0.000.010.020.030.040.05Average effect size0.00.20.40.60.81.0Probability of rejection0.000.010.020.030.040.05Average effect size0.00.20.40.60.81.0Probability of rejection−0.04−0.020.000.020.04−0.04−0.020.000.020.04Per-unitTwo-way globalOne-way globalSynthetic control (random treatment)Difference-in-means (random treatment)Given an instance (B, T /2) of the partitioning problem, consider an instance of the J2-way(I)

or J1-way(I) problem where we set N = {ai|1 ≤ i ≤ n} with ai = bi + T . We note that with

this transformation, there exists a subset I with a total sum of nT +T

2

if and only if there exists

a subset S ⊂ B of n/2 items with total sum of T /2. Furthermore, for such a subset I, since
|I| = |N \I|, the average of items in I will be the same as the average of ¯I = N \I and equivalently,

(aI − a)2 = 0. We also observe that the optimal solution for both J2-way(I) and J1-way(I) is at
N −K . As a result, the optimal solution for problems J2-way(I) or J1-way(I) is 1

K + 1

K + 1

least 1

N −K

if and only if we can ﬁnd a subset of size n/2 of N with the total sum of nT +T

2

or, equivalently,

words, determining if the optimal solution is 1

if and only if there exists a subset S ⊂ B of n/2 items of B with the total sum of T /2. In other
K + 1
N −K corresponds to having a “YES” instance
of the equal-size partitioning problem (B, T /2). Therefore, ﬁnding such an optimal solution is

NP-hard.

36

