1
2
0
2

c
e
D
0
3

]

G
L
.
s
c
[

1
v
1
4
9
4
1
.
2
1
1
2
:
v
i
X
r
a

A General Traï¬€ic Shaping Protocol in E-Commerce

Chenlin Shen
Alibaba Group
Hangzhou, China

Guangda Huzhang
guangda.hzgd@alibaba-inc.com
Alibaba Group
Hangzhou, China

Yuhang Zhou
Alibaba Group
Hangzhou, China

Chen Liang
Alibaba Group
Hangzhou, China

Qing Da
Alibaba Group
Hangzhou, China

ABSTRACT
To approach diï¬€erent business objectives, online traï¬ƒc shaping al-
gorithms aim at improving exposures of a target set of items, such
as boosting the growth of new commodities. Generally, these al-
gorithms assume that the utility of each user-item pair can be ac-
cessed via a well-trained conversion rate prediction model. How-
ever, for real E-Commerce platforms, there are unavoidable fac-
tors preventing us from learning such an accurate model. In or-
der to break the heavy dependence on accurate inputs of the util-
ity, we propose a general online traï¬ƒc shaping protocol for online
E-Commerce applications. In our framework, we approximate the
function mapping the bonus scores, which generally are the only
method to inï¬‚uence the ranking result in the traï¬ƒc shaping prob-
lem, to the numbers of exposures and purchases. Concretely, we
approximate the above function by a class of the piece-wise linear
function constructed on the convex hull of the explored data points.
Moreover, we reformulate the online traï¬ƒc shaping problem as lin-
ear programming where these piece-wise linear functions are em-
bedded into both the objective and constraints. Our algorithm can
straightforwardly optimize the linear programming in the prime
space, and its solution can be simply applied by a stochastic strat-
egy to fulï¬ll the optimized objective and the constraints in expec-
tation. Finally, the online A/B test shows our proposed algorithm
steadily outperforms the previous industrial level traï¬ƒc shaping
algorithm.

CCS CONCEPTS
â€¢ Theory of computation â†’ Theory and algorithms for ap-
plication domains; â€¢ Applied computing â†’ Online shopping.

KEYWORDS
Traï¬ƒc shaping, black-box approximation, linear programming

ACM Reference Format:
Chenlin Shen, Guangda Huzhang, Yuhang Zhou, Chen Liang, and Qing
Da. 2018. A General Traï¬ƒc Shaping Protocol in E-Commerce. In Woodstock

Permission to make digital or hard copies of all or part of this work for personal or
classroom use is granted without fee provided that copies are not made or distributed
for proï¬t or commercial advantage and that copies bear this notice and the full cita-
tion on the ï¬rst page. Copyrights for components of this work owned by others than
ACM must be honored. Abstracting with credit is permitted. To copy otherwise, or re-
publish, to post on servers or to redistribute to lists, requires prior speciï¬c permission
and/or a fee. Request permissions from permissions@acm.org.
Woodstock â€™18, June 03â€“05, 2018, Woodstock, NY
Â© 2018 Association for Computing Machinery.
ACM ISBN 978-1-4503-XXXX-X/18/06. . . $15.00
https://doi.org/10.1145/1122445.1122456

â€™18: ACM Symposium on Neural Gaze Detection, June 03â€“05, 2018, Woodstock,
NY . ACM, New York, NY, USA, 5 pages. https://doi.org/10.1145/1122445.1122456

1 INTRODUCTION
Most E-Commerce algorithms aim to improve transaction eï¬ƒciency
by showing personalized items according to the interests of users,
which provides the basic power for the growth of the platform.
However, transaction eï¬ƒciency is not the only business concern
in many cases. For example, the delivery timeliness is a vital fea-
ture aï¬€ecting the satisfaction of users, since users wish to receive
their package as soon as possible. Therefore, for the sake of op-
timizing the satisfaction of users, retail platforms will boost cer-
tain exposure for the items with better delivery timeliness. The
demand for such quantitative exposure boosting is fundamental in
E-Commerce operations and can be formulated as an online traf-
ï¬c shaping problem. The goal is to maximize the cumulative pur-
chase number while satisfying the constraints of the lowest expo-
sure number.

Traditional online traï¬ƒc shaping algorithms assume that the
utility of each user-item pair can be accessed via an oracle model.
In other words, there exists a model that serves as an oracle to accu-
rately predict the probability of purchase when showing an item to
a user. With the assistance of the probabilities, the traï¬ƒc shaping
problem can be further formulated as a linear program (LP). More-
over, by adopting the stochastic user arrival model, most existing
algorithms are based on the primal-dual framework, where dual
optimal prices are learned by solving a fractional LP with the prob-
abilities of revealed users and are used for subsequent assignments.
However, there are unavoidable factors that prevent us from learn-
ing an accurate model to predict the probabilities, such as the cold-
start problem, class-imbalance data set, and heavy noises in behav-
ior patterns. Therefore, the traditional online traï¬ƒc shaping algo-
rithms can be ineï¬€ective in practice, leading to either non-optimal
purchase numbers or severe violation of the exposure constraints.
To break the heavy dependence on accurate probabilities, we
propose a novel and general online traï¬ƒc shaping protocol for E-
Commerce platforms. Instead of trying to directly learn the dual
optimal prices with ranking scores, we treat the ranking model as
a component of the whole environment. In this environment, we
introduce functions that map the dual prices to the numbers of
exposure and purchase on each user group. For the ease of intu-
itive understanding, we rename the dual price as bonus score that
can be added to the model-output scores in the rest of this paper.
Since the bonus score is a continuous variable, we explore the func-
tion values on several points and approximate the function with a

 
 
 
 
 
 
Woodstock â€™18, June 03â€“05, 2018, Woodstock, NY

Chenlin Shen, Guangda Huzhang, Yuhang Zhou, Chen Liang, and Qing Da

piece-wise linear function constructed on the convex hull of the ex-
plored points. Moreover, we reformulate the online traï¬ƒc shaping
problem as an LP where the piece-wise linear functions are embed-
ded into both the objective and constraints. The main diï¬€erence
between our proposed LP and that used in existing online match-
ing algorithms is that the optimization variables of our proposed
LP are bonus scores, thus we directly optimize the LP in the pri-
mal space to obtain optimal bonus scores. Then we apply the opti-
mal bonus scores by a randomized combination of explored bonus
scores, which is shown to be better than a deterministic protocol.
The main contributions of this paper are summarized as follows:

â€¢ We propose a general online traï¬ƒc shaping protocol for E-
Commerce platforms to break the heavy dependence on ac-
curate probabilities in online traï¬ƒc shaping problems.
â€¢ We proof that our proposed protocol achieves the optimal

solution in the stationary environments.

â€¢ The experiments on real applications exhibit the superiority

of our approach.

2 RELATED WORKS
A close research topic of traï¬ƒc shaping is online matching [14].
Generally, online matching algorithms focus on optimizing the com-
petitive ratio given a user arriving model, e.g. [4, 6, 8, 9]. Some
recent works study the eï¬ƒciency on converge [2, 3, 13], extension
versions for more general setting [1, 11, 12], and more complicated
user models [7, 17]. Diï¬€erent from online matching, online convex
optimization involves learning frameworks and has been studied
in theory and practice [10]. Recent online convex optimization al-
gorithms study dynamic regret and can adapt to both stationary
and dynamic environments [5, 15, 16, 18]. Compared to them, our
study focuses on real-world scenarios, and aims to build the com-
plete process that uses the raw statistics data to improve the online
revenue which is a complicated black-box function.

3 PRELIMINARY
Our online platform has ğ‘› disjoint user groups ğ‘ˆ = {ğ‘ˆ1, ğ‘ˆ2, ..., ğ‘ˆğ‘›}
and target items set ğ‘† = {ğ‘†1, ğ‘†2, ..., ğ‘†ğ‘š }. User groups are partitioned
by business experts and the users in the same group are likely to
have similar behaviors. In our online platform, items displayed to
users are ranked by their ranking scores, and we increase the expo-
sure of a target items set by adding the a bonus score to these items.
The bonus scores for items in the same target items set should be
the same, and they can be diï¬€erent given diï¬€erent users. Practi-
cally, there may be items which belong to two target items set, but
the amount of these items can be ignored. Therefore, we assume
target items sets are also disjoint.

For a traï¬ƒc shaping task, our ï¬rst objective is to satisfy the low-
est exposures requirement of each target set ğ‘† ğ‘— . Concretely, the total
exposure of items in target set ğ‘† ğ‘— should be at least ğ‘Ÿ ğ‘— . Our second
objective is to minimize the loss of clicks caused by the above expo-
sures requirement. Formally,

ğ‘šğ‘ğ‘¥ğ‘–ğ‘šğ‘–ğ‘§ğ‘’ Ã•

ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘– ğ‘— )

1â‰¤ğ‘– â‰¤ğ‘›,1â‰¤ ğ‘— â‰¤ğ‘š

ğ‘ .ğ‘¡ . Ã•
1â‰¤ğ‘– â‰¤ğ‘›

ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘– ğ‘— ) â‰¥ ğ‘Ÿ ğ‘— , âˆ€ğ‘— âˆˆ [1, ğ‘š]

(1)

The non-decreasing function ğ‘“ğ‘– ğ‘— (ğ‘¥) represent the times that items
in the ğ‘—-th set will be exposed for buyers in the ğ‘–-th group when we
assign bonus score of ğ‘—-th set to ğ‘¥ in expectation (to dispose the un-
certainty of an online environment). The non-increasing function
ğ‘”ğ‘– ğ‘— (ğ‘¥) represent the times of total clicks (for all items) under the
same setting.

4 METHODOLOGY
We can observe that Equation 1 is a non-linear programming and
it is hard to solve it straightforwardly. The high level idea of our
solution is to estimate and break ğ‘“ and ğ‘” into the sum of several
piece-wise linear functions. Without loss of generality, we assume
the bonus score is chosen from 0 to 1. We partition the interval
into ğ‘˜ + 1 sub-intervals and examine a ï¬xed set of bonus score
value ğ‘‡ = (0, 1/ğ‘˜, 2/ğ‘˜, ..., 1). We estimate the ground-truth value
(ğ‘“ (ğ‘¥), ğ‘”(ğ‘¥)) for ğ‘¥ğ‘™ğ‘–ğ‘š âˆˆ ğ‘‡ , denoted as ( Â¯ğ‘“ (ğ‘¥ğ‘™ğ‘–ğ‘š), Â¯ğ‘”(ğ‘¥ğ‘™ğ‘–ğ‘š)). Then, a
stochastic allocation can be proved to optimize the performance.
We demonstrate the process by pseudo code in Algorithm 1.

Algorithm 1 AE Traï¬ƒc Shaping

Input: Oracle functions of exposures (ğ‘“ğ‘– ğ‘— ) and clicks (ğ‘”ğ‘– ğ‘— ), the
lowest exposures requirement ğ‘Ÿ ğ‘— .
Output: A stochastic bonus score assignment for {ğ‘¥ğ‘– ğ‘— }.

Constraints set ğ¶ â† âˆ…
Optimization variables set ğ‘‹ â† âˆ…
Objective function ğ‘‚ â† 0
Split points ğ‘‡ â† (0, 1/ğ‘˜, 2/ğ‘˜, ..., 1)
for ğ‘– âˆˆ [ğ‘›], ğ‘— âˆˆ [ğ‘š] do

Detect ğ‘“ğ‘– ğ‘— (ğ‘¥lim) and ğ‘”ğ‘– ğ‘— (ğ‘¥lim) for ğ‘¥lim âˆˆ ğ‘‡ , denoted as
Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š) and Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š)
Solve the outer convex curve ğ¿ of points ( Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š), Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š))
by the Grahamâ€™s scan algorithm // refer Deï¬nition 1
Sort points of ğ¿ in increasing order of ğ‘¥
for ğ‘˜ = 2 to size of L do

( Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘˜ ), Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘˜ )) â† ğ‘˜-th element of L
( Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘˜âˆ’1), Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘˜âˆ’1)) â† (ğ‘˜ âˆ’ 1)-th element of L
ğ‘‹ â† ğ‘‹ âˆª {ğ‘¥ğ‘– ğ‘—ğ‘˜ }
mixedBy(ğ‘¥ğ‘– ğ‘—ğ‘˜ ) â† (ğ‘¥ğ‘˜âˆ’1, ğ‘¥ğ‘˜ )
ğ¶ â† ğ¶ âˆª {0 â‰¤ ğ‘¥ğ‘– ğ‘—ğ‘˜ â‰¤ Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘˜ ) âˆ’ Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘˜âˆ’1)}
ğ‘‚ â† ğ‘‚ + ğ‘¥ğ‘– ğ‘—ğ‘˜ Â·

Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘˜âˆ’1)âˆ’ Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘˜ )
Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘˜ )âˆ’ Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘˜âˆ’1)

end for

end for
Solve LP variables ğ‘‹ that optimizes ğ‘‚ under constraints ğ¶
Initialize stochastic bonus score assignment ğ´
for ğ‘– âˆˆ [ğ‘›], ğ‘— âˆˆ [ğ‘š] do

Find maximal ğ‘¡ that ğ‘¥ğ‘– ğ‘—ğ‘¡ > 0
ğ‘¥left, ğ‘¥right â† mixedBy(ğ‘¥ğ‘– ğ‘—ğ‘¡ )
Add the following rule to ğ´: let ğ‘¥ğ‘– ğ‘— = ğ‘¥left with probability of
, and ğ‘¥ğ‘– ğ‘— = ğ‘¥right with probability of
1 âˆ’
end for
return ğ´

ğ‘¥ğ‘– ğ‘—ğ‘¡
ğ‘¥rightâˆ’ğ‘¥left

ğ‘¥ğ‘– ğ‘—ğ‘¡
ğ‘¥rightâˆ’ğ‘¥left

A General Traï¬€ic Shaping Protocol in E-Commerce

Woodstock â€™18, June 03â€“05, 2018, Woodstock, NY

4.1 Proof of Main Theorem
We purify our theoretic contribution in the following theorem. Prac-
tically, we will choose a reasonably large parameter ğ‘˜ and go through
the steps in Algorithm 1.

Theorem 1. Assume | Â¯ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š)âˆ’ğ‘“ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š)| < ğœ–1 and | Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š)âˆ’
ğ‘”ğ‘– ğ‘— (ğ‘¥ğ‘™ğ‘–ğ‘š)| < ğœ–2 for ğ‘¥ğ‘™ğ‘–ğ‘š âˆˆ ğ‘‡ given monotonic and continuous func-
tion ğ‘“ğ‘– ğ‘— and ğ‘”ğ‘– ğ‘— . When ğ‘˜ goes to inï¬nity, there is a polynomial-time
protocol that produces the expected number of exposures Ë†ğ‘“ğ‘— for each
target set ğ‘— and the global expected number of clicks Ë†ğ‘”, satisfying
E[ Ë†ğ‘“ğ‘— ] + ğ‘›ğœ–1 â‰¥ ğ‘Ÿ ğ‘— and ğ¸ [ Ë†ğ‘”] + ğ‘›ğ‘šğœ–2 â‰¥ ğ‘”âˆ— where ğ‘”âˆ— is the global
optimality on clicks.

We ï¬rst introduce a series of lemmas to prove the theorem. The
ï¬rst lemma allows us to estimate the eï¬€ect of an arbitrary bonus
score by a stochastic combination of bonus scores that already
have been observed.

Lemma 1. Given values of ğ‘“ and ğ‘” in two points ğ‘¥0 and ğ‘¥1, a sto-
chastic strategy can obtain exposures ğœ†ğ‘“ (ğ‘¥0)+(1âˆ’ğœ†)ğ‘“ (ğ‘¥1) and clicks
ğœ†ğ‘”(ğ‘¥0) + (1 âˆ’ ğœ†)ğ‘”(ğ‘¥1) for any ğœ† âˆˆ [0, 1] in the sense of expectation.

Proof. We can adopt the bonus score ğ‘¥0 with the probability of
ğœ† and the bonus score ğ‘¥1 with the probability of 1 âˆ’ ğœ†. It is easy to
(cid:3)
see the desired result.

The following lemma introduces a special class of piece-wise
linear functions that can be written without conditions on pieces.

Lemma 2. Given a non-increasing, continuous, and piece-wise lin-

ear function ğ‘” separated by ğ‘˜ points {ğ‘ 1, ğ‘ 2, ..., ğ‘ ğ‘˜ },

ğ‘”(ğ‘¥) = {ğ‘˜ğ‘– (ğ‘¥ âˆ’ ğ‘ ğ‘–) + ğ‘ğ‘–, ğ‘ ğ‘– â‰¤ ğ‘¥ â‰¤ ğ‘ ğ‘–+1|ğ‘– âˆˆ [1, ğ‘˜ âˆ’ 1]}.

(2)

The above formula can be written as

ğ‘”(Ã• ğ‘¥ğ‘– ) = ğ‘1 +

ğ‘˜âˆ’1

Ã•
ğ‘–=1

ğ‘˜ğ‘–ğ‘¥ğ‘– if (ğ‘¥ğ‘– > 0 =â‡’ ğ‘¥ ğ‘— = ğ‘  ğ‘—+1 âˆ’ğ‘  ğ‘— , âˆ€ğ‘— < ğ‘–) (3)

The condition {ğ‘¥ ğ‘— = ğ‘  ğ‘—+1 âˆ’ ğ‘  ğ‘— , âˆ€ğ‘— < ğ‘–} implies that all previous ğ‘¥ ğ‘—

are maximized. If ğ‘˜ğ‘– â‰¥ ğ‘˜ğ‘–+1 for each ğ‘–, then

ğ‘”(ğ‘¥) = ğ‘1 +

max
ğ‘¥ğ‘– âˆˆ[0,ğ‘ ğ‘–+1âˆ’ğ‘ ğ‘– ],

ğ‘¥ğ‘– =ğ‘¥

Ã

[

ğ‘˜âˆ’1

Ã•
ğ‘–=1

ğ‘˜ğ‘–ğ‘¥ğ‘– ]

(4)

Proof. By the deï¬nition, we can see ğ‘”(ğ‘ 1) = ğ‘1. Consider the
process of value changing of ğ‘” when ğ‘¥ moves from ğ‘ 1 to ğ‘ ğ‘˜ . Its
gradient is ğ‘˜1 at the beginning. When the ï¬rst interval is exhausted
(i.e. ğ‘¥ â‰¥ ğ‘ 1), the speed of value changing becomes ğ‘˜2. Equation 3
limits the added portion of ğ‘¥ must be selected from left to right so
it is equivalent to the original deï¬nition of ğ‘”(ğ‘¥).

Equation 4 demonstrates a diï¬€erent process where added por-
tion of ğ‘¥ is not constrained to from left to right. Because of the in-
creasing property of {ğ‘˜ğ‘– }, maximizing
ğ‘˜ğ‘–ğ‘¥ğ‘– implies that ğ‘¥ should
after ï¬ll the left interval before go right. Therefore, Equation 3 and
4 is equivalent with increasing {ğ‘˜ğ‘– }.

Ã

(cid:3)

The next lemma introduces a surrogate objective ğ‘”ğ‘ can promise
that {ğ‘˜ğ‘– } is increasing and objective value ğ‘”ğ‘ (ğ‘¥) is not worse than
ğ‘”(ğ‘¥) for each ğ‘¥.

Definition 1. The outer convex curve for a set of points {(ğ‘¥ğ‘–, ğ‘¦ğ‘– )}
is obtain by eliminating (ğ‘¥, ğ‘¦) if there exist (ğ‘¥ â€², ğ‘¦â€²) and (ğ‘¥ â€²â€², ğ‘¦â€²â€²) s.t.
ğ‘¥ â€² â‰¤ ğ‘¥ â‰¤ ğ‘¥ â€²â€² and (ğ‘¦âˆ’ğ‘¦â€²)Â·(ğ‘¥ â€²â€²âˆ’ğ‘¥ â€²) < (ğ‘¥ âˆ’ ğ‘¥ â€²) Â· (ğ‘¦â€²â€² âˆ’ ğ‘¦â€²). The outer
convex curve is the upper-half of a convex hull and can be computed
by the Grahamâ€™s scan algorithm.

Lemma 3. Given a monotone, continuous, piece-wise linear func-
tion ğ‘” separated by ğ‘˜ points {ğ‘ 1, ğ‘ 2, ..., ğ‘ ğ‘˜ }, the new piece-wise linear
function ğ‘“ ğ‘ that describes the outer convex curve for {(ğ‘ 
))}
satisï¬es ğ‘“ ğ‘ (ğ‘¥) â‰¥ ğ‘“ (ğ‘¥) for an arbitrary ğ‘¥.

ğ‘˜, ğ‘“ (ğ‘ 

â€²
ğ‘˜

â€²

Proof. For ğ‘ ğ‘– â‰¤ ğ‘¥ â‰¤ ğ‘ ğ‘–+1 and both (ğ‘ ğ‘–, ğ‘“ (ğ‘ ğ‘–)) and (ğ‘ ğ‘–+1, ğ‘“ (ğ‘ ğ‘–+1))
are in the outer convex curve, ğ‘“ ğ‘ (ğ‘¥) = ğ‘“ (ğ‘¥). Otherwise, with-
out loss of generality, (ğ‘ ğ‘–, ğ‘“ (ğ‘ ğ‘–)) can be eliminated by two points
(ğ‘¥ â€², ğ‘“ (ğ‘¥ â€²)) and (ğ‘¥ â€²â€², ğ‘“ (ğ‘¥ â€²â€²)) in the outer convex curve, which sat-
isï¬es ğ‘¥ â€² â‰¤ ğ‘ ğ‘– â‰¤ ğ‘¥ â€²â€²and

(ğ‘“ (ğ‘ ğ‘–) âˆ’ ğ‘“ (ğ‘¥ â€²)) Â· (ğ‘¥ â€²â€² âˆ’ ğ‘¥ â€²) < (ğ‘ ğ‘– âˆ’ ğ‘¥ â€²) Â· (ğ‘“ (ğ‘¥ â€²â€²) âˆ’ ğ‘“ (ğ‘¥ â€²))

=â‡’ ğ‘“ (ğ‘ ğ‘– ) < ğ‘“ (ğ‘¥ â€²) +

(ğ‘ ğ‘– âˆ’ ğ‘¥ â€²) Â· (ğ‘¦â€²â€² âˆ’ ğ‘¦â€²)
ğ‘¥ â€²â€² âˆ’ ğ‘¥ â€²

= ğ‘“ ğ‘ (ğ‘ ğ‘–)

(5)
Note that the singular case ğ‘¥ â€² = ğ‘ ğ‘– = ğ‘¥ â€²â€² is solved naturally. The
above result shows ğ‘“ ğ‘ â‰¥ ğ‘“ at least on separated points, which can
extends to arbitrary points for piece-wise linear functions.

(cid:3)

Proof. (of Theorem 1) Let ğ‘‚ğµ ğ½ the optimized value of objec-
tive in Equation 1. We ï¬rst transform Equation 1 by replacing ğ‘“
and ğ‘” with the summation of linear functions in Equation 3. We
use Â¯ğ‘“ğ‘– ğ‘—ğ‘¡ and Â¯ğ‘”ğ‘– ğ‘—ğ‘¡ to represent the gradient of each linear function
(ğ‘˜ğ‘– in Equation 3), i.e. Â¯ğ‘“ğ‘– ğ‘— (
ğ‘¥ğ‘¡ ) = Â¯ğ‘“ğ‘– ğ‘— (0) +
Â¯ğ‘“ğ‘– ğ‘—ğ‘¡ ğ‘¥ğ‘¡ . After replac-
ing ğ‘“ and ğ‘” with Â¯ğ‘“ and Â¯ğ‘”, we have

ğ‘˜âˆ’1
ğ‘¡=1

Ã

Ã

ğ‘šğ‘ğ‘¥ğ‘–ğ‘šğ‘–ğ‘§ğ‘’ Ã•
ğ‘–,ğ‘—

ğ‘˜âˆ’1

Ã•
ğ‘¡=1
ğ‘˜âˆ’1

ğ‘ .ğ‘¡ . Ã•
ğ‘–

Ã•
ğ‘¡=1

Â¯ğ‘”ğ‘– ğ‘—ğ‘¡ Â· ğ‘¥ğ‘– ğ‘—ğ‘¡ + ğ¶

Â¯ğ‘“ğ‘– ğ‘—ğ‘¡ Â· ğ‘¥ğ‘– ğ‘—ğ‘¡ â‰¥ ğ‘Ÿ ğ‘— âˆ’ ğ‘ ğ‘— , âˆ€ğ‘—

(6)

0 â‰¤ ğ‘¥ğ‘– ğ‘—ğ‘¡ â‰¤ ğ‘ ğ‘– ğ‘—ğ‘¡+1 âˆ’ ğ‘ ğ‘– ğ‘—ğ‘¡ , âˆ€ğ‘–, ğ‘—, ğ‘¡ âˆˆ [1, ğ‘˜ âˆ’ 1]
ğ‘¥ğ‘– ğ‘—ğ‘¡ > 0 =â‡’ ğ‘¥ğ‘– ğ‘—ğ‘¡ â€² = ğ‘ ğ‘– ğ‘—ğ‘¡ â€²+1 âˆ’ ğ‘ ğ‘– ğ‘—ğ‘¡ â€², âˆ€ğ‘¡ â€² < ğ‘¡
Ãğ‘–,ğ‘— Â¯ğ‘”ğ‘– ğ‘— (0) and ğ‘ ğ‘— =

Â¯ğ‘“ğ‘– ğ‘— (0), can be
Two constant terms, ğ¶ =
ignored in our task. We denote the optimized value of the above
objective ğ‘‚ğµ ğ½1. The gap between ğ‘‚ğµ ğ½ and ğ‘‚ğµ ğ½1 is the caused by
the approximation. Without consideration of constraints, the gap
between them is

Ãğ‘–

|ğ‘‚ğµ ğ½ (ğ‘‹ ) âˆ’ ğ‘‚ğµ ğ½1(ğ‘‹ )|

â‰¤ğ‘›ğ‘š Â· sup(|ğ‘”ğ‘– ğ‘— (ğ‘¥) âˆ’ Â¯ğ‘”ğ‘– ğ‘— (ğ‘¥)|)
â‰¤ğ‘›ğ‘š Â· (|ğœ–2 + ğ›¿ |) = ğ‘›ğ‘šğœ–2

(7)

Here ğ›¿ is the diï¬€erence of ğ‘” on adjacent separated points, which
can be removed when ğ‘˜ goes to inï¬nity. On the other hand, feasible
solutions of ğ‘‚ğµ ğ½ may not be feasible for ğ‘‚ğµ ğ½1 and vice versa. The
fulï¬llment of constraints can be similarly proved to have a bound
of ğ‘›ğœ–1 as above. Next, we are going to eliminate the last constraint
of ğ‘‚ğµ ğ½1. We let ğ‘¥

,

â€²
ğ‘– ğ‘—ğ‘¡

= ğ‘¥ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ğ‘– ğ‘—ğ‘¡

Woodstock â€™18, June 03â€“05, 2018, Woodstock, NY

Chenlin Shen, Guangda Huzhang, Yuhang Zhou, Chen Liang, and Qing Da

ğ‘˜âˆ’1

ğ‘šğ‘ğ‘¥ğ‘–ğ‘šğ‘–ğ‘§ğ‘’ Ã•
ğ‘–,ğ‘—

Ã•
ğ‘¡=1

Â¯ğ‘”ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ğ‘– ğ‘—ğ‘¡

ğ‘¥ â€²
ğ‘– ğ‘—ğ‘¡ + ğ¶

ğ‘˜âˆ’1

ğ‘¥ â€²
ğ‘– ğ‘—ğ‘¡ â‰¥

ğ‘ .ğ‘¡ . Ã•
Ã•
ğ‘¡=1
ğ‘–
0 â‰¤ ğ‘¥ â€²

ğ‘– ğ‘—ğ‘¡ â‰¤

, âˆ€ğ‘—

ğ‘Ÿ ğ‘— + ğ‘ ğ‘—
Â¯ğ‘“ğ‘– ğ‘—ğ‘¡
ğ‘ ğ‘– ğ‘—ğ‘¡+1 âˆ’ ğ‘ ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ğ‘– ğ‘—ğ‘¡
ğ‘– ğ‘—ğ‘¡ â€² = ğ‘ ğ‘– ğ‘—ğ‘¡ â€²+1 âˆ’ ğ‘ ğ‘– ğ‘—ğ‘¡ â€², âˆ€ğ‘¡ â€² < ğ‘¡

, âˆ€ğ‘–, ğ‘—, ğ‘¡ âˆˆ [1, ğ‘˜ âˆ’ 1]

ğ‘¥ â€²
ğ‘– ğ‘—ğ‘¡

> 0 =â‡’ ğ‘¥ â€²

â€¢ Gross Merchandise Volume (GMV). GMV(million dollars)

is the total value of the sold items.

â€¢ Compliance Rate (CR). The high CR value implies the re-
quirements on exposures of targeted items are better satis-
ï¬ed. Let ğ¶ = {ğ‘1, ğ‘2, ..., ğ‘ğ‘š } be the actual exposure ratios of
ğ‘š targeted sets, CR is computed as follows:

CR(ğ¶) = 1
ğ‘š

ğ‘š

Ã•
ğ‘–=1

min(ğ‘ğ‘–, ğ‘Ÿğ‘–)
ğ‘Ÿğ‘–

.

(10)

(8)

If

Â¯ğ‘”ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ğ‘– ğ‘—ğ‘¡

is non-increasing, the last constraint can be eliminated.

So the last step of our algorithm is to replace the piece-wise linear
functions by the outer convex curve of them. Let {(ğ‘ ğ‘
ğ‘¡=1 be

)}ğ‘˜ğ‘

ğ‘– ğ‘—ğ‘¡,

Â¯ğ‘”ğ‘
ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ ğ‘
ğ‘– ğ‘—ğ‘¡
ğ‘¡=1. The correspond-

)}ğ‘˜

the outer convex curve of points {(ğ‘ ğ‘– ğ‘—ğ‘¡,
ing programming is

Â¯ğ‘”ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ğ‘– ğ‘—ğ‘¡

ğ‘šğ‘ğ‘¥ğ‘–ğ‘šğ‘–ğ‘§ğ‘’ Ã•
ğ‘–,ğ‘—

ğ‘˜ğ‘ âˆ’1

Ã•
ğ‘¡=1
ğ‘˜ğ‘ âˆ’1

ğ‘ .ğ‘¡ . Ã•
ğ‘–

Ã•
ğ‘¡=1

0 â‰¤ ğ‘¥ â€²

ğ‘– ğ‘—ğ‘¡ â‰¤

Â¯ğ‘”ğ‘
ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ ğ‘
ğ‘– ğ‘—ğ‘¡

ğ‘¥ â€²
ğ‘– ğ‘—ğ‘¡ + ğ¶

ğ‘¥ â€²
ğ‘– ğ‘—ğ‘¡ â‰¥

ğ‘Ÿ ğ‘— + ğ‘ ğ‘—
Â¯ğ‘“ ğ‘
ğ‘– ğ‘—ğ‘¡
ğ‘ ğ‘
ğ‘– ğ‘—ğ‘¡+1 âˆ’ ğ‘ ğ‘
ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ ğ‘
ğ‘– ğ‘—ğ‘¡

, âˆ€ğ‘—

(9)

, âˆ€ğ‘–, ğ‘—, ğ‘¡ âˆˆ [1, ğ‘˜ğ‘ âˆ’ 1]

We denote the optimized value of above linear programming is
ğ‘‚ğµ ğ½2 which can be solved in polynomial time. Note that the last
is
constraint in ğ‘‚ğµ ğ½1 is eliminated here by Lemma 2 because

Â¯ğ‘”ğ‘
ğ‘– ğ‘—ğ‘¡
Â¯ğ‘“ ğ‘
ğ‘– ğ‘—ğ‘¡

non-increasing. Also, we then can produce the bonus score assign-
ment by {ğ‘¥ â€²
ğ‘– ğ‘—ğ‘¡ } by ï¬nding the ğ‘¥ğ‘– ğ‘—ğ‘¡ with the maximal ğ‘¡ such that
ğ‘¥ğ‘– ğ‘—ğ‘¡ > 0 for (ğ‘–, ğ‘—) pairs, which can be achieved by the linear combi-
nation of its two neighbors as Algorithm 1 shows. Finally, because
of Lemma 3, we can see the solution of ğ‘‚ğµ ğ½2 is no worse than ğ‘‚ğµ ğ½1
so that satisï¬es E[ Ë†ğ‘“ğ‘— ] + ğ‘›ğœ–1 â‰¥ ğ‘Ÿ ğ‘— and ğ¸ [ Ë†ğ‘”] + ğ‘›ğ‘šğœ–2 â‰¥ ğ‘”âˆ—.

(cid:3)

4.2 Online test
We examine our algorithm in the ANONYMOUS platform for a
month. The ANONYMOUS platform is one of the largest interna-
tional online E-Commerce platforms worldwide, and the targeted
set of items in this scenario is more than 10%, which has been a
heavy portion of the revenue. The baseline method is an industrial-
level traï¬ƒc shaping protocol, which includes a PID module with
adjustments from a multi-arm bandit module and has been served
our platform for years. Intuitively, PID helps us achieve the expo-
sure requirements and the bandit module can select to push the
targeted items to the proper group of users in an online fashion.
Each examined method needs to serve more than millions of users
per day with support requirements for tens of targeted sets: guar-
antee a certain count of exposure for each day. We consider three
indicators in the online A/B test:

â€¢ Purchase Rate (PR). PR is computed as the number of pur-

chases divides by the number of served users.

Models
No Traï¬ƒc Shaping
PID + Bandit
Ours

CR

PR
GMV
+0.00% +0.00% 66.14%
81.39%
-2.51%
-2.53%
82.65%
-0.70%
-0.89%

Table 1: The relative gap on metrics.

From the above result, we can see traï¬ƒc shaping has a nega-
tive inï¬‚uence on the possibility of purchase, but can expose much
more targeted items. Our proposed method can achieve better PR
and GMV (greater than 1.5%) than PID with eï¬ƒciency selection
by the bandit module, which can be translated to a signiï¬cant im-
provement that prevents us from losing of millions GMV per day.
At the same time, our method can have a compatible CR, which im-
plies that our method can achieve the best trade-oï¬€ on short-term
reward (PR and GMV) and long-term reward (CR) amongst exists
methods.

5 CONCLUSION
In this paper, we propose a new framework for traï¬ƒc shaping in
E-Commerce. The proposed framework straightforwardly solves
the approximated version of original traï¬ƒc shaping in expectation,
where no accurate conversion rate prediction model needs to be
included. The experimental result shows that it can steadily bring
revenue to our online system.

REFERENCES
[1] Gagan Aggarwal, Gagan Goel, Chinmay Karande, and Aranyak Mehta. 2011. On-
line vertex-weighted bipartite matching and single-bid budgeted allocations. In
Proceedings of the 22nd Annual ACM-SIAM Symposium on Discrete Algorithms.
1253â€“1264.

[2] Shipra Agrawal and Nikhil R Devanur. 2014. Fast algorithms for online stochas-
tic convex programming. In Proceedings of the 26th Annual ACM-SIAM Sympo-
sium on Discrete Algorithms. 1405â€“1424.

[3] Shipra Agrawal, Nikhil Devanur R, and Lihong Li. 2016. An eï¬ƒcient algorithm
for contextual bandits with knapsacks, and an extension to concave objectives.
In Proceedings of the 29th Annual Conference on Learning Theory. 4â€“18.

[4] Shipra Agrawal, Zizhuo Wang, and Yinyu Ye. 2014. A dynamic near-optimal
algorithm for online linear programming. Operations Research 62, 4 (2014), 876â€“
890.

[5] Omar Besbes, Yonatan Gur, and Assaf Zeevi. 2015. Non-stationary stochastic

optimization. Operations Research 63, 5 (2015), 1227â€“1244.

[6] Niv Buchbinder and Joseph Naor. 2009. The design of competitive online algo-
rithms via a primal-dual approach. Foundations and Trends in Theoretical Com-
puter Science 3, 2-3 (2009), 93â€“263.

[7] Hossein Esfandiari, Nitish Korula, and Vahab S. Mirrokni. 2015. Online alloca-
tion with traï¬ƒc spikes: Mixing adversarial and stochastic models. In Proceedings
of the 16th ACM Conference on Economics and Computation. 169â€“186.

[8] Matthew Fahrbach, Zhiyi Huang, Runzhou Tao, and Morteza Zadimoghaddam.
2020. Edge-weighted online bipartite matching. arXiv preprint arXiv:2005.01929
(2020).

A General Traï¬€ic Shaping Protocol in E-Commerce

Woodstock â€™18, June 03â€“05, 2018, Woodstock, NY

[9] Jon Feldman, Monika Henzinger, Nitish Korula, Vahab S. Mirrokni, and Cliï¬€ord
Stein. 2010. Online stochastic packing applied to display ad allocation. In Pro-
ceedings of the 18th Annual European Symposium. 182â€“194.

[10] Elad Hazan. 2019. Introduction to online convex optimization. arXiv preprint

arXiv:1909.05207 (2019).

[11] Guangda Huzhang, Xin Huang, Shengyu Zhang, and Xiaohui Bei. 2017. Online
roommate allocation problem.. In Proceedings of the 26th International Joint Con-
ference on Artiï¬cial Intelligence. 235â€“241.

[12] Thomas Kesselheim, Klaus Radke, Andreas TÃ¶nnis, and Berthold VÃ¶cking. 2013.
An optimal online algorithm for weighted bipartite matching and extensions to
combinatorial auctions. In European Symposium on Algorithms. Springer, 589â€“
600.

[13] Xiaocheng Li, Chunlin Sun, and Yinyu Ye. 2020. Simple and fast algorithm for
binary integer and online linear programming. arXiv preprint arXiv:2003.02513
(2020).

[14] Aranyak Mehta. 2013. Online matching and ad allocation. Foundations and

Trends in Theoretical Computer Science 8, 4 (2013), 265â€“368.

[15] Lijun Zhang, Shiyin Lu, and Zhi-Hua Zhou. 2018. Adaptive online learning in
dynamic environments. In Advances in Neural Information Processing Systems.
1323â€“1333.

[16] Peng Zhao, Yu-Jie Zhang, Lijun Zhang, and Zhi-Hua Zhou. 2020. Dynamic re-
gret of convex and smooth functions. Advances in Neural Information Processing
Systems 33 (2020).

[17] Yu-Hang Zhou, Chen Liang, Nan Li, Cheng Yang, Shenghuo Zhu, and Rong Jin.
2019. Robust online matching with user arrival distribution drift. In Proceedings
of the 33rd AAAI Conference on Artiï¬cial Intelligence. 459â€“466.

[18] Martin Zinkevich. 2003. Online convex programming and generalized inï¬ni-
tesimal gradient ascent. In Proceedings of the 20th International Conference on
Machine Learning. 928â€“936.

