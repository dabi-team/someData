Cloud-Based Dynamic Programming for an Electric 
City Bus Energy Management Considering Real-
Time Passenger Load Prediction 

Junzhe Shi1, Bin Xu2*, Xingyu Zhou3, Jun Hou4* 

1: University of California, Berkeley, Department of Civil and Environmental Engineering, 760 Davis Hall, 
Berkeley, CA 94720, USA. 
2: Clemson University, Department of Automotive Engineering, 4 Research Dr., Greenville, SC, 29607, USA 
3: University of Texas, Austin, Department of Mechanical Engineering, 204 E. Dean Keeton Street, Stop C2200 ETC 
II 5.160 Austin, TX, 78712, USA.  
4: University of Michigan, Department of Electrical Engineering and Computer Science, 1301 Beal Avenue, Ann 
Arbor, MI, 48109, USA. 
* Corresponding author: Bin Xu, Clemson University, Department of Automotive Engineering, 4 Research Dr., 
Greenville, SC, 29607, USA. Phone: 864-626-8335, Email: xbin@clemson.edu. Jun Hou, University of Michigan, 
Department of Electrical Engineering and Computer Science, 221 Santa Clara Way, San Mateo, CA 94403, USA. 
Phone: 734-272-5516, Email: junhou@umich.edu. 

Abstract - Electric city bus gains popularity in recent years for its low greenhouse gas emission, low noise level, etc. Different 

from a passenger car, the weight of a city bus varies significantly with different amounts of onboard passengers, which is 

not well studied in existing literature. This study proposes a passenger load prediction model using day-of-week, time-of-

day, weather, temperatures, wind levels, and holiday information as inputs. The average model, Decision Tree, Gradient 

Boost  Decision  Tree, and  Neural  Networks  models are  compared  in  the passenger  load prediction.  The  Gradient  Boost 

Decision Tree model is selected due to its best accuracy and high stability. Given the predicted passenger load, dynamic 

programming algorithm determines the optimal power demand for supercapacitor and battery by optimizing the battery 

aging and energy usage in the cloud. Then rule extraction is conducted on dynamic programming results, and the rule is 

real-time loaded to onboard controllers of vehicles. The proposed cloud-based dynamic programming and rule extraction 

framework with the passenger load prediction shows 4% and 11% fewer bus operating costs in off-peak and peak hours, 

respectively. The operating cost by the proposed framework is less than 1% shy of the dynamic programming with the true 

passenger load information.  

Keywords: Electric city bus, cloud computing, vehicle to infrastructure, dynamic programming, passenger load prediction   

1. Introduction 

Greenhouse gas emission by human activities has been dominating global warming since the mid-20th century 

[1].  Reducing  carbon  dioxide  emissions  by  minimizing  conventional  fossil  fuel  applications  is  the  key  to  the 

sustainable development for the whole world. US government plans to limit the carbon dioxide emissions of passenger 

cars to 88g/km in 2025 [2].  The electrified propulsion system [3], such as Hybrid electric vehicles (HEVs), plug-in 

hybrid electric vehicles (PHEVs), and all-electric vehicles (EVs), will replace conventional gasoline-power vehicles 

 
 
in future markets. Due to their high passenger loading capacities [4], city buses are perfect for applying the techniques 

of  electric  vehicles  to  reduce  carbon  dioxide  emissions.  Besides,  driving  in  a  city  involves  a  lot  of  braking  and 

acceleration conditions [5]. The  regeneration ability further improves the  energy utilization rate  of an electric bus 

because most of the kinetic energy can be charged back rather than becomes the heat loss in vehicle braking [6]. In 

addition, the  application of electric city buses also  leads to  reductions in noise levels [7]. Because of the benefits 

electric buses bring, as of 2019, more than 425,000 electric buses have been deployed around the world [8]. 

Rather than only using batteries as the energy storage devices, other devices, including supercapacitors [9] and 

flywheels  [10],  are  also  widely  used  in  transportation  to  minimize  operational  cost  by  extending  the  lifetime  of 

batteries.  Supercapacitors  can  be  charged  and  discharged  much  more  rapidly  than  conventional  batteries  without 

apparent aging [11]. However, using the supercapacitors as the only energy storage devices is not a good choice due 

to their low energy density. A supercapacitor can only store about 5 percent of the energy that  lithium-ion batteries 

can store with the same weight [12]. Thus, one possible solution is to use a hybrid energy storage system (HESS) that 

has both advantages of supercapacitors and batteries, including high power density and high energy density. 

An energy management strategy (EMS) plays a crucial role in a HESS because of the HESS complexity [13]. In 

the  literature,  various  EMSs  have  been  designed  and  discussed,  such  as  the  rule-based  method,  the  Pontryagin 

Minimum Principle (PMP), Model predictive control (MPC), and Dynamic Programming (DP). A fuzzy-logic rule-

based EMS is proposed for an electric bus [14]. The rule is offline optimized by DP. Even though DP is used, it is 

only optimized one time and does not consider the real-time load variation. Two rule-based EMSs, named Model 

Decision  and  Parallel  driving  Energy  Management,  are  proposed  for  a  series-parallel  hybrid  bus  [15].  Energy 

consumption  is  reduced  compared  with  an  internal  combustion  power  bus.  However,  the  rule  is  fixed  once  it  is 

developed and does not adaptive to real-time varying conditions. Different from rule-based methods, PMP, MPC and 

DP are optimization-based methods. A PMP based EMS is proposed for a plug-in hybrid electric bus on a fixed route 

[16]. The proposed PMP results show a close approximation to the offline DP results. However, the varying passenger 

load is not considered. In [17], an MPC with a Pareto-front analysis of the objective functions is used to reduce fuel 

consumption and battery degradation. However, the battery degradation rate is changing while batteries  are aging, 

which is not considered. [18] utilizes the DP to deal with the integrated optimization for deriving energy split strategies 

of a hybrid electric city bus. Both MPC and DP are used in a plug-in hybrid electric [19]. Even though it has future 

operating condition prediction, its prediction accuracy is low. In addition, due to the high computational cost, DP is 

only  executed  offline.  Nevertheless,  these  papers  neglect  the  passenger  loading  effect  and  assumes  the  city  buses 

always keep the constant masses. Besides, these methods require a priori knowledge of driver power demand to specify 

the  future  power  output  of  each  actuator  [20].  Once  driving  patterns  are  different  from  the  designed  one,  the 

performances  of  the  above  methods  cannot  be  guaranteed.  Moreover,  DP  is  only  used  offline  due  to  the  limited 

computation capability of the bus onboard controller. 

To  address  the  future  passenger  load  prediction  issue,  collecting  traffic  information  and  predict  future  power 

demand  become  a  potential  way.  Through  Vehicle-to-Infrastructure  (V2I)  and  Vehicle-to-Vehicle  (V2V), 

communication holds a  significant potential to improve the information acquisition for prediction of future traffic 

information [21]. A hierarchical EMS using vehicle-to-cloud connectivity and MPC on the vehicle side is recently 

discussed  in  [22].  However,  applying  MPC  on  the  vehicle  side  with  a  short  prediction  horizon  still  leads  to  high 

computational costs. The rapid development of intelligent transportation systems (ITS) and widespread use of cloud 

computing offers excellent opportunities to improve the overall performance of energy management strategies [23]. 

Besides, vehicle-to-cloud (V2C) provides a chance to apply the accurate and optimal but high computation expensive 

prediction  and  control  algorithms,  store  and  process  the  massive  amount  of  data,  and  update  the  structures  and 

parameters of current algorithms. With the powerful cloud cluster, even the DP algorithm has the potential to execute 

in real-time. Overall, three research gaps are found in the existing researches: 

1) 

Influence  of  the  various  passenger  load  for  generating  an  optimal  EMS  of  hybrid-electric  buses  is  merely 

discussed, 

2)  The high computational cost of the vehicle onboard optimization-based EMS like MPC and DP, The V2I and 

V2V benefits are not fully explored in the perspective of EV EMS.  

3)  The lacking investigation on EMS optimization considering the change of battery degradation rate after batteries 

aged. 

This paper extends the researches by discussing the effect of the passenger load factors and battery aging on the 

optimal EMS generation while proposing a new EMS to fill above three research gaps. The schematic diagram of 

using cloud data collection and computation for hybrid-electric buses is presented in Fig. 1.  Due to several stochastic 

variables (e.g., weather conditions), a precise passenger load prediction is challenging [24]. This paper investigates 

the  method  of  passenger  load  factor  prediction  using  different  statistic  and  machine  learning  models.  With  the 

assistance of V2C connect, the prediction of the reference power demand can be achieved by collecting the traffic 

information and predicting passenger load factors. Then, the planning of the reference power splitting is obtained with 

the concept of â€œblock MPCâ€ on the cloud by dynamic programming method. In addition, a rule-based controller with 

rule update ability is designed to handle the error between the predicted and actual power demands on the vehicle side 

with the limited computational cost. In summary, the contributions of this study are as follows: 

1)    EV bus passenger load is predicted in real-time using all the available information like weather conditions, time-

of-day, day-of-week, etc. As the on-board passenger number varies significantly during rush hours and off-peak hours, 

the passenger load prediction substantially increases the accuracy of power demand profile prediction for EV buses. 

2)    Four models are investigated for the passenger load prediction, including an average model and three supervised 

learning models. Due to the inputs (i.e., weather condition, time-of-day, day-of-week, etc.) are not highly connected, 

the supervised models shine in these complex modeling problems.  

3)        A  cloud-based  DP  framework  is  proposed  to  take  advantage  of  the  V2I  and  V2C  connectivity.  The  DP 

optimization is executed in the powerful cloud cluster, and then a rule-extraction procedure is followed to run the DP 

results in the low-cost CPU on the bus. 

4)    Battery degradation rate impacts on bus operation costs are analyzed. 

Figure. 1. The schematic diagram of cloud data collection and computation for hybrid-electric buses. 

The remainder of this paper is organized as follows. Section II introduces the system modeling and configuration. 

Section III presents the passenger load prediction models. Section IV explains the three EMS utilized in this study. 

Section V first analyzes the aging effect and passenger loading effect, then presents the results of different passenger 

loading prediction models, and finally compares the three EMS. Section VII highlights the key conclusions of this 

paper. 

 
 
 
2. Configuration and Modeling  

In this section, the vehicle dynamics and system configurations of a hybrid electric city bus are presented. Besides, 

the models of battery and supercapacitor used in this study are discussed.  

2.1 Vehicle Model and System Configurations 

According to the specification of Mercedes-Benz eCitaro [25], the maximum energy capacity, maximum load 

capacity, and empty vehicle mass of the vehicle model are determined. The model aims to convert speed profiles to 

power  demand  profiles  for  the  hybrid  energy  storage  system  based  on  different  driving  conditions.  The  vehicle 

dynamics can be expressed as, 

ğ‘šğ‘¤â„ğ‘œğ‘™ğ‘’ğ‘”ğ‘“ğ‘£ğ‘ğ‘œğ‘ (ğ›¼) + 0.5ğ¶ğ·ğ´ğ‘“ğœŒğ‘£3 +

ğ‘šğ‘¤â„ğ‘œğ‘™ğ‘’ğ‘£ğ‘‘ğ‘£
ğ‘‘ğ‘¡

ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ğœ‚ğ‘‡ğœ‚ğ‘šğ‘‘,   ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ > 0

+ ğ‘šğ‘¤â„ğ‘œğ‘™ğ‘’ğ‘”ğ‘£ğ‘ ğ‘–ğ‘›(ğ›¼) = {

ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘
ğœ‚ğ‘Ÿ

,   ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ â‰¤ 0

ğ‘šğ‘¤â„ğ‘œğ‘™ğ‘’ = ğ‘šğ‘£ğ‘’â„ğ‘–ğ‘ğ‘™ğ‘’ + ğ‘šğ‘ğ‘’ğ‘Ÿğ‘ ğ‘œğ‘›ğ¶ğ‘šğ‘ğ‘¥ğ‘“ğ‘™ğ‘œğ‘ğ‘‘

(1) 

(2) 

where ğ‘£ is  the  vehicle  speed, ğ›¼ is  the  road  slop, ğ‘“ğ‘™ğ‘œğ‘ğ‘‘ is  the  passenger  load  factor,  and  rest  of  the  parameters  are 

summarized in Table 1.   

Table 1 

Parameters and Description of the Electric City Bus. 

Parameter 
ğ‘šğ‘£ğ‘’â„ğ‘–ğ‘ğ‘™ğ‘’ 
ğ‘šğ‘ğ‘’ğ‘Ÿğ‘ ğ‘œğ‘› 
ğ¶ğ‘šğ‘ğ‘¥ 
ğ¸ğ‘šğ‘ğ‘¥ 
ğ‘” 
ğ´ğ‘“ 
ğ‘“ 
ğ¶ğ· 
ğœŒ 
ğœ‚ğ‘‡ 
ğœ‚ğ‘šğ‘‘ 
ğœ‚ğ‘Ÿ 

Description 
Empty vehicle mass 
Average mass of a person 
Maximum passenger load capacity 
maximum energy capacity 
Gravity acceleration 
Front area 
Rolling resistance coefficient 
Air drag coefficient 
Air density 
Transmission efficiency 
Electrical machine efficiency 
Regenerative braking efficiency 

Value 
13500 ğ‘˜ğ‘” 
70 ğ‘˜ğ‘” 
145 
293 ğ‘˜ğ‘Šâ„ 
9.8 ğ‘š/ğ‘ 2 
7.5 ğ‘š2 
0.018 
0.7 
1.29 ğ‘˜ğ‘”/ğ‘š3 
90% 
85% 
65% 

According to the required energy capacity of Mercedes-Benz eCitaro, the battery configuration is set up as 217 

in  series  and  7  in  parallel  in  this  study.  Besides  supplying  at  least  15  seconds  of  peak  power  consumption,  the 

supercapacitor pack is set up as 20 in series and 6 in parallel. The topology of the semi-active hybrid energy storage 

system  is  presented  in  Fig.  2.  The  electric motor  drives  the  rear  wheels.  A  DC/AC  converter  locates  between  the 

 
 
 
electric motor and the two energy storage systems. A DC/DC converter is used to mitigate the voltage among battery, 

supercapacitor, and AC/DC converter. 

Figure. 2. Topology schematic of a semi-active hybrid energy storage system. 

                       (a) Rint model of a battery 

(b) RC model of a battery of a supercapacitor 

Figure. 3. Simple equivalent circle models of a battery and supercapacitor. 

2.2 Battery Model 

In this study, the  state-of-charge (SOC) of a battery is defined as the state variables, while the  current of the 

battery is defined as the control input. The dynamic of a battery is, 

ğ‘†ğ‘‚ğ¶Ì‡ ğ‘ğ‘ğ‘¡ = âˆ’

ğ¼ğ‘ğ‘ğ‘¡
3600ğ‘„ğ‘ğ‘ğ‘¡

(3) 

where the ğ‘„ğ‘ğ‘ğ‘¡ is the nominal capacity of a battery. 

As shown in Fig. 3 (a), the simple equivalent circle model of a battery comprises an open-circuit voltage (OCV) 

and an ohmic resistor. The output and electric loss powers of a battery can be calculated by using, 

ğ‘ƒğ‘ğ‘ğ‘¡ğ‘™ğ‘œğ‘ ğ‘  = ğ¼ğ‘ğ‘ğ‘¡

2 âˆ— ğ‘…ğ‘ğ‘ğ‘¡

(4) 

 
 
 
 
 
where, ğ‘‚ğ¶ğ‘‰ğ‘ğ‘ğ‘¡ and ğ‘…ğ‘ğ‘ğ‘¡ are the OCV and the ohmic resistance of a battery. Their values depend on the ğ‘†ğ‘‚ğ¶ğ‘ğ‘ğ‘¡, and 

ğ‘ƒğ‘ğ‘ğ‘¡ğ‘œğ‘¢ğ‘¡ğ‘ğ‘¢ğ‘¡ = ğ‘‚ğ¶ğ‘‰ğ‘ğ‘ğ‘¡ âˆ— ğ¼ğ‘ğ‘ğ‘¡ âˆ’ ğ¼ğ‘ğ‘ğ‘¡

2 âˆ— ğ‘…ğ‘ğ‘ğ‘¡

(5) 

the other parameters of the battery used in this study are listed in Table 2 [26]. 

Parameter 
Capacity (Ah) 
Stored Energy (kWh) 
SOC Usage Window (%) 

Table 2 

Battery Parameters 

Value 
60 
0.192 
10 - 90 

The capacity of a battery limits the maximum energy of a battery that  can supply. However, the capacity of a 

battery will fade while the battery is aging. Through cycling tests, an empiric aging model is obtained and verified in 

Error!  Reference  source  not  found..  The  capacity  fade  depends  strongly  on  battery  usage,  C-rate,  operating 

temperature, and depth-of-discharge. The battery depths-of-discharge (operating range) of a hybrid electric city bus is 

assumed  from  90%  to  10%  SOC.  The  semi-empirical  life  model  adopted  the  following  equation  to  describe  the 

correlation between the capacity loss, Ah throughput, temperature, and C-rate, 

ğ‘„ğ‘™ğ‘œğ‘ ğ‘  = 0.0032 âˆ— exp (âˆ’

15162 âˆ’ 1516 âˆ— ğ¶ğ‘Ÿğ‘ğ‘¡ğ‘’
ğ‘…ğ‘‡ğ‘ğ‘ğ‘¡

) âˆ— ğ´â„0.824

where, the ğ‘„ğ‘™ğ‘œğ‘ ğ‘  represents the normalized capacity degradation, ğ‘… is the gas constant which is equal to 8.3145 

(6) 

ğ½

ğ‘šğ‘œğ‘™ğ¾

, 

ğ‘‡ğ‘ğ‘ğ‘¡ is  the  absolute  temperature  of  the  battery,  and ğ´â„ is  the  Ah  throughput.  After  discretized  the  formula  of  the 

battery degradation equation (6), a dynamic degradation model is obtained, 

âˆ†ğ‘„ğ‘™ğ‘œğ‘ ğ‘  = (0.0032 âˆ— exp (âˆ’

15162 âˆ’ 1516 âˆ— ğ¶ğ‘Ÿğ‘ğ‘¡ğ‘’
ğ‘…ğ‘‡ğ‘ğ‘ğ‘¡

1
0.824

))

0.824âˆ’1
0.824   âˆ— 0.824 âˆ—

âˆ— ğ‘„ğ‘™ğ‘œğ‘ ğ‘ 

âˆ†ğ‘¡ âˆ— ğ¼ğ‘ğ‘ğ‘¡
3600

(7) 

where, âˆ†ğ‘¡ is the sampling time. While a battery is aging, the value of its resistance and capacity will change. In this 

study, the resistance and capacity of the batteries are assumed to be obtained and updated by online estimation. 

2.3 Supercapacitor Model 

As the same as a batterie, the SOC of a supercapacitor is also defined as the state variable, and the current of a 

supercapacitor is defined as the control input,  

where, the ğ¶ğ‘ ğ‘ and ğ‘‰max ğ‘ ğ‘ are the capacitance and maximum voltage of a supercapacitor. 

ğ‘†ğ‘‚ğ¶Ì‡

ğ‘ ğ‘ = âˆ’

ğ¼ğ‘ ğ‘
ğ¶ğ‘ ğ‘ğ‘‰max ğ‘ ğ‘

(8) 

  
As  shown  in  Fig.  3 (b),  the  Rint-Capacity  model  of  a  supercapacitor  is  comprised  by  an  OCV  and  an ohmic 

resistor. The OCV of a supercapacitor is determined by, 

The output and electric loss powers of a supercapacitor can be calculated by using, 

ğ‘‚ğ¶ğ‘‰ğ‘ ğ‘ = ğ‘†ğ‘‚ğ¶ğ‘ ğ‘ âˆ— ğ‘‰max ğ‘ ğ‘

ğ‘ƒğ‘ ğ‘ğ‘™ğ‘œğ‘ ğ‘  = ğ¼ğ‘ ğ‘

2 âˆ— ğ‘…ğ‘ ğ‘

ğ‘ƒğ‘ ğ‘ğ‘œğ‘¢ğ‘¡ğ‘ğ‘¢ğ‘¡ = ğ‘‚ğ¶ğ‘‰ğ‘ ğ‘ âˆ— ğ¼ğ‘ ğ‘ âˆ’ ğ¼ğ‘ ğ‘

2 âˆ— ğ‘…ğ‘ ğ‘

(9) 

(10) 

(11) 

where, ğ‘…ğ‘ ğ‘ is the resistance, which depends on the C rate, and the other parameters of the supercapacitor used in this 

study are listed in Table 3 [26]. 

Parameter 
Max Voltage (V) 
Capacity (F) 
Stored Energy (kWh) 
SOC Usage Window (%) 

Table 3 

Supercapacitor Parameters 

Value 
27 
140 
0.0142 
50 -100 

Unlike a batterie, a supercapacitor has a much longer cycle life, and its degradation is neglectable [27]. Therefore, 

the supercapacitor cycle life mode is not considered in this study. 

3. Passenger Load Factor Prediction 

A passenger load factor represents the capacity utilization of public transport services. 0% passenger load factor 

means  the  bus  is  empty,  while  a  100%  passenger  load  factor  means  the  bus  is  filled.  This  section  focuses  on  the 

predictions of the passenger  load factors using different models. Four models are discussed, including an average 

model and three regression models - Neural Network (NN), Regression Tree (RT), and Gradient Boosting Decision 

Tree (GBDT). 

3.1 Passenger Load Data Analysis 

The actual passenger load data was collected from line 11 city buses in Guangdong, China. The raw data recodes 

the total number of people who took the line 11 city buses each hour from 08/01/2014 to 12/24/2014, as shown in the 

blue line of Fig. 4. There are four spikes regions at each month, which represents the weekdays busy hours of the four 

weeks. Each spike region has five lines, representing the five weekdays. 

 
 
Figure. 4. The number of passengers who took the line 11 city buses in Guangdong from 08/01/2014 to 12/24/2014. 

3.2 Average Model  

The hourly, daily averages, and weekly averages of the passenger load data are also shown in Fig. 4. The pattern 

of daily average data is more regular than the weekly average data. Thus, the passenger load data is normalized and 

classified according to the day of a week, and shown in Fig. 5. In Fig. 5, the blue lines represented the passenger loads 

of a particular day, and the red lines indicate hourly average passenger loads of all weeks. Besides, the day-of-week 

data patterns can also work as the average model to predict the passenger load factors in the future. 

Figure. 5. Passengers load Factor from Monday to Sunday. Blue lines: passenger load of a particular day. The red line: 

hourly average passenger load of all weeks. 

3.3 Regression Models 

In this paper, the regression models, including Neural Network, Regression Tree, and Gradient Boosting Decision 

Tree,  are  considered  and  evaluated  to  increase  the  prediction  accuracy  of  the  average  model.  The  inputs  of  these 

regression models are day-of-week, time-of-day, weathers, temperatures, wind levels, and holiday information. The 

 
 
 
data of temperatures is presented in Fig. 6.  The structures of each regression method are described in the following 

subsections. 

Figure. 6. The temperatures in Guangdong from 08/01/2014 to 12/24/2014. The blue line: the highest temperatures 

each day. The red line: the lowest temperatures each day. 

3.3.1 Neural Network 

Neural Networks (NN) are a class of statistical learning algorithms. Fig.  7. illustrates the structure of the four 

layers perceptron network used in the study. 

Figure. 7. Neural Network structure for the passenger load factor prediction. 

The hidden layer performs nonlinear transforms for the feature extractions. Because the ReLu function provides 

fast calculation and converging speeds without a gradient vanishing issue, in the hidden layers, the ReLu function is 

selected as the activation function, 

For the neuron in the output layer, a linear activation function is applied, 

ğ‘…ğ‘’ğ¿ğ‘ˆ = max(0, ğ‘¥)

ğ‘Œ = ğœƒğ‘‡ğ‘

(12) 

(13) 

 
 
 
During the training, the backpropagation algorithm is used to adjusts the weights and thresholds of each neuron 

to minimize the error between the true passenger load factor and predicted results of the NN with current parameters 

sets up. In this paper, the NN is trained using gradient descent backpropagation for 200 epochs. For a further discussion 

of neural networks, readers can find more details in [28]. 

3.3.2 Regression Tree 

Regression Tree (RT) is one type of decision tree and a machine learning method for predictions. Fig. 8. illustrates 

the structure of the Regression Tree used in the study. As a tree structure, the feature space of the RT is recursively 

partitioned into small parts to create its node and leaves. Once the splitting is completed, each leaf is fitted by a simple 

regression model.  

Figure. 8. Regression Tree structure for the passenger load factor prediction.  

During the training process, the tree recursively splits a node (data set), ğ‘†, into two child nodes (subsets), ğ‘†ğ¿ğ‘’ğ‘“ğ‘¡ 

and ğ‘†ğ‘Ÿğ‘–ğ‘”â„ğ‘¡. By exhaustively searching over data space, the division ğœƒ = (ğ‘˜, ğ‘¡ğ‘), composed of feature k and threshold 

ğ‘¡ğ‘,  is selected to minimizes the total impurity of two child nodes. The forms of each child nodes are, 

ğ‘†ğ¿ğ‘’ğ‘“ğ‘¡(ğœƒ) = {ğ‘†| ğ‘‹ğ‘˜ â‰¤ ğ‘¡ğ‘}

ğ‘†ğ‘Ÿğ‘–ğ‘”â„ğ‘¡(ğœƒ) = {ğ‘†| ğ‘‹ğ‘˜ > ğ‘¡ğ‘}

(14) 

(15) 

In the paper, the impurity is defined as the sum of squared deviations between each passenger load factor data 

and the mean of all the passenger load factor variables in this branch, ğ‘¦Ì…. For a branch with ğ‘ variables, the impurity 

functions ğ‘ƒ is given by, 

ğ‘¦Ì… =

1
ğ‘

ğ‘
âˆ‘ ğ‘¦ğ‘–
ğ‘–=1

(16) 

 
 
 
ğ‘ƒ =

1
ğ‘

ğ‘
âˆ‘(ğ‘¦ğ‘– âˆ’ ğ‘¦Ì…)2
ğ‘–=1

(17) 

The  training process stops after the  relative  decrease  in the impurity is below a prespecified threshold, or the 

maximum tree depth is reached. For more discussions about a Classification and Regression Tree, more details can be 

found in [29]. 

3.3.3 Gradient Boosting Decision Tree 

A Gradient Boosting Decision Tree (GBDT) uses an ensemble of decision tresses for predictions. During the 

training, a series of small decision trees are built. Each decision tree attempts to correct residuals from the previous 

one. The structure of the GBDT for the passenger load factor prediction is shown in Fig. 9. 

Figure. 9. The structure of Gradient Boosting Decision Tree for the passenger load factor prediction. 

In  this  paper,  the  mean  of  the  passenger  load  factors  of  the  whole  data  set  is  selected  as  the  baseline  of  the 

predictions. By comparing the predictions with actual data, residuals, ğ‘Ÿ, can be calculated by the following equation, 

where, the ğ‘‹ is a set of inputs, ğ‘¦ğ‘– and ğ‘¦Ì‚(ğ‘‹) are the actual with the predicted data with given inputs. A decision tree 

with a shallow max depth can be constructed to predict the residuals based on the previous prediction results. With 

ğ‘Ÿğ‘– = ğ‘¦ğ‘– âˆ’ ğ‘¦Ì‚(ğ‘‹ğ‘–)

(18) 

the additional decision tree, the prediction with inputs ğ‘‹ are updated by the following the equation, 

where, the ğ‘ is this baseline, ğ›¼ is  the learning rate that controls how hard each new  tree tries to correct remaining 

ğ‘¦Ì‚(ğ‘‹ğ‘–) = ğ‘ + ğ›¼ âˆ— ğ·ğ‘‡(ğ‘‹ğ‘–)

(19) 

residuals from the previous round, and ğ·ğ‘‡(ğ‘‹) represents the predicted residual with given inputs. After prediction 

values are updated, residuals are calculated again to generate a new decision tree, which further improves prediction 

accuracy. The training processes repeat until the maximum numbers of decision trees are created. Once trained, all of 

the decision trees in the ensemble are used to make a final prediction by, 

 
ğ‘
ğ‘¦Ì‚(ğ‘‹ğ‘–) = ğ‘ + âˆ‘ ğ›¼ âˆ— ğ·ğ‘‡ğ‘š(ğ‘‹ğ‘–)
ğ‘š=1

(20) 

where, ğ‘, is total numbers of decision trees. Readers can find more details about the Gradient Boosting Decision in 

[30]. 

4. Energy management strategies 

This section introduces the three EMS utilized in this study. The structure of the three EMS is shown in Fig. 10. 

The first EMS is a standard offline dynamic programming strategy. All the future passenger load information is prior 

knowledge for dynamic programming. Due to the high computational cost of dynamic programming, the first EMS is 

only implemented in offline. The second EMS addresses the weakness of the high computational cost by extracting 

the rules from the offline dynamic programming results and implementing the rules in an online rule-based controller. 

However, this rule-based controller is not benefited from passenger load prediction. The third EMS is the proposed 

EMS framework by combining the advantages of the first EMS, second EMS, passenger load prediction model, V2I, 

and cloud computing. It takes advantage of the power cloud cluster to execute the dynamic programming using the 

predicted passenger load. The dynamic programming rule extraction is real-time conducted, and the rule is loaded to 

the onboard  vehicle  controller via the V2I connectivity. Detailed explanations of the three EMS are introduced in 

section 4.1, 4.1, and 4.3, respectively.  

(a) 

(b) 

(c) 

Figure. 10. Three  EMS  used  in  this  study:  (a)  standard  DP  with  true  passenger  load  information,  (b)  rule-based 

controller with DP rule-extraction and no passenger load prediction, and (c) proposed cloud-based DP and rule-based 

controller with passenger load prediction. 

 
 
4.1 Dynamic Programming 

First proposed by Richard Bellman in 1950s [31], the dynamic programming method breaks down a complex 

optimization problem into multiple subproblems, solves the subproblems, saves the solutions into a table, and then 

finds the solutions for the complex problem by looking up the table. The advantages of dynamic programming include: 

1) Providing a globally optimal solution, 2) Designed for multi-stage decision processes, 3) Applicability of nonlinear 

systems, and 4) Handling of constraints. 

The DP method is adopted in this paper to understand the minimum cost that a global optimization could bring to 

the entire driving cycle. In this study, the cost function of dynamic programming is formulated as follows: 

ğ‘

ğ½(ğ‘˜) = âˆ‘(âˆ†ğ‘„ğ‘™ğ‘œğ‘ ğ‘ (ğ‘˜) âˆ— ğ‘ƒğ‘ğ‘ğ‘¡ + âˆ†ğ¸ğ‘™ğ‘œğ‘ ğ‘ (ğ‘˜) âˆ— ğ‘ƒğ‘’ğ‘™ğ‘’ + ğ‘Šğ‘ ğ‘ âˆ— ğœğ‘ ğ‘(ğ‘˜) + ğ‘Šğ‘ğ‘ğ‘¡ âˆ— ğœğ‘ğ‘ğ‘¡(ğ‘˜))

(21) 

ğ‘¡=ğ‘˜

subject to the system dynamics: 

and input constraints: 

ğ‘†ğ‘‚ğ¶ğ‘ğ‘ğ‘¡(ğ‘˜ + 1) = ğ‘†ğ‘‚ğ¶ğ‘ğ‘ğ‘¡(ğ‘˜) +

âˆ’ğ‘‡ğ‘ ğ¼ğ‘ğ‘ğ‘¡(ğ‘˜)
3600ğ‘„ğ‘ğ‘ğ‘¡

ğ‘†ğ‘‚ğ¶ğ‘ ğ‘(ğ‘˜ + 1) = ğ‘†ğ‘‚ğ¶ğ‘ ğ‘(ğ‘˜) +

âˆ’ğ‘‡ğ‘ ğ¼ğ‘ ğ‘(ğ‘˜)
ğ‘‰ğ‘ ğ‘ ğ‘€ğ´ğ‘‹ğ¶ğ‘ ğ‘

ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘(ğ‘˜) = ğ‘ƒğ‘ğ‘ğ‘¡(ğ‘˜) + ğ‘ƒğ‘ ğ‘(ğ‘˜)

ğ‘ƒğ‘ğ‘ğ‘¡(ğ‘˜) = ğ‘‚ğ¶ğ‘‰ğ‘ğ‘ğ‘¡(ğ‘˜)ğ¼ğ‘ğ‘ğ‘¡(ğ‘˜) + ğ‘…ğ‘ğ‘ğ‘¡ğ¼ğ‘ğ‘ğ‘¡(ğ‘˜)2

ğ‘ƒğ‘ ğ‘(ğ‘˜) = ğ‘‚ğ¶ğ‘‰ğ‘ ğ‘(ğ‘˜)ğ¼ğ‘ ğ‘(ğ‘˜) + ğ‘…ğ‘ ğ‘ğ¼ğ‘ ğ‘(ğ‘˜)2

ğ¼ğ‘ ğ‘ğ‘€ğ¼ğ‘ â‰¤ ğ¼ğ‘ ğ‘(ğ‘˜) â‰¤ ğ¼ğ‘ ğ‘ğ‘€ğ´ğ‘‹

ğ¼ğ‘ğ‘ğ‘¡ğ‘€ğ¼ğ‘ â‰¤ ğ¼ğ‘ğ‘ğ‘¡(ğ‘˜) â‰¤ ğ¼ğ‘ğ‘ğ‘¡ğ‘€ğ´ğ‘‹

and state constraints: 

ğ‘†ğ‘‚ğ¶ğ‘ ğ‘ğ‘šğ‘–ğ‘› âˆ’ ğœğ‘ ğ‘ğ‘™ğ‘œğ‘¤

(ğ‘˜) â‰¤ ğ‘†ğ‘‚ğ¶ğ‘ ğ‘(ğ‘˜) â‰¤ ğ‘†ğ‘‚ğ¶ğ‘ ğ‘ğ‘šğ‘ğ‘¥ + ğœğ‘ ğ‘â„ğ‘–ğ‘”â„

(ğ‘˜)

ğ‘†ğ‘‚ğ¶ğ‘ğ‘ğ‘¡ğ‘šğ‘–ğ‘› âˆ’ ğœğ‘ğ‘ğ‘¡ğ‘™ğ‘œğ‘¤

(ğ‘˜) â‰¤ ğ‘†ğ‘‚ğ¶ğ‘ğ‘ğ‘¡(ğ‘˜) â‰¤ ğ‘†ğ‘‚ğ¶ğ‘ğ‘ğ‘¡ğ‘šğ‘ğ‘¥ + ğœğ‘ğ‘ğ‘¡â„ğ‘–ğ‘”â„

(ğ‘˜)

ğœğ‘ğ‘ğ‘¡ â‰¥ 0

(22) 

(23) 

(24) 

(25) 

(26) 

(27) 

(28) 

(29) 

(30) 

(31) 

 
 
 
 
 
 
 
ğœğ‘ ğ‘ â‰¥ 0

and cost constraints: 

âˆ†ğ¸ğ‘™ğ‘œğ‘ ğ‘ (ğ‘˜) = (ğ¼ğ‘ğ‘ğ‘¡(ğ‘˜)2 âˆ— ğ‘…ğ‘ğ‘ğ‘¡ğ‘ ğ‘’ğ‘Ÿ + ğ¼ğ‘ ğ‘(ğ‘˜)2 âˆ— ğ‘…ğ‘ ğ‘ğ‘ ğ‘’ğ‘Ÿ) âˆ— ğ‘‡ğ‘ 

âˆ†ğ‘„ğ‘™ğ‘œğ‘ ğ‘ (ğ‘˜) = (ğ‘€ âˆ— exp (âˆ’

1
ğ‘§

ğ¸ğ‘
ğ‘…ğ‘‡ğ‘ğ‘ğ‘¡

))

ğ‘§âˆ’1
ğ‘§ (ğ‘˜)  âˆ—
âˆ— ğ‘„ğ‘™ğ‘œğ‘ ğ‘ 

ğ‘‡ğ‘  âˆ— ğ¼ğ‘ğ‘ğ‘¡(ğ‘˜)
3600

(32) 

(33) 

(34) 

where the sampling time ğ‘‡ğ‘  is 1 s, the price of battery capacity loss ğ‘ƒğ‘ğ‘ğ‘¡ is 694. 4 ğ‘ˆğ‘†ğ· / ğ´â„, and the price of electric 

ğ‘ƒğ‘’ğ‘™ğ‘’ is 0.1685 ğ‘ˆğ‘†ğ· / ğ‘˜ğ‘Šâ„.  To  avoid  the over-charging  and  over-discharging of batteries  and  supercapacitors,  the 

operation windows of batteries and supercapacitors are constrained by 10% to 90% SOC of batteries and 50% to 99% 

SOC of supercapacitors. ğ‘Šğ‘ ğ‘ and ğ‘Šğ‘ğ‘ğ‘¡ weight the state constraints violations. ğœğ‘ ğ‘ and ğœğ‘ğ‘ğ‘¡ are the slack variables on 

the state constraints. When both constraints are met, and slack variables ğœğ‘ ğ‘ and ğœğ‘ğ‘ğ‘¡ are zero in the optimal solution. 

However,  if  constraints  are  violated,  softened  state  constraints  ensure  the  feasibility  of  the  problem,  and  their 

associated linear weights can immediately penalize small constraint violations. ğ½(ğ‘˜) indicates the accumulative cost 

of the capacity loss of batteries and electric loss of resistances from time N to time k. According to Bellmanâ€™s cost-

to-go principle, by solving the DP backward, the minimal costs of all states along the entire driving cycle can be found 

and stored as a global optimal control strategy.  

4.2 Rule-based Controller with Rule Extraction from Dynamic Programming 

The  rule-based  method  is  one  of  the  most  widely  used  energy management  strategies  to  split  power between 

batteries and supercapacitors at different conditions. When the demand powers are high, the supercapacitors are used 

to supply the powers to avoid the degradation of batteries. However, supercapacitors cannot keep a high-power supply 

for a long time because of their relatively low energy density. The supercapacitors should be charged by regeneration 

power or batteries to keep the power supply ability for the future. Thus, the critical point of designing a rule-based 

controller is to figure out the charging and discharging conditions of the supercapacitors. The results of an offline DP 

are usually used to generate an optimal rule-based controller. By plotting one of the DP results in Fig. 11, we can see 

that the relationship between the power demands and supply powers of supercapacitors is almost linear. Because the 

DP  provides  globally  optimal  results,  by  fitting  the  relationship  between  the  power  demand  and  supply  power  of 

supercapacitors with the linear regression method, an optimal rule of the rule-based controller can be obtained. 

 
 
 
 
Figure. 11. DP result of ğ‘ƒğ‘ ğ‘ ğ‘£ğ‘ . ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ with 100 % passenger load factor. 

Due  to  the  lack  of  future  power  profile  information,  to  avoid  the  over-charged  and  over-discharge  of  the 

supercapacitors, 1% SOC buffer zones are set for the lower and higher bounds of the supercapacitor SOC operation 

range. The flow chart of the rule-based controller is presented in Fig. 12. Supercapacitor only uses the extracted rule 

from DP when ğ‘†ğ‘‚ğ¶ğ‘†ğ¶ is in the range of 51%-99%. 

Figure. 12. The flow chart of the rule-based control that extracted from DP results. 

4.3 Cloud-based Dynamic Programming with Passenger Load Prediction 

The rapid developments of cloud computation and telecommunication technologies provide the potentials to apply 

high  computational  cost  but  optimal  algorithms  for  real-time  applications.  With  cloud  assisting,  real-time  traffic 

information can be collected, and the algorithm mentioned in the previous section about the city bus passenger load 

factors  prediction  can  be  implemented.  In  this  subsection,  an  innovative  energy  management  strategy,  combining 

dynamic programming via cloud computing and rule-based controller with the rule update, is proposed for hybrid-

electric buses. The structure of the proposed method is demonstrated in Fig. 10 (c). 

 
 
The power demands are predicted by collecting traffic information and predicting passenger load factors on the 

cloud side. A discrete-time DP is applied to generate reference power profiles of batteries and supercapacitors and the 

rule  of  the  rule-based  controller  with  predicted  power  demands.  The  prediction  horizon  of  the  DP  is  set  as  1200 

seconds, and the DP is performed every 60 seconds with updated current states of the batteries and supercapacitors. 

Namely, the DP works as a block model predictive controller that generates optimal reference control signals with a 

long prediction horizon and allows the local controllers to follow the first 5% of the reference control signals. The 

prediction horizon and update frequency are design parameters determined by the trade-off between computational 

cost and performances. With accurate models and predicted power demands, a longer prediction horizon and faster 

update frequency provide better performances but lead to higher computational costs. 

Due  to  the  disturbances  and  the  predictive  errors of  passenger  load  factors  and  traffic  information,  the  actual 

power demands may differ from the reference power demand used in cloud DP. Thus, on the vehicle side, the rule-

based  controller  is  used  to  handle  the  errors  between  the  actual  and  reference  power  demands  by  the  following 

equations, 

ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ğ‘Ÿğ‘’ğ‘“ = ğ‘ƒğ‘ ğ‘ğ‘Ÿğ‘’ğ‘“ + ğ‘ƒğ‘ğ‘ğ‘¡ğ‘Ÿğ‘’ğ‘“

ğ‘ƒğ‘ ğ‘ = ğ‘ƒğ‘ ğ‘ğ‘Ÿğ‘’ğ‘“ + (ğ‘“ğ‘Ÿğ‘¢ğ‘™ğ‘’ (ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘)  âˆ’ ğ‘“ğ‘Ÿğ‘¢ğ‘™ğ‘’  (ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ğ‘Ÿğ‘’ğ‘“))

ğ‘ƒğ‘ğ‘ğ‘¡ = ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ âˆ’ ğ‘ƒğ‘ ğ‘

(35) 

(36) 

(37) 

where,  ğ‘ƒğ‘ ğ‘ğ‘Ÿğ‘’ğ‘“ and ğ‘ƒğ‘ğ‘ğ‘¡ğ‘Ÿğ‘’ğ‘“ are the reference powers of batteries and supercapacitors from the cloud DP, ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ğ‘Ÿğ‘’ğ‘“  

and ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ are the reference and actual power demand, ğ‘ƒğ‘ ğ‘ and ğ‘ƒğ‘ğ‘ğ‘¡ are the actual powers supplied from batteries 

and supercapacitors, and ğ‘“ğ‘Ÿğ‘¢ğ‘™ğ‘’ is the optimal rule of a rule-based controller is updated by the optimization results of 

the cloud DP.  

5. Results Analysis 

In this study, real-time energy management strategies are tested and validated by the typical China Bus Driving 

Cycle (CBDC). The CBDC speed profile was converted to different power demand profiles with different passenger 

load conditions. The CBDC speed profile and power profiles with different passenger load factors are presented in 

Fig. 13. The CBDC speed profile shows  frequent acceleration and braking events with the maximum speed below 

15m/s (i.e., 53kg/h or 33mph). Power demand varies significantly along with different passenger load factor as the 

100% load factors results in high peaks at high speed and deep valleys at braking. 

 
(a) CBDC speed profile                    (b) CBDC power profile with different passenger load factors  

Figure. 13. China Bus Driving Cycle  

5.1 Aging Effect  

In order to analyze the impact factors of an optimal energy management strategy generation of hybrid city buses, 

a comparison study is performed in this subsection. The dynamic programming approach was utilized as the energy 

management strategy in the battery aging effect discussion. 

Based on Eq. (7), the delta capacity loss in a sample time depends on the battery temperature, C-rate, and previous 

accumulated battery capacity loss. As shown in Fig. 14, with fixed battery temperature and crate, the delta capacity 

loss of a battery in a sampling time decreases while the battery is aging (i.e., y-axis drops as state-of-health (SOH) 

decreases from 100% to 50%). SOH = 100% corresponds to a brand-new battery and SOH = 0 % means 20% capacity 

loss,  as  known  as  end-of-life  (EOL).  Namely,  the  cost  of  battery  capacity  loss  in  a  sampling  time  will  decrease 

progressively  as  the  batteries  aged  at  the  same  operating  conditions.  In  addition,  using  batteries  to  charge 

supercapacitors  leads  to  extra  electrical  costs  because  of  the  electrical  energy  losses  due  to  the  resistances  of 

supercapacitors. Thus, one thing that can be expected is that the battery aging effect impacts the formulation of optimal 

energy management strategy. If the state-of-health of the batteries is low, the optimization algorithm (21) will put 

more effort into minimizing the electric loss rather than the battery degradation loss. 

 
 
 
Figure. 14. The delta capacity loss of a battery with 1 C discharge current from 100 % SOH to 50% SOH. 

To  further  validate  and  analyze  the  aging  effect  of  the  batteries  on  the  optimal  energy  management  strategy 

generation,  the  control  strategies  that  consider  the  aging  effect  have  been  tested  in  this  study.  The  dynamic 

programming generates two control strategies with the same power profiles but different battery SOH values. Then, 

these two control strategies are tested by the same vehicle operating condition. The results are shown in Fig. 15.  

As shown in Fig. 15, the strategy (Strategy 1) represented by the blue line is generated with a 100 % passenger 

load factor and 100 % SOH. The strategy (Strategy 2) showed by the red line came from the 100% passenger load 

factor and 0 % SOH. In the test, both strategies were tested by an operation condition with a 100 % load factor and 

100 % battery SOH. The total costs of Strategy 1 and strategy 2 are 3.8573 USD and 3.8795 USD, respectively. The 

result means that the correct SOH strategy only brings 0.58% of improvement than the strategy generated with a wrong 

SOH value. Namely, in this test, the SOH does not play an important role in the optimal control strategy generation. 

The result is surprising as we would expect larger improvement with correct SOH estimation.  

 
 
 
Figure. 15. Aging  effect  comparisons  of  100%  SOH  and  0% SOH  DP  strategies  by using a  100%  SOH  operation 

condition: (a) power profiles of batteries, (b) power profiles of supercapacitors, (c) power demand profile, (d) SOC 

profiles of batteries, (e) SOC profiles of supercapacitors, and (f) total cumulated cost. 

To further investigate the logic behind the result, the costs along the CBDC using the same control strategy with 

100% and 0% SOH are plotted and shown in Fig. 16.  As shown in Fig. 16, the real-time cost of capacity loss with 0% 

SOH is much less than the cost with 100% SOH. The result matches the expectation. However, although the cost of 

battery capacity loss drops a lot from 100% SOH to 0% SOH, the real-time cost is still much higher than electrical 

loss. Namely, during the optimization, more efforts were put on minimizing the cost of the capacity loss rather than 

the electrical loss due to the resistance in both cases. As a  result, similar control strategies were gained even they 

generated from  different  SOH  conditions. In  conclusion,  the  SOH  of  a battery  would not  significantly  impact  the 

optimal  energy  split  strategy  generation  in  the  studied  vehicle  unless  the  manufacture  cost  the  Li-ion  batteries 

substantially decrease or electricity price increases in the future. 

(a) Cost with 100 % SOH Batteries                (b) Cost with 0 % SOH Batteries                       

Figure. 16. Real-time cost comparison with different SOH of Batteries. 

5.2 Passenger Loading Effect 

As shown in Fig. 13 (b), a higher load factor leads to higher power demands. Simultaneously, the higher power 

demands require higher C-rates that batteries and supercapacitors have to supply. As shown in Fig.  17, the battery 

capacity loss cost increases exponentially as the C-rate increases. Thus, as the passenger load factor increasing, more 

control efforts should be put on avoiding charging or discharging batteries with high C-rates to minimize the battery 

capacity loss.    

 
 
Figure. 17. The delta capacity loss of a battery with 1 C to 3.5 C discharge current and 100 % SOH. 

Two control strategies are generated based on 100% load (Strategy 1) and 0% load (Strategy 2), respectively, 

with the dynamic programming algorithm to investigate the effect of  the passenger load factor. These two control 

strategies were then tested with a 100 % load and 100 % battery SOH condition. As shown in Fig. 18, there is a large 

difference between the two strategies. When power demands are low, Strategy 1 is more likely to charge or save the 

energy of supercapacitors than Strategy 2. By keeping high SOC values of supercapacitors during low power demand 

range, Strategy 1 lets supercapacitors to provide more power supply than batteries when power demands are high. As 

a result, the total costs of Strategy 1 and strategy 2 are 3.8573 USD and 4.1369 USD, respectively. Without considering 

the loading effect, Strategy 2 introduced 7.24 % more cost than Strategy 1. This large percentage difference caused 

by the different passenger loading effect indicates the importance of the loading effect. It means that the passenger 

load factor should be considered while designing an optimal energy control strategy.  

 
 
Figure. 18. Loading effect comparisons of 100 % load and 0% load DP strategies basing on CBDC and 100 % load 

factor:  (a)  power  profiles  of  batteries,  (b)  power  profiles  of  supercapacitors,  (c)  power  demand  profile,  (d)  SOC 

profiles of batteries, (e) SOC profiles of supercapacitors, and (f) total cumulated cost. 

Besides, by extracting rules from DP, the fitted functions with CBDC and different passenger load factors are 

shown in Table 4 to demonstrate the impacts of passenger load factors on the rule update of rule-based controllers. 

The function in each row is fitted using the DP results considering the specific passenger load factor from that row. 

The rule of rule-based controller with different passenger load factors. 

Table 4 

Passenger Load Factor (%) 
0 
20 
40 
60 
80 
100 

Fitted Function (W) 

ğ‘ƒğ‘ ğ‘ = 0.8391 âˆ— ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ âˆ’ 11803 
ğ‘ƒğ‘ ğ‘ = 0.8277 âˆ— ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ âˆ’ 13808 
ğ‘ƒğ‘ ğ‘ = 0.8270 âˆ— ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ âˆ’ 15948 
ğ‘ƒğ‘ ğ‘ = 0.8268 âˆ— ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ âˆ’ 18247 
ğ‘ƒğ‘ ğ‘ = 0.8240 âˆ— ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ âˆ’ 20402 
ğ‘ƒğ‘ ğ‘ = 0.8183 âˆ— ğ‘ƒğ‘‘ğ‘’ğ‘šğ‘ğ‘›ğ‘‘ âˆ’ 22476 

As shown in Table 4, with a higher passenger load factor, the slop and intercept value  of a fitted function are 

smaller. Because a higher passenger load factor leads to high power demands, supercapacitors need to supply more 

power at the high-power demand ranges to minimize the capacity loss of batteries. The optimization results tend to 

charge supercapacitors with more powers or save the energy of supercapacitors when power demands are low. Thus, 

for proposed EMS, with the updated rule of the rule-base controller at different passenger load conditions, the error 

between predicted and true power demands can be handled in an optimal way.  

5.3 Passenger Load Factor Prediction  

The average and regression models are trained using the Guangdong line 11 city buses passenger load data sets 

from 08/01/2014 to 12/14/2014. In the subsection, these models are tested by one-week passenger load data  from 

12/15/2014 to 12/22/2014. From the test, the comparisons between actual and predicted passenger load factors of each 

model are presented in Fig. 19. Among the four models, RT and GBDT prediction results show good alignment with 

the true results. NN model has extremely good prediction accuracy on all the days except Dec 16 and 17. The average 

model underestimates nearly all the peak load factors. 

 
Figure. 19. Passenger load factor prediction test for RT, GBDT, NN, and Average models with one-week Guangdong 

line 11 city bus passenger load data from 12/15/2014 to 12/22/2014. 

To further analysis the accuracies of prediction results, the accuracy of the forecast is evaluated by the root mean 

squared error (RMSE), 

ğ‘…ğ‘€ğ‘†ğ¸ = âˆš

1
ğ‘š

ğ‘š
âˆ‘(ğ‘¦ğ‘– âˆ’ ğ‘¦Ì‚ğ‘–)2 
ğ‘–=ğ‘–

(38) 

where ğ‘¦ and ğ‘¦Ì‚ are the true and predicted passenger load factor, and m represents the number of the predictions. RMSE 

of each day and the whole week for each model are calculated and presented in Table 5. Besides, the variance of these 

RMSE of each model in the whole week are gained by using, 

ğ‘‰ =

1
ğ‘ âˆ’ 1

ğ‘
âˆ‘|ğ‘…ğ‘€ğ‘†ğ¸ğ‘– âˆ’ ğ‘…ğ‘€ğ‘†ğ¸
ğ‘–=1

Ì…Ì…Ì…Ì…Ì…Ì…Ì…Ì…|2

(39) 

where, N is the numbers of day in a week, and ğ‘…ğ‘€ğ‘†ğ¸

Ì…Ì…Ì…Ì…Ì…Ì…Ì…Ì… is the mean RMSE of each model.  

 
 
 
The RMSE of each day and the whole week for each model. 

Table 5 

   RSME 
Model 
RT 
GBDT 
NN 
Average 

Mon 

Tu  

Wed  

Th 

Fri  

Sat 

Sun  

Total  

Variance 

 3.0113 
 3.2303 
 5.4844 
 10.3139  7.1619 

5.7436 
3.2929 
14.9115 

 6.6337 
 4.2915 
 1.3670 
8.5135 

4.2158 
3.6366 
0.0665 
4.7929 

4.2971 
2.7078 
0.0091 
3.7301 

3.8723 
6.5581 
0.0017 
5.1463 

6.0119 
7.6120 
2.1439 
9.1172 

4.9776 
4.7988 
6.0816 
7.3353 

1.7285 
3.4977 
29.4542 
6.1290 

As shown in Table 5, the three regression models all work very well. NN model provides very accurate predictions 

from Wednesday to Sunday. The performances of the RT model are good and very stable, with the lowest RSME 

variance. The prediction results of GBDT have the lowest RMSE for the whole week, and the variance is the second-

best only behind the RT model. As a result, the GBDT model is selected as the most suitable model for the passenger 

load factor prediction in this study due to the benefits which the GBDT model are brought including, 1) high prediction 

accuracy,  2)  fast  prediction  speed  while  only  requiring  modest  memory,  3)  without  requiring  complex  feature 

engineering to perform well, and 4) ability to handle a mixture of feature types. 

5.4 Comparison of Three Energy Management Strategies 

In this subsection, the proposed method is evaluated and discussed with true passenger load data of Guangdong 

Transit Bus Line 11 on 12/15/2014 and CBDC. The real passenger load data at peak hour 8:00 AM and off-peak hour 

12:00 PM are used in the test because the tests in these hours represent the most and least impacts of loading effect. 

The plot of true and GBDT predicted passenger load factors on this day are presented in Fig.  20. The predicted and 

true passenger load factor aligns very well over the 16 hours span without large error. The comparison results are 

summarized in Table 6. During the busy hours (i.e., 8:00 AM), the prediction error is under 10%. At noon, the error 

is large at 20% due to the low absolute load factor at around 30%. 

Figure. 20. Predicted and true passenger load factors of Guangdong city bus line 11 on 12/15/2014. 

 
 
 
Predicted and true passenger load factor, and prediction error at peak and off-peak hours of Guangdong city bus line 

Table 6 

11 on 12/15/2014. 

Hour 

Predicted Load Factor 

True Load Factor 

Absolute error 

Error percentage 

8:00 AM 

12:00 PM 

98% 

24% 

90% 

30% 

8% 

6% 

8.9% 

20% 

In order to evaluate the performances of the proposed method, its test results are compared with the results of 

optimal DP strategies and the pure rule-based method, which does not consider the loading effect. The pure rule-based 

method used in the test is generated from the CBDC speed profile. However, under other driving cycles, the driving 

patterns that are different from the CBDC, the performance of the pure rule-based method may lead to significant 

downgrades. Thus, the rule-based method results in the test represent the best performances that a conventional rule-

based method can bring for an electric city bus. The optimal DP strategies are generated from the true passenger load 

factors and actual speed profile and represent the best results that can be gained at these vehicle operating conditions.  

The comparison results at 8:00 AM are shown in Fig. 21 and Table 7. These total costs of the proposed method, 

pure rule-based method, and optimal DP strategy are 3.6890, 4.1181, and 3.6885 USD, respectively. As shown in the 

supercapacitor SOC subplot, the proposed method provides a similar control strategy as the optimal DP strategy, while 

the pure rule-based method has a totally different SOC curve. Multiple supercapacitor SOC saturations are spotted 

between 400s and 1200s, which disables the possibility of discharge assistant to the battery at high power demand 

situations. This leads to the peaks from the pure rule-based method in the battery power subplot, during which the 

battery  power  sits  at  low  levels  for  the  other  two  methods.  The proposed method  and  optimal  DP  method  have a 

smoother battery SOC curve than the pure rule-based method. Even though the pure rule-based method shows the 

least cumulative cost at 450s, its supercapacitor SOC saturates at that time, and the cost immediately goes up, finally 

surpasses the costs from the other two methods. For the proposed method, even if there is an 8.9% prediction error of 

the  passenger load factor, only 0.0136% of the difference between the total costs of the proposed method and the 

optimal DP strategy is introduced. On the other side, the proposed method brings 10.4199% of cost reduction than the 

pure rule-based method in the peak-hour. 

 
Figure. 21. Comparison of the proposed method, pure rule-based method, and optimal DP strategy with CBDC and 

true passenger load factor at 8:00 AM of Guangdong Transit Bus Line 11 on 12/15/2014: (a) power profiles of batteries, 

(b) power profiles of supercapacitors, (c) power demand profile, (d)  SOC profiles of batteries, (e) SOC profiles of 

supercapacitors, and (f) total cumulated cost. 

Figure. 22. Comparison of the proposed method, pure rule-based method, and optimal DP strategy with CBDC and 

true  passenger  load  factor  at  12:00  PM  of  Guangdong  Transit  Bus  Line  11  on  12/15/2014:  (a)  power  profiles  of 

batteries,  (b)  power profiles  of  supercapacitors,  (c)  power  demand profile,  (d)  SOC  profiles  of  batteries,  (e)  SOC 

profiles of supercapacitors, and (f) total cumulated cost. 

Table 7 

Total costs of proposed and pure rule-based methods compare with the optimal DP cost at the peak hour (8:00 AM) 

and off-peak hour (12:00 PM). 

Peak Hour (8:00 AM) 

Off-peak Hour (12:00 PM) 

Methods 

Proposed method 

Total Cost 
(USD) 
3.6890 

Compare with Optimal 
DP 
0.0136 % more cost 

Total Cost 
(USD) 
2.6869 

Compare with Optimal 
DP 
0.0298 % more cost 

 
 
Pure rule-based method 

4.1181 

11.647 % more cost 

2.7973 

4.1398 % more cost 

As shown as Fig. 22 and Table 7, the total cost of the proposed method, pure rule-based method, and optimal DP 

strategy at 12:00 PM are 2.6869, 2.7973, and 2.6861 USD, respectively. The proposed method has a very similar SOC 

trajectory of the supercapacitors as the optimal DP strategy. The difference in the total costs between the proposed 

method and the optimal DP strategy is 0.0298%, while a 25% error of the passenger load factor is introduced. It means 

that the proposed method is very robust against the prediction error of the passenger load factor. One thing remarkable 

is that, before the 1000s, the cost of the pure rule-based method is low than the costs of the proposed method and 

optimal DP. The reason is that with prediction and prior knowledge about the future power demand, the proposed 

method and rule-based method focus on minimizing the total cost of the whole circle rather than the current cost. Thus, 

using these two strategies, the batteries will charge and save the energy of supercapacitors for the future. It leads to 

higher costs at the beginning but saves more cost in the end because it allows the supercapacitors to have enough 

energy to supply during high power demands conditions. Besides, it further illustrates that without the predictions of 

future power demands, the performance of the traditional rule-based methods is limit. In addition, even if the 12:00 

PM  is  the  off-peak  hour,  which  includes  the  less  loading  effect,  the  proposed  method  leads  3.946%  of  cost 

improvement than the pure rule-based method. 

6. Conclusion: 

In this paper, a dynamic programming approach is utilized as the battery/ supercapacitor hybrid electric bus EMS 

in the battery aging effect and passenger loading effect discussion. The passenger loading effect plays a more dominant 

role than the battery aging effect does on the bus operation cost. Four different models are presented for predicting 

the passenger load factors of city buses. GBDT Model is selected as the best passenger load factor prediction model 

for  its  high  accuracy  and  stability.  Even  though  the  neural  networks  model  has  high  accuracy  in  certain  days,  its 

performance is not consistent throughout the entire week, and its stability is extremely bad. A new EMS comprised of 

a cloud DP and rule-based controller with the rule update is proposed. To evaluate the proposed EMS performances, 

the proposed EMS is compared with the optimal DP method and the pure rule-based method. In this case, the proposed 

EMS and optimal DP share similar results with less than 1% difference. At peak and off-peak hours, the proposed 

EMS reduces 10.419% and 3.946% cost than the pure rule-based method.  

 
In future studies, the size of the optimal components of supercapacitor and battery could be conducted. Besides, 

the performance of the rule-based controller used on the vehicle side can be further improved by increasing its rule 

with more heuristic principles in the EMS field. 

Reference: 

[1]  Cook, J., Oreskes, N., Doran, P.T., Anderegg, W.R.L., Verheggen, B., Maibach, E.W., Carlton, J.S., 

Lewandowsky, S., Skuce, A.G., Green, S.A., Nuccitelli, D., Jacobs, P., Richardson, M., Winkler, B., 

Painting, R., Rice, K., 2016. Consensus on consensus: a synthesis of consensus estimates on human-caused 

global warming. Environ. Res. Lett. 11, 048002. https://doi.org/10.1088/1748-9326/11/4/048002 

[2]  Yang, F., Xie, Y., Deng, Y., Yuan, C., 2018. Predictive modeling of battery degradation and greenhouse 

gas emissions from U.S. state-level electric vehicle operation. Nature Communications 9, 2429. 

https://doi.org/10.1038/s41467-018-04826-0 

[3]  Xu, B., Rathod, D., Zhang, D., Yebi, A., Zhang, X., Li, X., Filipi, Z., 2020. Parametric study on 

reinforcement learning optimized energy management strategy for a hybrid electric vehicle. Applied 

Energy 259, 114200. https://doi.org/10.1016/j.apenergy.2019.114200 

[4]  Yan, S., Chi, C.-J., Tang, C.-H., 2006. Inter-city bus routing and timetable setting under stochastic 

demands. Transportation Research Part A: Policy and Practice 40, 572â€“586. 

https://doi.org/10.1016/j.tra.2005.11.006 

[5]  KivekÃ¤s, K., Lajunen, A., VepsÃ¤lÃ¤inen, J., Tammi, K., 2018. City Bus Powertrain Comparison: Driving 

Cycle Variation and Passenger Load Sensitivity Analysis. Energies 11, 1755. 

https://doi.org/10.3390/en11071755 

[6]  Zhang, J., Lv, C., Qiu, M., Li, Y., Sun, D., 2013. Braking energy regeneration control of a fuel cell hybrid 

electric bus. Energy Conversion and Management 76, 1117â€“1124. 

https://doi.org/10.1016/j.enconman.2013.09.003 

[7]  Pihlatie, M., Kukkonen, S., Halmeaho, T., Karvonen, V., Nylund, N.-O., 2014. Fully electric city buses - 

The viable option, in: 2014 IEEE International Electric Vehicle Conference (IEVC). Presented at the 2014 

IEEE International Electric Vehicle Conference (IEVC), pp. 1â€“8. 

https://doi.org/10.1109/IEVC.2014.7056145 

[8]  An, K., 2020. Battery electric bus infrastructure planning under demand uncertainty. Transportation 

Research Part C: Emerging Technologies 111, 572â€“587. https://doi.org/10.1016/j.trc.2020.01.009 

[9]  Song, Z., Li, J., Han, X., Xu, L., Lu, L., Ouyang, M., Hofmann, H., 2014. Multi-objective optimization of a 

semi-active battery/supercapacitor energy storage system for electric vehicles. Applied Energy 135, 212â€“

224. https://doi.org/10.1016/j.apenergy.2014.06.087 

[10] Hou, J., Sun, J., Hofmann, H., 2017. Battery/flywheel Hybrid Energy Storage to mitigate load fluctuations 

in electric ship propulsion systems, in: 2017 American Control Conference (ACC). Presented at the 2017 

American Control Conference (ACC), pp. 1296â€“1301. https://doi.org/10.23919/ACC.2017.7963131 

[11] Liu, S., Wei, L., Wang, H., 2020. Review on reliability of supercapacitors in energy storage applications. 

Applied Energy 278, 115436. https://doi.org/10.1016/j.apenergy.2020.115436 

[12] Martinez, C.M., Hu, X., Cao, D., Velenis, E., Gao, B., Wellers, M., 2017. Energy Management in Plug-in 

Hybrid Electric Vehicles: Recent Progress and a Connected Vehicles Perspective. IEEE Transactions on 

Vehicular Technology 66, 4534â€“4549. https://doi.org/10.1109/TVT.2016.2582721 

[13] Xu, B., Hou, J., Shi, J., Li, H., Rathod, D., Wang, Z., Filipi, Z., 2020. Learning Time Reduction Using 

Warm Start Methods for a Reinforcement Learning Based Supervisory Control in Hybrid Electric Vehicle 

Applications. IEEE Transactions on Transportation Electrification 1â€“1. 

https://doi.org/10.1109/TTE.2020.3019009 

[14] LÃ³pez-Ibarra, J.A., Goitia-Zabaleta, N., Herrera, V.I., Gazta Ã±aga, H., Camblong, H., 2020. Battery aging 

conscious intelligent energy management strategy and sensitivity analysis of the critical factors for plug-in 

hybrid electric buses. eTransportation 5, 100061. https://doi.org/10.1016/j.etran.2020.100061 

[15] Xiong, W., Zhang, Y., Yin, C., 2009. Optimal energy management for a seriesâ€“parallel hybrid electric bus. 

Energy Conversion and Management 50, 1730â€“1738. https://doi.org/10.1016/j.enconman.2009.03.015 

[16] Xie, S., Li, H., Xin, Z., Liu, T., Wei, L., 2017. A Pontryagin Minimum Principle-Based Adaptive 

Equivalent Consumption Minimum Strategy for a Plug-in Hybrid Electric Bus on a Fixed Route. Energies 

10, 1379. https://doi.org/10.3390/en10091379 

[17] Sockeel, N., Shi, J., Shahverdi, M., Mazzola, M., 2018. Pareto Front Analysis of the Objective Function in 

Model Predictive Control Based Power Management System of a Plug-in Hybrid Electric Vehicle, in: 2018 

IEEE Transportation Electrification Conference and Expo (ITEC). Presented at the 2018 IEEE 

Transportation Electrification Conference and Expo (ITEC), pp. 1â€“6. 

https://doi.org/10.1109/ITEC.2018.8449957 

[18] Song, Z., Hofmann, H., Li, J., Han, X., Ouyang, M., 2015. Optimization for a hybrid energy storage system 

in electric vehicles using dynamic programing approach. Applied Energy 139, 151â€“162. 

https://doi.org/10.1016/j.apenergy.2014.11.020 

[19] Time-Efficient Stochastic Model Predictive Energy Management for a Plug-In Hybrid Electric Bus With an 

Adaptive Reference State-of-Charge Advisory - IEEE Journals & Magazine [WWW Document], n.d. URL 

https://ieeexplore.ieee.org/document/8270601 (accessed 10.13.20). 

[20] Moura, S.J., Fathy, H.K., Callaway, D.S., Stein, J.L., 2011. A Stochastic Optimal Control Approach for 

Power Management in Plug-In Hybrid Electric Vehicles. IEEE Transactions on Control Systems 

Technology 19, 545â€“555. https://doi.org/10.1109/TCST.2010.2043736 

[21] Zhang, F., Hu, X., Langari, R., Cao, D., 2019. Energy management strategies of connected HEVs and 

PHEVs: Recent progress and outlook. Progress in Energy and Combustion Science 73, 235â€“256. 

https://doi.org/10.1016/j.pecs.2019.04.002 

[22] Hou, J., Song, Z., 2020. A hierarchical energy management strategy for hybrid energy storage via vehicle-

to-cloud connectivity. Applied Energy 257, 113900. https://doi.org/10.1016/j.apenergy.2019.113900 

[23] Xing, Y., Lv, C., Wang, H., Cao, D., Velenis, E., Wang, F.-Y., 2019. Driver Activity Recognition for 

Intelligent Vehicles: A Deep Learning Approach. IEEE Transactions on Vehicular Technology 68, 5379â€“

5390. https://doi.org/10.1109/TVT.2019.2908425 

[24] Ma, Z., Xing, J., Mesbah, M., Ferreira, L., 2014. Predicting short-term bus passenger demand using a 

pattern hybrid approach. Transportation Research Part C: Emerging Technologies 39, 148â€“163. 

https://doi.org/10.1016/j.trc.2013.12.008 

[25] Mercedes-Benz Buses: eCitaro [WWW Document], n.d. URL https://www.mercedes-benz-

bus.com/en_DE/models/ecitaro.html (accessed 10.13.20). 

[26] Song, Z., Hofmann, H., Li, J., Hou, J., Han, X., Ouyang, M., 2014. Energy management strategies 

comparison for electric vehicles with hybrid energy storage system. Applied Energy 134, 321â€“331. 

https://doi.org/10.1016/j.apenergy.2014.08.035 

[27] Zhang, L., Hu, X., Wang, Z., Sun, F., Dorrell, D.G., 2018. A review of supercapacitor modeling, 

estimation, and applications: A control/management perspective. Renewable and Sustainable Energy 

Reviews 81, 1868â€“1878. https://doi.org/10.1016/j.rser.2017.05.283 

[28] Schmidhuber, J., 2015. Deep Learning in Neural Networks: An Overview. Neural Networks 61, 85â€“117. 

https://doi.org/10.1016/j.neunet.2014.09.003 

[29] Loh, W.-Y., 2011. Classification and regression trees. WIREs Data Mining and Knowledge Discovery 1, 

14â€“23. https://doi.org/10.1002/widm.8 

[30] Friedman, J.H., 2001. Greedy function approximation: A gradient boosting machine. Ann. Statist. 29, 

1189â€“1232. https://doi.org/10.1214/aos/1013203451 

[31] Bellman, R., 1966. Dynamic Programming. Science 153, 34â€“37. 

https://doi.org/10.1126/science.153.3731.34 

 
 
