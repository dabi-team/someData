7
1
0
2

r
a

M
8
2

]

V
C
.
s
c
[

2
v
7
6
2
8
0
.
9
0
6
1
:
v
i
X
r
a

De-noising,StabilizingandCompleting3DReconstructionsOn-the-gousingPlanePriorsMaksymDzitsiuk1,2,J¨urgenSturm2,RobertMaier1,LingniMa1andDanielCremers1Abstract—Creating3Dmapsonrobotsandothermobiledeviceshasbecomearealityinrecentyears.Online3DreconstructionenablesmanyexcitingapplicationsinroboticsandAR/VRgaming.However,thereconstructionsarenoisyandgenerallyincomplete.Moreover,duringonlinereconstruction,thesurfacechangeswitheverynewlyintegrateddepthimagewhichposesasigniﬁcantchallengeforphysicsenginesandpathplanningalgorithms.Thispaperpresentsanovel,fastandrobustmethodforobtainingandusinginformationaboutplanarsurfaces,suchaswalls,ﬂoors,andceilingsasastagein3DreconstructionbasedonSignedDistanceFields(SDFs).Ouralgorithmrecoverscleanandaccuratesurfaces,reducesthemovementofindividualmeshverticescausedbynoiseduringonlinereconstructionandﬁllsintheoccludedandunobservedregions.Weimplementedandevaluatedtwodifferentstrategiestogenerateplanecandidatesandtwostrategiesformergingthem.Ourimplementationisoptimizedtoruninreal-timeonmobiledevicessuchastheTangotablet.Inanextensivesetofexperiments,wevalidatedthatourapproachworkswellinalargenumberofnaturalenvironmentsdespitethepresenceofsigniﬁcantamountofocclusion,clutterandnoise,whichoccurfrequently.Wefurthershowthatplaneﬁttingenablesinmanycasesameaningfulsemanticsegmentationofreal-worldscenes.I.INTRODUCTIONInthispaperweinvestigatetheproblemofreal-time,on-device3Dreconstruction.Whileexisting3Dreconstructionalgorithms[1]–[6]aremostlytargetedatofﬂineuseoftheresulting3Dmodels,manyapplicationsinroboticsandARgamingrequirethatvalidanddependablemodelsexistalreadyduringmodelacquisition,e.g.,becausetherobotorplayeractivelyexplorestheenvironmentwhilethe3Dmodelisbeingacquired.Thisleadstoseveralinterestingproblemsthathaven’tre-ceivedmuchattentionsofarandthatwetackleinthispaper:First,the3Dmodelchangeswitheverynewobservation,whichleadstoawobblingsurfaceandchangingtopology(seeFig.3forananalysis),whichposesaproblemforpathplanningalgorithmsandphysicssimulations.Forexample,virtualballsthrownintothemeshofacurrentlyreconstructedroomwillcontinuouslyrollaroundasthereconstructiongetsreﬁned.Atowerofvirtualobjectsfallswithoutuserinterventionforthesamereason(Fig.2).Second,the3Dreconstructiontypicallycontainsholesandisgenerallyin-complete,evenafterscanninghasbeenﬁnalized.Similarly,1MaksymDzitsiuk,RobertMaier,LingniMaandDanielCremersarewiththeComputerVisionGroup,DepartmentofComputerScience,TechnicalUniversityofMunich{dzitsiuk,maierr,lingni,cremers}@in.tum.de.2MaksymDzitsiukandJ¨urgenSturmarewithGoogle{dzitsiuk,jsturm}@google.com.(a)Rawreconstruction(b)De-noisedreconstruction(c)Holeﬁlling(d)ObjectsegmentationFig.1.Real-worldscansgenerallysufferfromnoiseandholesinthereconstructedmodels(topleft).Inman-madeenvironments,thenoisecanbesigniﬁcantlyreducedbyapplyingaplaneprior(topright).Furthermore,byextendingthedetectedplanesintounobservedregions,holescanbeﬁlledautomatically(bottomleft).Thisalsoenablesscenesegmentationandobjectdetection(bottomright).thiscausesproblemsforrobotnavigationandsimulatedavatarsthatcannotreasonaboutspaceoutsideofthealreadyscannedarea.Third,thereconstructionsaregenerallynoisy(especiallyinthebeginning)whichis(atleast)visuallyunpleasantifnotproblematicfortraversabilityanalysis.Ourgoalisthustode-noise,stabilizeandcomplete3Dscansduringmodelacquisition.Whilethisisahardprobleminthegeneralcase,itbecomestractableinindoorenvironmentswherewemayexpectmanyplanarsurfaces.Incorporatingplanepriorsinto3Dindoorreconstructionsce-nariosyieldscleaner,morerealisticandmorecomplete3Dmodelsofroomsorhouse-scaleenvironmentsbyimprovingthegeometricreconstructionofwalls,ﬂoorsandotherplanarsurfaces.Figure1illustratesourapproach.Itisclearlyvisiblethatthenoiseissigniﬁcantlyreducedonplanarsurfacesresultinginamoreaccurateandvisuallymoreappealinggeometric3Dreconstruction.Furthermore,weareabletoclosevariousholesintheﬂoorandthewalls.Finally,objectscanbesegmentedandsemanticinformationcanbeattachedtothereconstructedscene.Toachievehigh-qualityreconstructionsfromcommodityRGB-Dsensors,manyapproachesfusenoisyrawdepthmapsinmemoryefﬁcientdatastructuressuchassigneddistanceﬁelds(SDF)[7].Theseimplicitsurfacerepresentationsallow 
 
 
 
 
 
Fig.2.Continuous3Dreconstructionisproblematicforphysicsengines.ThisimageshowsavirtualJengatowerstandingonaplanarsurface.Duetosensornoiseduringreconstruction,thetowerfallsoverwithoutapplyingaplaneprior.Fig.3.Duringonline3Dreconstruction,thesurfaceisconstantlymovingduetosensornoise.Theplotshowstherootmeansquaredifference(RMSD)betweenverticesofthereconstructedmeshovertime.Theexamineddataincludesstaticobservationofﬂoorover250frames,executed10times.forhighlyaccurategeometricrecontructionsandprovidetherequiredscalabilityandmemoryefﬁciency.Inthispaper,weintroduceanefﬁcientmethodtoapplyaplanepriorduringSDF-based3Dreconstruction.Theaccompanyingvideocanbefoundathttps://youtu.be/8OxwiRpmzn4.Themaincontributionsofthispaperare:•Weproposeanalgorithmforreal-time3Dreconstruc-tiononmobiledevicesthatincorporatespriorsformodellingplanarsurfacesofindoorenvironments.•WeintroduceanovelwayofestimatingplanesbyﬁttingthemtoSignedDistanceFields.ThepresentedmethodisbasedonrobustleastsquaresandisfasterthanRANSAC-basedmethods.Thedetectedlocalplanecandidatesaremergedtoﬁndgloballyconsistentplanes.•WeapplyourapproachtosigniﬁcantlyreducenoiseonﬂatsurfacesbycorrectingSDFvaluesusingdetectedplanes.Further,wedemonstratethatthemethodcanbeusedtoﬁllholesinincompletereconstructed3Dmodels.Lastly,weuseplanepriorstodirectlyobtainobject-levelandsemanticsegmentation(e.g.walls)ofindoorenvironments.II.RELATEDWORKInthissection,weﬁrstdiscussthemostrelatedworksofstate-of-the-artRGB-Dbased3Dreconstruction.Second,wediscusstheuseofplanepriorsin2.5/3Dreconstruction.3Dreconstructionwithsigneddistanceﬁelds:Kinect-FusionbyNewcombeetal.[1]wastheﬁrstsystemtoreconstructhighlyaccurate3Dmodelsofpersons,objectsandworkspacesoflimitedsize.ExtensionstoKinectFusionfocusonvariousaspectsof3Dmodeling.Bylowetal.[8]performdirectcameratrackingagainsttheSDF,whileNiessneretal.[3]enablelarge-scale3Dmappingusinganefﬁcientvoxelhashingscheme.Otherapproachestackletheproblemoflarge-scale3Dreconstructionbydirectframe-to-(key)frametrackingwithcontinuousposegraphoptimiza-tion[2]andsubsequentdatafusioninanOctree-basedSDFrepresentation[9]orbyachievingglobalconsistencyusingsubmap-basedbundleadjustment[10].Recently,theBundleFusionsystembyDaietal.[6]extends[3]toallowforlarge-scalereconstructionofpreviouslyunseengeometricaccuracy.However,noneoftheseframeworksexploitsplanepriorsfortrackingorimprovingthereconstructionquality.AsthesesystemsusuallyextensivelyrelyontheuseofGPUsorpowerfulCPUs,real-time3Dreconstructionapproachesfortheapplicationonmobiledeviceshavebeendesignedspeciﬁcally.K¨ahleretal.[5]modiﬁedthevoxelhashingframework[3]toefﬁcientlyworkinreal-timeonamobileNVIDIAShieldTabletwithabuilt-inGPU.Finally,ourworkisbasedonCHISEL[4]whichenablesdensehouse-scale3Dreconstructionsinreal-timeonaTangodevice.ThesystemdoesnotrelyonaGPUandcombinesvisual-inertialodometryforlocalizationwithanefﬁcientspatiallyhashedSDFvolumeformapping.Ourapproachusesthisimplicitsurfacerepresentationandcombinesitwithplanepriorsinordertoimprovereconstructionsinvariousways.Incorporatinggeometricpriorsduring3Dreconstruc-tion:Planesegmentationisausefulpreprocessingformanyindoorenvironmentmappingandtrackingalgorithms.Given3Dpointclouds,onecommonlyusedplaneseg-mentationalgorithmisbasedonRANdomSAmpleCon-sensus(RANSAC)[11].RANSAC-basedalgorithmsﬁndthepointclusterthatbestﬁtsaplanemodel,buttheyalsoproducefalsedetectionsinmanysituationsbecauseofnotconsideringunderlyingconnectivityofpoints.Totacklethisdrawback,manysolutionshavebeendevelopedbasedonregion-growing[12]–[15].WhenusingRGB-Dcameras,directplanedetectionondepthmapsbecomepossible,sincedensedepthmapsembedorganizedpointclouds.Holzetal.[16]proposedafastplanedetectionwhichperformsfastnormalestimationusingintegralimagesandsubsequentlyclusterspointsintoplanarregionsaccordingtothenormals.Fengetal.[17]developedanagglomerativehierarchicalclustering(AHC)algorithmwhichﬁndsblock-wiseplanarregionswithleastsquaresplaneﬁttingandthenmergesthelocalregionstoformcompleteplanesegments.Jiangetal.[18]ﬁtcuboidstodepthimagesbyﬁrstdividingtheimageintoplanarsuperpixelsandthenusingRANSACtogeneratesuitablecuboidcandidates.Silbermanetal.[19]useaprobabilisticmodeltocompletetheboundariesofoccludedobjectsbydetectingthedominantplanesfrompartialvoxelbasedreconstruction.MostdirectlyrelatedtoourapproachistheworkbyZhangetal.[15],whichsegmentsincomingdepthposeDepthFusionPlaneCandidateGenerationPlaneMergingTriangulationmeshSDFlocalplanesreﬁnedplanesFig.4.Pipelineoverview.Ourmainapproachaddstwosteps(boldnodes)tothe3Dreconstructionpipeline.LocalplanecandidategenerationhappensdirectlyontheSDFgridbyusinganadaptedleastsquaresﬁttingapproach.Afterlocalplanesareestimated,theyareclusteredintofewerreﬁnedplanesthatrepresentrealobjectsinthescene.Thereﬁnedplanemodelscanbeusedforanypurpose,e.g.duringtriangulationtoreducethenoiseonplanarsurfaces.depthimagesandthensimilarlymaintainsasetofplanesandpropagatesthisinformationtotheSDF.Despiteallproposedplanesegmentationalgorithms,noneofthesolutionshavebeendevelopedforimplicitsurfacerepresentationssuchasSDFs.AdditionallytoevaluatingRANSAConthereconstructedmesh,wehavedevelopedanovelapproachofﬁttingplanesdirectlytoSDFgrids,withouttheneedforanexplicitsurfacerepresentation.Asevaluationshows,thisapproachsigniﬁcantlyreducestheruntimeoftheﬁttingprocessanddoesnotrequireadditionalstorage,makingitapplicableonmobiledevicesandrobots.III.3DRECONSTRUCTIONPIPELINETheTangovisualinertialodometry(VIO)algorithmusesaﬁsh-eyecameraandanIMUtotrackits3Dposeinreal-time.Inpost-processing,thecameraposescanbereﬁnedusingbundleadjustmenttofurtherreducedrift.WeimplementedourapproachontopofCHISEL[4],whichisthe3Dre-constructionpipelineinProjectTango.Atitsheart,CHISELusesatwoleveldatastructuretostoretheSDF:Theﬁrstlevelcontainsblocksofvoxels,whicharecalledvolumesthroughoutthispaper.Volumesarespatiallyhashedintoadynamic3Dmapbasedontheirintegercoordinates.Theyareallocatedanddeallocateddynamicallytostoreonlytheareaswheremeasurementsareobserved.Eachvolumeconsistsofaﬁxed3Dgridofvoxels,whicharestoredsequentiallyinmemory.EachvoxelcontainsanestimateoftheSDFandanassociatedweight.Whenincorporatinganewdepthimage,volumesgetmarkedforre-meshing.Aftertheupdateiscomplete,weextractameshofeveryvolumethathasbeenmarkedusingMarchingCubes.Typically,everyvoxelhasasizeof3cmandeveryvolumeconsistsof163voxels(correspondingtoacubeof48cmsidelength).Thedepthcamerahasaresolutionof160×120pixelsandoperatesataframerateof5fps.Allofouralgorithmshavebeendesignedtoruninreal-timeonaTangodevice,exceptifnotedotherwise.IV.PLANESEGMENTATIONOursegmentationalgorithmconsistsoftwostages(Fig.4):First,wedetectplanarsurfaceslocallyineachvolumeandestimateplanecandidateparameters(localﬁtting,candi-dategeneration).Second,weusetheseplanecandidatestoestimateparametersoflarger,multi-volumeplanemodels(clustering,merging).Theseplanes,thatwealsousetogenerateﬁnalmesh,arecalledreﬁnedthroughoutthepaper.AsdescribedinSec.III,oursurfacerepresentationisstoredasaspatiallyhashedgridofvolumesthatcontainSDFvoxels.Weusethesamedatastructuretostoreinformationaboutdetectedandreﬁnedplanesforeveryvolume.A.NotationWedenotea3Dpositionwithx=(xyz)>∈R3.Ifneeded,wedenotewith¯x=(xyz1)>∈R4theaugmentedvector.A3DplaneinHessiannormalformisdenotedasp=(n1n2n3d)>∈R4wheren=(n1n2n3)>∈R3istheplanenormalofunitlength,i.e.,|n|=1.Thesigneddistanceofaplaneptoapointxthencorrespondstop¯x.Anallocatedvolumei∈Nhasitscenteratvi∈R3andconsistsofm3voxels(m=16inourexperiments,whereeachvoxelhasasidelengthof3cm).EveryvolumemayhaveuptooneassociatedplanecandidatepiandasetofreﬁnedplanesQi={q1,...}.TheSDFvalue(storedinthediscretevoxelgrid)forany3DpointcanberetrievedusingthefunctionΦ:R3→R.B.GeneratingplanecandidatesWeimplementedandevaluatedtwodifferentwaysforgeneratingplanecandidates:RANSACandleastsquares.a)RANSAC:ByusingMarchingCubes,wecreateameshfromeachSDFvolumeandrun3-pointRANSAConitsverticesforﬁndingplanes.Thesegmentisconsideredplanariftheratioofinliersisaboveacertainthreshold(0.8workedwellforus).Themaximuminlierdistanceparameterdeﬁneshowaggressivelyplanesareﬁttedtothesurface.Wefoundthatavalueof2cmworkswellonTangodataandallowstargetingonlystrictlyplanarsurfaces.Toreﬁnetheplanemodel,wesetthenormaltothesmallesteigenvalueofthecovariancematrixoftheinliervertices.Weﬂiptheﬁttedplaneparameterstoensurethatthenormalpointsinthesamedirectionastheaveragenormalofmeshfaces.Pervolume,weextractatmostone(themostdominant)planecandidate.b)LeastSquares:InsteadofextractinganintermediatemeshfromeachSDFvolumeandﬁttingaplanetoitsvertices,wedevelopedamoreelegantmethodfordirectlyﬁttingaplanetotheSDFvaluesofavolume,basedonrobustleastsquares.WeﬁrstdeterminethesetofvoxelsV={xk}insideavolumethatarerelevantforplaneﬁtting,wherexk∈R3arethe3Dcoordinatesofthevoxelcenters.Sinceweonlywanttoconsidervoxelsthatcontainvaliddistancevalues,weonlyincludevoxelsxkwithΦ(xk)<0.8τ,whereτistheSDFtruncationvalue(10cminourcase).Wealsoexcludevoxelswithweightequaltozero,i.e.unobservedregions.Toobtaintheplaneparametersp∈R4foravolume,weminimizethefollowingleastsquaresproblem:argminpXxk∈V(rk)2(1)withper-voxelresidualsrk:rk:=p¯xk−Φ(xk).(2)Thisformulationisequivalenttominimizingthedifferencebetweenthedistancefromtheplanetothevoxelcenter(com-putedbyp¯xk)andtheSDFvalueΦ(xk)(asmeasurement),whichencodesthedistanceofthevoxelcentertotheclosestsurface.Wedeterminewhetherthevolumecontainsaplanebasedontheaverageoftheabsoluteper-voxelresiduals.Wefoundthatathresholdof2cmworkswelltodetectalllocalplanarregions.However,itisinpracticenotalwaysthecasethatallvoxelsinsideavolumeactuallybelongtothesameplane.Therefore,weintegrateanadditionalweightingfunctionwbasedontherobustHuberlossfunction,whichgiveslessweighttooutliers,intotheregularleastsquaresformulationabove.Thisleadstothefollowingweightedleastsquaresformulation:argminpXxk∈Vw(rk)(rk)2(3)withw(r)=(12r2for|r|≤δ,δ(|r|−12δ),otherwise.(4)Empirically,wefoundthatthevalueofδ=5cmworksbestforthistask.Weminimizethisproblembyapplyingtheiterativelyre-weightedleastsquares(IRLS)algorithm,inwhichcompu-tationofweightsandplaneparametersarealternated.C.MergingplanesSincevolumesarerelativelysmallchunksofreconstructedgeometry(inourcaseabouthalfameterineachdimension),theplaneﬁttingdescribedabovecanrobustlydetectthepresenceofasingleplanewithinavolume.Furthermore,thisallowsustodetectplanesindependentlyandinparallelforeveryvolume.Thisalsoguaranteesaconstantruntimesincethenumberofupdatedvolumesperframeislimited(duetothemaximumrangeofthesensor),evenifthetotalmapsizeisgrowing.However,duetosensornoise,theplaneestimatesinadjacentvolumesofthesameplanearetypicallynotidentical.Toreconstructlargerplanarstructureslikewallsortabletops,wethereforeneedtomergeplanecandidatesatagloballevelandpropagatethembacktoeveryaffectedvolume.Notethatthismeansthatthenumberofvolumesthatneedtobere-meshedafteranupdategrowslinearlywiththemapsize(sinceallvolumessharingthesamereﬁnedplaneneedtobeupdated).Tokeepourimplementationreal-timecapable,weonlymarkthosevolumesforre-meshing𝛾𝑝𝑞𝑣%𝑑VoxelVolumeLocal planeFig.5.Planemergingconditions.Planeqismergedwithplanepiftheangleγisbelowathreshold(cid:15)andtheunsigneddistancedbetweenqandvolumecenterviprojectedonpissmallerthanthresholdλ.thatarewithinacertainradiusofourcurrentposition.Weimplementedthefollowingtwoalgorithmsforplanemerging:RANSACandgreedyregiongrowing.a)RANSAC:Ourclusteringapproachisbasedona1-pointRANSACandadaptedtoﬁndparametersofaplanethatissimilartothemostplanesinagivenset.OneachRANSACiterationwerandomlypickaplanecandidatepifromthesetofallplanecandidatesinthemap.Weneedtoevaluatehowmanyoftheotherplanecandidatespjwithi6=jareinlierstopi.Letxij=vj−(pi¯vj)ni,(5)betheprojectionofvolumecentervjontotheplanepi.Wethencheckthefollowingtwocriteriatodeterminewhetherpjisaninliertopi(seeFig.5foranillustration):1)theangulardifferencebetweenqandpisbelowacertainthreshold(wefoundthat3degreesworkswellforindoorenvironments),i.e.,ninj>cos(cid:15)(6)2)theEuclideandistancebetween¯xijandpiisbelowacertainthreshold,i.e.,|pi¯xij|<λ.(7)Weaddedthelatterconditiontomakemergingofdistantplaneslesslikelyeveniftheyhavesimilarnormals(λ=5cminourcase).Afterﬁndingthelargestsetofinliersandreﬁningtheplaneparameters,westorethereﬁnedplaneforpropagation(explainedbelow).Toacceptareﬁnedplane,wetypicallyrequireittohaveacertainnumberofsupportingvolumes,whichinturncorrespondstoaminimumsurfacearea.Dependingontheapplication,itcanbeusefultorestrictestimationtoonlylargerplanes,likewallsorlargefurnituresurfaces.b)RegiongrowingThismergingmethodselectsoneoftheplanecandidatesinthemapandexecutesbreadth-ﬁrsttraversalofitsneighbors,addingallvolumesthathavecompatibleplanecandidatestothecurrentlymergedplane.Allvolumesadjacenttoavolumethathavesimilarplanesareaddedtothetraversalqueue.Planesimilarityisdeterminedinthesamewayasinthepreviousapproach.Adrawbackofthismethodisthatoutcomedependsoninitialplaneselectedforregiongrowing.c)PlanepropagationInmanycasesSDFvolumescontainmorethanoneplane(e.g.atwallintersections,shelvesorFig.6.Usingplanepriorstoreducenoisein3Dreconstruction.Originalreconstruction(left)andreconstructionusingplanepriors(right).anysmallrectangularobjects).TobeabletoqueryallcloseplanesateachSDFvoxel,weextendthereﬁnedplanesbypropagatingthemtoallintersectedvolumesthatarewithinaparametricdistance.Asaresult,eachvolumecanhaveoneormorereﬁnedplanesQi={q1,...}associatedthatcanbeusedfornoisereduction,holeﬁlling,andpossiblyotherapplicationssuchasimprovedcameratrackingortexturing.D.NoisereductionIndoorenvironmentsareusuallydominatedbyﬂatsurfaceslikewalls,ﬂoorandshelves,butsincethedepthdataofmobilesensorsisnoisy,theﬁnal3Dreconstructionscontainnoticeableartifacts,seeFig.6(left).Theerrorsinreconstruc-tioncanalsocomefrominaccuratelocalizationorsparsedepthdata.Afterwefoundasetofreﬁnedplanespervolumeasdescribedintheprevioussubsection,wearenowabletoextractabettermesh.Tothisend,wedeﬁneanewSDFthatisbasedontheoriginalSDFbutreplacesthedistancevaluesofvoxelsnearaplanebytheactualdistancetotheplane.LetΦ(x)betheoriginalSDFvalueforapointx.WethendeﬁneamodiﬁedSDFΦ0(x)basedonΦ(x)andthesetofreﬁnedplanesQiofthecorrespondingvolumei.Letpclosest(x)∈Pibethereﬁnedplanewhichistheclosesttox.Letpmin(x)∈Pibethereﬁnedplanewhichishassmallestsigneddistancetox.LetDclosest(x)=¯xpclosest(x)andDmin(x)=¯xpmin(x)bethedistancestosuchplanesfromapointx,respectively.Then,wecancomputeareﬁnedSDFvaluethatcombinestheplaneswithexistingSDFvaluesasfollows:Φ0(x)=Dmin(x)if∃p,q∈Q:−τ<¯x>p·¯x>q<0Dclosest(x)if|Dclosest(x)|<τand|Dclosest(x)−Φ(x)|<τΦ(x)otherwise(8)Letusdiscusseverylineofthisequationseparately:1)Theﬁrstcaseistargetedatvoxelsnearplaneinter-sections(seeFig.7foranillustration).Weusethesmallestsigneddistanceofallcloseplanesinareaswhenthereﬁnedplanesarenotallofthesamesign.Inthiscase,xismostlikelylocatedbehindaplaneandthusshouldbeassignedanegativevalue.2)ThesecondcaseappliestovoxelsthatarelocatedclosetoaplaneandthusgettheirdistancevaluesΦ=0𝑝𝑥̅=0𝑝’𝑥̅±𝜏=0𝑞𝑥̅=0+--+𝐗,𝐗-𝐗.𝑝𝑞Fig.7.CasesofSDFcorrectionatplaneintersections:atpointxAandxCweusethedistancetothenearestplane;atxBandareashighlightedinredweusethelowestsigneddistancetotheplane.𝑝𝐗#𝐷(𝐗#)𝐗#𝐗’𝐷(𝐗’)𝑝𝐗’𝐗(𝐷(𝐗()𝑝𝐗(Φ=0𝑝𝑥̅=0𝑝𝑥̅±𝜏=0𝑝Fig.8.DifferentSDFcorrectioncasesatcentersofvoxelsxA,xB,xC.xA-distancetoplaneisusedsincethevoxelisclosetotheplaneandnotnearanintersection;xB-originalvalueisusedbecausethepointisoutsideoftruncationdistancetotheplane;xCoriginalvalueisusedbecausedifferencebetweenDclosest(xC)=p¯xcandΦ(xC)islargerthantruncationdistance.overwrittenbythedistancetothisplane(seeFig.8foranillustration).3)Otherwise,wetaketheoriginalSDFvalueinareasthatarefarfromanydetectedplanes.E.JitterreductionEvenafterﬁttingplanestothemodel,theresultingmesh-ingstillshowjitterduringtheonlinereconstruction,albeitatalowerlevel.Tofurtherreduceorpossiblyfullyeliminatejitter,weonlyupdatethecoefﬁcientsofthosereﬁnedplanes(andthusre-meshthecorrespondingvolumes)thatdifferbymorethan1degree.F.HoleﬁllingWhenusingmobiledevicesforhandheld3Dreconstruc-tion,theresultingmodelsareoftenincomplete,withunob-servedpartsoftheenvironmentappearingasholesinthere-constructedmesh.Suchmissinggeometryalsooccursbehindfurnitureandregionsoccludedbyobjects.Thiscanimposeseriousproblemsinmanyaugmentedrealityapplications,forexamplewhenobjectsorgamecharactersfallthroughholesintheﬂoororenteraroomthroughawall.Fillingholesin3Dmapsisalsodesirableforrobotnavigation,forexample,topreventquadrotorstoﬂythroughapparentholesinawallduetomissingdataortoenableagroundrobottoplanapathduetogapsintheﬂoorplane.Tocompletethegeometrywhereitispossibleandproducesmoothclosedsurfaces,weextendthereﬁnedplanarregionsandcalculateSDFvaluesinunobservedvoxelsfromeq.8.Thisapproachcanalsobeusedforgeneratingindoorstructureassumptionsinthelargeunobservedareas.ForFig.9.Fillingunobservedpartsofreconstructionin’LivingRoom-kt1’(top)and’Ofﬁce-kt1’(bottom)datasetsof[20].Ourcompletionadded72.6%and64.2%tothesurfacearearespectively,recoveringallwalls.example,theﬂoorplanecanbeassumedtobeinﬁniteaslongasthisdoesnotcontradictanyexistingobservations.Ifonlydistantpiecesofadjacentwallshavebeenobserved,suchextrapolationgivesusinformationabouttheirintersectioneventhoughitwasnotseenbythedevice.Sinceeachvolumehasaseparatemeshinourrecon-structionpipeline,wecansimplifyvolumeswhichcontainonlyplanargeometrybyreplacingthemwithonlytwofaceswhichformaquadrilateral.Thisenablesmoreefﬁcientstorageandprocessingofmeshes,whichcanbeusedforexampleincollisionavoidance.G.SegmentationFindingplaneequationsofthewallsinaroomisusefultoclusterthesceneintoasetdisjointofobjects.Separationofplanarregionshappensnaturallyinbothapproachesofplaneclustering,whereweassignanIDtoeachglobalplane.Additionally,weassignoneofthefollowingsemanticlabels:ﬂoor,wall,ceilingandotherbyimposingthefollowingrules:1)Thesupportareaofaplanehastobegreaterthanathresholddeﬁnedforeachlabel.Weusethenumberofcandidatesthatweremergedasanimplicitmeasureofplanarregionareasize(valueof4workedwellforﬂoorandwalls).2)Angulardifferencebetweenplane’snormalandIMUgravityvectorhastobewithinalimitsetforeachlabel.Forourevaluation,weusedathresholdof10degreesdifferencewithunitangles.Moreover,suchlabellingcanbeusedtoreconstructonlythepartsoftheisosurfacethatbelongtothewalls.Combinedwithholeﬁllingasdescribedabove,thisresultsinare-constructionthatcontainsonlytheroom’swalls,completelyremovingallotherobjectsandfurniture.Thiscouldbeusedforexampleinautomatic3Dﬂoorplanextraction.TABLEI.Evaluationsontheamountofaddedsurfaceareabytheholeﬁllingalgorithmtothemeshreconstructionwithindoordatasets.DatasetRawm2Filledm2ImprovePosterroom95.52107.3812.41%Kidsroom75.6695.7526.55%ICL-NUIMlivingroom164.52111.3572.60%ICL-NUIMofﬁce188.58145.4564.20%BundleFusionapt0113.40135.7719.72%BundleFusionofﬁce194.40137.1945.33%Average88.68122.1540.14%Havingallﬂatsurfacessegmented,wecanalsosegmentfurnitureandotherobjectsinthescenebasedontheirmeshconnectivity.Forthis,weﬁrstextractameshofeverythingthatisnotaplane.Bytraversingthemeshinbreadth-ﬁrstsearch,wecansegmenteveryvertexaspartofthecurrentobject.Ifnounsegmentedverticescanbeadded,theobjectisﬁnalizedandtheprocessiscontinuedtothenextunsegmentedvertexwithanewobjectID.Thisenablesasimplebutefﬁcientdecompositionofthe3Dreconstructionforfurtherobjectrecognition.V.EVALUATIONANDEXPERIMENTALRESULTSA.QualitativeresultsWeevaluatedourapproachintendifferentindoorandout-doorscenes,asshowninFig.10.Inthisexperimentweusedthefastestcombinationofmethods,whichisplanecandidateestimationwithSDFﬁttingandglobalclusteringwith1-pointRANSAC.Weusedparametervaluesasspeciﬁedpreviously.AlldatawasrecordedonaTangotabletandpost-processedonaPCforvisualization.a)Noiseremoval:ThesecondrowshowstherawreconstructionfromCHISEL[4]withoutincorporatingplanepriors.Thewallsandtheﬂoorarenoisyandincomplete.Thethirdrowshowsthe3Dreconstructionafteraddingtheplanepriorfornoisereduction.Themodelslookmuchcleaner,althoughincertaincasessmalldetailslikepostersonthewalldisappear.b)Jitterremoval:ReferringbacktoFig.3,withourapproachweareabletocompletelyeliminatemeshjitteronalldetectedﬂatsurfacesduringonlinereconstruction.Thevideoaccompanyingthispaper(alsofoundathttps://youtu.be/8OxwiRpmzn4),weshowourmethodusedformeshstabilization.c)Holeﬁlling:Weevaluatedtheholeﬁllingapplicationbycomparingtheareaaddedtothemeshusingplanesinunobservedregions.Forthisevaluationweuseourdatasetsofroomswhereallmajorwallsareatleastpartiallyobserved.Wealsousepubliclyavailabledatasetsfrom[20],[21],[6].Thedatashowsthatineachscenewewereabletoreasonablyaugmenttheoriginalreconstruction,addingonaverage40.14%ofmesharea.Weconcludethatourapproachcanrecoversigniﬁcantamountofunobservedandoccludedsurfacesforindoorenvironments.d)Semanticlabellingofplanes:Fig.10showshowourapproachcanbeappliedfordetectionofwalls(green)andﬂoor(red).Oursystemfoundallwallsandﬂoorswithexceptionofkitchendataset,wheretheplaneﬁttedtowalldidnotreceivesemanticlabellingduetosmallobservedarea.PosterroomKidsroomBedroomLivingroomCopyroomOfﬁceﬂoorKitchenClosetLockersOutdoorsFig.10.Reconstructionexamples.Fromtoptobottom:originalreconstruction,de-noised,holesﬁlled,semanticsegmentationofplanes(green:wall,red:ﬂoor).Fig.11.Usingplanesforobjectsegmentation.Theplanesaremarkedwithcheckerboardpattern,whileseparateobjectsareassigneddifferentcolors.Wealsoevaluatedthenumberofcorrectclassiﬁcationsofwallsinthescene.Intheseruns,20of21wallsweredetectedcorrectlywiththeonlyexceptionofthekitchenwallthatissigniﬁcantlyoccludedbytheworktopandshelves.Therefore,weconcludethatourapproachiscapableofﬁndingmajorwallsourtestenvironmentsat95%accuracy.B.ObjectsegmentationObjectsegmentationisdoneasapost-processingsteponameshwithsegmentedplanes.Fig.11showsthataslongasthereisnoconnectivitybetweenobjectsandthewallsaredetected,segmentationisperformedcorrectly.Twocasesinthetoprowshowhowtopologicallyconnectedobjects(acurtainandapieceoffurniture)arewronglysegmentedasonepiece.Fig.12.Runtimesduringonlinereconstructionofthedataset”Posterroom”onamobiledevice.Thismethodgenerallyworkswellforindoorenviron-ments,whereallobjectsaresomehowattachedtoplanarregions.Ontheroomscalewecancoarselydetectfurnitureanddynamicactors,whereasonthesmallerscalewecansegmentobjectslayingonatableorconveyorlentthatmayneedtobepickedupwitharobotarm.C.RuntimeevaluationWeevaluatedruntimeperformanceofdifferentmethodsdescribedinthispapertoﬁndthebestcombinationofplaneﬁttingandmergingapproaches.Weusedadevicewith4GBRAMand4-coreprocessorwith2GHzfrequencyfortheruntimeevaluation.AllcomputationalprocessingdescribedinthissectionisperformedonlyontheCPU.WesetthemaximumnumberofRANSACiterationsforlocalﬁttingandglobalassociationto100and50respectively.Themaximumnumberofiterationsforlocalﬁttingusingiterativelyre-weightedleastsquaresonSDFis30.TheresultisgiveninTab.II:Thebasecase,whereweupdatetheSDFtakes40.8msperframe,whileextractingthemeshtakes72.8ms.Whenweenabletheplaneprior,weneed14.5ms(or8%)morecomputationtime.Notethatthetimedependsalsoonthescene.ForexampletheoutdoortreegeneratesmorecandidateswhenusingRANSACsincemanyreconstructedauxilarymeshesaredenselypackedwithTABLEII.Runtimecomparisonofplaneﬁttingandclusteringapproaches.Dataset#frames#candidateplanes#mergedplanesTimeperframe[ms]DetectionmethodMergingmethodCandidategenerationMergingRANSACSDFﬁttingRANSACRegiongrowingSDFfusionRANSACSDFﬁttingRANSACRegiongrowingPosterroom94323021361063.285.218.93.66.8Kidsroom4431221175644.553.914.12.44.0Bedroom10521213348.614.34.40.90.5Ofﬁceﬂoor20047471130.533.213.00.80.9Printer19231392342.325.76.81.31.4Livingroom495106932248.462.317.92.02.5Kitchen22432323330.524.311.12.32.1Closet32551514444.025.57.32.01.3Lockers48594973532.252.813.72.73.9Outdoors27262111124.165.718.90.80.6Average36880723440.844.312.61.92.4leaves,generatingmoreverticesresultinginmorecandidatesandlongerprocessing.WhilethenumbersoflocallyfoundplanesaresimilarbetweenRANSACandSDFﬁtting,theruntimesofSDFﬁttingisonaverage3.4timesbetter.ThisismainlycausedbyeliminatinggenerationofanauxiliarymeshwithMarchingCubesthatisneededforRANSACtoﬁtaplanetovertices.Toseedynamicsofprocessing,wemeasuretimespentonSDFfusion,candidategenerationandmerging.Fig.(12)showsthatprocessingtimesintroducedbyplaneﬁttingaresmallcomparedtotheSDFfusion,whichincludesdepthintegrationandmeshgeneration.Thetimecomplexityofcandidategenerationisgenerallyconstantbecausethenum-berofvolumesobservedineachframeisroughlythesame.Planeclusteringduration,however,dependslinearlyonthetotalnumberofcandidatesinthemap,growingovertimeuntilthedistancebetweenthecameraandsomecandidatesreachesapre-deﬁnedthreshold.Overall,oursystemiscapableofonlineprocessingatinteractiveframeratesonamobiledevice.ThepreferredmethodsforcandidategenerationandplanemergingareleastsquaresonSDFand1-pointRANSACrespectively.VI.CONCLUSIONWepresentedanewapproachofﬁndingandusingplanarsurfacesduringonline3Dreconstructionofindoorenvi-ronments.Ourplanedetectionalgorithmconsistsoflocalplaneﬁttingandglobalplanemerging.WeshowthatlocalcandidategenerationcanbeefﬁcientlytackledbyleastsquaresplaneestimationdirectlyontheSDFgrid.Globalclusteringcanbeeffectivelydoneby1-pointRANSAConallcandidates.Wedemonstratedhowusingourapproachcansigniﬁcantlyreducenoiseinonlineandofﬂine3Dreconstructionsandmakethemmorevisuallyappealing.Omittingre-meshingofplanarregionsresolvesthevertexjitterproblemofﬂatsurfaces.Byextendingplanarregionsintounobservedandoccludedpartsofthesceneweareabletorecovermissinginformationofroomstructureandﬁllholesalreadyduringreconstruction.REFERENCES[1]R.Newcombe,A.Davison,S.Izadi,P.Kohli,O.Hilliges,J.Shotton,D.Molyneaux,S.Hodges,D.Kim,andA.Fitzgibbon,“KinectFusion:Real-timedensesurfacemappingandtracking,”inISMAR,2011.[2]C.Kerl,J.Sturm,andD.Cremers,“DensevisualslamforRGB-Dcameras,”inIROS,2013.[3]M.Nießner,M.Zollh¨ofer,S.Izadi,andM.Stamminger,“Real-time3Dreconstructionatscaleusingvoxelhashing,”ACMTransactionsonGraphics(TOG),vol.32,no.6,p.169,2013.[4]M.Klingensmith,I.Dryanovski,S.Srinivasa,andJ.Xiao,“Chisel:Realtimelargescale3dreconstructiononboardamobiledevice,”inRSS,2015.[5]O.K¨ahler,V.Prisacariu,C.Ren,X.Sun,P.Torr,andD.Murray,“Veryhighframeratevolumetricintegrationofdepthimagesonmobiledevices,”TVCG,vol.21,no.11,pp.1241–1250,2015.[6]A.Dai,M.Nießner,M.Zoll¨ofer,S.Izadi,andC.Theobalt,“Bundlefu-sion:Real-timegloballyconsistent3dreconstructionusingon-the-ﬂysurfacere-integration,”ACMTransactionsonGraphics(TOG),2017.[7]B.CurlessandM.Levoy,“Avolumetricmethodforbuildingcomplexmodelsfromrangeimages,”inSIGGRAPH,1996.[8]E.Bylow,J.Sturm,C.Kerl,F.Kahl,andD.Cremers,“Real-timecameratrackingand3Dreconstructionusingsigneddistancefunctions,”inRSS,2013.[9]F.Steinbr¨ucker,J.Sturm,andD.Cremers,“Volumetric3Dmappinginreal-timeonaCPU,”inICRA,2014.[10]R.Maier,J.Sturm,andD.Cremers,“Submap-basedbundleadjustmentfor3DreconstructionfromRGB-Ddata,”inGCPR,2014.[11]R.Schnabel,R.Wahl,andR.Klein,“Efﬁcientransacforpoint-cloudshapedetection,”ComputerGraphicsForum,2007.[12]J.Poppinga,N.Vaskevicius,A.Birk,andK.Pathak,“Fastplanedetectionandpolygonalizationinnoisy3drangeimages,”inIROS.IEEE,2008,pp.3378–3383.[13]J.-E.DeschaudandF.Goulette,“Afastandaccurateplanedetectionalgorithmforlargenoisypointcloudsusingﬁlterednormalsandvoxelgrowing,”in3DPVT,May2010.[14]L.Ma,R.Favier,L.Do,E.Bondarev,andP.deWith,“Planesegmentationanddecimationofpointcloudsfor3denvironmentreconstruction,”inCCNC,2013,pp.43–49.[15]Y.Zhang,W.Xu,Y.Tong,andK.Zhou,“Onlinestructureanalysisforreal-timeindoorscenereconstruction,”ACMTransactionsonGraphics(TOG),vol.34,no.5,p.159,2015.[16]D.Holz,S.Holzer,R.Rusu,andS.Behnke,“Real-timeplanesegmentationusingrgb-dcameras,”inRobotSoccerWorldCup,2011,pp.306–317.[17]C.Feng,Y.Taguchi,andV.Kamat,“Fastplaneextractioninorganizedpointcloudsusingagglomerativehierarchicalclustering,”inICRA,2014,pp.6218–6225.[18]H.JiangandJ.Xiao,“AlinearapproachtomatchingcuboidsinRGBDimages,”inCVPR,2013.[19]N.Silberman,L.Shapira,R.Gal,andP.Kohli,“Acontourcompletionmodelforaugmentingsurfacereconstructions,”inECCV,2014,pp.488–503.[20]A.Handa,T.Whelan,J.McDonald,andA.Davison,“AbenchmarkforRGB-Dvisualodometry,3DreconstructionandSLAM,”inICRA,2014.[21]S.Choi,Q.-Y.Zhou,andV.Koltun,“Robustreconstructionofindoorscenes,”inCVPR,2015.