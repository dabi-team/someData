8
1
0
2

g
u
A
3

]

R
C
.
s
c
[

1
v
1
0
2
1
0
.
8
0
8
1
:
v
i
X
r
a

1

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorialAndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeAbstractMalwareanalysisanddetectiontechniqueshavebeenevolvingduringthelastdecadeasareﬂectiontodevelopmentofdifferentmalwaretechniquestoevadenetwork-basedandhost-basedsecurityprotections.Thefastgrowthinvarietyandnumberofmalwarespeciesmadeitverydifﬁcultforforensicsinvestigatorstopro-videanontimeresponse.Therefore,MachineLearning(ML)aidedmalwareanaly-sisbecameanecessitytoautomatedifferentaspectsofstaticanddynamicmalwareinvestigation.WebelievethatmachinelearningaidedstaticanalysiscanbeusedasamethodologicalapproachintechnicalCyberThreatsIntelligence(CTI)ratherthanresource-consumingdynamicmalwareanalysisthathasbeenthoroughlystud-iedbefore.Inthispaper,weaddressthisresearchgapbyconductinganin-depthsurveyofdifferentmachinelearningmethodsforclassiﬁcationofstaticcharacter-isticsof32-bitmaliciousPortableExecutable(PE32)Windowsﬁlesanddeveloptaxonomyforbetterunderstandingofthesetechniques.Afterwards,weofferatuto-rialonhowdifferentmachinelearningtechniquescanbeutilizedinextractionandanalysisofavarietyofstaticcharacteristicofPEbinariesandevaluateaccuracyandpracticalgeneralizationofthesetechniques.Finally,theresultsofexperimentalAndriiShalaginovNorwegianInformationSecurityLaboratory,CenterforCyber-andInformationSecurity,Nor-wegianUniversityofScienceandTechnology,Gjvik,Norway,e-mail:andrii.shalaginov@ntnu.noSergiiBaninNorwegianInformationSecurityLaboratory,CenterforCyber-andInformationSecurity,Norwe-gianUniversityofScienceandTechnology,Gjvik,Norway,e-mail:sergii.banin@ntnu.noAliDehghantanhaSchoolofComputing,ScienceandEngineering,UniversityofSalford,UKe-mail:a.dehghantanha@salford.ac.ukKatrinFrankeNorwegianInformationSecurityLaboratory,CenterforCyber-andInformationSecurity,Norwe-gianUniversityofScienceandTechnology,Gjvik,Norway,e-mail:katrin.franke@ntnu.no1 
 
 
 
 
 
2

2AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankestudyofallthemethodusingcommondatawasgiventodemonstratetheaccuracyandcomplexity.Thispapermayserveasasteppingstoneforfutureresearchersincross-disciplinaryﬁeldofmachinelearningaidedmalwareforensics.1IntroductionStealingusers’personalandprivateinformationhasbeenalwaysamongtopinter-estsofmaliciousprograms[8].Platformswhicharewidelyusedbynormalusershavealwaysbeenbesttargetsformalwaredevelopers[9].Attackershaveleveragedmalwaretotargetpersonalcomputers[22],mobilede-vices[61],cloudstoragesystems[13],SupervisoryControlandDataAcquisitionSystems(SCADA)[12],InternetofThings(IoT)network[81]andevenbigdataplatforms[67].Forensicsexaminersandincidenthandlersontheothersidehavedevelopeddif-ferenttechniquesfordetectionofcompromisedsystems,removalofdetectedma-liciousprograms[23,14],networktrafﬁc[63],andevenloganalysis[69].Differ-entmodelshavebeensuggestedfordetection,correlationandanalysesofcyberthreats[20](onarangeofmobiledevices[43]andmobileapplications[45],cloudapplications[11],cloudinfrastructure[46]andInternetofThingsnetworks[47]).WindowsusersarestillcomprisingmajorityofInternetusershence,itisnotsurpris-ingtoseeWindowsasthemostadoptedPCOperatingSystem(OS)ontopofthelistofmalwaretargetedplatforms[73].Inresponse,lotsofeffortshavebeenmadetosecureWindowsplatformsuchaseducatingusers[54,25],embeddingananti-virussoftware[40],deployinganti-malwareandanti-exploitationtools[53,52],andlimitingusersapplicationsprivilege[41].Inspiteofallsecurityenhancements,manymalwarearestillsuccessfullycom-promisingWindowsmachines[36,73]andmalwareisstillrankedasanimportantthreattoWindowsplatforms[33].Asresult,manysecurityprofessionalsarestillrequiredtospendalotoftimeonanalyzingdifferentmalwarespecies[10].ThisisalogicalstepsincemalwareanalysisplaysacrucialroleinCyberThreatsIn-telligence(CTI).TherehasbeenproposedaportaltofacilitateCTIandmalwareanalysisthroughinteractivecollaborationandinformationfusion[56].Therearetwomajorapproachesformalwareanalysisnamelystatic(code)anddynamic(behavioral)malwareanalysis[16,8].Indynamicmalwareanalysis,sam-plesareexecutedandtheirruntimebehaviorsuchastransmittednetworktrafﬁc,thelengthofexecution,changesthataremadeintheﬁlesystem,etc.areusedtounderstandthemalwarebehaviorandcreateindicationsofcompromiseformal-waredetection[16].However,dynamicanalysistechniquescanbeeasilyevadedbymalwarethatareawareofexecutionconditionsandcomputingenvironment[34].DynamicmalwareanalysistechniquescanonlyprovideasnapshotviewofthemalwarebehaviorandhenceverylimitedinanalysisofPolymorphorMetamorphspecies[44].Moreover,dynamicmalwareanalysistechniquesarequiteresourcehungrywhichlimitstheirenterprisedeployment[37].Instaticmalwareanalysis,theanalystisreversingthemalwarecodetoachieveadeeperunderstandingofthemalwarepossibleactivities.[28].Staticanalysisrelies3

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial3onextractionofavarietyofcharacteristicsfromthebinaryﬁlesuchthatfunctioncalls,headersections,etc.[83].Suchcharacteristicsmayrevealindicatorsofmali-ciousactivitythataregoingtobeusedinCTI[57].However,staticanalysisisquiteaslowprocessandrequiresalotofhumaninterpretationandhence[8].StaticanalysisofPE32isamany-sidedchallengethatwasstudiedbydifferentauthors.Staticmalwareanalysisalsowasusedbeforefordiscoveringinterconnec-tionsinmalwarespeciesforimprovedCyberThreatIntellifence[42,66].As32-bitmalwarearestillcapableofinfecting64-bitplatformsandconsideringtherearestillmany32-bitWindowsOSitisnotsurprisingthatstillmajorityofWindowsmalwareare32-bitPortableExecutableﬁles[8].ToauthorsknowledgetherehasnotbeenacomparativestudyofML-basedstaticmalwareusingasingledatasetwhichproducescomparableresults.WebelievethatutilizationofML-aidedauto-matedanalysiscanspeedupintelligentmalwareanalysisprocessandreducehumaninteractionrequiredforbinariesprocessing.Therefore,thereisaneedforthoroughreviewoftherelevantscientiﬁccontributionsandofferataxonomyforautomatedstaticmalwareanalysis.Theremainderofthispaperisorganizedasfollows.Weﬁrstofferacomprehen-sivereviewofexistingliteratureinmachinelearningaidedstaticmalwareanalysis.Webelievethissurveypavesthewayforfurtherresearchinapplicationofmachinelearninginstaticmalwareanalysisandcallsforfurtherdevelopmentinthisﬁeld.Then,taxonomyoffeatureconstructionmethodsforvarietyofstaticcharacteristicsandcorrespondingMLclassiﬁcationmethodsisoffered.Afterwards,weofferatu-torialthatappliesvarietyofsetofmachinelearningtechniquesandcomparestheirperformance.ThetutorialﬁndingsprovideaclearpictureofprosandconsofML-aidedstaticmalwareanalysistechniques.Toequallycompareallthemethodsweusedonebenignandtwomalwaredatasetstoevaluateallofthestudiedmethods.Thisimportantpartcomplementsthepaperduetothefactthatmostofthesurveyedworksusedowncollections,sometimesnotavailableforpublicaccessornotpub-lishedatall.Therefore,experimentalstudyshowedperformancecomparisonandotherpracticalaspectsofML-aidedmalwareanalysis.Section4givesaninsightintoapracticalroutinethatweusedtoestablishourexperimentalsetup.AnalysisofresultsandﬁndingsaregivenintheSection5.Finally,thepaperisconcludedandseveralfutureworksaresuggestedintheSection6.2AnoverviewofMachineLearning-aidedstaticmalwaredetectionThissectionprovidesananalysisofdetectablestaticpropertiesof32bitPEmalwarefollowedbydetaileddescriptionofdifferentmachinelearningtechniquestodevelopataxonomyofmachinelearningtechniquesforstaticmalwareanalysis.4

4AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFranke2.1StaticcharacteristicsofPEﬁlesPEﬁleformatwasintroducedinWindows3.1asPE32andfurtherdevelopedasPE32+formatfor64bitWindowsOperatingSystems.PEﬁlescontainaCommonObjectFileFormat(COFF)header,standardCOFFﬁeldssuchasheader,sectiontable,datadirectoriesandImportAddressTable(IAT).BesidethePEheaderﬁeldsanumberofotherstaticfeaturescanbeextractedfromabinaryexecutablesuchasstrings,entropyandsizeofvarioussections.TobeabletoapplyMachineLearningPE32ﬁlesstaticcharacteristicsshouldbeconvertedintoamachine-understandablefeatures.Thereexistdifferenttypesoffeaturesdependingonthenatureoftheirvaluessuchthatnumericalthatdescribesaquantitativemeasure(canbeinteger,realorbinaryvalue)ornominalthatdescribesﬁnitesetofcategoriesorlabels.AnexampleofthenumericalfeatureisCPU(in%)orRAM(inMegabytes)usage,whilenominalcanbeaﬁletype(like∗.dllor∗.exe)orApplicationProgramInterface(API)functioncall(likewrite()orread()).1.n-gramsofbytesequencesisawell-knownmethodoffeatureconstructionuti-lizingsequencesofbytesfrombinaryﬁlestocreatefeatures.Manytoolshavebeendevelopedforthispurposesuchashexdump[39]created4-gramsfrombytesequencesofPE32ﬁles.Thefeaturesarecollectedbyslidingwindowofnbytes.Thisresultedin200millionsoffeaturesusing10-gramsforabouttwothousandsﬁlesinoverall.Moreover,featureselection(FS)wasappliedtoselect500mostvaluablefeaturesbasedonInformationGainmetric.Achievedaccu-racyonmalwaredetectionwasupto97%usingsuchfeatures.Anotherworkonbyten-grams[51]describedusageof100-500selectedn-gramsyetonasetof250maliciousand250benignsamples.Similarapproach[31]wasusedwith10,...,10,000bestn-gramsforn=1,...,10.Additionally,MLmethodssuchthatNaiveBayes,C4.5,k-NNandotherswereinvestigatedtoevaluatetheirap-plicabilityandaccuracy.Finally,arangeof1-8n-grams[27]canresultin500bestselectedn-gramsthatareusedlatertotrainAdaBoostandRandomForestsinadditiontopreviouslymentionedworks.2.OpcodesequencesoroperationcodesaresetofconsecutivelowlevelmachineabstractionsusedtoperformvariousCPUoperations.Asitwasshown[62]suchfeaturescanbeusedtotrainMachineLearningmethodsforsuccessfulclassiﬁca-tionofthemalwaresamples.However,thereshouldbeabalancebetweenthesizeofthefeaturesetandthelengthofn-gramopcodesequence.N-gramswiththesizeof4and5resultinhighestclassiﬁcationaccuracyasunknownmalwaresam-plescouldbeunveiledonacollectionof17,000malwareand1,000benignﬁleswithaclassiﬁcationaccuracyupto94%[58].Bragen[6]exploredreliabilityofmalwareanalysisusingsequencesofopcodesbasedonthe992PE-ﬁlesmalwareandbenignsamples.Duringtheexperiments,about50millionsofopcodeswereextracted.1-gram-and2-gram-basedfeaturesshowedgoodcomputationalre-sultsandaccuracy.Wangetal.[79]presentedhowthe2-tupleopcodesequencescanbeusedincombinationwithdensityclusteringtodetectmaliciousorbenignﬁles.5

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial53.APIcallsarethefunctioncallsusedbyaprogramtoexecutespeciﬁcfunctional-ity.WehavetodistinguishbetweenSystemAPIcallsthatareavailablethroughstandardsystemDLLsandUserAPIcallsprovidedbyuserinstalledsoftware.Thesearedesignedtoperformapre-deﬁnedtaskduringinvocation.SuspiciousAPIcalls,anti-VMandanti-debuggerhooksandcallscanbeextractedbyPEanalyserssuchasPEframe[4].[83]studied23malwaresamplesandfoundthatsomeoftheAPIcallsarepresentonlyinmalwaresratherthanbenignsoft-ware.FunctioncallsmaycomposeingraphstorepresentPE32headerfeaturesasnodes,edgesandsubgraphs[84].ThisworkshowsthatMLmethodsachieveac-curacyof96%on24featuresextractedafteranalysisof1,037malwareand2,072benignexecutables.Further,in[71]20,682APIcallswereextractedusingPEparserfor1,593maliciousandbenignsamples.SuchlargenumberofextractedfeaturescanhelptocreatelinearlyseparablemodelthatiscrucialformanyMLmethodsasSupportVectorMachines(SVM)orsingle-layerNeuralNetworks.Anotherworkby[55]describedhowAPIsequencescanbeanalysedinanalogywithbyten-gramsandopcoden-gramstoextractcorrespondingfeaturestoclas-sifymalwareandbenignﬁles.Alsointhiswork,anarrayofAPIcallsfromIAT(PE32headerﬁled)wasprocessedbyFisherscoretoselectrelevantfeaturesafteranalysisofmorethan34ksamples.4.PEheaderrepresentsacollectionofmetadatarelatedtoaPortableExecutableﬁle.BasicfeaturesthatcanbeextractedfromPE32headerareSizeofHeader,SizeofUninitializedData,SizeofStackReserve,whichmayindicateifabinaryﬁleismaliciousorbenign[15].Thework[76]utilizedDecisionTreestoanalysePEheaderstructuralinformationfordescribingmaliciousandbenignﬁles.[77]used125rawheadercharacteristics,31sectioncharacteristics,29sectionchar-acteristicstodetectunknownmalwareinasemi-supervisedapproach.Anotherwork[80]usedadatasetcontaining7,863malwaresamplesfromVxHeavenwebsiteinadditionto1,908benignﬁlestodevelopaSVMbasedmalwarede-tectionmodelwithaccuracyof98%.[38]usedF-scoreasaperformancemet-rictoanalysePE32headerfeaturesof164,802maliciousandbenignsamples.Also[29]presentedresearchoftwonovelmethodsrelatedtoPE32string-basedclassierthatdonotrequireadditionalextractionofstructuralormeta-datainfor-mationfromthebinaryﬁles.Moreover,[84]describedapplicationof24featuresalongwithAPIcallsforclassiﬁcationofmalwareandbenignsamplesfromVx-HeavenandWindowsXPSP3respectively.Further,ensembleoffeatureswasexplored[59],whereauthorsusedintotal209featuresincludingstructuralandrawdatafromPE32ﬁleheader.Further,Le-Khacetal.[35]focusedonControlFlowChangeoverﬁrst256addressestoconstructn-gramfeatures.Inadditiontostudyofspeciﬁcfeaturesusedformalwaredetection,weanalyzedarticlesdevotedtoapplicationofMLforstaticmalwareanalysispublishedbetween2000and2016,whichcoversthetimelineofWindowsNTfamilythatarestillinuseasdepictedintheFigure1.Wecanseethatthenumberofpapersthatarerelevanttoourstudyisgrowingfrom2009andlater,whichcanbejustiﬁedonthebasisofincreaseinthenumberofWindowsusers(potentialtargets)andcorrespondingmalwarefamilies.6

6AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeFig.1:Timelineofworkssince2009thatinvolvedstaticanalysisofPortableExe-cutableﬁlesusingmethodcharacteristicsusingalsoMLmethodforbinarymalwareclassiﬁcationChallenges.Despitethefactthatsomeofthefeatureconstructiontechniquesreﬂectedpromisingprecisionof90+%indifferentiationbetweenmaliciousandbenignexecutables,therearestillnobeststaticcharacteristicthatguarantee100%accuracyofmalwaredetection.Thiscanbeexplainedbythefactthatmalwareareusingobfuscationandencryptiontechniquestosubvertdetectionmechanisms.Inaddition,moreaccurateapproachessuchasbytesN-GRAMSarequiteresourcein-tensiveandhardlypracticalintherealworld.2.2MachineLearningmethodsusedforstatic-basedmalwaredetection2.2.1StatisticalmethodsExploringlargeamountsofbinaryﬁlesconsistsofstatisticalfeaturesmaybesim-pliﬁedusingsocalledfrequenciesorlikelihoodoffeaturesvalues.Thesemethodsaremadetoprovidepredictionaboutthebinaryexecutableclassbasedonstatisticsofdifferentstaticcharacteristics(eitherautomaticallyormanuallycollected)whichareapplicabletomalwareanalysistooasdescribebyShabtaietal.[60].Toprocesssuchdata,extractnewormakepredictionsthefollowingsetofstatisticalmethodscanbeused:NaiveBayesisasimpleprobabilisticclassiﬁer,whichisbasedonBayesiantheo-remwithnaiveassumptionsaboutindependenceincorrelationofdifferentfeatures.TheBayesRulecanbeexplainedasafollowingconditionalindependencesoffea-turesvalueswithrespecttoaclass:P(Ck|V)=P(Ck)P(V|Ck)P(V)(1)7

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial7whereP(Ck)isapriorprobabilityofclassCk,k=1,...,m0whichiscalcu-latedfromcollectedstatisticsaccordingtodescriptionofvariablesprovidedbyKononenkoetal.[32].Thismethodisconsideredtotacklejustbinaryclassiﬁcationproblem(benignagainstmalicious)sinceitwasoriginallydesignedasmultinomialclassiﬁer.V=hv1,...,vaiisthevectorofattributesvaluesthatbelongstoasample.IncaseofNaiveBayesinputvaluesshouldbesymbolical,forexamplestrings,op-codes,instructionn-gramsetc.P(V)isthepriorprobabilityofasampledescribedwithvectorV.HavingtrainingdatasetandgivenvectorVwecounthowmanysamplescontainequalvaluesofattributes(e.g.basedonthenumberofsectionsorgivenopcodesequence).ItisimportanttomentionthatVhavenottobeoflengthoffullattributevectorandcancontainonlyoneattributevalue.P(V|Ck)isthecon-ditionalprobabilityofasampledescribedwithVgiventheclassCk.AndP(Ck|V)conditionalprobabilityofclassCkwithV.BasedonsimpleprobabilitytheorywecandescribeconditionalindependenceofattributevaluesvigiventheclassCk:P(V|Ck)=P(v1∧...∧va|Ck)=a∏i=1P(vi|Ck)(2)DroppingthemathematicaloperationswegetﬁnalversionofEquation1:P(Ck|V)=P(Ck)a∏i=1P(Ck|vi)P(Ck)(3)So,thetaskofthismachinelearningalgorithmistocalculateconditionalandunconditionalprobabilitiesasdescribedintheEquation3usingatrainingdataset.Tobemorespeciﬁc,theAlgorithm1pseudocodeshowsthecalculationoftheconditionalprobability.8

8AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeAlgorithm1CalculatingP(Ck|V)-conditionalprobabilityofclassCkwithV1:Samplestructurewithclasslabelandattributevalues2:S←arrayoftrainingSamples3:V←arrayofattributevalues4:Ck←classnumber5:PCk=06:functiongetPCk(ClassNumber,Samples)7:output=08:forallsamplefromSamplesdo9:ifsample.getClass()==ClassNumberthen10:output+=1size[Samples]11:endif12:endfor13:returnoutput14:endfunction15:functiongetPCkvi(ClassNumber,v,i,Samples)16:output=017:forallsamplefromSamplesdo18:ifsample.getClass()==ClassNumberANDsample.getAttribute(i)==vthen19:output+=1size[Samples]20:endif21:endfor22:returnoutput23:endfunction24:P(Ck|V=0)25:prod=126:i=027:forallvfromVdo28:prod∗=getPCkvi(ClassNumber,v,i,Samples)getPCk(ClassNumber,Samples)29:i+=130:endfor31:P(Ck|V)=prod∗getPCk(ClassNumber,Samples))So,wecanseefromtheEquation1thatgivenoutputisasaprobabilitythataquestionedsoftwaresamplebelongstooneoranotherclass.Therefore,theclassiﬁ-cationdecisionwillbemadebyﬁndingamaximalvaluefromsetofcorrespondingclasslikelihoods.Equation4providesformulathatassignsclasslabeltotheoutput:ˆy=argmaxk∈{1,...,K}P(Ck)P(V|Ck).(4)BayesianNetworksisaprobabilisticdirectedacyclicgraphicalmodel(some-timesalsonamedasBayesianBeliefNetworks),whichshowsconditionaldepen-denciesusingdirectedacyclicgraph.Networkcanbeusedtodetect”updateknowl-edgeofthestateofasubsetofvariableswhenothervariables(theevidencevari-ables)areobserved”[32].BayesianNetworksareusedinmanycasesofclassi-ﬁcationandinformationretrieval(suchassemanticsearch).Themethod’sroutinecanbedescribedasfollowing.IfedgegoesfromvertexAtovertexB,thenAisaparentofB,andBisanancestorofA.IffromAthereisorientedpathtoanother9

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial9vertexBexiststhenBisancestorofA,andAisapredecessorofB.Letsdesig-natesetofparentvertexesofvertexViasparents(Vi)=PAi.DirectacyclicgraphiscalledBayesianNetworkforprobabilitydistributionP(v)givenforsetofrandomvariablesVifeachvertexofgraphhasmatchedwithrandomvariablefromV.Andedgeofagraphﬁtsnextcondition:everyvariablevifromVmustbeconditionallyindependentfromallvertexesthatarenotitsancestorsifallitsdirectparentsPAiareinitializedingraphG:∀Vi∈V⇒P(vi|pai,s)=P(vi|pai)(5)whereviisavalueofVi,S-setofallvertexesthatarenotancestorsofVi,s-conﬁgurationofS,pai-conﬁgurationofPAi.Thenfullgeneraldistributionofthevaluesinvertexescouldbewrittenasproductoflocaldistributions,similarlytoNaiveBayesrules:P(V1,...,Vn)=n∏i=1P(Vi|parents(Vi))(6)BayesianBeliefNetworkscanbeusedforclassiﬁcation[32],thuscanbeappliedformalwaredetectionandclassiﬁcationaswell[58].TomakeBayesianNetworkcapableofclassiﬁcationitshouldcontainclassesasparentnodeswhichdon’thaveparentsthemselves.Figure2showsanexampleofsuchBayesiannetwork.Fig.2:Bayesiannetworksuitableformalwareclassiﬁcation[58]2.2.2RulebasedRulebasedalgorithmsareusedforgeneratingcrisporinexactrulesindifferentMa-chineLearningapproaches[32].Themainadvantageofhavinglogicrulesinvolved10

10AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeinmalwareclassiﬁcationisthatlogicalrulesthatoperatewithstatementslikeequal,graterthen,lessorequaltocanbeexecutedonthehardwarelevelwhichsigniﬁ-cantlyincreasesthespeedofdecisionmaking.C4.5isspeciallyproposedbyQuinlan[50]toconstructdecisiontrees.Thesetreescanbeusedforclassiﬁcationandespeciallyformalwaredetection[75].Theprocessoftreestrainingincludesprocessingofpreviouslyclassiﬁeddatasetandoneachsteplooksforanattributethatdividessetofsamplesintosubsetswiththebestinformationgain.C4.5hasseveralbeneﬁtsincomparewithotherdecisiontreebuildingalgorithms:•Worksnotonlywithdiscretebutwithcontinuousattributesaswell.Forcontinu-ousattributesitcreatesthresholdtpcomparesvaluesagainst[49].•Takeintoaccountmissingattributesvalues.•Workswithattributeswithdifferentcosts.•Performautomatetreepruningbygoingbackwardthroughthetreeandremovinguselessbrancheswithleafnodes.Algorithm2showsasimpliﬁedversionofdecisiontreebuildingalgorithm.Algorithm2Decisiontreemakingalgorithm1:S=s1,s2,...labelledtrainingdatasetofclassiﬁeddata2:x1i,x2i,...,xpi-p-dimensionalvectorofattributesofeachsamplesiformS3:Checkforbasecases4:forallattributesxdo5:Findthenormalizedgainratiofromsplittingsetofsampleonx6:endfor7:Letxbestbetheattributewiththehighestnormalizedinformationgain.8:Createdecisionnodethatsplitsonxbest9:Repeatonthesubsetscreatedbysplittingwithxbest.Newlygainednodesaddaschildrenofcurrentnode.Neuro-Fuzzyisahybridmodelsthatensemblesneuralnetworksandfuzzylogictocreatehuman-likelinguisticrulesusingthepowerofneuralnetworks.Neu-ralnetworkalsoknownasartiﬁcialneuralnetworkisanetworkofsimpleele-mentswhicharebasedonthemodelofperceptron[65].Perceptronimplementspreviouslychosenactivationfunctionswhichtakeinputsignalsandtheirweightsandproducesanoutput,usuallyintherangeof[0,1]or[−1,1].Thenetworkcanbetrainedtoperformclassiﬁcationofcomplexandhigh-dimensionaldata.Neu-ralNetworksarewidelyusedforclassiﬁcationandpatternrecognitiontasks,thusformalwareanalysis[72].TheproblemisthatsolutionsgainedbyNeuralNet-worksareusuallyimpossibletointerpretbecauseofcomplexityofinternalstruc-tureandincreasedweightsontheedges.ThisstimulatesusageofFuzzyLogictech-niques,wheregeneratedrulesaremadeinhuman-likeeasy-interpretableformat:IFX>3ANDX<5THENY=7.BasicideaofNeuro-Fuzzy(NF)modelisafuzzysystemthatistrainedwithalearningalgorithmsimilartoonefromneuralnetworkstheory.NFsystemcanbe11

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial11representedasaneuralnetworkwhichtakesinputvariablesandproducesoutputvariableswhileconnectionweightsarerepresentedasencodedfuzzysets.Thusatanystage(likepriorto,inprocessofandaftertraining)NFcanberepresentedasasetoffuzzyrules.Self-Organising(Kohonen)maps[30]isthemostcommontech-niquesofcombiningNeuroandFuzzyapproaches.Shalaginovetal.[64]showedthepossibilityofmalwaredetectionusingspecially-tunedNeuro-Fuzzytechniqueonasmalldataset.Further,NFshowedgoodperformanceonlarge-scalebinaryproblemofnetworktrafﬁcanalysis[63].Thismethodhasalsoprovenitsefﬁciencyonasetofmultinomialclassiﬁcationproblems.Inparticular,itisusefulwhenwearetalkingaboutdistinguishingnotonly”malware”or”goodware”butalsodetectingspeciﬁctypeof”malware”[68].Therefore,ithasbeenimprovedforthemultinationalclas-siﬁcationofmalwaretypesandfamiliesbyShalaginovetal.[70].2.2.3DistancebasedThissetofmethodsisusedforclassiﬁcationbasedonpredeﬁneddistancemeasure.Datafordistance-basedmethodsshouldbecarefullyprepared,becausecomputa-tionalcomplexitygrowssigniﬁcantlywithspacedimensionality(numberoffea-tures)andnumberoftrainingsamples.Thusthereisaneedforproperfeatureselec-tionaswellassometimesfordatanormalization.k-NearestNeighboursork-NNisclassiﬁcationandregressionmethod.k-NNdoesnotneedspecialpreparationofthedatasetoractual”training”asthealgorithmisreadyforclassiﬁcationrightafterlabellingthedataset.Thealgorithmtakesasamplethatisneedtobeclassiﬁedandcalculatesdistancestosamplesfromtrainingdataset,thenitselectsknearestneighbours(withshortestdistances)andmakesdecisionbasedonclassofthisknearestneighbours.Sometimesitmakesdecisionjustonthemajorityofclassesinthiskneighboursselection,whileinothercasesthereisweightsinvolvedinprocessofmakingdecision.Whenk-NNisusedformalwareclassiﬁcationanddetectionthereisaneedforcarefulfeatureselectionaswellasamethodologyfordealingwithoutliersandhighlymixeddata,whentrainingsamplescannotcreatedistinguishableclusters[58].SupportVectorMachineorSVMisasupervisedlearningmethod.Itconstructsoneorseveralhyperplanestodividedatasetforclassiﬁcation.Hyperplaneiscon-structedtomaximizedistancefromittothenearestdatapoints.Sometimeskerneltransformationisusedtosimplifyhyperplanes.Buildingahyperplaneisusuallyturnedintotwo-classproblem(onevsone,onevsmany)andinvolvesquadraticprogramming.Letshavelinearlyseparabledata(asshowninFigure3)whichcanberepresentedasD={(xi,yi)|xi∈Rp,yi∈{−1,1}}ni=1.Whereyiis1or-1depend-ingonclassofpointxi.Eachxiisp-dimensionalvector(notalwaysnormalised).Thetaskistoﬁndhyperplanewithmaximummarginthatdividesdatasetonpointswithyi=1andyi=−1:w·x−b=0.Wherewisanormalvectortoahyperplane[21].Ifdatasetislinearlyseparablewecanbuildtwohyperplanesw·x−b=1andw·x−b=−1betweenwhichtherewillbeno(orincaseofsoftmarginmaximalallowednumber)points.Distancebetweenthem(margin)is2||w||,sotomaximize12

12AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankemarginweneedtominimize||w||andtoﬁndparametersofhyperplaneweneedtointroduceLagrangianmultipliersαandsolveEquation7withquadraticprogram-mingtechniques.argminw,bmaxα≥0(12kwk2−n∑i=1αi[yi(w·xi−b)−1])(7)Fig.3:Maximummarginhyperplanefortwoclassproblem[32]Sometimesthereisaneedtoallowanalgorithmtoworkwithmisclassiﬁeddatahenceleavingsomepointsinsidethemarginbasedonthedegreeofmisclassiﬁcationξ.SotheEquation3turnsintoEquation8.argminw,ξ,bmaxα,β(12kwk2+Cn∑i=1ξi−n∑i=1αi[yi(w·xi−b)−1+ξi]−n∑i=1βiξi)withαi,βi≥0(8)Alsothedatamightbelinearlyseparated,sothereisaneedforkerneltrick.Thebasicideaistosubstituteeverydotproductwithnon-linearkernelfunction.Kernelfunctioncanbechosendependingonsituationandcanbepolynomial,Gaussian,hyperbolicetc.SVMisaverypowerfultechniquewhichcangivegoodaccuracyifproperlyused,soitoftenusedinmalwaredetectionstudiesasshownbyYeetal.[82].13

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial132.2.4NeuralnetworksNeuralNetworkisbasedonthemodelofperceptronwhichhaspredeﬁnedactivationfunction.Intheprocessoftrainingweightsofthelinksbetweenneuronsaretrainedtoﬁttraindatasetwithminimumerrorwithuseofbackpropagation.ArtiﬁcialNeuralnetwork(ANN)consistsofinputlayer,hiddenlayer(layers)andoutputlayerasitisshownonFigure4.Fig.4:Artiﬁcialneuralnetwork[32]Theinputlayertakesnormalizeddata,whilehiddenoutputlayerproducesac-tivationoutputusingneuron’sweightedinputandactivationfunction.Activationfunctionisabasicpropertyofneuronthattakesinputvaluesgivenontheinputedges,multiplythembyweightsoftheseedgesandproducesoutputusuallyinarangeof[0,1]or[-1,1].Outputlayerisneededtopresentresultsandtheninterpretthem.TrainingofANNstartswithrandominitializationofweightsforalledges.Thenfeaturevectorofeachsampleisusedasaninput.Afterwards,resultgainedontheoutputlayeriscomparedtotherealanswers.Anyerrorsarecalculatedandusingback-propagationallweightsaretuned.Trainingcancontinueuntilreachingdesirednumberoftrainingcyclesoraccuracy.LearningprocessofANNcanbepre-sentedasshownintheAlgorithm3.ArtiﬁcialNeuralnetworkscanbeappliedforcomplexmodelsinhigh-dimensionalspaces.Thisiswhyitoftenusedformalwareresearch[72].14

14AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeAlgorithm3ANNtraining1:S=s1,s2,...labeledtrainingdatasetofclassiﬁeddata2:x1i,x2i,...,xpi-p-dimensionalvectorofattributesofeachsamplesiformS3:Nnumberoftrainingcycles4:Lratelearningrate5:Randomweightinitialization6:foralltrainingcyclesNdo7:forallsamplesSdo8:givefeaturesxiasinputtotheANN9:compareclassofsiwithgainedoutputofANN10:calculateerror11:usingback-propagationtuneweightsinsidetheANNwithLrate12:endfor13:reduceLrate14:endfor2.2.5OpenSourceandFreelyavailableMLToolsTodaymachinelearningiswidelyusedinmanyareasofresearchwithmanypub-liclyavailabletools(Softwareproducts,librariesetc.).WekaorWaikatoEnvironmentforKnowledgeAnalysisisapopular,free,crossplatformandopensourcetoolformachinelearning.ItsupportsmanyofpopularMLmethodswithpossibilityofﬁnetuningoftheparametersandﬁnalresultsanalysis.Itprovidesmanyfeaturessuchassplittingdatasetandgraphicalrepresentationoftheresults.Wekaresultsaresavedin.arffﬁlewhichisspeciallypreparedCSVﬁlewithheader.Itsuffersfromcoupleofissuesincludingnosupportformulti-threadcomputationsandpoormemoryutilizationespeciallywithbigdatasets.PythonwekawrapperisthepackagewhichallowsusingpowerofWekathroughPythonprograms.ItusesjavabridgetolinkJava-basedWekalibrariestopython.ItprovidesthesamefunctionalityasWeka,butprovidesmoreautomationcapacities.LIBSVMandLIBLINEARareopensourceMLlibrarieswritteninC++sup-portingkernelizedSVMsforlinear,classiﬁcationandregressionanalysis.BindingsforJava,MathlabandRarealsopresent.Itusesspace-separatedﬁlesasinput,wherezerovaluesneednottobementioned.RapidMinerismachinelearninganddataminingtoolwithauserfriendlyGUIandsupportforalotofMLanddataminingalgorithms.Dlibisafreeandcross-platformC++toolkitwhichsupportsdifferent-machinelearningalgorithmsandallowsmulti-threadingandutilizationofPythonAPIs.2.2.6FeatureSelection&ConstructionprocessNextimportantstepafterthecharacteristicsextractionisso-calledFeatureSelectionprocess[32].FeatureSelectionisasetofmethodsthatfocusoneliminationofirrelevantorredundantfeaturesthatarenotinﬂuentialformalwareclassiﬁcation.15

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial15Thisisimportantsincethenumberofcharacteristicscanbeextremelylarge,whileonlyafewcanactuallybeusedtodifferentiatemalwareandbenignapplicationswithahighdegreeofconﬁdence.ThemostcommonfeatureselectionmethodsareInformationGain,andCorrelation-basedFeatureSubsetSelection(CFS)[24].TheﬁnalgoalofFeatureSelectionistosimplifytheprocessofknowledgetransferfromdatatoareusableclassiﬁcationmodel.2.3TaxonomyofmalwarestaticanalysisusingMachineLearningOurextensiveliteraturestudyasreﬂectedinTable1resultedtoproposingataxon-omyformalwarestaticanalysisusingmachinelearningasshowninFigure5.Ourtaxonomydepictsthemostcommonmethodsforanalysisofstaticcharacteristics,extractingandselectingfeaturesandutilizingmachinelearningclassiﬁcationtech-niques.StatisticalPatternRecognitionprocess[26]wasusedasthebasisforourtaxonomymodelling.Fig.5:Taxonomyofcommonmalwaredetectionprocessbasedonstaticcharacter-isticsandMachineLearningYearAuthorsDatasetFeaturesFSMLPE32header16

16AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFranke2016Cepedaetal.[7]7,630malwareand1.818goodware57featuresfromVirisTotalChiSqSelectorwith9featuresﬁnallySVM,RF,NN2016Le-Khacetal.[35]Malicious:94;Benign:620ControlFlowChangeand2-6n-grams-NaiveBayes2014Markeletal.[38]Malicious:122,799,Be-nign:42,00346featuresusepython’peﬁle’-NaiveBayes,LogisticRegression,Classiﬁca-tionandRegressionTree(CART)2013Khorsandetal.[29]Benign:850EXEand750DLL;Malware:1600fromVXheavenseliminated-Predictionbypartialmatching2012Devietal.[15]4,075PEﬁles:2954ma-liciousand1121Win-dowsXPSP2benign2+5features-BayesNet,k-NN,SVM,AdaBoostM1,Decisiontable,C4.5,RandomForest,RandomTree2011Zhao[84]3109PE:1037virusesfromVxHeavensand2072benignexecutableonWinXPSp324featuresfromPEﬁlesusingControlFlowGraph-basedonnodesRandomForest,DecisionTree,Bagging,C4.52011Ugarte-Pedreroetal.[77]500benignfromWinXPand500non-packedfromVxheaven;500packed+500Zeus166structurefea-turesofPEﬁleInfoGainLearningwithLocalandGlobalConsistency,Ran-domForest2011Santosetal.[59]500benignand500maliciousfromVxHeav-ens,alsopackedandnotpacked209structuralfea-turesInfoGainCollectiveForest2009Tang[76]361executablesand449normaltrojanﬁlesPEheaderstructuralfeatures-DecisionTree2009Wangetal.[80]Benign:1,908,Mali-cious:7,863143PEheaderen-triesInfoGain,GainraioSVMbytesn-gramsequences2011Jainetal.[27]1,018malwareand1,120benignsamples1-8byte,n-gram,bestn-grambydocumentwisefrequency-NB,iBK,J48,Ad-aBoost1,RandomForest2007Masudetal.[39]1stset-1,435executa-bles:597ofwhicharebe-nignand838aremali-cious.2ndset-2,452ex-ecutables:1,370benignand1,082malicious500bestn-gramsInfoGainSVM2006Reddyetal.[51]250malwarevs250be-nign100-500bestn-gramDocumentFre-quency,InfoGainNB,iBK,DecisionTree2004Kolteretal.[31]1971benign,1651mali-ciousfromVxHeaven500bestn-gramsInfoGainNaiveBayes,SVM,C4.5opcoden-gramsequences2016Wangetal.[79]11,665malwareand1,000benignsamples2-tupleopcodese-quencesinformationentropydensityclustering2015Bragen[6]992malwares,771be-nignfromWindowsVista1-4n-gramopcodewithvocabulary530-714,390Cfs,Chi-sqaured,InfoGain,ReliefF,SymUncert.RandomForest,C4.5,NaiveBayes,bayesNet,Baggin,ANN,SOM,k-nn2013Santosetal.[58]13,189malwarevs13,000benigntop1,000featuresInfoGainRandomForest,J48,k-NearestNeighbours,Bayesiannetworks,SVM2011Shahzadetal.[62]Benign:300,Malicious:300onWindowsXPcoabularyof1,413withn-gram=4tf-idfZeroR,Ripper,C4.5,SVM,NaiveBayes,k-nn17

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial17APIcalls2012Zabidietal.[83]23malwareand1benignAPIcalls,debuggerfeatures,VMfea-tures--2012Farukietal.[19]3234benign,3256mal-ware1-4APIcall-gram-RandomForest,SVM,ANN,C4.5,Naivebayes2010Shankarapanietal.[71]1593PEﬁles:875benignand715maliciousAPIcallssequence-SVM2010Samietal.[55]34,820PE:31,869ma-liciousand2951benignfromWindowsAPIcallsFisherScoreRandomForest,C4.5,NaiveBayesnofeatures/notdescribed2012Baigetal.[5]200packedPEand200unpackedfromWindows7,Windows2003Serverﬁleentropy--2010Dubeetal.[17]40,498samples:25,974malware,14,524benignfrom32bitﬁles-DecisionTreeTable1:AnalysisofMLmethodsapplicabilityfordifferenttypesofstaticcharac-teristicsTogetaclearpictureonapplicationdomainofeachmachinelearningandfeatureselectionmethodweanalysedreportedperformanceasshowninFigure6.Majorityofresearcherswereusingbyten-gram,opcoden-gramandPE32headerﬁeldsforstaticanalysiswhileC4.5,SVMork-NNmethodsweremainlyusedformalwaredetection.InformationGainistheprevalentmethodtodeﬁnemalwareattributes.Alsowecanseethatn-gram-basedmethodtendtousecorrespondingsetoffea-tureselectionliketf-idfandSymmetricUncertaintythataremorerelevantforlargenumberofsimilarsequences.Ontheotherhand,PE32header-basedfeaturestendtoprovidehigherentropiesforclassiﬁcationandthereforeControl-Flowgraph-basedandGainRatioaremoresuitableforthistask.Fig.6:Comparisonofaccuracyofvariousstaticcharacteristicswithrespecttofea-tureselectionandmachinelearningmethods.Colourofthebubblesshowsusedcharacteristicsfordetection,whilesizeofthebubbledenotesachievedaccuracy18

18AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeToconclude,onecansaythatmajorityofauthorseitherextractfeaturesthatoffersgoodclassiﬁcationaccuracy,oruseconventionalmethodslikeInformationGain.However,n-grambasedcharacteristicsneedotherFSapproachestoelimi-nateirrelevantfeatures.Rule-basedMListhemostcommonlyusedclassiﬁcationmethodalongwithSVM.Forest-basedmethodtendstobemoreapplicableforPE32header-basedfeatures.AlsoANNisnotcommonly-usedtechnique.Whilemostoftheworksachievedaccuraciesof80-100%,someBayes-basedmethodsofferedmuchloweraccuracyevendownto50%only.3ApproachesforMalwareFeatureConstructionSimilarthepreviousworks,followingfoursetsofstaticpropertiesaresuggestedforfeatureclassiﬁcationinthispaper:PE32headerfeaturescharacterizethePE32headerinformationusingthePE-frametools[77].Followingnumericalfeatureswillbeusedinourexperiments:•ShortInfoDirectoriesdescribes16possibledatadirectoriesavailableinPEﬁle.Themostcommonlyusedare”Import”,”Export”,”Resource”,”Debug”,”Relo-cation”.•ShortInfoXorindicatesdetectedXORobfuscation.•ShortInfoDLLisabinaryﬂagofwhetheraﬁleisexecutableordynamically-linkedlibrary.•ShortInfoFileSizemeasuressizeofabinaryﬁleinbytes.•ShortInfoDetectedshowspresenttechniquesusedtoevadethedetectionbyanti-viruseslikehookstodisableexecutioninvirtualizedenvironmentorsuspiciousAPIcalls.•ShortInfoSectionsisanumberofsubsectionsavailableintheheader.•DigitalSignaturecontainsinformationaboutthedigitalsignatturethatcanbepresentinaﬁle•PackerdescribesusedpackerdetectedbyPEframe•AntiDebuggivesinsightintothetechniquesusedtopreventdebuggingprocess.•AntiVMisincludedtopreventtheexecutioninavirtualizeenvironment.•SuspiciousAPIindicatesfunctionscallsthatarelabelledbyPEframeassuspi-cious.•SuspiciousSectionscontainsinformationaboutsuspicioussectionslike”.rsrc\u0000\u0000\u0000”•Urlisanumberofdifferenturladdressesfoundinthebinaryﬁle.Byten-gram.N-gramisasequenceofsomeitems(withminimumlengthof1)thatarepredeﬁnedasminimalpartsoftheobjectexpressedinBytes.Byhavingtheﬁlerepresentedasasequenceofbyteswecanconstruct1-gram,2-gram,3-grametc.N-gramsofbytes,orbyten-gramsarewidelyusedasfeaturesformachinelearningandstaticmalwareanalysis[27,51].19

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial19Reddyetal.[51]usedn-gramsofsize2,3and4withcombinationofSVM,Instance-basedlearnerandDecisionTreealgorithmstodistinguishbetweenmali-ciousandbenignexecutables.Afterextractingn-gramstheyusedclass-wisedocu-mentfrequencyasafeatureselectionmeasureandshowedthatclass-wisedocumentfrequencyisperformingbetterthanInformationGainasafeatureselectionmeasure.Jainetal.[27]usedn-gramsinrangeof1to8asfeaturesandNaiveBayes,InstanceBasedLearnerandAdaBoost1[3]asmachinelearningalgorithmsformalwareclassiﬁcationandreportedbyte3-gramsasthebesttechnique.Opcoden-gramrepresentasetofinstructionsthatwillbeperformedontheCPUwhenbinaryisexecuted.Theseinstructionsarecalledoperationalcodesoropcodes.Toextractopcodesfromexecutableweneedtoperformdisassemblyprocedure.Af-terthisopcodeswillberepresentedasshortinstructionsnamessuchasPOP,PUSH,MOV,ADD,SUBetc.Santosetal.[58]describedamethodtodistinguishbetweenmaliciousandbenignexecutablesordetectingdifferentmalwarefamiliesusingop-codesequencesoflength1to4usingRandomForest,J48,k-NearestNeighbours,BayesianNetworksandSupportVectorMachinealgorithms[3].APIcallsisasetoftoolsandroutinesthathelptodevelopaprogramusingexistentfunctionalityofanoperatingsystem.SincemostofthemalwaresamplesareplatformdependentitisverymuchlikelythattheirdevelopershaveuseAPIsaswell.Therefore,analysingAPIcallsusageamongbenignandmalicioussoftwarecanhelptoﬁndmalware-speciﬁcAPIcallsandthereforearesuitabletobeusedasafeatureformachinelearningalgorithms.Forexample,[71]successfullyusedSupportVectorMachineswithfrequencyofAPIcallsformalwareclassiﬁcation.[78]providedamethodologyforclassiﬁcationofmaliciousandbenignexecutablesusingAPIcallsandn-gramswithnfrom1to4andachievedaccuracyof97.23%for1-gramfeatures.[19]usedso-calledAPIcall-grammodelwithsequencelengthrangingfrom1-4andreachedaccuracyof97.7%wasachievedbytrainingwith3-grams.Inourexperimentswearegoingtouse1and2n-gramsasfeaturesgeneratedfromAPIcalls.4ExperimentalDesignAllexperimentswereconductedonadedicatedVirtualmachine(VM)onUbuntu14.04serverrunningonXen4.4.TheserverhadanIntel(R)Core(TM)i7-3820CPU@3.60GHzwith4cores(8threads),outofwhich2cores(4threads)wereprovidedtotheVM.DiskspaceisallocatedontheSSDRAIDstoragebasedonSamsung845DC.InstalledservermemorywasKingstonPC-1600RAM,outofwhich8GBwasavailablefortheVM.OperatingsystemwasanUbuntu14.0464bitrunningonaededicatedVMtogetherwithalldefaulttoolsandutilitiesavailableintheOS’srepository.Filespre-processingwereperformedusingbashscriptsduetonativesupportinLinuxOS.TostoreextractedfeaturesweutilisedMySQL5.5databaseenginetogetherwithPythonv2.7.6andPHPv5.5.9connectors.20

20AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeFortheexperimentsweusedasetofbenignandmalicioussamples.ToauthorsknowledgetherehavenotbeenpublishedanylargeBENIGNSOFTWAREREFER-ENCEDATASETS,sowehavetocreateourownsetofbenignﬁles.SincethefocusofthepaperismainlyonPE32Windowsexecutables,wedecidedtoextractcorre-spondingknown-to-be-goodﬁlesfromdifferentversionsofMSWindows,includ-ingdifferentsoftwareandmultimediaprogramsinstallationsthatareavailable.TheOSesthatweprocessedwere32bitversionsofWindowsXP,Windows7,Windows8.1andWindows10.FollowingtwoWindowsmalwaredatasetswereusedinourresearch:1.VXHEAVEN[2]dedicatedtodistributeinformationaboutthecomputervirusesandcontains271,092sortedsamplesdatingbackfrom1999.2.VIRUSSHARE[1]representsharingresourcethatoffers29,119,178malwaresamplesandaccessiblethroughVirusSharetrackerasof12thofJuly,2017.Weutilizedfollowingtwoarchives:VirusShare00000.zipcreatedon2012-06-1500:39:38withasizeof13.56GBandVirusShare00207.zipcreatedon2015-12-1622:56:17withasizeof13.91GB,alltogethercontained131,072unique,uncategorisedandunsortedmalwaresamples.Theywillbereferredfurtherasmalware000andmalware207.Tobeabletoperformexperimentsonthedataset,wehavetoﬁlteroutirrelevantsamples(notspeciﬁcPE32andnotexecutables),whichareoutofscopeinthispaper.However,processingofmorethan100ksamplesputlimitationsandrequirenon-trivialapproachestohandlesuchamountofﬁles.Wediscoveredthatcommonwaysofworkingwithﬁlesindirectorysuchthatsimplelsandmvinbashtakeunreasonableamountoftimetoexecute.Alsothereisnowaytodistinguishﬁlesbyextensionlike*.dllor*.exesincethenamesarejustmd5sums.So,followingﬁlteringstepswereperformed:1.Heapofunﬁlteredmalwareandbenignﬁleswereplacedintotwodirectories”malware/”and”benign/”.2.Toeliminateduplicates,werenamedalltheﬁlestotheirMD5sums.3.PE32ﬁlesweredetectedineachfolderusingﬁleLinuxcommand:\$file000000b4dccfbaa5bd981af2c1bbf59a000000b4dccfbaa5bd981af2c1bbf59a:PE32executable(DLL)(GUI)Intel80386,forMSWindows4.AllPE32ﬁlesfromcurrentdirectorythatmeetourrequirementwerescrappedandmovetoadedicatedone:#!/bin/shcd../windows1;counter=0;foriin∗;docounter=$((counter+1));echo”$counter”;VAR=”file$i|grepPE32”;21

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial21VAR1=$(eval”$VAR”);len1=${#VAR1};if[−n”$VAR1”]&&[”$len1”−gt”1”];thenecho”$VAR1”|awk’{print$1}’|awk’{gsub(/:$/,””);print$1”../windows/PE/”$1}’|xargsmv−f;elseecho”other”;file$i|awk’{print$1}’|awk’{gsub(/:$/,””);print$1”../windows/other/”$1}’|xargsmv−f;fidone5.WefurthercanseeavarietyofPE32modiﬁcationsfor32bitarchitecture:PE32executable(GUI)Intel80386,forMSWindowsPE32executable(DLL)(GUI)Intel80386,forMSWindowsPE32executable(GUI)Intel80386,forMSWindows,UPXcompressedFollowingourpurposetoconcentrateon32bitarchitecture,onlyPE32areﬁlteredoutfromallpossiblevariantsofPE32ﬁlesshownabout.6.AfterextractingatargetgroupofbenignandmaliciousPE32ﬁles,multipleroundsoffeatureextractionareperformedaccordingtomethodsusedinthelit-erature.7.Finally,weinsertextractedfeaturesintothecorrespondingMySQLdatabasetoeasethehandling,featureselectionandmachinelearningprocessesrespectively.Aftercollectingallpossibleﬁlesandperformingthepre-processingphase,weendedupwiththesetsrepresentedintheTable2.Table2:CharacteristicsofthedatasetcollectedandusedforourexperimentsafterﬁlteringPEﬁlesDatasetNumberofﬁlesSizeBenign16,6327.4GBMalware00058,02314.0GBMalware20741,89916.0GBFurther,featureconstructionandextractionroutinefromPEﬁleswasperformedusingseveraltoolsasfollows:1.PEFRAME[4]isanopensourcetoolspeciﬁcallydesignedforstaticanalysisofPEmalware.ItextractsvariousinformationfromPEheaderrangingfrompackerstoantidebugandantivmtricks.22

22AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFranke2.HEXDUMPisastandardLinuxcommandlinetoolwhichisusedtodisplayaﬁleinspeciﬁcformatlikeASCIIorone-byteoctal.3.OBJDUMPisastandardLinuxcommandlinetootodetectapplicationsinstruc-tions,consumedmemoryaddresses,etc.5Results&DiscussionsBeforetestingdifferentMLtechniquesformalwaredetectionitisimportanttoshowthatourdatasetsactuallyrepresentthereal-worlddistributionofthemalwareandgoodware.Comparisonof”CompileTime”ﬁeldofPE32headercanbeutilizedforthispurpose.Figure7representslog-scalehistogramofthecompilationtimeforourbenigndataset.TakingintoconsiderationtheWindowsOStimelinewefoundaharmonybetweenourbenigndatasetapplicationscompiletimeanddevelopmentofMicrosoftWindowsoperatingsystems.Tostartwith,Windows3.1wasoriginallyreleasedonApril6,1992andourplotofbenignapplicationsindicatesthebiggestspikeinearly1992.Lateronin1990th,Windows95wasdueon24August1995,whilenextWindows98wasannouncedon25June1998.Further,2000thmarkedreleaseofWindowsXPonOctober25,2001.NextphasesontheplotcorrespondtothereleaseofWindowsVistaon30thJanuary2007andWindows7on22ndOctober2009.Nextpopularversion(Windows8)appearedon26thOctober2012andthelatestmajorspikeintheendof2014correspondstothereleaseofWindows10on29thJuly2015.Further,compilationtimedistributionfortheﬁrstmalwaredatasetmalware000isgivenintheFigure8.WecanclearlyseethatreleaseofnewerWindowsversionisalwaysfollowedbyanincreaseofcumulativedistributionofmalwaresamplesinfollowing6to12month.Itcanbeseenthatthereleaseof32bitWindows3.1causeaspikeinanumberofmalware.Afterthisthenumberofmalwarecompiledeachyearisconstantlygrowing.Then,anotherincreasecanbeobservedinsecondhalfofthe2001whichcorrespondstothereleaseoftheWindowsXPandsoon.ConsideringthefactthatMSDOSwasreleasedin1981itmakescompilationtimesbeforethisdaylooklikefakeorjustobfuscatedintentionally.Ontheotherhandthedatasetmalware000cannothavedateslaterthanJune2012.Therefore,malwarewithcompilationtimepriorto1981orlaterthanJan2012aretampered5.1AccuracyofML-aidedMalwareDetectionusingStaticCharacteristicsThispartpresentsresultsofapplyNaiveBayes,BayesNet,C4.5,k-NN,SVM,ANNandNFmachinelearningalgorithmsagainststaticfeaturesofourdatasetnamelyPE32header,Bytesn-gram,Opcoden-gram,andAPIcallsn-gram.23

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial23Fig.7:Log-scalehistogramofcompilationtimesforbenigndatasetFig.8:Log-scalehistogramofcompilationtimesformalware000dataset5.1.1PE32headerPE32headerisoneofthemostimportantfeaturesrelevanttothreatintelligenceofPE32applications.WeperformedfeatureselectionusingCfsandInfoGainmethodswith5-foldcross-validationaspresentedintheTable3.WecanclearlyseethatthefeaturesfromtheShortInfosectioninPE32headerscanbeusedasastand-alonemalwareindicators,includingdifferentepochs.Num-berofdirectoriesinthissectionaswellasﬁlesizeandﬂagofEXEorDLLhavebiggermeritsincomparisontootherfeatures.Tocontrary,AntiDebugandSuspi-ciousAPIsectionsfromPEframecannotclassifyabinaryﬁle.Finally,wecansaythatdigitalsignatureandAntiVMﬁlesinPE32headersarealmostirrelevantinmalwaredetection.Further,weperformedexplorationofselectedMLmethodsthat24

24AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeFig.9:Log-scalehistogramofcompilationtimesformalware207datasetTable3:FeatureselectiononPE32features.BoldfontdenotesselectedfeaturesaccordingtoInfoGainmethodBenignvsMalware000BenignvsMalware207Malware000vsMalware207InformationGainmeritattributemeritattributemeritattribute0.377ShortInfoDirectories0.369ShortInfoDLL0.131ShortInfoFileSize0.278ShortInfoDLL0.252ShortInfoDirectories0.094ShortInfoDetected0.118AntiDebug0.142ShortInfoFileSize0.064SuspiciousAPI0.099Packer0.105SuspiciousSections0.044ShortInfoDirectories0.088SuspiciousSections0.101SuspiciousAPI0.036Packer0.082ShortInfoXor0.089AntiDebug0.028AntiDebug0.076SuspiciousAPI0.084ShortInfoDetected0.017SuspiciousSections0.045ShortInfoFileSize0.054ShortInfoXor0.016Url0.034ShortInfoDetected0.050Packer0.015AntiVM0.022Url0.036Url0.012ShortInfoXor0.004AntiVM0.002AntiVM0.002ShortInfoDLL0ShortInfoSections0ShortInfoSections0ShortInfoSections0DigitalSignature0DigitalSignature0DigitalSignatureCfsattributeattributeattributeShortInfoDirectoriesShortInfoDirectoriesShortInfoDirectoriesShortInfoXorShortInfoXorShortInfoFileSizeShortInfoDLLShortInfoDLLShortInfoDetectedShortInfoDetectedPackerUrlcanbeusedwithselectedfeatures.Byextractingcorrespondingnumericalfeaturesmentionedearlier,wewereabletoachieveclassiﬁcationaccuracylevelspresentedinTable4.Table3presentsalsoaccuracyofMLmethodafterperformingfeatureselection.Hereweusedwholesub-setsdeﬁnedbyCfsmethodandfeatureswithmeritof≥0.1detectedbyInfoGain.25

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial25Table4:ComparativeclassiﬁcationaccuracybasedonfeaturesfromPE32header,in%.Bn,Ml000andMl207arebenignandtwomalawaredatasetsrespectivelyDatasetNaiveBayesBayesNetC4.5k-NNSVMANNNFAllfeaturesBnvsMl00090.2991.4297.6397.3087.7595.0892.46BnvsMl20788.2791.2196.4395.9984.8893.2489.03Ml000vsMl20763.4171.5982.4582.1173.7769.9969.01InformationGainBnvsMl00088.3289.1794.0994.0194.0993.5187.53BnvsMl20787.2590.3995.0694.5884.5592.3787.88Ml000vsMl20758.2667.0567.7770.7069.4663.1951.31CfsBnvsMl00089.3590.8995.3995.3895.1693.6985.85BnvsMl20786.8889.6791.6191.6891.6891.6881.91Ml000vsMl20767.4570.9576.9876.9272.1568.1867.06Malwareandgoodwarecanbeeasilyclassiﬁedusingfullsetaswellassub-setoffeatures.OnecannoticethatANNandC4.5performedmuchbetterthanothermethods.Itcanbealsoseenthatthehighqualityofthesefeaturesmadethemveryappropriatetodifferentiatebetweenthebenignandmalware000dataset.Further,wecanseethatthetwodatasetsmalware000andmalware207aresimilarandextractedfeaturesdonotprovideahighclassiﬁcationaccuracy.NeuralNetworkwasusedwith3hiddenlayersmakingitanon-linearmodelandexperimentswereperformedusing5-foldcross-validationtechnique.5.1.2Bytesn-gramBytesn-gramisaverypopularmethodforstaticanalysisofbinaryexecutables.Thismethodhasonesigniﬁcantbeneﬁt:inordertoperformanalysisthereisnoneedofpreviousknowledgeaboutﬁletypeandinternalstructuresinceweuseitsraw(binary)form.ForfeatureconstructionweusedrandomproﬁlesthatwereﬁrstpresentedbyEbringeretal.[18]calledﬁxedsamplecount(seeFigure10),whichgeneratesﬁxednumberofrandomproﬁlesregardlessoftheﬁlesizeandslidingwindowalgorithm.InthismethodeachﬁleisrepresentedinahexadecimalformatandfrequenciesofeachbytearecountedtobuildaHuffmantreeforeachﬁle.Thenusingwindowofﬁxedsizeandmovingitonﬁxedskipsizetherandomnessproﬁleofeachwindowiscalculated.ARandomnessproﬁleissumofHuffmancodelengthofeachbyteinasinglewindow.Thelowertherandomnessinaparticularwindowthebiggerwillbetherandomnessofthatproﬁle.Wechose32bytesasthemostpromisingslidingwindowsize[18,48,74]andduetobigvarietyofﬁlesizesinourdataset,wechose30bestfeatures(orpruningsizeinterminologyfrom[18])whicharetheareasofbiggestrandomness(themostuniqueparts)intheiroriginalorder.Thisfeatureswasfedintodifferentmachine26

26AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeFig.10:Slidingwindowalgorithm[18]learningalgorithmsasshowninTable5.Ourresultsindicatethattheaccuracyofthistechniqueisnotthathighasitwasoriginallydevelopedtopreservelocaldetailsofaﬁle([18])whilethesizeofﬁleaffectslocalnessalot.Inourcaseﬁlesizesvaryfromaround0.5Kbto53.7Mbwhichadverselyaffecttheresults.Despiteworseresultsitisstilleasiertodistinguishbetweenbenignexecutablesandmalwarethanbetweenmalwarefromdifferenttimeslices.AlsowecanseethatANNisbetterinBenignvsMalware000dataset,C4.5inBenignvsMalware207andMalware000vsMalware207datasets.Table5:Classiﬁcationaccuracybasedonfeaturesfrombytesn-gramrandomnessproﬁles,in%DatasetNaiveBayesBayesNetC4.5k-NNSVMANNNFAllfeaturesBnvsMl00069.960.476.975.678.378.374.8BnvsMl20770.368.275.875.672.171.668.2Ml000vsMl20750.164.068.164.758.160.158.2AlsoitshouldbenotedthatwedidnotusefeatureselectionmethodsasinthecaseofPE32headerfeatures.BothInformationgainandCfsarenotefﬁcientduetothesimilarityoffeaturesandequivalenceinimportanceforclassiﬁcationprocess.FortheﬁrstdatasettheInformationGainwasintherangeof0.0473-0.0672whilefortheseconddatasetitwasintherangeof0.0672-0.1304andforthelastitwas0.0499-0.0725.Moreover,Cfsproducesbestfeaturesubsetnearlyequaltofullset.Therefore,wedecidedtouseallfeaturesasthereisnosubsetthatcouldpossiblybebetterthanoriginalone.27

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial27(a)Lessthan1M(b)Biggerthan1MFig.11:DistributionofﬁlesizevaluesinBytesforthreeclasses5.1.3Opcoden-gramOpcoden-gramconsistsofassemblyinstructionswhichconstructtheexecutableﬁle.Themainlimitationofthismethodisthatinordertogainopcodesweneeddisassembleanapplicationwhichsometimesfailstogivecorrectopcodesduetodifferentanti-disassemblyandpackingtechniquesusedinexecutableshenceweﬁl-teredoutthiskindofﬁlesfromourdataset.Weextracted100mostcommon3-and4-gramsfromeachofthreeﬁlesetsinourdataset.Thenweextractedasetof200mostcommonn-grams-whicharecalledfeaturen-grams-tobuildapresencevec-torwherevalue1wasassignedifacertainn-gramfromfeaturen-gramsispresentintop100mostusedn-gramsoftheﬁle.Table6representsresultsoffeatureselectionperformedonthedatasetwith3-grams.Ascanbeseentheﬁrsttwopairofdatasetshavealotofcommonn-grams,whileselectedn-gramsforthethirdpairofdatasetistotallydifferent.ForInformationGainthethresholdof0.1wasusedforbothbenignandmalwaredatasets,whileforthelastsetweusedInfoGainof0.02.ThesedatawerepassedtomachinelearningalgorithmsandresultsareshowninTables7and9.AscanbeseenC4.5performedwellandhadthehighestaccuracyalmostinallexperiments.Alsofeatureselectionsigniﬁcantlyreducedthenumberofn-gramsfrom200downto10-15,whileoverallaccuracyonallmethodsdidnotdroppedsigniﬁcantly.Infact,NaiveBayesperformedevenbetterthatcanbejusti-ﬁedbyreducedcomplexityoftheprobabilisticmodel.AlsoNFshowedmuchbetteraccuracyincomparisontoothermethodswhenusingallfeaturestodistinguishbe-tweentwomalwaredatasetswhichcanbelinkedtonon-linearcorrelationinthedatathatarecircumscribedintheGaussianfuzzypatches.Further,weinvestigatedifthereisanycorrelationbetweenn-gramsinﬁlesthatbelongtobothbenignandmaliciousclasses.Weextractedrelativefrequencyofeachn-gramaccordingtothefollowingformulahn−gram=NClassfiles∈n−gramNClassfiles,where28

28AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeTable6:Featureselectionon3-gramopcodefeatures.BoldfontdenotesfeaturesthatpresentinbothdatasetsthatincludenenignsamplesBenignvsMalware000BenignvsMalware207Malware000vsMalware207InformationGainmeritattributemeritattributemeritattribute0.302483int3movpush0.298812int3movpush0.042229pushlcallpushl0.283229int3int3mov0.279371int3int3mov0.039779movtestjne0.266485popretint30.227489popretint30.037087callpushlcall0.236949retint3int30.202162retint3int30.031045pushpushlcall0.191866jmpint3int30.193938jmpint3int30.134709callmovtest0.108580retpushmov0.133258movtestje0.115976callmovpop0.114482testjemov0.101328poppopret0.100371movtestjneCfsattributeattributeattributemovtestjemovmovaddpushpushlcallcallmovtestretpushmovmovtestjnecallmovpopxormovmovmovmovjmpretint3int3callmovtestjecmpjepopretint3popretint3cmpjepushpushmovaddpushmovaddpushleacallint3int3movint3int3movcallpopretcallmovjmpcallmovjmpleaveretpushjmpint3int3jmpint3int3pushmovaddint3movpushint3movpushpushcallleacallpushlcallcallmovleapushlcallpushlmovmovmovlcalljmpmovTable7:Classiﬁcationaccuracybasedonfeaturesfromopcode3-gram,in%DatasetNaiveBayesBayesNetC4.5k-NNSVMANNNFAllfeaturesBnvsMl00083.5183.5295.5393.8294.4394.5195.28BnvsMl20784.5284.5293.9391.8492.3292.4493.20Mn000vsMl20763.7363.7381.2178.6475.4276.6483.13InformationGainBnvsMl00086.7486.9490.4190.4589.9890.2684.45BnvsMl20786.2286.2286.2286.2287.4687.4883.36Mn000vsMl20763.1962.5571.1971.8969.5467.3669.14CfsBnvsMl00087.7988.6691.1591.2290.9090.8285.31BnvsMl20786.2486.3389.9289.7389.1789.3481.58Mn000vsMl20786.2486.3389.9289.7389.1789.3469.25NClassfiles∈n−gramindicatesnumberofﬁlesinclassthathasn-gramandNClassfilesisatotalnumberofﬁlesinthisclass.Theresultsfor3-gramisdepictedintheFigure12.29

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial29Asareferencewetooktop20mostfrequentn-gramsfrombenignclassandfoundfrequencyofthecorrespondingn-gramsfrombothmalwaredatasets.Itcanbeseenthatthefrequencydoesnotdifferfundamentally,yetn-gramsforbothmaliciousclassestendtohaveveryclosenumbersincomparisontobenignﬁles.Moreover,thereisacleardependencybetweenbothmaliciousclasses.Wealsocannoticethatmostofthefeaturesselectedfromtwodatasetsthatincludesbenignsamplesaresame.Thishighlightsreliabilityoftheselected4-gramsandgeneralizationofthismethodformalwaredetection.Fig.12:Distributionofthefrequenciesoftop20opcode3-gramsfrombenignsetincomparisontobothmaliciousdatasetsAdditionally,westudied4-gramfeaturesandextracted200featuresasshowninTable8.Similartothe3-gramsfeaturesselectedintheTable6onecanseethattwoﬁrstpairsofdatasetshavealotofcommonfeatures,whilethelastoneprovidesasigniﬁcantlydifferentset.Asincasewith3-gramsweusedInformationGainwiththresholdof0.1forbothbenignandtheﬁrstmalwaredataset,whileforthelastmalwaresetweusedInfoGainof0.02,whichlooksreasonablewithrespecttonumberofselected‘features.TheclassiﬁcationperformanceisgiveninFigure9.Ascanbeseen,3-gramscanshowabitbetterresultthan4-gramsincaseofdistinguishingbetweenbenignandmalware000orBenignandmalware207withC4.5classiﬁer.Atthesametime4-gramsarebetterinordertodistinguishbetweentwomalwaredatasetswithC4.5classiﬁer.Wecanconcludethatresultsarequitegood,andcanbeusedformalwaredetection.Inouropinionresultscanbeimprovedbyextractingmorefeaturesandusageofrelativefrequenciesratherthanpurevectors.Incontraryto3-gramswecanseethatthehistogramsof4-gramshavefunda-mentaldifferenceswhenitcomestomaliciousandbenignsetsasitisdepictedinFigure13.Wecanseethatthefrequenciescorrespondtomalware000andmal-ware207datasetsarenearlysimilarandarefarfromthefrequenciesdetectedforthebenignclass.Moreover,thereisaclearandstrongcorrelationbetweentwomal-waredatasets.So,wecanconcludethatincaseofprobabilistic-basedmodelslikeBayesNetworkandNaiveBayestheclassiﬁcationcouldbeabitbetterduetodif-ferencesinlikelihoodofappearance,whichcanbealsofoundinTables7and9.30

30AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeTable8:Featureselectiononon4-gramopcodefeatures.BoldfontdenotesfeaturesthatpresentinbothdatasetsthatincludenenignsamplesBenignvsMalware000BenignvsMalware207Malware000vsMalware207InformationGainmeritattributemeritattributemeritattribute0.303209int3int3movpush0.295427int3int3movpush0.047452pushlcallpushlcall0.295280int3movpushmov0.286378int3movpushmov0.045860movpoppopret0.285608int3int3int3mov0.266966int3int3int3mov0.044750jepushcallpop0.258733popretint3int30.229431jmpint3int3int30.044573callpushlcallpushl0.241215poppopretint30.224318poppopretint30.038822cmpjepushcall0.233205jmpint3int3int30.210289popretint3int30.035731pushcallpopret0.220679retint3int3int30.170367retint3int3int30.030460pushcallpopmov0.185178movpopretint30.148442movpopretint30.028564movcmpjepush0.151337movpushmovsub0.116760movpushmovsub0.025813cmpjecmpje0.125703pushcallmovtest0.103841movpushmovpush0.024372leaveretpushmov0.104993movpushmovpush0.102730movpushmovmov0.023374pushpushpushlcall0.104416movpushmovmov0.022312pushcallpoppop0.021929movtestjepush0.020003pushpushleapushCfsattributeattributeattributeincaddincaddaddaddaddaddleaveretpushmovmovpushmovsubmovmovpushpushcallmovtestjejmpmovmovmovmovpushmovsubjepushcallpoppushcallmovtestpushcallmovtestpushlcallpushlcallint3int3int3movint3int3int3movpushpushpushleamovpoppopretmovxormovmovjecmpjecmpjmpint3int3int3pushlcallpushlcallmovpoppopretmovpopretint3jmpint3int3int3pushcallmovpushint3int3movpushmovpopretint3pushmovmovcallint3movpushmovint3int3movpushmovpopretint3poppopretint3int3movpushmovcmpjepushcalladdpushpushpushpoppopretint3movleamovmovpushpushcallleamovmovjmpmovpushpushcalllearetnopnopnopmovaddpushpushsubpushpushpushFig.13:Distributionofthefrequenciesoftop20opcode4-gramsfrombenignsetincomparisontobothmaliciousdatasets31

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial31Table9:Classiﬁcationaccuracybasedonfeaturesfromopcode4-gram,in%DatasetNaiveBayesBayesNetC4.5k-NNSVMANNNFAllfeaturesBnvsMl00086.9286.9295.3193.7394.2894.2395.54BnvsMl20786.8486.8493.3391.7192.0392.0493.75Ml000vsMl20764.9064.9081.5878.9874.9875.7778.80InformationGainBnvsMl00087.7987.8991.4891.4591.3190.8485.74BnvsMl20784.6484.5787.8487.8387.2587.7048.67Mn000vsMl20762.7363.2069.9670.2568.4067.2468.90CfsBnvsMl00089.6389.6391.5191.5291.5290.7684.95BnvsMl20786.4186.6489.3689.4889.1689.1281.13Mn000vsMl20766.2866.1772.0072.2768.9669.1769.325.1.4APIcalln-gramsAPIcallsn-gramsisthecombinationofspeciﬁcoperationsinvokedbytheprocessinordertousefunctionalitiesofanoperationsystem.InthisstudyweusedpeframetoextractAPIcallsfromPE32ﬁles.Thebiggerthen-gramsizeistheloweraccuracyispossibletogain.ThereasonforthisisthatsingleAPIcallsandtheirn-gramsarefarfewerincomparisonwithforexampleopcoden-grams.AfterextractionofAPIcalls,wecombinedtheminto1-and2-grams.Foreachtaskweselected100mostfrequentfeaturesinaparticularclassandcombinedtheminto200-featurevectors.Tables10and11presentsresultsofmachinelearningevaluationonAPIcalln-gramsdata.AswecanseeANN,k-NNandC4.5arethebestclassiﬁerssimilartopreviousresults.Itisalsomoredifﬁculttodistinguishbetweenﬁlesfrommalware000andmalware207.Wegainedquitehighaccuracy,butitisstilllowerthaninrelatedstudies.Itcouldbeexplainedbythesizeofdatasets:otherstudiesdatasetsusuallyconsistofseveralhundredsorthousandsofﬁleswhileourdatasethasmorethan110,000ﬁles.Afteranalysingfeatureselectionresultswedecidednottoincludethemintheresultssectionsincemostofthefeaturesaresimilarintermsofdis-tinguishingbetweenmalwareandgoodware.ItmeansthatthereislargenumberofuniqueAPIcallsthatcanbefoundonceortwiceinaﬁleincontrarytothebyteoropcoden-gramTable10:ClassiﬁcationaccuracybasedonAPIcall1-gramfeatures,%DatasetNaiveBayesBayesNetC4.5k-NNSVMANNNFAllfeaturesBnvsMl00090.7990.7993.3993.4793.5193.4382.44BnvsMl20787.1887.1890.9491.0391.3791.2381.28Ml000vsMl20766.1966.278.4477.0973.3372.7773.5532

32AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFrankeTable11:ClassiﬁcationaccuracybasedonAPIcall2-gramfeatures,%DatasetNaiveBayesBayesNetC4.5k-NNSVMANNNFAllfeaturesBnvsMl00086.5486.5590.8891.5391.9691.8575.24BnvsMl20781.9481.9187.8488.8288.3187.8183.61Ml000vsMl20762.3162.3173.6973.1770.2769.4570.08WealsostudiedthedifferencebetweenfrequenciesdistributionsofAPIcalls.Figure14sketchesextractedAPI1-gramsfromthreedatasets.Onecanseethatthereisasigniﬁcantspreadbetweennumbersofoccurrencesinbenignclassincontrarytobothmaliciousdatasets.Ontheotherhand,resultsforbothmalwaredatasetsaresimilar,whichindicatesstatisticalsigniﬁcanceofextractedfeatures.Itisimportanthohighlightthatthelargestscatterareinfrequenciesformemset(),malloc()andfree()APIcalls.Ontheotherhand,maliciousprogramstendtouseGetProcAddress()functionmoreoftenforretrievingtheaddressofanyfunctionfromdynamic-linklibrariesinthesystem.Fig.14:frequenciesof20mostfrequentAPI1-gramsforthreedifferentdatasets6ConclusionInthispaperwepresentedasurveyonapplicationsofmachinelearningtech-niquesforstaticanalysisofPE32Windowsmalware.First,weelaboratedondiffer-entmethodsforextractingstaticcharacteristicsoftheexecutableﬁles.Second,anoverviewofdifferentmachinelearningmethodsutilizedforclassiﬁcationofstaticcharacteristicsofPE32ﬁleswasgiven.Inaddition,weofferedataxonomyofmal-warestaticfeaturesandcorrespondingMLmethods.Finally,weprovidedatutorialonhowtoapplydifferentMLmethodsonbenignandmalwaredatasetforclassiﬁca-tion.WefoundthatC4.5andk-NNinmostcasesperformbetterthanothermethods,33

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial33whileSVMandANNonsomefeaturesetsshowedgoodperformance.OntheotherhandBayesNetworkandNaiveBayeshavepoorperformancecomparedtootherMLmethods.Thiscanbeexplainedbynegligiblylowprobabilitieswhichpresentinalargenumberoffeaturessuchasopcodeandbytesn-grams.So,itcanseethatstatic-analysisusingMLisafastandreliablemechanismtoclassifymaliciousandbenignsamplesconsideringdifferentcharacteristicofPE32executables.MachineLearning-aidedstaticmalwareanalysiscanbeusedaspartofCyberThreatIntel-ligence(CTI)activitiestoautomatedetectionofindicationsofcompromisefromstaticfeaturesofPE32Windowsﬁles.References1.Virusshare.com.http://virusshare.com/.accessed:15.10.2015.2.Vxheaven.http://vxheaven.org/.accessed:25.10.2015.3.Weka3:Dataminingsoftwareinjava.http://www.cs.waikato.ac.nz/ml/weka/.accessed:10.09.2015.4.GianniAmato.Peframe.https://github.com/guelfoweb/peframe.accessed:20.10.2015.5.M.Baig,P.Zavarsky,R.Ruhl,andD.Lindskog.Thestudyofevasionofpackedpefromstaticdetection.InInternetSecurity(WorldCIS),2012WorldCongresson,pages99–104,June2012.6.SimenRuneBragen.Malwaredetectionthroughopcodesequenceanalysisusingmachinelearning.Master’sthesis,GjvikUniversityCollege,2015.7.C.Cepeda,D.L.C.Tien,andP.Ordez.Featureselectionandimprovingclassiﬁcationperfor-manceformalwaredetection.In2016IEEEInternationalConferencesonBigDataandCloudComputing(BDCloud),SocialComputingandNetworking(SocialCom),SustainableComput-ingandCommunications(SustainCom)(BDCloud-SocialCom-SustainCom),pages560–566,Oct2016.8.MohsenDamshenas,AliDehghantanha,andRamlanMahmoud.Asurveyonmalwarepropa-gation,analysis,anddetection.InternationalJournalofCyber-SecurityandDigitalForensics(IJCSDF),2(4):10–29,2013.9.F.Daryabar,A.Dehghantanha,andN.I.Udzir.Investigationofbypassingmalwaredefencesandmalwaredetections.In20117thInternationalConferenceonInformationAssuranceandSecurity(IAS),pages173–178,Dec2011.10.FaridDaryabar,AliDehghantanha,andHoorangGhasemBroujerdi.Investigationofmalwaredefenceanddetectiontechniques.InternationalJournalofDigitalInformationandWirelessCommunications(IJDIWC),1(3):645–650,2011.11.FaridDaryabar,AliDehghantanha,BrettEterovic-Soric,andKim-KwangRaymondChoo.Forensicinvestigationofonedrive,box,googledriveanddropboxapplicationsonandroidandiosdevices.AustralianJournalofForensicSciences,48(6):615–642,2016.12.FaridDaryabar,AliDehghantanha,NurIzuraUdzir,SolahuddinbinShamsuddin,etal.To-wardssecuremodelforscadasystems.InCyberSecurity,CyberWarfareandDigitalForensic(CyberSec),2012InternationalConferenceon,pages60–64.IEEE,2012.13.FaridDaryabar,AliDehghantanha,NurIzuraUdzir,etal.Areviewonimpactsofcloudcomputingondigitalforensics.InternationalJournalofCyber-SecurityandDigitalForensics(IJCSDF),2(2):77–94,2013.14.AliDehghantanhaandKatrinFranke.Privacy-respectingdigitalinvestigation.InPrivacy,SecurityandTrust(PST),2014TwelfthAnnualInternationalConferenceon,pages129–138.IEEE,2014.34

34AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFranke15.DhruwajitaDeviandSukumarNandi.Detectionofpackedmalware.InProceedingsoftheFirstInternationalConferenceonSecurityofInternetofThings,SecurIT’12,pages22–26,NewYork,NY,USA,2012.ACM.16.DennisDistlerandCharlesHornat.Malwareanalysis:Anintroduction.SansReadingRoom,2007.17.T.Dube,R.Raines,G.Peterson,K.Bauer,M.Grimaila,andS.Rogers.Malwaretyperecog-nitionandcybersituationalawareness.InSocialComputing(SocialCom),2010IEEESecondInternationalConferenceon,pages938–943,Aug2010.18.TimEbringer,LiSun,andSerdarBoztas.Afastrandomnesstestthatpreserveslocaldetail.VirusBulletin,2008,2008.19.ParvezFaruki,VijayLaxmi,M.S.Gaur,andP.Vinod.Miningcontrolﬂowgraphasapicall-gramstodetectportableexecutablemalware.InProceedingsoftheFifthInternationalConferenceonSecurityofInformationandNetworks,SIN’12,pages130–137,NewYork,NY,USA,2012.ACM.20.AndersFlaglien,KatrinFranke,andAndreArnes.Identifyingmalwareusingcross-evidencecorrelation.InIFIPInternationalConferenceonDigitalForensics,pages169–182.SpringerBerlinHeidelberg,2011.21.TristanFletcher.Supportvectormachinesexplained.[Online].http://sutikno.blog.undip.ac.id/ﬁles/2011/11/SVM-Explained.pdf.[Accessed06062013],2009.22.KatrinFranke,ErikHjelm˚as,andStephenDWolthusen.Advancingdigitalforensics.InIFIPWorldConferenceonInformationSecurityEducation,pages288–295.SpringerBerlinHeidelberg,2009.23.KatrinFrankeandSargurNSrihari.Computationalforensics:Towardshybrid-intelligentcrimeinvestigation.InInformationAssuranceandSecurity,2007.IAS2007.ThirdInterna-tionalSymposiumon,pages383–386.IEEE,2007.24.MarkAHallandLloydASmith.Practicalfeaturesubsetselectionformachinelearning.Proceedingsofthe21stAustralasianComputerScienceConferenceACSC’98,1998.25.ChrisHoffman.Howtokeepyourpcsecurewhenmicrosoftendswin-dowsxpsupport.http://www.pcworld.com/article/2102606/how-to-keep-your-pc-secure-when-microsoft-ends-windows-xp-support.html.accessed:18.04.2016.26.AnilKJain,RobertPWDuin,andJianchangMao.Statisticalpatternrecognition:Areview.PatternAnalysisandMachineIntelligence,IEEETransactionson,22(1):4–37,2000.27.SachinJainandYogeshKumarMeena.Byteleveln–gramanalysisformalwaredetection.InComputerNetworksandIntelligentComputing,pages51–59.Springer,2011.28.KrisKendallandChadMcMillan.Practicalmalwareanalysis.InBlackHatConference,USA,2007.29.Z.KhorsandandA.Hamzeh.Anovelcompression-basedapproachformalwaredetectionusingpeheader.InInformationandKnowledgeTechnology(IKT),20135thConferenceon,pages127–133,May2013.30.TeuvoKohonenandTimoHonkela.Kohonennetwork.Scholarpedia,2(1):1568,2007.31.JeremyZ.KolterandMarcusA.Maloof.Learningtodetectmaliciousexecutablesinthewild.InProceedingsoftheTenthACMSIGKDDInternationalConferenceonKnowledgeDiscoveryandDataMining,KDD’04,pages470–478,NewYork,NY,USA,2004.ACM.32.IgorKononenkoandMatjaˇzKukar.Machinelearninganddatamining:introductiontoprin-ciplesandalgorithms.HorwoodPublishing,2007.33.S.Kumar,M.Azad,O.Gomez,andR.Valdez.Canmicrosoft’sservicepack2(sp2)securitysoftwarepreventsmurfattacks?InAdvancedInt’lConferenceonTelecommunicationsandInt’lConferenceonInternetandWebApplicationsandServices(AICT-ICIW’06),pages89–89,Feb2006.34.Lastline.Thethreatofevasivemalware.whitepaper,LastlineLabs,https://www.lastline.com/papers/evasive_threats.pdf,February2013.accessed:29.10.2015.35

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial3535.N.A.Le-KhacandA.Linke.Controlﬂowchangeinassemblyasaclassiﬁerinmalwareanalysis.In20164thInternationalSymposiumonDigitalForensicandSecurity(ISDFS),pages38–43,April2016.36.WoodyLeonhard.Atmswillstillrunwindowsxp–butabiggershiftinsecuritylooms.http://www.infoworld.com/article/2610392/microsoft-windows/atms-will-still-run-windows-xp----but-a-bigger-shift-in-security-looms.html,March2014.accessed:09.11.2015.37.R.J.MangialardoandJ.C.Duarte.Integratingstaticanddynamicmalwareanalysisusingmachinelearning.IEEELatinAmericaTransactions,13(9):3080–3087,Sept2015.38.Z.MarkelandM.Bilzor.Buildingamachinelearningclassiﬁerformalwaredetection.InAnti-malwareTestingResearch(WATeR),2014SecondWorkshopon,pages1–4,Oct2014.39.M.M.Masud,L.Khan,andB.Thuraisingham.Ahybridmodeltodetectmaliciousexecuta-bles.InCommunications,2007.ICC’07.IEEEInternationalConferenceon,pages1443–1448,June2007.40.Microsoft.Microsoftsecurityessentials.http://windows.microsoft.com/en-us/windows/security-essentials-download.accessed:18.04.2016.41.Microsoft.Setapplication-speciﬁcaccesspermissions.https://technet.microsoft.com/en-us/library/cc731858%28v=ws.11%29.aspx.accessed:30.05.2016.42.C.Miles,A.Lakhotia,C.LeDoux,A.Newsom,andV.Notani.Virusbattle:State-of-the-artmalwareanalysisforbettercyberthreatintelligence.In20147thInternationalSymposiumonResilientControlSystems(ISRCS),pages1–6,Aug2014.43.NikolaMilosevic,AliDehghantanha,andKim-KwangRaymondChoo.Machinelearningaidedandroidmalwareclassiﬁcation.Computers&ElectricalEngineering,2017.44.S.Naval,V.Laxmi,M.Rajarajan,M.S.Gaur,andM.Conti.Employingprogramse-manticsformalwaredetection.IEEETransactionsonInformationForensicsandSecurity,10(12):2591–2604,Dec2015.45.FarhoodNorouzizadehDezfouli,AliDehghantanha,BrettEterovic-Soric,andKim-KwangRaymondChoo.Investigatingsocialnetworkingapplicationsonsmartphonesdetect-ingfacebook,twitter,linkedinandgoogle+artefactsonandroidandiosplatforms.Australianjournalofforensicsciences,48(4):469–488,2016.46.OpeyemiOsanaiye,HaibinCai,Kim-KwangRaymondChoo,AliDehghantanha,ZhengXu,andMqheleDlodlo.Ensemble-basedmulti-ﬁlterfeatureselectionmethodforddosdetec-tionincloudcomputing.EURASIPJournalonWirelessCommunicationsandNetworking,2016(1):130,2016.47.HamedHaddadPajouh,RezaJavidan,RaoufKhayami,DehghantanhaAli,andKim-KwangRaymondChoo.Atwo-layerdimensionreductionandtwo-tierclassiﬁcationmodelforanomaly-basedintrusiondetectioniniotbackbonenetworks.IEEETransactionsonEmergingTopicsinComputing,2016.48.ShuhuiQi,MingXu,andNingZheng.Amalwarevariantdetectionmethodbasedonbyterandomnesstest.JournalofComputers,8(10):2469–2477,2013.49.J.RossQuinlan.Improveduseofcontinuousattributesinc4.5.Journalofartiﬁcialintelli-genceresearch,pages77–90,1996.50.RCQuinlan.4.5:Programsformachinelearningmorgankaufmannpublishersinc.SanFrancisco,USA,1993.51.DKrishnaSandeepReddyandArunKPujari.N-gramanalysisforcomputervirusdetection.JournalinComputerVirology,2(3):231–239,2006.52.SethRosenblatt.Malwarebytes:Withanti-exploit,we’llstoptheworstattacksonpcs.http://www.cnet.com/news/malwarebytes-finally-unveils-freeware-exploit-killer/.accessed:30.05.2016.53.NeilJ.Rubenking.Thebestantivirusutilitiesfor2016.http://uk.pcmag.com/antivirus-reviews/8141/guide/the-best-antivirus-utilities-for-2016.accessed:30.05.2016.36

36AndriiShalaginov,SergiiBanin,AliDehghantanha,KatrinFranke54.PaulRubens.10waystokeepwindowsxpmachinesse-cure.http://www.cio.com/article/2376575/windows-xp/10-ways-to-keep-windows-xp-machines-secure.html.accessed:18.04.2016.55.AshkanSami,BabakYadegari,HosseinRahimi,NaserPeiravian,SattarHashemi,andAliHamze.Malwaredetectionbasedonminingapicalls.InProceedingsofthe2010ACMSymposiumonAppliedComputing,SAC’10,pages1020–1025,NewYork,NY,USA,2010.ACM.56.S.Samtani,K.Chinn,C.Larson,andH.Chen.Azsecurehackerassetsportal:Cyberthreatintelligenceandmalwareanalysis.In2016IEEEConferenceonIntelligenceandSecurityInformatics(ISI),pages19–24,Sept2016.57.SANS.Who’susingcyberthreatintelligenceandhow?https://www.sans.org/reading-room/whitepapers/analyst/cyberthreat-intelligence-how-35767.accessed:01.03.2017.58.IgorSantos,FelixBrezo,XabierUgarte-Pedrero,andPabloGBringas.Opcodesequencesasrepresentationofexecutablesfordata-mining-basedunknownmalwaredetection.InformationSciences,231:64–82,2013.59.IgorSantos,XabierUgarte-Pedrero,BorjaSanz,CarlosLaorden,andPabloG.Bringas.Col-lectiveclassiﬁcationforpackedexecutableidentiﬁcation.InProceedingsofthe8thAnnualCollaboration,ElectronicMessaging,Anti-AbuseandSpamConference,CEAS’11,pages23–30,NewYork,NY,USA,2011.ACM.60.AsafShabtai,YuvalFledel,andYuvalElovici.Automatedstaticcodeanalysisforclassifyingandroidapplicationsusingmachinelearning.InComputationalIntelligenceandSecurity(CIS),2010InternationalConferenceon,pages329–333.IEEE,2010.61.KavehShaerpour,AliDehghantanha,andRamlanMahmod.Trendsinandroidmalwarede-tection.TheJournalofDigitalForensics,SecurityandLaw:JDFSL,8(3):21,2013.62.R.K.Shahzad,N.Lavesson,andH.Johnson.Accurateadwaredetectionusingopcodese-quenceextraction.InAvailability,ReliabilityandSecurity(ARES),2011SixthInternationalConferenceon,pages189–195,Aug2011.63.AndriiShalaginovandKatrinFranke.Automatedgenerationoffuzzyrulesfromlarge-scalenetworktrafﬁcanalysisindigitalforensicsinvestigations.In7thInternationalConferenceonSoftComputingandPatternRecognition(SoCPaR2015).IEEE,2015.64.AndriiShalaginovandKatrinFranke.Anewmethodforanoptimalsomsizedeterminationinneuro-fuzzyforthedigitalforensicsapplications.InAdvancesinComputationalIntelligence,pages549–563.SpringerInternationalPublishing,2015.65.AndriiShalaginovandKatrinFranke.Anewmethodoffuzzypatchesconstructioninneuro-fuzzyformalwaredetection.InIFSA-EUSFLAT.AtlantisPress,2015.66.AndriiShalaginovandKatrinFranke.Automatedintelligentmultinomialclassiﬁcationofmalwarespeciesusingdynamicbehaviouralanalysis.InIEEEPrivacy,SecurityandTrust2016,2016.67.AndriiShalaginovandKatrinFranke.Bigdataanalyticsbyautomatedgenerationoffuzzyrulesfornetworkforensicsreadiness.AppliedSoftComputing,2016.68.AndriiShalaginovandKatrinFranke.TowardsImprovementofMultinomialClassiﬁcationAccuracyofNeuro-FuzzyforDigitalForensicsApplications,pages199–210.SpringerInter-nationalPublishing,Cham,2016.69.AndriiShalaginov,KatrinFranke,andXiongweiHuang.Malwarebeaconingdetectionbymininglarge-scalednslogsfortargetedattackidentiﬁcation.In18thInternationalConferenceonComputationalIntelligenceinSecurityInformationSystems.WASET,2016.70.AndriiShalaginov,LarsStrandeGrini,andKatrinFranke.Understandingneuro-fuzzyonaclassofmultinomialmalwaredetectionproblems.InIEEEInternationalJointConferenceonNeuralNetworks(IJCNN2016),Jul2016.71.M.Shankarapani,K.Kancherla,S.Ramammoorthy,R.Movva,andS.Mukkamala.Kernelmachinesformalwareclassiﬁcationandsimilarityanalysis.InNeuralNetworks(IJCNN),The2010InternationalJointConferenceon,pages1–6,July2010.37

MachineLearningAidedStaticMalwareAnalysis:ASurveyandTutorial3772.MuazzamAhmedSiddiqui.Dataminingmethodsformalwaredetection.ProQuest,2008.73.HollyStewart.Infectionratesandendofsupportforwindowsxp.https://blogs.technet.microsoft.com/mmpc/2013/10/29/infection-rates-and-end-of-support-for-windows-xp/.accessed:01.04.2016.74.LiSun,StevenVersteeg,SerdarBoztas¸,andTrevorYann.Patternrecognitiontechniquesfortheclassiﬁcationofmalwarepackers.InInformationsecurityandprivacy,pages370–390.Springer,2010.75.SMominaTabish,MZubairShaﬁq,andMuddassarFarooq.Malwaredetectionusingstatis-ticalanalysisofbyte-levelﬁlecontent.InProceedingsoftheACMSIGKDDWorkshoponCyberSecurityandIntelligenceInformatics,pages23–31.ACM,2009.76.ShugangTang.Thedetectionoftrojanhorsebasedonthedatamining.InFuzzySystemsandKnowledgeDiscovery,2009.FSKD’09.SixthInternationalConferenceon,volume1,pages311–314,Aug2009.77.X.Ugarte-Pedrero,I.Santos,P.G.Bringas,M.Gastesi,andJ.M.Esparza.Semi-supervisedlearningforpackedexecutabledetection.InNetworkandSystemSecurity(NSS),20115thInternationalConferenceon,pages342–346,Sept2011.78.RVeeramaniandNitinRai.Windowsapibasedmalwaredetectionandframeworkanalysis.InInternationalconferenceonnetworksandcybersecurity,volume25,2012.79.C.Wang,Z.Qin,J.Zhang,andH.Yin.Amalwarevariantsdetectionmethodologywithanopcodebasedfeaturemethodandafastdensitybasedclusteringalgorithm.In201612thInternationalConferenceonNaturalComputation,FuzzySystemsandKnowledgeDiscovery(ICNC-FSKD),pages481–487,Aug2016.80.Tzu-YenWang,Chin-HsiungWu,andChu-ChengHsieh.Detectingunknownmaliciousex-ecutablesusingportableexecutableheaders.InINC,IMSandIDC,2009.NCM’09.FifthInternationalJointConferenceon,pages278–284,Aug2009.81.SteveWatsonandAliDehghantanha.Digitalforensics:themissingpieceoftheinternetofthingspromise.ComputerFraud&Security,2016(6):5–8,2016.82.YanfangYe,DingdingWang,TaoLi,DongyiYe,andQingshanJiang.Anintelligentpe-malwaredetectionsystembasedonassociationmining.Journalincomputervirology,4(4):323–334,2008.83.M.N.A.Zabidi,M.A.Maarof,andA.Zainal.Malwareanalysiswithmultiplefeatures.InComputerModellingandSimulation(UKSim),2012UKSim14thInternationalConferenceon,pages231–235,March2012.84.ZongquZhao.Avirusdetectionschemebasedonfeaturesofcontrolﬂowgraph.InArtiﬁcialIntelligence,ManagementScienceandElectronicCommerce(AIMSEC),20112ndInterna-tionalConferenceon,pages943–947,Aug2011.