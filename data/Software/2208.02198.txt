2
2
0
2

g
u
A
3

]

M

I
.
h
p
-
o
r
t
s
a
[

1
v
8
9
1
2
0
.
8
0
2
2
:
v
i
X
r
a

A simulation suite for readout with SMuRF tone-tracking
electronics

Cyndia Yua, Zeeshan Ahmedb, J. Mitch D’Ewartb, Josef C. Frischb, Shawn W. Hendersonb,
and Max Silva-Feaverc

aStanford University Department of Physics, Stanford, CA 94305
bSLAC National Accelerator Laboratory, Menlo Park, CA 94025
cUniversity of San Diego Department of Physics, La Jolla, CA 92093

ABSTRACT

We present the details of a simulation suite for modeling the eﬀects of readout with SLAC Microresonator
RF (SMuRF) electronics. The SMuRF electronics are a warm readout and control system for use with su-
perconducting microwave resonator-based detector systems. The system has been used with the BICEP/Keck
program and will be used on the upcoming Simons Observatory and BICEP Array experiments. This sim-
ulation suite is a software implementation of the main SMuRF algorithms for oﬄine analysis, modeling, and
study. The ﬁrmware-implemented algorithms for calibration, resonator frequency estimation, and tone tracking
present sources of potential bias or errors if not modeled properly. The simulator takes as input true detector
signal, realistic resonator properties, and SMuRF-related user-controlled readout settings. It returns the ﬁnal
ﬂux ramp-demodulated output of a detector timestream as would be passed to the experiment data acquisition
system, enabling the analysis of the impact of readout-related parameters on the ﬁnal science data. It is publicly
available in Python with accompanying Jupyter notebooks for user tutorials.

Keywords: microwave SQUID, multiplexing, simulation, readout, RF electronics, digital signal processing,
resonator

1. INTRODUCTION

Superconducting detectors are increasingly popular for a broad variety of applications due to their exquisite sen-
sitivity, high resolution, and low noise.1, 2 As these experiments seek to deploy ever-larger arrays to achieve their
science goals, new multiplexing techniques are required to reduce thermal loading and integration complexity.
Superconducting resonator-based detector or readout schemes transduce the detector signal into modulation of
the amplitude and/or phase of a microwave resonator. The wide available readout bandwidth and high quality
factors routinely achieved in nanofabrication allow for high channel count and/or high bandwidth readout of
superconducting detectors, qubits, and other cryogenic devices. These systems require sophisticated RF readout
electronics for interrogating the resonators and performing the digital signal processing necessary to infer the
detector signal.

SMuRF electronics are designed to meet the needs of large-format arrays read out with microwave SQUID
multiplexing (µmux).3, 4 The SMuRF system provides RF tone generation and readback, ﬂux ramp signal gener-
ation and demodulation, and other subsystems such as DC signal generation and conditioning, data streaming,
and timing synchronization that comprise a full experiment readout. The system has been demonstrated in an
engineering run on the Keck Array and will be deployed on the upcoming Simons Observatory experiment.5, 6
Laboratory-scale deployments are actively in use around the world for testing and characterization of µmux and
KID systems.

The SMuRF electronics are a highly complex and integrated system with hardware, ﬁrmware, and software
components that all contribute to the overall transfer function and performance of the readout. In particular,
the frequency error estimation, tone-tracking, and ﬂux ramp demodulation functions rely on proper calibration,
well-behaved resonators, and well-tuned user input parameters to arrive at faithful reconstructions of the detector

(cid:66) cyndiayu@stanford.edu

1

 
 
 
 
 
 
signal. In these proceedings we present a simulation suite to enable the exploration and modeling of these eﬀects.
The code implements the per-channel ﬁrmware algorithms as they are used in the SMuRF electronics, enabling
users to predict and study the eﬀects of the SMuRF signal processing on science data. We note that the current
software suite does not include multichannel eﬀects, such as implementation of the polyphase ﬁlter banks and
crosstalk. It also does not yet include any resonator or SQUID physics, such as response to varying input power
levels, changing resonance shapes, or resonator/SQUID coupling eﬀects, though these updates are planned for
future releases.

The format of these proceedings is as follows. In Sec. 2 we outline the basics of superconducting resonator
readout and microwave SQUID multiplexing as relevant for the simulation suite. We give a brief outline of the
SMuRF electronics in Sec. 3 with special focus on the digital signal processing algorithms implemented in the
software suite. An overview of the software implementation is given in Sec. 4. Three example use cases enabled
by this software suite are shown in Sec. 5. We conclude with a discussion of future directions in Sec. 6.

2. INTRODUCTION TO RESONATOR READOUT

The SMuRF electronics were broadly designed for use with superconducting microwave-frequency resonators,
which are a popular choice for detector and/or readout element for a variety of applications.7 In particular,
the system was optimized for use with the microwave SQUID multiplexer, a technology for reading out many
cryogenic detectors with a small number of wires. However, it is broadly applicable to and has been used with
other resonator technologies, most notably kinetic inductance detectors (KIDs). In this section we present some
basic elements of microwave SQUID multiplexing and resonator readout that will be relevant in later sections.

2.1 The Microwave SQUID Multiplexer

The microwave SQUID multiplexer consists of a superconducting GHz-frequency resonator coupled to a unique
rf SQUID, which is in turn coupled to a unique cryogenic detector, typically a transition-edge sensor (TES) or a
magnetic microcalorimeter (MMC). A schematic is given in Figure 1. A detector signal is thus transduced into a
ﬂux in the SQUID, which in turn modulates the eﬀective inductance of the resonator and therefore its resonance
frequency. Depending on available readout bandwidth and resonator quality factors, thousands of resonators
may be coupled to a common feedline and read out simultaneously.

To linearize the SQUID response without adding a unique feedback line for every detector channel, a common
ﬂux ramp line is coupled to all rf SQUIDs and modulated much faster than the anticipated detector signal.8
This modulation shape is traditionally implemented as a sawtooth waveform with suﬃcient amplitude to sweep
several ﬂux quanta in the SQUID per ramp. Thus, the detector signal is transduced to a phase modulation of
the ﬂux ramp-modulated resonance frequency response.

The SQUID response to input ﬂux is typically described in terms of the resonance frequency deviation
from some initial state. The shape of this response is quasi-sinusoidal, with the deviation from a pure sinusoid
parametrized by λ corresponding to the SQUID hysteresis parameter.9 The amplitude of the frequency swing fpp
is set by the coupling factors between the SQUID and the resonator. To maximize SQUID responsivity without
risking resonator bifurcation or pathological SQUID curves, µmux devices are traditionally designed such that
the peak to peak frequency swing fpp is matched to the resonance bandwidth ∆f . However, speciﬁc applications
or variations in fabrication may yield more undercoupled or overcoupled devices, where the coupling sets fpp.
For µmux, we operate in the regime where resonance shapes do not change substantially with SQUID ﬂux. This
is in contrast to KIDs, which often change in both resonance frequency and quality factor with detector loading.7

Since µmux allows for the beneﬁts of microwave resonator-based readout systems while maintaining separately
designed and optimized detector arrays, it is an increasingly popular readout scheme for applications in search
of larger detector counts and/or high bandwidth cryogenic detector readout. The technology has been used for
astronomical applications with the MUSTANG-II instrument on the Green Bank Telescope and the Keck Array
cosmic microwave background (CMB) experiment, and is planned or considered for use on the upcoming Simons
Observatory and Ali-CPT CMB experiments as well as future far-IR and x-ray ﬂagship space missions.5, 10–14
Beyond astronomical applications, µmux has been demonstrated in gamma ray spectroscopy and is being explored
for use with x-ray spectroscopy with light sources.15

2

Figure 1. A schematic of the microwave SQUID multiplexer, shown here with two transition-edge sensor (TES) detectors
and two resonators. In this scheme, a dc-biased TES (red) is uniquely coupled to a GHz-frequency resonator (black) via
an rf SQUID. The detector signal modulates ﬂux in the SQUID, which presents as a variable inductor coupled to the
resonator. A common ﬂux ramp line (blue) linearizes the SQUID response without the need for additional feedback lines.

2.2 Resonator Readout

For a series of resonators coupled to a common transmission line, the state of the resonators is probed by exciting
the resonators and measuring the response. In this section and throughout the text we refer to the measured
resonator response as its forward transmission S21; other schemes are easily mapped onto this case. While some
schemes utilize a ringdown method for interrogating the resonator state, the associated nonlinearity and aliasing
penalties drive many readout schemes to favor constantly monitoring the transmitted response of a comb of
probe tones tuned to each resonance. Thus, in the discussion that follows we assume the resonance is excited
via a spectrally pure probe tone.

A resonator’s complex transmission response as a function of frequency S21(f ) may be parameterized by
an amplitude and phase, where the resonance exhibits a dip in amplitude and a sign change in phase at the
resonance frequency fres. Equivalently, the complex response can be separated into in-phase I and quadrature
Q components that are orthogonal to each other. An ideal resonator response in the IQ plane traces out a circle
oriented such that at the resonance frequency, the response is entirely in the quadrature direction. Non-idealities
such as cable delays, impedance mismatches on the transmission line, and coupling to box modes may in general
rotate or scale the response such that the response at the resonance frequency is no longer contained entirely in
one axis. A sketch of the various parameterizations for an ideal and non-ideal resonator is given in Figure 2.

3. SMURF ELECTRONICS

This section brieﬂy outlines the relevant details of the SLAC Microresonator RF (SMuRF) electronics. The
interested reader is directed to other SMuRF publications for further details.16, 17

The SMuRF electronics system is a warm readout system designed for use with cryogenic resonator-based
arrays. It generates the RF probe tones used to interrogate the resonances and reads back the transmitted RF
response. The system additionally provides cryogenic ampliﬁer and detector biases, ﬂux ramp signal generation,
timing synchronization, and data streaming to comprise a complete µmux readout system for large-scale experi-
ments. The ﬁrmware on the main FPGA contains the bulk of the advanced signal processing, including RF tone
generation and readback, signal manipulation, and clock synchronization. In the text that follows we describe
the SMuRF ﬁrmware that was optimized for readout of CMB-style µmux resonators, which have bandwidths of

3

Figure 2. Amplitude (left), phase (center), and complex (right) S21 responses for an ideal resonator (blue) and a more
realistic resonance with some asymmmetry, loss, and phase delay (orange). Note that these eﬀects rotate and scale the
resonance circle in the complex plane away from the ideal response. Here we add a small asymmetry in the form of a
complex coupled Q, 3 dB of loss from various connections, and 30◦ of delay corresponding to about 0.5mm of cable length
drift.

∼ 100 kHz and resonance frequencies in the 4 − 8 GHz range. Other applications may have slightly diﬀerent
bandwidths and channel counts, but the implementation details remain the same.

The RF probe tone generation and readback is implemented in ﬁrmware as an oversampled-by-2 polyphase
ﬁlter bank converting between 500 MHz-wide chunks of bandwidth digitized by each ADC and overlapping
2.4 MHz-wide channels, each of which may be mapped to a single detector. For each channel, SMuRF simul-
taneously reads out the complex response (I, Q), where the orthogonal components separation is done digitally
via Digital DownConversion (DDC) rather than relying on the orthogonality and stability of physical I/Q signal
chains.

Since the detector signal is encoded in the resonance frequency of the corresponding resonator, following
calibration as described in Subsec 3.1 the SMuRF ﬁrmware translates the (I, Q) digitized RF response to a
resonance frequency estimate. This frequency estimate is used to tune the probe tones to excite the resonators.
The linearity requirements for the RF hardware, particularly the cryogenic ampliﬁers and RF mixers, in a system
reading out hundreds or even thousands of resonators are quite strict. To address this, SMuRF system uniquely
implements a tone-tracking feedback algorithm that continuously updates the probe tone frequency to maintain
its centering on resonance. This minimizes tone power transmitted to the cryogenic ampliﬁer, since the resonator
response acts as a ﬁlter attenuating the probe tone.

Finally, since in µmux systems the detector signal is encoded in the phase of the ﬂux ramp-modulated
resonance frequency, the SMuRF system demodulates the resonance frequency signal as described in Subsec. 3.2.
It therefore outputs the demodulated detector signal, which can be streamed to experiment data acquisition
programs or written to disk.

3.1 Frequency Estimation

As discussed in Subsec. 2.2, the complex response of an ideal resonator is centered in the I/Q plane such that
small deviations from the resonance frequency are contained in a single quadrature. However, non-idealities
generically rotate and scale the response to an arbitrary position in the I/Q plane. For each resonator, the
complex response S21(f ) is measured carefully, and a probe tone centered on the resonance frequency is applied.
Currently, the probe tone is chosen to sit at the point of minimum S21 amplitude response, though other choices
are possible.

The SMuRF estimates the deviation of the resonance frequency from the probe tone ∆f by applying a
calibration factor to the measured ADC digital (I, Q) response such that resonator frequency variation contributes

4

In the small-signal limit where the frequency shift ∆f is small compared with the
only in one quadrature.
resonance bandwidth, we take the simplifying assumption that shifting the resonance frequency from the probe
tone is the inverse of shifting the probe tone relative to the resonance at constant ﬂux, i.e.

∂S21(f − fres(φ))
∂f

(cid:12)
(cid:12)
(cid:12)
(cid:12)φ=constant

= −

∂S21(f − fres(φ))
∂fres(φ)

.

(1)

The analogous statement for KID statements modulates S21 as a function of power on the detector rather than
ﬂux. As a consequence of this assumption, for reasonably constant conditions the resonator response S21 must
only be mapped once at a constant ﬂux, recording the I and Q components of the transmission.

The resonator response is rotated and scaled such that the response is in a single quadrature, allowing for
a single real-valued estimate ˆ∆f . The calibration factor η is estimated as the inverse of the unit modulus
transmission measured at some frequency oﬀset f± ≡ fres ± foﬀset from the resonance frequency. That is, η is
given by

η ≡

f+ − f−
S21(f+) − S21(f−)

(2)

The value of foﬀset is chosen empirically to capture the ﬂat portion of the resonator circle; it is typically about
10% of the resonance bandwidth.

Near resonance, we may then estimate the resonance frequency as

ˆ∆f ≡ Re [S21(fprobe + ∆f ) × η]

(3)

where S21(f + ∆f ) is the complex transmission at the shifted resonance frequency. We note that the real or
imaginary component taken in Eq. 3 depends on the convention used for the resonator I/Q plane relative to the
quadratures obtained from the ADC and DDC. Other documents may use a diﬀerent convention, resulting in
the imaginary component being taken rather than the real. A sketch of the η estimation and application is given
in Fig. 3.1.

With this frequency error estimate, the SMuRF feedback loop seeks to minimize ˆ∆f by continuously updating
the probe tone frequency fprobe such that ∆f → 0. This keeps the probe tone centered on the resonance dip as
the resonator is modulated, thereby minimizing probe tone power transmitted to the cryogenic ampliﬁer. The
resonance frequency as a function of time fres(t) is thus estimated as the tracked (probe tone) frequency.

We emphasize that the estimate relies on proper calibration of η, which in principle need be computed
only once at the start of observation. However, any cable delay drifts or other time-varying changes to the
resonator response induce rotations or scalings of the resonance circle not captured by η, potentially causing
unlocked feedback or improper reconstruction of detector signals. This presents a tradeoﬀ between more frequent
recalibration and observing eﬃciency. To address this, slow changes to resonator response may be monitored
with “pilot tones” monitoring the overall delay rather than individual resonators, and a slower feedback loop
may be implemented to update η without the need for recalibration.18

3.2 Flux Ramp Demodulation

Following η calibration, the feedback loop has a bandwidth of O(1 kHz), allowing for tracking of slow modulations
of the resonance frequency. This bandwidth may be suﬃcient for KID applications, but for µmux the ﬂux ramp
modulation is typically run at SQUID modulation rates of O(10s kHz) to adequately sample the science signal,
suppress 1/f noise from resonator frequency ﬂuctuations, and avoid aliasing penalties.19 To extend the bandwidth
of the tracking loop to these frequencies and simultaneously demodulate the detector-equivalent signal from the
ﬂux ramp modulation without need for saving to disk the full modulated timestreams, SMuRF implements a
stochastic gradient descent algorithm to minimize ∆f via a least mean squares ﬁt to the harmonics of a known
ﬂux ramp modulation frequency.

5

Figure 3. (Left) A resonance circle prior to calibration. (Right) A resonance circle after η has been applied. The red stars
denote the resonance frequency, while the orange line denotes the probe tone. Note that the axis scales have changed,
since the η calibration involves a magnitude scaling into frequency units. The diﬀerence between the probe tone and
resonance frequency is estimated by the projection of the response onto a single axis. This diﬀerence ∆f is subsequently
minimized in the tracking loop.

Given the quasi-sinusoidal nature of the SQUID ﬂux to resonance frequency relation, the ﬂux ramp-modulated
resonance frequency may be approximated as a Fourier series with known frequency but unknown amplitude
and phase. The principle harmonic ωc ≡ 2πfc is given by the ﬂux ramp sawtooth reset rate multiplied by the
number of a ﬂux quanta swept in a ramp period, typically 3-6. Thus, the resonance frequency is parameterized
by

fres[n] = constant +

M
(cid:88)

i=1

(ai sin ωiTsn + bi cos ωiTsn) + w[n]

(4)

where w[n] is a white noise term and ωi are the ith harmonics of the principle harmonic ωc. Note that we write
this in discrete time given the discretely sampled nature of the waveform as measured by the ADC; thus n takes
on only integer values. We may then estimate the phase of the ith harmonic and therefore the inferred TES
current from the harmonic coeﬃcients ai, bi via ∆ arctan(bi/ai) = i∆φi. Currently SMuRF tracks and estimates
up to M = 3 harmonics, which are empirically suﬃcient to maintain good tracking and measurement of the
SQUIDs tested thus far.

We estimate the coeﬃcients ai, bi via a stochastic gradient descent method implemented in ﬁrmware. Equa-

tion 4 is rewritten in vector form as

(cid:126)f = H(cid:126)α + (cid:126)w

(5)

for (cid:126)f and (cid:126)m the resonance frequency and measurement noise, respectively of M discrete samples in a ﬂux ramp
frame. Coeﬃcient vector (cid:126)α is a (2M + 1) × 1 vector of (a1, b1, . . . , aM , bM , constant) coeﬃcients for the sine and
cosine coeﬃcients of the M harmonics and constant term. This is multiplied by the harmonic sample matrix H,
an N × (2M + 1) matrix where the (i, j) entries are given by

6

for

Hij =






cos(j+1)/2[i],
sinj/2[i],
1,

j = odd
j = even
j = 2M + 1

sinm[n] ≡ sin(ωmTsn), ωm = m × ω1

(6)

(7)

and likewise for cosn[m]. Here Ts is the time per discrete sample. In the case of no ﬂux ramp modulation, we
have N = 0 and thus (cid:126)α reduces to a single constant α = ∆f .

At a discrete timestep n, we then predict the resonance frequency from Eq. 4 as

ˆf [n] = constant + a1 sin ω1Tsn + b1 cos ω1Tsn + · · ·

We see that this is equivalent to the dot product of the nth row of H with (cid:126)α, i.e.

ˆf [n] = (cid:126)Hn∗ · α

(8)

(9)

where the ∗ runs over all indices.

We estimate the frequency error between the probe tone and the resonance frequency ˆ∆f [n] as in Subsec. 3.1
using the η calibration. This error term allows us to update the prediction to minimize ˆ∆f via a stochastic
gradient descent:

(cid:126)α[n + 1] = (cid:126)α[n] + µ ˆ∆f [n]

(cid:17)

(cid:16) (cid:126)Hn∗

(10)

where µ is a user-deﬁned gain. Since ω1 is input by the user, this allows the tracking loop to have bandwidth
beyond the constant-only case. Given the frequency error term accumulates the phase error estimate over the
entire ﬂux ramp frame, we may think of the feedback as somewhat analogous to a PID controller with only a
proportional term.

Given the harmonic coeﬃcients, the phase of the ﬁrst harmonic is computed as φ1 = arctan(b1/a1). This is
typically averaged over the ﬂux ramp frame and passed to a downstream data framer or external data acquisition
system, which may further downsample or ﬁlter the data as needed. We thus consider the ﬂux ramp-demodulated
data output from SMuRF as sampled at the ﬂux ramp sawtooth reset rate, though the harmonic coeﬃcients
are updated at the per-channel digitizer rate. The eﬀects of these various sample rates are discussed further in
Subsec. 5.3.

4. SOFTWARE IMPLEMENTATION

The frequency estimation, tracking, and ﬂux ramp demodulation components of the SMuRF ﬁrmware algorithm
are critical to transforming the measured resonator response to the inferred detector-equivalent signal. To
enable exploring the impact of these algorithms and sensitivity to user-deﬁned parameters, we have implemented
a software simulation suite, babysmurf∗, which returns outputs given known inputs.

We note that these components act on a per-channel basis. Thus, any eﬀects of the channelization or
considerations of interacting channels such as crosstalk or colliding resonance modulations are not currently
modeled. Since the channelization ﬁlter bank is the inverse of the mechanism by which probe tones are generated,
this implies that we ignore the ﬁnite width of the probe tone and here consider it as a spectrally pure tone with
inﬁnite dynamic range. We furthermore do not implement any SQUID or resonator physics; arbitrary shapes
may be generated without enforcing that they are physically plausible and we do not account for any changes to
the SQUID or resonator response as a function of input power. These features are planned for future updates
and are welcomed as contributions from other users.

∗https://github.com/cyndiayu/babysmurf

7

Figure 4. A ﬂowchart of the babysmurf software suite. The green components are physical inputs, which may come from
real data or be generated given key parameters. The purple components are ﬂux ramp, feedback, and tracking parameters
that must be input by the user. From these, the blue components are calculated. The red components represent the main
non-trivial algorithms implemented by SMuRF.

A ﬂowchart of the software is given in Figure 4. Resonator response, SQUID parameters, detector signals,
and noise may be input by the user from real data, or generated based on deﬁning parameters. The ﬂux ramp
and feedback/tracking variables are implementation-speciﬁc parameters required to be speciﬁed by the user.
From these inputs, the calibration factor and ﬂux-modulated resonance frequency response may be calculated.
The core SMuRF algorithms compute the frequency error estimate and tracked resonance frequency, from which
the demodulated detector signal is derived.

4.1 Generating Resonances

We model the forward transmission of a resonance with total quality factor Q and coupled quality factor Qc as

S21(f ) = 1 −

Q ∗ Q−1
1 + 2iQ(f − fres)/fres

c

(11)

where fres is the resonance frequency.20 The coupling quality factor term Qc may be complex, which allows for
asymmetric resonances due to impedance mismatches between the resonator input and output ports. While the
resonator parameters being considered for various applications may vary widely, we take as default parameters
the behavior of NIST CMB µmux resonators, which have typical quality factors Q ∼ 5 × 104 and resonance
frequencies around fres ∼ 5 GHz.21 Throughout the code, we parameterize the complex resonator response via
a separate magnitude and phase to avoid confusion of conventions on the quadrature labels.

For a generated resonance, we may estimate η as described in Eq. 2. This allows exploration of the accuracy
of the frequency error estimation as a function of parameters such as resonance asymmetry and oﬀset frequency,
which may in turn inform user choices of estimation parameters given a particular realization of resonators.

4.2 Flux Ramp Modulation

The ﬂux ramp-modulated resonance frequency as a function of time is parametrized by a carrier frequency ωc as

8

∆fres(t) = C

(cid:18) λ cos(ωct)

(cid:19)

1 + λ cos(ωct)

(12)

where λ is the SQUID hysteresis parameter. We note that this equation is not fully physical, and the full
modeling of SQUID curves is the subject of intense study.22 For the purposes of the simulation suite, however,
it is suﬃcient to capture the quasi-sinusoidal nature of SQUID curves often encountered. The value of C may
be scaled such that the overall peak to peak swing of the resonance frequency ∆fpp is appropriately matched
to the bandwidth. We typically set ∆fpp ∼ 100 kHz. By appropriately scaling t we may reparameterize Eq. 12
in terms of input ﬂux, allowing for arbitrarily modifying the sample rate or number of Φ0 swept in a ﬂux ramp
frame. A SQUID curve in units of resonance frequency versus input ﬂux can similarly be measured from a cold
system and passed as input to the simulation suite.

Given a SQUID curve covering a full 2π in input ﬂux, a ﬂux ramp modulated signal may be generated by
perturbing the phase of each ﬂux ramp frame, where one frame is a single sawtooth ramp. The phase modulation
is achieved by shifting the ﬂux ramp frame forward and backward by an integer number of samples. Thus, the
phase modulation is eventually discretized by the ﬁnite sampling of the SQUID curve, which should be kept in
mind when interacting with the software.

Given a detector-equivalent signal as a function of time, it is interpolated or downsampled such that it is
sampled at the ﬂux ramp frame rate. This does not enforce the continuity of the resonance frequency at sawtooth
resets, which may have large transient signals or other eﬀects of large input signals.

The modulation of the resonance S21 is implemented na¨ıvely as a modulation of the entire resonance shape
in frequency space, with no incorporation of SQUID or resonator dynamics. That is, the entire resonator S21 is
modulated forward and backward in frequency without changing its shape in amplitude or phase.

4.3 Demodulation and Output Inspection

The tracking and demodulation algorithm as described in Subsec. 3.2 is implemented in two modes: (1) taking
only the ﬂux ramp-modulated resonance frequency as input and assuming perfect tracking, and (2) taking the
η estimate and modulating S21 as input such that the frequency error estimation is also used. This allows for
exploration of the eﬀects of the gradient descent and demodulation algorithms separately from the eﬀects of
the frequency error estimation if desired. The ﬁtted coeﬃcients (cid:126)α[n], tracked frequencies, estimated and real
frequency errors, and demodulated phase are all recorded for later inspection and comparison.

4.4 Noise

Noise is added at the timestream level by drawing from a distribution according to a user-deﬁned noise amplitude
Hz). The phases are randomly drawn from a uniform
spectral density expressed in units of frequency noise (Hz/
distribution [0, 2π). An empirically measured noise trace may also be added in manually. This allows the user
to disentangle the eﬀects of the tracking algorithms from noise, and conversely to investigate the sensitivity of
the tracking and estimation loops to noisy inputs.

√

4.5 Jupyter Notebooks

An introductory notebook outlining the basic functionality of the software and example notebooks reproducing
the results of Sec. 5 are available alongside the main software module. The main dependency is numpy.23
Additional features are enabled by scipy and matplotlib.24, 25

We present several short studies that have been enabled by this simulation suite. Further directions for explo-
ration are discussed in Sec. 6.

5. ONGOING EXAMPLE STUDIES

9

Figure 5. (Left) Diﬀerences in ﬂux ramp-demodulated timestreams for scenarios in which the S21 response has been
shifted by some constant phase delay, but the η calibration has not been updated to reﬂect this delay. The reconstructed
timestreams have an eﬀective noise bias that grows with the size of the angle oﬀset.
(Right) The rms error of the
demodulated timestreams versus oﬀset angle. We see that the amplitude of the noise is non-linear in the angle of oﬀset.

5.1 Eta miscalibration

As the η calibration discussed in Subsec. 3.1 determines the frequency error estimate that is minimized in tone
tracking, the accuracy and stability of this calibration factor is key to the readout scheme. There are several
ways in which the calibration factor may be wrong: it could be misestimated, as is often the case particularly for
very shallow resonances where the ﬂat portion of the resonance circle is very small; the resonator response may
be drifting due to time-varying loss or phase delay without an updated calibration factor; it may be estimated
using an algorithm which fails to capture the point of maximum responsivity, as may be the case for asymmetric
resonances. These various eﬀects are not guaranteed to have the same eﬀect on the ﬂux ramp-demodulated data,
and must be considered separately.

We consider here the impact of a phase delayed resonance whose calibration factor has not been updated.
That is, the resonance circle has been rotated, perhaps due to temperature-induced cable length variation or
other slowly-varying eﬀect, without a compensating update in the calibration parameter. Here we take the
resonance to be perfectly symmetric and noiseless such that the only non-ideality is the rotation of the resonance
circle relative to its initial orientation. The rotation is implemented by adding a constant phase delay to the
entire modulated S21 response; thus, this does not capture time-varying delays.

We see that in this limit of a perfectly symmetric resonance and noiseless modulation, the impact of a
misestimated calibration parameter appears as an eﬀective noise. Note that since the feedback algorithm contains
no randomness, this response is deterministic up to the choice of starting point for the (cid:126)α coeﬃcients. The
pseudonoise has mean zero, suggesting that this eﬀect may produce a noise penalty but no bias on the ﬁnal
science data. It is worth exploring in future studies how these results change for a time-varying delay, as may
be the case for temperature-induced cable changes, or for asymmetric resonances which may see some bias in
addition to the noise penalty.

5.2 Gain

The gain parameter determines the extent to which the tracking algorithm responds to the estimated frequency
error between the probe tone and resonance frequency. If it is too small, the phase estimate may never converge
over the course of a ﬂux ramp cycle, while too large estimates render the tracking loop unstable. In Figure 5.2
we inspect the response to an input sine wave for values of gain spanning several orders of magnitude.

We see that the tracking loop is approximately equivalent for gain values spanning several orders of magnitude.
The small sawtooth-like features are a numerical artifact due to the ﬁnite sampling resolution of the input SQUID
curve, and are not expected to appear in real data.

10

Figure 6. (Left) Flux ramp-demodulated timestreams for an input signal under the assumption of perfect tracking and
an ideal resonator, varying the gain. We see that the diﬀerences from the input signal are small across nearly 10 bits
of precision in the gain setting. (Right) The error between the tracking algorithm reconstruction of the signal and the
input. We see that the errors are sub-percent across a broad range of gains. The cusped nature of the error comes from
the discrete sampling of the SQUID curves in the fake signal construction and is not expected to appear in real data.

5.3 Aliasing

The transient induced by the sawtooth reset on the ﬂux ramp line breaks the quasi-sinusoidal assumption of the
modulated resonance frequency and may cause the feedback loop to become unlocked. To avoid these eﬀects, a
user-deﬁned portion of each ﬂux ramp frame is blanked oﬀ from the tracking loop: the resonance frequency is
held constant and the α coeﬃcients are not updated. In typical operation, we attempt to tune the ﬂux ramp
waveform amplitude and blank-oﬀ such that the region covered by the tracking loop sweeps an integer number
of ﬂux quanta and thus the quasi-sinusoidal assumption holds.

This blank-oﬀ induces an aliasing penalty during the region not covered by the tracking loop, which manifests
as an increase in noise. In Figure 5.3 we generate a white noise timestream and pass it through demodulation
with a simulated SQUID curve. The absolute level of the noise does not strongly impact the simulated behavior
so long as the equivalent ﬂux noise is small compared to a Φ0. We vary the fraction of the SQUID curve that is
tracked and demodulated and compare to the case of no aliasing, when the entire SQUID curve is used. Here,
we assume perfect tracking and a symmetric resonator.

We see that the aliasing penalty is sharper than the na¨ıve (cid:112)1/tracked fraction expectation, possibly due
to the discontinuities that arise from the fractions here not being chosen to maintain an integer number of Φ0
covered by the tracking loop.8 Future studies may examine the impact of this blanking fraction choice as well
as how it may depend on the shape of the SQUID curve.

6. CONCLUSION AND FUTURE DIRECTIONS

We hope and intend for this simulation suite to be a starting point for a wide array of investigations into the eﬀects
of the SMuRF readout electronics. The advanced RF hardware, fast tone updating, high dynamic range, and
large-scale integration support of SMuRF make it an attractive solution for microwave resonator-based readout
applications across a wide range of science goals. The SMuRF system’s unique tone-tracking ability further
enables high channel count applications and dramatically simpliﬁes oﬄine analysis for frequency estimation. In
the case of µmux, tone tracking additionally simpliﬁes ﬂux ramp demodulation.

11

Figure 7. (Left) Noise spectral densities for the same noisy timestream passed to the demodulation loop, but with varying
fractions of each ﬂux ramp frame tracked. Blanking oﬀ the ﬂux ramp frame allows for transients due to the ﬂux ramp
sawtooth reset frames to be ignored by the tracking loop, maintaining a quasi-sinusoidal response. (Right) The ratio of
Hz) to the case of perfect tracking the full waveform.
the white noise levels (in amplitude spectral density units of Hz/

√

However, the eﬀects of these algorithms may have subtle impacts on the inferred detector data that may
include a noise penalty or systematic biases. The results of these simulations may be used to constrain design
speciﬁcations for hardware, prepare systematic mitigation analyses, or design new algorithms as the applications
dictate. Below we suggest several questions that may be answered by the existing software suite:

• Is the tracking linear for all inputs? For what gain settings does this linearity hold? More generally, under

what conditions is the demodulated output an unbiased estimate of the detector input signal?

• Are there better estimators for the resonance frequency or frequency error, particularly for asymmetric

resonators?

• Does the non-linearity of the ﬂux ramp waveform due to DAC eﬀects bias the demodulation?

• How do the assumptions for frequency error estimation and tone-tracking need to change in the case of

KID-like devices, where the size of the resonance circle may be changing with input power?

• Can the signal-to-noise ratio be improved by tracking more harmonics?

Furthermore, extensions to the software suite are welcomed and would enable analyses of other aspects of
the readout, with an ultimate goal of providing an end-to-end simulation of the eﬀects of the warm readout
electronics. Avenues for further development include:

• Incorporation of resonator and SQUID physics eﬀects, such that the modulation of tone power on the

resonator input can be modeled.

• Integration with existing pysmurf† tools for data-taking and analysis.

• Multi-channel eﬀects, including but not limited to: colliding resonators and crosstalk.

• Channelization eﬀects and the polyphase ﬁlter bank, such that the ﬁnite spectral width of the probe tones

can be modeled with the resonator transfer function.

The software repository will be maintained by the authors, with contributions highly welcomed. Questions

about use and startup may be directed to the corresponding author.

†https://github.com/slaclab/pysmurf

12

ACKNOWLEDGMENTS

CY was supported in part by the National Science Foundation Graduate Research Fellowship Program under
Grant No. 1656518. MSF was supported in part by the Department of Energy Oﬃce of Science Graduate Student
Research (SCGSR) Program. The SCGSR program is administered by the Oak Ridge Institute for Science and
Education (ORISE) for the DOE, which is managed by ORAU under contract number DE-SC0014664. This
work was supported in part by the Department of Energy at SLAC National Accelerator Laboratory under
contract DE-AC02-76SF00515.

REFERENCES

[1] Irwin, K. and Hilton, G., [Transition-Edge Sensors], 63–150, Springer Berlin Heidelberg, Berlin, Heidelberg

(2005).

[2] Enss, C., ed., [Cryogenic Particle Detection ], Springer (2005).
[3] Irwin, K. and Lehnert, K., “The microwave squid multiplexer,” Appl. Phys. Lett. 85, 2107 (2004).
[4] Mates, J., Hilton, G., Irwin, K., Vale, L., and Lehnert, K., “Demonstration of a multiplexer of dissipationless

superconduting quantum interference devices,” Appl. Phys. Lett. 92, 023514 (2008).

[5] Cukierman, A., Ahmed, Z., Henderson, S., Young, E., Yu, C., Barkats, D., Brown, D., Chaudhuri, S.,
Cornelison, J., D’Ewart, J. M., Dierickx, M., Dober, B. J., Dusatko, J., Fatigoni, S., Filippini, J. P., Frisch,
J. C., Haller, G., Halpern, M., Hilton, G. C., Hubmayr, J., Irwin, K. D., Karkare, K. S., Karpel, E.,
Kernasovskiy, S. A., Kovac, J. M., Kovacs, A., Kuenstner, S. E., Kuo, C. L., Li, D., Mates, J. A. B., Smith,
S., Germaine, T. S., Ullom, J. N., Vale, L. R., Winkle, D. D. V., Vasquez, J., Willmert, J., Zeng, L., Ade, P.
A. R., Amiri, M., Thakur, R. B., Bischoﬀ, C. A., Bock, J. J., Boenish, H., Bullock, E., Buza, V., Cheshire,
J., Connors, J., Crumrine, M., Duband, L., Hall, G., Harrison, S., Hildebrandt, S. R., Hui, H., Kang, J.,
Kefeli, S., Lau, K., Megerian, K. G., Moncelsi, L., Namikawa, T., Nguyen, H. T., O’Brient, R., Palladino,
S., Pryke, C., Racine, B., Reintsema, C. D., Richter, S., Schillaci, A., Schwarz, R., Sheehy, C. D., Soliman,
A., Steinbach, B., Sudiwala, R. V., Thompson, K. L., Tucker, C., Turner, A. D., Umilt`a, C., Vieregg, A. G.,
Wandui, A., Weber, A. C., Wiebe, D. V., Wu, W. L. K., Yang, H., Yoon, K. W., and Zhang, C., “Microwave
multiplexing on the keck array,” J. Low Temp. Phys. 199, 858–866 (2020).

[6] McCarrick, H., Healy, E., Ahmed, Z., Arnold, K., Atkins, Z., Austermann, J. E., Bhandarkar, T., Beall,
J. A., Bruno, S. M., Choi, S. K., Connors, J., Cothard, N. F., Crowley, K. D., Dicker, S., Dober, B., Duell,
C. J., Duﬀ, S. M., Dutcher, D., Frisch, J. C., Galitzki, N., Gralla, M. B., Gudmundsson, J. E., Henderson,
S. W., Hilton, G. C., Ho, S.-P. P., Huber, Z. B., Hubmayr, J., Iuliano, J., Johnson, B. R., Kofman, A. M.,
Kusaka, A., Lashner, J., Lee, A. T., Li, Y., Link, M. J., Lucas, T. J., Lungu, M., Mates, J. A. B., McMahon,
J. J., Niemack, M. D., Orlowski-Scherer, J., Seibert, J., Silva-Feaver, M., Simon, S. M., Staggs, S., Suzuki,
A., Terasaki, T., Ullom, J. N., Vavagiakis, E. M., Vale, L. R., Lanen, J. V., Vissers, M. R., Wang, Y.,
Wollack, E. J., Xu, Z., Young, E., Yu, C., Zheng, K., Zhu, N., and Thornton, R., “The simons observatory
microwave SQUID multiplexing detector module design,” The Astrophysical Journal 922, 38 (nov 2021).
[7] Zmuidzinas, J., “Superconducting microresonators: Physics and applications,” Annual Review of Condensed

Matter Physics 3(1), 169–214 (2012).

[8] Mates, J. A. B., Irwin, K. D., Vale, L. R., Hilton, G. C., Gao, J., and Lehnert, K. W., “Flux-Ramp
Modulation for SQUID Multiplexing,” Journal of Low Temperature Physics 167, 707–712 (June 2012).
[9] Mates, J. A. B., The Microwave SQUID Multiplexer, Ph.D. thesis, University of Colorado at Boulder,

https://www.proquest.com/docview/868186018 (December 2011).

[10] Stanchﬁeld, S., Ade, P., Aguirre, J., Brevik, J., Cho, H.-m., Datta, R., Devlin, M., Dicker, S., Dober, B.,
Egan, D., Ford, P., Hilton, G., Hubmayr, J., Irwin, K., Marganian, P., Mason, B., Mates, J., McMahon,
J., Mello, M., and Young, A., “Development of a microwave squid-multiplexed tes array for mustang-2,”
Journal of Low Temperature Physics 184 (07 2016).

[11] Galitzki, N., Ali, A., Arnold, K. S., Ashton, P. C., Austermann, J. E., Baccigalupi, C., Baildon, T., Barron,
D., Beall, J. A., Beckman, S., Bruno, S. M. M., Bryan, S., Calisse, P. G., Chesmore, G. E., Chinone, Y.,
Choi, S. K., Coppi, G., Crowley, K. D., Crowley, K. T., Cukierman, A., Devlin, M. J., Dicker, S., Dober,
B., Duﬀ, S. M., Dunkley, J., Fabbian, G., Gallardo, P. A., Gerbino, M., Goeckner-Wald, N., Golec, J. E.,
Gudmundsson, J. E., Healy, E. E., Henderson, S., Hill, C. A., Hilton, G. C., Ho, S.-P. P., Howe, L. A.,

13

Hubmayr, J., Jeong, O., Keating, B., Koopman, B. J., Kiuchi, K., Kusaka, A., Lashner, J., Lee, A. T., Li,
Y., Limon, M., Lungu, M., Matsuda, F., Mauskopf, P. D., May, A. J., McCallum, N., McMahon, J., Nati,
F., Niemack, M. D., Orlowski-Scherer, J. L., Parshley, S. C., Piccirillo, L., Rao, M. S., Raum, C., Salatino,
M., Seibert, J. S., Sierra, C., Silva-Feaver, M., Simon, S. M., Staggs, S. T., Stevens, J. R., Suzuki, A., Teply,
G., Thornton, R., Tsai, C., Ullom, J. N., Vavagiakis, E. M., Vissers, M. R., Westbrook, B., Wollack, E. J.,
Xu, Z., and Zhu, N., “The Simons Observatory: instrument overview,” in [Millimeter, Submillimeter, and
Far-Infrared Detectors and Instrumentation for Astronomy IX ], Zmuidzinas, J. and Gao, J.-R., eds., 10708,
1 – 13, International Society for Optics and Photonics, SPIE (2018).

[12] Salatino, M., Austermann, J., Thompson, K. L., Ade, P. A. R., Bai, X., Beall, J. A., Becker, D. T., Cai, Y.,
Chang, Z., Chen, D., Connors, J., Chen, P., Dober, B., Delabrouille, J., Duﬀ, S. M., Gao, G., Givhan, R. C.,
Ghosh, S., Hilton, G., Hu, B., Hubmayr, J., Karpel, E., Kuo, C.-L., Li, H., Li, M., Li, S.-Y., Li, X., Link,
M., Li, Y., Liu, H., Liu, L., Liu, Y., Lu, F., Lucas, T., Lu, X., Mates, J. A. B., Mathewson, J., Mauskopf,
P., Meinke, J., Montana-Lopez, J., Shi, J., Sinclair, A. K., Stephenson, R., Sun, W., Tseng, Y., Tucker,
C., Ullom, J., Vale, L., van Lanen, J., Vissers, M., Walker, S., Wang, B., Wang, G., Wang, J., Weeks, E.,
Wu, D., Wu, Y.-H., Xia, J., Xu, H., Yao, J., Yao, Y., Yoon, K. W., Yue, B., Zhai, H., Zhang, A., Zhang,
L., Zhang, L., Zhang, P., Zhang, T., Zhang, X., Zhang, Y., Zhang, Y., Zhao, G.-B., and Zhao, W., “The
design of the Ali CMB Polarization Telescope receiver,” in [Millimeter, Submillimeter, and Far-Infrared
Detectors and Instrumentation for Astronomy X ], Zmuidzinas, J. and Gao, J.-R., eds., 11453, 341 – 360,
International Society for Optics and Photonics, SPIE (2020).

[13] Bennett, D. A., Mates, J. A. B., Bandler, S. R., Becker, D. T., Fowler, J. W., Gard, J. D., Hilton, G. C.,
Irwin, K. D., Morgan, K. M., Reintsema, C. D., Sakai, K., Schmidt, D. R., Smith, S. J., Swetz, D. S., Ullom,
J. N., Vale, L. R., and Wessels, A. L., “Microwave SQUID multiplexing for the Lynx x-ray microcalorimeter,”
Journal of Astronomical Telescopes, Instruments, and Systems 5(2), 1 – 10 (2019).

[14] Nagler, P. C., Sadleir, J. E., and Wollack, E. J., “Transition-edge sensor detectors for the Origins Space

Telescope,” Journal of Astronomical Telescopes, Instruments, and Systems 7(1), 1 – 18 (2021).

[15] Mates, J. A. B., Becker, D. T., Bennett, D. A., Dober, B. J., Gard, J. D., Hays-Wehle, J. P., Fowler, J. W.,
Hilton, G. C., Reintsema, C. D., Schmidt, D. R., Swetz, D. S., Vale, L. R., and Ullom, J. N., “Simultaneous
readout of 128 x-ray and gamma-ray transition-edge microcalorimeters using microwave squid multiplexing,”
Appl. Phys. Lett. 111(6), 062601 (2017).

[16] Henderson, S. W., Ahmed, Z., Austermann, J., Becker, D., Bennett, D. A., Brown, D., Chaudhuri, S., Cho,
H.-M. S., D’Ewart, J. M., Dober, B., Duﬀ, S. M., Dusatko, J. E., Fatigoni, S., Frisch, J. C., Gard, J. D.,
Halpern, M., Hilton, G. C., Hubmayr, J., Irwin, K. D., Karpel, E. D., Kernasovskiy, S. S., Kuenstner, S. E.,
Kuo, C.-L., Li, D., Mates, J. A. B., Reintsema, C. D., Smith, S. R., Ullom, J., Vale, L. R., Winkle, D. D. V.,
Vissers, M., and Yu, C., “Highly-multiplexed microwave SQUID readout using the SLAC Microresonator
Radio Frequency (SMuRF) electronics for future CMB and sub-millimeter surveys,” in [Millimeter, Sub-
millimeter, and Far-Infrared Detectors and Instrumentation for Astronomy IX], Zmuidzinas, J. and Gao,
J.-R., eds., 10708, 170 – 185, International Society for Optics and Photonics, SPIE (2018).

[17] Yu, C., Ahmed, Z., Frisch, J. C., Henderson, S. W., Silva-Feaver, M., Arnold, K., Brown, D., Connors,
J., Cukierman, A. J., D’Ewart, J. M., Dober, B. J., Dusatko, J. E., Haller, G., Herbst, R., Hilton, G. C.,
Hubmayr, J., Irwin, K. D., Kuo, C.-L., Mates, J. A., Ruckman, L., Ullom, J., Vale, L., Winkle, D. D. V.,
Vasquez, J., and Young, E., “Slac microresonator rf (smurf) electronics: A tone-tracking readout system for
superconducting microwave resonator arrays,”

[18] Silva-Feaver, M., Ahmed, Z., Arnold, K., Frisch, J. C., Groh, J., Henderson, S. W., Vasquez, J., and
Yu, C., “Phase Feedback for Tone Tracking Readout of Superconducting Microwave Resonators,” in [this
proceedings ], Zmuidzinas, J. and Gao, J.-R., eds., International Society for Optics and Photonics, SPIE.
[19] Yu, C., Ahmed, Z., Connors, J. A., D’Ewart, J. M., Dober, B., Frisch, J. C., Henderson, S. W., Hilton,
G. C., Hubmayr, J., Kuenstner, S. E., Mates, J. A. B., Silva-Feaver, M., Ullom, J. N., Vale, L. R., Winkle,
D. V., and Young, E., “Bandwidth and Aliasing in the Microwave SQUID Multiplexer,” Journal of Low
Temperature Physics , LTD2021 (2021).

[20] Khalil, M. S., Stoutimore, M. J. A., Wellstood, F. C., and Osborn, K. D., “An analysis method for asym-
metric resonator transmission applied to superconducting devices,” Journal of Applied Physics 111, 054510
(2012).

14

[21] Dober, B., Ahmed, Z., Arnold, K., Becker, D. T., Bennett, D. A., Connors, J. A., Cukierman, A., D’Ewart,
J. M., Duﬀ, S. M., Dusatko, J. E., Frisch, J. C., Gard, J. D., Henderson, S. W., Herbst, R., Hilton, G. C.,
Hubmayr, J., Li, Y., Mates, J. A. B., McCarrick, H., Reintsema, C. D., Silva-Feaver, M., Ruckman, L.,
Ullom, J. N., Vale, L. R., Van Winkle, D. D., Vasquez, J., Wang, Y., Young, E., Yu, C., and Zheng, K., “A
microwave squid multiplexer optimized for bolometric applications,” Applied Physics Letters 118(6), 062601
(2021).

[22] Wegner, M., Enss, C., and Kempf, S., “Analytical model of the readout power and squid hysteresis parameter
dependence of the resonator characteristics of microwave squid multiplexers,” Superconductor Science and
Technology 35, 075011 (2022).

[23] Harris, C. R., Millman, K. J., van der Walt, S. J., Gommers, R., Virtanen, P., Cournapeau, D., Wieser,
E., Taylor, J., Berg, S., Smith, N. J., Kern, R., Picus, M., Hoyer, S., van Kerkwijk, M. H., Brett, M.,
Haldane, A., Fern´andez del R´ıo, J., Wiebe, M., Peterson, P., G´erard-Marchant, P., Sheppard, K., Reddy,
T., Weckesser, W., Abbasi, H., Gohlke, C., and Oliphant, T. E., “Array programming with NumPy,”
Nature 585, 357–362 (2020).

[24] Virtanen, P., Gommers, R., Oliphant, T. E., Haberland, M., Reddy, T., Cournapeau, D., Burovski, E.,
Peterson, P., Weckesser, W., Bright, J., van der Walt, S. J., Brett, M., Wilson, J., Millman, K. J., Mayorov,
N., Nelson, A. R. J., Jones, E., Kern, R., Larson, E., Carey, C. J., Polat, ˙I., Feng, Y., Moore, E. W.,
VanderPlas, J., Laxalde, D., Perktold, J., Cimrman, R., Henriksen, I., Quintero, E. A., Harris, C. R.,
Archibald, A. M., Ribeiro, A. H., Pedregosa, F., van Mulbregt, P., and SciPy 1.0 Contributors, “SciPy 1.0:
Fundamental Algorithms for Scientiﬁc Computing in Python,” Nature Methods 17, 261–272 (2020).

[25] Hunter, J. D., “Matplotlib: A 2d graphics environment,” Computing In Science & Engineering 9(3), 90–95

(2007).

15

