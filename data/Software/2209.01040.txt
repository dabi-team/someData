Astronomy & Astrophysics manuscript no. topz
September 5, 2022

©ESO 2022

TOPz: Photometric redshifts for J-PAS

J. Laur1, E. Tempel1, 2, A. Tamm1, R. Kipper1, L. J. Liivamägi1, A. Hernán-Caballero3, M. M. Muru1, J.
Chaves-Montero4, L. A. Díaz-García5, S. Turner1, T. Tuvikene1, C. Queiroz6, C. R. Bom7, 8, J. A.
Fernández-Ontiveros3, R. M. González Delgado5, T. Civera3, R. Abramo9, J. Alcaniz10, N. Benitez5, S. Bonoli3, 4, S.
Carneiro11, J. Cenarro12, D. Cristóbal-Hornillos12, R. Dupke10, A. Ederoclite3, C. López-Sanjuan12, A. Marín-Franch3,
C. M. de Oliveira9, M. Moles3, L. Sodré Jr.9, K. Taylor13, J. Varela12, and H. V. Ramió12

1 Tartu Observatory, University of Tartu, Observatooriumi 1, 61602 Tõravere, Estonia

e-mail: jaan.laur@ut.ee

2 Estonian Academy of Sciences, Kohtu 6, 10130 Tallinn, Estonia
3 Centro de Estudios de Física del Cosmos de Aragón (CEFCA), Plaza San Juan, 1, E-44001 Teruel, Spain
4 Donostia International Physics Center, Paseo Manuel de Lardizábal 4, E-20018 Donostia-San Sebastián, Spain
5 Instituto de Astrofísica de Andalucía (CSIC), P.O. Box 3004, 18080 Granada, Spain
6 Departamento de Astronomia, Instituto de Física, Universidade Federal do Rio Grande do Sul (UFRGS), Av. Bento Gonçalves,

9500, Porto Alegre, RS, Brazil

7 Centro Brasileiro de Pesquisas Físicas, Rua Dr. Xavier Sigaud 150, CEP 22290-180, Rio de Janeiro, RJ, Brazil
8 Centro Federal de Educação Tecnológica Celso Suckow da Fonseca, Rodovia Mário Covas, lote J2, quadra J, CEP 23810-000,

Itaguaí, RJ, Brazil

9 Instituto de Física, Universidade de Sãoo Paulo, Rua do Matãoo 1371, 05508-090 Sãoo Paulo, Brazil
10 Observatório Nacional, Ministério da Ciencia, Tecnologia, Inovação e Comunicações, Rua General José Cristino, 77, São

Cristóvão, 20921-400, Rio de Janeiro, Brazil

11 Instituto de Física, Universidade Federal da Bahia, 40210-340, Salvador, BA, Brazil
12 Centro de Estudios de de Física del Cosmos de Aragón (CEFCA), Unidad Asociada al CSIC, Plaza San Juan, 1, 44001 Teruel,

Spain

13 Instruments4, 4121 Pembury Place, La Canada Flintridge, CA 91011, U.S.A.

September 5, 2022

ABSTRACT

Context. The importance of photometric galaxy redshift estimation is rapidly increasing with the development of specialised powerful
observational facilities.
Aims. We develop a new photometric redshift estimation workﬂow TOPz to provide reliable and eﬃcient redshift estimations for the
upcoming large-scale survey J-PAS which will observe 8500 deg2 of the northern sky through 54 narrow-band ﬁlters.
Methods. TOPz relies on template-based photo-z estimation with some added J-PAS speciﬁc features and possibilities. We present
TOPz performance on data from the miniJPAS survey, a precursor to the J-PAS survey with an identical ﬁlter system. First, we
generated spectral templates based on the miniJPAS sources using the synthetic galaxy spectrum generation software CIGALE. Then
we applied corrections to the input photometry by minimising systematic oﬀsets from the template ﬂux in each ﬁlter. To assess the
accuracy of the redshift estimation, we used spectroscopic redshifts from the DEEP2, DEEP3, and SDSS surveys, available for 1989
miniJPAS galaxies with r < 22 magAB. We also tested how the choice and number of input templates, photo-z priors, and photometric
corrections aﬀect the TOPz redshift accuracy.
Results. The general performance of the combination of miniJPAS data and the TOPz workﬂow fulﬁlls the expectations for J-PAS
redshift accuracy. Similarly to previous estimates, we ﬁnd that 38.6% of galaxies with r < 22 mag reach the J-PAS redshift accuracy
goal of dz/(1 + z) < 0.003. Limiting the number of spectra in the template set improves the redshift accuracy up to 5%, especially for
fainter, noise-dominated sources. Further improvements will be possible once the actual J-PAS data become available.

Key words. Galaxies: distances and redshifts – Techniques: photometric – Methods: observational

2
2
0
2

p
e
S
2

]

M

I
.
h
p
-
o
r
t
s
a
[

1
v
0
4
0
1
0
.
9
0
2
2
:
v
i
X
r
a

1. Introduction

Photometric galaxy redshift surveys provide a viable alternative
and a complement to spectroscopic surveys for acquiring a 3D
map of the Universe and they play an important role in studies
of galaxy evolution, galaxy clusters, stellar populations, and star
formation rates. While the precision of a photometrically esti-
mated redshift (photo-z) typically lags behind that of a spectro-
scopically determined one, the considerable gain in speed and
the lack of source selection eﬀects favour photo-z surveys for
cosmological applications where large, deep, and unbiased data

sets are desired. Due to these observational advantages, photo-zs
will be the most viable solution for redshift estimations in the
imminent big data era of galaxy and cosmological surveys. Re-
cent years have brought along a multitude of new observational
initiatives and instrumentation for obtaining multi-band photom-
etry of large parts of the sky: ALHAMBRA (Moles et al. 2008),
PAU (Benítez et al. 2009), J-PAS (Benitez et al. 2014), HSC-
SSP (Aihara et al. 2018), J-PLUS (Cenarro et al. 2019), S-PLUS
(Mendes de Oliveira et al. 2019; Almeida-Fernandes et al. 2022),
and KiDS (Hildebrandt et al. 2020).

Article number, page 1 of 20

 
 
 
 
 
 
A&A proofs: manuscript no. topz

While the derivation of redshifts from spectroscopic data is
relatively straightforward, the situation is quite diﬀerent for pho-
tometric redshifts (photo-z), where spectral features may easily
remain undetected, unresolved, or misidentiﬁed. Recent years
have seen a big leap forward in overcoming these obstacles and a
large variety of photo-z estimation methods and algorithms have
been developed; we refer readers to Salvato et al. (2019) for a
recent overview.

Most broadly, photo-z methods can be split between those
based on machine-learning (e.g. Carrasco Kind & Brunner 2013,
2014; Hogan et al. 2015; Sadeh et al. 2016; Gomes et al. 2018;
Graham et al. 2018) and those based on spectral templates (e.g.
Brammer et al. 2008; Molino et al. 2014; Beck et al. 2017;
Benítez 2000; Ansari et al. 2021). Performance-wise, no clear
winner has yet emerged, mostly due to various assumptions un-
derlying each estimation approach (Schmidt et al. 2020).

Theoretically, machine-learning algorithms are capable of
using all the information available in the data and should thus
yield maximal possible accuracy. In addition, machine-learning
algorithms tend to be faster than template-based ones. However,
their performance generally depends on the size and quality of
the training set, which becomes problematic at higher redshifts,
where an unbiased comprehensive observational data set is hard
to obtain; thus machine-learning algorithms are generally out-
performed by template-based methods in this regime (Hilde-
brandt et al. 2010). In addition, template-based methods have
another advantage in that they may simultaneously be used to
derive a range of physical properties of galaxies via spectral en-
ergy distribution (SED) ﬁtting (Walcher et al. 2011; Díaz-García
et al. 2015; Battisti et al. 2019; Díaz-García et al. 2019; González
Delgado et al. 2021).

Most typically, photo-z methods have been applied to broad-
band ﬁlter data (Ilbert et al. 2006; Tanaka et al. 2018; Lee &
Chary 2020, and many others). In such cases, redshifts are pri-
marily derived from large-scale features such as the 4000 Å,
Balmer, or Lyman breaks if they are present in between the ﬁl-
ter passband ranges. Thereby, a redshift accuracy of up to dz
≈ 0.03(1 + z) has been achieved. Using narrow-band ﬁlters, this
limit can be considerably extended by a more precise localisation
of the continuum breaks as well as by the possibility of detect-
ing individual spectral lines: JPLUS/SPLUS (Izquierdo-Villalba
et al. 2019), miniJPAS (Bonoli et al. 2021), and PAU (Eriksen
et al. 2020; Rodriguez et al. 2020).

In essence, the template-based photo-z methods share the
general working principle of measuring the χ2 deviation be-
tween the observed SED and each template on a redshift grid
for a given source. However, in practical applications, the per-
formance may be strongly inﬂuenced by the library of the spec-
tral templates (Greisel et al. 2015; Wright et al. 2020), the ap-
plied redshift prior (in the case of Bayesian methods, see Benítez
2000; Molino et al. 2014; Tanaka 2015), or the method by which
the best redshift estimate is extracted. In particular, to make the
most of narrow-band ﬁlter observations of high redshift sources,
the spectral templates should also cover the UV part of the spec-
trum. These aspects favour synthetic spectra over observational
ones when it comes to templates.

We present a new template-based photometric redshift work-
ﬂow TOPz (Tartu Observatory photo-z), which was purpose-
built for the J-PAS survey, but easily applicable to any other
galaxy photometry data set. The main goal is to include improve-
ments to photo-z estimation that are speciﬁc to J-PAS observa-
tions along with a cluster-ready implementation to speedily han-
dle the expected amount of data. We provide an overview of the
method, a recipe for generating a suitable set of template spec-

Article number, page 2 of 20

tra, and the results of an application on the current miniJPAS
data set.

The outline of the paper is as follows. In Sect. 2 we give
a brief overview of the Bayesian photometric redshift estima-
tion method and in Sect. 3 an overview of our photo-z workﬂow
TOPz. In Sect. 4 we describe the miniJPAS data. The construc-
tion of the templates, photometric corrections, and photo-z pri-
ors are described in Sect. 5. The impact of the aforementioned
inputs along with the results are given in Sect. 6 and a discussion
follows in Sect. 7.

2. Bayesian photometric redshift estimation

2.1. General overview

In a Bayesian framework, the problem of photo-z estimation can
be posed as ﬁnding the probability of a galaxy having redshift z
given the observational data and some prior information (Benítez
2000). The probability can be expressed as

p(z | D, I),

(1)

where D = {F, m0} describes the observed SED that is given by
relative ﬂuxes F at diﬀerent wavelengths and total magnitude m0
in a reference passband. The latter also sets the absolute scale for
the SED. The term I includes the prior information not already
contained in D. To simplify the mathematical notation, we drop
the term I below.

Expression (1) gives the probability assuming that a galaxy
has a known spectral type. The measured SED F of a galaxy can
be approximated with a variety of diﬀerent spectral types, rep-
resented by a set of spectral templates T. A given galaxy cannot
belong to two spectral types at the same time, thus the probabil-
ity in expression (1) can be expanded as p(z, T | D), that is the
probability of the galaxy redshift being z while the galaxy has a
type T . This can in turn expanded as

p(z, T | D) = p(z, T | F, m0) ∝ p(z, T | m0)p(F | z, T ),

(2)

where in the second step we applied the Bayes’ theorem. The last
expression p(F | z, T ) gives the probability that the measured rel-
ative ﬂuxes F correspond to the template T at redshift z. We as-
sume that the probability does not depend on the magnitude m0.
The prior p(z, T | m0) can be further developed using the product
rule

p(z, T | m0) = p(T | m0)p(z | T, m0),

(3)

where p(T | m0) is the general, independently known galaxy type
fraction as a function of galaxy magnitude and p(z | T, m0) is the
general redshift distribution of galaxies with spectral template T
and magnitude m0.

The template-dependent redshift posterior for a given galaxy
with total magnitude m0 and observed ﬂuxes F is deﬁned in
Eq. (2). The calculation of p(z, T | F, m0) assumes that we know
how to calculate the redshift likelihood p(F | z, T ) and how to es-
timate the prior p(z, T | m0). The former is explained in Sect. 2.2,
the latter is discussed in Sect. 5.4. To ﬁnd the redshift posterior,
we can marginalise over the template set T

p(z | F, m0) =

(cid:88)

T ∈T

p(z, T | F, m0).

(4)

J. Laur et al.: TOPz: Photometric redshifts for J-PAS

2.2. Estimating the redshift likelihood

Following Benítez (2000) the redshift likelihood of a galaxy
p(F | z, T ) can be written as

p(F | z, T ) ∝

(cid:112)

FTT exp

(cid:34)
−

χ2(z, T, a)
2

(cid:35)

,

(5)

where normalisation factor FTT (see Eq. (11)) comes from the in-
tegration over nuisance parameter a. The χ2 deﬁnes the quantity
to be minimised and is deﬁned as
(cid:16)

(cid:17)2

,

(6)

χ2(z, T, a) =

Nﬁlt(cid:88)

j=1

F j − aFT, j
σ2
F j

where summation is over all observed passbands for a given
galaxy. F j and σF j are the observed galaxy ﬂux and its standard
deviation through passband j while FT, j is the synthetic ﬂux of
a redshifted template T through passband j.

Equation (6) can be rewritten as

χ2(z, T, a) = FOO −

F2
OT
FTT

+ (a − am)2FTT,

where
am = FOT
FTT

(7)

(8)

is the value of nuisance parameter a that minimises Eq. (6) and
Eq. (7). The notations FOO, FOT, and FTT are deﬁned as

FOO =

FOT =

FTT =

Nﬁlt(cid:88)

j=1
Nﬁlt(cid:88)

j=1
Nﬁlt(cid:88)

j=1

F2
j
σ2
F j

,

F jFT, j
σ2
F j

,

F2
T, j
σ2
F j

.

(9)

(10)

(11)

For a given galaxy with observed ﬂuxes F j, we calculate the
likelihood (deﬁned in Eq. (5)) that the observational data corre-
spond to a given template T at a given redshift z. For practical
reasons, the redshift is mapped onto a user-deﬁned grid and the
template set T contains a limited number of templates.

3. TOPz

3.1. Overview

The basic workﬂow of TOPz along with references to the corre-
sponding sections in this paper can be seen in Fig. 1. TOPz fol-
lows the Bayesian approach described in Sect. 2 by evaluating
the likelihood of a galaxy lying at certain redshifts. The likeli-
hood is calculated based on a preselected set of templates that
best describe the spectral types of observed galaxies in a given
data set. Synthetic photometry can be calculated by combining
the observed optical system transmission curve (passband) with
the spectral templates. This transmission curve usually incor-
porates the CCD quantum eﬃciency, ﬁlter transmission, atmo-
spheric transmission, and the optics of a particular telescope.
For each galaxy, the templates are redshifted along a grid and
the corresponding χ2 values (Eq. (6)) are used to ﬁnd the red-
shift likelihood p(F | z, T ). This likelihood can be further reﬁned

Fig. 1. Flowchart describing the basic functionality of a template based
photo-z code. The section numbers below each element refer to the out-
line of this paper. The dashed boxes indicate optional inputs.

by introducing a prior, for example on the basis of previously
determined redshift distribution of galaxies. From the likelihood
distribution, diﬀerent estimations for the ‘best’ redshift can be
inferred as described in Sect. 3.2.

In order to run TOPz for the redshift estimations, there are
multiple required inputs (see Fig. 1). First input is a catalogue
containing the ﬂuxes of the observed galaxies in each passband
along with the corresponding uncertainties (see Sect. 4). TOPz
does not require all the passbands for each galaxy to be present
as speciﬁc passbands can be ﬂagged and thus ignored in the ﬁt-
ting process. Second inputs are the eﬀective transmission curves
for every ﬁlter used in the observations, ideally combining the
ﬁlter transmission, CCD quantum eﬃciency, eﬀects from tele-
scope optics and atmospheric transmission. Third input it the set
of spectral templates (see Sect. 5).

As an optional input, a set of photometric corrections can
be provided to be applied to the input catalogue (see Sect. 5.3).
This is introduced to correct systematic errors in the observa-
tions. Photometric corrections can be given separately for each
galaxy or as a single value for the whole data set. Systematic
uncertainties for each ﬁlter can also be adjusted in this phase.
Another optional inputs are the priors for modifying the redshift
likelihood depending on the brightness and type of the observed
galaxy (see Sect. 5.4). Separate priors can be used for each spec-
tral template or groups of templates.

TOPz follows the general Bayesian likelihood calculation
workﬂow of the BPZ code1 while also using the same priors
deﬁned in Benítez (2000). However, TOPz diﬀers by its ability
to generate and prioritise templates based on the observed pho-
tometry, allowing to reach a better correspondence between the
template set and the actual occurrence statistics and photometry
of the sources. In addition, these templates can also be used to
calibrate the observed photometry and thereby further improve
the resultant photo-z accuracy.

One of the unique features of TOPz is a J-PAS speciﬁc option
to consider multiple passbands per ﬁlter. This option enables to
take into account the dependency of ﬁlter transmission curves on
the incident angle of the light, arising in the J-PAS optical system
due to large ﬁeld of view (Benitez et al. 2014). When looking at
an observation through a single ﬁlter in J-PAS, each galaxy will
have a diﬀerent passband that will be constructed based on the

1 https://www.stsci.edu/ dcoe/BPZ/

Article number, page 3 of 20

Templates(Sect. 5.1 & 5.2)Redshiftlikelihood(Sect. 2)Photometriccorrections(Sect. 5.3)Observedphotometry(Sect. 4)Photo-zposterior(Sect. 2)Filter passbands(Appendix A)Priors(Sect. 5.4)Photo-zestimates(Sect. 3.2)A&A proofs: manuscript no. topz

galaxy’s position on the frame as well as on the information how
that speciﬁc tile has been observed. For a more in-depth analysis
on the impact of this eﬀect see Appendix A.

TOPz is mainly written in Fortran language and has been
developed keeping in mind the forthcoming J-PAS data set, ex-
pected to contain SED measurements for around 107 galaxies
which is ∼ 17500 galaxies per deg2 (Hernán-Caballero et al.
2021). Therefore, the code is built with parallel computing ca-
pabilities and designed to run on a computer cluster. We evalu-
ated that, using 100 spectral templates on a 30-core machine, it
would take around three minutes to calculate photo-z estimates
for 1 deg2 and around 30 hours to estimate them for the whole
catalogue of 107 galaxies.

3.2. Outputs

The general idea of Bayesian photo-z codes is to calculate the
redshift likelihood of a galaxy and estimate the ‘best guess’
redshift from the respective probability density function (PDF).
This is illustrated in Fig. 2 using an example of an actual galaxy
from the miniJPAS survey. Typically, the redshift value corre-
sponding to the highest PDF value is given as the ‘best guess’
photometric redshift of the galaxy (designated z_ml1d in TOPz).
Another possibility is to ﬁnd the redshift with the highest likeli-
hood value among all the given templates (z_ml2d in TOPz).

Depending on the observational uncertainties and the spec-
tral characteristics of the galaxy, the PDF shapes can vary dra-
matically. Therefore, depending on the goal and on the actual
data, other kinds of ‘best’ redshift estimators can be used, for
example taking into account the area under the likelihood curve
up to some distance from the peak. Currently, two of such ad-
ditional estimators have been implemented in TOPz, described
below.

z_w1d is the weighted average of the PDF around the initial
likelihood maximum. It is obtained by recognising the highest
PDF value and then tracing the PDF peak in both directions until
the ﬁrst minimum below a user-deﬁned threshold. The weighted
average is then calculated over the traced part of the PDF. This
redshift estimate performs best in situations where the peak of
the PDF is not at the centre of a broader elevation as, instead of
the peak location, the whole immediate area around the peak is
taken into account. Similarly, z_w2d is calculated using the red-
shift of the lowest χ2 value as the starting point and ﬁnding the
weighted average over the traced part of the PDF. In this paper,
we have mostly used the z_w1d estimation as it was the best per-
forming estimator on our test catalogue (see Sect. 6.3). A more
thorough assessment of the performance of diﬀerent ‘best’ red-
shift estimators with diﬀerent input data and in diﬀerent redshift
regimes has to wait for a larger data set from the upcoming J-
PAS full survey.

For each photometric redshift value, we also give an ‘odds’
estimate which is the relative area of the PDF within a user-
deﬁned ﬁxed range centred on the estimated redshift value. Odds
value close to one means that the PDF is narrowly condensed
around the highest PDF value whereas a low odds value means
that the PDF is broad and the estimated redshift is of a lower
probability.

In addition to the speciﬁc ‘best’ redshift estimates, the full
redshift PDF can be extracted as the output. In statistical anal-
yses, the full posterior PDF (Eq. 4) gives a more adequate esti-
mate of the spatial distribution of galaxies, for example for stud-
ies of clustering or the galaxy luminosity function (Ascaso et al.
2015, 2016; López-Sanjuan et al. 2017). In the example shown
in Fig. 2, the one-dimensional PDF has two separate peaks of

Article number, page 4 of 20

Fig. 2. Example output of TOPz for one galaxy. The upper panel shows
the χ2 heatmap of every template, where white and blue colours de-
note low and high likelihood, respectively. The green circle marks the
location of the highest likelihood value. The lower panel shows the
marginalised probability distribution. Diﬀerent redshift estimators (de-
scribed in Sect. 3.2) are marked with dashed vertical lines.

roughly the same height. The redshift at the lowest χ2 value
corresponds to one peak (z_ml2d) and the redshift at the high-
est value on the one-dimensional PDF corresponds to the other
(z_ml1d). The corresponding weighted averages are given with
the dashed vertical, slightly darker, lines (z_w1d and z_w2d).
The dashed horizontal lines represent the user-deﬁned thresh-
old for tracing the PDF peak. In this ﬁgure, the threshold is set
to 40% of the peak value and the two thresholds are labelled
threshold 1d and threshold 2d to note the two separate
peaks of z_ml1d and z_ml2d, respectively. The coloured areas
indicate the traced parts of the PDF that are used to calculate the
weighted averages. In this speciﬁc case, the two peaks and the
redshift estimations are all diﬀerent, whereas in many cases they
coincide.

4. The miniJPAS catalogue

MiniJPAS (Bonoli et al. 2021) is a precursory photometric sur-
vey to the Javalambre Physics of the Accelerating Universe As-
trophysical Survey (J-PAS, Benitez et al. 2014). It was car-
ried out between May and September of 2018, using the 2.5-
m Javalambre Survey Telescope, JST/T250, located in Sierra de
Javalambre in Teruel, Spain. The observations consist of four
pointings in the All-wavelength Extended Groth strip Interna-
tional Survey (AEGIS, Davis et al. 2007) ﬁeld covering a stripe
of ∼1 deg2 (1.9 deg × 0.5 deg). The photometric data set was ob-
served in 54 narrow-band and six medium and wide-band ﬁlters
using the interim JPAS-Pathﬁnder camera. For our analysis, we
have used the point-spread-function-corrected ﬂuxes given in the
minijpas.FNuDualObj catalogue of the miniJPAS data release

02004006008001000template number0.050.100.150.200.25z0.20.40.60.81.0Pthreshold 1dthreshold 2dz_w1dz_w2dz_ml1dz_ml2dJ. Laur et al.: TOPz: Photometric redshifts for J-PAS

PDR201912, provided in the J-PAS data archive2. Additional
Milky Way extinction corrections have been applied per pass-
band based on the E(B − V) colour excess (see López-Sanjuan
et al. 2019 for details).

For characterising the brightness of the sources and applying
luminosity cuts we have used the r-band MAG_AUTO magnitudes.
The speciﬁc luminosity cut values are described in the text.

The bulk of the science cases of the J-PAS survey critically
depend on the accuracy of galaxy redshift measurements. One of
the most important constraints on the redshift accuracy is related
to probing the properties of dark energy by measuring the scale
of baryon acoustic oscillations (Chaves-Montero et al. 2018).
Following these requirements, the target redshift accuracy of the
J-PAS survey has been set to dz/(1+z) = |zphot−zspec|/(1+zspec) <
0.003 (Benitez et al. 2014). First proof that this target is reach-
able came with the miniJPAS data release, which includes galaxy
redshifts derived with the LePhare code3 (Ilbert et al. 2006), spe-
cially modiﬁed to work with a larger number of ﬁlters and a
higher resolution in redshift (Hernán-Caballero et al. 2021). For
example, for galaxies with r < 22 mag, the normalised median
absolute deviation of redshifts σN MAD = 0.0032 ± 0.002 was
reached at a completeness level of 50% (also see Bonoli et al.
2021, for a more detailed assessment of the redshifts).

To test the accuracy of the photometric redshifts yielded
by the TOPz workﬂow, we use a subset of miniJPAS objects
that have reliable spectroscopic redshift estimates. The deep
extragalactic evolutionary probe 2 (DEEP2) and deep extra-
galactic evolutionary probe 3 (DEEP3) Galaxy Redshift Surveys
(Cooper et al. 2011; Newman et al. 2013) provide the largest
and most comprehensive set of spectroscopic observations in the
miniJPAS footprint. We only considered sources that are classi-
ﬁed spectroscopically as a galaxy with the secure spectroscopic
redshift quality ﬂag (ZQUALITY ≥ 3). Some additional spec-
troscopic redshifts were cross-referenced from the Sloan Digital
Sky Survey. The depth of the test catalogue is set at 23 magni-
tudes in r-band and the spectroscopic redshifts are selected up to
redshift 1.5. In total, the resultant test catalogue consists of 4457
galaxies while a brighter (r < 22 mag) sub-sample with 1989
objects is used in most of the tests. In general, this test catalogue
is based on the one used by Hernán-Caballero et al. (2021) for
constructing the miniJPAS photo-z and therefore we have con-
sidered the redshift accuracy achieved by them in the miniJPAS
data release as a benchmark for TOPz performance.

Since each object in the test sample was required to have a
spectroscopic classiﬁcation of a galaxy, there are no objects in
the test catalogue that are identiﬁed as AGNs or quasars, high-z
point sources that exhibit distinct characteristics diﬀering from
other galaxies. Therefore, we have not attempted to represent
AGN spectra in our templates. We note that a robust detection
and classiﬁcation of J-PAS quasars would be needed to properly
address them in the future (Queiroz et al. 2022).

The distributions of spectroscopic redshifts and r-band mag-
nitudes of the test catalogue sources can be seen in Fig. 3.
The statistical ﬂuctuations of redshifts are visible, hinting that
a larger test sample would be desirable for a comprehensive as-
sessment of the redshift estimates. For example, the redshift his-
togram (green barplot on the right panel) shows peaks at around
redshift 0.25 and 0.4 that are most likely due to larger clusters or
superclusters in the line of sight of the observations. Such con-
centrations may bias the ﬁnal template selection.

2 http://archive.cefca.es/catalogues/minijpas-pdr201912
3 http://www.cfht.hawaii.edu/∼arnouts/lephare.html

Fig. 3. Distribution of spectroscopic redshifts and r-band magnitudes
of the miniJPAS sources in the test catalogue. The dashed line represent
the magnitude cut of the brighter sub-sample.

The miniJPAS data reduction process identiﬁed some resid-
ual issues with individual images that needed special treatment:
fringing, vignetting, and background patterns. To correct for
these eﬀects, additional illumination and background corrections
were applied after the initial pipeline data reduction (for more
details see Appendix B of Bonoli et al. 2021). Although these
corrections generally improved the photometry, some systematic
errors may have been introduced. Therefore, we seized the op-
portunity oﬀered by the template-ﬁtting redshift estimation prin-
ciple to further reﬁne the miniJPAS photometry. This step is de-
scribed in detail in Sect. 5.3.

5. Templates and prior of model galaxies

For template-based photometric redshift estimation, the quality
of the template library is crucial. Moreover, depending on the
observational data and the aims, speciﬁc templates with speciﬁc
features may be needed. For example, the spectral range and
spectral resolution of the observational data set and the targeted
redshift range dictate the requirements for the spectral range and
spectral resolution of the templates. Additionally, the presence
and precision of broad absorption features such as MgB, CaT, or
TiO bands and emission lines in the templates are needed. Be-
sides the technical characteristics of the templates themselves,
the whole template library must be representative of the ob-
served sources. Counter-intuitively, a maximally broad choice of
templates is often not the best solution because at lower signal-
to-noise levels the chance of a completely unrealistic template
yielding a low χ2 value at an incorrect redshift increases signiﬁ-
cantly.

The J-PAS optical system comprises of observations that
range from 3400 to 11 000 Å. Since several sources are expected
to lie well beyond z = 1, we require the templates to cover at
least the 1000 to 11 000 Å range. The minimally required spec-
tral resolution is not determined by the width of the passbands
(FWHM ∼ 145 Å) but rather by the sharp edges of the through-

Article number, page 5 of 20

181920212223r-band (magnitude)0.00.20.40.60.81.01.21.4 spectroscopic redshift 0200400250A&A proofs: manuscript no. topz

put curves. These edges are measured to be around 10 Å wide,
so a template spectral sampling rate of ≤ 10 Å would be needed.
Generally, there are two approaches to compile the template
library: using observed spectra of a broad range of galaxy types
or using stellar population synthesis models. Since there are only
a small number of readily available observational spectra cover-
ing the required wavelength range at the required resolution, we
consider the synthesis approach to be more applicable. Besides,
the spectra produced by stellar population synthesis can be di-
rectly linked to the physical properties of the galaxies, making it
easy to provide a value-added catalogue alongside with the red-
shift estimates.

As mentioned above, we would like to prevent the template
library from becoming too large. On the other hand, the usage
of narrow-band photometry requires the templates to be realistic
and representative also in details like spectral line strengths and
ratios. We chose the strategy of constructing templates on the
basis of the same data set which the templates are going to be
applied on, in the present case, the miniJPAS (Hernán-Caballero
et al. 2021). While risking to introduce a biased choice of tem-
plates due to the small number of objects in the data set, we are
at least ensuring that the template library corresponds to the ac-
tually targeted sources.

5.1. Base template set generation

In this work, we used the Code Investigating GALaxy Emis-
sion (CIGALE; Boquien et al. 2019) for generating a library of
synthetic spectra. CIGALE uses ﬁlter passbands and observed
galaxy ﬂuxes through these passbands to generate its synthetic
spectrum. Assuming the spectroscopic redshift of an observed
galaxy, we could construct precise synthetic galaxies from the
spectroscopically observed subset of the full miniJPAS data set
(see Sect. 4). We varied the CIGALE input parameters determin-
ing the star formation history, dust attenuation, and other prop-
erties within realistic limits. According to its working principle,
CIGALE calculates the spectra resulting from each parameter
combination and then assesses their correspondence to the ob-
served galaxy’s SED. Eventually, we are left with CIGALE’s
best estimate for the spectrum of each galaxy. In order to avoid
approximating noisy data with unrealistic models, we used 500
brightest galaxies from the test sample for this procedure, that
is galaxies up to ∼ 21 mag in r-band. We ﬁne-tuned almost ev-
ery CIGALE input parameter to achieve the best TOPz photo-z
accuracy of the sub-sample. The list of input parameters gener-
ating the template library used throughout this work is speciﬁed
in Table 1.

From Fig. 3, it can be seen that the 500 brightest galaxies
that we used for the template construction have redshifts z (cid:46) 0.7
while the brighter test sample extends farther, z (cid:46) 1. However,
since evolutionary eﬀects become important at much higher red-
shifts, it is very unlikely that there are galaxy types in our test
catalogue that are not represented by the 500 brightest galax-
ies and therefore no additional templates are needed to compen-
sate for the redshift diﬀerence. A test on how under or over-
represented templates aﬀect the resulting redshift estimations is
discussed in Sect. 6.1.1.

The resulting spectra were designated as our base set of tem-
plates. In principle, all of these spectra can be used as templates,
but initial tests suggested that this is not optimal for photomet-
ric redshift determination. In order to mitigate this issue, we se-
lected a template sub-sample that would yield a better photomet-
ric redshift accuracy as described in the next Section.

Article number, page 6 of 20

Table 1. Parameter names in CIGALE alongside the value ranges that
were used to construct the templates.

Parameter

Values

Delayed expa with burst (sfhdelayedbq module)

b

τmain
Age of main population
Age of burst
Ratio of the SFRc after burst

300, 680, 1550, 3500, 8000
2000, 5300, 8600, 12000
10, 29, 83, 240, 690, 2000
0.01 , 0.017, 0.03, 0.05, 0.08,
0.14, 0.24, 0.4

Bruzual Charlot synthesis (bc03 module)

IMFd
Metallicity
Population age separation

Salpeter
0.008, 0.02
10, 32, 100, 316, 1000

Emission features (nebular module)

Ionisation parameter

−3.0, −2.5, −2.0, −1.5, −1.0

Dust absorption (dustatt_modiﬁed_CF00 module)

µe
ISMf power law slope
ISM V-band attenuation
Power law slope of the
attenuation in birth clouds

0.01, 0.025, 0.06, 0.16, 0.4, 1
−0.5, −0.7, −0.9
1

−1.3

Notes. Abbreviations: (a) exponential model; (b) e-folding time of the
main stellar population model in Myr; (c) star formation rate; (d) initial
mass function; (e) attenuation ratio; (f) interstellar medium.

5.2. Final template selection

In addition to the template quality and representativeness, also
the size of the template library can be optimised. A higher
number of templates increases the redshift accuracy of brighter
sources, while also lowering the accuracy of fainter ones due
to over-ﬁtting. Therefore, the optimal number of templates for
diﬀerent brightness sub-samples are diﬀerent. The results of the
corresponding test are described in Sect. 6.1.1. For the brighter
(r < 22 mag) subset, we ﬁnd that a library of around 75 tem-
plates gives an optimal result.

In order to obtain a smaller template library while still pro-
viding an adequate description of the observed galaxies, we re-
duced our base template set on the basis of minimising the total
χ2 value. In essence, the selection process was done by selecting
a speciﬁed number of templates from the base template set, shift-
ing them by the spectroscopic redshift value, and then applying
the TOPz workﬂow to the test catalogue. While iteratively se-
lecting diﬀerent sets of templates, we would ﬁnd the one that
minimises the total χ2 value of the test catalogue.

A more detailed description of the template selection process
T for each

is as follows. Similarly to Eq 6, we calculated the χ2
galaxy-template combination as

χ2
T

= 1
Nﬁlt





Nﬁlt(cid:88)

j=1

F j − aFT, j
σ2
F j


2



,

(12)

where Nﬁlt is the number of valid pasbands for a given galaxy.

Let us denote the set of selected templates as V so that each
set V belongs to the overall set containing all possible combina-
tions V ⊂ Vmaster while the number of templates in set V is ﬁxed
at NT. For every galaxy, we selected the best-matching template
and the corresponding χ2

T value from V by calculating

χ2
gal

= min
T ∈V

(cid:17)

(cid:16)
χ2
T

.

(13)

J. Laur et al.: TOPz: Photometric redshifts for J-PAS

Fig. 4. Final selection of 75 templates after pruning the base template
set made with CIGALE. The ﬂuxes are scaled to unity at 4000 Å. Some
templates are depicted darker for visual representation.

From there, the general assessment of the template set V was
based on the total χ2
cat value of the test catalogue (with Ngal galax-
ies) by calculating

χ2
cat

=

Ngal(cid:88)

i=1

χ2
galwgal,

(14)

where the weights wgal are based on the normalised apparent
magnitude of the galaxy. To lower the eﬀect of the more noisy
fainter galaxies, the weight values used in this paper were be-
tween 3 and 1. This means that the brightest galaxy has a weight
value of 3 and the faintest galaxy a weight value of 1 with other
galaxies having weight values linearly distributed between those
two. This ensures that when the χ2
gal values change between dif-
ferent template sets V, the brighter galaxies would contribute
more to the total χ2

cat change than the fainter galaxies.

The selection of the best template set was calculated itera-
tively. The ﬁrst iteration contained a random initial set of tem-
plates while every other iteration replaced a single template,
starting from the worst performing one. For determining the best
template set, Vi was substituted with Vi+1 only in case the global
cat is minimised (χ2
χ2
cat,i). Otherwise, the set Vi would
be the starting point for the next iteration.

cat,i+1 < χ2

Following this method, we reduced the total number of tem-
plates while covering most of the spectral features present in
the SEDs of the galaxies in our test catalogue. All of the 75
templates in the ﬁnal selection are plotted in Fig. 4. The ﬂuxes
are scaled at 4000 Å in order to see the shapes of the templates.
In this selection, there are templates with and without emission
lines although it is hard to see on the plot as the emission lines
overlap with the templates without the lines.

Another way of showing the template coverage is using a
colour-colour diagram (see Fig. 5). The r < 22 miniJPAS cata-
logue until z = 1 are shown as green points while fainter points
indicate fainter galaxies in g-band ﬂux. The template colours are
shown for three distinct redshift values: 0, 0.3, and 1. Increasing
redshift values twist and shift the template colours towards the
upper-left side of the colour-colour diagram. As such, the area
between the z = 0 and z = 1 template colours is where we expect
most of our redshifted templates to lie. The overlapping region

Fig. 5. Colour-colour diagram of the miniJPAS catalogue (green points)
and the selected templates (diﬀerent markings). Green point intensity
corresponds to the galaxy g-band ﬂux. The shapes of the template mark-
ings indicate the same templates at three distinct redshifts. Blue and red
colours indicate whether a late- or early type prior was applied to the
given template (see Sect. 5.4).

between the template colours and catalogue colours shows where
our selected templates cover the corresponding galaxy types. We
deﬁne a rectangular region between the templates with most ex-
treme colours as the colour range that is encapsulated by the tem-
plates. Most of the catalogue galaxies (∼ 78%) are within this re-
gion, while there are some galaxies that have more extreme g − r
colours than our templates. These measured colour extremes are
likely due to fainter galaxies as most of the faint (less g-band
ﬂux) green points lie in that region.

5.3. Photometric corrections

By knowing the spectroscopic redshifts and the expected (tem-
plate) spectra of the galaxies, we can inspect the observed pho-
tometry for possible systematic oﬀsets. To check for such oﬀsets,
we used the template selection as described in Sect. 5.2.

For every galaxy, we calculated the diﬀerence between the
observed and synthetic photometry that is obtained from the tem-
plate with minimum χ2 value at the spectroscopically ﬁxed red-
shift. The upper panel of Fig. 6 presents such diﬀerences for each
passband. While the scatter is large, a notable systematic oﬀset
of median values (up to 10%) is also present in many ﬁlters.
Assuming that the templates at least roughly depict the actual
galaxy SEDs, we may consider that systematic oﬀsets between
observations and templates are unlikely to be caused by prob-
lems with the templates. This is because the oﬀsets occur even
after redshifting the templates by a varying amount according to
each given source and therefore should not be a systematic eﬀect
caused by the templates. Instead, the oﬀsets refer to some resid-
ual deviations in the photometry that we can reduce by bring-
ing the observed photometry closer to the templates, as done in
Coe et al. (2006). We also note that this kind of correction might
introduce some colour terms, that is correlations between pass-
bands, as synthetic spectra do not represent all the aspects of
observed galaxies. So one has to keep in mind that these cor-
rections may still contain some dependence on the template or
source set and might not be applicable for other purposes.

For calculating the photometric corrections, we also consid-
ered the known observational uncertainties. The correction term

Article number, page 7 of 20

20003000400050006000700080009000wavelength (Å)0.51.01.52.02.5scaled flux0.50.00.51.01.52.02.5g - r (mag)0.00.51.01.52.0u - g (mag)z=0z=0.3z=1A&A proofs: manuscript no. topz

Fig. 7. Photometric correction term C (deﬁned in Eq. 15) for each pass-
band given in wavelengths. This is the average correction value over the
four diﬀerent tiles in miniJPAS data.

that comprise these tiles. Although the correction terms from tile
to tile might diﬀer a lot in some of the passbands, the overall
shape of the terms in all of the passbands remain the same.

Figure 7 shows our calculated corrections in all of the
miniJPAS passbands where each point denotes the correction
term that is averaged over the four diﬀerent tiles for clarity. As
can be seen, the correction values range from 0.9 to 1.1 and are
mostly uncorrelated with passband wavelength. An exception is
the red end (starting from ∼ 8000 Å) where a sharp gradient
is seen. We speculate that this could be related to the fringing
eﬀect aﬀecting the CCD photometry at longer wavelengths. It
also seems that the average correction term between 4000 and
7000 Å trends towards unity, which is probably related to the
decrease in observational errors caused by the atmospheric ab-
sorption in the ‘optical window’. The corrected photometry can
be seen on the lower panel of Fig. 6 which shows the diﬀerences
between observational and model ﬂuxes after applying the pho-
tometeric corrections from Fig. 7 to the observations. In general,
the average diﬀerence between observations and model has been
reduced signiﬁcantly, while some minor systematic oﬀsets are
still present at bluer wavelengths.

5.4. Prior

The prior, in the context of Bayesian redshift estimation, enables
us to reﬁne our results using what we know about the distribution
of galaxy luminosities and galaxy types at diﬀerent redshifts.
The prior indicates the probability of ﬁnding a galaxy with a
certain apparent magnitude and type at a certain redshift. This
probability can be inserted into the redshift estimation through
the prior term p(z | T, m0) in Eq. (3) modifying the resultant red-
shift PDF.

In principle, it is possible to ascribe a diﬀerent prior to each
template and, provided that the galaxy data set under consider-
ation is large enough, the priors for each template can be cal-
ibrated based on the data themselves. However, given that our
current sample is rather limited and external observations do not
give information at the required level of detail, we have adapted
here the priors constructed by Benítez (2000). He introduced an
analytic form for the prior, containing a parametrised relation-
ship between the redshift and apparent luminosity, depending on

Fig. 6. Oﬀsets between the observed and template-based model ﬂuxes
before (upper panel) and after (lower panel) the photometric correc-
tions. The correction factor C is deﬁned in Eq. 15. Solid line illustrates
the median value while the shaded area marks the inner 50% of the
objects in each passband.

is deﬁned so that the average diﬀerence between the observa-
tions and synthetic photometry would become zero. For each
passband, the correction term C is calculated using the following
expression:

Ngal(cid:88)

i=1

FT,i − CFi
σFi

= 0,

(15)

where FT,i and Fi are the synthetic and observed ﬂuxes of each
galaxy i, and σFi are the corresponding observational uncertain-
ties. Factor C is the correction term for the given passband that
is set to one for uncorrected data and diﬀers from unity if correc-
tion is needed. After the initial run, we applied the corrections to
the observations in each passband and conducted another itera-
tion of TOPz with the newly corrected photometry while keeping
the same templates. We iterated up to four times until no signiﬁ-
cant improvement could be seen between the last two iterations;
ﬁnal correction value would thus be the cumulative correction
over the iterations. While correcting the observations, we kept
the observational error at the same fractional value that it was
in the original catalogue. This means that when the brightness
increased due to photometric corrections, the absolute observa-
tional errors were also increased and vice versa.

The miniJPAS observations consist of four tiles, that is co-
added frames of multiple exposures observed through each of
the J-PAS ﬁlters at four diﬀerent pointings. We calculated the
correction terms on a per tile basis using only the galaxies in said
tile. We found slightly diﬀerent correction terms for each tile that
are most likely associated with the variable PSF of the images

Article number, page 8 of 20

0.50.00.51Fmod/Fobs400050006000700080009000wavelength (Å)0.50.00.51Fmod/(CFobs)400050006000700080009000wavelength (Å)0.91.01.1CJ. Laur et al.: TOPz: Photometric redshifts for J-PAS

Fig. 8. Two types of galaxy priors used in this work. The upper panel
shows the probability that a spiral galaxy of a certain brightness would
lie at a certain redshift and the lower panel shows the same for an early
type galaxy.

the morphological type. Three morphological types were distin-
guished: early type galaxies (E/S0), spirals (Sbc, Scd), and irreg-
ulars. The parametrisation of the prior function was conducted
on the basis of galaxy statistics in the Hubble Deep Field North
(Williams et al. 1996).

We split our templates into red and blue sub-types accord-
ing to their cumulative spectral distribution and respectively as-
cribed them the prior function of either the early type or the spi-
ral type from Benítez (2000). That is, we calculate the wave-
length value where the cumulative template ﬂux reaches 50%
and then apply the spiral type to ∼ 80% of galaxies with lower
wavelength value and early type to the rest, roughly following
the fractions measured for the local universe. The colour-colour
representation of the sub-types can be seen in Fig. 5 where, de-
pending on the redshift, each group of templates is separated into
a redder and bluer marking denoting the red and blue sub-types,
respectively. The dependence on the redshift for the early and
spiral type priors diﬀer mostly when looking at fainter galax-
ies (see Fig. 8). We chose the r-band magnitude as an indicator
of the apparent luminosity. Our tests showed that the eventual
redshift accuracy was not sensitive to the exact location of sepa-
ration between red and blue galaxies.

The prior bends the redshift PDF according to the overall
shape of the prior (see Fig. 9). These drastic examples illustrate
how adding a prior can both improve as well as hamper the red-
shift determination when the PDF has multiple peaks. The prior
can enhance the secondary maximum into a primary one and
the resultant redshift value estimation become very close to the
spectroscopic redshift value (see top panel of Fig. 9). Whereas,
on the lower panel the prior drastically reduces the primary max-
imum that was centred around the spectroscopic redshift, giving
the galaxy a wrong photometric redshift estimation. This eﬀect

Fig. 9. Eﬀect of prior on the redshift PDFs of two selected galaxies. The
black dotted vertical line is the spectroscopic redshift and the dashed
blue line is the TOPz z_w1d redshift estimation. Solid black and grey
lines show the normalised PDFs when considering or not considering
the prior, respectively.

is most prominent for faint galaxies at very low redshift values
where the prior favours a higher redshift solution. Thus, there is
room for improvements in specifying the prior by adding addi-
tional prior types and, if suﬃcient J-PAS data with known spec-
troscopic redshifts will be available, by constructing the priors
directly from observations.

6. Photometric redshifts with miniJPAS data

For the tests with the miniJPAS data, the upper limit of TOPz
redshift estimations were set to z = 1.5 and the resolution was
set to ∆z = 0.001. The threshold value for calculating weighted
estimates (see Fig. 2) was set to 0.4 as the closest rounded value
that, based on our initial testing, yielded the best results. In ad-
dition, we applied the prior and the photometric corrections as
described in Sect. 5.3 and 5.4. Below we give an overview of the
impact that diﬀerent inputs and conﬁgurations have on the TOPz
performance for the r < 22 mag sub-sample of galaxies (1989
sources) when comparing the photometric redshift estimations
to the spectroscopic redshifts.

6.1. Testing the impact of TOPz inputs

6.1.1. Impact of template selection

As explained in Sect. 5, photometric redshift estimation may de-
pend on the set of templates used for approximating the observed
spectral distribution of the galaxies. Consider the example of the
best-matching template ﬁtted to the photometry of an r = 20.6

Article number, page 9 of 20

1819202122Sbc, Scd0.00.20.40.60.81.0z1819202122E/S0r (mag)0.300.320.340.360.380.400.420.440.20.40.60.81.0Pprior onprior off0.050.100.150.200.250.30z0.20.40.60.81.0PA&A proofs: manuscript no. topz

Fig. 10. Example of a ﬁtted template matching the photometry. The
upper panel shows the match between the observed (orange circle) and
the synthetic photometry (blue box) of the best template (blue line).
The lower panel is the PDF from TOPz with dashed blue line showing
the weighted redshift (z_w1d) and black dotted line the spectroscopic
redshift.

galaxy, presented in Fig. 10. On the upper panel, the blue line
and squares represent the template spectrum and the correspond-
ing synthetic photometry, respectively, and the orange circles are
the observed ﬂuxes together with error estimates in each of the
54 narrow-band ﬁlters. Although the photometric errors are rela-
tively large and the scatter of the observations even exceed these
errors, we can quite accurately detect the major emission lines.
The lower panel shows the marginalised PDF that is produced
by our ﬁnal template set. The PDF peak (z_ml1d) as well as the
z_w1d redshift estimation (dashed blue line) are somewhat over-
estimated. Nevertheless, the photometric redshift is more accu-
rate than the J-PAS target goal of dz/(1 + z) < 0.003.

In Sect. 5.2 we noted that ∼ 22% of the galaxies in the test
catalogue fall outside the colour region that our templates cover.
We also noted that these galaxies are fainter on average, having
a median brightness of r = 21.57 mag compared to r = 21.21
mag of those galaxies that are inside the region. We ﬁnd that at
a ﬁxed brightness level, the number of galaxies that reach the J-
PAS accuracy goal is similar between galaxies outside the colour
region and the remaining galaxies. This shows that, although the
broadband colours of the templates are somewhat more restricted
than those of the observed galaxies, the templates are accurate
enough to yield reliable redshift estimates from the full J-PAS
ﬁlter set. The most probable explanation is that the accuracy of
photo-z for fainter galaxies is, due to their larger photometric
uncertainties, mostly deﬁned by the detection of emission lines
and not the template broadband colours themselves.

In TOPz, the marginalised PDF of a galaxy is determined by
the input templates since it is combined from the χ2 values of ev-
ery single template in that set. If the chosen templates do not rep-
resent the observed data, the combined PDF shape will be wors-

Article number, page 10 of 20

Fig. 11. Photometric redshift accuracy depending on the size of the used
template set. Each point marks the mean value of the 20 diﬀerent reali-
sations of a template selection run. Upper panel shows the percentage of
objects that ﬁt the J-PAS accuracy criteria while the middle panel shows
the achieved median absolute deviation for the normalised distribution
(σNMAD). The lower panel shows a merit function for choosing the
ﬁnal number of templates. The two colours are cuts in magnitude where
the green points are shifted slightly right for visibility.

ened by the unsuitable templates, which may yield a relatively
low χ2 ﬁt to the observational data points at an otherwise ran-
dom redshift. Thus, by reducing the total number of templates,
we can ﬁnd a template conﬁguration that improves the overall
quality of the photometric redshifts compared to an arbitrarily
composed big template set. A more general solution could be
made by applying a template prior to the likelihood.

First, we tested how varying the amount of a single template
type aﬀects the marginalisation process of the PDF and what is
the eﬀect on the resulting redshift estimations. For this, we in-
creased the ratio of templates that were deﬁned as elliptical up to
50 times, increasing the template set from 75 up to ∼ 1100. The
resulting photometric redshift estimations worsened at most 1%
and thus we conclude that the number of templates of any certain
spectral type has negligible eﬀect of the outcome. This is mainly
because the ratio of templates with diﬀerent spectral types only
aﬀect redshift estimations for galaxies with PDFs having multi-
ple peaks (75% of the test catalogue is single peaked) with suﬃ-
cient strength. Therefore, a potential template bias that would be
caused by the fact that DEEP2 and DEEP3 spectroscopic sam-
ples were selected to prefer higher-redshift sources should not
aﬀect our results. This type of template selection eﬀect could
be further reduced by introducing a template prior that would
weight each template type by its occurrence in the selection.

Next, we conducted a test to see the impact that the size
of the template set has on the eventual redshift accuracy. The
results are shown in Fig. 11. Each point represent 20 realisa-

400050006000700080009000wavelength (Å)0.00.51.01.52.0fluxz_spec=0.244   z_phot=0.246synobs0.2300.2350.2400.2450.2500.255z0.20.40.60.81.0P32343638% objects dz < 0.00312.012.513.013.514.0% objects dz < 0.003r < 22r > 220.650.700.750.800.85NMAD (%)4.64.85.05.2NMAD (%)0255075100125150175200number of chosen templates0.00.51.0MeritJ. Laur et al.: TOPz: Photometric redshifts for J-PAS

tions of the template set selection run. The errors of these points
are a result of the semi-random nature of the template selec-
tion procedure (see Sect. 5.2). The two colours show the re-
sults separately for objects brighter (blue) and fainter (green)
than r = 22 mag. The upper panel shows that the fraction
of brighter galaxies that achieve the J-PAS target accuracy in-
creases until the template set size of about 75 is reached. This
is because too few templates cannot cover the whole spectral
type distribution of the observations. Beyond the 75 template
mark, additional templates do not improve the results. While
more templates may provide a better approximation for some
galaxies, they contaminate the redshift PDF of some others and
eﬀectively reduce the overall redshift determination accuracy.
The middle panel of Fig. 11 shows a similar result for brighter
galaxies when using the normalised median absolute deviation
(σNMAD = 1.4826 ∗ median(|dz − median(dz)|) ) as a proxy to de-
scribe the spread of the photometric redshift accuracy (Hernán-
Caballero et al. 2021). The deviation for the brighter sub-sample
stays the lowest when the size of the template set is close to 75.
As Fig. 11 shows, the above aspects are diﬀerent for fainter
galaxies which are more dominated by noise. Estimation of the
redshifts of fainter galaxies beneﬁts from the use of far fewer
templates as then the possibility that an arbitrary template falsely
gives a relatively low χ2 at an arbitrary redshift decreases.

Based on the above information as well as on the outlier rate,
deﬁned as galaxies with a redshift accuracy worse than 5%, we
have constructed a merit function that helps us choose the opti-
mal number of templates. We deﬁne the following counts:

U =

W =

(cid:34)

(cid:34)

1

1

Ngal(cid:88)

i=1
Ngal(cid:88)

i=1

dzi
1 + zi

dzi
1 + zi

(cid:35)

< 0.003

,

(cid:35)
< 0.05

,

(16)

(17)

where U and W are the number of galaxies that reach the J-PAS
accuracy limit and the number of galaxies that don’t reach the
outlier limit, respectively. The merit function is then deﬁned as
a weighted combination of the Ω components:

Merit = waccΩacc + wNMADΩNMAD + woutΩout,

(18)

where each Ω component is deﬁned as the corresponding values
normalised between [0,1]

Ωacc,m =

Um − min U
max U − min U

,

ΩNMAD,m =

σNMAD,m − min σNMAD
max σNMAD − min σNMAD

,

Ωout,m =

Wm − min W
max W − min W

.

(19)

(20)

(21)

Here, Um is the U value for an applied template set Vm and the
same holds true for σNMAD,m and Wm. The weights wacc, wNMAD,
and wout in Eq 18 determine the desired ratio of the merit com-
ponents. In this work, we used the respective weight values of
0.4, 0.4, and 0.2. The outlier ratio was given a lower weight be-
cause our outlier deﬁnition is somewhat arbitrary and it also af-
fects only a small fraction of galaxies.

Based on the calculated merit values (see lower panel of
Fig. 11), we ﬁnd that the optimal number of selected templates
for bright galaxies is 75, although the diﬀerences between other
number of chosen templates are not that big for number of tem-
plates above 50. In this work, we were satisﬁed with only one set

Fig. 12. Photometric redshift accuracy depending on the r-band mag-
nitude limit of the base templates. The y-axis of each panel is identical
to those in Fig. 11. Each mark is composed of 10 realisations and each
realisation has 100 selected templates.

of 75 templates as we mostly use the magnitude cut of r < 22
mag. But if larger sets of observations should become available
in the future, it might be viable to construct diﬀerent template
selections for each brightness range.

Another test was carried out to determine whether setting a
magnitude limit to the galaxies used for template creation (see
Sect. 5.1) has any eﬀect on the ﬁnal template selection and the
resulting redshift estimations. The reasoning being that by only
selecting templates constructed from brighter galaxies, the qual-
ity of said templates might be much higher and thus excluding
templates constructed from fainter galaxies results in a higher
quality template set.

Overall, the magnitude limit does not seem to aﬀect the per-
formance much for template sets of 100 templates (see Fig. 12).
The biggest exception being the brightest cut (r ≤ 19) that con-
siderably decreases the resultant accuracy due to a small number
of templates from which the template set can be formed (here,
142). Templates based on relatively few brightest galaxies can-
not be representative enough for all the observed galaxies. If the
number of bright sources were larger, such an eﬀect should be
signiﬁcantly reduced. However, the possibility that the SEDs of
some speciﬁc higher redshift sources remain unrepresented in
the template set increases with brightness cuts.

6.1.2. Impact of applying the photo-z priors

We tested whether the inclusion of a simple prior as described
in Sect. 5.4 make a notable impact on the redshift estimation ac-
curacy. Distribution of the redshift accuracy of the sources with
and without prior can be seen in Fig. 13. In general, the shape
of the accuracy distribution remains roughly the same. The mi-
nor diﬀerences are due to galaxies with the redshift PDF shapes

Article number, page 11 of 20

36.036.537.037.538.0% objects dz < 0.0030.700.72NMAD (%)19.019.520.020.5magnitude limit of generated templates0.00.51.0MeritA&A proofs: manuscript no. topz

Fig. 13. Comparison of the distributions of photometric redshift accu-
racy with prior turned on and oﬀ for galaxies with r < 22 mag. Galaxies
with the accuracy better than the J-PAS target value 0.3% are marked
with darker blue area between the dashed black lines. The percentages
in the top left corners show the fraction of objects having the J-PAS
target accuracy (upper) and the fraction of outliers (lower).

Fig. 15. Reduced χ2 value distributions before (blue) and after (green)
applying photometric corrections to the miniJPAS photometry. Com-
pared to the initial catalogue, corrected data has a more condensed re-
duced χ2 distribution but the mean value is shifted further away from
unity.

shift estimations is ∼ 3 times higher than the number of wors-
ened ones (115 and 36, respectively, out of the total of 1989
galaxies). Interestingly, the ﬁgure also shows that, on average,
the corrections tend to increase the redshift estimation rather
than reduce it. This is most likely due to that linear increase
in correction values starting from ∼ 8000 Å (see Fig. 7). Only
the nearest sources show the opposite eﬀect because our redshift
estimations are limited to z > 0.

However, the galaxies shown in Fig. 14 make up only ∼ 8%
of the whole sample. For most of the other galaxies, the eﬀect of
the photometric correction is much more subtle and for around
75% of the galaxies in the catalogue, the eﬀect is so negligible
that it does not aﬀect their photometric redshift accuracy.

We can assess the photometric corrections also from a sta-
tistical point of view. Assuming that the templates are optimal
for the given galaxies, it is expected that the average χ2 value
for the best match template over all passbands (reduced χ2) re-
mains close to unity. This means that, on average, the diﬀerence
between the data and the template is of the same measure as ob-
servational errors and, as a result, is aﬀected only by these errors.
The photometric corrections should improve the photometry
and lead to better redshift estimations. This is under the assump-
tion that the templates describe the galaxies somewhat truthfully
and that by introducing this correction we will get rid of the sys-
tematic oﬀsets embedded in the photometry and bring it closer
to the template SEDs. Fig. 15 shows the reduced χ2 values be-
fore and after applying the photometric corrections for galax-
ies in the brighter sub-sample (r < 22 mag). The reduced χ2
value distribution of the initial photometry (blue) is quite broad,
with the maximum close to unity and a large wing extending to
high values. By applying the corrections, we get a more narrow
distribution. The galaxies with the worst photometry improved
more than the ones with good photometry. But this also created
a side-eﬀect where the distribution maximum is now shifted to
around χ2 = 0.8. While still relatively close to unity, it might
also be an indicator of an overestimation of systematic errors
either by miniJPAS data processing or as a result of the photo-
metric corrections. However, we consider the current data set not
big enough for far-reaching conclusions and the above deviation
from unity big enough for motivating a mechanical reduction of
the photometric errors.

Fig. 14. Eﬀect of our photometry corrections to the redshift estimations.
Red diamonds are the photo-z values with raw data and blue points are
the photo-z values after correcting the photometry. The dotted lines in-
dicate whether the corrections improve (blue line) or worsen (red line)
the photo-z estimation.

that are most aﬀected by the prior. The number in the top left
corner of each panel shows the ratio of galaxies that achieve the
J-PAS target accuracy and the number below that is the fraction
of outliers. As can be seen, there is an improvement of both indi-
cators where the number of outliers is reduced by almost 10 per
cent. Thus, we conclude that applying even a simple prior is an
improvement to the overall redshift estimation quality.

6.1.3. Impact of photometric corrections

The eﬀect of the photometric corrections described in Sect. 5.3
can be seen in Fig. 14. The red diamonds and blue circles show
the z_w1d photo-z estimations before and after applying the pho-
tometric correction, respectively. Only galaxies for which the in-
clusion of the photometric corrections changed the photo-z es-
timations by more than 0.1 are presented in the plot. For these
galaxies, we ﬁnd that the number of improved photometric red-

Article number, page 12 of 20

0.010.000.010204060prior off0.010.000.01  prior ondz / (1 + z_spec)0.00.20.40.60.81.01.21.4 spectroscopic redshift 0.00.20.40.60.81.01.21.4photometric redshiftwithout correctionswith corrections0.000.250.500.751.001.251.501.75reduced 20.00.51.01.52.0raw (r < 22)corrected (r < 22)J. Laur et al.: TOPz: Photometric redshifts for J-PAS

Fig. 17. Impact on redshift estimation when two separate subsets are
used for training and validation. The x-axis shows the ratio of objects
(from to the full catalogue with r < 22 mag) that are used for test-
ing. Each marking is comprised of 10 randomly selected subsets and
is plotted as the mean value and standard deviation of the distribution
of values. The blue points follow the percentage of objects that ﬁt the
J-PAS accuracy criteria while the green points follow the achieved me-
dian absolute deviation for the normalised distribution (σNMAD). The
green points are shifted slightly right for better visibility.

panel shows the density of diﬀerences between the two as a func-
tion of redshift and, on average, no noticeable trend can be seen
in the residuals. The lower panel shows the overall photometric
redshift accuracy distribution. We ﬁnd that we reach the J-PAS
redshift accuracy goal (indicated with dashed vertical lines) for
38.6% of the galaxies with r < 22 mag. We also ﬁnd that 12.5%
of galaxies have exceedingly wrong redshift estimate, deﬁned as
dz/(1 + z) > 0.05, that we consider as outliers. This is also the
current failure rate of the miniJPAS-TOPz combination and, as
can be seen below, is similar to the results obtained in Hernán-
Caballero et al. (2021).

One way to increase the reliability of a photometric redshift
estimation is the use of the odds parameter. Hernán-Caballero
et al. (2021) showed that by using an odds cut (odds > 0.82) in
their catalogue, ∼ 50% of the miniJPAS galaxies reach the J-
PAS redshift accuracy goal and only 5% of the galaxies would
be classiﬁed as outliers. We can conﬁrm that when using the
same redshift range to calculate the odds values, the TOPz results
with odds > 0.82 provides 46% galaxies that reach the J-PAS
redshift accuracy goal and 4% of galaxies that are classiﬁed as
outliers. When using the brighter sub-sample (r < 22 mag), these
percentages would be 48% and 4%, respectively. Therefore, a cut
in odds value is, similarly to a cut in brightness, another reliable
way to select a sub-sample of galaxies with better photometric
redshift estimates.

As discussed in Sect. 5, we are using a set of galaxies from
the miniJPAS catalogue for generating our templates and photo-
metric corrections. The same catalogue is used also to probe the
resultant photometric redshift accuracy. In order to address the
possibility that a bias is introduced by using the same catalogue
for both training and validating, we have run the TOPz workﬂow
also on two separate subsets of the full catalogue. The training
subset was generated by randomly selecting a ﬁxed number of
galaxies from the miniJPAS catalogue and the remainder of the
galaxies were left for the validation subset. The training set was
used to generate templates, make a template selection, and cal-
culate photometric corrections. These templates and photometric
corrections were then applied to the validation set to estimate the
accuracy of the photometric redshifts. We varied the correspond-
ing subset sizes to make sure that the potentially small number

Article number, page 13 of 20

Fig. 16. Comparison with spectroscopic redshifts (top panel), surface
density of residuals (middle panel), and photometric redshift accuracy
distribution (bottom panel) for galaxies r < 22 mag. Galaxies with
a photo-z accuracy better than the J-PAS target accuracy of 0.3% are
marked with darker blue between the dashed lines on the bottom panel.
The percentages in the bottom panel show the fraction of objects having
the required accuracy and the fraction of outliers in a upper and lower
box, respectively.

6.2. Comparison with spectroscopic data

In order to assess our photo-z estimation accuracy, we have ap-
plied TOPz to the miniJPAS catalogue described in Sect. 4 and
compared the results with spectroscopic redshifts. In Fig. 16, we
give three diﬀerent types of comparison plots showing the dif-
ferences between the TOPz z_w1d photo-z results and spectro-
scopic redshifts for the sample of 1989 galaxies with r < 22 mag.
The top panel shows a one-to-one comparison of the redshifts.
In general, the miniJPAS-TOPz estimations are in accordance
with the spectroscopic values without a major systematic oﬀset
trend, although in cases of catastrophic failures, TOPz tends to
underestimate redshifts for more distant sources and overesti-
mate them for closer ones. The underestimation at higher red-
shifts may be connected to the above-mentioned lower redshift
preference as well as to the colour degeneracy as low redshift
red galaxies become similar to high redshift blue galaxies. The
overestimation of lower redshifts has a statistical explanation - it
is unlikely to underestimate redshift values that are already close
to 0 as negative redshifts are not allowed in TOPz. The middle

0.00.20.40.60.81.01.21.4spectroscopic z0.00.51.01.5photometric z0.00.20.40.60.81.01.2spectroscopic z0.150.100.050.000.050.100.15dz / (1 + z_spec)01020300.0150.0100.0050.0000.0050.0100.015dz / (1 + z_spec)0204060505560657075size of training set (%)3637383940% objects dz < 0.0030.600.650.700.75NMAD (%)A&A proofs: manuscript no. topz

Fig. 18. Fraction of galaxies satisfying accuracy limits. Diﬀerent limits
are shown on the x-axis with the J-PAS target accuracy of 0.3% in-
dicated with a dashed vertical line. Colours show diﬀerent TOPz runs
using various setups described in this paper and grey corresponds to the
LePhare photo-z estimations presented in the miniJPAS database. This
plot shows how correcting the observations and adding photo-z priors
improve the results signiﬁcantly. Galaxies with r < 22 mag and TOPz
output z_w1d were used.

of galaxies in the training or validation sets does not worsen the
statistics.

The impact on the redshift estimation of separating the train-
ing and validation subsets can be seen in Fig. 17. We ran the
TOPz workﬂow with three diﬀerent training set sizes and ten
randomly selected training sets were generated for each size. It
can be seen that even when using as few as 50% of the miniJPAS
catalogue with r < 22 mag for training (i.e. 994 galaxies), we
achieve the same fraction of galaxies with dz < 0.003 (blue
points) than when using the full miniJPAS catalogue for both
training and validating. The same holds true for the σNMAD
values (green points). When we increase the training size, the
mean values for these characteristics remain almost the same
while the variance grows. This is to be expected, as the num-
ber of galaxies in the validation sets keep getting smaller and
thus the estimates become more aﬀected by the randomness of
the subset selection. It can also be seen that no bias is introduced
when we increase the number of galaxies in the training subset.
Therefore, we can be conﬁdent that using the same catalogue for
both training and validating the photo-z estimates does not bias
the ﬁnal results.

Figure 18 shows how the improvements described in
Sect. 6.1 aﬀect photometric redshift estimations. The results
improve progressively when we use the full base template set
(blue), enable photometric corrections (orange), apply the re-
duced template selection (green), and ﬁnally enable priors along
with the previous steps (red). The grey line shows the photo-
z estimations from miniJPAS database and the dashed vertical
line marks the target accuracy of J-PAS redshifts. Every added
step increases the number of galaxies achieving J-PAS photo-z
target accuracy with the biggest improvement coming from im-
plementing the photometric corrections (see Sect. 5.3). Overall,
TOPz results are on par with previous miniJPAS photo-z esti-
mations showing the accuracy that template-based photometric

Article number, page 14 of 20

Fig. 19. TOPz results based on the brightness of galaxies. Upper panel:
fraction of galaxies within the J-PAS target accuracy (solid lines) and
outliers (dashed lines) depending on the limiting magnitude of the sam-
ple. Colours show z_ml1d (blue) and z_w1d (orange) redshift esti-
mators from TOPz and results from miniJPAS database (grey). Lower
panel: photometric redshift accuracy for individual galaxies alongside
their apparent brightness (blue points). The blue line marks the binned
median value, the shaded area is where 50% of the binned data lies and
the dashed black lines mark the 0.3% accuracy limit.

redshift methods can reach given the quality of the miniJPAS
photometry.

All of the previous results and plots were shown for sources
with r < 22 mag. From the observational perspective, the
brighter the galaxies are, the less noisy the observations become
and the easier it is to estimate photometric redshifts. The ratio
of TOPz photo-z estimations reaching the J-PAS target accuracy
depending on the depth of the observations can be seen in the
upper panel of Fig. 19. As expected, the photo-z accuracy falls
when taking more fainter galaxies into account. As discussed in
Sect. 6.1.1, fainter galaxies would beneﬁt from a smaller set of
templates.

Diﬀerent TOPz redshift estimators (maximum likelihood
z_ml1d and weighted z_w1d) yield a similar dependency on
source magnitude (see Fig. 19). At the bright end, the object
density is low and the scatter in estimators is caused by statisti-
cal errors. The weighted estimator is slightly better up to 21 mag
and becomes equal to other estimators when taking fainter galax-
ies into account. The dashed lines in the upper panel of Fig. 19
show the corresponding outlier fraction. As expected, this frac-
tion increases for fainter sources and no real variation in dif-
ferent photo-z estimators can be seen. The accuracy of Hernán-
Caballero et al. (2021) photo-z results (presented with grey) is
somewhat worse than TOPz for brighter galaxies whereas the
accuracy becomes equal for the full catalogue. The diﬀerences
between Hernán-Caballero et al. (2021) and TOPz results on the

0.0010.0020.0030.0040.0050.006dz / (1 + z_spec)202530354045505560cumulative % of objects500 templates500 templates + cor.75 templates + cor.75 templates + cor. + priorHernan-Caballero et al. (2021)171819202122r limit (mag)020406080100% objects dz/(1+z_spec) < 0.003z_ml1dz_w1dHernan-Caballero et al. (2021)16171819202122r (mag)0.040.020.000.020.04dz / (1 + z_spec)J. Laur et al.: TOPz: Photometric redshifts for J-PAS

brighter end may be caused by diﬀerent optimisation of tem-
plates or other choices in the conﬁguration. However, a detailed
analysis of these diﬀerences is meaningless given the small size
of the galaxy sample and a more thorough assessment have to
wait until more data from the full J-PAS survey become avail-
able.

The lower panel of Fig. 19 shows the photo-z accuracy for
individual galaxies. We note that some outliers are left out of
the bounds of the plot as otherwise the more interesting central
region would become too tiny for visualisation. Galaxies with
apparent magnitudes up to ∼ 19 are mostly within the J-PAS
accuracy limit, shown with the dashed black line. The accuracy
becomes worse at fainter magnitudes and from above ∼ 21 mag,
less than half of the galaxies remain within the J-PAS target ac-
curacy.

6.3. Understanding the PDF

Although a single redshift value is usually the most preferred
output of a redshift catalogue, the underlying redshift PDFs con-
tain more useful information. As one of the TOPz outputs is the
full redshift PDF of every template-galaxy pair, we can conduct
some statistical tests on the whole catalogue to determine how
well-behaved our redshift PDFs are in terms of statistics.

In Polsterer et al. (2016), the probability integral transform
(PIT) is used as a diagnostic tool to check the calibration and the
sharpness of the generated predictive distributions. The PIT is
easily validated visually as a histogram of the cumulative prob-
abilities at the value of the spectroscopic redshift. Only if the
PIT histogram bins are distributed uniformly, are the PDFs well
calibrated. Whereas, if the histogram is u-shaped, the PDFs are
overconﬁdent and in the opposite case, the PDFs are undercon-
ﬁdent.

Polsterer et al. (2016) also introduced a continuous ranked
probability score (CRPS) to measure the individual perfor-
mances of the PDFs. CRPS expresses the distance between the
PDF and the spectroscopic redshift value and is used to measure
how precise is the PDF shape in relation to the true value. An av-
erage CRPS value is used to estimate the overall performance of
a redshift estimation method on a given galaxy set, with a lower
value indicating better PDFs.

Finally, a test to measure the fraction of galaxies ( ˆF(c)) in
which the spectroscopic redshift falls within a given conﬁdence
interval (CI) of the PDF is used to determine how well calibrated
the PDFs are. Wittman et al. (2016) deﬁne the CI as the area
under the PDF that reaches the probability threshold calculated
at the spectroscopic redshift. Likewise to the case with PIT, if the
PDFs are calibrated well then we can expect 10% of galaxies to
fall within 10% CI, 20% within 20% CI, etc. Therefore, when the
cumulative fraction of galaxies ˆF(c) follows the CI values, the
PDFs are well calibrated whereas when the ˆF(c) is below (above)
the CI relation, the PDFs are deemed over- (under-) conﬁdent.

We have analysed the PDFs of the r < 22 mag catalogue
galaxies using three above-mentioned statistics and the results
can be seen in Fig. 20. Both the PIT as well as the ˆF(c) - c re-
lation show that the PDFs of our miniJPAS catalogue are some-
what overconﬁdent. This means that the PDFs are too narrow
and do not correspond well to the true redshift. This is usually
a problem resulting from underestimating the observational un-
certainties.

In Fig. 21, we conducted the same analysis but this time we
increased the photometric uncertainties by 1.3 times. After in-
creasing the uncertainties, the overconﬁdence in the PDFs are
eliminated and the calibration is much more uniform. Also the

Fig. 20. PIT (upper panel), CRPS (middle panel), and ˆF(c) (lower
panel) tests for the r < 22 mag catalogue. The average CRPS value
is given in the middle panel. The dashed grey line on the lower panel
shows the expected ˆF(c) - c relation.

Fig. 21. Same panels as in Fig. 20, but with the uncertainties of the
r < 22 mag catalogue increased by 1.3 times.

Article number, page 15 of 20

0.00.20.40.60.81.00501000.000.010.020.030.040.050100200CRPS = 0.02530.00.20.40.60.81.0c0.00.20.40.60.81.0F(c)0.00.20.40.60.81.002040600.000.010.020.030.040.050100200CRPS = 0.02490.00.20.40.60.81.0c0.00.20.40.60.81.0F(c)A&A proofs: manuscript no. topz

Table 2. TOPz estimator performance for r < 22 mag galaxies with
multi-peaked PDFs.

TOPz estimator
z_ml1d
z_w1d
z_ml2d
z_w2d

dz < 0.003a
15.7%
17.9%
6.4%
7.9%

dz > 0.05b min(dzphot)c

27.1%
25.7%
42.1%
41.4%

27.1%
35.0%
17.1%
20.7%

Notes. (a) Percentage of galaxies that reach the J-PAS redshift accuracy
goal using this TOPz estimator.
(b) Percentage of galaxies that we consider outliers using this TOPz es-
timator.
(c) Percentage of objects for which this TOPz estimator is closest to the
spectroscopic redshift.

precision in other cases. However, it does not help much in the
worst cases. For more complex shapes (panel 5 and 6), the diﬀer-
ence in templates is more distinct but the spectroscopic redshift
value is not always around the maximum and there is no univer-
sal way to detect and solve these cases.

Speciﬁcally, when comparing z_w1d and z_w2d redshift es-
timations, the two values coincide for 93% of the galaxies in
our test catalogue. This means that 7% of the galaxies are multi-
peaked (similar to panel 5 and 6 in Fig. 22). In general, there
are no excellent redshift estimators for these cases. We ﬁnd that
z_w1d performs a little bit better having 17.9% of galaxies with
multi-peaked PDFs fall into the J-PAS accuracy limit compared
to the 7.9% with z_w2d. When compared directly, for 62.8% of
these galaxies, the z_w1d value is closer to the spectroscopic
redshift than the z_w2d value. When also taking into account the
z_ml1d and z_ml2d estimators, z_w1d value is closest to the
spectroscopic redshift for 35.0% of them and also remains the
most accurate TOPz estimator within the J-PAS accuracy limit.
Table 2 summarises the performance of the four TOPz redshift
estimators for galaxies with multi-peaked PDFs. Although, on
average, z_w1d performed the best out of the current TOPz red-
shift estimators, there are still speciﬁc cases where other estima-
tors are better thus a more robust estimator selection could be
made with more available data.

7. Conclusion and discussion

We have developed a software package TOPz for template-based
photometric redshift estimation, speciﬁcally designed for the
forthcoming multi-ﬁlter narrow-passband J-PAS survey data. We
applied TOPz on the precursor observations to the J-PAS, the
miniJPAS, and compared the redshift estimations to the spectro-
scopic redshifts from the DEEP2, DEEP3, and SDSS observa-
tions. The spectral templates of galaxies were generated on the
basis of the actual miniJPAS sources using the synthetic spec-
trum generation software CIGALE. We showed that reducing
the number of base templates improves the photo-z accuracy and
that the number of optimal templates depends on the brightness
cut of a given galaxy sub-sample. We also showed that apply-
ing the photo-z priors as well as correcting the photometry using
the template library can further improve the accuracy. We ﬁnd
that, using the redshift estimations from TOPz, the overall num-
ber of galaxies satisfying the J-PAS redshift accuracy goal is on
par with previous results. However, as both the observed area
of miniJPAS as well as the number of observed galaxies with
known spectroscopic redshifts are quite small, the statistical un-
certainties reduce the possibilities for a more detailed assessment
of the results and the veriﬁcation of speciﬁc choices made in the

Fig. 22. Examples of diﬀerent redshift PDF shapes. Spectroscopic red-
shift values are marked with vertical black dotted lines and TOPz red-
shift estimations (z_w1d) with dashed blue lines.

CRPS score is lower than it was for the original catalogue, mean-
ing that the PDFs are, on average, better deﬁned. Therefore, we
can conclude that the photometric uncertainties of the miniJPAS
catalogue are under-valuated. Although, the PDFs are better de-
scribed with increased uncertainties, the resulting redshift esti-
mates are ∼ 2% worse than what we achieved in Sect. 6.2. In
order to to keep the best redshift estimates while having better
calibrated PDFs, one option is to apply a contrast correction to
the original PDFs as was done by Hernán-Caballero et al. (2021).
The redshift PDFs of diﬀerent galaxies can be quite di-
verse as the accuracy of the observed photometry will cause
various interactions with the templates. Some examples of the
PDF shapes are given in Fig. 22 with the black dotted line
marking the spectroscopic redshift and the dashed blue line the
TOPz weighted (z_w1d) redshift estimation. With very promi-
nent emission lines, the PDF shapes would have a single sym-
metrically narrow peak. In more general cases, some PDF shapes
are relatively simple with one maximum and slightly lopsided
wings (panel 1 and 2) whereas other shapes can be more com-
plex with multiple peaks and valleys. The latter cases stem from
photometric uncertainties as well as from the types of templates
dominating in the PDF construction. There are tougher cases
where the templates get quite similar χ2 values for a wider area
around the true redshift while diﬀerent types of galaxy tem-
plates have their maximum set at diﬀerent redshifts. When we
marginalise them into the PDF, we are left with a shape where
the spectroscopic redshift is at the secondary maximum on the
side of a more dominant peak (panel 3 and 4). This is the main
motivation to prefer the weighted average around the maximum
(z_w1d) instead of the peak location, as the former takes into
account also the lopsidedness of the PDF without losing much

Article number, page 16 of 20

0.290.300.31  0.250.500.751.00  10.2800.2850.290    20.520.540.56  0.250.500.751.00  30.360.370.38    40.60.7  0.250.500.751.00  50.20.40.6    6probability densityphotometric redshiftJ. Laur et al.: TOPz: Photometric redshifts for J-PAS

workﬂow. With future observations, the results could be further
improved by using better-calibrated templates, priors, and other
input information.

In particular, an important J-PAS-speciﬁc improvement in
TOPz is the possibility to take into account the dependence of
the central wavelengths of the ﬁlter transmission bands on the
incident angle of the light path (Benitez et al. 2014). This depen-
dence means that each galaxy in each ﬁlter is observed through
a slightly diﬀerent passband depending on the physical position
of the galaxy’s image on the surface of the ﬁlter during an ex-
posure. As only the average passband of each ﬁlter of J-PAS is
provided at the moment, taking such passband shifts into account
would improve the match between synthetic and J-PAS photom-
etry. Currently, this information is lost during the combination
of diﬀerent exposures into ‘tiles’, but can be taken into account
with the main J-PAS data releases. For more detailed analysis on
how we expect the results to improve, see Appendix. A.

A number of required and optional inputs (see Sect. 3.1) af-
fect the resulting photometric redshift estimations with TOPz.
Unfortunately, the eﬀects of these inputs are often degenerate
and a set of inputs that improve the results separately might not
do so when combined. TOPz is most strongly aﬀected by the
input templates, observational data quality, the accuracy of the
uncertainty estimates, and photo-z priors.

Out of the listed factors, we only had considerable control
over the templates. We tested diﬀerent approaches for optimis-
ing the set of templates. The optimal base template set depends
on the overall conﬁguration of the workﬂow (with priors, with-
out priors, with priors and added corrections, and so on). In ad-
dition, inputs that produce good results with one observational
data set may not be the best for others. Most notably, template
set tuned for brighter sources is not optimal for fainter, noise-
dominated sources. The same may apply for the targeted redshift
range; however, the current data did not allow us to investigate
such dependencies. Similarly, we can expect that more sophisti-
cated prior, which considers the expected abundance of a given
spectral type at a given redshift, can further improve the accuracy
of redshifts. The necessary observational information can come
from the same data being analysed, but the number of sources
has to be considerably larger. For best results, it is necessary to
adjust the inputs separately for each speciﬁc set of data and also
the science goal.

On a ﬁnal note, the maximum as well as the overall distri-
bution of the redshift accuracy histogram are slightly shifted to-
wards positive values (see Fig. 16). This means that, on average,
the photometric redshifts are overestimated. The same holds true
for the photometric redshifts available in the miniJPAS database,
described in more detail in Hernán-Caballero et al. (2021). The
shift seems to be independent on the method used to extract the
photometric redshifts and might thus be caused by some hidden
aspect of the miniJPAS data. Regardless of the underlying rea-
son, a simple systematic shift applied to all photo-z estimations
would improve the overall accuracy. A more detailed analysis of
this systematic eﬀect must wait for larger data sets from future
observations.

This work was meant as a precursor to the photometric red-
shift estimations for the full J-PAS observations as well as any
other large-scale photometric redshift survey. As the number of
galaxies in miniJPAS that also have reliable spectroscopic red-
shift measurements is small, we expect that some of the prob-
lems and limitations we faced will not be present in the full sur-
vey. The same should hold true for the systematic observational
eﬀects that miniJPAS data exhibited as the telescope setup will
be diﬀerent in several aspects, including the camera, ﬁlter tray

system, and the ﬁeld of view. Thus, while we showed that the
combination of TOPz and miniJPAS data generally already ful-
ﬁls the expectations for J-PAS redshift accuracy, we expect some
further improvement once the actual full J-PAS data start to be-
come available.

Acknowledgements. We thank the anonymous referee for useful comments and
suggestions, which have enabled us to improve the paper. Part of this work was
supported by institutional research funding IUT40-2, JPUT907, PSG700 and
PRG1006 of the Estonian Ministry of Education and Research. We acknowledge
the support by the Centre of Excellence ’Dark side of the Universe’ (TK133)
ﬁnanced by the European Union through the European Regional Development
Fund. J.C.M. acknowledges partial support from the Spanish Ministry of Sci-
ence, Innovation and Universities (MCIU/AEI/FEDER, UE) through the grant
PGC2018-097585-B-C22. L.A.D.G. and R.M.G.D. acknowledge ﬁnancial sup-
port from the State Agency for Research of the Spanish MCIU through the
’Center of Excellence Severo Ochoa’ award to the Instituto de Astrofísica de
Andalucía (SEV-2017-0709) and to the projects PID2019-109067-GB100 and
AYA2016-77846-P. J.A.F.O. acknowledges the ﬁnancial support from the Span-
ish Ministry of Science and Innovation and the European Union – NextGenera-
tionEU through the Recovery and Resilience Facility project ICTS-MRR-2021-
03-CEFCA. This work is based on observations made with the JST/T250 tele-
scope and JPCam at the Observatorio Astrofísico de Javalambre (OAJ), in Teruel,
owned, managed, and operated by the Centro de Estudios de Física del Cosmos
de Aragón (CEFCA). We acknowledge the OAJ Data Processing and Archiv-
ing Unit (UPAD) for reducing and calibrating the OAJ data used in this work.
Funding for the J-PAS Project has been provided by the Governments of Spain
and Aragón through the Fondo de Inversión de Teruel, European FEDER fund-
ing and the Spanish Ministry of Science, Innovation and Universities, and by the
Brazilian agencies FINEP, FAPESP, FAPERJ and by the National Observatory of
Brazil with additional funding also provided by the Tartu Observatory and by the
J-PAS Chinese Astronomical Consortium. This paper has gone through internal
review by the J-PAS collaboration.

References

Aihara, H., Arimoto, N., Armstrong, R., et al. 2018, PASJ, 70, S4
Almeida-Fernandes, F., SamPedro, L., Herpich, F. R., et al. 2022, MNRAS, 511,

4590

Ansari, Z., Agnello, A., & Gall, C. 2021, A&A, 650, A90
Ascaso, B., Benítez, N., Dupke, R., et al. 2016, MNRAS, 456, 4291
Ascaso, B., Benítez, N., Fernández-Soto, A., et al. 2015, MNRAS, 452, 549
Battisti, A. J., da Cunha, E., Grasha, K., et al. 2019, ApJ, 882, 61
Beck, R., Dobos, L., Budavári, T., Szalay, A. S., & Csabai, I. 2017, Astronomy

and Computing, 19, 34

Benítez, N. 2000, ApJ, 536, 571
Benitez, N., Dupke, R., Moles, M., et al. 2014, arXiv e-prints, arXiv:1403.5237
Benítez, N., Gaztañaga, E., Miquel, R., et al. 2009, ApJ, 691, 241
Bonoli, S., Marín-Franch, A., Varela, J., et al. 2021, A&A, 653, A31
Boquien, M., Burgarella, D., Roehlly, Y., et al. 2019, A&A, 622, A103
Brammer, G. B., van Dokkum, P. G., & Coppi, P. 2008, ApJ, 686, 1503
Carrasco Kind, M. & Brunner, R. J. 2013, MNRAS, 432, 1483
Carrasco Kind, M. & Brunner, R. J. 2014, MNRAS, 442, 3380
Cenarro, A. J., Moles, M., Cristóbal-Hornillos, D., et al. 2019, A&A, 622, A176
Chaves-Montero, J., Angulo, R. E., & Hernández-Monteagudo, C. 2018, MN-

RAS, 477, 3892

Coe, D., Benítez, N., Sánchez, S. F., et al. 2006, AJ, 132, 926
Cooper, M. C., Aird, J. A., Coil, A. L., et al. 2011, ApJS, 193, 14
Davis, M., Guhathakurta, P., Konidaris, N. P., et al. 2007, ApJ, 660, L1
Díaz-García, L. A., Cenarro, A. J., López-Sanjuan, C., et al. 2019, A&A, 631,

A156

Díaz-García, L. A., Cenarro, A. J., López-Sanjuan, C., et al. 2015, A&A, 582,

A14

Eriksen, M., Alarcon, A., Cabayol, L., et al. 2020, MNRAS, 497, 4565
Gomes, Z., Jarvis, M. J., Almosallam, I. A., & Roberts, S. J. 2018, MNRAS,

475, 331

González Delgado, R. M., Díaz-García, L. A., de Amorim, A., et al. 2021, A&A,

649, A79

Graham, M. L., Connolly, A. J., Ivezi´c, Ž., et al. 2018, AJ, 155, 1
Greisel, N., Seitz, S., Drory, N., et al. 2015, MNRAS, 451, 1848
Hernán-Caballero, A., Varela, J., López-Sanjuan, C., et al. 2021, A&A, 654,

A101

Hildebrandt, H., Arnouts, S., Capak, P., et al. 2010, A&A, 523, A31
Hildebrandt, H., Köhlinger, F., van den Busch, J. L., et al. 2020, A&A, 633, A69
Hogan, R., Fairbairn, M., & Seeburn, N. 2015, MNRAS, 449, 2040
Ilbert, O., Arnouts, S., McCracken, H. J., et al. 2006, A&A, 457, 841
Izquierdo-Villalba, D., Angulo, R. E., Orsi, A., et al. 2019, A&A, 631, A82

Article number, page 17 of 20

A&A proofs: manuscript no. topz

Lee, B. & Chary, R.-R. 2020, MNRAS, 497, 1935
López-Sanjuan, C., Tempel, E., Benítez, N., et al. 2017, A&A, 599, A62
López-Sanjuan, C., Varela, J., Cristóbal-Hornillos, D., et al. 2019, A&A, 631,

A119

Mendes de Oliveira, C., Ribeiro, T., Schoenell, W., et al. 2019, MNRAS, 489,

241

Moles, M., Benítez, N., Aguerri, J. A. L., et al. 2008, AJ, 136, 1325
Molino, A., Benítez, N., Moles, M., et al. 2014, MNRAS, 441, 2891
Newman, J. A., Cooper, M. C., Davis, M., et al. 2013, ApJS, 208, 5
Polsterer, K. L., D’Isanto, A., & Gieseke, F. 2016, arXiv e-prints,

arXiv:1608.08016

Queiroz, C., Abramo, L. R., Rodrigues, N. V. N., et al. 2022, arXiv e-prints,

arXiv:2202.00103

Rodriguez, F., Gonzalez, E. J., O’Mill, A. L., et al. 2020, A&A, 634, A123
Sadeh, I., Abdalla, F. B., & Lahav, O. 2016, PASP, 128, 104502
Salvato, M., Ilbert, O., & Hoyle, B. 2019, Nature Astronomy, 3, 212
Schmidt, S. J., Malz, A. I., Soo, J. Y. H., et al. 2020, MNRAS, 499, 1587
Tanaka, M. 2015, ApJ, 801, 20
Tanaka, M., Coupon, J., Hsieh, B.-C., et al. 2018, PASJ, 70, S9
Walcher, J., Groves, B., Budavári, T., & Dale, D. 2011, Ap&SS, 331, 1
Williams, R. E., Blacker, B., Dickinson, M., et al. 1996, AJ, 112, 1335
Wittman, D., Bhaskar, R., & Tobin, R. 2016, MNRAS, 457, 4005
Wright, A. H., Hildebrandt, H., van den Busch, J. L., & Heymans, C. 2020, A&A,

637, A100

Article number, page 18 of 20

J. Laur et al.: TOPz: Photometric redshifts for J-PAS

Appendix A: Assessing the effect of miniJPAS ﬁlter

passbands on the redshift estimation.

In order to estimate photometric redshifts, one required input to
the photo-z code is the transmission curve of the optical sys-
tem through which the object is observed. An important com-
ponent in this total transmission curve is the ﬁlter transmission
which can diﬀer depending on the incident angle of the light.
This change in the transmission has been measured for every
miniJPAS ﬁlter on a 13 by 12 grid covering the full physical sur-
faces of the ﬁlters (see Fig. A.1). The top panels on Fig. A.1
give an indication how much the transmission can change due
to the incident angle of the light and the bottom panels show
the central wavelength diﬀerence when compared to the average
passband in that ﬁlter. As can be seen on the bottom panel, the
change in the central wavelength of the transmission curves do
vary smoothly across a single ﬁlter but the overall shape diﬀers
a lot from ﬁlter to ﬁlter. Therefore, it is hard to predict what the
total eﬀect of these changes are when all of the ﬁlters are used
together in the photo-z codes.

Right now, it is not possible to determine which part of the
ﬁlter was used in the actual miniJPAS observations and there-
fore no tests can be done using the observed catalogue. We tried
to estimate the eﬀect of the transmission curve diﬀerences on
the redshift estimation by simulating the observations as if ob-
served through diﬀerent areas on this 13 by 12 grid. For this, we
used the remaining templates that were left after the template se-
lection process described in Sec. 5.2 and constructed redshifted
synthetic photometry catalogues for seven ﬁxed areas from the
13 by 12 grid. Each catalogue consists of synthetic observations
from all of the remaining templates in all of the miniJPAS ﬁlters
and as if observed through the same passband that is measured
through the selected area on every ﬁlter. As the templates them-
selves were calculated using actual miniJPAS observations, we
could simulate synthetic observational uncertainties by applying
a gaussian error to the synthetic photometry using the actual pho-
tometric errors measured in each corresponding ﬁlter. Then, the
synthetic catalogues were run through TOPz workﬂow to com-
pare how the resulting photo-z accuracy changed depending on
the passbands applied to the templates. To get an idea of the ef-
fect of the applied observational uncertainties, we ran each sim-
ulation three times.

Figure A.2 shows the accuracy of photometric redshift es-
timations through TOPz depending on whether the input pass-
bands are given as average passbands or as ﬁlter area speciﬁc
passbands. The x-axis shows the relative distance from the ﬁlter
centre and all of the selected ﬁlter areas are directed towards the
lower-left corner of the ﬁlter. Every marking at diﬀerent distance
value consists of simulations where a synthetic photometry cat-
alogue is constructed as if observed through that speciﬁc area
on the ﬁlter and the colour indicate the passband that is given
as an input during a single TOPz run. Blue markings are shifted
for visual clarity and should be counted as coinciding with the
nearby green markings. Accuracy errors on Fig. A.2 are calcu-
lated as a standard deviation of the three simulation runs where
the photometric errors in each synthetic catalogue were applied
in a random manner. Keep in mind that the ﬁlter transmission
measurements are actually made on a grid so the relative dis-
tance from the ﬁlter centre in Fig. A.2 notes a single rectangular
area on the ﬁlter. As the shapes of the central wavelengths dif-
ferences are not radially symmetric, the results should diﬀer if
moving into any other direction from the centre. Nevertheless, it
can be seen that in almost every ﬁlter area, the accuracy is bet-
ter when a speciﬁc passband for that area is used as opposed to

the mean passband that we used throughout the analysis in this
paper. Therefore, in order to improve the photometric redshift es-
timations in the full J-PAS catalogue, it is necessary to map the
CCD coordinates of the J-PAS observations to the actual physi-
cal coordinates on the ﬁlter and then use this info to construct a
diﬀerent passband tailor-made for each observed object.

Article number, page 19 of 20

A&A proofs: manuscript no. topz

Fig. A.1. Measured passbands and their overall shape on the physical ﬁlter for three diﬀerent J-PAS ﬁlter. All the passbands (top panel) on a single
ﬁlter were measured in a 12 by 13 grid (bottom panel). Darker blue lines on the top panels show the two most opposed transmission curves of that
ﬁlter. The colourbar on the bottom panels indicates each passband’s central wavelength diﬀerence from the mean passband.

Fig. A.2. Eﬀect of the variable ﬁlter passband on the redshift estimation
accuracy. Blue markers note the accuracy when the average passband
is used and green markers when the speciﬁc passband is used. The rel-
ative distance shows the physical distance from the centre of the ﬁlter
towards the lower-left corner. Blue markers are slightly separated for
visual clarity.

Article number, page 20 of 20

380039004000wavelength (Å)J0390642024730074007500wavelength (Å)J074010505830084008500wavelength (Å)J084010505100.00.20.40.60.81.0relative distance from filter center7172737475% objects with dz < 0.003mean passbandactual passband