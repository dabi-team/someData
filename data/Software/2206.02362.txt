2
2
0
2

n
u
J

6

]
h
p
-
o
e
g
.
s
c
i
s
y
h
p
[

1
v
2
6
3
2
0
.
6
0
2
2
:
v
i
X
r
a

FULL WAVEFORM INVERSION BY MODEL EXTENSION:
PRACTICAL APPLICATIONS

Guillaume Barnier
Geophysics Department
Stanford University
Stanford, CA 94305
gbarnier@sep.stanford.edu

Ettore Biondi
Seismology Laboratory
California Institute of Technology
Pasadena, CA 91125
ettore88@sep.stanford.edu

Robert G. Clapp
Geophysics Department
Stanford University
Stanford, CA 94305
bob@sep.stanford.edu

Biondo Biondi
Geophysics Department
Stanford University
Stanford, CA 94305
biondo@sep.stanford.edu

June 7, 2022

ABSTRACT

Producing reliable acoustic subsurface velocity models still remains the main bottleneck of the
oil and gas industry’s traditional imaging sequence. In complex geological settings, the output of
conventional ray-based or wave-equation-based tomographic methods may not be accurate enough
for full waveform inversion (FWI) to converge to a geologically satisfactory Earth model. We create
a new method referred to as full waveform inversion by model extension (FWIME) in which a wave-
equation migration velocity analysis (WEMVA) technique is efﬁciently paired with a modiﬁed version
of FWI. We show that our method is more powerful than applying WEMVA and FWI sequentially, and
that it is able to converge to accurate solutions without the use of a good initial guess or low-frequency
energy. We demonstrate FWIME’s potential on ﬁve realistic and challenging numerical examples that
simulate complex geological scenarios often encountered in hydrocarbon exploration. We guide the
reader step by step throughout the optimization process. We show that our method can simultaneously
invert all wave types with the same simple mechanism and without the need for a user-intensive
hyper-parameter tuning process. In an online repository, we provide a fully-reproducible open-source
software solution implemented with general-purpose graphics processing units (GPU) and with a
user-friendly Python interface.

1

Introduction

Seismic imaging is the most ubiquitous and effective method for subsurface hydrocarbon exploration. Energy companies
rely on good-quality images to ensure safety and efﬁciency during exploration, drilling and production. However,
reliable images of the subsurface can be quite challenging to generate in certain geological settings where complex
overburdens are encountered. The main difﬁculty within this process is to obtain accurate seismic velocity models
of the subsurface. Small errors rapidly degrade the image quality and may lead to erroneous interpretations. Due
to the high-dimensional nature of the unknown model space and the large amount of seismic data to process, the
velocity-estimation step is typically recast as a nonlinear optimization problem such as acoustic full waveform inversion
(FWI), and numerically solved using gradient-descent algorithms [1, 2, ]. In the last two decades, the increasing
availability of high-performance computing (HPC) resources combined with the advent of general-purpose graphics
processing units (GPU) enabled the industry to routinely conduct successful FWI production workﬂows on 3D ﬁeld
datasets, thereby obtaining substantial uplifts in structural image quality and higher-resolution Earth models [3, 4, 5, ].

 
 
 
 
 
 
A PREPRINT - JUNE 7, 2022

The ﬁrst drawback hampering FWI is the need to start the inversion scheme with an accurate model. Failing to satisfy
this condition may lead gradient-descent optimization algorithms to converge to local minima present in the FWI
objective function [6, ]. This effect can be mitigated by employing long-offset low-frequency data (with suitable
signal-to-noise ratio) in conjunction with a data-space multi-scale approach [7, 8, 9, ]. However, acquiring such type of
signal is often too impractical or costly, even with the recent advancements in the design of low-frequency sources and
ultra-long offset ocean-bottom node (OBN) surveys [10, 11, 12, 13, ]. To solve this issue, the conventional imaging
process usually begins by applying a tomographic algorithm such as migration velocity analysis (MVA), with which
an accurate low-resolution velocity model is produced and used as an initial guess for FWI [14, 15, 16, 17, 18, ].
Unfortunately, in certain geological scenarios, the output of the tomographic step is not precise enough for FWI to
converge to a useful solution, which leaves an information gap between the two families of techniques [19, ]. Moreover,
even if the initial model is accurate enough, conventional FWI must often be modiﬁed or adapted to the type of
waves used for the inversion. This tedious tuning and data-selection process gave rise to a multitude of ad hoc FWI
variants that require intensive human inputs, thereby making their application challenging for non-expert geophysicists.
Finally, FWI’s computational burden may still limit the use of costly numerical schemes capable of modeling more
realistic physics such as anisotropic or visco-elastic effects. Therefore, the acoustic approximation (commonly made
for production workﬂows) can prevent the inversion from recovering useful elastic and petrophysical properties of
hydrocarbon reservoirs.

Promising approaches have been developed to improve the convergence properties of conventional FWI by designing
more convex objective functions [20, ]. This goal is achieved by either extending the unknown model search space
[21, 22, 23, 24, 25, 26, 27, 28, ], by relaxing certain constraints related to the physics of the problem [29, 30, 31, 32,
33, 34, 35, ], or by measuring the data misﬁt with a more appropriate norm [36, 37, 38, ].

We build upon the idea introduced by [21] and [23] which consists in using the concept of extended modeling as a
tool to pair a wave-equation migration velocity analysis (WEMVA) approach with conventional FWI into a single
workﬂow. We propose a novel method, full waveform inversion by model extension (FWIME). Our goal is to bridge
the information gap previously discussed and produce consistent acoustic seismic velocity models by inverting any
type of surface (or borehole) seismic data without requiring accurate initial models or low-frequency long-offset
recordings. We make our workﬂow automatic by reducing the necessity for human inputs and by limiting the number
of hyper-parameters to adjust in our cost function. In addition, we simultaneously invert the full dataset (which may
include all wave types and all frequencies), thereby mitigating the need for tedious data selection or ﬁltering. Hence,
our method is consistently applied with the exact same mechanism, regardless of the geological scenario.

In a companion paper [39, ], we provide an exhaustive description of the theory, design, and optimization scheme for
FWIME. In this paper, we focus on the method’s applications and we give practical implementation details on how to
efﬁciently conduct FWIME and select the optimal hyper-parameter values. We thoroughly guide the reader step by
step through a sequence of ﬁve realistic 2D tests, which simulate some of the most challenging geological scenarios
encountered in ﬁeld exploration. We demonstrate FWIME’s ability to automatically and simultaneously invert complex
datasets composed of all types of waves. In each scenario, the recorded signal lacks low-frequency energy and the
initial model is inaccurate. Such conditions are quite common in ﬁeld-data applications, and lead standard methods to
fail at recovering useful Earth models.

We begin with a brief summary of the theory and design of FWIME. Then, we present our results on ﬁve numerical tests.
In the ﬁrst example, we invert cycle-skipped data dominated by reﬂected events generated by the Marmousi2 model
[40, ]. Additionally, we assess the effect of coherent noise by inverting an analogous dataset containing free-surface
multiples. We show that for a shallow water layer, the presence of free-surface multiples can hamper the quality of
the FWIME solution. The second example focuses on the use of refracted energy (diving waves) to simultaneously
retrieve high- and low-resolution features from the North Sea region of the 2004 BP model [41, ]. The third example is
conducted on a model created and shared by the Seiscope consortium, which is designed to assess the robustness of
FWIME against the ill-posedness coming from wrong association of predicted and observed waveforms. In the fourth
test, we leverage recorded signal from ultra-long offset surveys (which contains a mix of reﬂected and refracted energy)
to successfully recover a salt body without the use of low-frequency data and by starting from a pure sediment model.
In the last example, we highlight some current limitations of our method at dealing with complex overburdens and
we propose potential research directions to address these limitations. Finally, we discuss the computational aspects
of FWIME (numerical implementation and computational cost). In addition, all numerical examples proposed in this
paper are fully reproducible and can be freely accessed (along with our open-source software solution) on our online
repository.

2

A PREPRINT - JUNE 7, 2022

2 FWIME theory

We summarize of the theory of full waveform inversion by model extension (FWIME). We describe the design of
our objective function, we discuss the concept of extended modeling, and we introduce the model-space multi-scale
approach employed in our inversion scheme. A more thorough explanation with detailed mathematical derivations can
be found in our complementary paper [42, ].

2.1 Formulation

We minimize the FWIME objective function deﬁned by

Φ(cid:15)(m) =

1
2

(cid:13)
(cid:13)f (Sm) + ˜B(Sm)˜popt
(cid:13)

(cid:15)

(Sm) − dobs(cid:13)
2
(cid:13)
(cid:13)
2

+

(cid:15)2
2

(cid:13)
(cid:13)D˜popt
(cid:15)

(Sm)(cid:13)
2
2 ,
(cid:13)

(1)

where m is the (non-extended) acoustic velocity model parametrized on a spline grid, and S is a linear spline
interpolation operator that maps models from a coarse grid onto a ﬁnite-difference grid [43, ]. f is the waveﬁeld
generated by an acoustic isotropic constant-density two-way wave-equation operator (extracted at some predeﬁned
receivers’ locations), and ˜B denotes the Born modeling operator extended with either time lags or horizontal subsurface
offsets [23, 44, ]. In this paper, all extended operations and operators are denoted by the ∼ symbol. dobs is the observed
data, and the diagonal matrix D is an invertible modiﬁed version of the differential semblance optimization (DSO)
operator that penalizes defocused energy within extended images [45, ]. (cid:15) is the ﬁxed trade-off parameter that balances
the two components of the objective function. The variable ˜popt
is always parametrized on the ﬁnite-difference grid,
and is deﬁned as the minimizer of the quadratic objective function Φ(cid:15),m (for a constant m),

(cid:15)

Φ(cid:15),m(˜p) =

1
2

˜B(Sm)˜p − (cid:2)dobs − f (Sm)(cid:3)(cid:13)
(cid:13)
2
(cid:13)
(cid:13)
(cid:13)
(cid:13)
2

+

(cid:15)2
2

(cid:107)D˜p(cid:107)2
2 .

The Hessian matrix of Φ(cid:15),m is given by the following expression,

HΦ(cid:15),m = ˜B∗(Sm) ˜B(Sm) + (cid:15)2D∗D,

(2)

(3)

where ∗ symbolizes adjoint operations. For (cid:15) > 0, Φ(cid:15),m is the sum of a real symmetric positive semi-deﬁnite matrix
˜B∗(Sm) ˜B(Sm) and a real symmetric positive deﬁnite matrix, D∗D, so Φ(cid:15),m is a real symmetric positive deﬁnite
matrix. Therefore, there exists a unique minimizer of Φ(cid:15),m, referred to as the optimal extended perturbation, denoted
by ˜popt
(cid:15)

. Its expression is given by the normal equation,

˜popt
(cid:15)

(Sm) = ˜B†

(cid:15),D(Sm) (cid:2)dobs − f (Sm)(cid:3) ,

where ˜B†

(cid:15),D is the pseudo-inverse of ˜B in equation 2:

˜B†

(cid:15),D(Sm) =

(cid:104) ˜B∗(Sm) ˜B(Sm) + (cid:15)2D∗D

(cid:105)−1

˜B∗(Sm).

(4)

(5)

The minimization of equation 2 corresponds to the variable projection step of FWIME and is conducted with a linear
conjugate-gradient scheme [46, 47, ]. The number of iterations needed for convergence is problem-dependent, but
in practice, we observe that approximately 50 iterations are usually necessary, for both 2D and 3D applications. The
estimation of ˜popt
is equivalent to conducting an extended least-square reverse-time migration [48, ], and it is the main
computational bottleneck of our algorithm. Finally, the nonlinear objective function deﬁned in equation 1 is minimized
with L-BFGS.

(cid:15)

2.2 Preventing “cycle-skipping" with extended modeling

The main idea driving FWIME is that in equation 1, we modify the conventional FWI objective function by adding a
data-correcting term ˜B(Sm)˜popt
(Sm) to ensure phase alignment between modeled and observed data. This terms

(cid:15)

3

A PREPRINT - JUNE 7, 2022

corresponds to the extended Born modeling (also referred to as extended demigration) of the extended perturbation
. It has been shown that for an appropriate extension and extended Born modeling operator ˜B, there exists such a
˜popt
(cid:15)
˜popt
that satisﬁes
(cid:15)

˜B(Sm)˜popt

(cid:15)

(Sm) ≈ dobs − f (Sm).

(6)

(cid:15)

For extremely inaccurate velocity models m, this property is only valid if ˜popt
is extended [21, ]. With this powerful
tool, we are able to construct a new forward modeling operator such that f (Sm) + ˜B(Sm)˜popt
(Sm) ≈ dobs at
any given precision, thereby mitigating the cycle-skipping phenomenon. For a ﬁxed velocity model m, the level of
data-matching is controlled by the value of (cid:15): lower (cid:15)-values are such that equation 6 is satisﬁed with more accuracy,
and vice-versa. However, preventing cycle-skipping (a data-space phenomenon) is not sufﬁcient to guarantee that the
objective function deﬁned in equation 1 is free of local minima. Therefore, an annihilating component is added to our
objective function (second term on the right side of equation 1), whose goal is to gradually reduce the contributions of
the correcting term with iterations. This task can be achieved by penalizing the energy within ˜popt
. Eventually, when
f (Sm) is able to accurately predict dobs without the help of the data-correcting term (and with S = Id), the inversion
has converged to the global solution. In our complementary paper, we illustrate how this annihilating term is similar to
a wave-equation migration velocity analysis (WEMVA) objective function. As a result, FWIME can be interpreted as a
combination of a modiﬁed FWI (ﬁrst component of equation 1) and WEMVA (second component of equation 1) into a
robust workﬂow that is more powerful than applying each technique separately or sequentially. In this paper, however,
we do not prove mathematically that our new formulation is free of local minima but we show numerical evidence.

(cid:15)

(cid:15)

2.3 Optimization

Equation 1 is minimized using a local optimization method and its gradient is composed of two terms,

∇mΦ(cid:15)(m) = ∇mΦBorn

(cid:15)

(m) + ∇mΦT omo

(cid:15)

(m),

with

∇mΦBorn
(cid:15)
∇mΦT omo
(cid:15)

(m) = S∗B∗(Sm) r(cid:15)
(m) = S∗T∗(Sm, ˜popt

d(Sm),
) r(cid:15)

(cid:15)

d(Sm),

(7)

(8)

(9)

d(Sm) = f (Sm) + ˜B(Sm)˜popt

where r(cid:15)
(Sm) − dobs is the adjoint source, B∗ is the adjoint of the non-extended
Born modeling operator, T∗ is the adjoint of the data-space tomographic operator [44, ], and S∗ is the adjoint of the
spline interpolator, which maps a model from the ﬁnite-difference grid onto a coarser spline grid. The Born gradient
∇mΦBorn
is similar to the conventional FWI gradient (and tends to guide the inversion to local minima at early stages
(cid:15)
when the initial model is poor). The tomographic component ∇mΦT omo
is responsible for recovering the missing
long-wavelength components of the velocity model, thereby mitigating the presence of local minima.

(cid:15)

(cid:15)

Our new FWIME formulation is paired with the model-space multi-scale workﬂow proposed by [43]. The full data-
bandwidth is simultaneously inverted and the resolution of the model updates is controlled by the spatial sampling of
the spline grid on which the velocity model m is parametrized. We begin with a coarse grid to enforce smooth updates
and we progressively reﬁne the spline sampling with iterations. The inverted model on a spline grid is taken as an initial
guess for the inversion on a ﬁner grid, and the last grid usually coincides with the ﬁnite-difference grid. Among many
beneﬁts, this multi-scale strategy prevents the inversion scheme from embedding spurious high-resolution artifacts at
early stages, such as migration isochrones [49, 50, ], and greatly improves the convergence properties of FWIME.

3 Marmousi2

The Marmousi2 synthetic model simulates a geologically complex subsurface structure and is well-suited for calibrating
velocity-model building algorithms [40, ]. We use this benchmark test to show that FWIME can successfully invert
reﬂection-dominated datasets and recover accurate solutions without the need for low-frequency signal or good initial
guesses. Compared to the original Marmousi [51, ], this model is wider and more representative of current long-offset
offshore acquisition geometries. The sediments are placed under a thicker layer of water of approximately 475 m,
which reduces the presence of refracted energy recorded in the data. Finally, additional hydrocarbon reservoirs and
stratigraphic features have been added to increase the overall geological complexity of the model [52, ].

4

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 1: 2D panels of velocity models. (a) Initial model. (b) Inverted model after conventional data-space multi-scale
FWI using ﬁve frequency bands. (c) Final FWIME inverted model. (d) True model.

3.1 Presentation and challenges

The true model mtrue is 17 km wide and 3.5 km deep (Figure 1(d)). The initial model minit is purposely designed
to be inaccurate (Figure 1(a)). Below the water layer (the bathymetry is assumed to be known for this problem), the
velocity is laterally invariant and linearly increasing with depth. Velocity proﬁles of the true and initial models extracted
at four horizontal positions are displayed in Figure 2 (red and and black curves). We place 140 sources every 120 m,
and 567 ﬁxed receivers every 30 m. All acquisition devices are located 30 m below the water surface. We generate
noise-free pressure data with a source wavelet containing energy restricted to the 4-13 Hz range (Figure 3(a)), a uniform
ﬁnite-difference grid spacing of 30 m, and we use absorbing-boundary conditions in all directions [53, ]. The data
are modeled and inverted with an acoustic isotropic constant-density two-way wave-equation operator. Figures 4a
and 4d show two representative shot gathers for sources placed at x = 1.2 km and x = 8.4 km. Even though some
refracted energy is recorded at offsets larger than 7 km, the dataset is strongly dominated by reﬂected events. Figures 4b
and 4e show that the initial prediction f (minit) fails to generate any reﬂection. The inaccuracy of minit coupled
with the lack of low-frequency and refracted energy (i.e., diving waves) make this test challenging for conventional
velocity-model building techniques. To illustrate this claim, we apply data-space multi-scale FWI using ﬁve frequency
bands (Figure 3(b)), which fails to retrieve a useful solution, especially in the deeper section of the model (Figure 1(b)).

3.2 FWIME

We guide the reader through the initial step of FWIME which includes a hyper-parameter-tuning process and the
computation of the initial search direction. Then, we present and carefully analyze the inversion results.

3.2.1 Selection of the extension

The ﬁrst step consists in selecting the optimal extension type and the length of the extended axis for ˜popt
such that
the initial data-correcting term ˜B(minit)˜popt
0 (minit) is able to match the initial data difference dobs − f (minit) (i.e.,
satisfy the condition expressed in equation 6). This condition ensures that without penalizing defocused energy within
˜popt
0 (minit) into the data
(cid:15)
space. Indeed, failing to select an adequate extension length may result in cycle-skipping, which in turn may lead

(i.e., when (cid:15) = 0), the initial prediction error can be fully explained by the mapping of ˜popt

(cid:15)

5

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

Figure 2: Depth velocity proﬁles extracted at (a) x = 6 km, (b) x = 9 km, and (c) x = 11 km, and (d) x = 13 km. The
black curve represents the initial model, the red curve is the true model, and the blue curve is the ﬁnal FWIME inverted
model.

(a)

(b)

Figure 3: Amplitude spectra of the seismic sources used to generate the various datasets for this numerical example. (a)
Source used for the FWIME workﬂow. (b) Sequence of sources used for the data-space multi-scale FWI workﬂow.

FWIME to converge to a local minimum. For computational efﬁciency, we wish to ﬁnd the optimal extension type that
satisﬁes this condition but with the smallest number of points on the extended axis. For that, we minimize the objective
function deﬁned in equation 2 with three different types of extension: using time lags, using horizontal subsurface
offsets, and without any extension (we conduct three separate inversions). For all three inversions, we set m = minit,
S = Id, and (cid:15) = 0.

We test with an extended axis of 101 points for both time lags and subsurface offsets with a sampling of ∆τ = 16
ms and ∆hx = 30 m, respectively. Hence, τ ranges from -0.8 s to 0.8 s, whereas hx ranges from -1.5 km to 1.5 km.
Figure 5(a) shows the normalized convergence curves for the minimization of objective function in equation 2 (the
initial variable projection step) using time lags (blue curve), horizontal subsurface offsets (red curve), and with no
extension (pink curve). As expected, the non-extended inversion fails to reduce the misﬁt to zero. In addition, the
time-lag extension seems to perform better than subsurface offsets as it manages to decrease the objective function value
by approximately 99.4% after 60 iterations of linear conjugate gradient, and by 99.9% after 100 iterations (compared to
96% and 97% for subsurface offsets), thereby satisfying the condition expressed in equation 6 more efﬁciently. Indeed,
a more accurate matching (up to numerical precision) would require more iterations. For this numerical example, we
choose a time-lag extension with a length of 101 points (a very conservative number) sampled at 16 ms, and we limit
the number of linear conjugate gradient iterations to 60 for the variable projection step. In practice, to further reduce the
computational cost for 3D ﬁeld applications, a smaller number of points on the extended axis could have been chosen.

6

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

(f)

Figure 4: Representative shot gathers for sources placed at x = 1.2 km (ﬁrst row) and x = 8.4 km (second row).
Observed data, dobs (ﬁrst column), predicted data with the initial model, f (minit) (second column), and initial
data-difference, ∆d(minit) = dobs − f (minit) (third column). All panels are displayed with the same grayscale.

3.2.2 Selection of the trade-off parameter (cid:15)

(cid:15)

(cid:15)

The second step consists in selecting the optimal (cid:15)-value. This quantity serves as a trade-off parameter that controls the
level of data-ﬁtting by penalizing the presence of energy within ˜popt
during the minimization of the objective functions
deﬁned in equations 1 and 2. To illustrate its effect, we compute ˜popt
(using the initial velocity model minit) for
four (cid:15)-values by minimizing the objective function in equation 2. The corresponding convergence curves are shown
in Figure 5(b). As the (cid:15)-value increases, the ability of the data-correcting term ˜B(minit)˜popt
(minit) to predict the
initial data misﬁt dobs − f (minit) is reduced. Figure 6 shows a time-lag common image gather (TLCIG) extracted at
x = 14 km from the four inverted ˜popt
(corresponding to the four convergence curves shown in Figure 5(b)). Figure 7
represents the difference between the corresponding data-correcting term and the initial FWIME data-residual (the
(minit) − (cid:0)dobs − f (minit)(cid:1).
d(minit) = ˜B(minit)˜popt
adjoint source): r(cid:15)
(cid:15)
For (cid:15) = 0, no constraint is applied to ˜popt
, and therefore a substantial amount of energy is mapped away from the
physical plane, as shown by the green arrows in Figure 6(a). Consequently, the data-correcting term is able to match the
initial data residual with high accuracy, and almost no coherent signal is present within the adjoint source (Figure 7(a)).
Increasing the (cid:15)-value penalizes defocused events within ˜popt
and reduces the amount of energy spread away from the
(cid:15)
physical plane (Figures 6b and c). The data-correcting term is then unable to accurately match the initial data-misﬁt
(Figures 7b and c). Eventually, for an extremely high (cid:15)-value, both ˜popt
and the data-correcting term vanish (Figures 6(d)
(cid:15)
and 7(d)), and r(cid:15)
d(minit) ≈ f (minit) − dobs. Mathematically, setting (cid:15) to a high value corresponds to conducting a
non-extended FWIME, or equivalently, conventional FWI.

(cid:15)

(cid:15)

(cid:15)

7

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 5: Normalized objective functions corresponding to the minimization of equation 2 (initial variable projection
step) with different extensions and (cid:15)-values. (a) Time-lag extension (blue curve), horizontal subsurface-offset extension
(red curve), and non-extended (pink curve). For (a), we set (cid:15) = 0. (b) Time-lag extension with different (cid:15)-values:
(cid:15)1 = 0 (blue curve), (cid:15)2 = 1.5 × 10−5 (red curve), (cid:15)3 = 5.0 × 10−5 (pink curve), and (cid:15)4 = 5.0 × 10−4 (black curve).
In both panels, all curves are normalized by the same value. The blue curves in panels (a) and (b) are identical.

(a)

(b)

(c)

(d)

Figure 6: Time-lag common image gathers (TLCIG) extracted at x = 14 km from ˜popt
(minit) computed with four
different (cid:15)-values. (a) (cid:15) = 0, (b) (cid:15) = 1.5 × 10−5, (c) (cid:15) = 5.0 × 10−5, and (d) (cid:15) = 5.0 × 10−4. All panels are plotted
for τ ∈ [−0.3 s, 0.3 s] for display purposes. However, all the computations are conducted for the full time-lag range
with τ ∈ [−0.8 s, 0.8 s]. All panels are displayed with the same grayscale.

(cid:15)

During the variable projection step, the background velocity model m is ﬁxed, and thus the (cid:15)-value only affects the
amplitude of the events within ˜popt
rather than the kinematics: the reﬂectors’ positions are not affected by (cid:15). In
Figure 6(a) (corresponding to (cid:15) = 0), there are three distinct events located in the extended space at negative time-lag
values (green arrows), which provide valuable information on velocity errors present in the initial model. In this
particular case, they indicate that the initial velocity is too low [44, ].

(cid:15)

On one hand, selecting a too small (cid:15)-value is sub-optimal because the amplitude of the corresponding adjoint source
r(cid:15)
d(minit) (employed in the gradient computation) would not contain any useful information, as its amplitude would be
numerically close to zero (Figure 7(a)). From a physical point of view, a small (cid:15)-value would not penalize defocused
energy within ˜popt
. On the other hand, a too-high (cid:15)-value would force the amplitude of the events in the extended
space to vanish, and the information they carry about velocity errors would be lost (Figure 6(d)). In addition, the
data-correcting term would not be able to match the initial data residual Figures 7(d), resulting in cycle-skipping. For

(cid:15)

8

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

Figure 7: Representative shot gathers generated by a source located at x = 1.2 km displaying the FWIME adjoint
0 (minit) − (cid:0)dobs − f (minit)(cid:1), computed for four different (cid:15)-values (minit is ﬁxed).
source, r(cid:15)
(a) (cid:15) = 0, (b) (cid:15) = 1.5 × 10−5, (c) (cid:15) = 5.0 × 10−5, and (d) (cid:15) = 5.0 × 10−4. All panels are displayed with the same
grayscale.

d(minit) = ˜B(minit)˜popt

this numerical example, we observe that for (cid:15) ∈ [1.5 × 10−5, 5.0 × 10−5], FWIME converges to similar accurate
solutions. In this paper, we propose to select the (cid:15)-value by examining a subset of the TLCIGs extracted from the initial
˜popt
computed with a few (cid:15)-values. We acknowledge the need for a more automatic approach for the selection of (cid:15), but
(cid:15)
we leave such investigation for future work. Fortunately, we observe that our results are relatively insensitive to the
choice of (cid:15) as long as the proper order of magnitude is determined.

3.2.3 Initial search direction

Figure 8 shows the Born, tomographic, and total FWIME initial search directions on the ﬁnite-difference grid computed
with (cid:15) = 1.5 × 10−5 (equations 7-9). The total search direction is mainly guided by the tomographic component
and seems to accurately capture some of the low-wavenumber features present in the ideal update in the shallow
region (by comparing Figures 8c and 8d). However, in panel 8c, the update direction is overwhelmed by spurious
high-wavenumber artifacts. To mitigate this effect, we use an initial coarse spline grid S0 with a sampling of 0.2 km
and 1 km in the vertical and horizontal directions, respectively. Figure 9 shows the analogous panels from Figure 8
after their mapping onto the ﬁrst spline grid (i.e., after applying operator S0S∗
0). As expected, the total FWIME search
direction is improved.

3.2.4 Inversion results

For the FWIME scheme, we use a sequence of four spline grids and we keep the same (cid:15)-value throughout the entire
process ((cid:15) = 1.5 × 10−5). Each spline grid reﬁnement is automatically triggered when the stepper is unable to ﬁnd an
appropriate step length for that particular grid. The spacing in the second and third grids are obtained by halving the
spacing from the previous ones. The ﬁnal spline grid coincides with the ﬁnite-difference grid (∆z = ∆x = 30 m).

Grid number ∆z [km] ∆x [km]

0
1
2
3

0.2
0.1
0.05
0.03

0.9
0.45
0.22
0.03

Table 1: Parameters of the spline grid sequence used for the model-space multi-scale FWIME scheme. Spline 3
coincides with the ﬁnite-difference grid.

Figures 10b-d show the FWIME inverted model after spline 0, 1, and 2, respectively. The ﬁnal FWIME inverted model
after 240 iterations of L-BFGS is shown in Figure 10(e). Even though it suffers from minor edge effects due to the
limited acquisition aperture, it is very accurate, as conﬁrmed by the velocity proﬁles shown in Figure 2 (blue curves).

Figure 11 shows the observed (left column), predicted (middle column), and data-difference (right column) for a source
located at x = 1.2 km, computed with the FWIME inverted models obtained after the ﬁrst, second, and ﬁnal grids
(the panels for the third grid are not shown). The inversion workﬂow begins by allowing exclusively low-wavenumber
updates into the model (due to the coarse spline grid parametrization), which enforces a better matching of the observed

9

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 8: Initial FWIME search directions on the ﬁnite-difference grid (before spline re-parametrization), computed
for (cid:15) = 1.5 × 10−5. (a) Born component, (b) tomographic component, (c) total search direction, and (d) true search
direction. Panels (a)-(c) are normalized with the same value.

data at larger offsets (i.e., diving waves), as shown in Figures 11b and 11c (compared to Figures 4b and 4c). As we
reﬁne the spline grid and allow for higher-wavenumber updates, reﬂections are progressively matched (second row of
Figure 11), and the data-residuals eventually vanish (third row in Figure 11).

Figure 12(a) shows the FWIME convergence curves as a function of iterations throughout the four stages of the inversion
process (the four spline grids). The blue curve corresponds to the total objective function, the red curve corresponds to
the data-ﬁtting component, and the pink curve displays the annihilating component. The three major discontinuities in
the rate of convergence occurring at iterations 25, 80, and 190 indicate a spline grid reﬁnement. Figure 12(b) displays
the normalized total FWIME objective function (blue curve) along with the FWI objective function evaluated at each
inverted model during the optimization sequence (red curve). The red curve is not the result of an inversion process,
but simply an evaluation of the FWI objective function at each FWIME inverted model. It can also be interpreted
as a measure of how well the FWIME estimated model explains all the events in the recorded data. Moreover, it
is not monotonically decreasing, which illustrates that the FWIME algorithm has successfully created an alternate
descent-path towards the optimal solution that could not have been taken by FWI. Eventually, both curves converge to
zero (up to numerical precision) which means that FWIME has managed to ﬁnd an inverted model that matches all the
events on the observed data without the need for the additional data-correcting term.
We analyze ˜popt
by examining the evolution of its zero-lag cross section (Figure 13) and a representative TLCIG
extracted at x = 14 km (Figure 14) at four stages of the inversion process. Initially, the energy is clustered away from
the physical plane (Figure 14(a)) and the zero-lag cross-section lacks coherency in the region where the reservoirs
are located (Figure 13(a)). As the velocity model becomes more accurate, the energy gradually focuses towards the
physical plane (Figures 14b-d), and the coherency of the zero-lag section is simultaneously enhanced (Figures 13b-d).
As expected, when the algorithm converges to the optimal solution, ˜popt

vanishes (Figures 14(e) and 13(e)).

(cid:15)

(cid:15)

3.3 Reducing FWIME’s computational cost

To mitigate the computational cost of FWIME, our algorithm could typically be used to recover a good-enough starting
model for FWI. In this numerical example, we conduct FWIME until completion in order to illustrate the potential of
the method. However, for 3D ﬁeld applications, the optimization could have been stopped at earlier stages. Figure 15(a)

10

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 9: Initial FWIME search directions after applying S0S∗
0 to the panels in Figure 8, computed for (cid:15) = 1.5 × 10−5.
(a) Born component, (b) tomographic component, (c) total search direction, and (d) true search direction. Panels (a)-(c)
are normalized with the same value.

shows the result of applying data-space multi-scale FWI using the FWIME inverted model on the ﬁrst spline grid, and
indicates that in this case, 25 iterations of FWIME would have been sufﬁcient for FWI to converge to an accurate
solution. Beyond that point, conducting FWI using the initial model from FWIME would perform as well as conducting
FWIME until completion (Figure 15b-d).

The most computationally intensive component of FWIME is the variable projection step, which consists in iteratively
minimizing the quadratic objective function deﬁned in equation 2 with a linear conjugate-gradient scheme. From
a numerical aspect, this condition implies that equation 2 should be minimized until full convergence. That is, by
conducting “enough" linear conjugate-gradient iterations. In order to further reduce the computational cost of our
method, we assess how solving the variable projection step less accurately (i.e., with less linear conjugate-gradient
iterations) impacts the quality of the FWIME solution.

The inverted model shown in Figure 10(e) is obtained by solving the variable projection problem with 60 iterations,
which accounts for 97% of the total FWIME cost. We conduct analogous FWIME schemes with the same hyper-
parameter selection but by reducing the number of linear iterations during the variable projection step. Figures 16a-d
show the FWIME inverted models obtained by minimizing equation 2 with 7, 10, 15, and 20 linear iterations, respectively.
For a fair cost comparison, the inverted models in Figures 16 were obtained with at most 240 nonlinear iterations of
L-BFGS. The inverted results become less accurate for 10 linear iterations or less (Figures 16(a) and 16(b)), but seem
unaffected when the number of iterations is set to 15 or higher (Figures 16(c) and 16(d)). In this numerical test, reducing
the number of linear iteration to 15 corresponds to a computational cost decrease of 73%. Even though this behavior
may be case dependent, it shows potential value in trying to reduce the number of linear iterations for the variable
projection step in FWIME, especially for 3D applications.

3.4 Effect of coherent source of noise

We investigate how the presence of free-surface multiples recorded with marine acquisition geometries affects the
performance of FWIME. We generate a new dataset with a free-surface boundary condition at the water surface, and
absorbing-boundary conditions in all other directions [54, ]. Both sources and receivers are placed at a depth of 30 m
below the surface. All other acquisition parameters are identical to the ones used for our previous analysis. Figure 17

11

A PREPRINT - JUNE 7, 2022

(b)

(d)

(f)

(a)

(c)

(e)

Figure 10: Inverted models at different stages of the FWIME workﬂow conducted with (cid:15) = 1.5 × 10−5. (a) Initial
model. (b) Inverted model after 25 iterations on the ﬁrst spline grid, S0. (c) Inverted model after 55 iterations on the
second spline grid, S1. (d) Inverted model after 110 iterations on the third spline grid, S2. (e) Inverted model after
50 iterations on the fourth (ﬁnite-difference) grid. (f) True model. The FWIME models in panels (b), (c), and (d) are
inverted on their respective spline grids Si but are shown on the ﬁnite-difference grid.

shows two shot gathers generated by sources positioned at x = 1.2 km (ﬁrst column) and x = 14.4 km (second column)
using an absorbing-boundary condition (ﬁrst row) and a free-surface boundary condition at the water/air interface
(second row). The free-surface multiples are clearly observable (white arrows) and their amplitude is strong due to the
relatively small thickness of the water layer. In the central part of the section (corresponding to the original Marmousi
model), the multiples overlap with the various reﬂected events generated by the complex geological structures, as shown
in Figure 17(d) [55, ].

We conduct data-space multi-scale FWI on this new dataset, which converges to an unsatisfactory solution (Figure 18(a)).
We then apply FWIME in a similar fashion as for our previous analysis. For both FWI and FWIME, we invert the
data generated with a free surface with the same engine (our forward modeling also uses a free surface). Figure 19
shows TLCIGs extracted at four horizontal positions (ranging from x = 11 km to x = 14.5 km) from ˜popt
(minit)
computed at the intial step using the original dataset with absorbing boundaries in all directions (top row), and then
using the new dataset with the free-surface boundary condition (bottom row). In both rows of Figures 19, we observe

(cid:15)

12

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

(f)

(g)

(h)

(i)

Figure 11: Representative shot gathers for a source placed at x = 1.2 km. Observed data dobs (left column), predicted
data f (Simi) (middle column), and data difference dobs − f (Simi) computed with the inverted model on the ﬁrst
spline grid (ﬁrst row), second spline grid (second row), and ﬁnal inverted model (third row). All panels are displayed
with the same grayscale.

clusters of energy located at negative time lags indicating that the initial velocity values are too low for this region of
the model (as we saw in the previous analysis). However, for the free-surface case (bottom row), additional clusters
of coherent energy are present at positive time lags, which correspond to the coherent mapping of the free-surface
multiples into the extended space of ˜popt
(indicated by the green arrows in Figures 19e-h). Since free-surface multiples
generally propagate with a lower velocity than primary reﬂections recorded with the same traveltime, their positions on
the extended axis wrongfully indicate that the initial velocity minit is too high, thereby misleading the FWIME search
direction for that region of the model. Figures 20a and 20b show the initial FWIME search directions computed on the
ﬁrst spline grid with the original dataset and with the new dataset, respectively. By comparing these panels to the true

(cid:15)

13

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 12: Normalized objective functions. (a) Total FWIME objective function (blue curve), FWIME data-ﬁtting
component (red curve), and FWIME annihilating component (pink curve). (b) Total FWIME objective function (blue
curve), and FWI objective function evaluated at each FWIME inverted model (red curve).

search direction (Figure 20(c)), we can see that the free-surface multiples seem to guide the inversion in the wrong
direction, especially in the right side of the model. The ﬁnal FWIME result obtained after a total of 120 iterations of
L-BFGS (using the same sequence of spline grids as for the original test) is shown in Figure 18(b). The inversion
manages to accurately reconstruct the sharp horizontal reﬂectors in the left part of the model, but the fails to recover
the shallow complex region of the model located between x = 9 km and x = 15 km. For this acquisition geometry,
the presence of free-surface multiples seems to harm the quality of the inverted solution (compared to the original
result shown in Figure 18(c)). To mitigate this effect for ﬁeld applications, we propose to use surface-related multiple
elimination techniques when applying FWIME to offshore data acquired in a similar scenario [56, 57, 58, 59, ].

4 BP 2004 model: the North Sea region

We invert a diving-wave dominated dataset generated from the North Sea region of the BP 2004 benchmark model [41,
]. Our goal is to show that FWIME can use diving waves to converge to the global minimum with the same automatic
and user-friendly workﬂow as the one conducted for reﬂection data in the previous example. The initial velocity model
is designed to be extremely inaccurate, and no energy below 3 Hz is present in the recorded data.

4.1 Presentation and challenges

The true model mtrue is 29 km-wide and 5.5-km deep, and is shown in Figure 21(d). The initial velocity model
minit (Figure 21(a)) is horizontally invariant and linearly increasing with depth (below a 1 km-thick water layer), and
contains substantial errors as shown by the vertical and horizontal velocity proﬁles in Figures 22 and 23. In certain
regions, the velocity errors between true and initial models are close to 2.0 km/s. We place 182 sources every 160
m, and 728 ﬁxed receivers every 40 m. All acquisition devices are positioned at a depth of 40 m below the water
surface. The noise-free data are generated with a source containing energy strictly limited to the 3-9 Hz frequency range
(Figure 24(a)), and are recorded for 13 s. As shown in Figures 25a and 25d, the data are dominated by diving waves and
the initial prediction generates multiple cycle-skipped events (Figure 25c and 25f). This example tests FWIME’s ability
to simultaneously recover model features of various scales. The ﬁrst difﬁculty is to obtain the correct velocity trend
(low-resolution component) in the deeper regions of the model. The second challenge consists in accurately delineating
the high-resolution features, which include the low-velocity zones in the shallow region and two high-velocity anomalies
underneath the mud volcano. As expected, conventional multi-scale FWI (using a sequence of four frequency bands
whose spectra are shown in Figure 24(b)) fails to retrieve a useful solution (Figure 21(b)).

4.2 FWIME

For the FWIME process, we follow a similar hyper-parameter-tuning analysis as for the Marmousi2 example, and we
set (cid:15) = 1.75 × 10−5. In order to account for the large kinematic errors in the initial data prediction, we use a time-lag

14

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 13: Zero time-lag sections of popt
computed at four stages of the FWIME workﬂow. (a) Initial step. (b) After
inversion on spline 1. (c) After inversion on spline 2. (d) After inversion on spline 3. (e) Final step. All panels are
displayed with the same grayscale.

(cid:15)

(e)

extension spanning the [−1.2 s, 1.2 s] interval with 101 points sampled at ∆τ = 24 ms. We use a sequence of 4 spline
grids (Table 2), and each spline grid reﬁnement is automatically triggered when the stepper is unable to ﬁnd a step
length that decreases the total objective function value. The initial grid is chosen to be very coarse with ∆z = 1.0 km
and ∆x = 2.4 km. The spacing in the second and third grids are obtained by halving the spacing from the previous
ones. The ﬁnal spline grid coincides with the ﬁnite-difference grid (∆z = ∆x = 40 m). For the ﬁrst, second and third
grid, we use a ﬁner spatial sampling of 100 m in the vicinity of the water bottom to account for the sharp interface.
However, the bathymetry is not assumed to be precisely known.

The beneﬁt of the spline parametrization can be appreciated by examining the initial search direction (Figure 26).
Before its mapping onto the initial spline grid, the FWIME search direction sinit (Figure 26(a)) contains spurious
high-resolution artifacts, which are not present in the true search direction strue = mtrue − minit (Figure 26(b)).
Figures 26c and 26d show the FWIME and ideal search directions after their mapping onto the ﬁrst spline grid (i.e.,
after applying S0S∗
0 to sinit and to strue, respectively). The high-wavenumber artifacts are removed and the FWIME
search direction is improved.

15

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

Figure 14: TLCIG extracted at x = 14 km from popt
computed at four stages of the FWIME workﬂow. (a) Initial
step. (b) After inversion on spline 1. (c) After inversion on spline 2. (d) Final step. All panels are plotted for
τ ∈ [−0.3 s, 0.3 s] for display purposes. However, all the computations are conducted for the full time-lag range with
τ ∈ [−0.8 s, 0.8 s]. All panels are displayed with the same grayscale.

(cid:15)

Grid number ∆z [km] ∆x [km]

0
1
2
3

0.9
0.6
0.2
0.04

2.4
1.2
0.28
0.04

Table 2: Parameters of the spline grid sequence used for the model-space multi-scale FWIME scheme. Spline 3
coincides with the ﬁnite-difference grid.

Figure 27 shows the sequence of FWIME inverted models throughout the model-space multi-scale process (for clarity
purposes, the models inverted on S0, S1, and S2 are displayed on the ﬁnite-difference grid). The solutions after the ﬁrst
and second grids (Figures 27b and 27c) show an accurate recovery of the long-wavelength components (the velocity
trend) that were completely missing in the initial model. Moreover, in a test not shown here, we veriﬁed that the
inverted models from both the second and third grids were accurate enough for conventional FWI to retrieve a solution
very similar to the ﬁnal FWIME inverted model. Here, we only conduct FWIME until full convergence to illustrate
its potential. The quality of the ﬁnal FWIME inverted model (obtained after a total of 217 iterations of L-BFGS) is
excellent (Figure 27(f)). This result is also conﬁrmed by observing vertical and horizontal velocity proﬁles extracted at
various positions in Figures 22 and 23 (blue curves).
We examine the evolution of ˜popt
at ﬁve stages of the inversion process. Figure 28 shows one TLCIG extracted at
x = 22 km from ˜popt
. In a similar
fashion as for the Marmousi2 example, a considerable amount of energy is initially mapped away from the physical
plane and located at negative time lags, conﬁrming that the initial velocity is too low (Figure 28(a)). However, notice
that the nature of the events (and their moveout) in the extended space is fundamentally different than for the Marmousi2
case (Figure 14(a)). Here, most of the energy contained within ˜popt
corresponds to the mapping of refracted events
(diving waves) present within dobs that our initial prediction f (minit) was not able to match. Hence, this example
illustrates how FWIME can successfully be applied with the same mechanism regardless of the type of waves present in
the data. As the inversion progresses, the FWIME inverted models become more accurate. The energy focuses in the
vicinity of the physical plane of ˜popt
(Figures 28b-d) and the events within the physical plane become more coherent
(Figures 29b-d). Eventually, ˜popt

, and Figure 29 displays the zero-lag cross-section (the physical plane) of ˜popt

(cid:15)
completely vanishes (Figures 28(e) and 29(e)).

(cid:15)

(cid:15)

(cid:15)

(cid:15)

(cid:15)

5 Seiscope’s syncline model

We apply FWIME on a synthetic example designed and shared by the Seiscope consortium. The true velocity model is
shown in Figure 30(d). The model is approximately 12 km wide and 3.5 km deep. It is composed of two horizontal
layers with a low-velocity synclinal inclusion (basin) embedded in the second (deeper) layer. The initial velocity
(Figure 30(a)) is identical to the true model but does not contain the synclinal basin. The velocity values are set to

16

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 15: 2D panels showing the result of applying FWI using various FWIME inverted models as initial guesses. (a)
FWIME inverted model on the ﬁrst spline grid S0 (Figure 10(b)). (b) FWIME inverted model on the second spline grid,
S1 (Figure 10(c)). (c) FWIME inverted model on the third grid S2 (Figure 10(d)). (d) Final FWIME inverted model
(Figure 10(e)).

vs = 2.8 km/s and vd = 4.0 km/s in the top and bottom layers, respectively. The difference between the two velocity
models is shown in Figure 38(d).

We generate a noise-free dataset with a ﬁnite-difference numerical scheme using a grid spacing of 50 m in both
directions and a band-passed Ricker wavelet containing energy restricted to the 1.5-6.5 Hz frequency range (Figure 31).
We place 48 shots spaced every 250 m and 255 receivers every 50 m. All acquisition devices are placed at a constant
depth of 50 m. Figure 32 shows two representative shot gathers for sources located at x = 0.3 km and x = 6.3 km.

5.1 Goal of the experiment

We test the robustness of FWIME against the ill-posedness coming from wrong association of predicted and complex
observed waveforms (J. Virieux, personal communication, 2019). In the proposed model, the basin curvature is such
that the reﬂected events from the bottom of the basin generate waveﬁeld triplications in the data, which overlap with
the reﬂections from the shallow interface between the two layers. The complexity of the recorded waveforms can be
observed in the shot gathers displayed in Figure 32. Moreover, the initial model contains a vast region (relative to
the dimensions of the features of interest) with mispositioned sharp interfaces and strong velocity contrasts with its
surroundings, which represents a similar (though simpler) scenario as the one encountered when delineating complex
overburdens/geobodies, such as salt bodies.

5.2 Analyzing the events in the data

To better identify the various events in the data, we generate one shot gather using a seismic source placed at x = 6.3
km with a higher frequency content (Figure 33(a)). Figure 33(b) shows the same shot gather where ﬁve separate
events have been identiﬁed and labeled with numbers. In order to better understand the nature of the complex recorded
waveforms, Figure 34 displays a sequence of snapshots extracted from the waveﬁeld that gave rise to the shot gather
shown in Figure 33.

17

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 16: FWIME inverted models computed with the same hyper-parameter selection as for the result shown in
Figure 10(e) but with less linear conjugate-gradient iterations for the variable projection step. (a) 7 iterations, (b) 10
iterations, (c) 15 iterations, and (d) 20 iterations.

• The ﬁrst event (event 0, white arrow in Figure 33(b)) displays a linear moveout and corresponds to the direct

arrival of the incident waveﬁeld.

• Event 1 (blue arrows in Figures 33(b) and 34(b)) corresponds to the back-scattering of the incident waveﬁeld
as it interacts with the sharp corners on the edges of the synclinal basin. The corners act as diffracting points
and the recorded event shows a hyperbolic moveout observable in the shot gather.

• Event 2 (red arrow in Figures 33(b) and 34d-g) is generated when the incident waveﬁeld reﬂects from the
bottom of the basin. The waveﬁeld later refocuses at the focal point of the syncline (Figure 34(b)), which
creates a waveﬁeld similar to the one that would have been generated by a virtual point source located at the
focal point (red arrow in Figure 33(b)), directly observable by examining the waveﬁeld snapshots.

• Event 3 (green arrows in Figure 33(b)) is generated by the overlapping of a reﬂection from the bottom of the
synclinal basin with the “tails" of the incident scattered waveﬁeld after its interaction with the sharp corners
(event 1). This event generates two up-going waveﬁelds (event 3) observable in Figures 34f-k (green arrows).
• Event 4 (purple arrows in Figure 33(b)) stems from the diffraction of both up-going waveﬁelds (i.e., event 3)

by the corners of the synclinal basin. Their respective wave paths can be observed in Figures 34i and j.

Finally, Figures 35 shows the observed, predicted and data difference computed with the initial velocity model for a
shot located at x = 6.3 km and maximum frequency of 6 Hz. Figures 35(c) clearly illustrates the overlapping of true
and wrongly predicted events (i.e., the reﬂection of the incident background waveﬁeld from the misplaced horizontal
interface present in the initial model).

5.3 Conventional FWI

We ﬁrst conduct conventional FWI to illustrate its inability to recover a useful model. Figures 30(b) shows the inverted
model after a total of 500 iterations of L-BFGS, conﬁrming that FWI has converged to a local minimum. Moreover,
Figures 36b and 36c show the predicted data f (mF W I ) and data difference ∆d(mF W I ) = dobs − f (mF W I ) computed
with the ﬁnal FWI inverted model. Clearly, the triplications generated by the synclinal feature are not accurately
predicted.

18

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

Figure 17: Representative shot gathers for sources placed at x = 1.2 km (ﬁrst column) and x = 14.4 km (second
column). The top row shows the data modeled with absorbing-boundary conditions in all directions. The bottom row
shows the data modeled with a free-surface boundary condition at the water surface. All panels are displayed with the
same grayscale.

5.4 FWIME

We apply FWIME by simultaneously inverting all data available within the 1.5-6 Hz frequency range. We use three
spline grids throughout the inversion scheme. The ﬁrst spline grid, S0, has a sampling of 500 m in both directions.
However, in the vicinity of the initial horizontal interface between the two layers, we use a spacing of 50 m in the
z-direction in order to preserve the sharpness present in the initial model. The second spline grid S1 halves the spacing
of the ﬁrst one (except in the vicinity of the horizontal interface) and the third grid S2 coincides with ﬁnite-difference
grid (i.e., S2 = Id). We use a horizontal subsurface-offset extension hx for ˜popt
(cid:15) which is adequate for a dataset
dominated by reﬂection events [23, ]. Due to the large kinematic errors in the initial data-prediction, we employ 201

19

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 18: 2D panels of velocity models. (a) FWI model inverted using the dataset modeled with a free-surface. (c)
Final FWIME model inverted using the dataset modeled with a free-surface. (c) FWIME model inverted with the
original dataset. (d) True model.

points of extension, which allows hx to range from -5 km to 5 km. Each variable projection step is conducted by
minimizing objective function shown in equation 2 with 60 iterations of linear conjugate gradient.
Figure 37 shows two horizontal subsurface-offset common image gathers (SOCIG) extracted from ˜popt
(S0m0) at
x = 4.0 km and x = 6.0 km, respectively (m0 is the initial model parametrized on the spline grid). The SOCIG located
at x = 4 km contains weaker energy/events due to the fact that at that location, the initial model is already accurate,
and thus f (S0m0) ≈ dobs. Consequently, less energy is mapped into ˜popt
during the minimization of equation 2.
Conversely, for the SOCIG closer to the basin (Figure 37(b)), the initial data prediction is less accurate, and more energy
is mapped into ˜popt
. In fact, the initial kinematic error is so substantial that a maximum subsurface-offset span of 10
km is needed to fully capture the energy from the data misﬁt.

(cid:15)

(cid:15)

(cid:15)

Figures 38a and 38b show the scaled Born and tomographic components of the ﬁrst FWIME search direction, re-
spectively. Note that Figures 38a and 38b are not normalized with the same scaling factor: the Born component is
approximately two orders of magnitude weaker than the tomographic component, even without the use of a spline
parametrization. Indeed, this is expected (and desired) at early stages of the FWIME workﬂow when the model updates
should primarily be guided by the tomographic gradient. Figure 38(c) shows the total search direction (i.e., the sum
of the two panels in Figures 38a and 38b), which is almost identical to the tomographic component. Even though
this search direction may seem promising (by comparing it to the ideal update in Figure 38(d)), its mapping onto the
ﬁrst spline grid removes most of the high-wavenumber artifacts and provides a much more promising search direction
(Figure 39(a)).

We minimize equation 1 with 28 iterations of L-BFGS on the ﬁrst spline grid, S0. The grid reﬁnement is automatically
triggered when the solver is unable to ﬁnd a proper step length that decreases the objective function. The inverted model
after the ﬁrst spline grid, m1 is shown in Figure 40(b) (for display purposes, this panel shows S0m1 rather than m1).
We use the inverted model on the ﬁrst spline grid as the initial guess for the inversion on the second spline grid and
we conduct 87 iterations of L-BFGS (Figure 40(c)). The ﬁnal FWIME inverted model on the ﬁnite-difference grid
is obtained after an additional 33 iterations of L-BFGS, and is shown in Figure 40(d). Figures 41a and 41b display
vertical and horizontal velocity proﬁles of the initial (red curve), true (blue curve) and FWIME (pink curve) models
at x = 6 km and z = 1.5 km, respectively. The ﬁnal result is accurate but still contains a thin reﬂector present at an

20

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

(f)

(g)

(h)

Figure 19: TLCIGs extracted at x = 11 km, x = 12.5 km, x = 13.5 km, and x = 14.5 km from ˜popt
(minit) computed
with the dataset using absorbing boundaries (top row), and with a free-surface boundary condition (bottom row). All
panels are displayed with the same grayscale.

(cid:15)

approximate depth of z = 0.8 km (where the wrongly-positioned horizontal interface was initially located). However,
this artifact would likely disappear if the frequency content of the data were to be increased. Even though the FWIME
results shown in Figure 40 are computed for a ﬁxed (cid:15)-value of 1.0 × 10−5, we observe that different values (ranging
from (cid:15) = 0.5 × 10−5 to (cid:15) = 5.0 × 10−5) lead to similar results.

Figure 42 shows the evolution of the predicted data f (Simi) (middle column) and the data-difference ∆d(mi) =
dobs − f (Simi) (right column) at various stages of the FWIME workﬂow (for a source placed at x = 6.3 km). After
the ﬁrst spline grid (second row), the inversion recovers a model that is able to generate some of the triplications in
the waveﬁeld (Figure 42(e)) by removing a large portion of the incorrect high-velocity zone at the bottom of the basin
(Figure 40(b)). At the ﬁnal stage (third row), most of the basin has been recovered, the reﬂection from the initially
mis-positioned horizontal interface at z ≈ 0.8 km has been removed from the predicted data (Figure 42(h)), and the
data residuals have completely vanished (Figure 42(i)).

For quality-control purposes, we migrate the observed data (after subtracting the direct arrival) using the initial velocity
model (Figure 43(a)) and the ﬁnal velocity model (Figure 43(b)). The migration is conducted with a RTM scheme. The
second panel shows a clear improvement, which is conﬁrmed by the ADCIGs extracted at various horizontal positions
(Figure 44). In the third and fourth columns of Figure 44, the improvement of the ﬂatness of the ADCIG conﬁrms that
the bottom of the basin is now accurately imaged. Furthermore, Figure 44 illustrates the ability of FWIME at leveraging
any type of coherent information/moveout from the extended space of ˜popt
to accurately update the velocity model.
Even though not tested here, we anticipate that more conventional techniques based on interpreting the curvature of the
the moveouts within the ADCIGs [60, ] would not perform as well.

(cid:15)

In summary, model-space multi-scale FWIME performs well on this numerical example. First, it manages to automati-
cally handle the phase identiﬁcation issue occurring when complex waveforms are recorded in the data, as indicated

21

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 20: Normalized initial search directions computed on the ﬁrst spline grid. (a) FWIME search direction computed
with the new dataset containing free-surface multiples. (b) FWIME search direction computed with the original dataset.
(c) True search direction. Panels (a) and (b) are normalized with the same value.

(c)

by Seiscope. In addition, it successfully removes a large area ﬁlled with incorrect velocity values (with a strong
velocity-contrast and sharp interfaces), which is a promising result for the next numerical example where we apply
FWIME to recover a salt body from a pure sediment model.

6 Salt model

Following the recent deployment of ultra-long offset full-azimuth sparse-node acquisition surveys [13, ], we design
a test to show that FWIME can leverage both refracted and reﬂected energy for velocity model building in complex
subsalt regions. With optimal illumination, we show its potential at providing signiﬁcant imaging uplifts without the
need for low-frequency energy nor accurate initial model.

6.1 Ultra-long offset survey

The true model is 33 km wide and 8.5 km deep (Figure 45(a)). It is composed of a sediment background (modiﬁed from
[41]) in which a 6 km-wide and 1 km-thick rugose salt body is embedded. The ultimate goal is to accurately image
a set of four thin high-velocity layers and one low-velocity anomaly located underneath the salt, at an approximate
depth of 5 km. The initial model is obtained by strongly smoothing the sediment background and does not contain any
information about the presence of salt (Figure 45(b) and black curves in Figures 46).

To simulate an ultra-long offset acquisition survey, we place 840 ﬁxed receivers every 40 m and we generate noise-free
pressure data with 139 sources. The distance between two consecutive sources is set to 240 m, and the maximum
recorded offset for this test is 33 km. Both sources and receivers are placed at depth of 50 m below the surface. Figure 49
shows two representative shot gathers for sources placed at x = 0 km and x = 16 km, which indicate the presence
of refracted energy. For the FWIME workﬂow, the source wavelet contains energy limited to the 3-9 Hz range, and
the data are modeled for 15 s with absorbing boundaries in all directions. This example proposes an ideal acquisition
geometry (the salt body is well illuminated by diving waves propagating through it) and is conducted to show the
usefulness of combining FWIME with novel long-offset node acquisition surveys to build accurate enough velocity
models for FWI to succeed in the presence of complex overburdens.

22

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 21: 2D panels of velocity models. (a) Initial model. (b) Inverted model after conventional data-space multi-scale
FWI using four frequency bands. (c) Final FWIME inverted model. (d) True model.

(a)

(b)

(c)

(d)

Figure 22: Depth velocity proﬁles extracted at (a) x = 6 km, (b) x = 9 km, and (c) x = 11 km, and (d) x = 13 km.
The black curve represents the initial model, the red curve is the true model, and the blue curve is the FWIME inverted
model.

We ﬁrst conduct multi-scale FWI using the initial model shown in Figure 45(b) assuming the presence of unrealistic
low-frequency energy in the recorded data, as shown by the ﬁve wavelet spectra in Figure 47(a). The ﬁnal inverted model
is extremely accurate (Figure 48(b)) and provides an estimate of the best recoverable solution using waveform-inversion
schemes with this particular acquisition geometry. We apply a second data-space multi-scale FWI workﬂow (with the
same initial model) assuming the presence of coherent energy as low as 1.8 Hz, which is still quite optimistic for ﬁeld
data. The sequence of wavelet spectra employed for this scheme is shown in Figure 47(b). In this case, FWI fails to
converge to a physical solution (Figure 48(c)), which highlights the difﬁculty of retrieving the salt body from a pure
sediment model.

23

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 23: Horizontal velocity proﬁles extracted at (a) z = 2 km, (b) z = 3 km, (c) x = 3.5 km, and (d) x = 4 km. The
black curve represents the initial model, the red curve is the true model, and the blue curve is the FWIME inverted
model.

For the FWIME scheme, we invert data generated with a source wavelet whose spectrum is shown in Figure 47(c). To
increase the difﬁculty of this test for FWIME, the lowest useful frequency is set to 3 Hz, which is even higher than the
lowest available frequency from the ﬁrst band used in conventional FWI (blue curve in Figure 47(b)). We use a time-lag
extension spanning the [−1.2 s, 1.2 s] interval with 101 points sampled at ∆τ = 24 ms and we set (cid:15) = 2.5 × 10−4.
The parameters of the six spline grids employed are shown in Table 3. In addition, we assume the bathymetry is
approximately known and for the ﬁrst, second, third, fourth, and ﬁfth grids, we use a ﬁner spatial sampling of 100
m in the vicinity of the water bottom to allow the recovered velocity models to correctly predict the strong reﬂection
generated from this interface.

Grid number ∆z [km] ∆x [km]

0
1
2
3
4
5

0.5
0.3
0.25
0.12
0.06
0.04

1.2
0.8
0.6
0.4
0.12
0.04

Table 3: Parameters of the spline grid sequence used for the model-space multi-scale FWIME scheme applied to the
salt model. Spline 5 coincides with the ﬁnite-difference grid. For spline grids 0, 1, 2, 3 and 4, we use a ﬁner sampling
in the z-direction in the vicinity of the water bottom (not shown in the table).

24

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 24: Amplitude spectra of the seismic sources employed in this numerical example. (a) Source used for the
FWIME workﬂow. (b) Sequence of sources used for the data-space multi-scale FWI workﬂow.

We examine the FWIME Born, tomographic, and total search directions on the ﬁnite-difference grid shown in Fig-
ures 50a-c (normalized by the same value). The tomographic component dominates the Born and seems to guide the
inversion towards the true solution (Figure 50(d)). After our parametrization on the ﬁrst spline grid, the FWIME initial
update direction is further improved. The high-wavenumber artifacts located on top of the salt body have been removed,
and the velocity values are increased at the exact position of the salt body. Underneath the salt, we also observe a good
phase matching between Figures 51(c) and 51(d). This analysis conﬁrms that the tomographic component plays an
important role at early stages. In contrast, FWI’s update direction is not able to capture the missing low-wavenumber
components, even using a spline grid re-parametrization (Figure 52).

The sequence of FWIME inverted models is shown in Figure 53. Each model is inverted on its respective spline grid and
then mapped on the ﬁnite-difference grid for display purposes. The inversion on the ﬁrst grid is crucial as it retrieves
a low-resolution salt body (i.e., a geobody with smooth contours) (Figure 53(b)). Then, the contours of the salt are
gradually sharpened as the spline grid is reﬁned (Figures 53c and 53d). Once the salt body is accurately reconstructed,
the thin subsalt reﬂectors are then well image, and the inverted model is excellent (Figure 53(e)).

Figure 54 displays the normalized FWIME objective function (blue curve) along with the value of the conventional
FWI objective function computed at each inverted model during the FWIME sequence (red curve). As expected, the
red curve is not monotonically decreasing but behaves differently than the analogous curve obtained in the example
based on the Marmousi2 model from the previous section (Figure 12(b)), where the inverted dataset is dominated by
reﬂections. It is interesting to notice that the red curve becomes smoother and seems to contain less local minima than
its counterpart from Figure 12(b). This observation potentially corroborates the claim that transmitted energy makes
seismic inversion problems better conditioned than pure reﬂections [61, ].

We observe here that the quality of the inverted model is mostly affected by the selection of the spline grid sequence
rather than by the trade-off parameter value (cid:15). Figure 55 shows two FWIME inverted models obtained with different
spline grid sequences: Figure 55(a) results from starting the inversion directly on the second grid, whereas Figure 55(b)
is computed by skipping the second grid. In both ﬁgures, the contours of salt body have been correctly reconstructed but
the inversion is unable to automatically ﬁll the salt with the correct velocity value. Moreover, by conducting additional
tests (not shown here), we notice that the presence of complex overburdens (or strong velocity contrasts) may generally
require a slower reﬁnement rate in the spline grid sequence to ensure convergence to an accurate solution.

6.2 Reducing the acquisition offset

We assess the effect of reducing the maximum acquisition offset on the quality of the FWIME results. The goal is
to test whether FWIME can be used without deploying ultra-long offset (and costly) surveys to build accurate initial
salt models. We design an analogous test as in the previous section but we decrease the width of our area of study.
Figures 56(a) and 56(d) show the initial and true models, which are 20 km wide instead of 34 km. The rest of the
geological features are identical to the ones from Figure 45. We deploy 500 ﬁxed receivers every 40 m and we generate

25

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

(f)

Figure 25: Representative shot gathers for sources placed at x = 0 km (ﬁrst row) and x = 19 km (second row). Observed
data, dobs (ﬁrst column), predicted data with the initial model, f (minit) (second column), and initial data-difference,
∆d(minit) = dobs − f (minit) (third column). All panels are displayed with the same grayscale.

noise-free pressure data with 83 sources. The frequency content is identical to the one used in the previous example
(Figure 47(c)).

Figure 57 shows two shot gathers from this dataset, which indicate that less transmitted energy is present. For the
FWIME workﬂow, we use the same spline grid reﬁnement schedule, and we set (cid:15) = 2.5 × 10−4. As shown in
Figure 56(c), FWIME recovers a solution as accurate as the one from the previous section. However, the algorithm
converged after approximately 500 L-BGFS instead of 250 L-BFGS. The inverted model after 250 L-BFGS iterations
(Figure 56(b)) shows that more iterations are needed to correctly capture the edges of the salt body. At that point, the
subsalt reﬂectors are poorly imaged.

Finally, Figure 58 displays the FWIME convergence curve (blue curve) along with the evaluated FWI objective function
(red curve). By comparing it with Figure 54, we can clearly observe that reducing the amount of transmitted energy has
made the inversion problem more ill-posed, but FWIME is eventually able to mitigate the presence of local minima.

7 Towards a more ﬂexible model parametrization

We design an experiment based on the BP 2004 benchmark model [41, ] to assess the limitations of FWIME when
imaging in the presence of thick and complex overburdens. Our study focuses on the central part of the original BP
2004 model, which is representative of the geological environments encountered in West Africa. We show that FWIME
does not manage to recover an accurate solution. However, we anticipate that our method can be conveniently improved
by designing and employing a more ﬂexible coarse-model representation, such as radial basis functions (RBF) [62, 63,
].

The true velocity is 40 km wide and 9 km deep (Figure 59(d)). The salt body is thick, deeply rooted, and presents steep
ﬂanks, which makes its boundaries challenging to delineate. In addition, a sharp interface between the base salt and a
low-velocity zone is present underneath the main salt structure and ranges from an approximate depth of 5 km, down
to the bottom of the model. Even with a long-offset acquisition geometry which generates diving waves, very little
recorded energy can illuminate this region, making its recovery very difﬁcult.

26

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 26: Normalized initial search directions. (a) FWIME initial search direction sinit before applying any spline
parametrization, computed with (cid:15) = 1.75 × 10−5. (b) True search direction, strue = mtrue − minit. (c) FWIME
initial search direction after its mapping on the initial spline grid (displayed on the ﬁnite-difference grid), sspline
init =
S0S∗
0sinit. (d) True search direction after its mapping on the initial spline grid (displayed on the ﬁnite-difference grid),
sspline
true = S0S∗

0strue.

We simulate a surface seismic acquisition with 160 sources placed every 250 m (50 m below the surface), and 800 ﬁxed
receivers every 50 m (also placed 50 m below the surface). The noise-free data are modeled and recorded for 17 s with
an acoustic isotropic constant-density propagator and a spatial sampling of 50 m for both vertical and horizontal axes.
In order to reduce the difﬁculty of this test, we use absorbing boundaries in all directions, and thus no free-surface
related multiples are present within the dataset. The initial model is solely composed of sediments (Figure 59(a)).
Throughout this study, the maximum frequency used to generate the data is set to 8 Hz for both FWI and FWIME
schemes. Figure 60 shows two representative shot gathers for sources placed at x = 4 km and x = 20 km, respectively.
These panels conﬁrm the difﬁculty to illuminate the low-velocity region underneath the salt. In fact, the only recorded
signal interacting with this zone is carried by diving waves recorded at very long offsets, as shown by the white arrows
in both panels. Moreover, for sources placed above the salt feature, the amplitude of the top-salt reﬂections dominate
the ones generated by the interface between the base of the salt and the low-velocity zone (green arrows in Figures 60a
and 60b).

We ﬁrst conduct FWI using unrealistic low-frequency energy ranging from 0.25 Hz to 8 Hz (Figure 61(a)), which
converges to an excellent solution (Figure 59(b)). Then, we limit the available bandwidth to 2-8 Hz (Figure 61(b)) and
the ﬁnal inverted model is unable to recover the salt body (Figure 59(c)), even with the presence of coherent energy as
low as 2 Hz.

We apply FWIME with a time-lag extension and we simultaneously invert a dataset generated with a wavelet containing
energy within the 3-8 Hz frequency band (Figure 61(c)). Unfortunately, even with a thorough hyper-parameter search
(i.e., by testing a multiple spline grid dispositions, reﬁnement schedules, and a wide range of (cid:15)-values), FWIME is
not able to recover a model as accurate as the one obtained with FWI using unrealistic low frequencies (shown in
Figure 59(b)). Figures 62 shows the set of the FWIME inverted models (displayed on the ﬁnite-difference grid) obtained
by using the most optimal hyper-parameters (a sequence of six spline grids with (cid:15) = 5.0 × 10−4). The ﬁnal inverted
model is shown in Figure 62(g) and fails to accurately capture the low-velocity region underneath the salt body, and the
right ﬂank is mis-positioned. Moreover, some low-velocity artifacts are present on the left ﬂank of the salt. The blue
curve in Figure 63 shows the total FWIME objective function corresponding to the optimization sequence and does

27

A PREPRINT - JUNE 7, 2022

(b)

(d)

(f)

(a)

(c)

(e)

Figure 27: Inverted models at different stages of the model-space multi-scale FWIME workﬂow with (cid:15) = 1.75 × 10−5.
(a) Initial model. (b) Inverted model after 77 iterations on the ﬁrst spline grid. (c) Inverted model after 60 iterations
on the second spline grid. (d) Inverted model after 33 iterations on the third spline grid. (e) Inverted model after 124
iterations on the fourth (ﬁnite-difference) grid. (f) True model. The total number of iterations used to obtained panel is
217.

not converge to zero, which indicates that the algorithm converges to a local minimum. The red curve in Figure 63,
which is the FWI objective function evaluated at each FWI inverted model during the optimization sequence, shows that
FWIME was able to bypass some - but not all - local minima from the conventional FWI formulation. Nevertheless,
FWIME performs better than conventional FWI, and the salt features in the shallower parts of the model are better
imaged (for depths smaller than 4 km).
Figure 64 shows the observed data, dobs (ﬁrst column), predicted data with the ﬁnal FWIME inverted model
f (mF W IM E) (second column), and the ﬁnal data difference, dobs − f (mF W IM E) (third column). The ﬁrst and
second rows correspond to sources located at x = 4 km, and x = 20 km, respectively. As expected, a large data
mismatch can be observed for events occurring at larger offsets (Figure 64(c)) for receivers’ positions greater than 25
km, which correspond to the recordings of diving waves traveling through the salt body. This prediction error highlights
the inability of FWIME to accurately recover for the low-velocity zone underneath the salt. In addition, the last inverted

28

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

Figure 28: Time-lag common image gathers (TLCIG) extracted at x = 22 km from popt
computed at ﬁve stages of the
FWIME workﬂow. (a) Initial step. (b) After inversion on spline 0. (c) After inversion on spline 1. (d) After inversion on
spline 2. (e) Final step. All panels are displayed with the same grayscale.

(cid:15)

model fails at predicting some reﬂected and scattered energy coming from the base salt, as shown in Figures 64(c) and
64(f), for near offsets.

In the presence of complex geological structures and overburdens, we observe that the selection of the spline grid spatial
sampling and the rate at which we adjust it throughout the optimization process strongly impacts the quality of inverted
models (more than the (cid:15)-value). More speciﬁcally, the inability to constrain the velocity values to vary less within salt
bodies and more rapidly in the vicinity of its edges, seems to hamper the inversion process. Perhaps a more ﬂexible
model parametrization may improve the convergence properties of FWIME. When dealing with complex salt bodies,
we intend to investigate in the near future the use of more adjustable basis functions for coarse model representation,
such as the approach implemented by [64]. Our proposed method would consist in using migrated images to guide the
spline nodes’ spacing and spatial disposition. The grid density would be increased in regions containing salt edges, and
would be reduced within the salt bodies to promote homogeneous velocity values.

8 Computational aspects

8.1 An efﬁcient GPU implementation

We design a 2D/3D fully-ﬂedged GPU software package for FWI and FWIME. Our computational framework is
composed of three abstract layers. (1) The ﬁrst layer handles FWIME’s most computationally intensive and parallelizable
tasks (2D waveﬁeld propagations and extended imaging/scattering operations), which are performed directly on the
GPU device and are programmed in the parallel computing platform referred to as compute uniﬁed device architecture
(CUDA). (2) The collection of CUDA functions (kernels) are then wrapped into a C++ framework which allows us to
dispatch the various modeling tasks on multiple GPU devices available within a compute node. (3) A Python-based
abstraction layer is then added to easily build, deﬁne, and solve large-scale complex numerical inverse problems on
multi-node heterogeneous GPU clusters with the use of the objected-oriented optimization framework developed by
[65]. Finally, the binding between C++ and Python user-deﬁned classes is achieved with the pybind11 library [66, ].

8.2 Computational cost analysis

To compare the theoretical computational cost of FWIME, CF W IM E, with the cost of FWI, CF W I , we evaluate the
number of waveﬁeld propagations required by each method to conduct one L-BFGS iteration. In FWI, one L-BFGS
iteration typically requires four propagations: two propagations for the gradient computation, and two propagations for
a parabolic line search [67, ]. Therefore, CF W I = 4.

In FWIME, the gradient computation is achieved with six propagations: two propagations for the Born component and
four for the tomographic component. In addition, for each evaluation of the objective function deﬁned in equation 1,
one variable projection (VP) step needs to be conducted by minimizing the quadratic objective function deﬁned in
equation 2. If we perform Nvp linear conjugate gradient iterations for the VP step, the additional cost is given by

29

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 29: Zero time-lag sections of popt
computed at ﬁve stages of the FWIME workﬂow. (a) Initial step. (b) After
inversion on spline 0. (c) After inversion on spline 1. (d) After inversion on spline 2. (e) Final step. All panels are
displayed with the same grayscale.

(cid:15)

(e)

Cvp = 4 × Nvp(1 + Cext),

(10)

where 0 ≤ Cext ≤ 1 is the percentage cost increase due to the fact that all migrations/demigrations are conducted on an
extended space. The value of Cext depends on the length of the extended axis but is typically on the order of 40% for
3D applications with a time-lag extended length of approximately 50 points. However, for the 2D numerical examples
shown in this paper, we do not try to optimize the length of the extended axis and Cext can be as high as 60%. In
equation 10, the factor 4 comes from the application of one forward and one adjoint extended migration per iteration,
each corresponding to two propagations. To avoid evaluating the FWIME objective function (equation 1) multiple times
during the step length estimation, we use the method proposed by [68] instead of a parabolic line search, which only
requires one cost function evaluation in addition to the gradient computation. Finally, the total cost of one L-BFGS
FWIME iteration is given by

CF W IM E = 6 + 4 × Nvp(1 + Cext).

(11)

30

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 30: 2D panels of velocity models. (a) Initial model. (b) Inverted model after conventional data-space multi-scale
FWI. (c) Final FWIME inverted model. (d) True model.

Figure 31: Amplitude spectrum of the seismic source used to generate the dataset for this numerical example.

Table 4 summarizes this analysis assuming different values of Nvp. The sixth column corresponds to the ratio
between the cost of the VP step and the total cost of one FWIME iteration, which illustrates that this step is our
main computational bottleneck. The last column displays the ratio between the FWIME and the FWI cost. For 3D
applications, we observe that setting Nvp = 30 is sufﬁcient for accurate convergence, which indicates that FWIME is
approximately 40 to 70 times more costly than conventional FWI.

8.3 Computational time for 2D applications

The numerical implementation for the 2D examples proposed in this paper are conducted on a GPU computer cluster,
which includes four compute nodes, each containing four NVIDIA Tesla V100 GPU devices with 16 GB of global
memory. Each node is equipped with 24 CPU cores and 512 GB of random access memory (RAM). Each example is
solved using four GPU devices without any domain-decomposition strategy [69, ]: each GPU device simulates one shot
throughout the full ﬁnite-difference domain of interest.

For reproducibility purposes, Table 5 provides a breakdown of the FD parameters and an estimation of the computational
time for the proposed numerical examples. Nz and Nx correspond to the number of spatial samples on the FD grid,
which includes additional padding for the absorbing boundaries. Next is the total number of samples on the extended
axis for ˜popt
. Trec is the total recording time for each shot, expressed in seconds. The quantities tF W IM E and tF W I

(cid:15)

31

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 32: Representative shot gathers generated by a seismic source containing energy restricted to the 1.5-6 Hz
frequency range. (a) Source located at x = 0.3 km. (b) Source located at x = 6.3 km. All panels are displayed with the
same grayscale.

(%) Ratio

FWI
FWIME
FWIME
FWIME
FWIME

Method Nvp Cext (%) Cvp Ctotal
-
40
40
40
40

-
560
280
168
112
Table 4: Table summarizing the computational cost comparison between FWIME and FWI. Nvp is the number of
linear conjugate gradient iterations for the VP step. Cext is the percentage cost increase due to the fact that all
migrations/demigrations are conducted on an extended space. Cvp is the number of propagations required for the VP
step. Ctotal is the total number of propagations for one L-BFGS iteration. The quantity Cvp
is the percentage cost of
Ctotal
the VP step. The last column shows the ratio between the FWIME and the FWI computational costs.

-
100
50
30
20

1
142
72
43
30

4
566
286
174
118

Cvp
Ctotal
-
99
98
97
95

correspond to the approximate computational time taken for one L-BFGS iteration for FWIME and conventional FWI,
respectively (expressed in minutes). The last column reports the ratio between the FWIME and the FWI computational
times.

For the 2D applications propsed in this paper, we do not focus on improving the computational efﬁciency of FWIME.
We choose very conservative values for Next and Nvp to ensure accurate convergence for the VP step and assess the
performance of our method in optimal conditions. For the Marmousi2 example, we investigate the effect of using a
smaller number of linear iterations for the VP step. We notice that 15 iterations are sufﬁcient to converge to a similar
solution, thereby reducing FWIME’s computational cost by a factor of three.

8.4 Reproducibility

To ensure the full reproducibility of our results from this paper, we create an online repository where our open-source
software package can be freely accessed [70, ]. All the numerical examples proposed in this paper are implemented in
Jupyter notebooks and can be replicated with the use of NVIDIA GPU devices.

32

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 33: (a) Shot gather for a source located at x = 6.3 km containing energy within the 2-30 Hz frequency range. (b)
Identical shot gather as (a) with labeled seismic events. All panels are displayed with the same grayscale.

Nz
250
250
250
250
220
330
330

2D Model
Marmousi2
Marmousi2
Marmousi2
North Sea
Seiscope
Salt
West Africa

Nx Next
101
700
101
700
101
700
101
840
201
470
101
1000
101
1000

Trec Nvp
60
8 s
30
8 s
15
8 s
60
13 s
80
6 s
100
15 s
100
15 s
Table 5: Table summarizing the FD modeling parameters and computational time for the ﬁve numerical examples
proposed in this paper. Each example is conducted on four NVIDIA Tesla V100 GPU devices. Nz and Nx correspond
to the number of samples for the FD grid. Next is the total number of samples on the extended axis. Trec corresponds
to the recording time for the simulated data. Nvp is the number of linear conjugate-gradient iterations conducted for the
VP step. tF W IM E and tF W I correspond to the approximate computational time for one L-BFGS iteration of FWIME
and FWI, respectively. The last column displays the ratio between tF W IM E and tF W I .

tF W IM E
50 min
26 min
14 min
80 min
15 min
85 min
85 min

tF W I
0.5 min
0.5 min
0.5 min
0.75 min
0.2 min
0.75 min
0.75 min

Ratio
100
52
28
106
90
110
110

9 Embedding FWIME in a production workﬂow

To mitigate the computational cost of FWIME in a production workﬂow, we see two potential applications of our
method. (1) FWIME can be conducted until the inverted model is accurate enough (which can be assessed by examining
the optimal extended perturbation ˜popt
) and used as an input for conventional FWI. (2) Alternatively, if we wish to
better characterize a speciﬁc region (e.g., hydrocarbon reservoir), we do not need high accuracy/resolution everywhere
in the subsurface. Instead of applying acoustic FWI on the entire domain, we can use the output of FWIME and feed
it to target-oriented elastic FWI procedures [71, 72, 73, 74, 75, ]. Even though elastic FWI is more computationally
intensive, it becomes tractable if applied to a smaller target volume. In addition, elastic FWI is better suited for retrieving
elastic properties than conventional ray-based amplitude versus angle (AVA) approaches [76, 77, 75, ].

(cid:15)

33

12340A PREPRINT - JUNE 7, 2022

(a)

(c)

(e)

(g)

(i)

(b)

(d)

(f)

(h)

(j)

Figure 34: Waveﬁeld snapshots generated by a source located at x = 6.35 km and containing energy within the 2-30
Hz frequency range, giving rise to the shot record shown in Figure 33. Each panel shows the waveﬁeld at a given time
step. All panels are displayed with the same grayscale.

10 Conclusions

The main beneﬁt of FWIME is its ability to converge to useful acoustic Earth models by inverting any type of waves
without the need for coherent low-frequency signal or accurate initial guesses. We do not provide a mathematical proof
of global convergence for our method, but we provide plenty of numerical evidence that support this claim. Our method
leverages the robustness of WEMVA with the high-resolution nature and accuracy of FWI by judiciously pairing them
into one workﬂow which is more efﬁcient than applying these two techniques separately/sequentially. The automatic
coupling between WEMVA and FWI is achieved with the variable projection method, which substantially reduces the
number of hyper-parameters to two: the trade-off variable (cid:15) and the spline grid schedule. Our algorithm is applied with
the same mechanism regardless of the type of waves being inverted, which makes it simple to use. Thus, the need to
design user-intensive ad hoc inversion strategies is mitigated.

We apply FWIME on ﬁve realistic synthetic tests that replicate some of the most challenging environments encountered
by energy companies: inaccurate initial model, lack of low-frequency data, lack of illumination, and presence of
complex overburdens. In each example, we guide the reader step by step through the hyper-parameter tuning process

34

122232333434A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

Figure 35: Shot gather for a source located at x = 6.3 km containing energy within the 1.5-6 Hz frequency range. (a)
Observed data, dobs. (b) Predicted data with the initial velocity model, f (m0). (c) Initial data difference, ∆d(m0) =
dobs − f (m0). All panels are displayed with the same grayscale.

(a)

(b)

(c)

Figure 36: Representative shot gather for a source placed at x = 6.3 km containing energy within the 1.5-6 Hz frequency
range. (a) Observed data, dobs. (b) Predicted data with the inverted model using conventional FWI, f (mF W I ). (c) Data
difference, ∆d(mF W I ) = dobs − f (mF W I ). All panels are displayed with the same grayscale.

and we show that our method can retrieve excellent solutions, whereas conventional methods converge to unsatisfactory
models. FWIME is more computationally demanding than conventional FWI. However, from energy companies’
perspective, the potential upside (in terms of safety and efﬁciency) gained from the image quality uplift in certain
regions may offset this cost.

We identify some current limitations and potential opportunities to improve the convergence properties of FWIME.
They include: (1) employing a numerical modeling scheme that simulates more realistic physics (anisotropy, elastic
effects, attenuation) and thus handle multi-parameter inversions, (2) applying a surface-related multiple elimination
pre-processing step to the data for offshore acquisitions, and (3) designing a more ﬂexible sparse model representation
to efﬁciently delineate and recover complex geobodies.

In an online repository, we provide a fully-reproducible open-source 2D GPU software suite (along with Jupyter
notebooks) to easily replicate the results presented in this paper. In a third paper, we successfully apply FWIME to a 3D
OBN ﬁeld dataset from the Gulf of Mexico and we make the 3D FWIME implementation freely accessible.

35

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 37: Horizontal subsurface offset common image gathers (SOCIG) extracted from the extended optimal perturba-
tion ˜popt
computed at the initial step and extracted at two horizontal positions. (a) x = 4.0 km. (b) x = 6.0 km. Both
panels are displayed with the same grayscale.

(cid:15)

(a)

(c)

(b)

(d)

Figure 38: Scaled FWIME initial search directions on the ﬁnite-difference grid (before their mapping onto the initial
spline grid). (a) Born search direction. (b) Tomographic search direction. (c) Total search direction (sum of panels (a)
and (b)). (d) True search direction. Note that (a) is normalized by a different scaling factor than the one for (b) and (c)
(for display purpose). The amplitude of panel (a) is approximately two orders of magnitude smaller than the one of
panels (b) and (c).

References

[1] Patrick Lailly and J Bednar. The seismic inverse problem as a sequence of before stack migrations. 1983.
[2] Albert Tarantola. Inversion of seismic reﬂection data in the acoustic approximation. Geophysics, 49(8):1259–1266,

1984.

[3] Laurent Sirgue, OI Barkved, J Dellinger, J Etgen, U Albertin, and JH Kommedal. Thematic set: Full waveform

inversion: The next leap forward in imaging at valhall. First Break, 28(4), 2010.

[4] Guido Baeten, Jan Willem de Maag, René-Edouard Plessix, Rini Klaassen, Tahira Qureshi, Maren Kleemeyer,
Fons ten Kroode, and Zhang Rujie. The use of low frequencies in a full-waveform inversion and impedance
inversion land seismic case study. Geophysical Prospecting, 61(4):701–711, 2013.

[5] Xukai Shen, Imtiaz Ahmed, Andrew Brenders, Joe Dellinger, John Etgen, and Scott Michell. Full-waveform

inversion: The next leap forward in subsalt imaging. The Leading Edge, 37(1):67b1–67b6, 2018.

[6] Jean Virieux and Stéphane Operto. An overview of full-waveform inversion in exploration geophysics. Geophysics,

74(6):WCC1–WCC26, 2009.

36

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 39: Scaled search directions. (a) FWIME initial search direction after applying S0S∗
direction after applying S0S∗

0 to panel 38(d).

0 to panel 38(c). (b) Search

(a)

(c)

(b)

(d)

Figure 40: Inverted models at various stages of the FWIME workﬂow, mapped onto the ﬁnite-difference grid. (a) Initial
model. (b) Inverted model after 28 iterations of FWIME on S0. (c) Inverted model after 87 iterations of FWIME on S1
using (b) as initial guess. (d) Inverted model after applying 33 iterations of FWIME on the ﬁnite-difference grid using
(c) as initial guess.

[7] Carey Bunks, Fatimetou M Saleck, S Zaleski, and G Chavent. Multiscale seismic waveform inversion. Geophysics,

60(5):1457–1473, 1995.

[8] AJ Brenders and R Gerhard Pratt. Waveform tomography of marine seismic data: What can limited offset offer?

In 2007 SEG Annual Meeting. OnePetro, 2007.

[9] Andreas Fichtner. Full seismic waveform modelling and inversion. Springer Science & Business Media, 2010.

[10] Joseph Dellinger, Allan Ross, David Meaux, Andrew Brenders, Glenn Gesoff, John Etgen, John Naranjo, Graham
Openshaw, and Mark Harper. Wolfspar®, an “fwi-friendly” ultralow-frequency marine seismic source. In SEG
Technical Program Expanded Abstracts 2016, pages 4891–4895. Society of Exploration Geophysicists, 2016.

[11] Andrew Brenders, Joseph Dellinger, Chinaemerem Kanu, Qingsong Li, and Scott Michell. The wolfspar® ﬁeld
trial: Results from a low-frequency seismic survey designed for fwi. In SEG Technical Program Expanded
Abstracts 2018, pages 1083–1087. Society of Exploration Geophysicists, 2018.

[12] John Brittan and Ian Jones. Fwi evolution—from a monolith to a toolkit. The Leading Edge, 38(3):179–184, 2019.

[13] Duncan Bate and TGS Mike Perz. Ultra-long offsets signal a bright future for obn. 2021.

[14] Biondo Biondi and Paul Sava. Wave-equation migration velocity analysis. In SEG Technical Program Expanded

Abstracts 1999, pages 1723–1726. Society of Exploration Geophysicists, 1999.

[15] Biondo Biondi and William W Symes. Angle-domain common-image gathers for migration velocity analysis by

waveﬁeld-continuation imaging. Geophysics, 69(5):1283–1298, 2004.

37

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 41: Velocity proﬁles of the initial model (red curve), true model (blue curve), and the ﬁnal FWIME inverted
model. (a) Vertical proﬁle extracted at x = 6 km. (b) Horizontal proﬁle extracted at z = 1.5 km.

[16] Paul Sava and Biondo Biondi. Wave-equation migration velocity analysis. i. theory. Geophysical Prospecting,

52(6):593–606, 2004.

[17] Tongning Yang. Waveﬁeld tomography using extended images. PhD thesis, Colorado School of Mines. Arthur

Lakes Library, 2013.

[18] Esteban F Díaz Pantin. Extended imaging and tomography under two-way operators. PhD thesis, Colorado

School of Mines. Arthur Lakes Library, 2016.

[19] Jon F Claerbout. Imaging the earth’s interior. Blackwell scientiﬁc publications Oxford, 1985.
[20] Arnaud Pladys, Romain Brossier, Yubing Li, and Ludovic Métivier. On cycle-skipping and misﬁt function
modiﬁcation for full-wave inversion: Comparison of ﬁve recent approaches. Geophysics, 86(4):R563–R587, 2021.
[21] William W Symes. Migration velocity analysis and waveform inversion. Geophysical prospecting, 56(6):765–790,

2008.

[22] Clement Fleury and Francesco Perrone. Bi-objective optimization for the inversion of seismic reﬂection data:
Combined fwi and mva. In SEG Technical Program Expanded Abstracts 2012, pages 1–6. Society of Exploration
Geophysicists, 2012.

[23] Biondo Biondi and Ali Almomin. Simultaneous inversion of full data bandwidth by tomographic full-waveform

inversion. Geophysics, 79(3):WA129–WA140, 2014.

[24] Yin Huang and William W Symes. Born waveform inversion via variable projection and shot record model
extension. In SEG Technical Program Expanded Abstracts 2015, pages 1326–1331. Society of Exploration
Geophysicists, 2015.

[25] Guanghui Huang, Rami Nammour, and William Symes. Full-waveform inversion via source-receiver extension.

Geophysics, 82(3):R153–R171, 2017.

[26] Qiang Guo, T Alkhalifah, and Zedong Wu. Velocity building by reﬂection waveform inversion without cycle-
skipping. In 79th EAGE Conference and Exhibition 2017, volume 2017, pages 1–5. European Association of
Geoscientists & Engineers, 2017.

[27] Guillaume Barnier and Ettore Biondi. Full waveform inversion by model extension using a model-space multi-
scale approach. In SEG Technical Program Expanded Abstracts 2020, pages 646–650. Society of Exploration
Geophysicists, 2020.

[28] Ludovic Métivier and Romain Brossier. Receiver-extension strategy for time-domain full-waveform inversion

using a relocalization approach. Geophysics, 87(1):R13–R33, 2021.

[29] Tristan Van Leeuwen and Felix J Herrmann. Mitigating local minima in full-waveform inversion by expanding

the search space. Geophysical Journal International, 195(1):661–667, 2013.

[30] Tristan van Leeuwen, Felix J Herrmann, and Bas Peters. A new take on fwi-waveﬁeld reconstruction inversion. In
76th EAGE Conference and Exhibition 2014, volume 2014, pages 1–5. European Association of Geoscientists &
Engineers, 2014.

38

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

(f)

(g)

(h)

(i)

Figure 42: Observed data, dobs (left column), predicted data, f (Simi) (middle column), and data difference, ∆d(mi) =
dobs − f (Simi) (right column) for a shot located at x = 6.3 km computed with the FWIME inverted models at various
stages of the FWIME workﬂow. Initial model (ﬁrst row), inverted model on the ﬁrst spline grid S0 (second row), and
ﬁnal inverted model (third row). All panels are displayed on the same grayscale.

[31] Michael Warner and Lluís Guasch. Adaptive waveform inversion-fwi without cycle skipping-theory. In 76th
EAGE Conference and Exhibition 2014, volume 2014, pages 1–5. European Association of Geoscientists &
Engineers, 2014.

[32] Michael Warner and Lluís Guasch. Adaptive waveform inversion: Theory. Geophysics, 81(6):R429–R445, 2016.

[33] Lluís Guasch, Michael Warner, and Céline Ravaut. Adaptive waveform inversion: Practice. Geophysics,

84(3):R447–R461, 2019.

[34] Hossein S Aghamiry, Ali Gholami, and Stéphane Operto. Improving full-waveform inversion by waveﬁeld
reconstruction with the alternating direction method of multipliers. Geophysics, 84(1):R125–R148, 2019.

[35] Yuanyuan Li and Tariq Alkhalifah. Extended full waveform inversion with matching ﬁlter. Geophysical Prospect-

ing, 2021.

39

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 43: RTM images computed with different velocity models. (a) Initial velocity model. (b) Final FWIME inverted
model. (c) True velocity model (for reference). Panels (a) and (b) are displayed with the same grayscale.

(c)

[36] Ludovic Métivier, Romain Brossier, Quentin Mérigot, Edouard Oudet, and Jean Virieux. Measuring the misﬁt
between seismograms using an optimal transport distance: Application to full waveform inversion. Geophysical
Supplements to the Monthly Notices of the Royal Astronomical Society, 205(1):345–377, 2016.

[37] Carlo Fortini, Vincenzo Lipari, Nicola Bienati, Jacopo Panizzardi, and Stefano Tubaro. Robust reﬂection full
waveform inversion with exponential signal encoding. In 2018 SEG International Exposition and Annual Meeting.
OnePetro, 2018.

[38] Ludovic Métivier, Aude Allain, Romain Brossier, Quentin Mérigot, Edouard Oudet, and Jean Virieux. Optimal
transport for mitigating cycle skipping in full-waveform inversion: A graph-space transform approach. Geophysics,
83(5):R515–R540, 2018.

[39] Guillaume Barnier, Ettore Biondi, Robert G. Clapp, and Biondo Biondi. Full waveform inversion by model
extension: theory, design and optimization. Retrieved June 2, 2022 from the arXiv database (submitted to
Geophysics), 2022. arXiv:2205.14341.

[40] Gary S Martin, Robert Wiley, and Kurt J Marfurt. Marmousi2: An elastic upgrade for marmousi. The leading

edge, 25(2):156–166, 2006.

[41] FJ Billette and Sverre Brandsberg-Dahl. The 2004 bp velocity benchmark. In 67th EAGE Conference & Exhibition,

pages cp–1. European Association of Geoscientists & Engineers, 2005.

[42] Guillaume Barnier, Ettore Biondi, Robert G Clapp, and Biondo Biondi. Full waveform inversion by model

extension: Theory, design and optimization. Geophysics, 2022.

[43] Guillaume Barnier, Ettore Biondi, and Robert Clapp. Waveform inversion by model reduction using spline

interpolation. In SEG International Exposition and Annual Meeting. OnePetro, 2019.

[44] Guillaume Barnier, Ettore Biondi, and Biondo Biondi. Full waveform inversion by model extension. In SEG

Technical Program Expanded Abstracts 2018, pages 1183–1187. Society of Exploration Geophysicists, 2018.
[45] William W Symes and Michel Kern. Inversion of reﬂection seismograms by differential semblance analysis:

Algorithm structure and synthetic examples 1. Geophysical Prospecting, 42(6):565–614, 1994.

[46] Gene H Golub and Victor Pereyra. The differentiation of pseudo-inverses and nonlinear least squares problems

whose variables separate. SIAM Journal on numerical analysis, 10(2):413–432, 1973.

[47] Richard C Aster, Brian Borchers, and Clifford H Thurber. Parameter estimation and inverse problems. Elsevier,

2018.

[48] Christopher Leader. The separation and imaging of continuously recorded seismic data. PhD thesis, Stanford

University, 2015.

[49] Romain Brossier, Stéphane Operto, and Jean Virieux. Velocity model building from seismic reﬂection data by

full-waveform inversion. Geophysical Prospecting, 63(2):354–367, 2015.

40

A PREPRINT - JUNE 7, 2022

(a)

(b)

(c)

(d)

(e)

(f)

(g)

(h)

Figure 44: Angle domain common image gathers (ADCIGs) computed with the initial model (top row) and the ﬁnal
FWIME inverted model (bottom row) at four different horizontal positions. First column is at x = 3 km, second column
is at x = 4 km, third column is at x = 5 km, and fourth column is at x = 6 km. All panels are displayed on the same
grayscale.

[50] Wei Zhou, Romain Brossier, Stéphane Operto, and Jean Virieux. Full waveform inversion of diving & reﬂected
waves for velocity model building with impedance inversion based on scale separation. Geophysical Journal
International, 202(3):1535–1554, 2015.

[51] R Versteeg and G Grau. Practical aspects of seismic data inversion, the marmousi experience: Proceedings of

1990 eaeg workshop. In 52nd Annual Meeting, Soc. Expl. Geophys, 1990.

[52] Gary S Martin, Kurt J Marfurt, and Shawn Larsen. Marmousi-2: An updated model for the investigation of avo in
structurally complex areas. In SEG Technical Program Expanded Abstracts 2002, pages 1979–1982. Society of
Exploration Geophysicists, 2002.

[53] Charles Cerjan, Dan Kosloff, Ronnie Kosloff, and Moshe Reshef. A nonreﬂecting boundary condition for discrete

acoustic and elastic wave equations. Geophysics, 50(4):705–708, 1985.

[54] Johan OA Robertsson. A numerical free-surface condition for elastic/viscoelastic ﬁnite-difference modeling in the

presence of topography. Geophysics, 61(6):1921–1934, 1996.

[55] Peng Guo, Huimin Guan, and George A McMechan. Data-and model-domain up/down wave separation for
reverse-time migration with free-surface multiples. Geophysical Journal International, 223(1):77–93, 2020.
[56] Dirk J Verschuur, AJ Berkhout, and CPA Wapenaar. Adaptive surface-related multiple elimination. Geophysics,

57(9):1166–1177, 1992.

[57] Anatoly Baumstein and Mohamed T Hadidi. 3d surface-related multiple elimination: Data reconstruction and

application to ﬁeld data. Geophysics, 71(3):E25–E33, 2006.

41

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 45: 2D panels of velocity models. (a) True model. (b) Initial model.

(a)

(b)

(c)

(d)

Figure 46: Depth velocity proﬁles extracted through the salt body at (a) x = 14 km, (b) x = 15 km, (c) x = 16 km, and
(d) x = 17 km. The black curve represents the initial model, the red curve is the true model, and the blue curve is the
ﬁnal FWIME inverted model.

(a)

(b)

(c)

Figure 47: Amplitude spectra of the seismic sources employed in this numerical example. (a) Sequence of sources used
for the data-space multi-scale FWI workﬂow using unrealistic low-frequency energy. (b) Sequence of sources used for
the data-space multi-scale FWI workﬂow using energy restricted to the 1.8-9 Hz bandwidth. (c) Source used for the
FWIME workﬂow with energy restricted to 3-9 Hz.

42

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 48: 2D panels of velocity models. (a) Initial model used for both the FWI and FWIME schemes. (b) Inverted
model after conventional multi-scale FWI using unrealistic low-frequency energy restricted to the 0-9 Hz range. (c)
Inverted model after conventional multi-scale FWI using energy restricted to the 1.8-9 Hz range. (d) True model.

(a)

(b)

Figure 49: Representative shot gathers of the observed data for sources placed at (a) x = 0 km and (b) x = 16 km for
the ultra-long offset acquisition. All panels are displayed with the same grayscale.

43

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 50: Normalized initial search directions (before applying any spline parametrization). (a) Born component of the
FWIME search direction. (b) Tomographic component of the search direction. (c) Total FWIME search direction (sum
of panels (a) and (b)). (d) True search direction. Panels (a), (b), and (c) are normalized with the same value.

[58] Bill Dragoset, Eric Verschuur, Ian Moore, and Richard Bisley. A perspective on 3d surface-related multiple

elimination. Geophysics, 75(5):75A245–75A261, 2010.

[59] Ali Siahkoohi, Dirk J Verschuur, and Felix J Herrmann. Surface-related multiple elimination with deep learning.
In SEG Technical Program Expanded Abstracts 2019, pages 4629–4634. Society of Exploration Geophysicists,
2019.

[60] Yang Zhang. Velocity Model Building Using Residual-Moveout-Based Wave-Equation Migration Velocity Analysis.

Stanford University, 2015.

[61] Odile Gauthier, Jean Virieux, and Albert Tarantola. Two-dimensional nonlinear inversion of seismic waveforms:

Numerical results. Geophysics, 51(7):1387–1403, 1986.

[62] Martin D Buhmann. Radial basis functions. Acta numerica, 9:1–38, 2000.
[63] Bradley Martin, Bengt Fornberg, and Amik St-Cyr. Seismic modeling with radial-basis-function-generated ﬁnite

differences. Geophysics, 80(4):T137–T146, 2015.

[64] Taylor Dahlke, Biondo Biondi, and Robert Clapp. Applied 3d salt body reconstruction using shape optimization

with level sets. Geophysics, 85(5):R437–R446, 2020.

[65] Ettore Biondi, Guillaume Barnier, Robert G Clapp, Francesco Picetti, and Stuart Farris. An object-oriented
optimization framework for large-scale inverse problems. Computers & Geosciences, 154:104790, 2021.
[66] Wenzel Jakob, Jason Rhinelander, and Dean Moldovan. pybind11 – seamless operability between c++11 and

python, 2017. https://github.com/pybind/pybind11.

[67] Philip E Gill, Walter Murray, and Margaret H Wright. Practical optimization. SIAM, 2019.
[68] Jorge J Moré and David J Thuente. Line search algorithms with guaranteed sufﬁcient decrease. ACM Transactions

on Mathematical Software (TOMS), 20(3):286–307, 1994.

[69] Paulius Micikevicius. 3d ﬁnite difference computation on gpus using cuda. In Proceedings of 2nd workshop on

general purpose processing on graphics processing units, pages 79–84, 2009.

[70] Guillaume Barnier, Ettore Biondi, and Stuart Farris. Fwime-applications: v1.0.0. [software]: GitHub, https:

//github.com/gbarnier/FWIME-applications, 2022.

44

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 51: Normalized initial search directions after being mapped on the ﬁrst spline grid (obtained by applying S0S∗
0
to the panels in Figure 50). (a) Born component of the FWIME search direction. (b) Tomographic component of the
search direction. (c) Total FWIME search direction (sum of panels (a) and (b)). (d) True search direction. Panels (a),
(b), and (c) are normalized with the same value.

(a)

(b)

Figure 52: Normalized initial search directions. (a) Conventional FWI. (b) Conventional FWI after applying S0S∗
panel (a).

0 to

45

A PREPRINT - JUNE 7, 2022

(a)

(c)

(e)

(b)

(d)

(f)

Figure 53: 2D panels of velocity models inverted on the various spline grids throughout the FWIME workﬂow: (a)
Initial model (b) ﬁrst grid, (c) second grid, (d) fourth grid, and (e) ﬁnal inverted model after a total of 250 L-BFGS
iterations. (f) True model.

46

A PREPRINT - JUNE 7, 2022

Figure 54: Convergence curves for the numerical test conducted on the wide salt model (Figure 45(a)). Total normalized
FWIME objective function (blue curve), and normalized FWI objective function evaluated at each FWIME inverted
model (red curve). We obtain full convergence after 250 L-BFGS iterations.

(a)

(b)

Figure 55: 2D panels of FWIME models inverted with a different spline grid reﬁnement schedule as the one shown in
Table 3. (a) Inverted model starting from spline 2. (b) Inverted model without the use of spline 2.

[71] Cornelis Pieter Arie Wapenaar. Elastic wave ﬁeld extrapolation: Redatuming of single-and multi-component

seismic data. Elsevier, 2014.

[72] Matteo Ravasi. Rayleigh-Marchenko redatuming for target-oriented, true-amplitude imaging. Geophysics,

82(6):S439–S452, 2017.

[73] Qiang Guo and Tariq Alkhalifah. Target-oriented inversion with least-squares waveform redatuming. In SEG

Technical Program Expanded Abstracts 2019, pages 1521–1525. Society of Exploration Geophysicists, 2019.

[74] Aayush Garg and DJ Verschuur. From surface seismic data to reservoir elastic parameters using a full-waveﬁeld

redatuming approach. Geophysical Journal International, 221(1):115–128, 2020.

[75] Ettore Biondi. Target-Oriented Elastic Full-Waveform Inversion. PhD thesis, Stanford University, 2021.
[76] Ettore Biondi, Mark Meadows, and Biondo Biondi. Amplitude preserving migration through extended acoustic
least-squares rtm. In SEG Technical Program Expanded Abstracts 2019, pages 4196–4200. Society of Exploration
Geophysicists, 2019.

[77] Ettore Biondi, Biondo Biondi, and Guillaume Barnier. Target-oriented elastic full-waveform inversion through
extended-migration redatuming. In SEG Technical Program Expanded Abstracts 2018, pages 1228–1232. Society
of Exploration Geophysicists, 2018.

47

A PREPRINT - JUNE 7, 2022

(a)

(c)

(b)

(d)

Figure 56: 2D panels of velocity models inverted on the various spline grids throughout the FWIME workﬂow: (a)
Initial narrow salt model, (b) FWIME model after 250 L-BFGS iterations, (c) FWIME inverted model after 500 L-BFGS
iterations, and (d) true model.

(a)

(b)

Figure 57: Representative shot gathers of the observed data for sources placed at (a) x = 0 km and (b) x = 9 km for the
narrow salt model. All panels are displayed with the same grayscale.

48

A PREPRINT - JUNE 7, 2022

Figure 58: Convergence curves for the numerical test conducted on the narrow salt model (Figure 56(d)). Total
normalized FWIME objective function (blue curve), and normalized FWI objective function evaluated at each FWIME
inverted model (red curve). We obtain full convergence after 500 L-BFGS iterations.

(a)

(c)

(b)

(d)

Figure 59: 2D panels of velocity models. (a) Initial model. (b) Conventional data-space multi-scale FWI inverted model
using a 0-8 Hz dataset. (c) Conventional data-space multi-scale FWI inverted model using a 3-8 Hz dataset. (d) True
model.

49

A PREPRINT - JUNE 7, 2022

(a)

(b)

Figure 60: Representative shot gathers generated with a source wavelet contaning energy restricted to the 3-8 Hz range.
(a) Source placed at x = 4 km. (b) Source placed at x = 20 km. All panels are displayed with the same grayscale.
White arrows show the energy recorded from diving waves traveling through the low-velocity zone underneath the salt
structure. Green arrows correspond to reﬂected energy from the base salt.

(a)

(b)

(c)

Figure 61: Amplitude spectra of the seismic sources employed in this numerical example. (a) Sequence of sources used
for the data-space multi-scale FWI workﬂow using unrealistic low-frequency energy. (b) Sequence of sources used
for the data-space multi-scale FWI workﬂow using energy restricted to the 2-8 Hz bandwidth. (c) Source used for the
FWIME workﬂow, containing energy within the 3-8 Hz bandwidth.

50

A PREPRINT - JUNE 7, 2022

(a)

(c)

(e)

(g)

(b)

(d)

(f)

(h)

Figure 62: 2D panels of FWIME inverted model at various stages of the inversion process. (a) Initial step. (b) Spline 1.
(c) Spline 2. (d) Spline 3. (e) Spline 4. (f) Spline 5. (g) Final FWIME inverted model on the last spline. (h) True model.
The last spline grid coincides with the FD grid. Panel (g) is obtained after a total of 258 iteration of L-BFGS.

51

A PREPRINT - JUNE 7, 2022

Figure 63: Total normalized FWIME objective function (blue curve), and normalized FWI objective function evaluated
at each FWIME inverted model (red curve).

(a)

(b)

(c)

(d)

(e)

(f)

Figure 64: Representative shot gathers for sources placed at x = 4 km (ﬁrst row) and x = 20 km (second row).
Observed data, dobs (ﬁrst column), Predicted data with the ﬁnal FWIME model, f (mF W IM E) (second column), and
data-difference, ∆d(mF W IM E) = dobs − f (mF W IM E) (third column). All panels are displayed with the same
grayscale.

52

