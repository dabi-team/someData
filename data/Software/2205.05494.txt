2
2
0
2

y
a
M
1
1

]
i
c
s
-
l
r
t

m

.
t
a
m
-
d
n
o
c
[

1
v
4
9
4
5
0
.

5
0
2
2
:
v
i
X
r
a

Journal of Synchrotron Radiation

ISSN 1600-5775

darﬁx: Data analysis for dark-ﬁeld X-ray microscopy
J´ulia Garriga Ferrer,a* Raquel Rodr´ıguez-Lamas,a Henri Payno,a Wout De
Nolf,a Phil Cook,a Vicente Armando Sol´e Jover,a Vincent Favre-Nicolin,a
Can Yildirima and Carsten Detlefsa
aESRF, The European Synchrotron, 71 Avenue des Martyrs, CS40220, 38043 Grenoble Cedex
9, France, and bDepartment of Physics, Technical University of Denmark, 2800 Kgs. Lyngby,

Denmark. Correspondence e-mail: julia.garriga@esrf.fr

A Python package for the analysis of dark-ﬁeld X-ray microscopy (DFXM) and
rocking curve imaging (RCI) data is presented. darﬁx provides a set of data pro-
cessing and visualization tools that can be either imported as library components
or accessed through a graphical user interface (GUI) as an Orange add-on. In the
latter case, the different analysis modules can be easily chained to deﬁne compu-
tational workﬂows. Operations on larger-than-memory image sets are supported
through the implementation of online versions of the data processing algorithms,
effectively trading performance for feasibility when the computing resources are
limited. The software can automatically extract the relevant instrument angle set-
tings from the input ﬁles metadata. The currently available input ﬁle format is
EDF and in future releases HDF5 will be incorporated.

© 0000 International Union of Crystallography

1. Introduction

Dark-ﬁeld X-ray microscopy (DFXM) is a novel full-ﬁeld
imaging technique that non-destructively maps the 3D struc-
ture, orientation and strain of deeply embedded crystalline ele-
ments, such as grains or domains (Simons et al., 2015; Poulsen
et al., 2017; Poulsen, 2020; Yildirim et al., 2020). Direct-
space images are formed by placing an X-ray objective lens
along the diffracted beam, affording a spatial resolution on the
order of 100 nm, while maintaining a working distance between
the sample and X-ray objective lens that is in the cm-range.
The ﬁrst implementation of a dedicated dark-ﬁeld x-ray micro-
scope was recently installed on beamline ID06-HXM of the
European Synchrotron Radiation Facility (Kutsal et al., 2019).
Since its installation, this instrument has been used to investi-
gate a variety of scientiﬁc subjects, including the domain evo-
lution in ferroelectrics (Simons et al., 2018), the austenitic
transformation in shape memory alloys (Bucsek et al., 2019),
recovery in metals (Mavrikakis et al., 2019; Ahl et al., 2020),
embedded particles in steel (Hlushko et al., 2020), visualization
of dislocation structures (Jakobsen et al., 2019; Dresselhaus-
Marais et al., 2021a), and the structure of biominerals (Cook
et al., 2018; Schoeppler et al., 2022).

DFXM is conceptually similar

to dark-ﬁeld electron
microscopy in transmission electron microscopy (TEM), which
is used to selectively image strain and orientation across mate-
rials science, physics, geoscience and numerous other ﬁelds
(Williams & Carter, 1996; Nellist, 2000; Ruben et al., 2005).

2. Dark Field X-ray Microscopy

Figure 1
Geometry of the dark-ﬁeld X-ray microscope at ID06-HXM at the ESRF. The
incident beam (cid:126)k0 travels along the laboratory x(cid:96) axis. The optical axis of the
objective (CRL) lens is aligned to the direction of the diffracted beam(cid:126)kd . The
pivot point of the goniometer and sample is coincident with the intersection of
these two optical axes. Vector (cid:126)Q deﬁnes the local scattering vector at a given
point (cid:126)r(x, y, z) within the sample, and may be parameterized by the scattering
(cid:12)
(cid:12)
(cid:126)Q
(cid:12)
(cid:12)
angle 2θ, the azimuthal angle η and the length of the vector
(cid:12). The value of
(cid:12)
(cid:12)
(cid:12)
(cid:126)Q
(cid:12)
(cid:12)
(cid:12) is related to the spacing of the lattice plane being measured, dhk(cid:96), and the
(cid:12)
X-ray wavelength, λ, by Bragg’s law. The goniometer is associated with a base
tilt, µ, an ω-rotation around (cid:126)Q and two tilts, χ and φ. d1 is the distance from the
sample to the entry point of the objective and d2 is the distance from the exit
point of the objective to the detector. The positive directions of the angles are
indicted. This ﬁgure is adapted from Poulsen et al. (2017).

The geometry of DFXM is illustrated in Fig. 1. Further
details can be found in Poulsen et al. (2017) and Kutsal et al.
(2019). A nearly monochromatic and nearly collimated X-ray
beam illuminates the sample. This beam may be condensed
in the vertical and horizontal direction to increase the beam
intensity in the ﬁeld of view, or to selectively illuminate a thin

J. Synchrotron Rad. (0000). 00, 000000

J. Garriga et al. · darﬁx

1

 
 
 
 
 
 
layer within the sample. The energy bandwidth is of the order
∆E/E ≈ 1.4 · 10−4.

The goniometer is designed to access diffraction angles in a
nearly vertical scattering geometry, and probe reciprocal space
only in the immediate vicinity of a given Bragg reﬂection
(h, k, (cid:96)). The current implementation of DFXM at ID06-HXM,
ESRF achieves this by moving the sample along a combination
of µ, ω, χ and φ rotation stages, see Fig. 1. The direction of
the diffracted beam is characterized by the scattering angle, 2θ,
and the azimuthal angle, η. In most experiments the sample is
aligned such that η ≈ 0.

The optical axis of an X-ray objective is aligned to the
diffracted beam to produce a magniﬁed image (inverted in both
directions) on the 2D detector. The magniﬁcation can be calcu-
lated from the distances d1 (sample to objective) and d2 (objec-
tive to detector), and experimentally veriﬁed by observing the
displacement of the image upon small calibrated translations of
the sample.

In addition to the magniﬁed DFXM images, there are fur-
ther 2D detectors to record non-magniﬁed images, e.g. a “near
ﬁeld camera” positioned directly downstream of the sample
(Kutsal et al., 2019). This can be used for classical diffraction
topography and its extension, rocking curve imaging (Tran Thi
et al., 2017).

2.1. Scan types

The 2D images recorded as function of the different rotation
angles form the main data sets of DFXM. darﬁx facilitates the
treatment of the individual raw images and the systematic anal-
ysis of scans.

Scan ranges and step size are generally a compromise of

completeness and resolution vs. scan duration.

The following recurring scan types are commonly used in

DFXM:

2.1.1. Rocking curve imaging: Rocking curve imaging is an
extension of classical diffraction topography: The diffraction
topograph is measured as a function of the “rocking” angle,
µ (see Fig. 1). Rocking curve imaging is typically performed
without the magnifying objective lens, using the near ﬁeld cam-
era. In this case the resolution in the 2θ and transverse (χ-)
directions is relatively low (Tran Thi et al., 2017). It can, how-
ever, also be carried out in DFXM mode.

The rocking curve imaging module provides functions simi-
lar to the RCIA code (Tran Thi et al., 2017) within the work-
ﬂow of darﬁx. Its main function is to analyze the rocking curve
of each pixel by ﬁtting to a peak shape, e.g. a Gaussian. After
the ﬁt, maps of the ﬁt parameters (constant background, inte-
grated intensity, peak position and peak width) as function of
pixel position are generated (Tran Thi et al., 2017), as shown in
Fig. 3.

As a computationally less intensive alternative to ﬁtting,
moments of the intensity as function of the angle can be com-
puted. For a perfectly Gaussian distribution, the zero order
moment corresponds to the integrated intensity, the ﬁrst order
moment (center of mass) to the peak position, and the second

order moment (variance) to the square of the rms peak width.
These can be used as starting values for the Gaussian ﬁt. darﬁx
can furthermore calculate the third (skewness) and fourth (kur-
tosis) moments. The moments can also be presented as color
maps.

2.1.2. Mosaicity scans: Mosaicity scans can be seen as a
generalization of rocking curve imaging, taking advantage of
the improved resolution in the transverse (χ-) direction due to
the limited angular acceptance of the objective lens (Poulsen
et al., 2017). Similar to rocking curve imaging, the depen-
dence of the intensity on two rotation angles, the “rocking”
and “rolling” angles, µ and χ respectively, is analyzed for
each pixel. Typically moments are calculated. The ﬁrst-order
moments (center-of-mass) correspond to the local orientation
of the diffracting planes. Due to the narrow acceptance of the
objective lens in the 2θ direction, the magnitude of the scat-
tering vector remains constant (Poulsen et al., 2017) such that
only shear strains and lattice rotations are measured (Poulsen
et al., 2021). Again, the results can be represented in a color
map, using a 2D color plane that encodes both rotation angles.
Some examples are shown in Fig. 4 (section 4.4), where the
center of mass color maps for µ (Fig. 4a) and χ (Fig. 4b) are
shown.

2.1.3. Strain scans: In strain scans, the scattering angle 2θ
is varied in order to probe spatial variations in the d-spacing
of selected Bragg reﬂection (Poulsen et al., 2017; Poulsen
et al., 2021). Typically strain maps are constructed from a series
of rocking scans performed consecutively over a given range of
scattering angles.

2.1.4. Combined mosaicity-strain scans: By recording a (2D)
mosaicity map instead of a (1D) rocking curve scan at each 2θ
position, all 3 directions in reciprocal space are probed. This is
the most complete type of DFXM scan. However, as a 3D mesh
of motor positions must be scanned, this scan type also requires
the longest data acquisition time and yields the largest raw data
volumes.

2.1.5. Reciprocal space mapping: This type of scan is simi-
lar to rocking curve imaging, but without the objective lens. The
images are recorded on a large ﬁeld of view camera positioned
in the farﬁeld (i.e. ≈5 m from the sample, Kutsal et al., 2019).
This type of scans provides angular information in three dimen-
sions, µ (scan axis), η and 2θ (derived from the pixel posi-
tion, see Fig. 1 and Poulsen et al. (2017)). Similar to rocking
curve real space imaging, the analysis includes integrated inten-
sity and center-of-mass visualization. Reciprocal space map-
ping can be used, e.g., to determine twin relationships between
domains in ferroelastic materials (Gorfman et al., 2022).

2.1.6. Layer scans: All of the scans listed above can be
performed with a line-focused beam illuminating a single,
≈150 µm thick layer within the sample. Layers recorded at a
series of heights within the sample can then be combined into

2

J. Garriga et al. · darﬁx

J. Synchrotron Rad. (0000). 00, 000000

3D volume maps.

3. The darﬁx codebase

darﬁx is a Python library that provides a set of computer vision
techniques for the analysis of dark-ﬁeld X-ray microscopy data.
It is split into two modules: a back end that contains the core
processing utilities, algorithm implementations and abstrac-
tions, and a graphical user interface (GUI). The typical user
would interact with the core module through the GUI, but it is
possible and straightforward to access the core methods directly
by importing that part of the library. The central code object
is Dataset, which encapsulates the properties of a stack of
images (multiple rotation angles can vary within a single stack
of images, each axis adds a dimension to the image stack).
Operations on the source data (e.g. blind source separation, hot
pixel removal, shift correction) are implemented as pure trans-
formations acting on this entity, such that there are no side
effects and the operations can be chained together to deﬁne
a computational workﬂow. Furthermore, as datasets are com-
monly of the order of several hundred gigabytes, the software
provides online versions for many of the data processing algo-
rithms: the output is build incrementally while adapting the
changes to the input. These options work without loading the
data in the computer memory so that computation is feasible
on memory constrained machines. If the option data in disk is
selected when loading the data, these versions will be automat-
ically used along the workﬂow.

darﬁx does not have a stand-alone application, but includes
an Orange (Demˇsar & Zupan, 2013) add-on for the deﬁni-
tion of workﬂows. Orange is a platform to perform data anal-
ysis and visualization, and which allows for the creation of
workﬂows using the darﬁx GUI. A typical workﬂow comprises
task such as raw data selection, background removal, region-
of-interest selection, scan variable identiﬁcation, scan process-
ing (e.g. rocking curve ﬁtting), display of the results, etc. (see
Fig. 2). All the tasks in darﬁx are independent (in the GUI as
well as in the processing part), so that for every task there is a
different widget. These widgets are based on Qt (The Qt Com-
pany, 2021) and silx (Vincent et al., 2021). They can be linked
through the workﬂow created in Orange. In addition, workﬂows
in Orange can be called from the command line with different
input datasets. The algorithms that were used in the original
workﬂow will be then reproduced without the need of the GUI.
In addition, a workﬂow deﬁned from the GUI can be saved with
it settings and reused using ewoks (De Nolf et al., 2022). This
allows users to launch the same workﬂow (algorithms and set-
tings) but with a different input data set. This is particularly use-
ful when the same workﬂow has to be carried out for a series of
datasets, e.g. the same analysis has to be applied to every layer
in a 3D volume map.

darﬁx contains a series of image processing methods for the
analysis of DFXM scans. These methods can be separated in
three parts: the selection of the data, the pre-processing algo-
rithms, and the analysis and visualization of the results. The
following sections will show the used techniques and how they
are implemented.

3.1. File inputs: data selection

Currently, darﬁx accepts the ESRF data format (.edf) of the
ID06 detectors, and is able to automatically characterize the
relevant instrument angle settings by analyzing the input ﬁles’
metadata. HDF5 (The HDF Group, 1997-2022; Collette, 2013)
is accepted, but only without dimension deﬁnition as the analy-
sis of metadata is still under development.

Output data can be saved from the GUI in different formats:
EDF, HDF5 (NeXus data format, K¨onnecke et al., 2015) , CSV,
TIFF, Numpy, ASCII and PNG. In the analysis there is usu-
ally the possibility to export speciﬁc data in a HDF5 ﬁle, which
can then be used for any needed post-processing. Alternatively,
when working without the GUI, numpy arrays can be extracted
from the Dataset object for further processing.

Modiﬁed data is automatically saved on disk under a treated
data folder chosen by the user. By default, only the most recent
data of the workﬂow is saved, but there exists the possibility to
copy the data using the Data copy widget.

Exporting data in a format compatible with 3D visualization
and processing software, e.g. Paraview (Ahrens et al., 2005;
Ayachit, 2015) is planned for a future release.

3.2. Pre-processing

3.2.1. Noise removal: It is common to have noise along the
set of data images, that either comes from the lens, the environ-
ment or the diffraction of the sample. The ﬁrst step (or second
if we apply a region of interest to the data) of the pre-analysis
is to detect and remove this noise from the sequence of images.
darﬁx provides the following tools for noise removal:

Background subtraction: This is a widely used approach
that calculates the foreground mask of an image by subtract-
ing it from a background model containing the static part of
an image sequence. In darﬁx, the background is an image that
can either be calculated using the mean or the median of a set
of data images (for example dark images from the scan). This
background image is then subtracted from each of the origi-
nal images to obtain the foreground mask. While both mean
and median ﬁlters can be used depending on the input dataset,
the median ﬁlter is more robust and realistic (the output pixels
are always one of the stack) than the mean ﬁlter, although the
median ﬁlter needs either memory or time. To speed up the pro-
cess when the data is not in memory the user has two options:

• Select chunks of a certain shape so that the median is
applied consecutively in all of them. Although this meth-
ods obtains a median of all the images, it is still time
consuming as the input/output operations slow a lot the
process.

• Only use a subgroup of the stack of images to calculate
the median: the user inputs a step k value so that the algo-
rithm selects the images with index i, i + k, i + 2k, ....

Hot pixel removal: Sometimes, after performing background
subtraction on the images, isolated groups of pixels appear at
some or all of the images in the stack. These pixels are called
“hot” because they have higher intensity than the other pixels

J. Synchrotron Rad. (0000). 00, 000000

J. Garriga et al. · darﬁx

3

around them, and they are usually not part of the object we want
to analyze but noise that needs to be retrieved. As the hot pixels
are independent from one image to the other, this technique can
be applied sequentially to the stack:

It is possible to ﬁnd and apply the shift along a chosen dimen-
sion. In this case, a different shift is detected for every value of
the chosen dimension. These shifts can then be applied to their
corresponding images.

• Apply a median ﬁlter to every image of the stack and sub-

tract it from the original image.

• The hot pixels are identiﬁed as the ones with higher value

than the standard deviation of this subtraction.

• The hot pixels intensity values are replaced by the val-
ues of their corresponding pixels in the image with the
median ﬁlter applied.

Threshold removal: Pixels with values lower than speciﬁed
will be set to 0.

The use of any or all of the noise removal tools is optional.

3.2.2. Image registration: Alignment errors in the experi-
mental hardware frequently cause a shift of the image as func-
tion of rotation angle. darﬁx contains a module for the detection
and correction of such shifts. We assume that the shift is a lin-
ear function of rotation angle, i.e. v(α) = αv0, where α is
the rotation angle relative to the scan center, and v0 is the dis-
placement vector in pixels/degree. The algorithm used to ﬁnd
the shift, which has proven to give acceptable results in a con-
siderably fast manner, is the following:

3.3. Scan analysis

After pre-processing, data can be further analysed according
to the type of scan performed during the experiment, see above.

3.3.1. Rocking curves ﬁtting: As described in section 2.1.1,

darﬁx allows for a rocking curve analysis.

The intensity of a pixel, Imeas,xy, as function of a motor posi-

tion, typically the rocking angle µ, is ﬁtted to a Gaussian,

Iﬁt,xy(µ) = bxy + Axy · exp

−

(cid:20)

1
2

(µ − pxy)2
σ2
xy

(cid:21)

.

(1)

Fitting all pixels in this way results in maps of the back-
ground (bxy), amplitude (Axy), peak position (pxy) and peak
width (σxy, full width at half maximum (FWHM) = 2.355σxy).
Furthermore the ﬁt generates a map of the chi-squared values,

χ2

xy =

(cid:88)

images

(Iﬁt,xy − Imeas,xy)2 ,

(2)

that can be used to assess deviations from a simple Gaussian
proﬁle.

For faster results, pixels with low intensities can be omitted

• Two images are obtained from the sum over axis 0 of the

from the ﬁt.

ﬁrst and second half of the dataset.

• The

shift vector v(cid:48) between the

two resulting
is determined using the scikit-image
function registra-

et al., 2014)

images
(van der Walt
tion.phase cross correlation.

• The linear shift is in the direction of the normalized shift:

v0 = h v(cid:48)/ |v(cid:48)|.

• The scaling factor h remains to be determined – it
depends on how the intensity of the images varies as func-
tion of α:
v∗
0 =
for h∗ ← 0 to 3ε do

2v0
num images

; ε = 3(cid:107)v∗

0 (cid:107)2

for i ← 0 to num images do

v∗(i) = ih∗v0
Shift image i using v∗(α) via an afﬁne trans-

formation

end for
Compute score using normalized variance of the

images sum
end for
h is the h∗ with maximum score

Once v has been determined, the images are shifted with
subpixel accuracy using the Discrete Fourier Transform (DFT)
algorithm. The library OpenCV (Bradski, 2000) is used both for
the afﬁne transformations and for the DFT algorithm.

One could use other strategies, e.g. a non-linear ﬁt, to opti-
mize h. In some cases, e.g. when summing the uncorrected
images leads to blurring, better results are obtained when the
shift correction is run several times.

2-dimensional scans, where e.g. two motors µ and χ are var-

ied, can be ﬁtted to a bivariate Gaussian,

Iﬁt,xy(µ, χ) = bxy + Axy · exp

−

(cid:34)

1
2(1 − ρ2

xy)

−2ρxy

(cid:18) µ − pµ,xy
σµ,xy

(cid:19) (cid:18) χ − pχ,xy

(cid:19)

σχ,xy

+

(cid:32)(cid:18) µ − pµ,xy
σµ,xy
(cid:18) χ − pχ,xy
σχ,xy

(cid:19)2

(cid:19)2(cid:33)(cid:35)

.(3)

Here pµ,xy and σµ,xy are maps of the peak position and peak
width of motor µ, pχ,xy and σχ,xy are maps of the peak position
and peak width of motor χ, and ρxy is the map of the Pearson
correlation coefﬁcient.

Additional line shapes are planned for a future release.

3.3.2. Grainplot: For scans where more than one motor
varies, such as mosaicity (µ–χ scans), the Grainplot tool can
calculate moments, e.g. the integrated intensity, center-of-mass
and standard deviation. In particular, for mosaicity scans, the
center-of-mass (COM) of the two scan motors are interpreted
as components of a 2D vector in the color plane. Both compo-
nents can then be displayed in a single graph. Intensity contours
in the corresponding color map represent a local pole ﬁgure of
the volume of interest.

3.3.3. Blind source separation: Blind source separation
(BSS) comprises all techniques that try to decouple a set of
source signals from a set of mixed signals with unknown (or
very little) information (Herault et al., 1985). Depending on the
assumptions of the data, different BSS techniques can be used.

4

J. Garriga et al. · darﬁx

J. Synchrotron Rad. (0000). 00, 000000

In DFXM, diffracting elements such as (sub)grains or fer-
roelastic domains can be interpreted as source signals that con-
tribute to the images. BSS can then be used to identify these
elements and extract the corresponding rocking curves, recipro-
cal space maps, etc. in a given dataset.

darﬁx implements several BSS techniques. For an easier anal-
ysis of the data, the images are ﬂattened and set as rows of a
single matrix X. The goal is to ﬁnd two matrices, H and W,
which product approximates X, and so that H rows are the com-
ponents we are looking for. H is called the components matrix
and W the mixing matrix. This approximation is done by opti-
mizing the distance d between X and the matrix product WH.
This approximation is usually done using the Frobenius norm.

The BSS techniques implemented in darﬁx are:

• Principal Component Analysis (PCA): PCA is a BSS
technique to recover a collection of orthogonal vectors
H, called principal components, and perform a change of
basis on the data which usually only uses the principal
components that better represent the data.
If the data is in memory, a PCA implementation based
on Martinsson et al. (2011) and Tipping & Bishop
(1999) is included. Otherwise we use the incremen-
tal PCA model from Ross et al. (2008). In both cases
the scikit-learn implementation (Pedregosa et al.,
2011) is used.
As the principal components are orthogonal, they do not
satisfy the non-negativity criterion for image intensity.
The principal components therefore can not be inter-
preted as diffracting crystal elements.
The eigenvalues of the principal components are very
useful to know how each of the components is present in
the dataset and to approximate a number of needed com-
ponents to represent it. This number of components can
then be used as input parameter for the other BSS meth-

ods described below.

• Non-negative Independent Component Analysis (NICA):
working with images, we can assume a constraint that
can help in the separation of the components: the non-
negativity of the sources. NICA ﬁnds the components
by assuming that they are non-Gaussian and statisti-
cally independent from each other (a technique known
as independent component analysis, ICA, (Hyv¨arinen
et al., 2001)), while restricting H to be non-negative. This
alternate way of approaching ICA has several algorithms
and methods presented such as (Yuan & Oja, 2004)
and (Ouedraogo et al., 2010). darﬁx implements the
method described in (Oja & Plumbley, 2004). However,
NICA does not require the mixing coefﬁcients to be non-
negative. Negative contributions of diffracting elements
to the image intensity are unphysical.

• Non-negative Matrix Factorization (NMF): we can con-
straint both the sources and the mixing elements (H and
W) to be non-negative. This constraint is called non-
negative matrix factorization and is another widely-used
technique for solving BSS (Lee & Seung, 1999). darﬁx
uses the implementation in scikit-learn to com-
pute NMF when the data is in memory. Otherwise our
own implementation is used based on the multiplicative
update rule (Lee & Seung, 2001). This method is applied
in chunks to avoid having all the data in memory.

• (NICA + NMF): The non-uniqueness (non-convexity)
property of NMF implies that the solution depends on the
initial factor matrices. To solve this problem we imple-
ment the idea presented in (Kitamura & Ono, 2016)
which suggests that a good initialization is based on the
factorization given by non-negative ICA.

3.4. Graphical user interface

J. Synchrotron Rad. (0000). 00, 000000

J. Garriga et al. · darﬁx

5

Figure 2
a) darﬁx GUI where a data preprocessing thread is shown, ﬁnalised by the Grainplot widget. b) raw data plotted as COM c) after background removal and threshold
removal d) after hot pixel removal and shift correction. The color bars represent scattering angles (2θ).

The GUI is programmed in Qt (The Qt Company, 2021) and
silx (Vincent et al., 2021) and it is structured to have a different
widget for each step in the data processing workﬂow. Orange
(Demˇsar & Zupan, 2013) is used to link all these widgets into a
single workﬂow and to pass information between them. Every
widget returns a new Dataset object which is the input to the
next step of the workﬂow. Fig. 2a shows an example of a typical
workﬂow comprising data selection, different pre-processing
steps, and shift correction. Fig. 2b, c and d show examples of
Grainplot of the intermediate and ﬁnal results of the workﬂow
(see below for details).

3.5. Open source, documentation and tutorials

darﬁx is open source under MIT license. The software can be
installed using pip, see https://pypi.org/project/
darfix/. User documentation can be found at https:
//gitlab.esrf.fr/XRD/darfix/-/blob/master/
docs/source/tutorials/darfix_guide.pdf.

4. Examples

Fig. 2a shows an example of a typical workﬂow comprising data
selection, different pre-processing steps, and shift correction.
Fig. 2b, c and d show examples, plotted as a Grainplot COM, of
the intermediate and ﬁnal results of the workﬂow (see below for
details). The represented data corresponds to a (200) reﬂection
of a grain in a Fe-3%Si sample that was produced as explained
in Mavrikakis et al. (2019).

4.1. Data selection and dimension deﬁnition

The ﬁrst step of the workﬂow is to select the input data. Next,
the dimensions are deﬁned, i.e. the motor(s) varying during the

scan and the number of points along each scan axis is deter-
mined (see Fig. 2). darﬁx will attempt an automatic dimension
deﬁnition. This will result in the automatic identiﬁcation of the
moving motors, the angular ranges, the step and the number of
steps on a scan. At the current version, dimension deﬁnition is
only available for data in EDF format, where motor positions
are automatically extracted from the metadata. Data in HDF5
can be analyzed, but at present the metadata is not used. After,
a region of interest can be deﬁned in order to reduce the data
volume and speed up processing.

4.2. Noise removal and Shift correction

Next, noise removal and shift correction, as detailed above,
are applied. The effect of these steps on the data is illustrated in
Fig. 2. Fig. 2b shows the raw data, followed by Fig. 2c where
a threshold removal had been executed and Fig. 2d where hot
pixel removal was also applied.

6

J. Garriga et al. · darﬁx

J. Synchrotron Rad. (0000). 00, 000000

4.3. Rocking curve imaging

tions 2.1.1 and 3.3.1 at each pixel of the data obtained from a
rocking scan. Moreover, darﬁx allows to input a 2D scan into
the rocking curve widget and performs a 2D ﬁt of the mosaicity
data (where the moving motors correspond to angular motions
in µ and χ).

Fig. 3 shows an example of the maps obtained from the rock-
ing curve analysis of the (200) reﬂection of Al (Dresselhaus-
Marais et al., 2021b), as well as the local rocking curve of a
selected pixel. While Fig. 3b presents the image obtained at a
certain µ the ﬁt maps Fig. 3 c-g provide information extracted
from the ﬁt of each pixel over the whole rocking curve. In
this example it can be seen that the “boundaries” between two
regions that diffract at different µ angle are the hardest to ﬁt,
as shown by the residuals (χ2) maps. These boundaries show
larger FWHM possibly related to a slightly gradual change in
orientation. The peak position map shows a constant gradient,
that can be related to an homogeneous deformation of the crys-
tal.

4.4. Mosaicity and strain scan

Figure 4
Center of mass maps a) for µ and b) χ c) Mosaicity map and orientation dis-
tribution color key of the mosaicity map with an overlaid contour map of the
integrated intensity indicates the angular spread for µ and χ.

Figure 4 shows a mosaicity map obtained from the projec-
tion of a grain in Fe-3%Si (Mavrikakis et al., 2019), in this case
the (200) reﬂection. Fig. 4a shows the peak position map of the
pitch (rocking angle µ), whereas Fig. 4b shows the peak posi-
tion in roll (angle χ). The two center-of-mass angles can be
combined into a color vector (Fig. 4c). This type of maps rep-
resent the local crystallographic orientation around the chosen
Bragg reﬂection. The contours in the color key (Fig. 4d) thus
represent a local pole ﬁgure of the (200) reﬂection.

Strain scans (varying µ and 2θ) can be analyzed in the same
way. The interpretation, however, is different, as these scans
measure the relative axial strain along a given crystallographic
plane. In contrast to mosaicity scans where the lattice distortion

Figure 3
Example of 1D rocking curve analysis, (a) ﬁt of the curve corresponding to
pixel indicated in (b) image at µ = −0.005 deg with a cross marking the pixel
of interest. Maps of the full stack of images composing the rocking scan, gen-
erated by the pixel by pixel ﬁt of (c) amplitude (d) background (e) full with half
maximum (f) peak position (g) residuals.

The rocking curve widget performs the ﬁt as described in sec-

J. Synchrotron Rad. (0000). 00, 000000

J. Garriga et al. · darﬁx

7

and orientation are measured, strain scans provide information
about the variation of the d-spacing of a given hkl plane of a
crystal.

4.5. Blind source separation

Figure 5
Example of blind source separation of obtained from a 1D rocking scan of a
(200) reﬂection of an Al single crystal (Dresselhaus-Marais et al., 2021b).a)
Rocking curve image of 0.2 deg in µ. Colored regions correspond to blind
source separated components as shown in b) Rocking curves for each inde-
pendent component.

In Fig. 5 the result of the blind source separation is shown
for the rocking curve (µ) obtained for a single crystal of Al in
a range of 0.2 deg for a (200) reﬂection. In Fig. 5a the com-
ponents resulting from the separation are identiﬁed by different
colors. Fig. 5b follows the same color code to show the rock-
ing curves corresponding to each component. The blind source
separation operation can be performed on 2D maps, the out-
put can in that case also be plotted as an rsm for each compo-
nent. Once the components are obtained they can be exported
as HDF5 ﬁles. darﬁx offers the possibility to link components
from two different datasets. This allows tracing features from
one layer to the next in multi layer scans or the evolution of
features under different external conditions.

5. Future evolution

8

J. Garriga et al. · darﬁx

Due to its modular structure, it is easy to extend darﬁx with
additional functionalities and widgets, for example additional
pre-processing tools such as gradient-based threshold removal
for the detection of low-intensity features (Gonzalez et al.,
2020).

The functionalities implemented so far are relatively low-
level. They mostly implement statistical methods and do not
include analysis of the diffraction physics. This is an obvi-
ous ﬁeld for future developments. In particular, we envisage
to implement the transformation from angle-space to reciprocal
space, including the transformation of peak shifts in mosaicity
and strain scans to strain components (Poulsen et al., 2021).

Furthermore, modules could be developed for the identiﬁca-
tion of characteristic features in the sample, e.g. isolated dislo-
cations (Jakobsen et al., 2019). Development is in progress for
the automatic tracking of mobile dislocations in time sequences
(Gonzalez et al., 2020). Bayesian inference methods can be
used to improve the accuracy of the dislocation core position
to ≈5 nm (Brennan et al., 2022). Due to the long range of strain
ﬁelds from dislocations, these techniques are directly applicable
to classical diffraction topography and rocking curve imaging.
Fine intra-granular defect features of dislocation arrange-
ments can be highlighted by plotting the local orientation gra-
dient of the tilt angles µ and χ for neighboring voxels within
each layer using the following relation: ∆γ = (cid:112)(∆µ)2 + (∆χ)2
(Mavrikakis et al., 2019; Ahl et al., 2017). Here, ∆µ and ∆χ
are the differences between the local sample tilt COM and their
grain averages. This is achieved by taking the spatial deriva-
tives of the center-of-mass maps, providing information on the
dislocation density (Pantleon, 2008; Simons et al., 2019).

Another ﬁeld for future development is the transformation
of a series of 2D scans into a 3D volume model of the sam-
ple. At present this is done manually for layer scans (Yildirim
et al., 2022), but stacking and registration could be automated.
An alternative measurement strategy would be topo-tomo scans
(Ludwig et al., 2009), where projections are recorded while the
sample is rotated about the scattering vector. Results should be
saved in a format compatible with dedicated 3D analysis soft-
ware such as Paraview (Ahrens et al., 2005; Ayachit, 2015).
Work for the 3D segmentation of dislocation networks is ongo-
ing (Huang et al., 2022).

6. Conclusions
darﬁx is a Python package for the analysis of dark-ﬁeld x-ray
microscopy and diffraction topography data. It provides data
processing and visualization tools that can be used either as
library components or via a graphical user interface as an add-
on to an Orange workﬂow.

darﬁx includes analysis functions speciﬁc to common scan
types used in DFXM, such as rocking curve imaging, mosaicity
and strain scans.

Through blind source separation, different diffracting ele-
ments present on the same map or rocking curve can be identi-
ﬁed as distinct sources of diffraction, associating each separated
unit to their corresponding rocking curve and reciprocal space
map.

J. Synchrotron Rad. (0000). 00, 000000

Acknowledgements
We acknowledge the European Synchrotron Radiation Facil-
ity for provision of synchrotron radiation facilities and we
would like to thank Thomas Dufrane for assistance in using
beamline ID06-HXM. We thank Leora Dresselhaus-Marais for
providing the unpublished data shown in Fig. 3 and critical read-
ing of the manuscript. We thank Thu Nhi Tran Caliste for stim-
ulating discussions on rocking curve imaging. Sonja R. Ahl and
Hugh Simons contributed the original data analysis scripts for
mosaicity maps that are now implemented in darﬁx.

References

Ahl, S., Simons, H., Detlefs, C., Juul Jensen, D. & Poulsen, H. F.

(2020). Acta Mater. 185, 142–148.

Ahl, S., Simons, H., Zhang, Y., Detlefs, C., St¨ohr, F., Jakobsen, A.,
Juul Jensen, D. & Poulsen, H. (2017). Scripta Mater. 139, 87–
91.

Ahrens, J., Geveci, B. & Law, C. (2005). ParaView: An End-User Tool
for Large Data Visualization, Visualization Handbook. Elsevier.
Ayachit, U. (2015). The ParaView Guide: A Parallel Visualization

Application. Kitware.

Bradski, G. (2000). Dr. Dobb’s Journal of Software Tools.
Brennan, M., Howard, M., Marzouk, Y. & Dresselhaus-Marais, L. E.,
(2022). Superresolution dislocation positions in DFXM with a
Bayesian inference model. To be published.

Bucsek, A., Seiner, H., Simons, H., Cook, P., Yildirim, C.,
Chumlyakov, Y., Detlefs, C. & Stebner, A. P. (2019). Acta Mater.
179, 273–286.

Collette, A. (2013). Python and HDF5. O’Reilly.
Cook, P. K., Simons, H., Jakobsen, A. C., Yildirim, C., Poulsen, H. F.
& Detlefs, C. (2018). Microscopy and Microanalysis, 24(S2),
88–89.

De Nolf, W., Payno, H., Svensson, O. & Koumoutsos, G., (2022).

ewoks.
URL: https://doi.org/10.5281/zenodo.6075053

Demˇsar, J. & Zupan, B. (2013). Informatica (Slovenia), 37, 55–60.
Dresselhaus-Marais, L. E., Winther, G., Howard, M., Gonzalez, A.,
Breckling, S. R., Yildirim, C., Cook, P. K., Kutsal, M., Simons,
H., Detlefs, C., Eggert, J. H. & Poulsen, H. F. (2021a). Science
Advances, 7(29), eabe8311.

Dresselhaus-Marais, L. E. et al. (2021b). Private communication.
Gonzalez, A., Howard, M., Breckling, S. & Dresselhaus-Marais, L. E.,
(2020). Methods to quantify dislocation behavior with dark-ﬁeld
x-ray microscopy timescans of single-crystal aluminum.

Gorfman, S., Spirito, D., Zhang, G., Detlefs, C. & Zhang, N. (2022).

Acta Crystallographica Section A, 78(3), 158–171.

Herault, J., Jutten, C. & Ans, B. (1985). 10eme Colloque sur le traite-

ment du signal et des images, 1985 ; p. 1017-1022.

Hlushko, K., Keckes, J., Ressel, G., Pornbacher, J., Ecker, W., Kutsal,
M., Cook, P. K., Detlefs, C. & Yildirim, C. (2020). Scripta Mater.
187, 402–406.

Huang, P.-H., Coffee, R. & Dresselhaus-Marais, L., (2022). Image
segmentation for 3D dislocation structures with dark-ﬁeld x-ray
microscopy. To be published.

Hyv¨arinen, A., Karhunen, J. & Oja, E. (2001). Independent Component

Analysis, vol. 26.

Jakobsen, A. C., Simons, H., Ludwig, W., Yildirim, C., Leemreize, H.,
Porz, L., Detlefs, C. & Poulsen, H. F. (2019). J. Appl. Cryst. 52,
122.

Kitamura, D. & Ono, N. (2016). In 2016 IEEE International Workshop

on Acoustic Signal Enhancement (IWAENC), pp. 1–5.

K¨onnecke, M., Akeroyd, F. A., Bernstein, H. J., Brewster, A. S., Camp-
bell, S. I., Clausen, B., Cottrell, S., Hoffmann, J. U., Jemian, P. R.,
M¨annicke, D., Osborn, R., Peterson, P. F., Richter, T., Suzuki,
J., Watts, B., Wintersberger, E. & Wuttke, J. (2015). Journal of
Applied Crystallography, 48(1), 301–305.

Kutsal, M., Bernard, P., Berruyer, G., Cook, P. K., Hino, R., Jakobsen,
A. C., Ludwig, W., Ormstrup, J., Roth, T., Simons, H., Smets,
K., Sierra, J. X., Wade, J., Wattecamps, P., Yildirim, C., Poulsen,
H. F. & Detlefs, C. (2019). IOP Conference Series: Materials
Science and Engineering, 580, 012007.
Lee, D. & Seung, H. (1999). Nature, 401, 788–91.
Lee, D. & Seung, H. S. (2001). In Advances in Neural Information
Processing Systems, edited by T. Leen, T. Dietterich & V. Tresp,
vol. 13. MIT Press.

Ludwig, W., King, A., Reischig, P., Herbig, M., Lauridsen, E.,
Schmidt, S., Proudhon, H., Forest, S., Cloetens, P., Rolland du
Roscoat, S., Bufﬁ`ere, J., Marrow, T. & Poulsen, H. (2009). Mate-
rials Science and Engineering: A, 524, 69–76.

Martinsson, P.-G., Rokhlin, V. & Tygert, M. (2011). Applied and Com-

putational Harmonic Analysis, 30(1), 47–68.

Mavrikakis, N., Detlefs, C., Cook, P., Kutsal, M., Campos, A., Gauvin,
M., Calvillo, P., Saikaly, W., Hubert, R., Poulsen, H., Vaugeois,
A., Zapolsky, H., Mangelinck, D., Dumont, M. & Yildirim, C.
(2019). Acta Mater. 174, 92–104.

Nellist, P.D.and Pennycook, S. (2000). Advances in Imaging and Elec-

tron Physics. Springer.

Oja, E. & Plumbley, M. (2004). Neural computation, 16, 1811–25.
Ouedraogo, W. S. B., Souloumiac, A. & Jutten, C. (2010). In Latent
Variable Analysis and Signal Separation, edited by V. Vigneron,
V. Zarzoso, E. Moreau, R. Gribonval & E. Vincent, pp. 522–529.
Berlin, Heidelberg: Springer Berlin Heidelberg.
Pantleon, W. (2008). Scripta Materialia, 58(11), 994–997.
Pedregosa, F., Varoquaux, G., Gramfort, A., Michel, V., Thirion, B.,
Grisel, O., Blondel, M., Prettenhofer, P., Weiss, R., Dubourg, V.,
Vanderplas, J., Passos, A., Cournapeau, D., Brucher, M., Per-
rot, M. & Duchesnay, E. (2011). Journal of Machine Learning
Research, 12, 2825–2830.

Poulsen, H. F. (2020). Current Opinion in Solid State and Materials

Science, 24, 100820.

Poulsen, H. F., Dresselhaus-Marais, L. E., Carlsen, M. A., Detlefs, C.

& Winther, G. (2021). J. Appl. Crystal. 54, 1555–1571.

Poulsen, H. F., Jakobsen, A. C., Simons, H., Ahl, S. R., Cook, P. K. &

Detlefs, C. (2017). J. Appl. Cryst. 50, 1441.

Ross, D., Lim, J., Lin, R.-S. & Yang, M.-H. (2008). International Jour-

nal of Computer Vision, 77, 125–141.

Ruben, J., Elechiguerra, J. L., Camacho, A., Holt, K., Kouri, J. B.,
Ram´ırez, J. T. & Yacaman, M. J. (2005). Nanotechnology, 16,
2346–53.

Schoeppler, V., Cook, P. K., Detlefs, C., Demichelis, R. & Zlotnikov,

I. (2022). Advanced Materials, n/a(n/a), 2200690.

Simons, H., Haugen, A. B., Jakobsen, A. C., Schmidt, S., St¨ohr,
F., Majkut, M., Detlefs, C., Daniels, J. E., Damjanovic, D. &
Poulsen, H. F. (2018). Nat. Materials, 17, 814–819.

Simons, H., Jakobsen, A. C., Ahl, S. R., Poulsen, H. F., Pantleon,
W., Chu, Y.-H., Detlefs, C. & Valanoor, N. (2019). Nano letters,
19(3), 1445–1450.

Simons, H., King, A., Ludwig, W., Detlefs, C., Pantleon, W., Schmidt,
S., St¨ohr, F., Snigireva, I., Snigirev, A. & Poulsen, H. F. (2015).
Nature Communications, 6, 6098.

The HDF Group, (1997-2022). Hierarchical Data Format, version 5.

URL: https://www.hdfgroup.org/HDF5/

The Qt Company, (2021). Qt: cross-platform software development for

embedded & desktop.
URL: https://www.qt.io

Tipping, M. E. & Bishop, C. M. (1999). Neural Computation, 11(2),

443–482.

Tran Thi, T. N., Morse, J., Caliste, D., Fernandez, B., Eon, D., H¨artwig,
J., Barbay, C., Mer-Calfati, C., Tranchant, N., Arnault, J.-C. et al.
(2017). J. Appl. Cryst. 50(2), 561–569.

Vincent, T., Valls, V., Payno, H., Kieffer, J., Sol´e, V. A., Paleo, P.,
De Nolf, W., Knobel, P. & Garriga, J., (2021). silx-kit/silx: 1.0.0:
2021/12/06.
URL: http://www.silx.org/

van der Walt, S., Sch¨onberger, J. L., Nunez-Iglesias, J., Boulogne, F.,
Warner, J. D., Yager, N., Gouillart, E., Yu, T. & the scikit-image
contributors (2014). PeerJ, 2, e453.

J. Synchrotron Rad. (0000). 00, 000000

J. Garriga et al. · darﬁx

9

Williams, D. & Carter, C. (1996). Transmission Electron Microscopy.

Plenum Press.

Yildirim, C., Cook, P., Detlefs, C., Simons, H. & Poulsen, H. F. (2020).

MRS Bulletin, 45.

Yildirim, C., Poulsen, H., Winther, G., Detlefs, C., Huang, P.-H. &

Dresselhaus-Marais, L. E. (2022). Extensive 3D mapping of dis-
location structures in bulk aluminum. To be published.

Yuan, Z. & Oja, E. (2004). vol. 3195 of Lecture Notes in Computer

Science, pp. 1–8.

10

J. Garriga et al. · darﬁx

J. Synchrotron Rad. (0000). 00, 000000

