PROGRAMS AND ALGORITHMS FOR THE SHELL 

DECOMPOSITION OF OSCILLATING FUNCTIONS IN SPACE 

by 

Ludmila UrzhumtsevaÂ§, Vladimir Y. Lunin& & Alexandre Urzhumtsev#â‚¬ 

Â§Architecture  et  RÃ©activitÃ©  de  lâ€™ARN,  UPR  9002  CNRS,  IBMC  (Institute  of  Molecular  and 

Cellular  Biology),  15  rue  R.  Descartes,  67084  Strasbourg,  France  ;  UniversitÃ©  de 

Strasbourg, Strasbourg, F-67000 France 

&Institute  of  Mathematical  Problems  of  Biology  RAS,  Keldysh  Institute  of  Applied 

Mathematics of Russian Academy of Sciences; Pushchino, 142290, Russia. 
#Centre for Integrative Biology, Institut de GÃ©nÃ©tique et de Biologie MolÃ©culaire et Cellulaire, 

CNRSâ€“INSERM-UdS, 1 rue Laurent Fries, BP 10142, 67404 Illkirch, France  

â‚¬UniversitÃ© de Lorraine, FacultÃ© des  Sciences  et  Technologies, BP  239,  54506 Vandoeuvre-

les-Nancy, France 

E-mail: l.ourjoumtseva@ibmc-cnrs.unistra.fr , lunin@impb.ru , sacha@igbmc.fr 

Abstract  

Real-space refinement of atomic models in macromolecular crystallography or in cryo 

electron microscopy fits a model to a map obtained experimentally. This requires generating 

model maps of a limited resolution which moreover may vary from one molecular region to 

another.  Calculating  such  map  as  a  sum  of  atomic  contributions  requires  that  these 

contributions reflect the local resolution of the experimental map. A possibility to refine the 

parameters  of  these  contribution  means  to  express  it  as  a  function  of  atomic  coordinates, 

displacement  factor  and  eventually  of  resolution.  Recently,  Urzhumtsev  &  Lunin  (BioRxiv, 

10.1101/2022.03.28.486044)  suggested  to  decompose  finite-resolution  atomic  images,  and 

more  generally  spherically  symmetric  oscillating  functions  in  space,  into  a  sum  of  specially 

designed  terms  analytically  dependent  on  all  atomic  parameters.  Each  term  is  a  spherically 

symmetric  function  concentrated  in  a  spherical  shell.  Here  we  describe  the  software  and 

respective algorithms to carry out such shell decomposition of oscillating functions. 

 
 
 
 
 
 
Keywords:  

Shell decomposition, atomic images, interference function, Fourier ripples, real-space 

refinement, resolution, atomic displacement factor.  

Synopsis:  A  software  has  been  developed  to  decompose  spherically  symmetric  oscillating 

functions  in  space  into  a  sum  of  specially  designed  shell-shaped  functions.  Such 

decomposition  allows  one  to  represent  a  resolution-restricted  atomic  image  by  a  function 

dependent  analytically  on  the  resolution,  the  isotropic  disorder  parameter,  and  the  atomic 

coordinates. 

Introduction  

In  macromolecular  crystallography  (MX)  or  in  cryo-electron  microscopy  (cryoEM), 

real-space  refinement  of  atomic  models,  i.e.,  their  fit  to  the  experimental  or  experimentally 

based  maps,  is  the  key  step  of  model  improvement  and  validation  (e.g.,  Diamond,  1971; 

Chapman et al., 2013; Afonine et al., 2018; Urzhumtsev & Lunin, 2019). This step becomes 

even  more  important  (Palmer  &  Aylett,  2022)  with  the  recent  progress  in  cryoCM 

(KÃ¼hlbrandt, 2014) and  in prediction of protein  structures  (Jumper et  al.,  2021;  Baek  et  al., 

2021). 

Three-dimensional  fields  such  as  an  electrostatic  potential  or  an  electron  or  nuclear 

density  can  be  seen  as  a  sum  of  contributions  from  individual  independent  atoms.  The 

experimental  maps  of  these  fields  are  their  distorted  images,  basically  due  to  an  atomic 

disorder and a limited resolution. To be compared quantitatively with an experimental map, a 

map  obtained  from  an  atomic  model  should  mimic  the  same  distortions.  Such  map  can  be 

calculated  as  a  sum  of  independent  atomic  contributions  considering  respectively  both  the 

atomic  disorder  and  the  resolution  cut-off  with  which  the  experimental  maps  are  available 

(e.g.,  Chapman,  1995;  Lutdke  et  al.,  1999;  Chapman  et  al.,  2013;  DiMaio  et  al.,  2015, 

Sorzano  et  al.,  2015,  and  references  therein).  In  the  simplest  case  of  an  isotropic  harmonic 

disorder,  such  contributions,  also  called  atomic  images  in  the  given  map,  are  spherically 

symmetric oscillating functions. They are composed of a peak in the origin surrounded by so-

called  Fourier  ripples  with  their  amplitude  decreasing  to  zero  much  slower  than  an  atomic 

 
 
 
 
 
 
density  itself.  These  functions,  in  particular  the  size  and  position  of  the  Fourier  ripples, 

depend on the atomic type, resolution and the disorder amplitude. Modeling the central peaks 

only, e.g., Lunin & Urzhumtsev (1984), is insufficient to reproduce the map accurately. 

Spherically symmetric oscillating functions in space, in particular atomic images, can be 

decomposed  into  a  sum  of  terms,  each  represented  by  a  specially  designed  spherically 

symmetric analytical function (

-function) that describes a distribution concentrated in a thin 

spherical shell (Urzhumtsev & Lunin, 2022). The main feature of the 

ğ›ºğ›º

-function is that it does 

not  change  its  form  when  changing  the  displacement  parameter  or  the  image  resolution  but 

ğ›ºğ›º

only modifies the value of the respective parameters. This allows an analytic expression of the 

model map values via all parameters of the atomic model including the local resolution, now 

associated  with  the  atom  (Urzhumtsev  &  Lunin,  2022).  This  in  turn  assures  analytic 

expressions for all respective partial derivatives of the score function comparing the maps and, 

as result, an efficient model refinement.  

In  this  work,  we  describe  the  algorithms  and  the  programs  that  realize  such  shell 

decomposition of the oscillating functions in space. In what follows, we use the term â€œdensityâ€ 

for all scalar fields since the mathematical and computer tools are exactly the same whatever 

the  physical  meaning  of  the  function  is.  The  term  â€œatomic  densityâ€  stands  for  the  density 

distribution  of  an  isolated  atom  and  â€œatomic  imageâ€  describes  how  this  density  is  seen  in  a 

given map, i.e., considering both an atomic disorder and a respective resolution cut-off.   

1.  Algorithms 

1.1. General considerations 

Introducing a harmonic disorder into an atomic position leads to blurring the atomic density 

function by its convolution with the normalized Gaussian function 

3 2â„

2

2

The parameter 

  ğ‘”ğ‘”(ğ«ğ«; ğµğµ) = ï¿½

 is the atomic displacement factor. The density of an immobile atom is 

ï¿½                                                                      (1)

exp ï¿½âˆ’

ï¿½

4ğœ‹ğœ‹
ğµğµ

4ğœ‹ğœ‹

|ğ«ğ«|
ğµğµ

a spherically-symmetric function with a peak in the origin and decreasing monotonously and 

ğµğµ = ğµğµ0

quite sharply with the distance. Traditionally, it  is decomposed into a linear combination of 

Gaussian functions (e.g., Doyle & Turner, 1968) 

 
 
 
 
 
ğ‘€ğ‘€

This allows one to use the property of the Gaussian function 

ğ‘šğ‘š=1

ğ‘“ğ‘“(ğ«ğ«) â‰ˆ ï¿½ ğ¶ğ¶ğ‘šğ‘šğ‘”ğ‘”(ğ«ğ«; ğµğµğ‘šğ‘š)

                                                                                               (2)

to express analytically the atomic density for any 

ğ‘”ğ‘”(ğ«ğ«; ğµğµ) âˆ— ğ‘”ğ‘”(ğ«ğ«; ğµğµ0) = ğ‘”ğ‘”(ğ«ğ«; ğµğµ + ğµğµ0)                                                                              (3)
ğµğµ0

To represent oscillating spherically symmetric function 

 in space we suggested the 

 value.  

decomposition  

ğ‘€ğ‘€

ğ‘“ğ‘“(ğ«ğ«)

where 

ğ‘“ğ‘“(ğ«ğ«) â‰ˆ ï¿½ ğ¶ğ¶ğ‘šğ‘šğ›ºğ›º(ğ«ğ«; ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š)

ğ‘šğ‘š=1

                                                                                   (4)

ğ›ºğ›º(ğ«ğ«; ğ‘…ğ‘…, ğµğµ) =

1
|ğ«ğ«|ğ‘…ğ‘…

ï¿½

1
4ğœ‹ğœ‹ğµğµ

ï¿½exp ï¿½âˆ’

2

2

4ğœ‹ğœ‹

(|ğ«ğ«| âˆ’ ğ‘…ğ‘…)

ğµğµ

ï¿½ âˆ’ exp ï¿½âˆ’

2

2

4ğœ‹ğœ‹

(|ğ«ğ«| + ğ‘…ğ‘…)

ğµğµ

ï¿½ï¿½         (5)

Function 

   represents  a  spherically  symmetric  solitary  wave  in  three-dimensional 

space (Fig. 1). It can be thought as a density of a virtual unit charge distributed uniformly on 

ğ›ºğ›º(ğ«ğ«; ğ‘…ğ‘…, ğµğµ)

the spherical surface of the radius 

 and blurred by the isotropic harmonic disorder described 

by the parameter 

 (Urzhumtsev & Lunin, 2022). Decomposition (4) of atomic images, which 

ğ‘…ğ‘…

we call the shell decomposition, is a generalization of the decomposition (2) because 

ğµğµ

ğ›ºğ›º(ğ«ğ«; ğ‘…ğ‘…, ğµğµ) â†’ ğ‘”ğ‘”(ğ«ğ«; ğµğµ)       when     ğ‘…ğ‘… â†’ 0                                                                 (6)

An important feature of function (5) is â€˜disorder transferabilityâ€™ which is similar to (3):  

ğ›ºğ›º(ğ«ğ«; ğ‘…ğ‘…, ğµğµ) âˆ— ğ‘”ğ‘”(ğ«ğ«; ğµğµ0) = ğ›ºğ›º(ğ«ğ«; ğ‘…ğ‘…, ğµğµ + ğµğµ0)                                                                 (7)

In other words, knowing the decomposition (4) of an image of an immobile atom, 

, we 

automatically  get  such  decomposition  for  an  image  of  an  atom  with  any  value 

 of  the 

displacement parameter. 

ğµğµ0 = 0
ğµğµ0

It what follows, we note by 

 the distance and by 

 the radial component 

of the function 

 . The decomposition procedure considers the radial component 

ğ‘Ÿğ‘Ÿ = |ğ«ğ«|

ğ›ºğ›ºï¿½(ğ‘Ÿğ‘Ÿ; ğ‘…ğ‘…, ğµğµ)
   being  defined  numerically, 

of  the  spherically  symmetric  function 
ğ›ºğ›º(ğ«ğ«; ğ‘…ğ‘…, ğµğµ)
 of a regular grid 

, 
ğ‘“ğ‘“Ì…(ğ‘Ÿğ‘Ÿ)
, in the axis of real numbers. 
ğ‘“ğ‘“ğ‘›ğ‘› = ğ‘“ğ‘“Ì…(ğ‘Ÿğ‘Ÿğ‘›ğ‘›)
ğ‘“ğ‘“(ğ«ğ«) = ğ‘“ğ‘“Ì…(|ğ«ğ«|)
Generally  speaking,  the  condition  on  the  grid  to  be  regular  is  not  necessary  but  simplifies 

in the points 

ğ‘›ğ‘› = 0, 1, â€¦ , ğ‘ğ‘; ğ‘Ÿğ‘Ÿ0 = 0; ğ‘Ÿğ‘Ÿğ‘›ğ‘› < ğ‘Ÿğ‘Ÿğ‘›ğ‘›+1

ğ‘Ÿğ‘Ÿğ‘›ğ‘›

some calculations.  

 
 
 
 
 
 
 
 
 
 
In the current version of the software, the discrepancy between the function 

 and its 

decomposition (4) is defined as the unweighted least-squares difference 

ğ‘“ğ‘“(ğ«ğ«)

where 

ğ¿ğ¿ğ¿ğ¿({ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š}) =

1
2

ï¿½  [ğ‘“ğ‘“ğ‘›ğ‘› âˆ’ ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿğ‘›ğ‘›; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})]
ğ‘›ğ‘›=0

2

                                    (8)

ğ‘ğ‘

ğ‘€ğ‘€

Other score functions can be easily implemented if required.  

ğ‘šğ‘š=1

ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿ; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š}) = ï¿½ ğ¶ğ¶ğ‘šğ‘šğ›ºğ›ºï¿½(ğ‘Ÿğ‘Ÿ; ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š)

                     .                                     (9)

1.2. The procedure 

The function (9) of a scalar variable 

 includes the terms corresponding to the peaks, positive 

or negative. The number 

 of terms is defined by the maximal authorized value, 

ğ‘Ÿğ‘Ÿ

 , 

and  by  the  accuracy 

 of  the  decomposition  which  are  parameters  of  the  procedure. 
ğ‘€ğ‘€ â‰¤ ğ‘€ğ‘€ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘
Various  protocols  have  been  tried  mixing  different  order  of  the  term  assignment  and 

ğ‘€ğ‘€

ğœ€ğœ€ğ‘‘ğ‘‘ğ‘ğ‘ğ‘‘ğ‘‘

refinement of estimated coefficients. Available software can use several such protocols, on the 

user  choice.  The  default  protocol  consists  in  the  following  steps  starting  from  the  initial 

function values: 

a)  Find, in the increasing order of the argument 

, all acceptable local peaks of the initial 

(at the first iteration) or the residual (at eventual following iterations) function; a peak 

ğ‘Ÿğ‘Ÿ

 in the position 

 with 

, is selected if 

 and 

. 

ğ‘šğ‘š

b)  Estimate the coefficients of the respective terms from the shape of each peak. 

0 â‰¤ ğ‘›ğ‘› â‰¤ ğ‘ğ‘
c)  Refine coefficients of all terms minimizing the score function (8).  

|ğ‘“ğ‘“ğ‘›ğ‘›| > ğœ€ğœ€ğ‘‘ğ‘‘ğ‘ğ‘ğ‘‘ğ‘‘

ğ‘šğ‘š â‰¤ ğ‘€ğ‘€ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘

ğ‘Ÿğ‘Ÿğ‘›ğ‘›

d)  Calculate the contribution (9) of the terms with the refined coefficients and extract this 

contribution from the initial function values. 

e)  If  the  break  conditions  defined  above  are  not  yet  fulfilled,  the  procedure  is  repeated 

using the  residual  function; new terms  complete the previous list and are refined, all 

together, at step c). 

Alternative  protocols  break  the  procedure  after  the  first  iteration,  whatever  the  residual 

discrepancy is, or refine the parameters values of each term before searching for the next one. 

The latter option may help to decompose the function with a very strongly dominating peak in 

the origin. 

 
 
 
 
 
1.3. Peaks interpretation 

The local peaks of the radial component are analyzed in the increasing order of the grid points 

. When a peak with 

 , 

, is found, we first flip the function if this peak 

is negative. Then we identify the peak extension, 
ğ‘Ÿğ‘Ÿğ‘›ğ‘›

0 â‰¤ ğ‘›ğ‘› â‰¤ ğ‘ğ‘
To estimate the initial values of the coefficients of the respective term 

|ğ‘“ğ‘“ğ‘›ğ‘›| > ğœ€ğœ€ğ‘‘ğ‘‘ğ‘ğ‘ğ‘‘ğ‘‘

 as discussed below  

 , we ignore the 

ğ‘ğ‘1 â‰¤ ğ‘›ğ‘› â‰¤ ğ‘ğ‘2

second term in (5) and a variation of 

 around the peak. As a result, we impose 

ğ‘šğ‘š

 and 

estimate two other coefficients from the minimum of  

ğ‘Ÿğ‘Ÿ

ğ‘…ğ‘…ğ‘šğ‘š = ğ‘Ÿğ‘Ÿğ‘›ğ‘›

ğ‘ğ‘2

2

Here, for 

ğ¿ğ¿ğ¿ğ¿ğ‘™ğ‘™ğ‘›ğ‘› = ï¿½  ï¿½ğ‘™ğ‘™ğ‘›ğ‘›(ğ‘“ğ‘“ğ‘›ğ‘›) âˆ’ ğ‘™ğ‘™ğ‘›ğ‘›ï¿½ğ¶ğ¶ğ‘šğ‘šğ‘”ğ‘”Ì…(ğ‘Ÿğ‘Ÿğ‘›ğ‘›; ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š)ï¿½ï¿½

ğ‘›ğ‘›=ğ‘ğ‘1

â†’ min

ğ‘…ğ‘…ğ‘šğ‘š,ğµğµğ‘šğ‘š,ğ¶ğ¶ğ‘šğ‘š

        .              (10)

ğ‘…ğ‘…ğ‘šğ‘š > 0

ğ‘”ğ‘”Ì…(ğ‘Ÿğ‘Ÿ; ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š) =

and for 

ğ‘…ğ‘…ğ‘šğ‘š = 0

1

1
2 ï¿½
ğ‘…ğ‘…ğ‘šğ‘š

4ğœ‹ğœ‹ğµğµğ‘šğ‘š exp ï¿½âˆ’

2

4ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ âˆ’ ğ‘…ğ‘…ğ‘šğ‘š)

2

ğµğµğ‘šğ‘š

ï¿½                                        (11)

3 2â„

2

2

Comparison of logarithms instead of the function values allows one to get an analytic solution 

ğ‘”ğ‘”Ì…(ğ‘Ÿğ‘Ÿ; 0, ğµğµğ‘šğ‘š) = ï¿½

 exp ï¿½âˆ’

ğ‘Ÿğ‘Ÿ

4ğœ‹ğœ‹
ğµğµğ‘šğ‘š ï¿½                   .                                            (12)

4ğœ‹ğœ‹
ğµğµğ‘šğ‘šï¿½

(Appendices A1 and A2). 

If initially we flipped the function, we should invert the sign of the coefficient 

.  

ğ¶ğ¶ğ‘šğ‘š

1.4. Peak borders  

The  peak  borders, 

,  are  chosen  as  the  left  and  right  function  inflection  points 

unless the function value drops  earlier below 

ğ‘ğ‘1 â‰¤ ğ‘›ğ‘› â‰¤ ğ‘ğ‘2

 which is one more parameter of the 

procedure. Naturally, for the peak in the origin, 

ğœ€ğœ€ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ > 0

, we assign 

. 

If a local maximum at the upper bound of the interval is observed, i.e., 

ğ‘›ğ‘› = 0

ğ‘ğ‘1 = 0

and  either 

can be beyond the interval. By this reason, if the function values are known for 

|ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿğ‘ğ‘)| > ğœ€ğœ€ğ‘‘ğ‘‘ğ‘ğ‘ğ‘‘ğ‘‘
, they 
ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿğ‘ğ‘) < ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿğ‘ğ‘âˆ’1) < 0
ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿ)
are used making this peak internal and reducing the situation to that described previously. By 

ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿğ‘ğ‘) > ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿğ‘ğ‘âˆ’1) > 0

 ,  the  actual  peak  of  the  curve 

 or 

ğ‘Ÿğ‘Ÿğ‘›ğ‘› > ğ‘Ÿğ‘Ÿğ‘ğ‘

this reason, it is recommended to calculate the function, if possible, at an interval larger than 

that in which the decomposition is required.  

If the function values beyond the interval are unknown, we assign 

. 

If  the  peak  is  too  narrow,   

,  we  assign 

 such  that  the  term 
ğ‘ğ‘2 = ğ‘…ğ‘…ğ‘šğ‘š = ğ‘Ÿğ‘Ÿğ‘ğ‘

ğ‘ğ‘2 âˆ’ ğ‘ğ‘1 â‰¤ 1

ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š

 
 
 
 
  
 
 
 
 
 
 in (8) becomes equal to 

 for 

 and had its width equal to the grid 

interval. 
ğ¶ğ¶ğ‘šğ‘šğ‘”ğ‘”Ì…(ğ‘Ÿğ‘Ÿ; ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š)

ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿğ‘›ğ‘›)

ğ‘Ÿğ‘Ÿ = ğ‘Ÿğ‘Ÿğ‘›ğ‘›

1.5. Function calculation 

Each term in (9) is a function with a single peak in the demi-axis 

 , either an internal one 

or in the origin, when 

 (Fig. 1). Its contribution is a decreasing function for 

ğ‘Ÿğ‘Ÿ â‰¥ 0

2

2

   and  becomes  negligibly  small  beyond  some  distance,  i.e., 
â‰¤ 3ğµğµ

ğ‘…ğ‘…
ğ‘Ÿğ‘Ÿ >
 is  found,  the 
with  some  small  constant 
ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿ; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š}) < ğœ€ğœ€ğ‘¡ğ‘¡ğ‘ğ‘ğ‘¡ğ‘¡ğ‘šğ‘š
ğ‘…ğ‘…
contribution of this term to the following points is ignored. A similar procedure is applied for 

 chosen.  As  soon  as  such  point 

8ğœ‹ğœ‹

ğœ€ğœ€ğ‘¡ğ‘¡ğ‘ğ‘ğ‘¡ğ‘¡ğ‘šğ‘š â‰¥ 0

ğ‘Ÿğ‘Ÿğ‘›ğ‘› < ğ‘Ÿğ‘Ÿğ‘ğ‘

 moving from the peak toward the origin. If 

, each term formally contributes 

to  all  points 
ğ‘Ÿğ‘Ÿ < ğ‘…ğ‘…
time. 

ğ‘Ÿğ‘Ÿğ‘›ğ‘›

 of  the  interval  making  the  sum  (9)  more  accurate  but  increasing  computing 

ğœ€ğœ€ğ‘¡ğ‘¡ğ‘ğ‘ğ‘¡ğ‘¡ğ‘šğ‘š = 0

1.6. Refinement of parameter values 

To  optimize  the  fit  (8)  of  the  calculated  function  to  the  input  one  improving  the  initial 

estimates of the parameters of the decomposition (9), we use the standard minimizer L-BFGS 

(Lui  & Nocedal, 1989).  It requires  calculation of the score function and  of its  gradient with 

respect to the decomposition coefficients (Appendix B).  

The minimizer uses bottom bound restraints on the values of the coefficients, 

, 

 and 

.  The  values  for  the  two  latter  bounds  are  calculated  from  the 
ğ‘…ğ‘…ğ‘šğ‘šğ‘šğ‘šğ‘›ğ‘› = 0
estimations  for  the  minimal  width  and  height  of  a  peak  giving  a  contribution  equal  to  the 
ğµğµğ‘šğ‘šğ‘šğ‘šğ‘›ğ‘› > 0
precision threshold 

ğ¶ğ¶ğ‘šğ‘šğ‘šğ‘šğ‘›ğ‘› > 0
. 

For the peak in the origin, 

ğœ€ğœ€ğ‘‘ğ‘‘ğ‘ğ‘ğ‘‘ğ‘‘

, we tried artificially to split it into two terms (5) with 

 slightly different from zero (with estimated 

ğ‘…ğ‘…ğ‘šğ‘š = 0
 always converged back to zero and we abandoned this practice. 

ğ¶ğ¶ğ‘šğ‘š

 divided by two). In all examples we saw, 

ğ‘…ğ‘…ğ‘šğ‘š
ğ‘…ğ‘…ğ‘šğ‘š
1.7. Choice of control parameters 

From our experience, when using a single term per Fourier ripple, the decomposition usually 

gives  an  approximation  with  the  discrepancy  of  3-4  orders  of  magnitude  lower  than  the 

function  values.  As  a  consequence,  refinement  is  sensitive  to  calculation  errors  (requiring 

 
 
 
 
 
 
 
double  precision  calculations  in  fortran)  and  to  the  initial  estimations  of  the  coefficients. 

While  routinely  the  default  choice  of  parameters  gives  sufficiently  good  results,  in  critical 

situations when a high accuracy, i.e., a small 

, is required they may be slightly improved 

after  trying  different 

 and 

.  The  default  values  found  empirically  are 

ğœ€ğœ€ğ‘‘ğ‘‘ğ‘ğ‘ğ‘‘ğ‘‘

 and 

; both values are defined as a part of the function value in the origin. 
ğœ€ğœ€ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ = 5 âˆ™
Except  particular  situations  one  does  not  use  the  maximal  allowed  number  of  terms 

ğœ€ğœ€ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘
âˆ’13

ğœ€ğœ€ğ‘¡ğ‘¡ğ‘ğ‘ğ‘¡ğ‘¡ğ‘šğ‘š

ğœ€ğœ€ğ‘¡ğ‘¡ğ‘ğ‘ğ‘¡ğ‘¡ğ‘šğ‘š = 10

âˆ’3

10

 ;  the  number  of  terms  is  found  automatically  for  the  given  accuracy 

.  The  last 

value can be defined either in the absolute scale or also as a part of the function value in the 
ğ‘€ğ‘€ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘ğ‘
origin. 

ğœ€ğœ€ğ‘‘ğ‘‘ğ‘ğ‘ğ‘‘ğ‘‘

2.  Program  

2.1. Software package, requirements and distribution 

The developed software consists of several programs. The principal component is the program 

dec3D  which calculates  the  shell decomposition coefficients  for a  given  oscillating function 

defined by its grid values. This program also calculates the sum of the respective terms  and 

compares the calculated curve with the control one 

An auxiliary program dec3D-rsum do the same but skips the first step and starts from a 

given set of the shell coefficients eventually refining them.    

Since the principal goal is a decomposition of atomic images, the software includes one 

more auxiliary program dec3D-atom that calculates the atomic images for the selected types 

of atoms for the chosen values of the resolution and the isotropic displacement factor.  

The  programs  are  available  in  fortran77  and  in  python3  (version  3.7.4  was  used  to 

develop  and  test  the  programs).  The  fortran  version  uses  the  L-BFSG  subroutines  provided 

with the program; thus,  the program is independent  of the environment.  The fortran version 

has no specific requirements. For example, working under Windows, one can use the compiler 

g77 with no installation needed.  

The  python  version  also  uses  only  basic  constructions.  It  requires  libraries  numpy 

(version 1.18.4 or higher) and scipy (version 1.6.3 or higher)  while may be compatible with 

some  older  versions.  The  L-BFGS  minimizer  is  distributed  with  the  scipy  libraries;  as  a 

consequence, the results may slightly vary with the installed versions of the libraries. 

 
 
 
 
The  python  scripts  may  be  run  as  stand-alone  of  via  a  graphical  interface.  The  GUI 

python  version  required  additionally  wx-python  (version  4.0.6  or  higher)  and  MatPlotLib 

(version 3.4.3 or higher).  

Some  details  of  the  programs  are  discussed  below.  The  programs  can  be  obtained  by 

request from the authors or from the site 

https://ibmc.cnrs.fr/en/laboratoire/arn-en/presentation/structures-software-and-websites/ 

2.2. Main program 

2.2.1. Input data  

The principal program dec3D requires the function values which are defined in the input file 

containing the records with the distance value and the function values in these points. The file 

may contain any number of columns with the values of different functions. For example, these 

may  be  images  of  atoms  of  different  types  at  a  given  resolution.  Otherwise,  they  may  be 

images  of  atoms  with  different  values  of  the  displacement  parameter  or  at  a  different 

resolution, or something else.  

The program requires also a file of input parameters where the name of the file with the 

function  values  (the  file  discussed  above)  is  the  only  mandatory  parameter;  optional 

parameters define the file content and the choice of the appropriate columns with data. Other 

optional  parameters  define  the  maximal  allowed  number  of  terms,  the  maximal  allowed 

discrepancy between the function and its decomposition, and the parameters used to build the 

terms and to find the range of their contribution, as discussed in previous sections.  

2.2.2. Output data  

The  principal  output  file  contains  the  initial  estimations  of 

 of  the  shell 

decomposition (4) and their values after refinement.  

ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š

The program calculates the function (8) as the sum of the terms as they are reported at 

the  end  of  the  program.  Also,  the  difference  function  between  the  initial  function  and  its 

decomposition  (9)  is  calculated  for  all  grid  points  in  which  the  function  is  defined.  These 

functions are saved in a separated output file and may be plotted and analyzed. The maximal 

deviation value is communicated for the whole interval of the function definition and for the 

interval for which the decomposition is constructed. 

 
 
 
 
 
2.3. Auxiliary programs 

2.3.1. Calculation of atomic images  

The auxiliary program dec3D-atom calculates the images of scatterers of a selected type for 

any chosen resolution and any value of the isotropic displacement parameter, equal to zero by 

default.  These  images  are  calculated  as  the  Fourier  transform  of  the  respective  scattering 

functions (Appendix C).  

X-ray  diffraction  or  electron  scattering  functions  of  neutral  atoms  and  their  ions  are 

defined  by  tabulated  functions  of 

 (e.g.,  Brown  et  al.,  2006)  or  by  a 

multi-Gaussian  approximation  to  them  (Navaza,  1994;  Peng,  1999;  Brown  et  al.,  2006,  and 

âˆ’1

ğ‘ ğ‘  = ğ‘‘ğ‘‘

= 2 sin ğœƒğœƒ /ğœ†ğœ†

references therein). The choice of the appropriate file is defined in the input parameters. Any 

other  data  in  the  same  format,  e.g.,  Waasmaier  &  Kirfel  (1995)  or  Grosse-Kunstleve  et  al. 

(2004),  may  be  used  if  available.  If  necessary,  the  files  may  be  completed  by  scattering 

functions for any new kind of scattering factor,  including that for a single Gaussian used  at 

subatomic resolution (Afonine et al., 2007).  

2.3.2. Calculation of the resulted curves  

The  auxiliary  program  dec3D-rsum  reads  the  values  of  the  coefficients  of  the  shell 

decomposition  and  calculates the  sum  (9)  as  well as the difference between  it and  the input 

function.  Differently  from  the  principal  program,  this  one  starts  directly  from  a  set  of  the 

decomposition  coefficients  allowing  one  to  test their  different  combinations.  Optionally,  the 

input values of the coefficients can be refined minimizing (8). 

A program dec3D-sum is a simplified version of dec3D-rsum which calculates the sums 

(8)  with  the  given  values  of  the  decomposition  coefficients  without  their  refinement. 

Differently from dec3D-rsum, this program needs neither scipy library for the python version, 

nor the L-BFGS modules for the Fortran version.  

2.4. GUI program version 

The computational part of the dec3D python suite is incorporated into an interactive graphic 

interface.  This  GUI  version  ignores  some  advanced  options  of  the  stand-alone  programs. 

 
 
 
 
 
 
 
Instead, it gives some extra possibilities such as a calculation â€˜on flyâ€™ of an analytic function 

to be decomposed.  

The GUI program runs consecutively four components: 

a)  Get curves to be decomposed; 

b)  Get the decomposition coefficients; 

c)  Calculate the  decomposition curves with  the decomposition coefficients which  can 

be eventually modified; 

d)  Plot any combination of the calculated curves and optionally save them. 

One can save intermediate results and to come back to any of the previous steps. 

At the first step, three options are available. One can input some precalculated functions 

or  calculate  atomic  images  of  a  given  resolution  and  with  a  given  displacement  parameter. 

The atomic types, or those of respective ions, are selected from  the interactive  Mendeleevâ€™s 

Table. Finally, one can define the input function by a python line in the respective window as, 

for example, 

3*(math.sin(2*math.pi*x) - (2*math.pi*x)*math.cos(2*math.pi*x)) / ((2*math.pi*x)**3) 

for the radial component of the three-dimensional interference function  

At the second step, the principal program works decomposing the functions obtained at 

                                                           (13)

ğºğº(ğ±ğ±) = 3

sin(2ğœ‹ğœ‹|ğ±ğ±|) âˆ’ (2ğœ‹ğœ‹|ğ±ğ±|) cos(2ğœ‹ğœ‹|ğ±ğ±|)
(2ğœ‹ğœ‹|ğ±ğ±|)

3

the previous step.  

The third step allows one to modify the values of the coefficients, exclude some terms 

from  the  curve  calculation  or,  inversely,  add  manually  new  terms.  Then,  the  sum  (9)  is 

calculated. 

At the fourth step, any combination of the calculated functions and their difference can 

be plotted, analyzed visually and saved in a file. One can choose the curve attributes such as 

their type, width and color. 

Fig. 2 illustrates, step by step, calculation of the images of the carbon and sulphur atoms, 

with 

 and at a resolution of  3  Ã…, using the GUI  version of the program.  The plots are 

generated directly by the program.  

ğµğµ = 0

 
 
 
 
 
 
0.04

0.03

0.02

0.01

0

0

(2.0,  8, 1.0)
(4.0,  8, 1.0)
(0.5,  8, 0.05)
(2.0, 64, 1.0)
(2.0,  4, 1.0)

1

2

3

4

5

Figure 1. The radial part 
sets of parameters 

 as indicated in the legend.  

ğ¶ğ¶ğ›ºğ›ºï¿½(ğ‘Ÿğ‘Ÿ; ğ‘…ğ‘…, ğµğµ)

(ğ‘…ğ‘…, ğµğµ, ğ¶ğ¶)

 of the scaled shell function for several 

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
Fig.  2.  Illustration  of  calculating  the  atomic  images  using  the  GUI  version  of  the  software. 

Consecutive  windows show the selection  of atomic types and parameters  of the images, the 

superposed  interactive  Mendeleev  table,  calculated  decomposition  parameters,  windows  for 

plotting the curves, the curves themselves and the residual curved after decomposition (note 

the difference  in scale in  two last figures).  Blue  curves  correspond  to the images of  carbon, 

red curves to those for sulphur. In the left bottom image, broken lines for the decomposition 

are indistinguishable from the full curves for the input images. 

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
Acknowledgement 

AU  acknowledges  Instruct-ERIC  and  the  French  Infrastructure  for  Integrated  Structural 

Biology FRISBI [ANR-10-INBS-05]. 

References 

Afonine,  P.V.,  Grosse-Kunstleve,  R.W.,  Adams,  P.D.,  Lunin,  V.Y.  &  Urzhumtsev,  A.G. 

(2007). Acta Cryst., D63, 1194-1197. 

Afonine, P.V., Poon, B.K., Read, R.J., Sobolev, O.V., Terwilliger, T.C., Urzhumtsev, A.G. & 

Adams, P.D. (2018). Acta Cryst., D74, 531-544. 

Atkinson, K.E. (1989). An Introduction to Numerical Analysis (2nd ed.). John Wiley & Sons. 

ISBN 0-471-50023-2. 

Baek, M. et al. (2021). Science, 373, 871â€“876. 

Brown, P.J., Fox, A.G., Maslen, E.N., Oâ€™Keefe, M.A. & Willis, B.T.M. (2006). In: Prince E, 

editor.  International  Tables  for  X-ray  Crystallography,  Vol.  C,  Dordrecht:  Springer, 

Dordrecht, The Netherlands. ch. 6.1, pp. 554-595. 

Chapman, M.S. (1995). Acta Cryst. A51, 69-80. 

Chapman, M. S., Trzynka, A. & Chapman, B. K. (2013). J. Str. Biol. 182, 10-21. 

Diamond, R. (1971).  Acta Cryst. A27, 436-452. 

Doyle, P. A. & Turner, P. S. (1968). Acta Cryst. 24, 390-397. 

Grosse-Kunstleve,  R.W.,  Sauter,  N.K.  &  Adams,  P.D.  (2004).  Newsletter  of  the  IUCr 

Commission on Crystallographic Computing, 3, 22-31. 

Jumper, J. et al. (2021). Nature 596, 583-589.  

KÃ¼hlbrandt, W. (2014). Science 343, 1443-1444. 

Liu, D. C. & Nocedal, J. (1989). Math. Program. 45, 503â€“528. 

Navaza, J. (1994).  Acta Cryst. A50, 157-163. 

Palmer, C.M. & Aylett, C.H.S. (2022). Acta Cryst. D78, 136-143. 

Peng, L.-M. (1999). Micron, 30, 625-648.  

Urzhumtsev, A.G. & Lunin, V.Y. (2019). Crystallogr. Reviews 25, 164-262. 

Urzhumtsev, A.G. & Lunin, V.Y. (2022). BioRxiv, 10.1101/2022.03.28.486044 

Waasmaier, D. & Kirfel, A. (1995). Acta Cryst. A51, 416-431. 

 
 
 
 
 
Appendix A. Parameters of the decomposition terms 

A1. Gaussian approximation to a local peak 

To  find  the  best  Gaussian  approximation 

,  with 

 constants,  to  the  given  set 

of  values 

, 

,  we  introduce  first  intermediate  parameters 

ğ‘ˆğ‘ˆ exp(âˆ’ğ‘£ğ‘£ğ‘Ÿğ‘Ÿ

)

ğ‘ˆğ‘ˆ, ğ‘£ğ‘£

2

, 

, with which condition (10), with the parameters introduced as below in A2, becomes 
ğ‘“ğ‘“ğ‘›ğ‘› = ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿğ‘›ğ‘›)
 ğ‘¦ğ‘¦ğ‘›ğ‘› = ğ‘™ğ‘™ğ‘›ğ‘›(ğ‘“ğ‘“ğ‘›ğ‘›)

ğ‘ğ‘1 â‰¤ ğ‘›ğ‘› â‰¤ ğ‘ğ‘2

ğ‘¢ğ‘¢ = ğ‘™ğ‘™ğ‘›ğ‘›ğ‘ˆğ‘ˆ

ğ‘ğ‘2

2
ğ¿ğ¿ğ¿ğ¿2(ğ‘¢ğ‘¢, ğ‘£ğ‘£) = ï¿½ [(ğ‘¢ğ‘¢ âˆ’ ğ‘£ğ‘£ğ‘Ÿğ‘Ÿğ‘›ğ‘›

ğ‘›ğ‘›=ğ‘ğ‘1

2

) âˆ’ ğ‘¦ğ‘¦ğ‘›ğ‘›]

i.e., 

â†’ minğ‘¢ğ‘¢,ğ‘£ğ‘£

                                                  (ğ´ğ´1)

ğœ•ğœ•ğ‘¦ğ‘¦
ğœ•ğœ•ğ‘¢ğ‘¢

ğ¿ğ¿ğ¿ğ¿2(ğ‘¢ğ‘¢, ğ‘£ğ‘£) =

ğœ•ğœ•ğ‘¦ğ‘¦
ğœ•ğœ•ğ‘£ğ‘£

ğ¿ğ¿ğ¿ğ¿2(ğ‘¢ğ‘¢, ğ‘£ğ‘£) = 0                                                                           (ğ´ğ´2)

This gives a system of two linear equations with respect to 

 resulting in  

ğ‘¢ğ‘¢, ğ‘£ğ‘£
âˆ’1

with 

ğ‘¢ğ‘¢ = (ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ2 âˆ™ ğ‘ ğ‘ ğ‘¦ğ‘¦ğ‘Ÿğ‘Ÿ2 âˆ’ ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ4 âˆ™ ğ‘ ğ‘ ğ‘¦ğ‘¦)(ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ2 âˆ™ ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ2 âˆ’ ğ‘›ğ‘›12 âˆ™ ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ4)
ï¿½
ğ‘£ğ‘£ = (ğ‘›ğ‘›12 âˆ™ ğ‘ ğ‘ ğ‘¦ğ‘¦ğ‘Ÿğ‘Ÿ2 âˆ’ ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ2 âˆ™ ğ‘ ğ‘ ğ‘¦ğ‘¦)(ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ2 âˆ™ ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ2 âˆ’ ğ‘›ğ‘›12 âˆ™ ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ4)

 and 

âˆ’1                                   (ğ´ğ´3)

ğ‘›ğ‘›12 = ğ‘ğ‘2 âˆ’ ğ‘ğ‘1 + 1

ğ‘ğ‘2

ğ‘ğ‘2

ğ‘ğ‘2

ğ‘ğ‘2

2
ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ2 = ï¿½ ğ‘Ÿğ‘Ÿğ‘›ğ‘›

ğ‘›ğ‘›=ğ‘ğ‘1

4
;   ğ‘ ğ‘ ğ‘Ÿğ‘Ÿ4 = ï¿½ ğ‘Ÿğ‘Ÿğ‘›ğ‘›

ğ‘›ğ‘›=ğ‘ğ‘1

;    ğ‘ ğ‘ ğ‘¦ğ‘¦ = ï¿½ ğ‘¦ğ‘¦ğ‘›ğ‘›

ğ‘›ğ‘›=ğ‘ğ‘1

2
;   ğ‘ ğ‘ ğ‘¦ğ‘¦ğ‘Ÿğ‘Ÿ2 = ï¿½ ğ‘¦ğ‘¦ğ‘›ğ‘›ğ‘Ÿğ‘Ÿğ‘›ğ‘›

ğ‘›ğ‘›=ğ‘ğ‘1

           (ğ´ğ´4)  

A2. Estimation of the decomposition parameters 

For the peak in the origin, the optimal values of the constants 

 in (A1) are related to the 

 parameters as 

ğµğµ, ğ¶ğ¶

giving  

ğ‘¢ğ‘¢ = ğ‘™ğ‘™ğ‘›ğ‘›ğ¶ğ¶ +   

ğ‘¢ğ‘¢, ğ‘£ğ‘£

3
2ğ‘™ğ‘™ğ‘›ğ‘›(4ğœ‹ğœ‹) âˆ’  

3
2 ğ‘™ğ‘™ğ‘›ğ‘›(ğµğµ)  ;   ğ‘£ğ‘£ = 4ğœ‹ğœ‹

2

âˆ’1

ğµğµ

                                               (ğ´ğ´5)

2

âˆ’1

3/2

âˆ’3/2

ğ‘¢ğ‘¢

 ; ğ¶ğ¶ = ğœ‹ğœ‹

ğ‘£ğ‘£

ğ‘’ğ‘’

                                                                           (ğ´ğ´6)

 for  an  internal  peak,  we  consider 

 ignoring 

the variation of the parameter 
ğµğµ, ğ¶ğ¶
ğ‘¢ğ‘¢, ğ‘£ğ‘£
 in (A1) are related to the 

constants 

 in the interval 

ğ‘Ÿğ‘Ÿ

 parameters as 

ğ‘Ÿğ‘Ÿğ‘ğ‘1 â‰¤ ğ‘›ğ‘› â‰¤ ğ‘Ÿğ‘Ÿğ‘ğ‘2

2
. Then, the optimal values of the 

ğ‘¦ğ‘¦ğ‘›ğ‘› = ğ‘™ğ‘™ğ‘›ğ‘›ï¿½2ğ‘“ğ‘“ğ‘›ğ‘›ğ‘…ğ‘…

1/2

ğœ‹ğœ‹

ï¿½

ğ‘¢ğ‘¢, ğ‘£ğ‘£

ğµğµ, ğ¶ğ¶

ğ‘¢ğ‘¢ = ğ‘™ğ‘™ğ‘›ğ‘›ğ¶ğ¶ âˆ’  

1
2 ğ‘™ğ‘™ğ‘›ğ‘›(ğµğµ)  ;   ğ‘£ğ‘£ = 4ğœ‹ğœ‹

2

âˆ’1

ğµğµ

                                                                    (ğ´ğ´7)

ğµğµ = 4ğœ‹ğœ‹

To  calculate 

ğ‘£ğ‘£
 from 

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
giving  

2

âˆ’1

âˆ’1/2

ğµğµ = 4ğœ‹ğœ‹

ğ‘£ğ‘£

 ; ğ¶ğ¶ = 2ğœ‹ğœ‹ğ‘¢ğ‘¢ğ‘£ğ‘£

                                                                              (ğ´ğ´8)

If a peak is too narrow, with its region composed of only 1 or 2 points, we assign 

, 

the minimal allowed value. Then, from the condition 

peak 

in 

the  origin,  we  calculate 

 for an internal peak, we calculate 
ğ¶ğ¶ = ğ‘“ğ‘“(ğ‘Ÿğ‘Ÿ0)ğµğµ

ğ¶ğ¶ğ‘”ğ‘”Ì…(ğ‘Ÿğ‘Ÿğ‘ğ‘0; ğ‘…ğ‘…, ğµğµ) = ğ‘“ğ‘“ğ‘ğ‘0

Appendix B. â„¦-function and its derivatives  

B1. Approximation to the function near the origin 

 for the 
ğµğµ = ğµğµğ‘šğ‘šğ‘šğ‘šğ‘›ğ‘›
the  condition 

ğ¶ğ¶ğ‘”ğ‘”Ì…(0; ğ‘…ğ‘… = 0, ğµğµ) = ğ‘“ğ‘“ğ‘¡ğ‘¡ğ‘ğ‘ğ‘ğ‘ğ‘šğ‘šğ‘‘ğ‘‘ğ‘¢ğ‘¢ğ‘ğ‘ğ‘™ğ‘™(ğ‘Ÿğ‘Ÿ0)
3/2

âˆ’3/2

 and, 

from 

ğœ‹ğœ‹

, 

ğ¶ğ¶ = 2ğ‘“ğ‘“ğ‘ğ‘0ğ‘…ğ‘…

2

1/2

(ğœ‹ğœ‹ğµğµ)

. 

The contribution of a term 

 with 

 to the curve in the point 

 is calculated 

according to the asymptotic behavior of function near the origin: 
ğ›ºğ›ºï¿½(ğ‘Ÿğ‘Ÿ; ğ‘…ğ‘…, ğµğµ)

ğ‘…ğ‘… â‰  0

ğ‘Ÿğ‘Ÿ = 0

ğ›ºğ›ºï¿½(ğ‘Ÿğ‘Ÿ; ğ‘…ğ‘…, ğµğµ) =

1
ğ‘Ÿğ‘Ÿğ‘…ğ‘…

ï¿½

1
4ğœ‹ğœ‹ğµğµ

exp ï¿½âˆ’

2

2

2

4ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ

+ ğ‘…ğ‘…

)

ğµğµ

ï¿½ ï¿½exp ï¿½

2

ğ‘Ÿğ‘Ÿğ‘…ğ‘…

8ğœ‹ğœ‹

ğµğµ

ï¿½ âˆ’ exp ï¿½âˆ’

2

8ğœ‹ğœ‹

ğ‘Ÿğ‘Ÿğ‘…ğ‘…

ğµğµ

ï¿½ï¿½ =

exp ï¿½âˆ’

2

2

2

4ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ

+ ğ‘…ğ‘…

)

ğµğµ

2

ğ‘Ÿğ‘Ÿğ‘…ğ‘…

ï¿½ ï¿½

16ğœ‹ğœ‹
ğµğµ

3

+ ğ‘‚ğ‘‚(ğ‘Ÿğ‘Ÿ

)ï¿½

=

1
ğ‘Ÿğ‘Ÿğ‘…ğ‘…

ï¿½

1
4ğœ‹ğœ‹ğµğµ
3/2

= ï¿½

4ğœ‹ğœ‹
ğµğµ

ï¿½

exp ï¿½âˆ’

2

2

4ğœ‹ğœ‹

ğ‘…ğ‘…

ğµğµ

2

ï¿½ [1 + ğ‘‚ğ‘‚(ğ‘Ÿğ‘Ÿ

)]                                                                         (ğµğµ1)

B2. Partial derivatives of the score function 

Partial  derivatives  of  the  score  function 

 describing  the  fit  of  the 

decomposition  to  the  input  curve  are  required  by  the  minimizer  L-BFSG  (Liu  &  Nocedal, 

ğ·ğ·({ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})

1989). These derivatives are calculated using the chain rule, in particular for (8): 

ğ‘ğ‘

ğœ•ğœ•
where 
ğœ•ğœ•ğœ•ğœ•

ğ¿ğ¿ğ¿ğ¿({ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š}) = ï¿½  [ğ‘“ğ‘“ğ‘›ğ‘› âˆ’ ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿğ‘›ğ‘›; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})]
 is any of the coefficients 

ğ‘›ğ‘›=0

.  

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿğ‘›ğ‘›; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğœ•ğœ•

       (ğµğµ2)

A straightforward differentiation of the expressions for the general case 
ğœ•ğœ•

ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š

ğ‘…ğ‘…ğ‘šğ‘š â‰  0, ğ‘Ÿğ‘Ÿ â‰  0

 
 
 
 
 
 
 
 
 
 
 
 
 
  
gives 

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿ; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğ‘…ğ‘…ğ‘šğ‘š

=

2

4ğœ‹ğœ‹

ï¿½ï¿½exp ï¿½âˆ’

âˆ’3/2

ğ¶ğ¶ğ‘šğ‘šğµğµğ‘šğ‘š
1/2
ğ‘Ÿğ‘Ÿğ‘…ğ‘…ğ‘šğ‘š
2ğœ‹ğœ‹
2
(ğ‘Ÿğ‘Ÿ âˆ’ ğ‘…ğ‘…ğ‘šğ‘š)

ğµğµğ‘šğ‘š

+ exp ï¿½âˆ’

âˆ’5/2

=

ğ¶ğ¶ğ‘šğ‘šğµğµğ‘šğ‘š
4ğ‘Ÿğ‘Ÿğ‘…ğ‘…ğ‘šğ‘šğœ‹ğœ‹
(ğ‘Ÿğ‘Ÿ âˆ’ ğ‘…ğ‘…ğ‘šğ‘š)

2

ğµğµğ‘šğ‘š

2 Ã—                                                                                  (ğµğµ3)

ï¿½ [8ğœ‹ğœ‹

2

ğ‘…ğ‘…ğ‘šğ‘š(ğ‘Ÿğ‘Ÿ âˆ’ ğ‘…ğ‘…ğ‘šğ‘š) âˆ’ ğµğµğ‘šğ‘š]

2

4ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ + ğ‘…ğ‘…ğ‘šğ‘š)

2

ğµğµğ‘šğ‘š

2

ï¿½ï¿½ [8ğœ‹ğœ‹

ğ‘…ğ‘…ğ‘šğ‘š(ğ‘Ÿğ‘Ÿ + ğ‘…ğ‘…ğ‘šğ‘š) + ğµğµğ‘šğ‘š]ï¿½

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿ; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğµğµğ‘šğ‘š

4ğœ‹ğœ‹

ï¿½exp ï¿½âˆ’

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿ; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğ¶ğ¶ğ‘šğ‘š

1/2 Ã—                                                                                (ğµğµ4)

2

2

ï¿½ [8ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ âˆ’ ğ‘…ğ‘…ğ‘šğ‘š)

2

âˆ’ ğµğµğ‘šğ‘š]

âˆ’ exp ï¿½âˆ’

2

4ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ + ğ‘…ğ‘…ğ‘šğ‘š)

2

ğµğµğ‘šğ‘š

2

ï¿½ [8ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ + ğ‘…ğ‘…ğ‘šğ‘š)

2

âˆ’ ğµğµğ‘šğ‘š]ï¿½

=                                                                                                       (ğµğµ5)

2

2

2

1

4ğœ‹ğœ‹

4ğœ‹ğœ‹ğµğµğ‘šğ‘š ï¿½exp ï¿½âˆ’

1
ğ‘Ÿğ‘Ÿğ‘…ğ‘…ğ‘šğ‘š ï¿½
, i.e., for the Gaussian terms, these derivatives are: 

ï¿½ âˆ’ exp ï¿½âˆ’

ğµğµğ‘šğ‘š

4ğœ‹ğœ‹

(ğ‘Ÿğ‘Ÿ âˆ’ ğ‘…ğ‘…ğ‘šğ‘š)

(ğ‘Ÿğ‘Ÿ + ğ‘…ğ‘…ğ‘šğ‘š)

ğµğµğ‘šğ‘š

2

ï¿½ï¿½

For 

ğ‘…ğ‘…ğ‘šğ‘š = 0, ğ‘Ÿğ‘Ÿ â‰  0

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿ; {0, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğµğµğ‘šğ‘š

= 4ğ¶ğ¶ğ‘šğ‘šğœ‹ğœ‹

3/2

âˆ’7/2

ğµğµğ‘šğ‘š

exp ï¿½âˆ’

2

2

ğ‘Ÿğ‘Ÿ

4ğœ‹ğœ‹
ğµğµğ‘šğ‘š ï¿½ [8ğœ‹ğœ‹

2

2

ğ‘Ÿğ‘Ÿ

âˆ’ 3ğµğµğ‘šğ‘š]                    (ğµğµ6)

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(ğ‘Ÿğ‘Ÿ; {0, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğ¶ğ¶ğ‘šğ‘š

= ï¿½

4ğœ‹ğœ‹
ğµğµğ‘šğ‘šï¿½

3/2

2

2

exp ï¿½âˆ’

ğ‘Ÿğ‘Ÿ

4ğœ‹ğœ‹
ğµğµğ‘šğ‘š ï¿½                                                            (ğµğµ7)

Finally, for 

 the derivatives are: 

ğ‘…ğ‘…ğ‘šğ‘š â‰  0, ğ‘Ÿğ‘Ÿ = 0

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(0; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğ‘…ğ‘…ğ‘šğ‘š

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(0; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğµğµğ‘šğ‘š

7
2

5
âˆ’
2
ğ¶ğ¶ğ‘šğ‘šğ‘…ğ‘…ğ‘šğ‘šğµğµğ‘šğ‘š

exp ï¿½âˆ’

= âˆ’64ğœ‹ğœ‹

4ğœ‹ğœ‹

3/2

âˆ’7/2

ğ¶ğ¶ğ‘šğ‘šğµğµğ‘šğ‘š

2

2
ğ‘…ğ‘…ğ‘šğ‘š

(8ğœ‹ğœ‹

= 4ğœ‹ğœ‹

2

2
ğ‘…ğ‘…ğ‘šğ‘š
ğµğµğ‘šğ‘š ï¿½                                      (ğµğµ8)
2
ğ‘…ğ‘…ğ‘šğ‘š
ğµğµğ‘šğ‘š ï¿½            (ğµğµ9)

4ğœ‹ğœ‹

2

âˆ’ 3ğµğµğ‘šğ‘š) exp ï¿½âˆ’

ğœ•ğœ•ğ‘“ğ‘“ğ‘€ğ‘€(0; {ğ‘…ğ‘…ğ‘šğ‘š, ğµğµğ‘šğ‘š, ğ¶ğ¶ğ‘šğ‘š})
ğœ•ğœ•ğ¶ğ¶ğ‘šğ‘š

3/2

= ï¿½

4ğœ‹ğœ‹
ğµğµğ‘šğ‘šï¿½

exp ï¿½âˆ’

4ğœ‹ğœ‹

2

2
ğ‘…ğ‘…ğ‘šğ‘š
ğµğµğ‘šğ‘š ï¿½                                                     (ğµğµ10)

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
Appendix C. Calculations of the atomic images  

The  image  of  an  atom  with  an  isotropic  scattering  factor 

 and  calculated  with  the 

resolution cut-off 

ğ·ğ· = ğ‘‘ğ‘‘â„ğ‘šğ‘šğ‘–ğ‘–â„

ğ‘“ğ‘“(ğ‘ ğ‘ )

2

/4) exp(âˆ’2ğœ‹ğœ‹ğœ‹ğœ‹ğ«ğ«ğ«ğ«) ğ‘‘ğ‘‘ğ«ğ«

ğœŒğœŒğ‘›ğ‘›(ğ«ğ«; ğµğµ, ğ·ğ·) = ï¿½ ğ‘“ğ‘“ğ‘›ğ‘›(ğ‘ ğ‘ ) exp(âˆ’ğµğµğ‘ ğ‘ 

âˆ’1

is  a  spherically  symmetric  function.  Here 

ğ‘ğ‘â‰¤ğ·ğ·

 is  a  dot  product  of  two  respective  vectors.  We 

calculate the radial component of this function along the axis Oz using spherical coordinates 

ğ«ğ«ğ«ğ«

which gives 

When 

,  

ğ‘Ÿğ‘Ÿ â‰ª 1

âˆ’1

ğ·ğ·

ğœŒğœŒÌ…ğ‘›ğ‘›(ğ‘Ÿğ‘Ÿ; ğµğµ, ğ·ğ·) = 2ğ‘Ÿğ‘Ÿ

âˆ’1

ï¿½ ğ‘ ğ‘ ğ‘“ğ‘“ğ‘›ğ‘›(ğ‘ ğ‘ ) exp(âˆ’ğµğµğ‘ ğ‘ 
0

2

/4) sin(2ğœ‹ğœ‹ğ‘Ÿğ‘Ÿğ‘ ğ‘ ) ğ‘‘ğ‘‘ğ‘ ğ‘ 

âˆ’1

ğ·ğ·

The  Simpson  (also  known  as  Kepler-Simpson  or  Newton-Cotes)  quadrature  (e.g.,  Atkinson, 

0

ğœŒğœŒÌ…ğ‘›ğ‘›(ğ‘Ÿğ‘Ÿ; ğµğµ, ğ·ğ·) â‰ˆ 4ğœ‹ğœ‹ ï¿½ ğ‘ ğ‘ 

ğ‘“ğ‘“ğ‘›ğ‘›(ğ‘ ğ‘ ) exp(âˆ’ğµğµğ‘ ğ‘ 

/4) ğ‘‘ğ‘‘ğ‘ ğ‘ 

2

2

1989) allows a numerical calculation of these integrals in any fine grid.  

 
  
                         
 
 
 
