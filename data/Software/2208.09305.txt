Computing: Oﬄine Analysis Environment

CBM Progress Report 2021

190

RealandsimulatedCBMdatainteractingwithanESCAPEdatalakeE.Clerkin∗1,P.-N.Kramp2,P.-A.Loizeau1,andM.Szuba21FAIR,Darmstadt,Germany;2GSI,Darmstadt,GermanyIntroductionESCAPEisanon-goingEU-fundedHorizon2020projectwhoseaimistostandardise,storeandsharedatafromlargescaleEuropeanastronomicalandparticlephysicsinfrastructureundertheauspiciousofopenscience,sharingdata,andpossibilityofleveragingeffortsofcit-izenscientistsworldwidetowardsastronomyandexperi-mentalparticlephysicsresearch.TheFAIRparticleac-celeratorinDarmstadtisamemberofthiscollaborativeclusterandtheCBMexperimentasapillarofFAIRhasbeenproactiveinengagingwithtesting,andvalidatingthetoolsforthisopenscienceproject.Inparticular,inthecaseoftheCBMexperiment,herewedocumenttheCBMin-teractingwiththeFAIRandCERNdatalakes,whicharedistributedrepositoriesofraworblobsofsemi-structureddatausedformanagingbigdata,asmaintainedbyotherwork-packagesoftheESCAPEproject.ForinformationonESCAPE,Refs.[1,2,3]andthereferencesthereinmaybeconsulted.WewantedtoshowcaseaspectrumofCBMdatainter-actingwithESCAPEdataenvironmentinabroadsense.Fig.1showsahighlysimpliﬁedblockdiagramofpossibleinteractionpointsofCBMandESCAPE.TheCBMexper-imentisinitsproductionstageanditssoftwaresuiteCBM-ROOTisstillunderactivedevelopment,butweneverthe-lesswantedtoshowcaseESCAPEinteractingwithbothexperimentalandsimulateddata.Onthesimulationside,manyoftheexistingtoolsmaybetunedtointeractwiththeESCAPEdatalakes.Inparticularwewillinteractwiththedatalakeasourstoragemediumforinputandoutputofdatafortransportanddigitisationstages.Forrealexperimentaldata,CBMhasaminiCBMproject(mCBM;cp.Ref.[4])whichtakesbeamfromtheexistingGSISIS18acceleratorandisusedbyusintheCBMcollaborationtotesthard-wareandsoftwareofthefullCBM.ItwillheregiveustheexcitingopportunitytoshowcaseESCAPEinteractingdi-rectlywithafunctioningparticlephysicsexperimentunderreal-timedatainjectionconditions.Thiswastheﬁrst-timeashowcaseofthiskindwasshown.Lastly,tocompletethedatademonstration,theﬁnaltaskwastointeractatthere-constructionoftracksstagewhichmaybethoughtofasthebasicdataanalysisstep.WehadthetwooptionstoeitherinteractwithsimulateddataorwiththemCBMrealexper-imentaldata.ItwasdecidedtouserealdatafrommCBMJuly2020dataprocessingrunasastrongerstatementofESCAPEusability.Thesethreedemonstrationswerepre-paredduringthecourseof2021andtheeffortsaccumu-∗e.clerkin@gsi.delatedandshowcasedduringasingleweekperiodforthedataacquisitionchallenge(DAC21)inNovember2021.Ineachofthethreesectionsthatfollow,wereportonthesuc-cessofeachofthesechallenges.ThisreportwascompiledfromtheDAC21activitieslogbook.Alltimesareapproxi-mateandinUTC.URQMDCBMTransportGEANT3|4CBMROOTdigitisationsimulationexperimentCBMROOT|RECONSTRUCTIONFigure1:Basicblockdiagramlayoutdisplayinginterac-tionpointsbetweentheCBMtoolkitandexternalsoftwarepackagesfortheCBMexperimentatGSI/FAIR.mCBMdataingestionInordertoshowcasetheinjectionofreal-timedata,ithadbeenhopedthatmCBMcosmic-raydatatakingwhichwasoriginallyplannedforearlyNovemberwouldbeavail-able.DuringlateNovember,thishadbeenrescheduledforDecember.DuringtheDAC,itwasinsteaddecidedtoreplayacquisitionofdatatakenbymCBMinJuly2021.Fromthedata-lakepointofview,thisisfunctionallythesameasifwehaddatacomingdirectlyfromthedetector.Fig.2showsaphotoofthemCBMexperimentatthistime,withthedetectoracronymsoverlaid.Thetaskandourteamwassplitbetweenareplaysideandaninjectionside.Thephysicaltransferofdatawasnotneededinthisdemonstration.ItwasnotedthattheFAIRdatalakewashostedonthesamelustreﬁlesystemaswasreplayedtobythereplayteam,butinsteadreplicasofthedatawereregisteredtothedatalakeprovidingitsfunction-ality.CBM Progress Report 2021

Computing: Oﬄine Analysis Environment

191

ReplaySide•2021-11-23,15:00-preparatoryscriptsforreplaystart.Severalissuesneededtobeovercomewherebylocked-incommandstriedtospeciﬁcssh-keysweredisabledbyITadministrators.Ouroriginalplanthere-foreneededaworkaroundandanalternativeapproachwaspursued.TheprocesswasachievedbyrsyncingoftheexperimentaldataoverInﬁnibandat150-200MB/s,with10parallelcopyjobsrunontheGSIGreenITCubecluster,leadingtoa2GB/saveragerate.ThisratewaschosentomimictheapproximatehighrateofmCBMdatataking.Thejobarraystartedat18:32,mostofthem(9/10)ﬁnishedaround18:36.Oneoftheﬁleshadamuchreducedwritingspeedof800kB/sduetoanunknownreason.Writingfortheﬁnalde-layedﬁleclosedat19:56.Infrastructureused:Asasource,twocomputenodesoftheminiFlescluster(experimentsideclusterofthemCBM),witheach5HDD(4TB)holdingtheoriginaldataﬁlesofthemCBM2021beamcampaign.TheﬁleswerewritteninparallelsoatleastoneﬁlefromeachHDDisneededtoreconstructasegmentofanymCBMrun.mFLEStoVirgo(GSIbatchclusterhostedintheGreen-Cubebuilding)Inﬁnibandbackbonecomprisesof10Virgologicalnodes(SLURMjobswithnon-defaultresourcesop-tions),with8GBRAMeach,eachexecutinganrsyncpro-cesstooneofthemFLESHDDfortheﬁrst10ﬁlesofatypicalmCBMrun.IngestionSide•2021-11-23,15:30-initialsetup•2021-11-23,17:30-statuscheckshowsnoreplicasorruleshavingbeenregisteredwithRucioinspiteoftheﬁrstbatchofﬁleshavingalreadyappearedintheFigure2:AboveimageshowsthemCBMexperimentalsetup.Thebeampipeisvisibletransversingthelowerrightquadrantandthetargetboxontherightcentreofthephoto.Eachofthesixdetectorssubsystemsareover-labelled.sourcedirectory.Problemtrackeddowntoﬁle-systemnotiﬁcationsnotfunctioningasexpected,begancon-vertingthescripttopollingmode•2021-11-23,18:00-testsofconvertedscriptrepeat-edlyfailonconnectionstotheCERNRucioserverbeingrefused.EventuallydiscoveredthatrecentchangestoGSInetworkwhichalloweddirectaccesstoFAIR-ROOTfromourcomputecluster,nowrequirerucio-clientstrafﬁcfromFAIR-ROOTtotheRucioservertogothroughalocalHTTPSproxy•2021-11-23,18:30-refactoredscriptlaunchedsuc-cessfully,withforceddelayof60secondsbetweenﬁlestoavoidpile-up.Replicasbegintobeaddedtothedatalake•2021-11-24,13:00-statuscheckshows92replicasregisteredsuccessfullybutowingtoatypo,thescriptonlyranonceinsteadofperiodically.Ranthescriptagaintoregistertheremaining8ﬁles•2021-11-24,13:15-ﬁnalstatuscheckshowsall100replicasregisteredsuccessfully.ConductedarandomsamplingofassociatedDIDs,allﬁlesaccessibleConclusionsAchievedasynchronouszero-copyinjectionofmCBMdataintothedatalake.Registeringareplicaandacorre-spondingreplicationruletook30-60spereach4-GBﬁle(havingsubtractedtheaforementionedforceddelay),i.e.comparabletotherateatwhichthedatahasbeenreplayedCurrentbottleneck:calculationofAdler32checksums(whichobviouslyhastobedoneatleastonce,althoughwithabitofcareonecanavoidrepeatingthecalculationsforunchangeddata)ontheclientsidepriortoregistrationofnewreplicas.Thiswouldideallyusechecksumscal-culatedbytheunderlyingﬁlesystematthetimeofdatabeingstored(ifavailableandpossibletobeextractedatﬁleratherthaninodelevel),howeverAdler32appearstobesupportedbyratherfewmodernﬁlesystemsandmaynotbeavailableevenwhensupported(e.g.atGSI-Lus-tredoessupportAdler32butourclusterusesCRC-32Cforperformancereasons)PossiblefuturedevelopmentinRucio:addsupportformoremodernchecksumalgorithms(e.g.xxhashasfasthashandSHA256/BLAKE2Basstronghash),ideallyfea-turingatransitionpathfromthecurrentAdler32+MD5schemaCBMsimulationThefutureCBMexperimentatFAIRinitselectroncon-ﬁgurationwithaMVD,STS,RICH,TRD,TOFandPSDdetectorswassimulated.(SeeFig.3)ThisconstitutesthemostdetectorrichconﬁgurationofthefullCBMexperi-ment.Computing: Oﬄine Analysis Environment

CBM Progress Report 2021

192

Figure3:LeftshowstheCBMsimulationgeometriesforthefutureCBMexperimentatFAIR.Itconsistsofabluemagnetyokeontheright,followedbytheRICHdetector,theTRD,theTOFandPSDdetectorontheleft.Thebeamentersfromtheright.TheSTSdetectoriscontainedinsidethemagnet.RightshowshitsaftertransportfromthedemoscriptsusedduringDAC21.Black(Blue)pointsshowhitsinthesensorsoftheMVD(STS)detector.Taskcompletedduring(Thu2021-11-25)and(Fri2021-11-26).Intheweeksbeforethechallenge,severaldockerimagesanddemoscriptswereprepared.CBMROOT,oursimulationsoftwaredevelopedatGSI/FAIRforthesimula-tionoftheCBMexperimentsisbuiltuponFairRootwhichinturnisbuiltuponFairSoftsoftwarepackages.Dockerimagesforeachofthesesteps,startingfromthemostrecentstabledocker-hubDebianreleasewereproduced.Finallyafourthdockerimagecontainingthenecessarypython,gfal,rucio[5],java,voms-client[6]andxrootd[7]wassubse-quentlybuiltontop.ThisallowedthetasktobecompletedusingastandardMacBookconnectedtoanetworkexternaltoGSIrunningadockercontainer.transport(demo2.sh)URQMDdatadac21.tra.rootdac21.par.rootdac21.geo.rootdigitisation(demo3.sh)dac21.raw.rootFigure4:Demosusedinsimulationchallenge.Theredarrowsshowdataextractedfromdatalake,andthebluearrowsshowdatasenttothedatalake.Demoscriptone(demo1.sh)uploadedinitialURQMDdatatothedatalakeusingRucioandfollowedanextrac-tionfromthedatalake.Theﬁlewasconsistentwithinitialinteractionofagoldbeamof10AGeVonagoldtarget.Fileconsistencywasveriﬁedviamd5sumbeforeandafteruploads.SubsequentrunningofscriptwouldhavereturnedfailureasthisdatahadalreadybeenplacedonthedatalakeandthereforewouldnothavebeenneededtoberunduringDAC21.Aseconddemoscript(demo2.sh)simulatesthetransportofparticlesthroughtheCBMexperimentinitselectronsetupasshownintheleftpanelofFig.3.Threedataﬁlesareuploadedtothedatalakecontainingparameters,geom-etryandtransportdataassymbolicallyrepresentedbythebluearrowsinFig.4.Itwasdecidedthatthedemoscriptwouldrunasacronjobrunningevery5minuteswhichstartedonThursdayeveningandcontinuedthroughtoFri-daymidnight.Athirdscript(demo3.sh)extractedsomeofthistrans-portdataandgenerateddigitisationdatawhichwasrunad-hoclyduringthetwodays.HitsinthesensorsoftheCBMdetectorforatypicalrunisdisplayedintherightpanelofFig.3.Demonstrationwassporadicallysuccessful.Itisnotedhoweverthatinteractionwiththedatalakesgaveerrormessagesduetoserversideissues.Additionally,timeoutofvomsproxywasalsoanissue,assomelongtimelapsesbetweenconnectionsoccurred.Successandfailurestatis-ticsarediscussedintheproceedingstudy.mCBMreconstructionGoalofthistaskwastoreconstructrecentmCBM(July2021)datainteractingwiththedatalake.Taskwascom-pletedinsideadockercontainerrunonaGentooLinuxdesktopmachineontheinternalGSInetwork.•2021-11-22Itwasnotedthatmuchofourdemoenvi-ronmentdevelopedforthistasksuddenlybecameob-soleteduetochangesinthedevelopmentbranchofCBMROOTwhichrequiredupdatedversionsofFair-SoftandFairRoot.Tomakemattersworse,theseweremajorratherthanincrementalchangeswhichrequiredmodiﬁcationoftheinstallationprocess.Bleeding-edgeCbmRootwasneededforreconstructionofJulydataastrackingandreconstructioncodewerebeingactivelydeveloped.ThenecessaryCBMROOTsoft-warewasnotavailabletocompletethistaskonthisday.•2021-11-23DevelopmentofnewDockerImagesbuiltonlateststableDebian,buildingaFairSoftimage,onwhichaFairRootimagewasbuiltfollowedbyaCbm-Rootimage.FinallyanimagewithRucio,gfalli-braries,xrootdandallnecessaryadditionstoCBM-ROOTnecessarytocompletethistaskwasbuiltontopoftheCbmRootimage.•2021-11-24AlthoughunpackingofmCBMhadbeenworkingforaweekpriortoDAC21,unpackershadCBM Progress Report 2021

Computing: Oﬄine Analysis Environment

193

madeitintoCbmRoottheweekprior,severaldevel-opmentsinthereconstructiondatastillhadnotbeensubmittedtotheCBMROOTdevelopmentbranch.ItisthereforedifﬁculttoprepareforthisDAC21taskaheadoftime.Onthisday,ourCBMROOTsoftwarewasstillnotabletoreconstructthe2021dataandweseriouslyplannedtoswitchtoplanBwhichmeantre-constructing2020datainstead.•2021-11-25NewtrackingandreconstructioncodemergedtothedevelopmentbranchofCbmRootbyitstrackingteam.ThesenewCBMROOTmacrosallowreconstructionoftherealexperiment2021datafromtheSIS18experimentshowninFig.2.Thesimula-tiongeometriesshowninFig.5wasusedduringthereconstructionprocess.•2021-11-2613:00CbmRootsourcecodeupdatedandrebuiltwithintherunningDockercontainer.Thiswasalsodonesoastonothavetorerunthedockerimagewhichwasbeingusedforthetask.•2021-11-2615:00-19:00Severaldemonstrationscriptstestedandcompletedourtaskalthoughinanad-hocfashion.Decidedasystematicapproachiswarranted.•2021-11-2618:47SomerawmCBMdatafromrun1588takenduringJuly2021isuploadedtothedatalakeusingaRucio-uploadcommand.Thisformsthebasisforlaterreconstruction.•2021-11-2620:05Script(demo6.sh)pullsthismCBMdata.Ifpullissuccessfulthencontinues,otherwisefailure1isoutputtothelogﬁle.Nextthescriptre-constructsthedatausingstandardmCBMreconstruc-tionmacrosmergedintoCBMROOTthedaybefore.Uploadreconstructeddatatodatalakeotherwisede-clarefailure2tothelogﬁles.Onlyfullcompletionisconsideredasuccess.•2021-11-2620:05Inordertogetsomesuccess/fail-urestatistics,thisdemonstrationwasrunonehundredtimeswiththescript(demo6.sh)ina“for”loopwitha60secondsleepbetweenruns.Statisticstrialstartedat21:04:50andendedat23:25:50.Ofthe100cases,0had“failure1”,i.e.readingtherawmCBMdatafromthedatalakeusingaRucio-getcom-mand,75had“failure2”,i.e.writingthereconstructedmCBMdatatothedatalakeusingaRucio-uploadcom-mand,and25weredeemedfullysuccessfulhavingnofail-uresreported.Thefailurerateswerehigh,asoneofthepro-tocolsfailedontheclientsside.ThetargetRSEsupportedboth“root://”and“davs://”asprotocols.WhencontactingtheRSEviatheRuciouploadcommand,theRucioclientprimarilychose“davs://”astheprotocol.The“davs://”protocolwasnotsupportedinthecontainerduetoaminorerrorintheconﬁguredpaths.gfal2,usingitsHTTPSplug-in,couldn’tresolvethelibdavixdependenciescorrectly.Itthereforereportedthattheprotocolisnotsupported.Theerrormessagealsocontained”Therequestedserviceisnotavailableatthemoment”,whichismisleadingandletsauserbelievethattheservicewasatfault.Despitethehighfailurerates,overallthechallengewasdeemedsuccessfulasashowcaseofreconstructionofmCBMdatainteractingwiththeESCAPEdataenvironment.Figure5:ShowsthesimulationgeometriesoftheJulymCBMsetup.TheﬁgureiscomparabletothephotoshowninFig.2References[1]R.Bolton,S.Campana,A.Ceccanti,X.Espinal,A.Fkiaras,P.FuhrmannandY.Grange“ESCAPEprototypesadatain-frastructureforopenscience”EPJWebofConferences245,04019(2020)CHEP2019[2]M.Allen,G.Lamanna,X.Espinal,K.Graf,M.vanHaar-lem,S.Serjeant,I.BirdI,E.Cuoco,andJ.Wagh“ESCAPE-addressingOpenSciencechallenges”[3]R.DiMaria,R.Dona“ESCAPEDataLake”EPJWebofConferences2021(Vol.251).[4]“mCBMSIS18–ACBMfullsystemtest-setupforhigh-ratenucleus-nucleuscollisionsatGSI/FAIR”TheCBMCollabo-ration,LetterofIntent,19June2017[5]C.Serfon,M.Barisits,T.Beermann,V.Garonne,andL.Goossens,M.Lassnig,A.Nairz,R.Vigne,Ralphetal.“Ru-cio,thenext-generationDataManagementsysteminAT-LAS”Nuclearandparticlephysicsproceedings,2016,vol-ume273,pages969-975[6]AlﬁeriR,CecchiniR,CiaschiniV,FrohnerA,GianoliA,LorenteyK,SpataroF.“VOMS,anauthorizationsystemforvirtualorganizations”EuropeanAcrossGridsConference2003Feb13(pp.33-40)[7]BauerdickLA,BloomK,BockelmanB,BradleyDC,DasuS,DostJM,SﬁligoiI,TadelA,TadelM,WuerthweinF,YagilA“XRootd,disk-based,cachingproxyforoptimizationofdataaccess,dataplacementanddatareplication.”JournalofPhysics:ConferenceSeries2014Jun11(Vol.513,No.4,p.042044)