HP - A code for the calculation of Hubbard parameters using density-functional
perturbation theory

Iurii Timrova,∗, Nicola Marzaria,b, Matteo Cococcionic

aTheory and Simulation of Materials (THEOS), and National Centre for Computational Design and Discovery of Novel Materials (MARVEL), ´Ecole
Polytechnique F´ed´erale de Lausanne (EPFL), CH-1015 Lausanne, Switzerland
bLaboratory for Materials Simulations, Paul Scherrer Institut, 5232 Villigen PSI, Switzerland
cDepartment of Physics, University of Pavia, via Bassi 6, I-27100 Pavia, Italy

2
2
0
2

l
u
J

8

]
i
c
s
-
l
r
t

m

.
t
a
m
-
d
n
o
c
[

2
v
4
8
6
5
1
.
3
0
2
2
:
v
i
X
r
a

Abstract

We introduce HP, an implementation of density-functional perturbation theory, designed to compute Hubbard parameters
(on-site U and inter-site V) in the framework of DFT+U and DFT+U+V. The code does not require the use of computa-
tionally expensive supercells of the traditional linear-response approach; instead, unit cells are used with monochromatic
perturbations that signiﬁcantly reduce the computational cost of determining Hubbard parameters. HP is an open-source
software distributed under the terms of the GPL as a component of Quantum ESPRESSO . As with other components,
HP is optimized to run on a variety of diﬀerent platforms, from laptops to massively parallel architectures, using na-
tive mathematical libraries (LAPACK and FFTW) and a hierarchy of custom parallelization layers built on top of MPI.
The eﬀectiveness of the code is showcased by computing Hubbard parameters self-consistently for the phospho-olivine
LixMn1/2Fe1/2PO4 (x = 0, 1/2, 1) and by highlighting the accuracy of predictions of the geometry and Li intercalation
voltages.

Keywords: Hubbard parameters, linear-response theory, density-functional perturbation theory, self-interaction
corrections, transition-metal compounds, Quantum ESPRESSO, open-source software, open science

PROGRAM SUMMARY
Program Title: HP
Licensing provisions: GNU General Public License V 2.0
Programming language: Fortran 95
External routines: HP is a tightly integrated component of the Quantum ESPRESSO distribution and requires the standard libraries
linked by it: BLAS, LAPACK, FFTW, MPI.
Nature of problem: Calculation of Hubbard interaction parameters for DFT+U and DFT+U+V.
Solution method: Hubbard parameters are expressed in terms of the inverse response matrices to localized perturbations of the atomic
occupations. The response matrices are computed using density-functional perturbation theory to ﬁrst order (linear-response theory) in
the reciprocal space, that allows to reconstruct the response to a localized perturbation (obtained from calculations in an appropriately
sized supercell) as the superposition of the responses to a series of monochromatic perturbations in a primitive unit cell, thus reducing
signiﬁcantly the computational cost. The response matrices are computed via a self-consistent solution of the static Sternheimer
equation, whose implementation does not require the calculation of any virtual states. Pseudopotentials (norm-conserving, ultrasoft,
projector augmented wave) are used in conjunction with plane-wave basis sets and periodic boundary conditions.
Additional comments including restrictions and unusual features: Local and semi-local exchange-correlation kernels only. Non-
collinear spin-polarized formalism is not supported, only collinear spin-polarized or non-spin-polarized cases can be treated. Spin-orbit
coupling cannot be used. Calculation of Hund’s J is not supported. Multiple Hubbard channels per atom are not supported. The
Hubbard manifold can be only constructed on atomic orbitals, both orthogonalized and non-orthogonalized, while Wannier functions
(as well as other localized basis sets) are not supported. The LR approach we adopt here typically results in Hubbard parameters that
are unphysically large for closed shell states [1]. No virtual orbitals are used, nor even calculated.
The distribution ﬁle of this program can be downloaded from the Quantum ESPRESSO website: http://www.quantum-espresso.org/,
and the development version of this program can be downloaded via Git from the GitLab website: https://gitlab.com/QEF/q-e.
Interactions with end users of the HP code happen via a mailing-list forum of Quantum ESPRESSO : https://www.quantum-
espresso.org/forum. Documentation of the HP code is tightly coupled with the code and is done via standard code comments; diﬀerent
subroutines that implement diﬀerent equations of the DFPT formalism contain references to the two main papers [2, 3] describing in
detail theory behind the implementation.

∗Corresponding author. e-mail address: iurii.timrov@epﬂ.ch

Preprint submitted to Elsevier

July 11, 2022

 
 
 
 
 
 
1. Introduction

The development of density-functional theory (DFT) [4, 5] has allowed modeling of a broad spectrum of properties for a
large variety of systems. In practical applications DFT relies on approximations to the exchange-correlation (xc) electronic
interactions, among which the local-density approximation (LDA) and the generalized-gradient approximation (GGA) are
the most popular ones. Both approximations suﬀer from self-interaction errors (SIE) [6], which limit the accuracy only to
simple systems with chemistries determined by s- and p-type electrons. In systems with strongly localized electrons of d
and f type, the SIE of LDA and GGA is quite large and leads to a signiﬁcant overdelocalization of these electrons which
translates into quantitative and sometimes even qualitative failures in the description of complex materials.

A popular approach to alleviate SIE in DFT calculations is to use Hubbard corrections to approximate DFT energy
functionals [7, 8, 9]. The rationale for this is that Hubbard corrections impose piecewise linearity in the energy func-
tional as a function of atomic occupations [10], and thus remove/alleviate SIE in the Hubbard manifold both in extended
systems and in molecular ones [11, 12]. Within this approach, often referred to as DFT+U, the Hubbard correction acts
selectively on strongly localized manifolds (of d or f types, typically) through projectors on the corresponding states,
while electrons on more delocalized states are treated at the level of approximate DFT. What has made this approach pop-
ular is certainly the possibility to achieve signiﬁcant improvement in the description of systems with localized electrons,
while maintaining a combination of simplicity and reduced computational costs. An extended formulation of DFT+U
– so-called DFT+U+V [13] – takes into account inter-site Hubbard interactions through the parameter V and allows
to improve the description of localized electrons even in presence of signiﬁcant hybridization with neighbors. Recent
works [14, 15, 3] have highlighted the quantitative accuracy of DFT+U+V calculations with both on-site U and inter-site
V eﬀective parameters. It is useful to mention about alternative recent formulations of DFT+U+V [16, 17].

The eﬀectiveness of the (extended) Hubbard functional depends critically on the values of the eﬀective interaction
parameters (i.e., the Hubbard U and V). Unfortunately, the values of these parameters are not known a priori and it is still
quite a common practice in literature to evaluate them semi-empirically by ﬁtting various experimental properties (when
available), which prevents this method from being fully ab initio and from being predictive for novel materials. Most
importantly, it is often forgotten that the Hubbard correction acts on a speciﬁc manifold that can be deﬁned in diﬀerent
ways [18]. Hence, the values of the Hubbard parameters are not transferable and should not be considered as universal
quantities for a given element or material (see the appendix in Ref. [12]). It is crucial to use the U and V parameters
consistently, i.e., maintaining the same Hubbard projectors, pseudopotentials, oxidation states, functionals, etc. for which
they were computed. During the past 30 years there has been a large eﬀort to develop methods for the ﬁrst-principles
calculation of Hubbard parameters. Among these, the constrained DFT (cDFT) approach [19, 20, 21, 22, 23, 24, 10, 25,
26, 27], the Hartree-Fock-based approaches [28, 29, 30, 31, 16, 17], and the constrained random phase approximation
(cRPA) approach [32, 33, 34, 35, 36, 37, 38] are the most popular. A linear-response formulation of cDFT (LR-cDFT)
was introduced in Ref. [10] and generalized to the calculation of the inter-site Hubbard parameters V in Ref. [13] (see
also Refs. [39, 40]). LR-cDFT has recently been recast via density-functional perturbation theory (DFPT) [2, 3], allowing
to overcome several challenges of the supercell approach of Ref. [10]. It was shown that both LR-cDFT and DFPT give
exactly the same values of Hubbard parameters (modulo the numerical noise), as they ought to by construction [2, 3]. By
constructing the localized perturbation (typically requiring costly calculations in supercells) as a series of independent
monochromatic perturbations in the primitive unit cell, it improves signiﬁcantly the computational eﬃciency, accuracy,
user-friendliness, and automation [2, 3], as also demonstrated by several recent applications [14, 41, 15, 42, 43, 44, 45,
46, 47, 48, 49]. Key to this successful implementation of the LR-cDFT is indeed the capability to express perturbation
theory in reciprocal space as in the calculation of phonons using DFPT [50, 51, 52].

An open and recurring question concerns the extent at which the Hubbard parameters obtained from diﬀerent ap-
proaches, e.g. cRPA [34] vs. LR-cDFT/DFPT [10, 2] vs. ACBN0 [31] compare to one another. First and foremost,
these methods have quite diﬀerent deﬁnitions of the Hubbard U which complicates very much their comparison.
In
fact, only a few attempts have been made in the literature trying to identify the analogies and diﬀerences between these
theories [1, 35, 40]. Moreover, diﬀerent Hubbard projector functions can be used in these methods: cRPA is based
on maximally localized Wannier functions [53], while LR-cDFT/DFPT and ACBN0 are used with several other popular
types of Hubbard projectors (e.g. nonorthogonalized or orthogonalized atomic orbitals, projector-augmented-wave (PAW)
functions, to name a few). Since the computed Hubbard parameters are very sensitive to the choice of Hubbard projector
functions [47], the comparison between the values of U computed using diﬀerent methods and diﬀerent projector func-
tions becomes even more complicated. Furthermore, in some works the Hubbard U is computed in a one-shot fashion
(i.e. a single calculation from an uncorrected ground state) while in other works a self-consistent procedure is adopted
where the eﬀective Hubbard U is recomputed from a DFT+U ground state until self-consistency is reached [3, 10, 54].
The choice of pseudopotentials is also very important when computing the Hubbard parameters [12, 27]: the value of U
obtained for the same structure but with diﬀering pseudopotentials may easily diﬀer by as much as 2–3 eV, in particular if
the pseudopotentials were generated from diﬀerent oxidation states [12]. All in all, for a given material of interest, even
if the calculations of U are done using the same crystal structure and atomic positions, the same kinetic-energy cutoﬀ,
k points sampling of the Brillouin zone (BZ) and same other technical details, all other aforementioned aspects must be
2

very carefully considered when comparing studies reporting diﬀerent Hubbard U parameters. Therefore, we believe that
it makes sense to compare U values computed using diﬀerent methods only when the same computational setup is used.
In this paper we introduce a computer code, named HP (Hubbard Parameters), which implements DFPT for the calcu-
lation of Hubbard parameters. HP is distributed under the terms of the GPL license [55], as a component of the Quantum
ESPRESSO suite of open-source codes based on plane-wave basis sets, pseudopotentials, and using periodic boundary
conditions [56, 57, 58].

This paper is organized as follows. In Sec. 2 we provide a theoretical background for the Hubbard-corrected DFT
and for DFPT. In Sec. 3 we describe the components of HP . In Sec. 4 we provide the instructions for installing HP on
UNIX systems and discuss various levels of parallelization implemented in it. In Sec. 5 we give an example of the usage
of HP for the calculation of Hubbard parameters for LixMn1/2Fe1/2PO4 and studying its ground-state properties. Finally,
Sec. 6 contains conclusions and perspectives for future work. Appendix A presents examples of the input ﬁles for the
PW and HP codes, and Appendix B contains the description of the input variables of the HP code. Hartree atomic units are
used throughout the paper.

2. Theory

2.1. Hubbard-corrected density-functional theory

In this section we brieﬂy review the formulation of the extended DFT+U+V approach [13]. All equations which are
presented below can be easily reduced to the case of DFT+U by simply setting V = 0. For the sake of simplicity, the
formalism is presented in the framework of norm-conserving (NC) pseudopotentials (PPs), for non-metallic ground states,
in the collinear spin-polarized case.

As a generalization of DFT+U, DFT+U+V is also based on an additive correction to the approximate DFT energy

functional, modeled on the Hubbard Hamiltonian [13]:

EDFT+U+V = EDFT + EU+V ,

(1)

where EDFT represents the approximate DFT energy (constructed, e.g., within the local spin density approximation –
LSDA, or the spin-polarized generalized-gradient approximation – GGA), while EU+V contains the additional Hubbard
term. At variance with the DFT+U approach, containing only on-site interactions, DFT+U+V is based on the extended
Hubbard model including also inter-site interactions between an atom and its surrounding ligands.
In the simpliﬁed
rotationally-invariant formulation [9], the extended Hubbard term reads:

EU+V = 1
2

(cid:88)

(cid:88)

I

σm1m2

U I (cid:16)

δm1m2 − nIIσ
m1m2

(cid:17)

nIIσ
m2m1

−

1
2

(cid:88)

∗(cid:88)

(cid:88)

I

J(J(cid:44)I)

σm1m2

V I JnI Jσ
m1m2

nJIσ
m2m1

,

(2)

where I and J are atomic site indices, m1 and m2 are the magnetic quantum numbers associated with a speciﬁc angular
momentum, U I and V I J are the on-site and inter-site Hubbard parameters, and the star in the sum denotes that for each
atom I, the index J covers all its neighbors up to a given distance (or up to a given shell).

m1m2 are based on a generalized projection of the Kohn-Sham (KS) states on localized

The atomic occupation matrices nI Jσ
m1 (r) of neighbor atoms:

orbitals ϕI

Nk(cid:88)

nI Jσ
m1m2

=

Nocc(cid:88)

(cid:104)ψ◦

vkσ| ˆPJI

m2m1

|ψ◦

vkσ(cid:105) ,

(3)

where v and σ represent, respectively, the band and spin labels of the KS (pseudo-)wavefunctions, k indicate points (wave
vectors) in the ﬁrst BZ, Nk being their number, Nocc is the number of occupied KS states, and ˆPJI
m2m1 is the generalized
projector on the localized orbitals of neighbor atoms:

k

v

ˆPJI

m2m1

= |ϕJ
m2

(cid:105)(cid:104)ϕI
m1

| .

(4)

m1(r) ≡ ϕγ(I)

In Eq. (3) and hereafter, with the superscript ◦ we indicate quantities which refer to the unperturbed ground state of the
system. Here, ϕI
m1 (r − RI) are localized orbitals centered on the Ith atom of type γ(I) at the position RI. Given
their importance for the calculation of the Hubbard parameters it is convenient to establish a short-hand notation for the
m1m2 . The standard DFT+U
on-site terms of the quantities deﬁned in Eqs. (3) and (4): nIσ
approach is recovered by setting V I J = 0 in Eq. (2). Based on the deﬁnitions above, it is quite straightforward to see
from Eq. (2) that the two terms in the corrective energy functional, proportional to the on-site (U I) and inter-site (V I J)
couplings, respectively, counteract each other. In fact, while the on-site term favors localization on atomic sites (typically
suppressing hybridization), the inter-site one favors hybridized states with components on neighbor atoms. Computing
the value of the U I and V I J eﬀective interaction parameters is thus crucial to determine the degree of atomic localization
of d- and/or f -type electrons when the system is in its ground state. The Hubbard projector functions {ϕI
m1 (r)} can be
constructed using diﬀerent types of projector functions as a basis set (see Sec. 2.2).

m1m2 and ˆPI

≡ nIIσ

≡ ˆPII

m1m2

m1m2

3

The action of the Hubbard potential on KS wavefunctions can be obtained by taking the functional derivative of
EDFT+U+V [see Eq. (1)] with respect to the complex conjugate of the same KS wavefunction [13, 59]. The term cor-
responding to this functional derivative of EU+V [see Eq. (2)] is:

ˆV ◦

Hub,σ

=

(cid:88)

(cid:88)

I

m1m2

U I

(cid:32) δm1m2
2

(cid:33)

− nIσ

m1m2

ˆPI

m1m2

−

(cid:88)

∗(cid:88)

(cid:88)

I

J(J(cid:44)I)

m1m2

V I JnI Jσ
m1m2

ˆPI J

m1m2

.

(5)

This Hubbard potential is added to the standard DFT Hamiltonian [2, 3], and then the modiﬁed KS equations are solved
self-consistently.

As was mentioned in Sec. 1, in DFT+U and DFT+U+V the two crucial aspects are: i) the choice of projector functions
that are used to construct the Hubbard manifold, and ii) the choice of the Hubbard parameters (U I and V I J). It is of utmost
importance to understand that the latter strongly depends on the former. Therefore, it makes sense to discuss the values of
Hubbard parameters only when the Hubbard projectors have been ﬁxed.

The use of DFT+U+V instead of DFT+U is mainly motivated by the increased ﬂexibility the former oﬀers compared
to the latter. This is particularly important for more covalently-bonded systems where electronic localization occurs on
hybridized states with components on neighbor atoms. In fact, a too large U, favoring on-site localization, might suppress
the inter-site hybridization and distort the electronic structure of these systems to the point that a negative U might be
required to restore a more physical picture and to recover the results achieved with hybrid HSE06 functionals [60]. This
eﬀect was already observed in Ref. [13] that showed that the standard on-site only DFT+U can actually suppress the
insulating behavior of covalent semiconductors (Si and GaAs) and decrease their band gap. In the same work it was ﬁrst
demonstrated that the use of a ﬁnite and positive V (within DFT+U+V), by favoring the hybridization of atomic states
between neighbor atoms, can in fact re-establish the insulating character of their ground state also predicting a wider
band gap than the one obtained using uncorrected DFT functionals. A ﬁnite positive V was also found eﬀective in re-
establishing a sound description of other problematic covalent systems without the need of negative on-site U’s, as detailed
in Ref. [17]. While the need of an inter-site interaction V makes a semi-empirical evaluation of the Hubbard parameters
much harder, the calculation of V from ﬁrst-principles can be achieved simultaneously to that of U, as illustrated already
in a number of studies [2, 3, 13, 16, 17]. Therefore, DFT+U+V where both U and V values are computed ab initio
constitutes a robust and accurate approach that describes accurately the on-site localization and inter-site hybridization of
electrons without any manual calibrations of Hubbard parameters. More on this is discussed in Sec. 2.3.

2.2. Hubbard projectors

As was discussed above, one of the key aspects of the Hubbard-corrected DFT formalism is the choice of the pro-

jector functions for the Hubbard manifold. In other words, we need to choose the basis {ϕI
m2m1
[see Eq. (4)]. There are quite many possible projector functions to use as a basis for the Hubbard manifold (see e.g.
Refs. [61, 62]). In particular, we mention here nonorthogonalized [10, 63] and orthogonalized atomic orbitals [14, 15, 43],
nonorthogonalized [64] and orthogonalized Wannier functions [65], linearized augmented plane-wave approaches [66],
and PAW projector functions [67, 68]. A common feature of all these projector functions is that they are spatially localized
and depend explicitly on atomic positions. In this work, we consider only two types of projector functions, nonorthogo-
nalized and orthogonalized atomic orbitals. Let us comment brieﬂy about each of them.

m(r)} for the projector ˆPJI

Nonorthogonalized atomic orbitals represent one of the simplest choices for the Hubbard projectors, and they are well
suited for systems with a pronounced ionic character. These functions are provided with pseudopotentials and, by virtue
of their angular part, they are orthonormal within each atom but not between diﬀerent atoms. Therefore, whenever inter-
atomic overlaps between them become relevant, this type of projector functions is not suitable any more, and inter-site
orthogonalization becomes necessary. Orthogonalized atomic orbitals are obtained by taking atomic orbitals of each
atom and then orthogonalizing them to all the orbitals of all the atoms in the system.
In this work, we will use the
L¨owdin orthogonalization method [69, 70]. By doing so, a new set of orbitals is obtained that, by virtue of their mutual
orthogonalization [18], provide a more accurate representation of inter-site hybridization. This choice is particularly
appealing to deﬁne the Hubbard projectors, because it allows us to avoid counting Hubbard corrections twice in the
interstitial regions between atoms. This is especially relevant in the case of DFT+U+V. As explained in Ref. [18],
L¨owdin orthogonalized atomic orbitals are deﬁned as:

m1 (r) =
ϕI

(cid:88)

(cid:16)

Jm2

O− 1

2

(cid:17)JI
m2m1

φJ
m2 (r) ,

(6)

where O is the orbital overlap matrix which is deﬁned from its matrix elements as: (O)I J
m1(r)
and φJ
m2 (r) are the nonorthogonalized atomic orbitals. It is important to note that the atomic and state indices must be
understood as being in couples, (I, m1) and (J, m2), because for diﬀerent types of atoms the considered atomic manifolds
can be diﬀerent. Here we orthogonalize all the states of all the atoms in the system. It is important to orthogonalize not
only states that belong to the chosen Hubbard manifolds of each atom (e.g., d or f states), but also the remaining states,
in order to preserve the on-site orthogonality.

(cid:105), where φI

|φJ
m2

m1m2

= (cid:104)φI
m1

4

In practice, we construct Bloch sums of the L¨owdin orthogonalized atomic orbitals and then use only their lattice-
periodic parts (see Eqs. (A2) and (A5) in Ref. [2]). Further, these quantities are Fourier-transformed from real to reciprocal
space and used in the DFT+U(+V) and DFPT formalisms to compute various scalar products [see e.g. Eqs. (3) and (4)]
as sums over reciprocal lattice vectors.

As shown in Ref. [47], the computed Hubbard parameters do depend strongly on the choice of the Hubbard projector
functions. For example, for β-MnO2 the U values computed using nonorthogonalized and orthogonalized atomic orbitals
diﬀer by about 1−2 eV while V values diﬀer by about 0.3 eV [47]. Therefore, it is crucial that the same Hubbard projector
functions are used for computing Hubbard parameters and for the subsequent DFT+U(+V) production calculations.

2.3. Hubbard parameters from density-functional perturbation theory

Following Ref. [10], Hubbard parameters can be deﬁned as the second derivatives of the total energy with respect to
the total occupation of a given atom, i.e. with respect to the trace of the site-diagonal occupation matrix nIσ
m1m2 . This is
consistent with the structure of the simple Hubbard corrective functional, shown in Eq. (2), that subtracts from the total
energy a quadratic term in the atomic occupation, to substitute it with a linear one, thus removing the unphysical self-
interaction (delocalization) errors from approximate energy functionals. In this context, the inter-site part in Eq. (2) serves
as an oﬀ-diagonal correction when removing self-interactions, which is especially relevant for systems with a covalent
bonding. In practice, the calculation of the energy second derivative can be achieved by perturbing the system with a
shift in the potential acting on the Hubbard states of a given atom J, λJ (cid:80)
mm (λJ is the strength of the perturbation),
and then computing the response of all the atomic occupations. Applying this to all the Hubbard atoms in the system
allows to construct the bare and self-consistent susceptibility matrices that are obtained, respectively, at the beginning of
the perturbed run and at its self-consistent convergence:

m ˆPJ

Here, nI = (cid:80)
obtained [10]:

mσ nIσ

(χ0)I J =

dnI
0
dλJ ,
mm and similar deﬁnition holds for nI
U I = (cid:16)
V I J = (cid:16)

(χ)I J = dnI
dλJ .

(7)

0. From these, the eﬀective Hubbard parameters can be readily

0 − χ−1(cid:17)
χ−1
0 − χ−1(cid:17)
χ−1

II

I J

,

.

(8)

(9)

It is important to stress that the procedure outlined above is based on isolated perturbations; therefore, it requires the
use of large supercells (whose size has to be increased until the convergence of U I and V I J is achieved) [10] that makes
these calculations computationally demanding and prone to accuracy issues due to their problematic convergence and
their reliance on small energy diﬀerences.

DFPT oﬀers a more eﬃcient approach to linear-response calculations and allows us to largely reduce these issues [2, 3].
Within the framework of DFPT, the response of the KS wavefunctions to a small perturbation of the atomic potential
[that induces a variation of the atomic occupations deﬁned in Eq. (7)] is obtained as the self-consistent solution of the
perturbative problem resulting from a ﬁrst-order variation of the KS equations:

(cid:16)

ˆH◦

σ − ε◦

vkσ

(cid:17) (cid:12)(cid:12)(cid:12)(cid:12)

dψvkσ
dλJ

(cid:69) = −

(cid:18) d ˆVHxc,σ
dλJ

−

dεvkσ
dλJ

(cid:19)

+ ˆV J

pert

|ψ◦

vkσ(cid:105) ,

(10)

DFT,σ

+ ˆV ◦

= ˆH◦

Hub,σ is the total Hamiltonian of DFT+U+V, where ˆH◦

where ˆH◦
DFT,σ is the Hamiltonian of standard DFT, and
σ
ˆV ◦
Hub,σ is the corrective Hubbard potential deﬁned in Eq. (5). ε◦
vkσ are the KS energies and wavefunctions of the
unperturbed system in the DFT+U+V framework. ˆV J
dλJ are
the response Hartree and xc (Hxc) potential, response KS wavefunctions, and response KS energies, respectively [2, 3]. It
is important to remark that the response of the Hubbard potential is not present in Eq. (10) so that the Hubbard parameters
are obtained, consistently with their deﬁnition, as second derivatives of the DFT part only of the total energy [2]. The
problem has to be solved self-consistently because the response of the KS eigenvalues and of the Hxc potential appearing
on the right-hand side of Eq. (10) depend on the response of the KS wavefunctions, obtained from the solution of the
perturbative problem in the equation above. Once convergence is achieved, the variation of the diagonal (with respect to
atomic sites) atomic occupation matrices [that deﬁne the self-consistent susceptibility matrix in Eq. (7)] are obtained [71]:

vkσ and ψ◦
mm is the perturbing potential; d ˆVHxc,σ
m ˆPJ

, and dεvkσ

, dψvkσ
dλJ

= (cid:80)

pert

dλJ

dnIσ
m1m2
dλJ

=

Nk(cid:88)

Nocc(cid:88)

k

v

(cid:20)(cid:68)

ψ◦

vkσ

(cid:12)(cid:12)(cid:12)(cid:12)

ˆPI

m2m1

(cid:12)(cid:12)(cid:12)(cid:12)

dψvkσ
dλJ

(cid:69) + (cid:68) dψvkσ
dλJ

(cid:12)(cid:12)(cid:12)(cid:12)

ˆPI

m2m1

(cid:69)(cid:21)

(cid:12)(cid:12)(cid:12)(cid:12)ψ◦

vkσ

.

(11)

The major advantage oﬀered by the DFPT reformulation of LR-cDFT consists in the possibility to obtain the variation of
atomic occupations as a sum of wavevector-speciﬁc contributions that can be computed independently from one another
(thus leading to better scaling of the computational cost [2]) using the primitive unit cell of the system. In fact, the Fourier
5

spectrum of a perturbation that has the periodicity of a supercell (as needed to eliminate the interactions with periodic
replicas) only contains fundamental vectors of its reciprocal lattice that map into a corresponding q points grid within the
BZ corresponding to the primitive cell [2]. The total response of atomic occupations can thus be written as (see Eq. (42)
in Ref. [2]):

dnslσ
m1m2
dλs(cid:48)l(cid:48)

= 1
Nq

Nq(cid:88)

q

eiq·(Rl−Rl(cid:48) ) ∆s(cid:48)

q ¯ns σ
m1m2

,

(12)

where the atomic site indices I and J have been decomposed as I = (l, s) and J = (l(cid:48), s(cid:48)) indicating, respectively, the
cell the atom belongs to (l and l(cid:48)) and its position within the cell (s and s(cid:48)). Here, Nq is the number of q points in the
ﬁrst BZ (note that the dimension of the q points grid reﬂects directly that of the supercell it is the reciprocal-space image
of). Hereafter, we use the over-bar to indicate lattice-periodic parts of the ground-state and response quantities. ∆s(cid:48)
m1m2
represents the lattice-periodic response of the occupation matrix to a monochromatic perturbation with a wavevector q,
and it can be linked to the lattice-periodic variations of the KS wavefunctions as follows [2]:

q ¯ns σ

∆s(cid:48)
q ¯ns σ
m1m2

= 1
Nk

Nk(cid:88)

Nocc(cid:88)

(cid:20)(cid:68)

¯u◦
vkσ

k

v

(cid:12)(cid:12)(cid:12)(cid:12)

ˆ¯Ps
m2,m1,k,k+q

(cid:12)(cid:12)(cid:12)(cid:12)

∆s(cid:48)

q ¯uvkσ

(cid:69) + (cid:68)

¯u◦
vkσ

(cid:12)(cid:12)(cid:12)(cid:12)

ˆ¯Ps
m1,m2,k,k+q

(cid:12)(cid:12)(cid:12)(cid:12)

∆s(cid:48)

q ¯uvkσ

(cid:69)(cid:21)

.

(13)

vkσ and ∆s(cid:48)

Here, ¯u◦
q ¯uvkσ are the lattice-periodic parts of the unperturbed and linear-response monochromatic q component
of the KS wavefunctions, respectively (see the appendices 1 and 3 of Ref. [2]). The lattice-periodic part of the projector
on the Hubbard manifold, which appears in Eq. (13), reads [2]:

ˆ¯Ps
m2,m1,k,k+q

= | ¯ϕs

m2,k(cid:105)(cid:104) ¯ϕs

m1,k+q| .

(14)

The two terms on the right-hand side of Eq. (13) were made look similar (except for the inversion in the order of indices
m1 and m2) by the use of time-reversal symmetry. As was mentioned above, due to the linear character of the perturbative
problem [Eq. (10)], the lattice-periodic components of the response KS wavefunctions at diﬀerent q can be computed
independently from one another as solutions of q-speciﬁc Sternheimer equations [2]:

(cid:18)

ˆ¯H◦

k+q,σ

+ α ˆ¯Ok+q,σ − ε◦

vkσ

(cid:19)

|∆s(cid:48)

q ¯uvkσ(cid:105) = − ˆ¯Pk+q,σ

(cid:16) ∆s(cid:48)

q

ˆ¯VHxc,σ + ˆ¯V s(cid:48)

pert,k+q,k

(cid:17)

|¯u◦

vkσ(cid:105) ,

where the perturbing potential reads:

ˆ¯V s(cid:48)
pert,k+q,k

=

(cid:88)

m

ˆ¯Ps(cid:48)
m,m,k+q,k .

(15)

(16)

q

k+q,σ and ∆s(cid:48)

ˆ¯VHxc,σ are, respectively, the lattice-periodic parts of the unperturbed Hamiltonian ˆH◦

The quantities ˆ¯H◦
σ (which
contains the Hubbard corrective potential with on-site U and inter-site V) and response Hxc potential for a speciﬁc q.
ˆ¯VHxc,σ depends on the response spin charge density at the same q, ∆s(cid:48)
The response Hxc potential ∆s(cid:48)
q ¯ρσ(r), which in turn
q
q ¯uvkσ(r) (see Ref. [2] for more details). The operators ˆ¯Ok+q,σ and ˆ¯Pk+q,σ are the lattice-periodic parts of
depends on ∆s(cid:48)
projectors on the valence and conduction manifolds, respectively [52, 72]:

and

ˆ¯Ok+q,σ =

Nocc(cid:88)

v(cid:48)

v(cid:48)k+qσ(cid:105)(cid:104)¯u◦
|¯u◦

v(cid:48)k+qσ| ,

ˆ¯Pk+q,σ = 1 −

Nocc(cid:88)

v(cid:48)k+qσ(cid:105)(cid:104)¯u◦
|¯u◦

v(cid:48)k+qσ| .

(17)

(18)

v(cid:48)
vkσ]), where max[ε◦

vkσ] − min[ε◦

vkσ] and min[ε◦

In Eq. (15), α = 2 (max[ε◦
vkσ] are the highest and the lowest energies of
the occupied KS bands, respectively. The operator ˆ¯Ok+q,σ is inserted on the left-hand side of Eq. (15) in order to avoid
singularity issues during the iterative solution; at the same time the operator ˆ¯Pk+q,σ avoids very expensive sums over
numerous empty states [52, 2, 3]. Note that due to the presence of the projector ˆ¯Pk+q,σ in Eq. (15) the derivative of
the KS eigenvalues disappears from the right-hand side of Eq. (15) in comparison to Eq. (10) (see also Ref. [2]). The
KS wavefunctions at k + q points, ¯u◦
v(cid:48)k+qσ(r), which are present in Eqs. (17) and (18) are obtained by solving non-self-
consistently the KS equations and using the unperturbed ground-state spin charge density ¯ρ◦
σ(r). All the operators in
Eq. (15) appear with a speciﬁc q component as a result of recasting Eq. (10) in reciprocal space through the Bloch sums
of all the quantities appearing in there (this is discussed in detail in Ref. [2]). The potential terms appearing on the right-
hand side of Eq. (15) represent the lattice-periodic components of the corresponding potential variations at the indicated
wavevector q. Once these equations are solved self-consistently for all the wavevectors, Eqs. (12) and (13) are used to
compute the susceptibility matrices using Eq. (7), from which the Hubbard interaction parameters are readily obtained as
indicated in Eqs. (8) and (9).

6

2.4. Extensions of the DFPT formalism

The formalism presented above has been generalized in several ways:

i) metallic ground states; ii) ultrasoft (US)
PPs [73] and the PAW method [74]; and iii) explicit account of symmetry. A detailed discussion about the ﬁrst two points
can be found in Ref. [3].

Metallic ground states. The ground state of a given system computed using standard DFT can be used as a starting
point for the DFPT calculation of Hubbard parameters. However, in some systems standard DFT predicts a metallic
ground state due to large self-interactions errors, while in reality the system is insulating. Therefore, the DFPT approach
presented above must be generalized to be able to work on top of metallic ground states. For this reason, an extension of
the DFPT approach to metallic ground states has been developed and discussed in detail in Ref. [3]. It is based on the use
of the smearing technique [75]. In metals, very dense k points sampling is needed to sample the Fermi surface, which is
computationally very expensive. Thanks to the smearing of the Fermi surface it is possible to reduce greatly the number
of k points needed to describe electronic states around the Fermi level, which helps containing the computational cost;
as a consequence, these states have partial occupancy (between 0 and 1). The DFPT approach can still have the same
form as for non-metallic systems but the following modiﬁcations are required [3]: i) electronic states should be allowed
to have a fractional occupancy which translates into weighted sums over k points and band indices, ii) the deﬁnition of
the projector ˆ¯Pk+q,σ is generalized, and iii) the response occupation matrix ∆s(cid:48)
m1m2 and the response spin charge density
acquire an extra term proportional to the shift of the Fermi level when q = 0. The interested reader can ﬁnd a detailed
discussion in Ref. [3].

q ¯ns σ

US PPs and PAW. In systems containing localized valence states (e.g., semicore states included in the valence region or
atomic states of d or f kind in transition-metal and rare-earth compounds), high kinetic energy cut-oﬀs in the plane-wave
expansion are needed if NC PPs are used. In this case, it is useful to replace NC PPs by US PPs or PAW which allow to
reduce signiﬁcantly the kinetic energy cut-oﬀ and thus lower the overall computational cost of the calculations. However,
when US PPs or PAW are used augmentation terms are added in the expressions for the spin charge density to restore the
correct normalization, and consequently extra terms appear in the expressions for the local and Hxc potentials. In US and
PAW formalisms, the standard KS equations must be replaced by generalized KS equations which contain the overlap
operator ˆS [73], and therefore also the ﬁrst-order response KS equations are modiﬁed [3]. The unperturbed and response
occupation matrices are also generalized, as well as the Hubbard potential, with the projector on the Hubbard manifold
acquiring the ˆS operator, as ˆPJI

| ˆS . Detailed discussions are presented in Ref. [3].

= ˆS |ϕJ
m2

(cid:105)(cid:104)ϕI
m1

m2m1

Symmetry. The CPU time and memory requirements of the DFPT calculation can be signiﬁcantly reduced by exploiting
the symmetry of the system. In fact, as explained in abundant literature (and speciﬁcally in Appendix A.4 of Ref. [56]
for Quantum ESPRESSO ) the use of symmetry allows to focus ground-state calculations only on a small portion of the
regular k point grid used to sample the BZ (the so-called irreducible wedge of the BZ (IBZ)). Within DFPT, the use of
symmetry is slightly more articulated due to the presence of perturbations. The response of a system (and the derivative
of relevant quantities) is typically reconstructed from the response to a series of monochromatic perturbations that are
computed one by one. Since a ﬁnite wavelength perturbation (q (cid:44) 0) lowers the symmetry of the crystal, at each speciﬁc
q point all the ground-state quantities that are needed in DFPT calculations (e.g., KS wavefunctions, Hamiltonian, and
eigenvalues) must be recomputed on an extended IBZ that is determined according to the so-called small group of q (i.e.
the group of symmetries such that Sq q = ±q + G, where G is a reciprocal lattice vector). The same procedure needs
to be repeated for each q point. Once DFPT calculations are completed for all the inequivalent points of the q-grid, and
the response on the other q-points is reconstructed by symmetry, the total response is computed according to Eq. (12).
Symmetry is thus important to reduce the workload of both DFT and DFPT calculations. The use of primitive unit
cells, and the possibility to reduce the number of q-speciﬁc linear-response calculations thanks to symmetry contribute to
make these calculations substantially faster than supercell-based LR-cDFT which cannot escape the cubic scaling of DFT
calculations with respect to the number of atoms.

3. Description of software components

The HP code is contained in a module of the Quantum ESPRESSO distribution [56, 57, 58], and it resides in a self-
contained directory HP under the root directory of the Quantum ESPRESSO tree. The HP code is tightly integrated
in Quantum ESPRESSO , and it uses many routines from other modules, namely PW , Modules, and LR Modules (see
Ref. [58] for more details). In addition, HP uses various domain-speciﬁc mathematical libraries of Quantum ESPRESSO ,
such as LAXlib (containing routines to perform linear-algebra operations) and FFTXlib (containing routines to perform
Fast Fourrier Transforms (FFT’s)). Basic linear-algebra operations (e.g. matrix-matrix and matrix-vector multiplications,
scalar products, matrix inversions, etc.) are eﬃciently performed using BLAS and LAPACK libraries. In the following
we discuss the workﬂow of the calculation of Hubbard parameters.

3.1. Ground-state calculation

In order to compute the Hubbard parameters for a given system, a standard ground-state DFT [or DFT+U(+V) with
some initial guess of U (and V)] calculation has to be performed ﬁrst, yielding the lattice-periodic parts of the unperturbed
7

vkσ(r) and the KS energies ε◦

vkσ for all the occupied states, the ground-state spin charge density ¯ρ◦

KS wavefunctions ¯u◦
σ(r),
and the occupation matrix nIσ
m1m2 . The information thus obtained is then used as input for the linear-response calculation
with the HP code. This ground-state calculation is performed using the PW code (pw.x executable), which is one of the key
components of the Quantum ESPRESSO distribution. In Appendix A sample input ﬁles for pw.x are shown (see the input
samples 1 and 2). After the successful completion of the ground-state calculation, the pw.x code writes the ground-state
quantities mentioned above to disk, together with all the relevant information about the system, including unit cell and
atomic positions, pseudopotentials, energy cutoﬀs, k point grids, etc. This data is used by the HP code which reads it from
ﬁle. Therefore, it is not necessary to redeﬁne the system under study in the input ﬁle of hp.x.

3.2. Linear-response calculation

The linear-response calculation of Hubbard parameters (U in the DFT+U framework, or U and V in the DFT+U+V
framework) is done using the HP code (hp.x executable). A list of all input variables of hp.x is given in Table B.3 of
Appendix B, and a sample input ﬁle for hp.x is given in Appendix A (see the input sample 3). The total number of
linear-response calculations that have to be performed is NpertNq, where Npert is the number of Hubbard atoms in the
primitive unit cell that have to be perturbed, and Nq is the number of points in the q grid.

H ×Nsc

The size of the response matrices χ and χ0 is Nsc

= NHNq, and NH is the total number of Hubbard atoms
H , where Nsc
H
in the primitive unit cell [2]. Each column of the response matrices corresponds to the perturbation of a speciﬁc Hubbard
atom of the primitive unit cell with a speciﬁc q. It is possible to reduce the number of linear-response calculations by
perturbing only inequivalent Hubbard atoms in the primitive unit cell. The HP code contains the implementation of several
algorithms which ﬁnd inequivalent Hubbard atoms (i.e. Npert); this is controlled by the keyword find atpert which is
described in Table B.3. The default algorithm for ﬁnding inequivalent (i.e., to be perturbed separately) Hubbard atoms is
based on the comparison of the traces of unperturbed atomic occupation matrices, Tr[nIσ
m1m2 ], which represent the L¨owdin
estimate of the number of electrons residing on the Hubbard manifold of a given Hubbard atom I. The calculation of the
response to the perturbation of inequivalent Hubbard atoms are independent from each other, and hence it is possible to
eﬃciently parallelize these calculations by performing them on diﬀerent nodes/machines (see Sec. 4.2).

The linear-response calculation for each perturbed Hubbard atom requires solving Nq independent q-speciﬁc Stern-
heimer equations (15). Nq is the number of points in the q point grid, Nq = nq1 × nq2 × nq3. The strength of DFPT (see
Sec. 2.3) resides in the fact that linear-response calculations at each q point are independent from other q points (in linear
regime there is no coupling between perturbations at diﬀerent wavelengths), and hence it is possible to parallelize calcu-
lations over q points as well (see Sec. 4.2). When the self-consistency of each q-speciﬁc Sternheimer equation has been
reached, the q-speciﬁc response occupations matrices ∆s(cid:48)
m1m2 are computed using Eq. (13). Then, all the responses are
summed up using Eq. (12), thus giving one column of the self-consistent response matrix χ (see Eq. (7)). One column of
the bare response matrix χ0 is computed in a similar way, however the sum of responses using Eq. (12) is computed after
ˆ¯VHxc,σ)
the ﬁrst iteration in the self-consistent cycle of Eq. (15), i.e. before that the response of the Hxc potential (i.e. ∆s(cid:48)
q
builds up. Other columns of the response matrices χ and χ0 are obtained from the perturbation of other inequivalent
Hubbard atoms.

q ¯ns σ

The Sternheimer equations (15) are solved iteratively and self-consistently using the conjugate-gradient method [52,
56], and using the standard linear-response machinery of Quantum ESPRESSO [57, 58]. In order to speed up the con-
ˆ¯VHxc,σ [2].
vergence of the iterative solution, the scheme of Ref. [76] is used for mixing the response Hxc potential ∆s(cid:48)
q
Table B.3 describes the parameters that control the convergence of the Sternheimer equations and of the response matrices
χ and χ0.

The ﬁnal step of the HP calculation is the postprocessing calculation of the Hubbard parameters using Eqs. (8) and (9).
This step is computationally inexpensive (negligible compared to the linear-response calculation). In this ﬁnal phase,
the missing columns of the response matrices χ and χ0 are reconstructed from the available data (i.e. columns which
were computed explicitly, as discussed above) exploiting the symmetry of the system. This is done by comparing the
inter-atomic distances, atomic types, and the orientation of spin (up or down). Once the full matrices χ and χ0 have been
reconstructed, they are inverted to compute the interaction matrix as showed in Eqs. (8) and (9).

4. Software installation, parallelization, and testing

4.1. Installation instructions

The HP program is distributed as source code, like the other components of the Quantum ESPRESSO distribution.
Version control is handled using Git and the code is hosted on the GitLab platform [77]. The installation procedure
of HP is the same as for all other modules of the distribution. Quantum ESPRESSO (including HP) makes use of GNU
autoconf [78]. The HP repository, which contains the source HP code, is residing within the Quantum ESPRESSO tree.
8

The code is compiled with the following commands from within the Quantum ESPRESSO tree:

./configure

make pw

make hp

Alternatively, it is possible to use cmake [79] instead of ./configure. Here, the ﬁrst step sets up the environment
(compilers, libraries, etc.), the second step compiles the PW code (pw.x), and in the third step, the HP code (hp.x) is
compiled. Links to all these executables are created in the bin/ directory of the Quantum ESPRESSO tree. More detailed
If problems are
instructions on the installation can be found in the documentation that comes with the distribution.
encountered during the installation or the use of HP (or of any other code in the Quantum ESPRESSO distribution) users
can also take advantage of the Quantum ESPRESSO users forum [80] by posting speciﬁc questions about their diﬃculties.
Users intending to make quick tests with HP or to use it for demonstrative or teaching purposes [81] could consider the
Quantum Mobile [82] - a virtual machine that has Quantum ESPRESSO pre-installed along with several other codes
for quantum-mechanical materials simulations. Quantum Mobile can be easily installed on laptops and desktops and its
use avoids any issues related to the installation of the Quantum ESPRESSO package. Of course, the Quantum Mobile
is not recommended for production runs; an optimized installation of Quantum ESPRESSO on workstations and high-
performance computers should instead be preferred for these purposes.

4.2. Parallelization of the code

Like the other components of Quantum ESPRESSO, the HP code is optimized to run on a variety of diﬀerent platforms,
from laptops to massively parallel architectures. The parallelization of the HP code is achieved by using the message-
passing paradigm and calls to standard Message Passing Interface (MPI) libraries [83]. High performance on massively
parallel architectures is achieved by distributing both data and computations in a hierarchical way across processors.
The FFT’s, which are used for transformations from real space to reciprocal space and vice versa, are also eﬃciently
parallelized among processors [56]. The HP code supports four levels of parallelization:

1. The parallelization over perturbed Hubbard atoms, which is implemented by distributing independent linear-response
atom-speciﬁc calculations (each having a grid of q points) across the processors, each taking care of one atom-speciﬁc
perturbation. This parallelization is controlled by setting the input parameter perturb only atom(i) to .true.,
which speciﬁes that the Hubbard atom with the index i will be perturbed in the current run;

2. The q points parallelization, which is implemented by distributing independent linear-response q-speciﬁc calcula-
tions of an atom-speciﬁc perturbation across the processors, each taking care of one or more q points. This paral-
lelization is controlled using the input parameters start q and last q which specify the index of the starting and
ﬁnal q points from the list of all q points that have to be considered in the current pool of q points;

3. The k points parallelization, which is implemented by dividing all processors into pools, each taking care of one or

more k points;

4. The plane-wave parallelization, which is implemented by distributing real- and reciprocal-space grids across the

processors.

Figure 1 shows the hierarchy of the parallelization levels of the HP code. First, the calculation can be parallelized over
the Hubbard atoms that must be perturbed (see perturb only atom); second, for each perturbed Hubbard atom the
calculation can be parallelized over q points (see start q and last q); third, for each q point (or a subset of q points)
the linear-response calculation can be parallelized over the k points (by choosing an appropriate number of k point pools
Npool); and, last, within each k point pool all available CPUs are used to parallelize the calculation over plane waves (G
points). If the system under study is quite small (say, a handful of atoms) and it can be run on a local workstation (with
e.g. 8-16 cores), then it is convenient to skip the parallelization over perturbed Hubbard atoms and over q points, and
use the parallelization over the k points (which can also be skipped) and use (only) the parallelization over plane waves.
If the calculations are run on HPC clusters with many nodes, then it is highly recommended to use all aforementioned
levels of parallelization in order to utilize the computational resources in the most eﬀective way. Moreover, on HPCs it is
recommended to avoid that the same compute node is split between k pools or groups of q points or perturbed atoms (due
to the slow inter-node communications). Finally, we note that at present these levels of parallelization have to be chosen
by the user manually.

4.3. Testing of the code

The HP code implements DFPT which is complex from the programming point of view, and hence it is crucial to
have a test suite to ensure that the new developments do not break existing functionalities of the code – its availability
facilitates maintenance of the code and ensures its long-term stability. As other components of Quantum ESPRESSO ,
the HP code relies on the test suite that is based on the testcode.py [84]: this provides the functionality to run tests
9

Figure 1: Schematic illustration of diﬀerent parallelization levels of the HP code. Nk and Nq are the number of k and q points, respectively, Npool is the
number of k points pools, NPW is the number of plane waves (PWs) in the basis, and Ipert is the index of the perturbed Hubbard atom. The meaning of
the keywords perturb only atom, start q, and last q is explained in Table B.3. Note, the speciﬁc parallelization over the k and q points is shown
just for demonstration purposes, but in practice the total number of k and q can be split in many diﬀerent ways, i.e. diﬀerent number of k point pools
Npool and diﬀerent parallelization over q points (depending on the availability of computational resources).

automatically (nightly) and compare selected quantities (Hubbard parameters) parsed from the output ﬁles generated by
HP against reference values. The HP code is run both in serial and in parallel, using various combinations of commonly
used compilers [Intel Fortran compilers (ifort), GNU Fotran compilers (GFortran), etc.] and libraries (Intel MPI, Open
MPI, etc.), which ensures that the code function correctly on various high-performance computer (HPC) architectures and
in diﬀerent environments. Whenever new features are added to the HP code, the corresponding tests must be added to the
test suite by the developers in order to guaranty the robustness of these features in the long term.

5. Benchmarking

We now showcase how to use the HP code for computing the Hubbard U for the Fe(3d) and Mn(3d) states and Hubbard
V for Fe(3d)–O(2p) and Mn(3d)–O(2p) in LixMn1/2Fe1/2PO4 at x = 0, 1/2, and 1. We recall that the validation of the
DFPT implementation versus the ﬁnite-diﬀerence supercell approach of Refs. [10, 13] was already done in our previous
works [2, 3]. After computing U and V self-consistently, we present the results for this material obtained in the framework
of DFT+U and DFT+U+V.

5.1. Technical details

All calculations were performed using the plane-wave (PW) pseudopotential method as implemented in the Quan-
tum ESPRESSO distribution [56, 57, 58]. We have used the xc functional constructed using spin-polarized GGA
with the PBEsol prescription [85]. The PPs were taken from the SSSP library v1.1 (eﬃciency) [86, 87], which are
either US or PAW: For manganese we have used mn pbesol v1.5.uspp.F.UPF from the GBRV v1.5 library [88],
for iron and oxygen Fe.pbesol-spn-kjpaw psl.0.2.1.UPF and O.pbesol-n-kjpaw psl.0.1.UPF from the Psli-
brary v0.3.1 [89], for phosphorus P.pbesol-n-rrkjus psl.1.0.0.UPF from the Pslibrary v1.0.0 [90], and for lithium
li pbesol v1.4.uspp.F.UPF from the GBRV v1.4 library [88]. To construct the Hubbard projector functions ϕI
m(r)
[see Eq. (4)] we have used atomic orbitals which are orthogonalized using L¨owdin’s method [69, 70]. Structural opti-
mizations using DFT+U and DFT+U+V were performed using orthogonalized atomic orbitals as described in detail in
Ref. [18]. KS wavefunctions and potentials were expanded in PWs up to a kinetic-energy cutoﬀ of 90 and 1080 Ry,
respectively, and the BZ was sampled using the uniform Γ-centered k point mesh of size 5 × 8 × 9, for structural optimiza-
tion. The crystal structure was optimized using the Broyden-Fletcher-Goldfarb-Shanno (BFGS) algorithm [91], with a
convergence threshold of 10−6 Ry for the total energy, 10−5 Ry/Bohr for forces, and 0.5 Kbar for pressure. For the metallic
ground states we have used the Marzari-Vanderbilt smearing method [53] with a broadening parameter of 0.02 Ry.

The DFPT calculations of Hubbard parameters were performed using the uniform Γ-centered k and q point meshes
of size 3 × 4 × 5 and 1 × 2 × 3, respectively, which give an accuracy of 0.01 eV for the computed values of U and V.
These k and q point meshes were determined by performing convergence tests as described in detail in Ref. [2]. The
10

…perturb_only_atom(1) = .true.…start_q = Nq-2last_q  = Nqstart_q = 1last_q  = 3…start_q = 1last_q  = 3…q points = {q1, q2, q3}…k pool #Npool………k pool #1k pool #Npoolperturb_only_atom(Ipert) = .true.Plane waves parallelization{G1,…,GNPW}start_q = Nq-2last_q  = Nq{k1,…,k20}{kNk-19,…,kNk}PWsPWsFigure 2: Crystal structure of the phospho-olivine LiMn1/2Fe1/2PO4. Fe atoms are indicated in blue, Mn atoms in purple, O atoms in red, Li atoms in
green, and P atoms in yellow. Black vertical arrows indicate the orientation of spin. Rendered using VESTA [94].

KS wavefunctions and potentials were expanded in PWs up to a kinetic-energy cutoﬀ of 65 and 780 Ry, respectively, for
calculation of Hubbard parameters. The linear-response KS equations of DFPT were solved using the conjugate-gradient
algorithm [92] and the mixing scheme of Ref. [76] for the response potential to speed up convergence.

Bulk Li was modeled at the DFT-PBEsol level using the bcc unit cell with one Li atom at the origin. The optimized
lattice parameter is 3.436 Å. The BZ was sampled using the uniform Γ-centered k point mesh of size 10 × 10 × 10, and we
have used the Marzari-Vanderbilt smearing method [53] with a broadening parameter of 0.02 Ry. The KS wavefunctions
and potentials were expanded in PWs up to a kinetic-energy cutoﬀ of 65 and 780 Ry, respectively.

The phospho-olivine LixMn1/2Fe1/2PO4 has an orthorhombic crystal structure at x = 0 and x = 1 with a Pnma space
group [93]. The unit cell contains four formula units, i.e. 24 atoms in the case of x = 0 and 28 atoms in the case of
x = 1. The crystal structure at x = 1 is shown in Fig. 2. The transition-metal (TM) atoms (labeled as M) are coordinated
by six O atoms forming a MO6 octahedron of which it occupies the center. The P atoms are instead at the center of PO4
tetrahedra that they form with neighboring oxygens. The three-dimensional structure of the crystal can be understood
as being based on a network of corner-sharing MO6 octahedra further linked by “interstitial” PO4 tetrahedra that act as
structural reinforcer [avoiding excessive volume variations upon Li (de-)intercalation] and chemical stabilizers (useful
to avoid oxygen escapes). Li ions reside within octahedral channels along the intermediate-length side of the cell. The
phospho-olivines are known to show an antiferromagnetic behavior below their transition temperatures. In the previous
study (Ref. [14]) it was shown that diﬀerent antiferromagnetic arrangements of spins result in total energies that diﬀer not
more than by ∼ 20 meV at the DFT+U+V level of theory. Here we use the magnetic conﬁguration that minimizes the
total energy (labeled “AF1” in Ref. [14]), and it is depicted in Fig. 2. Finally, there are several conﬁgurations for arranging
two Mn and two Fe atoms in the unit cell of LixMn1/2Fe1/2PO4. Our goal here is not to investigate all conﬁgurations but
rather to choose one as a representative case for comparing results obtained using diﬀerent levels of theory. To this end,
we choose to arrange Mn and Fe atoms such that two Mn atoms are antiferromagnetically coupled to each other and same
for Fe atoms, as shown in Fig. 2.

The data used to produce the results of this work are available in the Materials Cloud Archive [95].

5.2. Ground-state calculation

In order to compute the Hubbard parameteres, independently from the speciﬁc functional adopted (DFT, DFT+U, or
DFT+U+V), the ﬁrst step is the ground-state calculation using the PW code. Since we are interested in a self-consistent
calculation of Hubbard parameters [3], in Appendix A we show the input samples for DFT+U (input sample 1) and
DFT+U+V (input sample 2) already with the converged values of U and V. If one wants to start from the DFT ground-
state, then the values of U for Fe(3d) and Mn(3d) states have to be initialized to some small numbers (e.g. 10−10 eV)
for the sake of activating the Hubbard-related machinery (in the DFT+U+V case, there is no need to initialize V, instead
initialize U for O(2p)).

The input ﬁles for the PW code contain the standard input parameters that will not be described here (the interested reader
is invited to check the documentation of the PW code [96]). Instead, we focus on the initialization of the Hubbard-related
input parameters. Since Quantum ESPRESSO v7.1, the input syntax for Hubbard-corrected DFT has changed to make it
more user-friendly. More speciﬁcally, there is a new input card called “HUBBARD”, where Hubbard-related data has to
be speciﬁed. In particular, one has to specify the type of Hubbard projectors. Currently, in Quantum ESPRESSO there
are two most popular types of Hubbard projectors, namely “atomic” that corresponds to the nonorthogonalzied atomic
orbitals and “ortho-atomic” that corresponds to the L¨owdin orthogonalized atomic orbitals (see Sec. 2.2). Here we use
the second option, thus in the input ﬁle we specify “HUBBARD {ortho-atomic}”. Next, one has to specify the Hubbard
manifolds, the values of the Hubbard parameters, and the indices of neighbors I and J between which V is applied in
11

the case of DFT+U+V. On the one hand, in the case of DFT+U (see the input sample 1 in Appendix A) we specify
that we want to apply the Hubbard U correction to Fe1, Fe2, Mn1, and Mn2, so we write a letter U on each input line
inside the “HUBBARD” card. For each of the Hubbard atomic types we specify the Hubbard manifold which is 3d, hence
we indicate it as Fe1-3d, Fe2-3d, Mn1-3d, and Mn2-3d. Finally, we specify the corresponding values of the Hubbard
U parameters on each input line: for Fe1(3d) and Fe2(3d) states we have exactly the same value of 4.97 eV, while for
Mn1(3d) and Mn2(3d) we have 4.32 eV. These values were computed self-consistently using the HP code (see below). It
is important to remark that Fe1 and Fe2 are crystallographically equivalent, and same for Mn1 and Mn2, and they diﬀer
only by the orientation of spin (this is why we have deﬁned sublattices with diﬀerent indices). That is why the values of
Hubbard U parameters are the same for the same TM elements. On the other hand, in the case of DFT+U+V we need
to specify both Hubbard U and V. The syntax for setting up Hubbard U is the same as in the DFT+U case. To specify
Hubbard V, we need to indicate a letter V and then to indicate what is the couple of neighbors that we want to consider.
For example, in the input sample 2 in Appendix A we specify the pair Fe1-3d and O-2p, and similarly for other nearest
neighbors for each TM element. However, this is not all and we need to specify the indices I and J to say speciﬁcally to
which atoms we are referring. Since Quantum ESPRESSO uses periodic boundary conditions, our real simulation cell is
virtually replicated in all three Cartesian directions (positive and negative directions) and periodic replicas of atoms are
generated (so we end up with a virtual 3 × 3 × 3 supercell). It is important to stress that in practice we still work with the
unit cell while the virtual 3 × 3 × 3 supercell is only generated internally in the code just for the sake of determining the
indices I and J of the neighboring atoms. This virtual supercell should not be confused with any of the real supercells
that are used in the LR-cDFT approach to converge the computed Hubbard parameters. A priori the user is not supposed
to specify these indices, instead, these indices and the values of Hubbard parameters are obtained as an output of the
HP calculation. In the input sample 2 in Appendix A we can see that for each TM element we have speciﬁed six nearest
neighbors because of the octahedral coordination; from our experience, setting six nearest neighbors is suﬃcient in the
vast majority of cases. However, technically there is no restriction to include even further neighbors, but care must be
taken in converging accurately the values of V.

In the case of magnetic insulators (which is the case here), the ground-state calculation must be performed using a two-
step procedure. First step, we need to perform a self-consistent-ﬁeld (SCF) DFT+U or DFT+U+V calculation as indicated
in Appendix A by treating the system as a fake metal by using some smearing function (occupations = ’smearing’,
smearing = ’mv’, and degauss = 0.01 in the system namelist). This is needed technically in order to allow for
fractional occupations in the spin-polarized calculation (nspin = 2 in the system namelist) by setting some nonzero
starting magnetization to each TM element (see starting magnetization). If we proceed directly to the HP calculation
immediately after this ﬁrst step there will be a problem because the density of states at the Fermi level is very small
and there will be a diverging “metallic term” (see Eq. (79) in Ref. [52]). Therefore, we need to perform a second SCF
calculation by restarting from the wavefunctions and spin charge density/potential of the ﬁrst SCF calculation (by adding
startingwfc = ’file’ and startingpot = ’file’ in the electrons namelist), by setting occupations to be ﬁxed
(occupations = ’fixed’), and by setting a total magnetization to be equal to the one determined in the ﬁrst SCF
calculation (tot magnetization = 0.00 in this case in the electrons namelist). After this second SCF calculation
we obtain a converged ground state for a magnetic insulator, which allows us to proceed to computing Hubbard parameters
using DFPT as implemented in the HP code.

5.3. Hubbard parameters

In this section we discuss how to compute Hubbard parameters using the HP code starting from the data generated from
the ground-state calculation (see Sec. 5.2). The input ﬁle for the linear-response calculation is quite simple and is shown
in Appendix A (see the input sample 3). First of all, one has to specify prefix = ’olivine’ and outdir=’./’, which
are the preﬁx and output directory that must be exactly the same as in the input samples 1 or 2 (this is needed for reading
the ground-state data). Second, the q point grid must be set: in this case we use the grid of size 1 × 2 × 3 and we specify
it as nq1 = 1, nq2 = 2, and nq3 = 3. The values of the Hubbard parameters computed using DFPT must be converged
with respect to the size of the q point grid [2]; this is equivalent to converging Hubbard parameters with respect to the
size of the (real) supercell when using the LR-cDFT approach of Ref. [10]. In principle, this should be enough in the
majority of cases because the default values for other input parameters will be used. For the case of the phospho-olivine
LixMn1/2Fe1/2PO4 we have changed somewhat other two input parameters compared to the default values. Namely,
we set conv thr chi = 1.0d-7 eV−1 which is the convergence threshold for the self-consistent response matrix (χ)I J
[see Eq. (7)] during the iterative solution of the Sternheimer equation (15), and dist thr = 5.D-3 Bohr which is the
threshold for comparing inter-atomic distances when reconstructing the missing elements of the response susceptibility
matrices (χ)I J and (χ0)I J in the post-processing step.

It is useful to comment on the diﬀerent options available to make the HP code determine which Hubbard atoms must
be perturbed. This is controlled by the input parameter find atpert (meaning “ﬁnd atoms to perturb”). The default
value (which is also used in this work) is find atpert=1: it checks the ground-state atomic occupations, Tr[nIσ
m1m2 ],
and compares them for diﬀerent Hubbard atoms. If the diﬀerences between the atomic occupations of Hubbard atoms
of the same type are smaller than the threshold docc thr (whose default value is 5 × 10−5) then these Hubbard atoms
12

are considered to be crystallographically equivalent (even if the magnetic moments have opposite sign). By applying this
check the Hubbard atoms are classiﬁed according to their occupations and one atom per class is then perturbed. This
option is the default one because it is general and it works well in most cases (regardless the number of symmetries that
the system features). A second option is find atpert=2: the code perturbs one Hubbard atom per type. It is important
to stress that when using this option, Hubbard atoms of the same type will be always treated as equivalent (for the
purpose of calculating the Hubbard parameters) even if they are crystallographically inequivalent or show diﬀerent atomic
occupations. This could lead to inaccuracies if not used properly. This option is useful when the user wants to distinguish
Hubbard atoms that might accidentally assume the same occupation (see previous option). Option find atpert=3
corresponds to determining Hubbard atom perturbation classes based on the symmetries of the system. This option,
mostly useful when the system is highly symmetric, serves to distinguish Hubbard atoms that accidentally show the same
atomic occupation. Finally, find atpert=4 corresponds to perturbing separately all the Hubbard atoms in the unit cell
(i.e., assuming they are all inequivalent), which is obviously the most computationally expensive case. All these options
of find atpert provide a signiﬁcant ﬂexibility in determining which Hubbard atoms should be perturbed in a system
of interest. In general, however, it is recommended to start with the default option find atpert=1. By applying this
procedure to LiMn1/2Fe1/2PO4, 8 Hubbard atoms are perturbed in total within DFT+U+V: Fe1 (#1), Mn1 (#3), and 6
oxygen atoms (#5, #6, #9, #10, #13, #15) - see the numbering of atoms in the ATOMIC POSITIONS card in Appendix A.
As can be seen, within DFT+U+V when we compute the Hubbard parameters using DFPT we perturb also O atoms - this
is needed in order to determine the inter-site Hubbard V parameters. However, we do not report and do not use Hubbard
U for O atoms.

The resulting Hubbard parameters in the DFT+U and DFT+U+V frameworks are shown in Table 1. It is interesting
to observe how the values of Hubbard parameters change upon the lithiation of the material. In the DFT+U case we can
see that when going from x = 0 to x = 1/2 the U value for Fe(3d) states is only slightly increased (by 0.13 eV), while
the U value for Mn(3d) states decreased signiﬁcantly (by 1.66 eV). This means that the extra two electrons went to two
Mn atoms and hence the corresponding U values dropped substantially. When further going from x = 1/2 to x = 1 we
see that the U value for Fe has now decreased (by 0.17 eV), while U for Mn has further decreased (by 0.25 eV). Such a
nonmonotonic behavior of U for Fe upon the lithiation is quite confusing, while for Mn we observe a systematic decrease
with x. As will be shown in the following, this is a consequence of the fact that DFT+U does not take into account the
inter-site Hubbard interactions that are very important for materials with covalent bonding.

Method

DFT+U

DFT+U+V

x

0
1/2
1

0

1/2

1

HP

U

U

U

U

V

U

V

U

V

Fe1

5.01

5.14

4.97

5.43

Fe2

5.01

5.14

4.97

5.43

Mn1

6.23

4.57

4.32

6.27

Mn2

6.23

4.57

4.32

6.27

0.60-1.12

0.60-1.12

0.55-1.05

0.55-1.05

5.44

5.44

4.81

4.81

0.54-1.06

0.54-1.06

0.28-0.91

0.28-0.91

5.28

5.28

4.58

4.58

0.41-0.89

0.41-0.89

0.42-0.80

0.42-0.80

Table 1: Self-consistent Hubbard parameters (HP) in eV computed using DFPT in the DFT+U and DFT+U+V frameworks for Fe(3d) and Mn(3d)
states in LixMn1/2Fe1/2PO4 for x = 0, 1/2, and 1. This is the case study presented also in Ref. [48].

In the DFT+U+V case we take into account the inter-site Hubbard interactions hence we can see more clear trends in
Table 1. More speciﬁcally, when going from x = 0 to x = 1/2 the U value for Fe(3d) states stays essentially constant,
while the U value for Mn(3d) states decreases (by 1.46 eV). This clearly shows that the extra two electrons went to two
Mn atoms, while Fe atoms remain unaﬀected. When further going from x = 1/2 to x = 1 the U value for Fe(3d) states
decreased (by 0.16 eV), but also the U value for Mn(3d) states decreased (by 0.23 eV, which is much smaller than when
going from x = 0 to x = 1/2). This means that the extra two electrons now went mainly to Fe atoms. The relatively
small change in U for Mn(3d) states seems to indicate that these states are very active chemically and hence they are
very sensitive to changes in the chemical environment around them. In addition, it is important to remark that these are
self-consistent values of Hubbard parameters, i.e. a structural optimization is performed for each concentration of x [3].
This might explain in part while the U values for Mn(3d) states still change when going from x = 1/2 to x = 1. The
overall decrease in the U values for Fe and Mn can be explained by the fact that the 3d manifolds of TM ions acquire an
extra electron due to the insertion of Li; the more electrons there are in the Hubbard manifold, the weaker is the screened
Coulomb interaction between them, and hence the U value is smaller. Regarding the Hubbard V, in Table 1 we show the
13

range of obtained values for diﬀerent couples Fe(3d)-O(2p) and Mn(3d)-O(2p). The intersite Hubbard V also decreases
on average when going from x = 0 to x = 1. This latter observation is justiﬁed by the fact that the Li insertion leads to an
increase of the cell volume and of the Mn–O bond lengths; the larger the bond lengths between two atoms, the smaller is
the intersite Hubbard V interaction.

5.4. Accurate geometry and energetics from DFT+U+V

Using the self-consistent Hubbard parameters presented in Sec. 5.3, various ground-state properties of the phospho-
olivine LixMn1/2Fe1/2PO4 can be computed, such as lattice parameters, electronic structure, atomic occupations, magnetic
moments, Li intercalation voltages, and others. The reader is invited to check Ref. [48] where all these properties are
discussed in great detail for several phospho-olivines including LixMn1/2Fe1/2PO4. Here, for the sake of demonstration
purposes only, we highlight brieﬂy the accuracy of predictions of lattice parameters and Li intercalation voltages.

LP

a

b

c

V

DFT

10.30

6.02

4.70

DFT+U
10.41

DFT+U+V
10.40

6.05

4.72

6.05

4.72

Expt.

10.38

6.04

4.71

291.46

297.47

297.07

296.00

Table 2: The equilibrium lattice parameters (LP) a, b, and c (in Å) and the volume V (in Å3) of LiMn1/2Fe1/2PO4 computed using DFT, DFT+U, and
DFT+U+V with self-consistent U and V (see Table 1). The experimental data is from Ref. [93]. This is the case study presented also in Ref. [48].

To the best of our knowledge, the experimental lattice parameters and volume for LixMn1/2Fe1/2PO4 are available only
at x = 1 [93]. Hence in Table 2 we show the optimized lattice parameters and the experimental one at x = 1. It can
be seen that DFT underestimates the lattice parameters and the cell volume while both DFT+U and DFT+U+V slightly
overestimate them, with DFT+U+V marginally overcoming DFT+U in terms of accuracy. The eﬀect of V on the crystal
structure of this material is very small though. This trend is consistent with the one we found for LiMnPO4 in Ref. [3].
Hence, overall we ﬁnd that DFT+U+V gives the closest agreement with the experimental lattice parameters at x = 1. In
Ref. [48] the optimized lattice parameters are presented also for other values of x.

Figure 3: Voltages vs. Li/Li+ (in V) for LixMn1/2Fe1/2PO4 for 0 < x < 1/2 and 1/2 < x < 1 computed using DFT, DFT+U, and DFT+U+V with
self-consistent U and V determined from ﬁrst-principles (see Table 1). The experimental data is from Ref. [93]. This is the case study presented also in
Ref. [48].

The Li intercalation voltages for LixMn1/2Fe1/2PO4 are shown in Fig. 3. A detailed discussion on how these voltages
were computed can be found in Ref. [48]. Experimentally it is known that in Li-ion batteries with this material as a
cathode there are two plateaus, with 4.1 V for 0 < x < 1/2 and 3.5 V for 1/2 < x < 1 [93]. The former corresponds to the
average voltage of LixMnPO4, while the latter corresponds to the average voltage of LixFePO4. Indeed, when intercalating
Li and changing its concentration from x = 0 to x = 1/2, Mn ions are ﬁrst to react while Fe ions remain unchanged, hence
the voltage corresponds to the pristine material LixMnPO4. When further increasing the concentration of Li from x = 1/2
to x = 1, now Fe ions react while Mn remain unchanged and hence the voltage corresponds to the pristine material
LixFePO4. As can be seen, DFT largely underestimates the voltages, while DFT+U overestimates them. DFT+U+V
gives the best agreement with the experimental voltages, which means that applying the on-site U correction alone is not
14

3.034.424.044.12.533.993.733.50 < x < 1/2DFTDFT+UDFT+U+VExpt.1/2 < x < 1suﬃcient and it is important to include also the inter-site V correction to take properly into account the interactions of
3d electrons of TM ions with the 2p electrons of ligands. It is instructive to compare the accuracy of the DFT+U+V
voltages with the ones obtained when using HSE06. As reported in Ref. [48], the HSE06 voltages (computed using the
DFT+U+V optimized geometry) are 4.34 and 4.03 V for 0 < x < 1/2 and 1/2 < x < 1, respectively. Therefore, we ﬁnd
that DFT+U+V outperforms even HSE06 in terms of accuracy for predicting cathode voltages in this class of materials.
Thus, DFT+U+V provides the most accurate and reliable framework for predicting voltages in phospho-olivines [14, 48],
and currently we are investigating the predictive accuracy of this approach for other types of cathode materials.

6. Conclusions

We have presented the HP code that implements DFPT for the calculation of the Hubbard parameters. DFPT allows to
reduce signiﬁcantly the computational costs and to improve the numerical accuracy of the Hubbard parameters by recast-
ing the linear response to a localized perturbation into an array of monochromatic perturbations that can be calculated in
the primitive cell independently of one another. Moreover, the calculation of empty electronic states is avoided [52] which
greatly speeds up linear-response calculations of U and V. The HP code is one of the core components of the Quantum
ESPRESSO distribution. It has multiple levels of parallelization which allows eﬃcient usage of high-performance com-
puters. Moreover, due to the high level of automation, HP can be readily used for high-throughput calculations e.g. using
AiiDA [97, 98].

The eﬀectiveness of the code has been demonstrated by computing the Hubbard parameters self-consistently for the
phospho-olivine LixMn1/2Fe1/2PO4 at x = 0, 1/2, and 1. It has been shown that the Hubbard parameters change upon
changes of x which means that U and V should be recomputed at each Li concentration and not treated as global x-
independent parameters. The predicted crystal geometry and intercalation voltages are in very good agreement with the
experimental data, thus validating this statement.

In the same spirit as the Quantum ESPRESSO project, HP provides scientists worldwide with a well documented and
open-source framework for implementing their ideas. It is in our best hope that HP can beneﬁt from the already well estab-
lished users community of Quantum ESPRESSO for incorporating new ideas and keep growing in the future. The HP code
is hosted in a community accessible Git repository [77] and hence, apart from the releases of Quantum ESPRESSO [96],
researchers who are willing to test the latest experimental implementations are welcome to do so and to contribute with
their feedback. Finally, the HP code can be extended so as to employ various new features, in particular: (maximally-
localized) Wannier functions as the projectors of the Hubbard manifold [99]; calculation of Hubbard parameters on top
of meta-GGA functionals (e.g. SCAN [100]); extension to multi-channel and noncollinear spin-polarized frameworks;
ability to be run on novel GPU-enabled architectures, to name a few. These are some of the topics of future investigations
of the HP developers.

Acknowledgements

We thank Paolo Giannozzi and Pietro Delugas for fruitful discussions. This research was supported by the Swiss
National Science Foundation (SNSF), through grant 200021-179138, and its National Centre of Competence in Research
(NCCR) MARVEL. M.C. acknowledges partial support from the EU-H2020 research and innovation programme under
Grant Agreement No. 654360 within the framework of the NFFA Europe Transnational Access Activity. Computer time
was provided by CSCS (Piz Daint) through project No. s1073, and by the italian supercomputing center CINECA through
the ISCRA project “BatMat”.

Appendix A. Sample input ﬁles

Input sample 1: DFT+U calculation using pw.x

&control

calculation = ’scf’, prefix = ’olivine’, pseudo_dir = ’./’, outdir = ’./’

/
&system

ibrav = 8, celldm(1) = 19.667, celldm(2) = 0.582, celldm(3) = 0.454,
nat = 28, ntyp = 7, nspin = 2, ecutwfc = 65.0, ecutrho = 780.0,
occupations = ’smearing’, smearing = ’mv’, degauss = 0.01,
starting_magnetization(1) = 0.5, starting_magnetization(2) = -0.5,
starting_magnetization(3) = 0.5, starting_magnetization(4) = -0.5

/
&electrons

conv_thr = 1.0d-10, mixing_mode = ’local-TF’
15

li_pbesol_v1.4.uspp.F.UPF

15.999 O.pbesol-n-kjpaw_psl.0.1.UPF
30.974 P.pbesol-n-rrkjus_psl.1.0.0.UPF
6.94

/
ATOMIC_SPECIES
Fe1 55.845 Fe.pbesol-spn-kjpaw_psl.0.2.1.UPF
Fe2 55.845 Fe.pbesol-spn-kjpaw_psl.0.2.1.UPF
Mn1 54.938 mn_pbesol_v1.5.uspp.F.UPF
Mn2 54.938 mn_pbesol_v1.5.uspp.F.UPF
O
P
Li
ATOMIC_POSITIONS {crystal}
-0.0018269047
Fe1
-0.0624820605
Fe2
0.4987576776
Mn1
0.4369302234
Mn2
-0.1853704531
O
0.6251324004
O
0.1210624075
O
0.3105574643
O
0.1689278301
O
0.2595012636
O
-0.2332375356
O
0.6761898894
O
0.0510283716
O
0.0510181642
O
0.5580466406
O
0.5580572495
O
-0.1153361890
O
-0.1153274751
O
0.3776426890
O
0.3776336406
O
-0.1864198847
P
0.6287097290
P
0.1221109842
P
0.3069801138
P
-0.2786794632
Li
0.2143739303
Li
0.2144236723
Li
Li
-0.2787339024
HUBBARD {ortho-atomic}
U Fe1-3d 4.97
U Fe2-3d 4.97
U Mn1-3d 4.32
U Mn2-3d 4.32
K_POINTS {automatic}
3 4 5 0 0 0

0.0000304069
0.4999699836
-0.0000338875
0.5000334630
-0.0000413913
0.4999517783
0.5000390704
0.0000452467
0.0000409137
0.5000440788
0.4999600895
-0.0000458163
0.7040582036
0.2960368185
0.7033668148
0.2965326193
-0.2040586775
0.2039633923
-0.2033681130
0.2034650241
-0.0000468288
0.4999490507
0.5000464680
0.0000492520
-0.2501647928
-0.2498290476
0.2499658680
0.2500407728

-0.0003932705
-0.5003915084
-0.4510637530
-0.9510599331
-0.2311704957
-0.7112993667
-0.7311671887
-0.2113000948
-0.7606906152
-0.1851692958
-0.2606909453
-0.6851718584
-0.1900775054
-0.1900725354
-0.2511808171
-0.2511588987
-0.6900811178
-0.6900740032
-0.7511796423
-0.7511611819
-0.5566953613
-0.3861250841
-0.0566921886
-0.8861258770
-0.9729266705
-0.4729136212
-0.4729252455
-0.9729169404

Input sample 2: DFT+U+V calculation using pw.x

&control

calculation = ’scf’, prefix = ’olivine’, pseudo_dir = ’./’, outdir = ’./’

/
&system

ibrav = 8, celldm(1) = 19.656, celldm(2) = 0.581, celldm(3) = 0.454,
nat = 28, ntyp = 7, nspin = 2, ecutwfc = 65.0, ecutrho = 780.0,
occupations = ’smearing’, smearing = ’mv’, degauss = 0.01,
starting_magnetization(1) = 0.5, starting_magnetization(2) = -0.5,
starting_magnetization(3) = 0.5, starting_magnetization(4) = -0.5

/
&electrons

conv_thr = 1.0d-10, mixing_mode = ’local-TF’

16

/

-0.0011569560
-0.5011531240
-0.4508915833
-0.9508863966
-0.2309578341
-0.7114114581
-0.7309509354
-0.2114131965
-0.7607925096
-0.1849993707
-0.2607911995
-0.6850067566
-0.1897007541
-0.1896986710
-0.2513817004
-0.2513649470
-0.6897058406
-0.6897024045
-0.7513800607
-0.7513678647
-0.5562820718
-0.3864261649
-0.0562763621
-0.8864285367
-0.9729446405
-0.4729292757
-0.4729426850
-0.9729317161

li_pbesol_v1.4.uspp.F.UPF

15.999 O.pbesol-n-kjpaw_psl.0.1.UPF
30.974 P.pbesol-n-rrkjus_psl.1.0.0.UPF
6.94

0.0000344681
0.4999654781
-0.0000456327
0.5000453113
-0.0000457697
0.4999513745
0.5000433096
0.0000450767
0.0000428446
0.5000509149
0.4999581183
-0.0000526565
0.7043511556
0.2957600446
0.7036161924
0.2962483677
-0.2043524154
0.2042410671
-0.2036180333
0.2037488625
-0.0000548726
0.4999421817
0.5000536496
0.0000558091
-0.2501758028
-0.2498167962
0.2499681667
0.2500403462

ATOMIC_SPECIES
Fe1 55.845 Fe.pbesol-spn-kjpaw_psl.0.2.1.UPF
Fe2 55.845 Fe.pbesol-spn-kjpaw_psl.0.2.1.UPF
Mn1 54.938 mn_pbesol_v1.5.uspp.F.UPF
Mn2 54.938 mn_pbesol_v1.5.uspp.F.UPF
O
P
Li
ATOMIC_POSITIONS {crystal}
-0.0013002888
Fe1
-0.0630088651
Fe2
0.4991481712
Mn1
0.4365431830
Mn2
-0.1854167223
O
0.6251479692
O
0.1211085328
O
0.3105410503
O
0.1689536157
O
0.2594770427
O
-0.2332639027
O
0.6762141677
O
0.0509385486
O
0.0509246526
O
0.5579501365
O
0.5579633292
O
-0.1152470278
O
-0.1152343627
O
0.3777385470
O
0.3777272053
O
-0.1863309783
P
0.6286200092
P
0.1220224059
P
0.3070692847
P
-0.2786861788
Li
0.2143816342
Li
0.2144369823
Li
Li
-0.2787476689
HUBBARD {ortho-atomic}
U Fe1-3d 5.28
U Fe2-3d 5.28
U Mn1-3d 4.58
U Mn2-3d 4.58
V Fe1-3d O-2p 1 321
V Fe1-3d O-2p 1
14
V Fe1-3d O-2p 1 401
V Fe1-3d O-2p 1
5
V Fe1-3d O-2p 1 410
V Fe1-3d O-2p 1 409
V Fe2-3d O-2p 2 465
18
V Fe2-3d O-2p 2
11
V Fe2-3d O-2p 2
7
V Fe2-3d O-2p 2
14
V Fe2-3d O-2p 2
13
V Fe2-3d O-2p 2
V Mn1-3d O-2p 3
16
V Mn1-3d O-2p 3 323
12
V Mn1-3d O-2p 3
19
V Mn1-3d O-2p 3

0.89
0.89
0.78
0.55
0.42
0.42
0.89
0.89
0.78
0.55
0.42
0.42
0.80
0.80
0.76
0.43

17

20
V Mn1-3d O-2p 3
8
V Mn1-3d O-2p 3
V Mn2-3d O-2p 4
20
V Mn2-3d O-2p 4 467
V Mn2-3d O-2p 4 374
V Mn2-3d O-2p 4 379
V Mn2-3d O-2p 4 380
V Mn2-3d O-2p 4
6
K_POINTS {automatic}
3 4 5 0 0 0

0.43
0.51
0.80
0.80
0.76
0.43
0.43
0.51

Input sample 3: calculation of U (and V) using hp.x

&inputhp

prefix = ’olivine’, outdir=’./’,
nq1 = 1, nq2 = 2, nq3 = 3,
conv_thr_chi = 1.0d-7,
dist_thr = 5.D-3

/

Appendix B. Input Variables

Variable name

Default

Description

Basic keywords

prefix

’pwscf’

outdir

’./’

find atpert

1

Preﬁx which is prepended to input/output ﬁlenames; must be the
same used in the calculation of unperturbed system.

Path to the working directory containing temporary ﬁles (wave-
functions, spin charge density, occupation matrix, XML ﬁle with
the system’s data, etc., which are generated by a ground-state pw.x
run).

Method for searching of atoms which must be perturbed. Possible
values: 1 - ﬁnd how many inequivalent Hubbard atoms there are by
analyzing the trace of unperturbed occupation matrices, Tr[nIσ
];
2 - ﬁnd how many Hubbard atoms to perturb based on how many
diﬀerent Hubbard atomic types there are. Note: atoms which have
the same type but which are inequivalent by symmetry or which
have diﬀerent occupations will not be distinguished in this case; 3
- ﬁnd how many inequivalent Hubbard atoms there are using sym-

m1m2

metry. Atoms which have the same type but are not equivalent by
symmetry will be distinguished in this case; 4 - perturb all Hubbard
atoms (this is the most expensive option).

docc thr

5 × 10−5
(unitless)

Threshold for the comparison of the traces of unperturbed occu-
] of diﬀerent Hubbard atoms, which is
pation matrices Tr[nIσ
needed for the selection of atoms which must be perturbed. Can
be used only when find atpert = 1.

m1m2

nq1, nq2, nq3

1, 1, 1

skip equivalence q

.false.

Size of the q point grid. Each q point corresponds to a monochro-
matic perturbation of electronic occupations in the Hubbard mani-
fold of Hubbard atoms.

If .true. then hp.x will skip the equivalence analysis of q points,
and thus the full grid of q points will be used. Otherwise, the sym-
metry is used to determine equivalent q points (star of q), and then
perform calculations only for inequivalent q points.

dist thr

6 × 10−4
(Bohr)

Threshold for comparing inter-atomic distances when reconstruct-
ing the missing elements of the response susceptibility matrices in
the post-processing step.

Continuation on the next page...

18

Variable name

Default

Description

iverbosity

1

Verbosity level, i.e. the amount of information printed in the output
ﬁle of the hp.x run. Possible values: 1 - minimal output; 2 - as
1 plus symmetry matrices, ﬁnal response matrices χ0 and χ [see
Eq. (7)] and their inverse matrices χ−1
0 and χ−1, and the matrix of
Hubbard parameters (U on the diagonal, V on the oﬀ-diagonal); 3
- as 2 plus various details about the non-self-consistent calculation
at k and k + q points; 4 - as 3 plus response occupation matrices
∆s(cid:48)
q ¯ns σ

[see Eq. (13)].

m1m2
Keywords controlling the convergence

conv thr chi

10−5
(eV−1)

Convergence threshold for the self-consistent response matrix χ
[see Eq. (7)] during the iterative solution of the Sternheimer equa-
tions (15).

thresh init

10−14

ethr nscf

niter max

alpha mix(i)

10−11
(Ry)

100

0.3

Initial threshold for the solution of the Sternheimer equations (ﬁrst
iteration). Needed to converge the bare (non-interacting) response
matrix χ0 [see Eq. (7)]. The speciﬁed value will be multiplied by
the number of electrons in the system (i.e. it is an extensive quan-
tity).

Threshold for the convergence of KS eigenvalues during the iter-
ative diagonalization of the Hamiltonian in the non-self-consistent
calculation at k and k + q points. Note, this quantity is not exten-
sive.

Maximum number of iterations for the self-consistent iterative so-
lution of the Sternheimer equations (15).

Mixing parameter (for the i-th iteration, i runs from 1 to
niter max) for updating the response Hxc potential ∆s(cid:48)
ˆ¯VHxc,σ us-
q
ing the modiﬁed Broyden method [76].

nmix

Number of iterations used in the mixing of the response Hxc poten-
tial ∆s(cid:48)
q
Keywords for the parallelization of the calculations (optional)

ˆ¯VHxc,σ using the modiﬁed Broyden method [76].

4

perturb only atom(i)

.false.

start q

last q

1

Nq

sum pertq

.false.

If perturb only atom(i)=.true. then only the i-th atom (not
the atomic type) will be perturbed and considered in the run. This
variable is useful when one wants to parallelize the whole calcula-
tion over perturbed Hubbard atoms (see Sec. 4.2).

This keyword is used for the parallelization of the calculation
over q points [see Sec. 4.2)] for a ﬁxed perturbed atom (see
perturb only atom). start q speciﬁes the q point starting from
which the calculations will be performed; see also last q.

This keyword is used for the parallelization of the calculation
over q points [see Sec. 4.2)] for a ﬁxed perturbed atom (see
perturb only atom). last q speciﬁes the q point up to which
the calculations will be performed; see also start q.

m1m2

If it is set to .true. then hp.x will collect pieces of the re-
sponse occupation matrices ∆s(cid:48)
q ¯ns σ
[see Eq. (13)] for all q points
and compute the sum of them including the respective phase fac-
tors and using the normalization 1/Nq, according to Eq. (12).
This variable should be used only when start q, last q and
perturb only atom are used; otherwise, hp.x will automatically
compute the sum using Eq. (12).

Continuation on the next page...

19

Variable name

Default

Description

compute hp

.false.

This keyword is used to perform post-processing calculation of the
Hubbard parameters. If it is set to .true., hp.x will not perform
linear-response calculations; instead, it will assume that selected
columns of the χ0 and χ matrices were already computed in pre-
vious runs [each column corresponds to the response of occupa-
tions on all atoms to a perturbation of a speciﬁc Hubbard atom, see
Eq. (7)]. The hp.x code will look for the ﬁles prefix.chi.i.dat
(i runs over perturbed Hubbard atoms I) that must be stored in
outdir/HP/. This keyword must be set to .true. when the
calculation was parallelized over perturbations (or when the post-
processing step must be re-run). outdir and prefix are deﬁned
in Appendix A.

Table B.3: Input variables for the HP code (hp.x executable), that have to
be speciﬁed in the namelist inputhp. Here, only the most relevant input
parameters are discussed; the complete list of all possible variables can
be found in the documentation of the HP code, which can be found in the
folder /HP/Doc residing in the Quantum ESPRESSO tree.

References

[1] K. Yu, E. Carter, Communication: Comparing ab initio methods of obtaining eﬀective U parameters for closed-shell materials, J. Chem. Phys.

140 (2014) 121105.

[2] I. Timrov, N. Marzari, M. Cococcioni, Hubbard parameters from density-functional perturbation theory, Phys. Rev. B 98 (2018) 085127.
[3] I. Timrov, N. Marzari, M. Cococcioni, Self-consistent Hubbard parameters from density-functional perturbation theory in the ultrasoft and

projector-augmented wave formulations, Phys. Rev. B 103 (2021) 045141.

[4] P. Hohenberg, W. Kohn, Inhomogeneous electron gas, Phys. Rev. 136 (1964) B864.
[5] W. Kohn, L. Sham, Self-consistent equations including exchange and correlation eﬀects, Phys. Rev. 140 (1965) A1133.
[6] J. Perdew, A. Zunger, Self-interaction correction to density-functional approximations for many-electron systems, Phys. Rev. B 23 (1981) 5048.
[7] V. Anisimov, J. Zaanen, O. Andersen, Phys. Rev. B 44 (1991) 943.
[8] V. Anisimov, F. Aryasetiawan, A. Liechtenstein, J. Phys.: Condens. Matter 9 (1997) 767.
[9] S. Dudarev, G. Botton, S. Savrasov, C. Humphreys, A. Sutton, Electron-energy-loss spectra and the structural stability of nickel oxide: An

LSDA+U study, Phys. Rev. B 57 (3) (1998) 1505.

[10] M. Cococcioni, S. de Gironcoli, Phys. Rev. B 71 (2005) 035105.
[11] H. Kulik, M. Cococcioni, D. Scherlis, N. Marzari, Density Functional Theory in Transition-Metal Chemistry: A Self-Consistent Hubbard U

Approach, Phys. Rev. Lett. 97 (2006) 103001.

[12] H. Kulik, N. Marzari, A self-consistent Hubbard U density-functional theory approach to the addition-elimination reactions of hydrocarbons on

bare FeO+, J. Chem. Phys. 129 (2008) 134314.

[13] V.L. Campo Jr, M. Cococcioni, J. Phys.: Condens Matter 22 (2010) 055602.
[14] M. Cococcioni, N. Marzari, Phys. Rev. Materials 3 (2019) 033801.
[15] C. Ricca, I. Timrov, M. Cococcioni, N. Marzari, U. Aschauer, Self-consistent DFT+U+V study of oxygen vacancies in SrTiO3, Phys. Rev.

Research 2 (2020) 023313.

[16] N. Tancogne-Dejean, A. Rubio, Parameter-free hybridlike functional based on an extended Hubbard model: DFT+U+V, Phys. Rev. B 102 (2020)

155117.

[17] S.-H. Lee, Y.-W. Son, First-principles approach with a pseudohybrid density functional for extended Hubbard interactions, Phys. Rev. Research

2 (2020) 043410.

[18] I. Timrov, F. Aquilante, L. Binci, M. Cococcioni, N. Marzari, Pulay forces in density-functional theory with extended Hubbard functionals: from

nonorthogonalized to orthogonalized manifolds, Phys. Rev. B 102 (2020) 235159, ibid. 105, (2022) 199901.

[19] P. Dederichs, S. Bl¨ugel, R. Zeller, H. Akai, Phys. Rev. Lett. 53 (1984) 2512.
[20] A. McMahan, R. Martin, S. Satpathy, Phys. Rev. B 38 (1988) 6650.
[21] O. Gunnarsson, O. Andersen, O. Jepsen, J. Zaanen, Phys. Rev. B 39 (1989) 1708.
[22] M. Hybertsen, M. Schl¨uter, N. Christensen, Phys. Rev. B 39 (1989) 9028.
[23] O. Gunnarsson, Phys. Rev. B 41 (1990) 514.
[24] W. Pickett, S. Erwin, E. Ethridge, Phys. Rev. B 58 (1998) 1201.
[25] I. Solovyev, M. Imada, Phys. Rev. B 71 (2005) 045103.
[26] K. Nakamura, R. Arita, Y. Yoshimoto, S. Tsuneyuki, Phys. Rev. B 74 (2006) 235113.
[27] M. Shishkin, H. Sato, Phys. Rev. B 93 (2016) 085135.
[28] N. Mosey, E. Carter, Phys. Rev. B 76 (2007) 155123.
[29] N. Mosey, P. Liao, E. Carter, J. Chem. Phys. 129 (2008) 014103.
[30] A. Andriotis, R. Sheetz, M. Menon, Phys. Rev. B 81 (2010) 245103.
[31] L. Agapito, S. Curtarolo, M. Buongiorno Nardelli, Phys. Rev. X 5 (2015) 011006.
[32] M. Springer, F. Aryasetiawan, Phys. Rev. B 57 (1998) 4364.
[33] T. Kotani, J. Phys.: Condens. Matter 12 (2000) 2413.
[34] F. Aryasetiawan, M. Imada, A. Georges, G. Kotliar, S. Biermann, A. Lichtenstein, Phys. Rev. B 70 (2004) 195104.
[35] F. Aryasetiawan, K. Karlsson, O. Jepsen, U. Sc¨onberger, Phys. Rev. B 74 (2006) 125106.
[36] E. Sasioglu, C. Friedrich, S. Bl¨ugel, Phys. Rev. B 83 (2011) 121101(R).

20

[37] L. Vaugier, H. Jiang, S. Biermann, Phys. Rev. B 86 (2012) 165105.
[38] B. Amadon, T. Applencourt, F. Bruneval, Phys. Rev. B 89 (2014) 125110.
[39] H. Kulik, N. Marzari, Transition-metal dioxides: A case for the intersite term in Hubbard-model functionals, J. Chem. Phys. 134 (2011) 094103.
[40] B. Himmetoglu, A. Floris, S. de Gironcoli, M. Cococcioni, Int. J. Quant. Chem. 114 (2014) 14.
[41] C. Ricca, I. Timrov, M. Cococcioni, N. Marzari, U. Aschauer, Self-consistent site-dependent DFT+U study of stoichiometric and defective

SrMnO3, Phys. Rev. B 99 (2019) 094102.

[42] A. Floris, I. Timrov, B. Himmetoglu, N. Marzari, S. de Gironcoli, M. Cococcioni, Phys. Rev. B 101 (2020) 064305.
[43] I. Timrov, P. Agrawal, X. Zhang, S. Erat, R. Liu, A. Braun, M. Cococcioni, M. Calandra, N. Marzari, D. Passerone, Electronic structure of
Ni-substituted LaFeO3 from near edge x-ray absorption ﬁne structure experiments and ﬁrst-principles simulations, Phys. Rev. Research 2 (2020)
033265.

[44] N. Kirchner-Hall, W. Zhao, Y. Xiong, I. Timrov, I. Dabo, Extensive Benchmarking of DFT+U Calculations for Predicting Band Gaps, Appl. Sci.

11 (2021) 2395.

[45] Y. Xiong, Q. Campbell, J. Fanghanel, C. Badding, H. Wang, N. Kirchner-Hall, M. Theibault, I. Timrov, J. Mondschein, K. Seth, R. Katz,
A. Molina Villarino, B. Pamuk, M. Penrod, M. Khan, T. Rivera, N. Smith, X. Quintana, P. Orbe, C. Fennie, S. Asem-Hiablie, J. Young,
T. Deutsch, M. Cococcioni, V. Gopalan, H. Abru˜na, R. Schaak, I. Dabo, Optimizing accuracy and eﬃcacy in data-driven materials discovery for
the solar production of hydrogen, Energy Environ. Sci. 14 (2021) 2335.

[46] J.-J. Zhou, J. Park, I. Timrov, A. Floris, M. Cococcioni, N. Marzari, M. Bernardi, Ab Initio Electron-Phonon Interactions in Correlated Electron

Systems, Phys. Rev. Lett. 127 (2021) 126404.

[47] R. Mahajan, I. Timrov, N. Marzari, A. Kashyap, Importance of intersite Hubbard interactions in β-MnO2: A ﬁrst-principles DFT+U+V study,

Phys. Rev. Materials 5 (2021) 104402.

[48] I. Timrov, F. Aquilante, M. Cococcioni, N. Marzari, Accurate electronic properties and intercalation voltages of olivine-type Li-ion cathode

materials from extended Hubbard functionals, under review (2022); arXiv:2203.15732.

[49] R. Mahajan, A. Kashyap, I. Timrov, Pivotal role of intersite Hubbard interactions in Fe-doped α-MnO2, submitted (2022), arXiv:2205.05977.
[50] S. Baroni, P. Giannozzi, A. Testa, Green’s-function approach to linear response in solids, Phys. Rev. Lett. 58 (1987) 1861.
[51] P. Giannozzi, S. de Gironcoli, P. Pavone, S. Baroni, Phys. Rev. B 43 (1991) 7231.
[52] S. Baroni, S. de Gironcoli, A. D. Corso, P. Giannozzi, Phonons and related crystal properties from density-functional perturbation theory, Rev.

Mod. Phys. 73 (2) (2001) 515.

[53] N. Marzari, D. Vanderbilt, A. De Vita, M. Payne, Phys. Rev. Lett. 82 (1999) 3296.
[54] H. Hsu, K. Umemoto, M. Cococcioni, R. Wentzcovitch, First-principles study for low-spin LaCoO3 with a structurally consistent Hubbard U,

Phys. Rev. B 79 (2009) 125124.

[55] The GNU General Public License: http://www.gnu.org/licenses/gpl.html.
[56] P. Giannozzi, S. Baroni, N. Bonini, M. Calandra, R. Car, C. Cavazzoni, D. Ceresoli, G. Chiarotti, M. Cococcioni, I. Dabo, A. Dal Corso,
S. De Gironcoli, S. Fabris, G. Fratesi, R. Gebauer, U. Gerstmann, C. Gougoussis, A. Kokalj, M. Lazzeri, L. Martin-Samos, N. Marzari, F. Mauri,
R. Mazzarello, S. Paolini, A. Pasquarello, L. Paulatto, C. Sbraccia, S. Scandolo, G. Sclauzero, A. Seitsonen, A. Smogunov, P. Umari, R. Wentz-
covitch, Quantum ESPRESSO: A modular and open-source software project for quantum simulations of materials, J. Phys.: Condens. Matter 21
(2009) 395502.

[57] P. Giannozzi, O. Andreussi, T. Brumme, O. Bunau, M. Buongiorno Nardelli, M. Calandra, R. Car, C. Cavazzoni, D. Ceresoli, M. Cococcioni,
N. Colonna, I. Carnimeo, A. Dal Corso, S. de Gironcoli, P. Delugas, R. A. DiStasio Jr., A. Ferretti, A. Floris, G. Fratesi, G. Fugallo, R. Gebauer,
U. Gerstmann, F. Giustino, T. Gorni, J. Jia, M. Kawamura, H.-Y. Ko, A. Kokalj, E. K¨uc¸ ¨ukbenli, M. Lazzeri, M. Marsili, N. Marzari, F. Mauri, N. L.
Nguyen, H.-V. Nguyen, A. Otero-de-la Rosa, L. Paulatto, S. Ponc´e, D. Rocca, R. Sabatini, B. Santra, M. Schlipf, A. Seitsonen, A. Smogunov,
I. Timrov, T. Thonhauser, P. Umari, N. Vast, S. Baroni, Advanced capabilities for materials modelling with Quantum ESPRESSO, J. Phys.:
Condens. Matter 29 (2017) 465901.

[58] P. Giannozzi, O. Baseggio, P. Bonf`a, D. Brunato, R. Car, I. Carnimeo, C. Cavazzoni, S. de Gironcoli, P. Delugas, F. Ferrari Ruﬃno, A. Ferretti,

N. Marzari, I. Timrov, A. Urru, S. Baroni, Quantum ESPRESSO toward the exascale, J. Chem. Phys. 152 (2020) 154105.

[59] Note that all indices in Eq. (5) are correct, while in Ref. [13] in the last term of Eq. (13) there must be nI Jσ

mm(cid:48) instead of nJIσ

m(cid:48)m (in the actual

implementation in Ref. [13] nI Jσ

mm(cid:48) was used).

[60] M. Yu, S. Yang, C. Wu, N. Marom, npj Comput. Mater. 6 (2020) 180.
[61] C. Tablero, Representations of the occupation number matrix on the LDA/GGA+U method, J. Phys.: Condens. Matter 20 (2008) 325205.
[62] Y.-C. Wang, Z.-H. Chen, H. Jiang, The local projection in the density functional theory plus U approach: A critical assessment, J. Chem. Phys.

144 (2016) 144106.

[63] B. Amadon, F. Jollet, M. Torrent, γ and β cerium: LDA+ U calculations of ground-state parameters, Phys. Rev. B 77 (2008) 155104.
[64] D. O’Regan, N. Hine, M. Payne, A. Mostoﬁ, Projector self-consistent DFT+U using nonorthogonal generalized Wannier functions, Phys. Rev.

B 82 (2010) 081102(R).

[65] D. Korotin, V. Kukolev, A. Kozhevnikov, D. Novoselov, V. Anisimov, Electronic correlations and crystal structure distortions in BaBiO3, J. Phys.:

Condens. Matter 24 (2012) 415603.

[66] Shick, A.B. and Liechtenstein, A.I. and Pickett, W.E., Implementation of the LDA+U method using the full-potential linearized augmented

plane-wave basis, Phys. Rev. B 60 (1999) 10763.

[67] O. Bengone, M. Alouani, P. Bl¨ochl, J. Hugel, Phys. Rev. B 62 (2000) 16392.
[68] A. Rohrbach, J. Hafner, G. Kresse, J. Phys.: Condens. Matter 15 (2003) 979.
[69] P.-O. L¨owdin, J. Chem. Phys. 18 (1950) 365.
[70] I. Mayer, Int. J. Quant. Chem. 90 (2002) 63.
[71] It is important to note that the response of the non-diagonal (with respect to the atomic sites) components of the occupation matrix in Eq. (3) is

not needed, because these terms are not present in the deﬁnition of the response matrices (χ0)I J and (χ)I J (see Eq. (7)).
[72] A. Dal Corso, Density-functional perturbation theory with ultrasoft pseudopotentials, Phys. Rev. B 64 (2001) 235118.
[73] D. Vanderbilt, Soft self-consistent pseudopotentials in a generalized eigenvalue formalism, Phys. Rev. B 41 (1990) 7892.
[74] P. Bl¨ochl, Phys. Rev. B 50 (1994) 17953.
[75] S. de Gironcoli, Lattice dynamics of metals from density-functional perturbation theory, Phys. Rev. B 51 (1995) 6773.
[76] D. Johnson, Phys. Rev. B 38 (1988) 12807.
[77] The latest development version of the Quantum ESPRESSO distribution can be downloaded from https://gitlab.com/QEF/q-e.
[78] GNU Autoconf: https://www.gnu.org/software/autoconf.
[79] CMake is an open-source, cross-platform family of tools designed to build, test and package software: https://cmake.org.
[80] The Quantum ESPRESSO users forum: https://www.quantum-espresso.org/forum.
[81] R. Kobayashi, T. Goumans, N. Carstensen, T. Soini, N. Marzari, I. Timrov, S. Ponc´e, E. Linscott, C. Sewell, G. Pizzi, F. Ramirez, M. Bercx,
S. Huber, C. Adorf, L. Talirz, Virtual Computational Chemistry Teaching Laboratories - Hands-On at a Distance, J. Chem. Educ. 98 (2021) 3163.

21

[82] The Quantum Mobile virtual machine: https://quantum-mobile.readthedocs.io/en/latest.
[83] Message passing interface forum, Int. J. Supercomput. Appl. 8 (1994) 159.
[84] J. Spencer, Testcode testcode.py, https://github.com/jsspencer/testcode.
[85] J. Perdew, A. Ruzsinszky, G. Csonka, O. Vydrov, G. Scuseria, L. Constantin, X. Zhou, K. Burke, Phys. Rev. Lett. 100 (2008) 136406.
[86] G. Prandini, A. Marrazzo, I. E. Castelli, N. Mounet, N. Marzari, Precision and eﬃciency in solid-state pseudopotential calculations, npj Compu-

tational Materials 4 (1) (2018) 1–13.

[87] The SSSP library of the Materials Cloud: https://www.materialscloud.org/discover/sssp/table/efficiency.
[88] K. Garrity, J. Bennett, K. Rabe, D. Vanderbilt, Comput. Mater. Sci. 81 (2014) 446.
[89] E. Kucukbenli, M. Monni, B. Adetunji, X. Ge, G. Adebayo, N. Marzari, S. de Gironcoli, A. Dal Corso, Projector augmented-wave and all-electron

calculations across the periodic table: a comparison of structural and energetic properties, arXiv:1404.3015 (2014).

[90] A. Dal Corso, Pseudopotentials periodic table: From h to pu, Comput. Mater. Sci. 95 (2014) 337.
[91] R. Fletcher, Practical Methods of Optimization, 2nd Edition, Wiley, Chichester, 1987.
[92] M. Payne, M. Teter, D. Allen, T. Arias, J. Joannopoulos, Rev. Mod. Phys. 64 (1992) 1045.
[93] T. Muraliganth, A. Manthiram, Understanding the Shifts in the Redox Potentials of Olivines LiM1−yMyPO4 (M = Fe, Mn, Co, and Mg) Solid

Solution Cathodes, J. Phys. Chem. C 114 (2010) 15530.

[94] K. Momma, F. Izumi, VESTA: a three-dimensional visualization system for electronic and structural analysis, J. Appl. Crystallogr. 41 (2008)

653.

[95] I. Timrov, N. Marzari, M. Cococcioni, HP – A code for the calculation of Hubbard parameters using density-functional perturbation theory,

Materials Cloud Archive 2022.77 (2022), doi: 10.24435/materialscloud:v6-zd. doi:10.24435/materialscloud:v6-zd.
[96] The oﬃcial release of the Quantum ESPRESSO distribution can be downloaded from https://www.quantum-espresso.org.
[97] G. Pizzi, A. Cepelotti, R. Sabatini, N. Marzari, B. Kozinsky, Comp. Mat. Sci. 111 (2016) 218.
[98] S. Huber, S. Zoupanos, M. Uhrin, L. Talirz, L. Kahle, R. H¨auselmann, D. Gresch, T. M¨uller, A. Yakutovich, C. Andersen, F. Ramirez, C. Adorf,
F. Gargiulo, S. Kumbhar, E. Passaro, C. Johnston, A. Merkys, A. Cepellotti, N. Mounet, N. Marzari, B. Kozinsky, G. Pizzi, AiiDA 1.0, a scalable
computational infrastructure for automated reproducible workﬂows and data provenance, Scientiﬁc Data 7 (2020) 300.

[99] N. Marzari, A. Mostoﬁ, J. Yates, I. Souza, D. Vanderbilt, Rev. Mod. Phys. 84 (2012) 1419.
[100] J. Sun, A. Ruzsinszky, J. Perdew, Phys. Rev. Lett. 115 (2015) 036402.

22

