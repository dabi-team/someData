Prepared for submission to JINST

Kinematic and vertex ﬁtting package for the CMD-3
experiment

𝑎,𝑏

𝑎,𝑏

A.S. Popov

S.S. Gribanov,
𝑎Budker Institute of Nuclear Physics, SB RAS,
Prospekt Akademika Lavrent’yeva, 11, Novosibirsk, 630090 Russia
𝑏Novosibirsk State University, Physics Department,
Pirogova, 2, Novosibirsk, 630090 Russia

E-mail: S.S.Gribanov@inp.nsk.su, aspopov1@inp.nsk.su

Abstract: In this article, we discuss a new software package of kinematic and vertex ﬁtting for the
CMD-3 experiment at the VEPP-2000 electron-positron collider. The authors describe in detail the
ﬁtting algorithm, parametrization of four-momenta and trajectories of various particles, and also
present the results of testing the ﬁtting pakage using events of Monte Carlo simulation of various
𝑒+𝑒− annihilation processes. Although the package discussed in this article is intended for the
CMD-3 experiment, it can also be used in other experiments. The authors consider the described
package as their ﬁrst step towards a more universal and rigrous kinematic and vertex ﬁtting package
that can be used in future 𝑒+𝑒− experiments, such as the Super Charm-Tau factory.

2
2
0
2

p
e
S
9
2

]
x
e
-
p
e
h
[

2
v
9
6
5
1
1
.
8
0
2
2
:
v
i
X
r
a

 
 
 
 
 
 
Contents

1

Introduction

2 Minimization algorithm

3 Hypotheses

4 Chi-square distribution
4.1 Gaussian simulation
4.2 Linear constraints
4.2.1 Case 𝑙 = 0
4.2.2 Case 𝑙 ≠ 0
4.3 Nonlinear constraints
4.4 Chi-square in the case of Monte Carlo simulation and experimental data

5 Vertices

6 Particles
Initial pseudo-particle
6.1
6.2 Charged particles and photons
6.2.1 Charged particle
Photon
6.2.2
Intermediate particles
6.3.1
6.3.2

6.3

Intermediate neutral particle
Intermediate charged particle

6.4 Lost particles

6.4.1 Massive particle
6.4.2 Massless particle

7 Constraints

7.1 Energy-momentum conservation constraints
7.2 Mass constraint
7.3 Vertex constraints

8 Examples

8.1 Hypotheses 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋−

8.1.1 Description of the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋− hypotheses
8.1.2
8.1.3
8.1.4

Fitting procedure details
Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events
Fitting the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events
8.2 Hypotheses 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋−

8.2.1 Description of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ hypotheses

– i –

2

3

6

7
7
8
10
11
12
12

13

14
14
15
15
16
17
17
18
19
20
20

20
21
23
24

25
25
25
26
27
34
37
37

8.2.2

8.2.3

Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events
Fitting the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events

8.3 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−

8.3.1 Description of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− hypothesis
8.3.2

Fitting procedure details
Fitting the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events
Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events

8.3.3

8.3.4

8.4 Hypothesis 𝑒+𝑒− → 𝛾𝛾𝛾

8.4.1 Description of the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis
8.4.2

Fitting the 𝑒+𝑒− → 𝜋0𝛾 events

8.5 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾

8.5.1 Description of the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis
8.5.2

Fitting the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 events

8.6 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾lost
8.7 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0

lost

8.7.1 Description of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0
8.7.2

Fitting procedure details
Fitting the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0 events

8.7.3

lost hypothesis

8.8 Hypothesis 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0

lost

8.8.1 Description of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0
8.8.2

Fitting procedure details
Fitting the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0 events

8.8.3

lost hypothesis

8.9 Hypothesis 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋−

8.9.1 Description of the 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis
8.9.2

Fitting procedure details
Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾𝑆 𝜋+𝜋−, 𝐾𝑆 → 𝜋+𝜋− events

8.9.3

9 Examples of Gaussian simulation
9.1 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾
9.2 Hypotheses 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋−

10 Fitting package

11 Summary

12 Acknowledgments

– 1 –

38

39

40

40

41

41

42

43

43

43

47

47

47

48

50

50

50

50

52

52

52

52

54

54

54

55

57

57

59

64

64

65

1

Introduction

Kinematic and vertex ﬁtting is widely used data analysis technique in particle physics experi-
ments [1–9]. This technique can be used in order to separate events corresponding to diﬀerent
kinematic hypotheses and to restore interaction and decay vertices.
In addition, the use of this
technique often leads to signiﬁcant improvements in resolution of some quantities, such as various
invariant masses. This paper describes kinematic and vertex ﬁtting package developed for the
CMD-3 experiment [10, 11] located at the VEPP-2000 electron-positron collider [12, 13]. The
discussed package is currently actively used in the study of a number of processes with the CMD-3
detector. This package can also be used in other similar experiments. To do this, it is necessary to
make a number of experiment-dependent changes related to the format of input data and probably
to some particle parametrizations. The authors believe that it is quite easy to do, since the discussed
package is divided into detector-dependent and detector-independent parts.

In general, any kinematic and vertex ﬁtting algorithm consists in constrained minimization of

the chi-square function:

𝜒2(𝒙) = 𝚫𝒙(cid:124) ˆ𝐶−1𝚫𝒙,

𝚫𝒙 = 𝒙 − ˜𝒙

(1.1)

where 𝒙 ∈ R𝑛 is the vector of the optimization variables corresponding to measurable parameters,
i.e. such parameters that can be measured in an experiment. The natural number 𝑛 is the number
of such parameters, the vector ˜𝒙 is the vector of these parameters, measured in a single event.
The matrix ˆ𝐶 is the corresponding covariance matrix, obtained in the same event. The parameters
measured by a detector are usually refer to one particle or another. Moreover, usually the parameters
corresponding to diﬀerent particles are measured independently. With these assumptions in mind,
the chi-square from equation (1.1) can be written as

𝑁𝑝
∑︁

𝜒2(𝒙) =

𝚫𝒙 (𝒊) (cid:124) ˆ𝐶 (𝑖) −1

𝚫𝒙 (𝒊) ,

𝑖=1
𝚫𝒙 (𝒊) = 𝒙 (𝒊) − ˜𝒙 (𝒊) ,

𝒙 = 𝒙 (1) ⊕ 𝒙 (2) ⊕ . . . ⊕ 𝒙 (𝑵𝒑) ,
˜𝒙 = ˜𝒙 (1) ⊕ ˜𝒙 (2) ⊕ . . . ⊕ ˜𝒙 (𝑵𝒑) ,
ˆ𝐶 = ˆ𝐶 (1) ⊕ ˆ𝐶 (2) ⊕ . . . ⊕ ˆ𝐶 ( 𝑁𝑝) ,

(1.2)

where 𝑖 is the particle index, 𝑁 𝑝 is the number of particles in a hypothesis, 𝒙 (𝒊) is the vector of the
optimization variables corresponding to measurable parameters of the 𝑖-th particle. The vector ˜𝒙 (𝒊)
ˆ𝐶 (𝑖) is the corresponding covariance
is the vector of these parameters, measured in a single event.
matrix. The notation 𝒙 (𝒊) ⊕ 𝒙 (𝒋) means the concatenation of the vectors 𝒙 (𝒊) and 𝒙 (𝒋) , while the
notation ˆ𝐶 (𝑖) ⊕ ˆ𝐶 ( 𝑗) means the direct sum of the matrices ˆ𝐶 (𝑖) and ˆ𝐶 ( 𝑗) .

In the case of kinematic and vertex ﬁtting, equality constraints are commonly used. These

constraints have the following form:

𝑓𝑘 ( 𝒚) = 0, 𝑘 = 1, 2, . . . , 𝑚,

𝒚 = 𝒙 ⊕ 𝒂,

(1.3)

– 2 –

where 𝑘 is the constraint index, 𝑓𝑘 is the 𝑘-th constraint function, 𝑚 is the number of constraints
in a hypothesis, 𝒂 ∈ R𝑙 is the vector of non-measurable optimization parameters, 𝑙 is the number
of these parameters. In this article we mean, that non-measurable parameters are those parameters
that cannot be measured experimentally, but can be obtained as result of ﬁtting. There is a
number of such parameters: momentum components of a lost particle, time parameter of a charged
particle trajectory (track), vertex coordinates, and some other parameters. Some examples of
non-measurable parameters are given in sections 5 and 6.

Taking into account the chi-square function (1.1) or (1.2) and the equality constraints (1.3),
one can formulate the following problem for ﬁnding the conditional extremum of the chi-square
function:

(cid:40)𝜒2(𝒙) → extremum,
𝑓𝑘 ( 𝒚) = 0, 𝑘 = 1, 2, . . . , 𝑚.

(1.4)

It is important to note that the initial values of the measurable parameters 𝒙 should be set equal to
their measured values ˜𝒙. In this case, the minimization algorithm starts from the lowest point of
the chi-square hyperparabaloid, which increases the probability that the ﬁt will converge to a global
minimum. The criterion that the found extremum is a local minimum and not a local maximum is
discussed in section 2.

2 Minimization algorithm

In this work the well-known method of Lagrange multipliers [14–16] is used in order to reduce the
problem of constrained optimization to the unconstrained one. The method of Lagrange multipliers
is based on the concept of the Lagrange function. In the context of the problem (1.4) this function
has the following form:

L (𝒚, 𝝀) = 𝜒2(𝒙) +

𝑚
∑︁

𝑘=1

𝜆𝑘 𝑓𝑘 (𝒚), 𝝀 =

,

𝜆1


𝜆2


...




𝜆𝑚














(2.1)

where variables 𝜆1, 𝜆2, . . . , 𝜆𝑚 are the Lagrange multipliers. Taking into the account the Lagrange
function, the necessary condition for the existence of an extremum in the problem (1.4) can be
formulated using the following theorem [14].

Theorem 2.1 (necessary condition). If 𝒚(cid:48) ∈ Ω ≡ {𝒚 ∈ R𝑛+𝑙 | 𝑓𝑘 (𝒚) = 0, 𝑘 = 1, 2, . . . , 𝑚} is a
conditional extremum point of the problem (1.4), then there is a nonzero vector 𝝀(cid:48) ∈ R𝑚 such that

∇𝒚 L ( 𝒚, 𝝀(cid:48))|𝒚=𝒚(cid:48) = 0.

(2.2)

In order to determine whether the found extremum is a local minimum or a local maximum, it

is necessary to formulate a suﬃcient conditions for an extremum [14].

– 3 –

Theorem 2.2 (suﬃcient conditions). Let 𝒚(cid:48) ∈ Ω and there is a vector 𝝀(cid:48), such that ∇𝒚 L ( 𝒚, 𝝀(cid:48))|𝒚=𝒚(cid:48) =
0. If for any vector 𝒅𝒚 ∈ R𝑛+𝑙, 𝒅𝒚 ≠ 0 that satisﬁes the conditions ∇𝒚 𝑓𝑘 ( 𝒚)|𝒚=𝒚(cid:48) · 𝒅𝒚 = 0, 𝑘 =
1, 2, . . . , 𝑚, the following inequality holds

𝑛+𝑙
∑︁

𝑛+𝑙
∑︁

𝑖=1

𝑗=1

𝜕2L (𝒚, 𝝀(cid:48))
𝜕𝑦𝑖𝜕𝑦 𝑗

(cid:12)
(cid:12)
(cid:12)𝒚=𝒚(cid:48)

𝑑𝑦𝑖 𝑑𝑦 𝑗 > 0,

(2.3)

then the strict local minimum of the function 𝜒2 on the set Ω is reached at the point 𝒚 = 𝒚(cid:48). If the
following inequality holds

𝑛+𝑙
∑︁

𝑛+𝑙
∑︁

𝑖=1

𝑗=1

𝜕2L (𝒚, 𝝀(cid:48))
𝜕𝑦𝑖𝜕𝑦 𝑗

(cid:12)
(cid:12)
(cid:12)𝒚=𝒚(cid:48)

𝑑𝑦𝑖 𝑑𝑦 𝑗 < 0,

(2.4)

then the strict local maximum is reached at the point 𝒚 = 𝒚(cid:48).

Thus, in order to ﬁnd the conditional minimum of the 𝜒2 function (1.2), one should follow the
algorithm below. First of all, we need to compose the Lagrange function according equation (2.1).
Then we need to use the necessary condition for the existence of an extremum (theorem 2.1), i.e.
solve the following system of equations:

(cid:40)∇𝒚 L ( 𝒚, 𝝀) = 0,
𝑓𝑘 ( 𝒚) = 0, 𝑘 = 1, 2, . . . , 𝑚.

(2.5)

Let us note that the system of equations (2.5) can be rewritten in a form that is more convenient for
the further use:

∇𝒒L (𝒚, 𝝀) = 0,

𝒒 = 𝒚 ⊕ 𝝀,

(2.6)

where 𝒒 is the vector of all parameters involved in the constrained chi-square minimization, including
the Lagrange multipliers. Suppose that as a result of solving the system of equations (2.6), a pair
of vectors is obtained: 𝒚 = 𝒚(cid:48) and 𝝀 = 𝝀(cid:48). This pair of vectors corresponds to a conditional
local extremum of the chi-square function. Finally, it is necessary to check whether this pair of
vectors corresponds to a local minimum or to a local maximum point. To do this, we can use
inequalities (2.3) and (2.4).

To solve the system of equations (2.6), the package discussed in this paper uses the well-known

Newton’s method [17–19]. This method is based on the following iterative approach:

𝒒𝑠 = 𝒒𝑠−1 − ˆH −1(𝒒𝑠−1)∇𝒒L ( 𝒚𝑠−1, 𝝀𝑠−1), 𝑠 = 1, 2, . . . ,

(2.7)

where 𝒒𝑠 = 𝒙𝑠 ⊕ 𝒂𝑠 ⊕ 𝝀𝑠 is the vector of optimization parameters at the 𝑠-th step of the iterative
ˆH (𝒒𝑠−1) is the Hessian of the
procedure, 𝒒0 = 𝒙0 ⊕ 𝒂0 ⊕ 𝝀0 is the vector of their initial values,
Lagrange function with respect to the variables 𝒒, and ∇𝒒L (𝒚𝑠−1, 𝝀𝑠−1) is its gradient calculated
at the point 𝒒𝑠−1. The vector 𝒚𝑠−1 is the concatenation of the vectors of measurable 𝒙𝑠−1 and non-
measurable 𝒂𝑠−1 parameters at the (𝑠 − 1)-th step of the optimization algorithm: 𝒚𝑠−1 = 𝒙𝑠−1 ⊕ 𝒂𝑠−1.
The initial values 𝒙0 of the measurable parameters 𝒙 are set equal to their measured values ˜𝒙. The

– 4 –

initial values 𝝀0 of the Lagrange multipliers are set to zero. The initial values 𝒂0 of the non-
measurable parameters can optionally be set to custom values.

It is easy to see that the Hessian ˆH (𝒒𝑠−1) of the Lagrange function has the following form:

ˆH (𝒒𝑠−1) =

(cid:34)

2 ˆ𝑀 + ˆ𝑄𝑠−1
ˆ𝐽 (cid:124)
𝑠−1

ˆ𝐽𝑠−1
0𝑚×𝑚

(cid:35)

,

ˆ𝑀 = ˆ𝐶−1 ⊕ 0𝑙×𝑙,

(2.8)

where 0𝑚×𝑚 and 0𝑙×𝑙 are 𝑚 by 𝑚 and 𝑙 by 𝑙 zero matrices, respectively; ˆ𝑄𝑠−1 is the matrix containing
the Hessians of the constraint functions with respect to the 𝒚 variables. Let us denote the Hessian
of the 𝑘-th constraint function calculated at the point 𝒚𝑠−1 as ˆ𝑄 (𝑘)
𝑠−1. In these notations, the matrix
ˆ𝑄𝑠−1 has the following form:

ˆ𝑄𝑠−1 =

𝜆𝑘,𝑠−1 ˆ𝑄 (𝑘)
𝑠−1

,

(2.9)

𝑚
∑︁

𝑘=1

where 𝜆𝑘,𝑠−1 is the value of the 𝑘-th Lagrange multiplier at the (𝑠 − 1)-th step of the iterative
𝜕( 𝑓1,..., 𝑓𝑚)
procedure given by equation (2.7). The matrix ˆ𝐽𝑠−1 in equation (2.8) is the Jacobian
𝜕( 𝑦1,...,𝑦(𝑛+𝑙) )
of the constraint functions with respect to the variables 𝒚. This Jacobian is also calculated at the
point 𝒚𝑠−1.

It should be noted that constraints (1.3) do not explicitly depend on the parameters of particles
and vertices. The constraint functions usually explicitly depend only on parametrizations of the
particle four-momenta and trajectories (see section 6), as well as the vertex parametrization (see
section 5). In this case, it is convenient to use the chain rule to obtain partial derivatives of the
constraints:

𝜕 𝑓𝑘 (𝑔1(𝒚), . . . , 𝑔𝑁𝑔 (𝒚))
𝜕𝑦𝑖

=

𝜕 𝑓𝑘
𝜕𝑔 𝑗

𝜕𝑔 𝑗
𝜕𝑦𝑖

,

(2.10)

where 𝑔 𝑗 is a function of some parametrization, 𝑁𝑔 is the number of such functions, the repeated
index 𝑗 is summed up. Using a chain rule in the ﬁtting package makes it possible to implement
constraint, particle, and vertex classes independently. Thus, for example, adding a new particle
class to the package will not change the implementation of the constraints, and vice versa.

In the case of the package discussed in this paper, the procedure given by equation (2.7)

continues until one of the following conditions is met:

1.

| 𝜒2(𝒙𝑠) − 𝜒2(𝒙𝑠−1)| < 𝜀 and 𝛿( 𝒚𝑠) < 𝜀, where 𝛿( 𝒚𝑠) =
some tolerance;

𝑚
(cid:205)
𝑘=1

| 𝑓𝑘 ( 𝒚𝑠)| is the residual and 𝜀 is

2. 𝑠 > 𝑁iter, where 𝑠 is the step number of the iterative procedure given by equation (2.7) and

𝑁iter is the maximum number of iterations.

If the ﬁrst condition (1) is met, then the ﬁt has converged to a local extremum.
If the second
condition (2) is met, then the ﬁt has not converged. The default tolerance 𝜀 and maximum number
of iterations 𝑁iter used in the ﬁtting package are equal to 10−4 and 20, respectively. These values can
be easily adjusted if desired. Although the default value for the maximum number of iterations is
equal to 20, it should be noted that the optimization algorithm usually converges in fewer iterations.
For example, in the case of ﬁtting the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− process under

– 5 –

the corresponding signal hypothesis (see sections 3 and 8.2.2), the optimization algorithm most
often converges in three iterations. At the same time, in about 93% of all events, the algorithm
In the case of ﬁtting the events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾
converges in 2–6 iterations.
process (see section 8.5.2), the algorithm most often converges in two iterations. In about 98% of
the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 events, the algorithm converges in 2–4 iterations.

It should be noted that in the implementation of the optimization algorithm, special attention
is paid to periodic measurable parameters. If, during optimization, such a parameter goes beyond
the period boundaries, then the corresponding contribution to the chi-square becomes incorrect
because the measured value of this parameter is within the period. Therefore, after each iteration,
if the parameter goes beyond the period boundaries, then it is returned back using a shift by an
integer number of periods. Since it is assumed that it does not matter for the constraint functions
whether the parameter is inside the period or not, the parameter values before and after the shift are
equivalent.

Another important feature of the ﬁtting package is the ability to use upper and lower limits
for parameters. In the current version of the package, if the parameter is out of range, it returns to
its initial value, after which the optimization algorithm continues. Thus, the values of individual
parameters can be limited. However, it may well be necessary to limit the values of some function,
i.e. use inequality constraints [17, 20, 21]. This feature is planned to be added during the further
development of the ﬁtting package.

The ﬁtting package provides an interface for ﬁxing and releasing parameters. Fixing a parameter
means that this parameter does not change during the execution of the optimization algorithm. This
can be achieved in the following way.
In the Hessian (2.8), all oﬀ-diagonal elements of rows
and columns corresponding to a ﬁxed parameter are set to zero. At the same time, the diagonal
element of the Hessian corresponding to this parameter must be set equal to one. The component
of the Lagrange function gradient corresponding to a ﬁxed parameter must be set to zero (see
equation (2.7)). It is this approach to ﬁxing parameters that is used in the considered ﬁtting package.
However, it should be noted that this approach is not unique. For instance, ﬁxed parameters can
be excluded programmatically, i.e. one can consider the Hessian with respect to free parameters
only. Both approaches are equivalent, but the latter approach makes it possible to reduce the size
of the Hessian matrix. With the further development of the ﬁttings package, it is planned to switch
to using this mechanism for ﬁxing parameters.

The ﬁtting package also provides an interface for enabling and disabling constraints. This
feature is coming very useful when it is necessary to perform a ﬁt in several hypotheses (see
section 3) that diﬀer from each other only in the set of constraints.

3 Hypotheses

Further, in this work the term hypothesis is often used. By hypothesis we mean a set of all particles,
vertices and constraints involved in the constrained chi-square minimization. The hypothesis also
depends on the state of particles and vertices, since some parameters of these entities can be ﬁxed.
The ﬁtting package discussed in this paper has special classes responsible for describing these
hypotheses. Further, for simplicity, we name the hypotheses according to the particles they contain,
for example, as 𝑒+𝑒− → 𝛾𝛾𝛾. One has to distinguish a hypothesis from a process, since the same

– 6 –

notation is used for both of them. The text of the paper always notes whether the reader is dealing
with the notation of a hypothesis or a process.

The paper also often uses the terms signal and background hypothesis. A hypothesis is called
a signal hypothesis for some process if it describes this process. Otherwise, the hypothesis is
a background hypothesis. There may be several signal hypotheses for some processes. Such
hypotheses can diﬀer from each other, for example, by the set of constraints, as well as by the
presence or absence of lost particles. To show this, let us consider the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾
process. Since the ﬁnal state of this process contains two charged pions and two photons, then
hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 is a signal hypothesis for this process. Another signal hypothesis is
𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾. This hypothesis takes into account the intermediate particle 𝜂. This
particle can be taken into account using the constraint on the two-photon invariant mass.

It should be noted that some of the hypotheses discussed in the article contain a particle denoted
by the letter 𝑋. It is important to keep in mind that this designation is used for a neutral intermediate
particle of unknown mass. An example of such a hypothesis is 𝑒+𝑒− → 𝑋𝐾 +𝜋−, 𝑋 → 𝜋+𝜋−,
which is a signal hypothesis for the 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋−, 𝐾𝑆 → 𝜋+𝜋− process.

4 Chi-square distribution

4.1 Gaussian simulation

Consider a single event of some process. Let us assume that the exact measurable parameters 𝝁𝒙
of the particles are known in this event. A single measurement of these parameters gives a vector
of measured parameters ˜𝒙, which has a random nature. Further, we suppose that ˜𝒙 ∼ N ( 𝝁𝒙, ˆ𝐶),
where ˆ𝐶 is the corresponding covariance matrix. Using this multivariate normal distribution, it is
possible to generate a number of events similar to the initial one, but corresponding to diﬀerent
outcomes of the random vector ˜𝒙. For each of these events, one can perform the procedure of
kinematic and vertex ﬁtting according to the algorithm 2. This sequence of steps is necessary to
obtain the chi-square 𝜒2(𝒙 (cid:48)) = (𝒙 (cid:48) − ˜𝒙)(cid:124) ˆ𝐶−1 (𝒙 (cid:48) − ˜𝒙) distribution at the local minimum points
𝒙 (cid:48) found using the ﬁtting procedure. The ﬁrst question is whether this distribution will match
the well-known chi-square distribution from statistics. Let us remind that the probability density
function (PDF) for the latter distribution has the following form:

𝑓𝜒2 (𝑡; 𝑘) =

𝑡 𝑘/2−1𝑒−𝑡/2, 𝑡 > 0;

1
2𝑘/2Γ(𝑘/2)
0, otherwise,





(4.1)

where the variable 𝑘 has the meaning of the number degrees of freedom (NDF), and the variable
𝑡 has the meaning of the chi-square value. If the chi-square 𝜒2(𝒙 (cid:48)) distribution at the output of
the ﬁtting procedure matches the distribution (4.1) under certain conditions, then a second question
arises. The question is what number of degrees of freedom corresponds to this distribution.

However, it should be noted that the exact values 𝝁𝒙 of the measurable particle parameters
are unknown in experimental and Monte Carlo simulation1 events. Therefore, in order to follow

1Further, by Monte Carlo simulation we understand the simulation of events of any 𝑒+𝑒− annihilation process, taking
into account the response of a detector. We assume that in this simulation we are interested in particles reconstructed using
this response. It should be noted that the exact particle parameters can be known from a primary generator. However, it
is not always a trivial task to compare the particles from the primary generator with the reconstructed particles.

– 7 –

the sequence of steps from the previous paragraph and obtain the distribution of 𝜒2(𝒙 (cid:48)), a little
trick is needed. The exact particle parameters 𝝁𝒙 correspond to the situation when all conservation
constraints are satisﬁed. Suppose that in the initial event only the vector of measured parameters
˜𝒙 and the covariance matrix ˆ𝐶 are known. This event can be ﬁtted according to algorithm 4.1
under the signal hypothesis. As a result of this ﬁtting, one can obtain a point 𝒙 (cid:48) of the chi-square
conditional minimum. This point satisﬁes the constraints by deﬁnition. However, it should be
noted that the vector 𝒙 (cid:48) has a random nature (sine it depends on the random vector ˜𝒙) and does not
coincide exactly with the vector 𝝁𝒙. In any case, one can forget about the previous initial event,
and consider a new initial event with exactly known vector 𝝁𝒙 = 𝒙 (cid:48). With the last event, one can
perform the sequence of steps from the ﬁrst paragraph and obtain the desired 𝜒2(𝒙 (cid:48)) distribution.
The procedure described in this paragraph and the previous one is further referred to as Gaussian
simulation.

4.2 Linear constraints

Let us ﬁrst consider the case where all constraints are linear. Suppose that these constraints have
the following form:

(4.2)
𝜕( 𝑓1,..., 𝑓𝑚)
𝜕( 𝑦1,...,𝑦(𝑛+𝑙) ) is the Jacobian of constraint functions, 𝒗 is some vector, dim 𝒗 = 𝑚. The

ˆ𝐽 𝒚 + 𝒗 = 0,

where ˆ𝐽 =
Lagrange function in this case has the form:

L ( 𝒚, 𝝀) = (𝒙 − ˜𝒙)(cid:124) ˆ𝐶−1 (𝒙 − ˜𝒙) + 𝝀(cid:124) (cid:0) ˆ𝐽 𝒚 + 𝒗(cid:1) ,

𝒚 = 𝒙 ⊕ 𝒂.

(4.3)

After substituting the Lagrange function 4.3 into equation (2.6), this equation will be reduced to the
following system of linear equations2:

(cid:35)

(cid:34)

2 ˆ𝑀 ˆ𝐽 (cid:124)
ˆ𝐽 0𝑚×𝑚

Δ𝒒 = −Δ𝒈,

(4.4)

where ˆ𝑀 = ˆ𝐶−1 ⊕ 0𝑙×𝑙, Δ𝒒 = Δ𝒚 ⊕ Δ𝝀, Δ𝒚 = 𝒚 − ˜𝒚, Δ𝝀 = 𝝀 − 0 = 𝝀. 0𝑚×𝑚 and 0𝑙×𝑙 are zero 𝑚 by 𝑚
and 𝑙 by 𝑙 zero matrices, respectively. The vector ˜𝒚 = ˜𝒙 ⊕ ˜𝒂 has the meaning of the vector of initial
values of the parameters 𝒚. As discussed above, the vector ˜𝒙 at the same time has the meaning of
the measured values of the parameters 𝒙. Vector Δ𝒈 can be written in the following form:


















2Thus, within the framework of the iterative algorithm given by equation (2.7), the optimization problem (1.4) is

0
...
0
𝑓1( ˜𝒚)
𝑓2( ˜𝒚)
...
𝑓𝑚( ˜𝒚)

0


...




0

Δ 𝑓1



Δ 𝑓2

...




Δ 𝑓𝑚



Δ𝒈 = ∇𝒒L ( ˜𝒚, 0) =





































(4.5)

≡

,

solved in one iteration in the case of linear constraints.

– 8 –

where Δ 𝑓𝑘 = 𝑓𝑘 ( ˜𝒚) − 𝑓𝑘 ( 𝒚(cid:48)) = 𝑓𝑘 ( ˜𝒚), 𝑓𝑘 ( 𝒚(cid:48)) = 0, 𝒚(cid:48) is the local extremum point.

Note that the matrix of the system of equations (4.4) is non-singular only if rank( ˆ𝐽) = 𝑚. If
the last equality is not satisﬁed, then linearly dependent rows and columns appear in the matrix of
the system of linear equations (4.4), i.e. this matrix becomes degenerate. Note that the condition
rank( ˆ𝐽) = 𝑚 must also hold in the nonlinear case, otherwise the Hessian (2.8) is degenerate. Thus,
it makes sense to consider only functionally independent constraints (rank( ˆ𝐽) = 𝑚). In addition, it is
easy to show that the inequality 𝑛 + 𝑙 ≥ 𝑚 must also hold, otherwise the constraints are functionally
dependent: rank( ˆ𝐽) ≤ min(𝑛 + 𝑙, 𝑚) = 𝑛 + 𝑙 < 𝑚.

Let us represent the Jacobian as the concatenation of two matrices: ˆ𝐽 =
𝜕( 𝑓1,..., 𝑓𝑚)
𝜕( 𝑥1,..., 𝑥𝑛) is the Jacobian of the constraint functions with respect to the parameters 𝒙, and the
𝜕( 𝑓1,..., 𝑓𝑚)
𝜕(𝑎1,...,𝑎𝑙) is the Jacobian of these functions with respect to the parameters 𝒂. Taking

ˆ𝐽𝒙 =
matrix ˆ𝐽𝒂 =
into account this form of the Jacobian, the system of equations (4.4) can be rewritten as follows:

. The matrix

ˆ𝐽𝒙 ˆ𝐽𝒂

(cid:104)

(cid:105)

ˆ𝐽 (cid:124)
𝒙
ˆ𝐽 (cid:124)
𝒂

2 ˆ𝐶−1 0𝑛×𝑙


0𝑙×𝑛



ˆ𝐽𝒙



0𝑙×𝑙
ˆ𝐽𝒂 0𝑚×𝑚

Δ𝒒 = −Δ𝒈.

(4.6)









It can be seen from the last system of linear equations that rank( ˆ𝐽𝒂) = 𝑙, otherwise the matrix
It is also seen that the inequality 𝑙 ≤ 𝑚 must be satisﬁed, since
of this system is degenerate.
min(𝑚, 𝑙) ≥ rank( ˆ𝐽𝒂) = 𝑙.

Equation (4.6) can be easily solved by inverting the corresponding block matrix. To do this,

one can use the well-known Forbenius formula [22] for block matrix inversion:

ˆ𝐴−1 =

(cid:35) −1

(cid:34) ˆ𝐵 ˆ𝐶
ˆ𝐷 ˆ𝐹

=

(cid:34) ˆ𝐵−1 + ˆ𝐵−1 ˆ𝐶 ˆ𝐺−1 ˆ𝐷 ˆ𝐵−1 − ˆ𝐵−1 ˆ𝐶 ˆ𝐺−1

(cid:35)

− ˆ𝐺−1 ˆ𝐷 ˆ𝐵−1

ˆ𝐺−1

,

(4.7)

where ˆ𝐵 is a 𝑛1 × 𝑛1 non-singular matrix, ˆ𝐹 is a 𝑛2 × 𝑛2 matrix, and ˆ𝐺 = ˆ𝐹 − ˆ𝐷 ˆ𝐵−1 ˆ𝐶. Taking into
account the last formula, one can obtain the following result:

ˆ𝐽 (cid:124)
𝒙
ˆ𝐽 (cid:124)
𝒂

2 ˆ𝐶−1 0𝑛×𝑙


0𝑙×𝑛



ˆ𝐽𝒙



0𝑙×𝑙
ˆ𝐽𝒂 0𝑚×𝑚

−1









=

=

(cid:35) −1

(cid:34)

2 ˆ𝐶−1
ˆ𝐾

ˆ𝐾 (cid:124)
ˆ𝑆

(cid:34) 1
2

ˆ𝐶 + 1
4
− 1
2

ˆ𝐶 ˆ𝐾 (cid:124) ˆ𝐺−1 ˆ𝐾 ˆ𝐶 − 1
2
ˆ𝐺−1 ˆ𝐾 ˆ𝐶

ˆ𝐶 ˆ𝐾 (cid:124) ˆ𝐺−1
ˆ𝐺−1

(cid:35)

,

where ˆ𝑆 is the following matrix:

ˆ𝑆 =

(cid:35)

ˆ𝐽 (cid:124)
𝒂

(cid:34)0𝑙×𝑙
ˆ𝐽𝒂 0𝑚×𝑚

;

ˆ𝐾 is the concatenation of matrices 0𝑙×𝑛 and ˆ𝐽𝒙:

ˆ𝐾 =

(cid:35)

(cid:34)0𝑙×𝑛
ˆ𝐽𝒙

.

– 9 –

(4.8)

(4.9)

(4.10)

0


...




0


Δ 𝑓1

...




Δ 𝑓𝑚


























𝑛 + 𝑙

𝑚

The matrix ˆ𝐺 in the case of equation (4.8) is as follows:

Thus, the solution for the vector Δ𝒒 has the form:

ˆ𝐺 = ˆ𝑆 −

ˆ𝐾 ˆ𝐶 ˆ𝐾 (cid:124).

1
2

(cid:34) 1
2

Δ𝒒 =

ˆ𝐶 + 1
4
− 1
2

ˆ𝐶 ˆ𝐾 (cid:124) ˆ𝐺−1 ˆ𝐾 ˆ𝐶 − 1
2
ˆ𝐺−1 ˆ𝐾 ˆ𝐶

(cid:35)

ˆ𝐶 ˆ𝐾 (cid:124) ˆ𝐺−1
ˆ𝐺−1

(cid:34)

− 1
2

(cid:35)

ˆ𝐶 ˆ𝐾 (cid:124) ˆ𝐺−1
ˆ𝐺−1

=

0


...




0


Δ 𝑓1

...




Δ 𝑓𝑚


























𝑙

𝑚

= ˆ𝑅 ˆ𝐺−1 ˆ𝑃Δ 𝒇 ,

where matrix ˆ𝑅 is such that

matrix ˆ𝑃 has the following form:

ˆ𝑅 =

(cid:34)

ˆ𝐶 ˆ𝐾 (cid:124)
− 1
2
ˆ𝐼𝑙+𝑚

(cid:35)

,

ˆ𝑃 =

(cid:35)

(cid:34)0𝑙×𝑚
ˆ𝐼𝑚

,

(4.11)

(4.12)

(4.13)

(4.14)

matrix ˆ𝐼𝑘 is the 𝑘 × 𝑘 identity matrix, Δ 𝒇 =
minimum point 𝒙 (cid:48) has the following form:

(cid:104)

Δ 𝑓1 Δ 𝑓2 · · · Δ 𝑓𝑚

(cid:105) (cid:124)

. The chi-square at the local

𝜒2(𝒙 (cid:48)) = (cid:0)𝒙 (cid:48) − ˜𝒙(cid:1) (cid:124) ˆ𝐶−1 (cid:0)𝒙 (cid:48) − ˜𝒙(cid:1) = Δ𝒙(cid:124) ˆ𝐶−1Δ𝒙 = Δ𝒒(cid:124) ˆ𝑌 Δ𝒒

= Δ 𝒇 (cid:124) ˆ𝑃(cid:124) ˆ𝐺−1 ˆ𝑅(cid:124) ˆ𝑌 ˆ𝑅 ˆ𝐺−1 ˆ𝑃Δ 𝒇

= Δ 𝒇 (cid:124)

(cid:18) 1
4

ˆ𝑃(cid:124) ˆ𝐺−1 ˆ𝐾 ˆ𝐶 ˆ𝐾 (cid:124) ˆ𝐺−1 ˆ𝑃

(cid:19)

Δ 𝒇 = Δ 𝒇 (cid:124) ˆMΔ 𝒇 ,

(4.15)

where ˆ𝑌 = ˆ𝐶−1 ⊕ 0(𝑙+𝑚)×(𝑙+𝑚) and ˆM = 1
4

ˆ𝑃(cid:124) ˆ𝐺−1 ˆ𝐾 ˆ𝐶 ˆ𝐾 (cid:124) ˆ𝐺−1 ˆ𝑃.

4.2.1 Case 𝑙 = 0
Let us consider ﬁrst the case where the number of non-measurable parameters is zero, 𝑙 = 0. In this
case ˆ𝐺 = − 1
. This matrix must be non-singular, otherwise the system of equations (4.6) is
2
unsolvable.

ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽𝒙

(cid:124)

Consider the random vector Δ 𝒇 = ˆ𝐽𝒙 ˜𝒙 + 𝒗. Since this vector is linearly related to the random
vector ˜𝒙 ∼ N ( 𝝁𝒙, ˆ𝐶), it is easy to show that it is also normally distributed. The expectation E[.] of

– 10 –

this vector has the following form: E[Δ 𝒇 ] = ˆ𝐽𝒙E[ ˜𝒙] + 𝒗 = ˆ𝐽𝒙 𝝁𝒙 + 𝒗 ≡ 0. In the previous formula,
we used the identity E[ ˜𝒙] = 𝝁𝒙. The covariance matrix ˆCov[.] for this vector can also be easily
obtained:

ˆCov[Δ 𝒇 ]𝑖 𝑗 = E[(Δ 𝒇 − 0)𝑖 (Δ 𝒇 − 0) 𝑗] =

E[( ˆ𝐽𝒙 ˜𝒙 + 𝒗)𝑖 ( ˆ𝐽𝒙 ˜𝒙 + 𝒗) 𝑗] = ( ˆ𝐽𝒙)𝑖𝑎 ( ˆ𝐽𝒙) 𝑗𝑏E[( ˜𝒙)𝑎 ( ˜𝒙)𝑏] + (𝒗)𝑖 ( ˆ𝐽𝒙 𝝁𝒙) 𝑗 =
(cid:17)

(cid:16)

(4.16)

( ˆ𝐽𝒙)𝑖𝑎 ( ˆ𝐽𝒙) 𝑗𝑏E[( ˜𝒙 − 𝝁𝒙)𝑎 ( ˜𝒙 − 𝝁𝒙)𝑏] =

ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽 (cid:124)

𝒙

.

𝑖 𝑗

(cid:124)

Indices 𝑖 and 𝑗 are free matrix indices. Thus we got that Δ 𝒇 ∼ N (0, ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽 (cid:124)

In the last equation it is assumed that summation is carried out over the repeated indices 𝑎 and
𝑏.
𝒙 ). Since the
ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽𝒙
matrix ˆ𝐺 = − 1
is also non-singular. Therefore, the
2
random variable Δ 𝒇 (cid:124) (cid:16)
(cid:17)

is non-singular, the matrix ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽𝒙
ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽 (cid:124)
= 𝑚 degrees of freedom.

ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽 (cid:124)
On the other hand, according to equation (4.15), the following equality holds in the case of

Δ 𝒇 is distributed according to the chi-square distribution with

rank

(cid:17) −1

(cid:16)

(cid:124)

𝒙

𝒙

𝑙 = 0:

𝜒2(𝒙 (cid:48)) = Δ𝒙(cid:124) ˆ𝐶−1Δ𝒙 = Δ 𝒇 (cid:124) ˆ𝑀Δ 𝒇 = Δ 𝒇 (cid:124) (cid:16)

(cid:17) −1

ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽 (cid:124)

𝒙

Δ 𝒇 ,

(4.17)

the random variable 𝜒2(𝒙 (cid:48)) = Δ𝒙(cid:124) ˆ𝐶−1Δ𝒙 has the same distribution as the random variable
ˆ𝐽𝒙 ˆ𝐶 ˆ𝐽 (cid:124)
Δ 𝒇 . Thus, in the case of linear constraints and with 𝑙 = 0, the random variable

i.e.
Δ 𝒇 (cid:124) (cid:16)
𝜒2(𝒙 (cid:48)) is distributed according to the chi-square distribution (4.1) with 𝑚 degrees of freedom.

(cid:17) −1

𝒙

4.2.2 Case 𝑙 ≠ 0

Now consider the case when the number of non-measurable parameters is non-zero. The system of
linear equations (4.2) describing the constraints can be rewritten as follows:

ˆ𝐽𝒙 𝒙 + ˆ𝐽𝒂 𝒂 + 𝒗 = 0.
Since rank( ˆ𝐽) = 𝑚, the latter system contains 𝑚 linearly independent equations. Let us multiply
this system of equations on the left by the matrix ˆ𝐽 (cid:124)
(cid:1) = rank( ˆ𝐽𝒂) = 𝑙, the 𝑙 × 𝑙
matrix ˆ𝐽 (cid:124)
𝒂 ˆ𝐽𝒂 is a full rank matrix, i.e. this matrix is non-singular. Thus, non-measurable variables
𝒂 can be expressed from equation (4.18) as follows:
(cid:1) −1 ˆ𝐽 (cid:124)
𝒂

𝒂 . Since rank (cid:0) ˆ𝐽 (cid:124)

(cid:0) ˆ𝐽𝒙 𝒙 + 𝒗(cid:1) .

𝒂 = − (cid:0) ˆ𝐽 (cid:124)

(4.18)

(4.19)

𝒂 ˆ𝐽𝒂

𝒂 ˆ𝐽𝒂

Further, non-measurable parameters can be excluded from equation (4.18) by substituting equa-
tion (4.19) back into equation (4.18). As a result of this substitution, one can obtain the following
system of equations:

(cid:16)

ˆ𝐼 − ˆ𝐽𝒂

(cid:0) ˆ𝐽 (cid:124)

𝒂 ˆ𝐽𝒂

(cid:1) −1 ˆ𝐽 (cid:124)
𝒂

(cid:17) (cid:0) ˆ𝐽𝒙 𝒙 + 𝒗(cid:1) = 0,

(4.20)

where ˆ𝐼 is the identity matrix. The system of linear equations (4.20) contains 𝑚 equations, but some
of the equations in this system are linearly dependent. Since this system was obtained from a system
of 𝑚 linearly independent equations (4.18) by eliminating 𝑙 non-measurable parameters, it contains
only 𝑚 − 𝑙 linearly independent equations. Thus the case 𝑙 ≠ 0 can be reduced to the case 𝑙 = 0.
Therefore, by analogy with section 4.2.2, one can conclude that in the case of linear constraints and
with 𝑙 ≠ 0, the random variable 𝜒2(𝒙 (cid:48)) is distributed according to a chi-square distribution (4.1)
with 𝑚 − 𝑙 degrees of freedom.

– 11 –

4.3 Nonlinear constraints

In the case of nonlinear constraints, the random vectors 𝒙 (cid:48) and Δ 𝒇 are expressed in terms of the
random vector ˜𝒙 non-linearly. Thus, in the case of nonlinear constraints, the distribution of the
random variable 𝜒2(𝒙 (cid:48)) = Δ𝒙(cid:124) ˆ𝐶−1Δ𝒙 diﬀers from the chi-square distribution (4.1).

It should be noted that the kinematic and vertex ﬁtting implies extensive use of nonlinear
constraints (see sections 6 and 7). Thus, one should expect that the distribution of the random
variable 𝜒2(𝒙 (cid:48)) obtained using Gaussian simulation will not be consistent with the chi-square
distribution (4.1). However, in the case of many hypotheses, nonlinear eﬀects do not lead to
signiﬁcant distortion of the chi-square distribution. That is, despite the non-linearity, the distribution
of the random variable 𝜒2(𝒙 (cid:48)) in these cases is well described by the distribution (4.1). At the same
time, in the case of some hypotheses3, the nonlinear eﬀects can be so large that the distribution of
the random variable 𝜒2(𝒙 (cid:48)) in these cases is not described by the probability density function (4.1).
A detailed discussion of how constraint non-linearity aﬀects the 𝜒2(𝒙 (cid:48)) distribution is given in
section 9 with examples using Gaussian simulation.

The fact that the 𝜒2(𝒙 (cid:48)) distribution is in many cases described by a probability density func-
tion (4.1), despite the non-linearity of the constraints, makes Gaussian simulation an important tool
for testing the ﬁtting package discussed in this work. Typos in various kinds of parametrizations, as
well as in their gradients and Hessians, often lead to signiﬁcant distortions of the 𝜒2(𝒙 (cid:48)) distribution.
The consequences of such typos appear in all hypotheses using corresponding parametrizations.
Thus, the analysis of the 𝜒2(𝒙 (cid:48)) distribution, obtained as a result of the Gaussian simulation, makes
it possible to identify some these typos.

4.4 Chi-square in the case of Monte Carlo simulation and experimental data

As noted above, Gaussian simulation is of interest for testing a ﬁtting package. In real analysis,
the user of a ﬁtting package deals with experimental data as well as Monte Carlo simulations of
It often happens that the uncertainties of some measurable parameters
a particular processes.
are of a non-Gaussian nature4 even in the case of Monte Carlo simulation. Therefore, it can be
expected that the distribution of the random variable 𝜒2(𝒙 (cid:48)) in the case of Monte Carlo simulations
and experimental data is less consistent with the chi-square distribution (4.1) than in the case of
Gaussian simulation. Examples of distributions of the random variable 𝜒2(𝒙 (cid:48)) for Monte Carlo
simulation events can be seen in section 8. These distributions were obtained using the ﬁtting
package discussed in this paper. It should be noted that below in the text and in the captions to the
ﬁgures, instead of 𝜒2(𝒙 (cid:48)), we often use the notation 𝜒2.

Since the Monte Carlo simulation does not perfectly describe the experimental data, the
distributions of the random variable 𝜒2(𝒙 (cid:48)) in the experiment and simulation may be diﬀerent.
Suppose that in the analysis of some physical process, a selection criterion for 𝜒2(𝒙 (cid:48)) is used.
Since the distributions of the random value 𝜒2(𝒙 (cid:48)) in experiment and simulation are diﬀerent, the
detection eﬃciencies in simulation and experiment are also diﬀerent. The detection eﬃciency in

3It should be noted that the inﬂuence of nonlinear constraints on the 𝜒2 (𝒙(cid:48)) distribution depends not only on the
hypothesis choice, but also on the magnitude of the elements of the covariance matrix ˆ𝐶. The greater the deviation of the
measured parameters from their exact values, the more the eﬀects of the constraint non-linearity aﬀect this distribution.

4Due to non-Gaussian response of a detector.

– 12 –

the experiment is usually unknown, so the corresponding eﬃciency from the simulation is usually
used instead. Since these eﬃciencies are diﬀerent, this diﬀerence must be taken into account
using eﬃciency corrections and ﬁnding the corresponding systematic uncertainties. Examples of
detection eﬃciency corrections related to a chi-square selection criterion can be found, for example,
in articles [23, 24].

5 Vertices

In this paper, vertices are considered as separate entities. The reason for considering vertices as
separate entities is that each vertex is always shared by some set of particles. Each vertex has three
coordinates. The kinematic and vertex ﬁtting package includes vertex classes corresponding to
coordinates in Cartesian and cylindrical coordinate systems. User can add vertices with custom
parametrization corresponding to a diﬀerent coordinate system. To do this, one needs to implement
a new vertex class inherited from the base vertex class. The base vertex class contains virtual abstract
methods that return the Cartesian coordinates of a vertex depending on its three parameters. This
class also contains virtual abstract methods for obtaining gradients and Hessians of the Cartesian
coordinates, depending on a vertex parametrization. In order to create a custom vertex class, the
user have to implement the above abstract methods.
In the case of the vertex corresponding to
the Cartesian coordinate system, the implementation of the methods listed above is trivial. For
example, functions that return the Cartesian coordinates of a vertex have the following form:

𝑥v(𝒂 (𝒗) ) = 𝑥 (𝑣) ,
𝑦v(𝒂 (𝒗) ) = 𝑦 (𝑣) ,
𝑧v(𝒂 (𝒗) ) = 𝑧 (𝑣) ,
𝑥 (𝑣)
𝑦 (𝑣)
𝑧 ( 𝑣)

𝒂 (𝒗) =









(5.1)

,









where 𝑥v, 𝑦v and 𝑧v are functions that return the Cartesian coordinates of a vertex depending on
the vector 𝒂 (𝑣) of its parameters 𝑥 (𝑣) , 𝑦 (𝑣) and 𝑧 (𝑣) , which are themselves the vertex Cartesian
coordinates. In the case of a vertex parametrized according to the cylindrical coordinate system,
the functions returning Cartesian coordinates are as follows:

𝑥v(𝒂 (𝒗) ) = 𝜌 (𝑣) cos 𝜙 (𝑣) ,
𝑦v(𝒂 (𝒗) ) = 𝜌 (𝑣) sin 𝜙 (𝑣) ,
𝑧v(𝒂 (𝒗) ) = 𝑧 (𝑣) ,
𝜌 (𝑣)
𝜙 (𝑣)
𝑧 (𝑣)

,








where parameters 𝜌 (𝑣) , 𝜙 (𝑣) and 𝑧 ( 𝑣) are the vertex coordinates in the cylindrical coordinate system.
Here and below, we do not present gradients and Hessians for vertex coordinates, particle four-
momenta and trajectories, since the procedure for calculating them is well known. At the same

𝒂 (𝒗) =









(5.2)

– 13 –

time, gradients and Hessians, for example, in the case of charged particle (see section 6.2.1), can
take up quite a lot of paper space.

In the case of the CMD-3 experiment, vertex parametrization (5.1) is most often used. Such ver-
tex parametrizations as (5.2) can be used in speciﬁc cases. For example, a vertex with parametriza-
tion (5.2) can be used if it is required to set limits for the 𝜌 (𝑣) parameter. Such a need may arise,
for example, if one wants to restore a vertex of a photon conversion on the vacuum tube of the drift
chamber.

Vertex coordinates are considered as non-measurable parameters by default.

In principle,
vertex coordinates can be made measurable parameters by specifying a non-zero inverse covariance
matrix corresponding to these coordinates. In this case, an additional non-zero sum over the vertices
will appear in the equation (1.2). However, in the case of the CMD-3 experiment, there is no such
need.

In the case of an 𝑒+𝑒− interaction vertex, the 𝑥- and 𝑦-coordinates can be ﬁxed at the beam
position in the corresponding plane, since this position is known with an accuracy of about 100 µm
in the case of the VEPP-2000 collider. The 𝑧-coordinate of this vertex should be a free parameter.
In the case of decay vertices, all three coordinates should be free.

6 Particles

Like vertices, particles are considered as separate entities in this work. Particle classes contain
parametrizations of output four-momenta with respect to the origin vertex and input four-momenta
with respect to the decay vertex. These four-momenta are used in the energy-momentum con-
servation constraints, as well as in the constraints on the invariant mass of some particle set.
Energy-momentum constraints and mass constraint are described in detail in sections 7.1 and 7.2,
respectively.

In the case of some particle classes, parametrization of particle trajectories can also be imple-

mented. These trajectories are required in constraints using for vertex ﬁtting (see section 7.3).

6.1

Initial pseudo-particle

The initial pseudo particle is used in order to set the total four-momentum of all particles present
in a certain hypothesis. In the case of the VEPP-2000 collider, the energies of the initial electrons
and positrons are the same with high accuracy, and the directions of their motion are opposite. For
this reason, the four-momentum parametrization for the initial pseudo-particle in the case of the
CMD-3 experiment can be written in the following form:

P (𝑖)
pseudo = (𝐸c.m., 0),
where 𝐸c.m. = 2𝐸beam is the center-of-mass energy, 𝐸beam is the beam energy, 𝑖 is the particle index.
In the case of the CMD-3, the energy is set constant at each event.
In principle, the user can
easily add a custom pseudo-particle class in which energy and momentum are free parameters and
contribute to the chi-square (1.2). In the case of the VEPP-2000, the typical beam energy spread is
less than 1 MeV. For this reason, using a non-constant center-of-mass energy 𝐸c.m. in the case of
the CMD-3 experiment will not have a signiﬁcant eﬀect5 on the ﬁt result.

(6.1)

5This eﬀect is within the detector resolution.

– 14 –

6.2 Charged particles and photons

The parametrizations of a charged particle and photon were placed in a separate subsection, since
the authors consider these parametrizations to be detector-dependent. For example, in the case of a
photon, the detector-dependent part of the parametrization is contained at least in the description of
the photon conversion point inside a calorimeter. In the case of the CMD-3 experiment, a cylindrical
coordinate system is used to set the photon conversion point. The parametrization of a charged
particle in the case of the CMD-3 experiment is described in section 6.2.1. This parametrization
may also have some diﬀerences in the case of a diﬀerent experiment. For example, in the case of
the charged particle parametrization described in section 6.2.1, a constant magnetic ﬁeld6 at any
point of the drift chamber is used, i.e. the change in the magnetic ﬁeld near the detector end-caps
is not taken into account. This is due to the fact that the charged particle tracks themselves are
reconstructed in the case of the CMD-3 experiment under the assumption of an uniform magnetic
ﬁeld. The inhomogeneity of the magnetic ﬁeld in the CMD-3 experiment is usually taken into
account by introducing a corresponding systematic uncertainty. Since the package of kinematic and
vertex ﬁtting discussed in this paper uses the parameters of already reconstructed tracks, it makes
no sense to take into account the inhomogeneity of the magnetic ﬁeld in this package.

It should be noted that only the parametrization of a ﬁnal charged particle is discussed in
section 6.2.1. The parametrization of an intermediate charged particle is discussed in section 6.3.2.

6.2.1 Charged particle

In the case of the experiment with the CMD-3 detector, the parametrizations of four-momenta and
trajectories of ﬁnal charged particles depend on ﬁve measurable parameters. These parameters are
listed below:

• 𝑝 (𝑖)

⊥ is the radial component of momentum, i.e. the momentum component perpendicular to

the magnetic ﬁeld;

• 𝜌 (𝑖)
c

• 𝑧 (𝑖)
c

• 𝜙 (𝑖)
c

• 𝜃 (𝑖)
c

is the distance between the beam axis and the nearest point on a charged particle trajectory;

is 𝑧-coordinate of the track point closest to the beam axis;

is the axial angle corresponding to the track point closest to the beam axis;

is the polar angle of a charged particle momentum.

The parametrizations of the charged particle four-momentum and trajectory depend also on one
non-measurable parameter 𝑐𝑡 (𝑖)
out. This parameter has a meaning of a distance along charged particle
trajectory with respect to the track point closest to the beam axis. At the end of the chi-square
minimization the value of the parameter 𝑐𝑡 (𝑖)
out is equal to the distance between the track point closest
to the beam axis and the vertex of a charged particle origin.

6Further, it is assumed that this ﬁeld is directed along the 𝑍-axis.

– 15 –

The parametrization of a charged particle four-momentum P (𝑖)

c, out =

(cid:16)

𝐸 (𝑖)
c

, 𝒑 (𝒊)

c, out

(cid:17)

has the

following form:

2,

(6.2)

𝑐𝑡 (𝑖)
out − 𝜙 (𝑖)

𝑐𝑡 (𝑖)
out − 𝜙 (𝑖)

c

c

(cid:33)

c ) + 𝑚 (𝑖)















(cid:33)

c

,

𝐸 (𝑖)

c =

√︃

2

𝑝 (𝑖)
⊥

(1 + cot2 𝜃 (𝑖)

𝒑 (𝒊)
c, out =

(cid:32) 𝜔 (𝑖)
c
𝑐

(cid:32) 𝜔 (𝑖)
c
𝑐

⊥ sin

𝑝 (𝑖)
⊥ cos








−𝑝 (𝑖)







𝑞 (𝑖)
c 𝐵𝜅c
𝐸 (𝑖)
c
𝜅c ≈ 2.9979 × 10−3,

𝜔 (𝑖)
c
=
𝑐

,

⊥ cot 𝜃 (𝑖)
𝑝 (𝑖)

c

is the particle charge, measured in elementary charges; the constant 𝑚 (𝑖)
c

where the constant 𝑞 (𝑖)
is
c
the mass of a charged particle, measured in GeV/𝑐2; the constant 𝐵 is the magnetic ﬁeld, measured
in T. Fraction 𝜔 (𝑖)
c /𝑐 is the fraction of cyclotron frequency to the speed of light; the constant
𝜅c ≈ 2.9979 × 10−3 is the proportionality factor7.

The parametrization of a charged particle trajectory 𝒓 (𝒊)

c, out =

the following equation:

(cid:104)

𝑥 (𝑖)
c, out

𝑦 (𝑖)
c, out

𝑧 (𝑖)
c, out

(cid:105) (cid:124)

sin 𝜙 (𝑖)

c + 𝑅 (𝑖)

c

sin

out − 𝜙 (𝑖)
𝑐𝑡 (𝑖)

c

(cid:32) 𝜔 (𝑖)
c
𝑐
(cid:32) 𝜔 (𝑖)
c
𝑐

(cid:33)

,

(cid:33)

,

cos 𝜙 (𝑖)

c + 𝑅 (𝑖)

c cos

out − 𝜙 (𝑖)
𝑐𝑡 (𝑖)

c

𝑥 (𝑖)
c, out = 𝑥beam +

(cid:16)

c − 𝜌 (𝑖)
𝑅 (𝑖)

c

𝑦 (𝑖)
c, out = 𝑦beam −

(cid:16)

c − 𝜌 (𝑖)
𝑅 (𝑖)

c

(cid:17)

(cid:17)

c, out = 𝑧 (𝑖)
𝑧 (𝑖)

c +

c 𝑐𝑡 (𝑖)

out

𝑝 (𝑖)
⊥ cot 𝜃 (𝑖)
𝐸 (𝑖)
c

,

is given by

(6.3)

𝑅 (𝑖)

c =

𝑝 (𝑖)
⊥
𝑞 (𝑖)
c 𝐵𝜅c

,

where 𝑥beam are 𝑦beam the 𝑥- and 𝑦-coordinates of the beam axis, respectively.
In the case of
the CMD-3 detector these coordinates considered as constants, since they are known with a high
accuracy.

6.2.2 Photon

The parametrization of the photon four-momentum depends on seven parameters. Four of the seven
parameters belong to the photon. The remaining three parameters are the coordinates 𝒓origin of its
origin vertex. One of the four photon parameters is its energy 𝐸 (𝑖)
𝛾 . The remaining three photon

7The value of this factor is determined by the speed of light and units of measurement of the quantities involved in
equation (6.2). Here and below, we assume that energy is measured in GeV, magnetic ﬁeld in T, time in seconds, and
distance in cm.

– 16 –

parameters are the coordinates 𝜌 (𝑖)
𝛾 , 𝜙 (𝑖)
system. The photon four-momentum P (𝑖)

𝛾 and 𝑧 (𝑖)
𝛾 = (𝐸 (𝑖)

𝛾 of the conversion point in a cylindrical coordinate
𝛾 , 𝒑 (𝒊)
𝜸 ) is given by the following equation:
𝒓 (𝒊)
conv − 𝒓origin
(cid:107) 𝒓 (𝒊)
conv − 𝒓origin(cid:107)
𝜌 (𝑖)
𝛾 cos 𝜙 (𝑖)

𝛾

𝛾 sin 𝜙 (𝑖)
𝜌 (𝑖)

𝛾

𝑧 (𝑖)


𝛾


(6.4)

,

.









𝜸 = 𝐸 (𝑖)
𝒑 (𝒊)

𝛾

𝒓 (𝒊)
conv =

Since equation (6.4) already requires a photon to ﬂy from the origin vertex 𝒓origin to the conversion
point 𝒓 (𝒊)

conv, there is no need for a separate parametrization of a photon trajectory.

Intermediate particles

6.3
Along all intermediate particles in the case of the CMD-3 experiment, 𝐾𝑆 mesons require special
attention due to their long lifetime. Parametrization of neutral intermediate particles, such as 𝐾𝑆
mesons, is given in section 6.3.1. It should also be noted that for particles such as 𝜋0 or 𝜂 mesons,
the parametrization described in section 6.3.1 should not be used. In the terms of kinematic and
vertex ﬁtting, these particles decay at the origin vertex due to their short lifetime. To take these
particles into account, it suﬃces to require a mass constraint on their decay products.

Due to the small radius (30 cm) of the drift chamber in the CMD-3 experiment, it practically
makes no sense to consider hypotheses with intermediate charged particles. The probability of
a charged 𝜋-meson or 𝐾-meson decay inside the drift chamber is low. There is always an odd
number of charged particles among the decay products of a charged particle in order to conserve
charge. The tracks of an initial charged particle and the charged products of its decay are well
reconstructed if the decay vertex is near the center of the drift chamber radius, since in this case
the probability that all tracks will have a suﬃcient number of hits is the highest. Thus, the number
of charged particle decay events in which kinematic and vertex ﬁtting can be successfully used is
additionally limited by the track reconstruction eﬃciency. However, intermediate charged particles
have been implemented in the discussed kinematic and vertex ﬁtting package. In addition, it was
veriﬁed that the use of these intermediate particles makes it possible, for example, to ﬁnd events
with 𝜋+ → 𝜇+𝜈𝜇 decay8. The parametrization of intermediate charged particles is discussed in
detail in section 6.3.2.

6.3.1

Intermediate neutral particle

The parametrization of the intermediate neutral particle depends on seven parameters. Four param-
eters belong to this particle. The three remaining parameters are the coordinates 𝒓origin of its origin
vertex. The ﬁrst three parameters of an intermediate neutral particle are the Cartesian components
of its momentum








8Since the detection of intermediate charged particles in the case of CMD-3 is diﬃcult due to the small size of the
drift chamber, the authors do not further consider examples of hypotheses with such particles. The authors hope to study
in more detail the possibility of using intermediate charged particles 6.3.2 in other experiments in the future.

𝒑 (𝒊)
int. n. =

(6.5)









,

𝑝 (𝑖)
x
𝑝 (𝑖)
y
𝑝 (𝑖)
z

– 17 –

the last parameter 𝜉 (𝑖) is proportional to the time interval between the particle origin and decay.
The four-momentum parametrization for an intermediate neutral particle has the following form:

(cid:32)√︂

P (𝑖)
int. n. =

2

𝑚 (𝑖)

int. n.

+ 𝒑 (𝒊)

2 , 𝒑 (𝒊)

int. n.

int. n.

(cid:33)

,

(6.6)

where the constant 𝑚 (𝑖)
particle can be written as follows:

int. n. is the particle mass. Trajectory parametrization of an intermediate neutral

All parameters 𝑝 (𝑖)
non-measurable.

x , 𝑝 (𝑖)

y , 𝑝 (𝑖)

z

int. n. = 𝒓origin + 𝜉 (𝑖) 𝒑 (𝒊)
𝒓 (𝒊)

int. n.

.

(6.7)

and 𝜉 (𝑖) of an intermediate neutral particle are considered to be

It should be noted that instead of the momentum parametrization (6.5), one could consider a
momentum parametrization similar that of a photon momentum (6.4). In the case of an intermediate
neutral particle, such parametrization would have the following form:

int. n. = 𝑝 (𝑖)
𝒑 (𝒊)

int. n.

𝒓decay − 𝒓origin
(cid:107) 𝒓decay − 𝒓origin(cid:107)

,

(6.8)

int. n.

int. n. = (cid:107) 𝒑 (𝒊)

where the parameter 𝑝 (𝑖)
(cid:107) is the particle momentum norm9, 𝒓decay is the particle decay
vertex. The advantage of the parametrization (6.8) could be that it already requires the particle to
ﬂy from the origin vertex to the decay vertex, so the trajectory parametrization (6.7) can be avoided
in this case. The parametrization (6.8) would allow one to reduce the space of minimization
parameters by six, allowing one to remove three particle parameters and three Lagrange multipliers
corresponding to the vertex constraints 7.3 for this particle. However, the kinematic and vertex ﬁtting
in the case of parametrization (6.8) would work very unstable. This is due to the fact that zeros10
may appear in the denominator of equation (6.8). These zeros can also appear in the gradients and
Hessians of the particle momentum components. The use of parametrizations (6.5) and (6.7) makes
it easy to avoid the indicated problem, although it increases the space of minimization parameters.
It should be noted, however, that such an increase in the dimension of the parameter space does not
cause a signiﬁcant slowdown in the work of the ﬁt, at least in the case of the hypotheses that can
appear in the CMD-3 experiment.

6.3.2

Intermediate charged particle

The parametrizations of four-momenta and the trajectories of intermediate charged particles are very
similar to the corresponding parametrizations in the case of ﬁnal charged particles 6.2.1. In the case
of an intermediate charged particle, the parametrizations of the output four-momentum (6.2) and
the output trajectory (6.3) with respect to the origin vertex are exactly the same as for a ﬁnal charged
particle. The parametrizations of the input four-momentum and the input trajectory with respect
to the decay vertex diﬀer from the parametrizations (6.2) and (6.3) by replacing the parameter

9In this article, by norm we always mean the ℓ2-norm: (cid:107)𝒃(cid:107) =

√︄

dim 𝒃
(cid:205)
𝑖=1

𝑏2
𝑖 .

10During ﬁtting, points 𝒓decay and 𝒓origin can become very close to each other.

– 18 –

𝑐𝑡 (𝑖)
out with the parameter 𝑐𝑡 (𝑖)
in . As a result of this replacement, the parametrization of the input
four-momentum P (𝑖)
𝐸 (𝑖)
of an intermediate charged particle has the following form:
c

(cid:17)

(cid:16)

, 𝒑 (𝒊)
c, in

c, in =

𝐸 (𝑖)

c =

√︃

2

𝑝 (𝑖)
⊥

(1 + cot2 𝜃 (𝑖)

(cid:32) 𝜔 (𝑖)
c
𝑐

𝑐𝑡 (𝑖)
in

(cid:32) 𝜔 (𝑖)
c
𝑐

𝑐𝑡 (𝑖)
in

⊥ cot 𝜃 (𝑖)
𝑝 (𝑖)

c

2,

c

(cid:33)

− 𝜙 (𝑖)
c

c ) + 𝑚 (𝑖)















− 𝜙 (𝑖)
c

(cid:33)

,

⊥ sin

𝑝 (𝑖)
⊥ cos








−𝑝 (𝑖)







𝑞 (𝑖)
c 𝐵𝜅c
𝐸 (𝑖)
c

.

𝒑 (𝒊)
c, in =

𝜔 (𝑖)
c
=
𝑐

The parametrization of input trajectory can be written as follows:

sin 𝜙 (𝑖)

c + 𝑅 (𝑖)

c

sin

(cid:33)

− 𝜙 (𝑖)
c

𝑐𝑡 (𝑖)
in

(cid:32) 𝜔 (𝑖)
c
𝑐
(cid:32) 𝜔 (𝑖)
c
𝑐

cos 𝜙 (𝑖)

c + 𝑅 (𝑖)

c cos

𝑐𝑡 (𝑖)
in

− 𝜙 (𝑖)
c

𝑥 (𝑖)
c, in = 𝑥beam +

(cid:16)

c − 𝜌 (𝑖)
𝑅 (𝑖)

c

𝑦 (𝑖)
c, in = 𝑦beam −

(cid:16)

c − 𝜌 (𝑖)
𝑅 (𝑖)

c

(cid:17)

(cid:17)

c, in = 𝑧 (𝑖)
𝑧 (𝑖)

c +

c 𝑐𝑡 (𝑖)

in

⊥ cot 𝜃 (𝑖)
𝑝 (𝑖)
𝐸 (𝑖)
c

,

(6.9)

(6.10)

,

(cid:33)

,

𝑅 (𝑖)

c =

𝑝 (𝑖)
⊥
𝑞 (𝑖)
c 𝐵𝜅c

.

The parameter 𝑐𝑡 (𝑖)
in in equations (6.9) and (6.10) has the meaning of the distance along the charged
particle trajectory from the track point closest to the beam axis to the decay vertex of this particle.
Like the parameter 𝑐𝑡 (𝑖)

out, the parameter 𝑐𝑡 (𝑖)

in is a non-measurable parameter.

Practically, ﬁnal 6.2.1 and intermediate 6.3.2 charged particles are implemented as a single
class in the kinematic and vertex ﬁtting package. In the case of a ﬁnal charged particle the parameter
𝑐𝑡 (𝑖)

in is ﬁxed.

6.4 Lost particles

An important requirement for the kinematic and vertex ﬁtting package is the ability to perform a
ﬁt in hypotheses with lost particles11. It should be noted that for a lost particle it makes sense to
specify only a four-momentum, while specifying the trajectory of such a particle is meaningless.
It should also be noted that the four-momentum parameterization will be diﬀerent for massive and
massless particles. The four-momentum parametrization of a massive lost particle is discussed in
section 6.4.1, while the parametrization in the case of a massless lost particle is given in section 6.4.2.
The parameters of the lost particles are non-measurable as they are not measured directly with a
detector. In the case of the discussed package, this is achieved by specifying zero inverse covariance

11By lost particles, we mean ﬁnal particles that are not detected.

– 19 –

matrices corresponding to the parameters of these particles. It should also be noted that in some
cases the parameterizations from sections 6.4.1 and 6.4.2 can also be used for detected particles.
It is assumed that the parametrization of the trajectories of such particles is of no interest, and the
corresponding inverse covariance matrices are nonzero.

6.4.1 Massive particle

The parametrization of a massive lost particle has the following form:

√︃

P (𝑖)

𝑚≠0 = (

𝑚 (𝑖) 2 + 𝒑 (𝒊) 2, 𝒑 (𝒊) ), 𝒑 (𝒊) =

𝑝 (𝑖)
𝑥
𝑝 (𝑖)
𝑦
𝑝 (𝑖)
𝑧

















,

(6.11)

where the parameters 𝑝 (𝑖)
constant 𝑚 (𝑖) ≠ 0 is its mass.

𝑥 , 𝑝 (𝑖)

𝑦 and 𝑝 (𝑖)
𝑧

are the momentum components of the particle, and the

6.4.2 Massless particle

The four-momentum parametrization of a lost massless particle cannot be chosen in the form (6.11)
with 𝑚 (𝑖) = 0. The disadvantages of the parametrization (6.11) in the case of a massless particle is
that the denominators of the derivatives of this parametrization become very small if 𝒑 (𝒊) is close
to zero. For this reason, in the case of a lost massless particle, a slightly diﬀerent four-momentum
parametrization is used. This parametrization has the following form:

P (𝑖)
𝑚=0 = (𝐸 (𝑖) , 𝐸 (𝑖) 𝒏(𝒊) ), 𝒏(𝒊) =

sin 𝜃 (𝑖) cos 𝜙 (𝑖)


sin 𝜃 (𝑖) sin 𝜙 (𝑖)



cos 𝜃 (𝑖)











,

(6.12)

where the parameter 𝐸 (𝑖) is the particle energy, the parameters 𝜃 (𝑖) and 𝜙 (𝑖) are the polar and
axial angles, respectively. These angles determine the direction of the particle momentum 𝒑 (𝒊) =
𝐸 (𝑖) 𝒏(𝒊) .

7 Constraints

The discussed kinematic and vertex ﬁtting package uses three diﬀerent kinds of constraints. These
are energy-momentum conservation constraints, vertex constraints and mass constraints.

The energy-momentum conservation constraints are imposed on a certain set of particles,
and are divided into four diﬀerent constraints: one constraint is needed for energy conservation,
the other three are for momentum conservation. A detailed discussion of the energy-momentum
conservation constraints is given in section 7.1.

The mass constraint is imposed on a certain set of particles in order to require that the invariant
mass of these particles be equal to a certain value. The detailed description of the mass constraint
is given in section 7.2.

The vertex constraints are imposed on some individual particles at the vertices of their origin
and / or decay. These constraints require that the particle’s trajectory pass through the origin vertex
and the decay vertex. A detailed discussion of the vertex constraints is given in section 7.3.

– 20 –

(1)

[𝑃 ( 𝑗)
𝛼 ]

(2)

(3)

Figure 1: An example of a sub-tree of some energy-momentum conservation constraint tree. The
vertex [𝑃 ( 𝑗)
𝛼 ] of the sub-tree corresponds to a constraint on the conservation of the 𝛼-th component
of the four-momentum, 𝛼 = 𝑥, 𝑦, 𝑧, 𝑡. The edges of the sub-tree correspond to the particles on
which the constraint [𝑃 ( 𝑗)
𝛼 ] is imposed. The solid edge corresponds to a decaying particle, while
the dashed edges correspond to its decay products.

7.1 Energy-momentum conservation constraints

The energy-momentum conservation constraints have the following form:

∑︁

𝑎 ∈S( 𝑗)
+

P (𝑎)
output −

∑︁

𝑏 ∈S( 𝑗)
−

P (𝑏)
input = 0,

(7.1)

output is the output four-momentum of the 𝑎-th particle, P (𝑏)

where the sets S( 𝑗)
± are the sets of indices corresponding to the particles involved in the considered
constraints, P (𝑎)
input is the input four-
momentum of the 𝑏-th particle. The set S( 𝑗)
− corresponds12 to particles before interaction or decay,
while the set S( 𝑗)
corresponds to particles that are products of this interaction or decay. The index
+
𝑗 in S( 𝑗)
± means the index of particle sets on which the constraints 7.1 are imposed. Thus, it is
implied that, in the same hypothesis, the constraints given by equation (7.1) can be imposed on
several diﬀerent sets of particles. This circumstance is caused by the fact that the energy-momentum
conservation laws often need to be written at each vertex. Thus, the sets S( 𝑗)
± usually correspond to
particles having a ( 𝑗-th) common vertex. However, in some cases described below, this statement is
not true. Note also that equation (7.1) is considered as four diﬀerent constraints: one constraint is
for energy conservation, and remaining three constraints are for conservation of three-dimensional
momentum components. The discussed kinematic and vertex ﬁtting package allows using all these
constraints simultaneously, as well as only a part of them.

The energy-momentum constraints given by equation (7.1) are schematically shown in the
ﬁgure 1 when one particle decays into two other particles. The vertex of the decay tree shown in
this ﬁgure corresponds to one of the components (𝛼 = 𝑥, 𝑦, 𝑧, 𝑡) of the four-momentum conservation
constraints. The edges of this tree correspond to the particles on which the constraints are imposed.

12Taking into account section 6.1, it can be concluded that the cardinality of the set S( 𝑗)

− is equal to one (as rule).

– 21 –

𝜋−
2

[𝑃 (2)
𝛼 ]

𝜋+

𝐾
𝑆

𝑒+𝑒−

𝐾
𝑆

[𝑃 (1)
𝛼 ]

𝐾+

𝜋−
1

Figure 2: The energy-momentum conservation constraint tree corresponding to the hypothesis
𝑒+𝑒− → 𝐾𝑠𝐾 +𝜋−, 𝐾𝑆 → 𝜋+𝜋−. Label 𝑒+𝑒− in the tree denotes the initial pseudo-particle with
the input four-momentum P (𝑒+𝑒−)
𝛼 ] ensures the conservation of
the 𝛼-th four-momentum component at the 𝑒+𝑒− interaction vertex, 𝛼 = 𝑥, 𝑦, 𝑧, 𝑡. Constraint [𝑃 (2)
𝛼 ]
ensures the conservation of the 𝛼-th four-momentum component at the 𝐾𝑆 meson decay vertex.
Since the considered hypothesis contains two 𝜋− mesons, they are denoted as 𝜋−

= (2𝐸beam, 0). Constraint [𝑃 (1)

input

1 and 𝜋−
2 .

The solid edge corresponds to the initial particle, while the dashed edges correspond to its decay
products. Equation (7.1) in the case of the example shown in ﬁgure 1 takes the following form:

+ P (2)

−P (1)
input

output = 0.

output + P (3)
Figure 2 shows an example of the energy-momentum conservation constraint tree in the case of
the 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋−, 𝐾𝑠 → 𝜋+𝜋− hypothesis. Label 𝑒+𝑒− denotes the initial pseudo-particle (see
section 6.1) with the input four-momentum P (𝑒+𝑒−)
𝛼 ] ensures the
conservation of the 𝛼-th four-momentum component at the 𝑒+𝑒− interaction vertex, while constraint
[𝑃 (2)
𝛼 ] does this at the 𝐾𝑆 meson decay vertex. According to the tree shown in ﬁgure 2, the
intermediate particle 𝐾𝑆 is included in the four-momentum conservation constraints. In particular,
this particle is included in the energy conservation constraint, which leads to the fact that the
invariant mass of the decay products of this particle turns out to be ﬁxed on the 𝐾𝑆 meson mass
after the ﬁt.

input = (2𝐸beam, 0). Constraint [𝑃 (1)

Sometimes it becomes necessary to use a hypothesis in which the invariant mass of decay prod-
ucts is not ﬁxed after the ﬁt. This result can be achieved if the momentum conservation constraints
are applied to all particles, including intermediate ones, while the energy conservation constraint
is applied only to the initial and ﬁnal particles. Examples of energy-momentum conservation
constraint trees for such a hypothesis are shown in ﬁgure 3. This hypothesis corresponds to the
𝑒+𝑒− → 𝑋𝐾 +𝜋−, 𝑋 → 𝜋+𝜋− process, where particle 𝑋 is unknown13. Two trees are shown in the

13Particle 𝑋 is unknown in the sense that the value of its mass does not aﬀect the result of the ﬁtting. This property of

– 22 –

𝜋−
2

[ 𝑝 (2)
𝑘 ]

𝜋+

𝑋

𝑒+𝑒−

𝑋

𝐾+

[ 𝑝 (1)
𝑘 ]

𝜋−
1

𝑒+𝑒−

𝜋−
2

[𝐸 (3) ]

𝜋+

𝐾+

𝜋−
1

(a) Momentum conservation constraint tree.

(b) Energy conservation constraint tree.

Figure 3: The energy-momentum conservation constraint trees corresponding to the hypothesis
𝑒+𝑒− → 𝑋𝐾 +𝜋−, 𝑋 → 𝜋+𝜋−, where 𝑋 is unknown intermediate massive particle. Vertices [ 𝑝 (1)
𝑘 ]
and [ 𝑝 (2)
𝑘 ] of the ﬁrst tree represent the three-dimensional (𝑘 = 𝑥, 𝑦, 𝑧) momentum conservation
constraints at the 𝑒+𝑒− interaction vertex and at the 𝑋 decay vertex, respectively. This tree contains
all particles, including intermediate ones. Vertex [𝐸 (3) ] of the second tree corresponds to the
energy conservation constraint. This tree contains all particles except intermediate ones.

ﬁgure 3. The tree shown in Figure 3a describes how three momentum conservation constraints are
applied, while the tree in ﬁgure 3b describes how the energy conservation constraint is applied. A
example of using this hypothesis can be found in section 8.1.

7.2 Mass constraint

The mass constraint is used in order to require that the invariant mass of some set of particles be
equal to a certain value. This constraint can be written as follows:

P (𝑖)
output

∑︁

(cid:169)
(cid:173)
(cid:173)
𝑖 ∈F( 𝑗)
+
(cid:171)

2

(cid:170)
(cid:174)
(cid:174)
(cid:172)

− 𝑚2

target = 0,

(7.2)

where F( 𝑗)
+
and 𝑚target is the target value of the invariant mass.

is some set of particle indices, P (𝑖)

output is the output four-momentum of the 𝑖-th particle,

On the one hand, the introduction of mass constraint (7.2) is redundant, since the energy-
momentum conservation constraints 7.1 together with the use of intermediate particles 6.3 make
it possible to achieve the same result. Indeed, suppose that we are dealing with a hypothesis in

particle 𝑋 is determined not by its parametrization, but by the speciﬁc conﬁguration of energy-momentum conservation
constraints. As for the intermediate particle 𝐾𝑆, the parameterizations described in section 6.3.1 are used for particle 𝑋.
Thus, the particle 𝐾𝑆 can be used as a particle 𝑋. The designation 𝑋 is introduced only to emphasize that the mass of
such a particle does not aﬀect anything.

– 23 –

which the 𝜋0 meson decays into two photons. Since the 𝜋0 meson lifetime is short, the 𝜋0 meson
decay vertex is close to its origin vertex. The resolution of the (CMD-3) detector does not allow
distinguishing one vertex from another. Thus, in terms of the kinematic and vertex ﬁtting, the 𝜋0
meson decays at the origin vertex. In this case, the use of vertex constraints 7.3 for the intermediate
𝜋0 meson does not make sense. The parameter 𝜉 (𝑖) of the intermediate 𝜋0 meson will not be used
in this case and can be ﬁxed (see equation (6.7)). However, eight energy-momentum conservation
constraints can be imposed on the intermediate 𝜋0 meson in this case. Four constraints correspond
to the laws of energy-momentum conservation at the origin vertex, and four others correspond to
such laws at the decay vertex.

On the other hand, the use of four-momentum parametrizations from section (6.3) in the case
of short-lived intermediate particles is not justiﬁed because it leads to a senseless increase in the
number of minimization parameters. In addition to the parameters of the intermediate particle, eight
more Lagrange multipliers will be involved in the minimization procedure in this case. If, however,
a short-lived intermediate particle is not introduced directly and the mass constraint (7.2) is used,
then only one additional Lagrange multiplier corresponding to this constraint will be involved in
the minimization procedure. Thus, the conclusion is that in the case of short-lived intermediate
particles, it is better to use the mass constraint (7.2) if necessary.

7.3 Vertex constraints

Vertex constraints are used to require particle trajectories to pass through origin and decay vertices.
The vertex constraints that require a particle to ﬂy out of its origin vertex have the following form:

𝒓 (𝒊)
output − 𝒓origin = 0,

(7.3)

where 𝒓 (𝒊)
output is the parametrization of the output trajectory of the 𝑖-th particle, i.e. the trajectory
corresponding to the escape of 𝑖-th particle from its origin vertex 𝒓origin. The vertex constraints,
which require a particle to ﬂy to its decay vertex, can be written as follows:

𝒓 (𝒊)
input

− 𝒓decay = 0,

(7.4)

output is the parametrization of the input trajectory of the 𝑖-th particle, i.e.

where 𝒓 (𝒊)
along which the particle ﬂies into its decay vertex 𝒓decay.

the trajectory

Among all particle kinds discussed in section 6, there are particle kinds for which trajectories
are not deﬁned. Such particle kinds are the initial pseudo particle from section 6.1, the lost
particles from section 6.4, and the photon from section 6.2.2. However, it should be noted that
the photon ﬂies from its origin vertex to its conversion point according to the parametrization of
its momentum (6.4). For the ﬁnal charged particle 6.2.1, only the output trajectory (6.3) is given,
while for the intermediate charged particle 6.3.2, both the output (6.3) and input (6.10) trajectories
are given.
In the case of the discussed package of kinematic and vertex ﬁtting, only the input
trajectory (6.7) is speciﬁed for the neutral intermediate particle 6.3.1.

– 24 –

8 Examples

This section provides examples of applying the kinematic and vertex ﬁtting technique in various
hypotheses to the simulated14 events of various 𝑒+𝑒− annihilation processes. Hypotheses with
intermediate long-lived neutral particles (𝐾𝑆 mesons), hypotheses containing charged particles only,
hypotheses containing photons only, hypotheses containing both charged particles and photons, as
well as hypotheses with lost massive and massless particles are discussed in detail. The following
subsections present mainly the results of applying the ﬁtting algorithm under signal hypotheses.
However, in some cases, examples of the ﬁtting under background hypotheses are also given.

8.1 Hypotheses 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋−

8.1.1 Description of the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋− hypotheses

Section 8.1 presents the results of applying the package of kinematic and vertex ﬁtting under two
charged conjugate hypotheses 𝑒+𝑒− → 𝑋𝐾 +𝜋− and 𝑒+𝑒− → 𝑋𝐾 −𝜋+, where 𝑋 is an unknown
intermediate neutral particle decaying into two charged pions: 𝑋 → 𝜋+𝜋−. These hypotheses
were developed in order to select the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− process. The
particle 𝑋 is called unknown because the energy conservation constraints are not applied at the 𝑒+𝑒−
interaction vertex and the decay vertex. The energy conservation constraint is applied only to ﬁnal
and initial particles in these hypotheses. Therefore, the mass of the particle 𝑋 is not contained in the
Lagrange function (2.1) and, as a consequence, does not participate in the constrained minimization
of the chi-square function (1.2). For this reason, the invariant mass of the 𝑋 decay products,
calculated using parameters obtained from the ﬁtting is not ﬁxed (e.g. on the 𝐾𝑆 mass). For more
details, see sections 6.3.1, 7.1 and ﬁgure 3.

The hypotheses under discussion have the following structure.

• Each hypothesis has two vertices. The ﬁrst vertex is the 𝑒+𝑒− interaction vertex, the second
vertex is the decay vertex of the particle 𝑋. All coordinates of the 𝑋 decay vertex are free.
The 𝑥- and 𝑦- coordinates of the 𝑒+𝑒− interaction vertex are ﬁxed at the beam position, while
the 𝑧-coordinate of this vertex is free. However, it should be reminded that ﬁxing vertex
coordinates does not mean disabling the corresponding vertex constraints for particles. In
the case of the 𝑒+𝑒− interaction vertex, all vertex constraints related to this vertex are still
required.

• Hypothesis 𝑒+𝑒− → 𝑋𝐾 +𝜋−, 𝑋 → 𝜋+𝜋− requires the presence of four ﬁnal particles and one
intermediate particle 𝑋. The intermediate particle 𝑋 originates at the 𝑒+𝑒− interaction vertex
and decays at its decay vertex into two ﬁnal particles 𝜋+ and 𝜋−. Another ﬁnal 𝜋− comes from
the 𝑒+𝑒− interaction vertex. The ﬁnal 𝐾 + also originates at this vertex. The charge conjugate
hypothesis 𝑒+𝑒− → 𝑋𝐾 −𝜋+ diﬀers from the 𝑒+𝑒− → 𝑋𝐾 +𝜋− hypothesis in that 𝐾 − and 𝜋+
ﬂy from the 𝑒+𝑒− interaction region instead of 𝐾 + and 𝜋−. Both hypotheses also contain the
initial pseudo-particle that provides the 𝑒+𝑒− four-momentum (see section 6.1).

14By simulated events in this section, we mean the events of Monte Carlo simulation, which takes into account the

response of the CMD-3 detector.

– 25 –

Table 1: Mappings between charged particles and their tracks in the case of the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓
hypotheses. 1 — the 𝑒+𝑒− interaction vertex, 2 — the 𝑋 → 𝜋+𝜋− decay vertex, 𝑡+
2 are tracks
of positively charged particles, 𝑡−
2 are tracks of negatively charged particles.

1 and 𝑡−

1 and 𝑡+

Hypothesis
Origin vertex
Particle

Track com-
binations

𝑒+𝑒− → 𝑋𝐾 +𝜋−

𝑒+𝑒− → 𝑋𝐾 −𝜋+

1

2

1

2

𝐾 +
𝑡+
1
𝑡+
1
𝑡+
2
𝑡+
2

𝜋−
𝑡−
1
𝑡−
2
𝑡−
1
𝑡−
2

𝜋+
𝑡+
2
𝑡+
2
𝑡+
1
𝑡+
1

𝜋− 𝐾 −
𝑡−
𝑡−
1
2
𝑡−
𝑡−
1
1
𝑡−
𝑡−
2
2
𝑡−
𝑡−
2
1

𝜋+
𝑡+
1
𝑡+
2
𝑡+
1
𝑡+
2

𝜋+
𝑡+
2
𝑡+
1
𝑡+
2
𝑡+
1

𝜋−
𝑡−
2
𝑡−
2
𝑡−
1
𝑡−
1

• At each vertex, three-dimensional momentum conservation constraints are imposed.

In
total, each of two hypotheses has 6 constraints on the conservation of the three-dimensional
momentum components, i.e. three constraints per each vertex.

• Each hypothesis has only one energy conservation constraint. Only the ﬁnal particles and the

initial pseudo-particle are involved in this constraint.

• Each hypothesis requires three vertex constraints for each ﬁnal particle (one constraint for
each trajectory component). Three vertex constraints are also required for the intermediate
particle 𝑋. See, sections 6.2.1, 6.3.1 and 7.3 for more details. In total, each of two hypotheses
contains 15 vertex constraints.

In total, each of two discussed hypotheses contains 22 constraints. Each of the hypotheses contains
32 free parameters: 20 measurable and 12 non-measurable parameters.

8.1.2 Fitting procedure details
Further, the considered hypotheses are applied to the simulated events of the signal process 𝑒+𝑒− →
𝐾𝑆𝐾 ±𝜋∓ and the background process 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−. Only four-track events are used in order
to demonstrate how the ﬁtting works under the discussed hypotheses. Moreover, only such four
tracks are considered, which correspond to the total electric charge equal to zero. At the same time,
for demonstration purposes, the pre-separation of tracks into kaon and pion ones is not performed.
The presence of four charged particles implies the presence of combinatorics associated with the
fact that it is not known in advance which track from a certain event corresponds to one or another
charged particle. Therefore, it is necessary to perform a separate ﬁt for each mapping of particles
to their tracks. All possible variants of such mappings are given in table 1. The table shows for
each hypothesis there are four possible mappings of charged particles into tracks. Since it is not
known in advance which of the signal processes 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋− or 𝑒+𝑒− → 𝐾𝑆𝐾 −𝜋+ took place
in a particular event, in each event the ﬁt is performed in both hypotheses 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓. Thus,
in each event, the ﬁt is performed eight times.

In order to demonstrate how the ﬁtting works, for each hypothesis, among the four mappings
of particles to their tracks, the one in which the ﬁt gives the smallest chi-square is selected. Fits in
the charge conjugate hypotheses 𝑒+𝑒− → 𝑋𝐾 +𝜋− and 𝑒+𝑒− → 𝑋𝐾 −𝜋+ give the same chi-square

– 26 –

(a) Fit convergence histogram. The ﬁrst bin corre-
sponds to the number of the events, where at least
one of the ﬁts converged to a local minimum. The
second bin corresponds to the number of the events,
where none of the ﬁts converged. The third bin
corresponds to those events where among the con-
verging ﬁts there are only those that have converged
to a local maximum.

(b) Chi-square distribution. This distribution cor-
responds to events in which the ﬁtting procedure
has converged to a local minimum, i.e. events from
the ﬁrst bin of the histogram in ﬁgure 4a.

Figure 4: Fit convergence histogram (a) and chi-square distribution (b) for the for the simulated
𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events when ﬁtted to the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋− hypotheses.

distribution when applied to signal15 events. Therefore, among these hypotheses, the hypothesis
corresponding to the minimum chi-square is selected16. It should be noted that only those ﬁts that
have converged to a local minimum are accepted for consideration. If in the event none of the ﬁts
converged to a local minimum, then such an event is ignored.

8.1.3 Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events

This subsection presents the results of the ﬁtting the simulated 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events under the
𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋− hypotheses. The 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events were simulated at the
center-of-mass energy of 1792.9 MeV and the magnetic ﬁeld of 1 T. 21281 four-track events were
passed to the input of the kinematic and vertex ﬁtting procedure 8.1.2. Figure 4a shows a histogram
with the number of events where the ﬁtting procedure converged to a local minimum (ﬁrst bin),
where the ﬁtting procedure did not converge (second bin), and where ﬁtting procedure converged to
a local maximum (third bin). Further, histograms like this one are called ﬁt convergence histograms.
The histogram contains one entry per each event. If at least one of the ﬁts in the event converges
to a local minimum, then the event is included in the ﬁrst bin of the histogram.
If none of the
ﬁts converged, then the event included in the second bin. If among all converged ﬁts in the event
there are only those that converged to the local maximum, then the event is included in the second
bin. In the considered case, the ﬁrst bin contains 20794 events, the second bin contains 487 events,
and the third bin contains zero events. It should be noted that in 10374 out of 20794 events the
ﬁtting procedure converged to the 𝑒+𝑒− → 𝑋𝐾 +𝜋− hypothesis, i.e.
the minimum chi-square in

15The signal events for the 𝑒+𝑒− → 𝑋𝐾+𝜋− hypothesis are the events of the 𝑒+𝑒− → 𝐾𝑆 𝐾+𝜋− process, while the

signal events for the 𝑒+𝑒− → 𝑋𝐾−𝜋+ hypothesis are the events of the 𝑒+𝑒− → 𝐾𝑆 𝐾−𝜋+ process.

16Thus, among the results of eight ﬁts in each event, the result that corresponds to the minimum chi-square is accepted.

– 27 –

0123errorcode01000020000Entries21281Mean0.0229StdDev0.14950100200χ20500Entries20794Mean36.6562StdDev37.1907Figure 5: Invariant mass distributions of the intermediate particle decay products (𝑋 → 𝜋+𝜋−).
The distributions shown in the ﬁgure were obtained for the simulated events of the 𝑒+𝑒− →
𝐾𝑆𝐾 ±𝜋∓ process. The dashed line corresponds to the invariant mass distribution obtained using the
parameters found with the ﬁts under the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses. The solid line corresponds to
the invariant mass distribution obtained using the measured particle parameters, but the mappings
of the particles to their tracks were found using the ﬁtting procedure 8.1.2.

this hypothesis turned out to be less than in the 𝑒+𝑒− → 𝑋𝐾 −𝜋+ hypothesis. For the remaining
10420 events, the ﬁtting procedure converged to the 𝑒+𝑒− → 𝑋𝐾 −𝜋+ hypothesis. Further in this
subsection, we discuss only such distributions that correspond to events where at least one of the
ﬁts converged to a local minimum, i.e. to the ﬁrst bin of the histogram from ﬁgure 4a. For example,
ﬁgure 4b shows the chi-square distribution for events where the ﬁtting procedure 8.1.2 converged
to a local minimum.

Figure 5 shows the invariant mass distributions of the two pions from the 𝑋 → 𝜋+𝜋− decay. The
dashed line corresponds to the invariant mass distribution obtained using the particle parameters
found with the ﬁtting procedure 8.1.2. The solid line corresponds to the invariant mass distribution
obtained using the measured particle parameters, but the mappings of the particles to their tracks
were found with the ﬁtting procedure 8.1.2. It can be seen from the ﬁgure that the distribution
obtained using the particle parameters found with the ﬁtting procedure has a better resolution than
the distribution obtained using the measured particle parameters. The mean value of the invariant
mass for the both distributions is close to the 𝐾𝑆 meson invariant mass. It should be noted that
the simulation of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ process takes into account the initial state radiation (ISR).
Since the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses do not take into account the ISR, the invariant mass obtained
using the particle parameters found with the ﬁtting procedure is slightly biased.

Figure 6 shows the coordinates of the vertices found with the ﬁtting procedure 8.1.2. In this
ﬁgure, 𝑥1, 𝑦1 and 𝑧1 are the coordinates of the 𝑒+𝑒− interaction vertex, while 𝑥2, 𝑦2 and 𝑧2 are the
coordinates of the 𝑋 → 𝜋+𝜋− decay vertex. As already noted, the coordinates 𝑥1 and 𝑦1 of the 𝑒+𝑒−

– 28 –

0.400.450.500.550.60Mπ+π−(GeV/c2)0200400600Entries20794Mean0.4972StdDev0.0288Entries20794Mean0.5004StdDev0.0210beforeﬁtafterﬁtFigure 6: Distributions of vertex coordinates. These coordinates were found using the ﬁtting
procedure 8.1.2. The distributions correspond to the simulated 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events. 𝑥1, 𝑦1
and 𝑧1 are the 𝑒+𝑒− interaction vertex coordinates, while 𝑥2, 𝑦2 and 𝑧2 are the 𝑋 → 𝜋+𝜋− decay
vertex coordinates.

2

1

interaction vertex are ﬁxed at the beam position. All other vertex coordinates are free parameters.
In each event of the simulation, the coordinates of the 𝑒+𝑒− interaction vertex 𝒓sim

and the
𝑋 → 𝜋+𝜋− decay vertex 𝒓sim
are known. Since the coordinates of these vertices found using the
ﬁtting procedure are also known, it is possible to show the distributions of the diﬀerence between the
coordinates found using the ﬁtting and the coordinates from the simulation. These distributions are
shown in ﬁgure 7. Figure 7a shows the diﬀerence between the 𝑧-coordinate of the 𝑒+𝑒− interaction
vertex found using the ﬁtting procedure and the same coordinate from the simulation. Figure 7b
shows a similar diﬀerence in the 𝑧-coordinates of the 𝑋 → 𝜋+𝜋− decay vertex. Figures 7c and 7d
show the distributions of the similar diﬀerences in the 𝑥-coordinates and 𝑦-coordinates of the
𝑋 → 𝜋+𝜋− decay vertex, respectively. From ﬁgures 7a and 7b, one can conclude that the accuracy
of ﬁnding the 𝑧-coordinates of both vertices using the ﬁtting procedure is about 1 cm. At the
same time, it can be concluded from ﬁgures 7c and 7d that the accuracy of ﬁnding the 𝑥- and 𝑦-
coordinates of the 𝑋 → 𝜋+𝜋− decay vertex is about 1 mm. It should be noted that the coordinates
found using the ﬁtting procedure turned out to be unshifted, at least within their resolution.

Since the coordinates of both vertices are known, the distances between these vertices can

– 29 –

x1(cm)020000x2(cm)01000y1(cm)020000y2(cm)01000−10010z1(cm)0200−10010z2(cm)0200(a) The diﬀerence between the 𝑧-coordinate of the
𝑒+𝑒− interaction vertex found with the ﬁtting pro-
cedure and the same coordinate obtained from the
simulation.

(b) The diﬀerence between the 𝑧-coordinate of the
𝑋 → 𝜋+𝜋− decay vertex found with the ﬁtting pro-
cedure and the same coordinate obtained from the
simulation.

(c) The diﬀerence between the 𝑥-coordinate of the
𝑋 → 𝜋+𝜋− decay vertex found with the ﬁtting pro-
cedure and the same coordinate obtained from the
simulation.

(d) The diﬀerence between the 𝑦-coordinate of the
𝑋 → 𝜋+𝜋− decay vertex found with the ﬁtting pro-
cedure and the same coordinate obtained from the
simulation.

Figure 7: Distributions of the diﬀerences between the vertex coordinates found using the ﬁtting
procedure 8.1.2 and the vertex coordinates from the simulation. These distributions obtained for
the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ simulation.

2 − 𝒓ﬁt

1 be the interaction vertex found using the ﬁtting procedure, and 𝒓ﬁt

be calculated. Let 𝒓ﬁt
2 be the
𝑋 → 𝜋+𝜋− decay vertex also found using the same procedure. The distance between these vertices
is then calculated using the formula: Δ𝑟ﬁt = (cid:107) 𝒓ﬁt
1 (cid:107). Similarly, it is possible to calculate the
distance between these vertices obtained from the simulation: Δ𝑟sim = (cid:107) 𝒓sim
1 (cid:107). Figure 8
shows the distribution of the diﬀerence between the distances Δ𝑟ﬁt and Δ𝑟sim. It can be seen from
the ﬁgure that in the case of the CMD-3 experiment, the ﬁtting procedure makes it possible to ﬁnd
the distance between the vertices with an accuracy of about 3.5 mm. In fact, this accuracy is even
slightly better, since the distribution shown in the ﬁgure has non-Gaussian tails, which increase the
standard deviation. These tails can be signiﬁcantly suppressed by the chi-square selection criterion.
The distribution of the distance Δ𝑟ﬁt between the vertices is shown in ﬁgure 9a.

2 − 𝒓sim

The kinematic ﬁtting technique makes it possible to separate charged kaons from pions, since

– 30 –

−505∆z1(cm)05001000Entries20794Mean-0.0031StdDev0.9354−505∆z2(cm)0500Entries20794Mean-0.0087StdDev0.8838−0.50.00.5∆x2(cm)05001000Entries20794Mean0.0007StdDev0.1069−0.50.00.5∆y2(cm)05001000Entries20794Mean-0.0003StdDev0.1070Figure 8: Distribution of the diﬀerence Δ𝑟ﬁt−Δ𝑟sim for the simulated events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓
process. Δ𝑟ﬁt is the distance between the 𝑒+𝑒− interaction vertex and the 𝑋 → 𝜋+𝜋− decay vertex,
found using the ﬁtting procedure 8.1.2. Δ𝑟sim is the same distance obtained from the simulation.

the masses of these particles diﬀer signiﬁcantly. However, this technique does not allow achieving
the desired level of the 𝐾-𝜋 separation17. For example, in the case of ﬁtting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓
events under the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses, kaons and pions can be mixed up at the 𝑒+𝑒−
interaction vertex. These entanglements can be seen in ﬁgures 9b and 9c. The ﬁgures show the
dependencies of 𝑑𝐸/𝑑𝑥 on the particle momentum for those particles that the ﬁtting procedure
identiﬁed as kaons and pions. Figure 9b corresponds to particles that have been identiﬁed as kaons,
while ﬁgure 9c corresponds to pions.
In each of the ﬁgures, one can see typical dependencies
corresponding to both particle types (true kaons and pions). Figure 9d shows the dependence
of 𝑑𝐸/𝑑𝑥 on the particle momentum for those particles that were identiﬁed as pions from the
𝑋 → 𝜋+𝜋− decay. In this ﬁgure, one can see only a typical dependence corresponding to true pions.
Thus, we can conclude that in this case there is a signiﬁcant entanglement of kaons and pions at the
𝑒+𝑒− interaction vertex, while pions from the 𝑋 → 𝜋+𝜋− decay are not mixed up with kaons.

Figures 9e and 9f show histograms from which one can conclude about the proportion of
events in which the ﬁtting procedure 8.1.2 led to an incorrect signal hypothesis. The histogram
in ﬁgure 9e was obtained using the simulated 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋− events, while the histogram in
ﬁgure 9f was obtained using the simulated 𝑒+𝑒− → 𝐾𝑆𝐾 −𝜋+ events. Both histograms show the
number of events in which the ﬁtting procedure chose the 𝑒+𝑒− → 𝑋𝐾 +𝜋− hypothesis or the
𝑒+𝑒− → 𝑋𝐾 −𝜋+ hypothesis. The ﬁrst bin in both histograms corresponds to the number of events
for the 𝑒+𝑒− → 𝑋𝐾 +𝜋− hypothesis, while the second bin corresponds to the number of events for
the 𝑒+𝑒− → 𝑋𝐾 −𝜋+ hypothesis. In the case of the 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋− process, the correct signal
hypothesis is the 𝑒+𝑒− → 𝑋𝐾 +𝜋−. In the case of the 𝑒+𝑒− → 𝐾𝑆𝐾 −𝜋+ process, the correct signal
hypothesis is the 𝑒+𝑒− → 𝑋𝐾 −𝜋+. Both ﬁgures show that the ﬁtting procedure led to the correct

17At least when using the considered hypotheses.

– 31 –

−2−1012∆rﬁt−∆rsim(cm)02004006008001000Entries20794Mean0.0009StdDev0.3513(a) Distribution of the distance between the 𝑒+𝑒−
interaction vertex and the 𝑋 → 𝜋+𝜋− decay vertex.
The distance between the vertices was found using
the ﬁtting procedure.

(b) Dependence of 𝑑𝐸/𝑑𝑥 on the momentum of par-
ticles identiﬁed by the ﬁtting procedure as kaons.

(c) Dependence of 𝑑𝐸/𝑑𝑥 on the momentum of
particles identiﬁed by the ﬁtting procedure as pions
from the 𝑒+𝑒− interaction vertex.

(d) Dependence of 𝑑𝐸/𝑑𝑥 on the momentum of
particles identiﬁed by the ﬁtting procedure as pions
from the 𝑋 → 𝜋+𝜋− decay vertex.

(e) The ﬁrst bin is the number of events with the
best chi-square obtained with the 𝑒+𝑒− → 𝑋𝐾 +𝜋−
hypothesis, the second bin is the number of events
with the best chi-square obtained with the 𝑒+𝑒− →
𝑋𝐾 −𝜋+ hypothesis. The histograms corresponds to
the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋− process.

(f) The ﬁrst bin is the number of events with the
best chi-square obtained with the 𝑒+𝑒− → 𝑋𝐾 +𝜋−
hypothesis, the second bin is the number of events
with the best chi-square obtained with the 𝑒+𝑒− →
𝑋𝐾 −𝜋+ hypothesis. The histograms corresponds to
the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 −𝜋+ process.

Figure 9: Some distributions obtained as a result of applying the ﬁtting procedure 8.1.2 to the
simulated 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events. The units of 𝑑𝐸/𝑑𝑥 in ﬁgures (b), (c) and (d) are conditional.

– 32 –

051015∆rﬁt(cm)05001000Entries20794Mean2.1551StdDev2.10670.250.500.75P(GeV/c)50001000015000dE/dx(CU)0200.250.500.75P(GeV/c)50001000015000dE/dx(CU)010200.250.500.75P(GeV/c)50001000015000dE/dx(CU)01020012025005000Entries10318Mean0.3347StdDev0.4719012025005000Entries10476Mean0.6650StdDev0.4720(a) This histogram corresponds to the simulated
𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events in which the ﬁtting pro-
cedure 8.1.2 converged to the incorrect signal hy-
pothesis.

(b) This histogram corresponds to the simulated
𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events in which the ﬁtting proce-
dure 8.1.2 converged to the correct signal hypothe-
sis.

Figure 10: Invariant mass distributions of the intermediate particle decay products (𝑋 → 𝜋+𝜋−).
The distributions shown in the ﬁgure were obtained for the simulated events of the 𝑒+𝑒− →
𝐾𝑆𝐾 ±𝜋∓ process. The dashed line corresponds to the invariant mass distribution obtained using the
parameters found with the ﬁts under the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses. The solid line corresponds to
the invariant mass distribution obtained using the measured particle parameters, but the mappings
of the particles to their tracks were found using the ﬁtting procedure 8.1.2.

hypothesis in about 2/3 of the events, while in the rest of the events this procedure led to the wrong
hypothesis. Thus, one can see that the proportion of events with mixed up kaons and pions from
the 𝑒+𝑒− interaction vertex is quite large.

It should be noted that the entanglement of kaons and pions has a dramatic eﬀect on the
results of the ﬁtting procedure 8.1.2. This entanglement leads to a signiﬁcant distortion of the
ﬁtting parameters. In the considered case, not only the parameters of particles ﬂying from the 𝑒+𝑒−
interaction vertex are distorted, but also the parameters of pions from the 𝑋 → 𝜋+𝜋− decay vertex.
This happens because the parameters of diﬀerent particles are related through the constraints.
Figures 10a and 10b show the distributions of the invariant masses of pions from the 𝑋 → 𝜋+𝜋−
decay. Both ﬁgures were obtained using the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ simulation events. However,
ﬁgure 10a was obtained for events in which the ﬁtting procedure chose the wrong signal hypothesis,
and ﬁgure 10b corresponds to those events in which the signal hypothesis was chosen correctly. It
can be seen from these ﬁgures that the resolution of the invariant mass is signiﬁcantly worse if the
signal hypothesis was chosen incorrectly.

Thus, one can conclude that an additional 𝐾-𝜋 separation procedure is required to avoid the
entanglement of kaons and pions. This procedure may be based on the use of 𝑑𝐸/𝑑𝑥, for example.
The 𝐾-𝜋 separation procedure must be used before the kinematic and vertex ﬁtting. After performing
such a procedure, it will be known which tracks correspond to kaons with the highest probability.
Thus, in each event, one know the mapping of the kaon to its track. The sign of the kaon charge

– 33 –

0.40.50.6Mπ+π−(GeV/c2)0100200Entries6962Mean0.4939StdDev0.0334Entries6962Mean0.5001StdDev0.0285beforeﬁtafterﬁt0.40.50.6Mπ+π−(GeV/c2)0250500Entries13832Mean0.4987StdDev0.0264Entries13832Mean0.5005StdDev0.0164beforeﬁtafterﬁtdetermines the signal hypothesis that will be used for the ﬁtting in a certain event. As a result, the
number of ﬁts in a single event can be signiﬁcantly reduced. Instead of mappings from table 1, it
is enough to consider only permutations of tracks for the pions of the same charge, i.e. there will
be only two ﬁts per event. Among these two ﬁts, as in the case of ﬁtting procedure 8.1.2, one can
choose the ﬁt with the smallest chi-square.

In this work, we do not use any additional 𝐾-𝜋 separation procedure, but for demonstration
purposes we can use the fact that in each event of the simulation we know which of the ﬁnal states
𝐾𝑆𝐾 +𝜋− or 𝐾𝑆𝐾 −𝜋+ occurred. Thus, it is possible to run ﬁtting procedure for each event of the
𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ simulation under the right signal hypothesis. For a given signal hypothesis, it
is necessary to consider only four mappings from table 1, i.e. do four ﬁts in each event. Using
the correct signal hypothesis in each event eliminates the entanglement of kaons and pions at the
𝑒+𝑒− interaction vertex. Taking into account that there is also no entanglement of kaons and pions
from the 𝑋 → 𝜋+𝜋− decay (see ﬁgure 9d), it can be obtained that with this approach there is no
entanglement of kaons and pions. The ﬁtting procedure in this case converges to a local minimum in
20519 events out of 21281, i.e. in most events where the wrong hypothesis was previously chosen,
there was a ﬁt under the correct hypothesis with a slightly larger chi-square. The ﬁt convergence
histogram corresponding to the considered approach is shown in ﬁgure 11a. The corresponding
chi-square distribution is shown in ﬁgure 11b. In this case, the distribution of the distance between
the vertices does not change signiﬁcantly and is shown in ﬁgure 11c. To conﬁrm that kaons and
pions are not mixed up, ﬁgures 11d, 11e, and 11f show the dependencies of 𝑑𝐸/𝑑𝑥 on the particle
momentum, similar to those shown in ﬁgures 9b, 9c, and 9d, respectively. Figure 12 shows the
distributions of the invariant mass of pions from the 𝑋 → 𝜋+𝜋− decay. Unlike ﬁgure 5, ﬁgure 12
was obtained by ﬁtting each simulation event using the correct signal hypothesis only. It can be
seen from ﬁgure 12 that the distribution of the invariant mass obtained using the pion parameters
after ﬁtting has somewhat changed compared to the similar distribution shown in ﬁgure 5 (see
dashed line). So the left slope of the peak became steeper, and the peak itself is slightly higher,
which indicates a slight increase in mass resolution. However, the distribution in ﬁgure 12 has
non-Gaussian tails, as in the case of a similar distribution in ﬁgure 5, which leads to the fact that
the standard deviations for the histograms in both ﬁgures are the same.

8.1.4 Fitting the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events

This subsection provides an example of applying the ﬁtting procedure 8.1.2 under the 𝑒+𝑒− →
𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋− hypotheses to the simulated 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events. The process 𝑒+𝑒− →
𝜋+𝜋−𝜋+𝜋− is one of the main background processes in the study of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ process
with the CMD-3 detector. It should be noted that the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− process does not contain
charged kaons in the ﬁnal state and, therefore, is also a background process with respect to the
𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses.

Figure 13a shows the ﬁt convergence histogram for the events of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−
simulation. It can be seen from the ﬁgure that the ﬁtting procedure in most events converged to
a local minimum. Note, however, that in this case the ﬁtting procedure 8.1.2 does not have to
converge to a local minimum, since the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− is the background process for the
𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses.

– 34 –

(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

(c) Distribution of the distance between the 𝑒+𝑒−
interaction vertex and the 𝑋 → 𝜋+𝜋− decay vertex.

(d) Dependence of 𝑑𝐸/𝑑𝑥 on the momentum of par-
ticles identiﬁed by the ﬁtting procedure as kaons.

(e) Dependence of 𝑑𝐸/𝑑𝑥 on the momentum of
particles identiﬁed by the ﬁtting procedure as pions
from the 𝑒+𝑒− interaction vertex.

(f) Dependence of 𝑑𝐸/𝑑𝑥 on the momentum of
particles identiﬁed by the ﬁtting procedure as pions
from the 𝑋 → 𝜋+𝜋− decay vertex.

Figure 11: Some distributions obtained as a result of applying the ﬁtting procedure to the events
of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ simulation. Each event was ﬁtted only using the correct signal hypothesis
(𝑒+𝑒− → 𝑋𝐾 +𝜋− or 𝑒+𝑒− → 𝑋𝐾 −𝜋+), i.e. the hypothesis determined from the simulation.

– 35 –

0123errorcode01000020000Entries21281Mean0.0358StdDev0.18580100200χ20500Entries20519Mean37.1324StdDev37.4666051015∆rﬁt(cm)05001000Entries21281Mean2.1091StdDev2.05270.250.500.75P(GeV/c)50001000015000dE/dx(CU)0200.250.500.75P(GeV/c)50001000015000dE/dx(CU)01020300.250.500.75P(GeV/c)50001000015000dE/dx(CU)01020Figure 12: Invariant mass distributions of the intermediate particle decay products (𝑋 → 𝜋+𝜋−).
The distributions shown in the ﬁgure were obtained for the simulated events of the 𝑒+𝑒− →
𝐾𝑆𝐾 ±𝜋∓ process. The dashed line corresponds to the invariant mass distribution obtained using the
parameters found with the ﬁts under the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses. The solid line corresponds to
the invariant mass distribution obtained using the measured particle parameters, but the mappings
of the particles to their tracks were found using the ﬁtting procedure. In the case of this ﬁgure, in
each event only the correct signal hypothesis (𝑒+𝑒− → 𝑋𝐾 +𝜋− or 𝑒+𝑒− → 𝑋𝐾 −𝜋+) is used, i.e. the
hypothesis determined from the simulation.

(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 13: Fit convergence histogram (a) and chi-square distribution (b) obtained by applying the
ﬁtting procedure 8.1.2 to the simulated 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events.

– 36 –

0.400.450.500.550.60Mπ+π−(GeV/c2)0200400600Entries20519Mean0.4970StdDev0.0286Entries20519Mean0.5033StdDev0.0210beforeﬁtafterﬁt0123errorcode02000040000Entries44160Mean0.0203StdDev0.14100200400600χ20500Entries43264Mean219.7339StdDev114.8120Figure 14: Distribution of the distance between the 𝑒+𝑒− interaction vertex and the 𝑋 → 𝜋+𝜋−
decay vertex, obtained as a result of applying the ﬁtting procedure 8.1.2 to the simulated 𝑒+𝑒− →
𝜋+𝜋−𝜋+𝜋− events.

Figure 13b shows the chi-square distribution obtained by applying the ﬁtting procedure to the
events of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− simulation. Since the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− is the background
process with respect to the considered hypotheses, the chi-square distribution turned out to be wide
(compare with ﬁgure 4b).

Figure 14 shows the distribution of the distance Δ𝑟ﬁt between the 𝑒+𝑒− interaction vertex and
the 𝑋 → 𝜋+𝜋− decay vertex. The distribution was obtained for the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events using
the ﬁtting procedure 8.1.2. The distance is calculated using the vertex coordinates found as a result
of the ﬁtting. Since in the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− process all pions originate from the 𝑒+𝑒− interaction
vertex, the large Δ𝑟ﬁt distances are not expected. Indeed, it can be seen from the ﬁgure that most of
the events belong to region Δ𝑟ﬁt (cid:46) 4 mm.

Finally, we can conclude that the chi-square and Δ𝑟ﬁt distributions can be successfully used
to select the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ process and suppress the corresponding background
processes, such as the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− process.

8.2 Hypotheses 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋−

8.2.1 Description of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ hypotheses

In section 8.2 we present the results of ﬁtting under 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− hypotheses.
The diﬀerence between section 8.1 and this section is that in this section the intermediate neutral
particle (𝐾𝑆) is known. By the fact that the intermediate particle is known, we mean that this particle
directly participates in the energy conservation constraints, i.e. its mass inﬂuences the ﬁtting results.
The energy-momentum conservation constraint tree corresponding to the 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋−, 𝐾𝑆 →
𝜋+𝜋− hypothesis has the form shown in ﬁgure 2. For the charge-conjugate hypothesis, there is
a similar tree, but with oppositely charged particles. Thus, energy conservation constraints are

– 37 –

0.00.20.40.60.81.0∆rﬁt(cm)025050075010001250Entries44160Mean0.2465StdDev0.1868(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 15: Fit convergence histogram (a) and chi-square distribution (b) obtained using the ﬁtting
procedure under the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− hypotheses. Both histograms correspond to
the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ simulation.

imposed in each of the two vertices and include all particles related with one or another vertex.
This is the only diﬀerence between the hypotheses 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ and 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ (see
subsection 8.1.1).

The ﬁtting procedure with the 𝑒+𝑒− → 𝐾𝑆𝐾 +𝜋− hypotheses is completely similar to the
ﬁtting procedure 8.1.2 with the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses. This procedure does not contain any
additional 𝐾-𝜋 pre-separation algorithm and is used for demonstration purposes only.

Subsections 8.2.2 and 8.2.3 show the results of the ﬁtting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events and the

events of the background process 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−.

8.2.2 Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events

This subsection discusses the results of applying the ﬁtting procedure under the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓
hypotheses to the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ process. Since the ﬁtting with the 𝑒+𝑒− →
𝐾𝑆𝐾 ±𝜋∓ hypotheses imposes tighter constraints than the ﬁtting with the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypothe-
ses, it is expected that in this case the ﬁtting procedure will converge to a local minimum less often.
This fact can be observed from the ﬁt convergence histogram shown in ﬁgure 15a. This ﬁgure
was obtained under conditions similar to those in ﬁgure 4a, but corresponds to the ﬁtting under the
𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ hypotheses. Figure 15a indeed shows that the ﬁtting procedure converged to a
local minimum for fewer events than in the case of ﬁgure 4a, which corresponds to the ﬁtting under
the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses.

Figure 15b shows the chi-square distribution for the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ simulation.
This distribution corresponds to the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ hypotheses. Figure 15b shows that the
distribution has become slightly wider than in the case of ﬁgure 4b. This is due to the fact that
in the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ hypotheses there is one more energy conservation constraint than in the
𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses.

Figure 16 shows the two-pion invariant mass distribution. Only pions from the 𝐾𝑆 → 𝜋+𝜋−
decay are taken into account. As in the case of ﬁgure 5, the solid line denotes the invariant mass dis-
tribution obtained using the measured pion parameters, however, pions from the 𝐾𝑆 → 𝜋+𝜋− decay

– 38 –

0123errorcode01000020000Entries21281Mean0.0286StdDev0.16670100200χ20250500Entries20672Mean39.5536StdDev38.2701Figure 16: Invariant mass distributions of the intermediate particle decay products (𝐾𝑆 → 𝜋+𝜋−).
The distributions shown in the ﬁgure were obtained for the simulated events of the 𝑒+𝑒− →
𝐾𝑆𝐾 ±𝜋∓ process. The dashed line corresponds to the invariant mass distribution obtained using the
parameters found with the ﬁts under the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ hypotheses. The solid line corresponds
to the invariant mass distribution obtained using the measured particle parameters, but the mappings
of the particles to their tracks were found using the ﬁtting procedure.

were found using the ﬁtting procedure. The dashed line indicates the invariant mass distribution
obtained using the pion parameters found with the ﬁtting procedure. Since the intermediate particle
(𝐾𝑆) in the considered hypotheses has a certain mass and participates in the energy conservation
constraints, the last distribution turned out to be ﬁxed on the value of this mass.

8.2.3 Fitting the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events

This subsection discusses the results of applying the ﬁtting procedure under the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓
hypotheses to the simulated events of the background process 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−. Figure 17a shows
the corresponding ﬁt convergence histogram, while ﬁgure 17b shows the chi-square distribution.
Since the background events are considered, the last distribution turned out to be much wider than
the similar distribution for the signal events shown in ﬁgure 15b. The chi-square distribution is
even broader than the similar distribution for the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events corresponding to the
𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses and shown in ﬁgure 13b. The last statement is due to the fact that the
𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ contain more constraints than the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓ hypotheses.

Figure 18 shows the distance Δ𝑟ﬁt between the 𝑒+𝑒− interaction vertex and the 𝐾𝑆 → 𝜋+𝜋−
decay vertex. As in the case of similar distributions in ﬁgures 9a and 14, this distribution was
obtained using the coordinates of the vertices found with the ﬁtting procedure. Since in this case
the ﬁtting under the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ is applied to the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events, the distances
in ﬁgure 18 is on average smaller than in ﬁgure 9a. However, these distances are larger than in
ﬁgure 14, which also corresponds to the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events, but with the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓

– 39 –

0.20.30.40.50.60.70.8Mπ+π−(GeV/c2)100101102103104Entries20672Mean0.4960StdDev0.0503Entries20672Mean0.4976StdDev0.0000beforeﬁtafterﬁt(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 17: Fit convergence histogram (a) and chi-square distribution (b) obtained using the ﬁtting
procedure under the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− hypotheses. Both histograms correspond to
the events of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− simulation.

Figure 18: Distribution of the distance Δ𝑟ﬁt between the interaction vertex and the 𝐾𝑆 → 𝜋+𝜋−
decay vertex obtained for the events of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− simulation. The vertex coordinates
were found using the ﬁtting procedure under the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− hypotheses.

hypotheses. This means that in the case of using a hypothesis similar to the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓,
the selection criterion on the Δ𝑟ﬁt is probably less eﬀective than in hypotheses with an unknown
intermediate particle.

8.3 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−

8.3.1 Description of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− hypothesis

Section 8.3 presents the results of applying the ﬁtting package under the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−
hypothesis. This hypothesis has the following structure.

– 40 –

0123errorcode02000040000Entries44160Mean0.0503StdDev0.21850100020003000χ20500Entries41940Mean948.4322StdDev747.64530.00.51.01.52.02.53.0∆rﬁt(cm)025050075010001250Entries44160Mean0.6278StdDev0.6166• The hypothesis has a single vertex. This vertex is the 𝑒+𝑒− interaction vertex. The 𝑥- and 𝑦-
coordinates of this vertex are ﬁxed at the beam position, while the 𝑧-coordinate of this vertex
is free.

• The hypothesis contains four ﬁnal particles. These particles are charged pions. The con-
sidered hypothesis requires also the initial pseudo-particle 6.1 in order to provide total
four-momentum of the initial particles (𝑒+𝑒−).

• All of the particles listed above are involved in four energy-momentum conservation con-

straints.

• Each charged pion has three vertex constraints. In total, the hypothesis contains 12 vertex

constraints.

In total, the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− hypothesis contains 16 constraints. This hypothesis contains 25
free parameters: 20 measurable and 5 non-measurable parameters.

8.3.2 Fitting procedure details

Further, the considered hypothesis is applied to the simulated events of the signal process 𝑒+𝑒− →
𝜋+𝜋−𝜋+𝜋− and the background process 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋−. As in section 8.1,
only four-track events are used in order to demonstrate how the ﬁtting works under the discussed
hypothesis. Moreover, only such four tracks are considered, which correspond to the total electric
In the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− hypothesis, particles of the same charge are
charge equal to zero.
equivalent, so only a single mapping of particles into their tracks is considered. Thus, only one ﬁt
is done in each event.

Almost all ﬁgures in subsections 8.3.3 and 8.3.4 correspond to events in which the ﬁtting
procedure converged to a local minimum . As in the previous sections, the ﬁt convergence histograms
are an exception. These histograms were obtained for all events in which the ﬁtting procedure was
applied.

8.3.3 Fitting the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− events

This subsection discusses the result of applying the ﬁtting procedure under the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−
hypothesis to the events of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− simulation. These events were simulated at the
same center-of-mass energy and magnetic ﬁeld as the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋−
simulation (see section 8.1.3). The ﬁtting procedure converged to a local minimum in 44715 events
out of 45022. In 47 events, this procedure converged to a local maximum, while in the remaining
260 events, the ﬁt did not converge. The corresponding ﬁt convergence histogram is shown in
ﬁgure 19a, while the chi-square distribution is shown in ﬁgure 19b.

Figure 20a shows the distribution of the 𝑧-coordinate of the 𝑒+𝑒− interaction vertex found with
the ﬁtting procedure. As expected, this distribution is similar to the one shown in ﬁgure 6. Figure 20
shows the distribution of the diﬀerence between the 𝑧-coordinate of the interaction vertex found
with the ﬁtting procedure and the same coordinate obtained from the simulation. As in the case of
a similar 𝑧-coordinate distribution shown in ﬁgure 7a, the accuracy of obtaining the 𝑧-coordinate
using the ﬁtting procedure in this case is also about 1 cm.

– 41 –

(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 19: Fit convergence histogram (a) and chi-square distribution (b) obtained using the ﬁtting
procedure under the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− hypothesis. Both histograms correspond to the events of
the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− simulation.

(a) Distribution of the 𝑧-coordinate of the 𝑒+𝑒− in-
teraction vertex found with the ﬁtting procedure.

(b) Distribution of the diﬀerence between the 𝑧-
coordinate of the 𝑒+𝑒− interaction vertex found us-
ing the ﬁtting procedure and the same coordinate
obtained from the simulation.

Figure 20: Distributions related with the 𝑧-coordinate of the 𝑒+𝑒− interaction vertex. Both dis-
tributions were obtained using the ﬁtting procedure under the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− hypothesis and
correspond to the events of the same process.

8.3.4 Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ events

In this subsection, we discuss the results of applying the ﬁtting procedure under the 𝑒+𝑒− →
𝜋+𝜋−𝜋+𝜋− hypothesis to the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− simulation. The
corresponding ﬁt convergence histogram shown in ﬁgure 21a. The 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ is the
background process with respect to the considered hypothesis. For this reason, the corresponding
chi-square distribution shown in ﬁgure 21b is much wider than the similar distribution shown in
ﬁgure 19b. Finally, one can conclude that the chi-squared distributions in ﬁgures 19b and 21b, as
well as the distributions in ﬁgures 4b and 13b, can be used to separate the events of the processes
𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− and 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋−.

– 42 –

0123errorcode02000040000Entries45022Mean0.0079StdDev0.09940100200χ201000Entries44715Mean39.7767StdDev35.5282−10010z(cm)010002000Entries44715Mean-0.0033StdDev2.8757−505∆z(cm)01000Entries44715Mean-0.0037StdDev0.9659(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 21: Fit convergence histogram (a) and chi-square distribution (b) obtained using the ﬁtting
procedure under the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋− hypothesis. Both histograms correspond to the events of
the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓ simulation.

8.4 Hypothesis 𝑒+𝑒− → 𝛾𝛾𝛾

8.4.1 Description of the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis

In section 8.4, we present the results of applying the kinematic and vertex ﬁtting package under the
𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis to the events of the 𝑒+𝑒− → 𝜋0𝛾, 𝜋0 → 𝛾𝛾 simulation. The 𝑒+𝑒− → 𝛾𝛾𝛾
hypothesis has the following form.

• The hypothesis contains a single vertex. This vertex is the 𝑒+𝑒− interaction vertex. The 𝑥-
and 𝑦- coordinates of this vertex are ﬁxed at the beam position, while the 𝑧-coordinate of this
vertex is free.

• The hypothesis contains three ﬁnal particles. These particles are photons 6.2.2. The hypoth-
esis contains also the initial pseudo-particle 6.1, which is used in order to provide the total
four-momentum of the initial particles (𝑒+𝑒−).

• All of the above particles are involved in four energy-momentum conservation constraints.

• The vertex constraints 7.3 are not imposed on the photons, because the photons are already
emitted from the origin vertex due to the parametrization of their momentum (6.4). An
important note about this hypothesis is that for a ﬁxed position of the beam axis, three
photons are suﬃcient to restore the 𝑧-coordinate of the 𝑒+𝑒− vertex using the kinematic ﬁtting
technique.

In total, the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis contains 4 constraints. This hypothesis contains 13 free
parameters. Among these parameters, there are 12 measurable parameters and one non-measurable
parameter.

8.4.2 Fitting the 𝑒+𝑒− → 𝜋0𝛾 events
In this subsection, we discuss the results of the ﬁtting the simulated 𝑒+𝑒− → 𝜋0𝛾, 𝜋0 → 𝛾𝛾 events
under the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis. It should be noted that for the demonstration purposes only

– 43 –

0123errorcode0500010000Entries12399Mean0.0341StdDev0.1932010002000χ20200400Entries12003Mean786.4002StdDev621.9858(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 22: Fit convergence histogram (a) and chi-square distribution (b) obtained using the ﬁtting
procedure under the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis. Both histograms correspond to the events of the
𝑒+𝑒− → 𝜋0𝛾 simulation.

Figure 23: Two-photon invariant mass distribution for the 𝑒+𝑒− → 𝜋0𝛾 events. The dashed line
corresponds to the invariant mass distribution obtained using the photon parameters found with the
ﬁtting procedure under the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis. The solid line corresponds to the invariant
mass distribution obtained using the measured photon parameters.

events with three photon clusters in the calorimeter are considered. Thus, since all three photons
are equivalent, there is a single mapping of photons to their clusters, i.e. only one ﬁt is performed
in each event. Figure 22a shows the ﬁt convergence histogram corresponding to this section, while
ﬁgure 22b shows the chi-square distribution. It can be seen from ﬁgure 22a that in this case, all the
ﬁts converged to a local minimum.

Figure 23 shows histograms with the two-photon invariant mass distributions. The histogram
indicated by the solid line is obtained using the measured photon parameters, and the histogram in-

– 44 –

0123errorcode050000Entries75086Mean0.0000StdDev0.00000102030χ201000Entries75086Mean4.4909StdDev4.94430.00.20.40.60.8Mγγ(GeV/c2)0200040006000800010000Entries225258Mean0.3857StdDev0.2301Entries225258Mean0.3895StdDev0.2292beforeﬁtafterﬁt(a) Distribution of the 𝑧-coordinate of the 𝑒+𝑒− in-
teraction vertex found with the ﬁtting procedure.

(b) Distribution of the diﬀerence between the 𝑧-
coordinate of the 𝑒+𝑒− interaction vertex found us-
ing the ﬁtting procedure and the same coordinate
obtained from the simulation.

Figure 24: Distributions related with the 𝑧-coordinate of the 𝑒+𝑒− interaction vertex. Both distribu-
tions were obtained using the ﬁtting procedure under the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis and correspond
to the events of the 𝑒+𝑒− → 𝜋0𝛾 process.

dicated by the dashed line is obtained using the photon parameters found using the ﬁtting procedure.
These histograms are shown for the reason that we would like to see a pion peak on them. Since
in the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis, it is unknown which photons are the pion decay products, these
histograms contain the invariant masses of all diﬀerent photon pairs, i.e. each histogram has three
entries per event. Thus, in these histograms, in addition to the pion peak, there is a contribution
from the combinatorial background. It is seen from the ﬁgure that the ﬁtting procedure signiﬁcantly
improves the two-photon invariant mass resolution.

Figure 24a shows the distribution of the 𝑧-coordinate of the 𝑒+𝑒− interaction vertex. This
coordinate is found using the ﬁtting procedure. It can be seen from the ﬁgure that this distribution is
the same as the similar distributions shown in ﬁgures 6 and 20a, but obtained with other hypotheses.
Figure 24 shows the distribution of the diﬀerence between the 𝑧-coordinate of the interaction vertex
found using the ﬁtting procedure and the same coordinate obtained from the simulation. The
accuracy of obtaining the 𝑧-coordinate in this case is slightly worse than in the case of hypotheses
with charged particles, but this accuracy is still on the order of 1 cm.

The hypothesis 𝑒+𝑒− → 𝛾𝛾𝛾 is quite simple. In this hypothesis, the energy-momentum conser-
vation constraints are imposed only at one vertex, and there are no direct vertex constraints. Let us
show how the energy-momentum conservation constraints hold. Figure 25 shows the distributions
of the left-hand sides of the energy-momentum conservation constraints (7.1). The solid lines indi-
cate the distributions obtained using the measured particle parameters. The dashed lines denote the
distributions obtained using the particle parameters found with the ﬁtting procedure. The dashed
distributions are ﬁxed at zero, i.e. energy-momentum conservation constraints are satisﬁed with
high accuracy. Similar distributions for the energy-momentum conservation constraints, as well as
for vertex constraints, can also be shown in the case of more complex hypotheses. However, in this
paper, we restrict ourselves to the distributions shown in ﬁgure 25.

– 45 –

−10010z(cm)02000Entries75086Mean0.0623StdDev2.7620−505∆z(cm)02000Entries75086Mean-0.0098StdDev1.1857(a) Total 𝑝 𝑥.

(b) Total 𝑝 𝑦.

(c) Total 𝑝𝑧.

(d) Total energy.

Figure 25: Distributions demonstrating the fulﬁllment of the energy-momentum conservation
constraints the case of the 𝑒+𝑒− → 𝛾𝛾𝛾 hypothesis. The distributions are obtained for the events
of the 𝑒+𝑒− → 𝜋0𝛾 simulation. The solid line in the ﬁgures denotes the components of the
total four-momentum obtained using the measured particle parameters. The dashed line denotes the
components of the total four-momentum obtained using the particle parameters found with the ﬁtting
procedure. By total four-momentum we mean the diﬀerence between the total four-momentum of
the ﬁnal and initial particles, i.e. the left-hand side of equation (7.1).

– 46 –

01ptotx(GeV/c)102105Entries75086Mean0.0017StdDev0.0359Entries75086Mean0.0000StdDev0.0000beforeﬁtafterﬁt01ptoty(GeV/c)102105Entries75086Mean0.0004StdDev0.0357Entries75086Mean-0.0000StdDev0.0000beforeﬁtafterﬁt−1012ptotz(GeV/c)102105Entries75086Mean0.0014StdDev0.0584Entries75086Mean0.0000StdDev0.0000beforeﬁtafterﬁt−1012Etot(GeV)102105Entries75086Mean-0.0026StdDev0.0630Entries75086Mean0.0000StdDev0.0000beforeﬁtafterﬁt8.5 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾

8.5.1 Description of the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis

Section 8.5.1 discusses the results of applying kinematic and vertex ﬁtting under the 𝑒+𝑒− →
𝜋+𝜋−𝛾𝛾 hypothesis. This hypothesis has the following form.

• The hypothesis has a single vertex, which is the 𝑒+𝑒− interaction vertex. The 𝑥- and 𝑦-
coordinates of the 𝑒+𝑒− interaction vertex are ﬁxed at the beam position, while the 𝑧-coordinate
of this vertex is free.

• The hypothesis requires the presence of four ﬁnal particles and one initial pseudo-particle 6.1.
The list of ﬁnal particles consists of two photons 6.2.2 and two oppositely charged pions 6.2.1.

• There are four constraints on the energy-momentum conservation in the hypothesis. All

particles are involved into these constraints.

• Three vertex constraints are imposed on each charged particle. No vertex constraints are im-
posed on the photons, because the photons already ﬂy out of the vertex due to the parametriza-
tion of their momenta.

In total, the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis contains 10 constraints. This hypothesis contains
21 free parameters. Among these parameters, 18 parameters are measurable and 3 parameters are
non-measurable.

8.5.2 Fitting the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 events

In this subsection we present the results of applying the ﬁtting package to the events of the 𝑒+𝑒− →
𝜋+𝜋−𝜂, 𝜂 → 𝛾𝛾 simulation. For demonstration purposes, only those events are passed to the input
of the ﬁtting procedure, in which there are at least two photon clusters in the calorimeter. If there
are only two photon clusters in an event, then a single ﬁt is performed in this event. If the number
of photon clusters is more than two, then separate ﬁts are performed for each diﬀerent mapping
of photons to their clusters. Permutations of two photon clusters in each pair are not considered,
because they do not aﬀect the ﬁtting result.

The ﬁtting procedure in the considered case converges in 23602 out of 25629 events passed
to the input of this procedure. In 1952 events, the ﬁtting procedure does not converge, while in
75 events it converges to a local maximum. The corresponding ﬁt convergence histogram and
chi-square distribution are shown in ﬁgures 26a and 26b, respectively.

The ﬁtting procedure signiﬁcantly improves the resolution in the two-photon invariant mass.
The distributions of the two-photon invariant mass are shown in ﬁgure 26c. As usual, the distribution
indicated by the solid line was obtained using the measured particle parameters, but the mappings
of photons to their clusters were found using the ﬁtting procedure. The distribution indicated by
the dashed line was obtained using the particle parameters found with the ﬁtting procedure.

It should be noted that there is no signiﬁcant improvement in the two-pion invariant mass. This
is due the fact that the dominant intermediate state in the 𝑒+𝑒− → 𝜂𝜋+𝜋− process is the 𝜂𝜌(770),
the two ﬁnal pions are the 𝜌(770) → 𝜋+𝜋− decay products. The width of the 𝜌(770) is
i.e.
approximately 149 MeV, which gives a lower limit to the typical width of the two-pion invariant

– 47 –

(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

(c) Two-photon invariant mass.

(d) Two-pion invariant mass.

Figure 26: Some results of applying the ﬁtting procedure to the events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 →
𝛾𝛾 simulation under the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis.

mass distribution. The two-pion invariant mass distributions can be seen in ﬁgure 26d. There
are two distributions in the ﬁgure. One distribution is indicated by a solid line, while the other is
indicated by a dashed line. The meaning of the diﬀerent line styles is the same as in the case of the
two-photon invariant mass distributions shown in ﬁgure 26c.

8.6 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾lost

In this section, we present the results of ﬁtting the events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾
simulation under the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾lost hypothesis. The diﬀerence between the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾
and 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾lost hypotheses is that in the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾lost hypothesis one of the photons
is lost. The lost photon is represented as the massless lost particle 6.4.2.

For demonstration purposes, we consider all events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 simulation
containing at least one photon cluster. Thus, even if there are clusters for both photons in an event,
only one photon cluster is ﬁnally taken into account. Events containing at least one photon cluster
are passed to the input of the ﬁtting procedure. Further, in the ﬁtting procedure, each photon cluster
is matched in turn to the detected photon. For each mapping of the detected photon to its cluster,

– 48 –

0123errorcode01000020000Entries25629Mean0.0820StdDev0.2849050100χ20500Entries23602Mean23.1428StdDev23.80340.00.51.0Mγγ(GeV/c2)05001000Entries23602Mean0.5375StdDev0.1057Entries23602Mean0.5753StdDev0.1022beforeﬁtafterﬁt0.00.51.01.5Mπ+π−(GeV/c2)02000Entries23602Mean0.7683StdDev0.1271Entries23602Mean0.7763StdDev0.1192beforeﬁtafterﬁt(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

(c) Two-photon invariant mass.

(d) Two-pion invariant mass.

Figure 27: Some results of applying the ﬁtting procedure to the events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 →
𝛾𝛾 simulation under the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾lost hypothesis.

a separate ﬁt is performed. Finally, in each event, such a mapping of the detected photon to the
photon cluster is chosen that leads to the smallest chi-square.

The ﬁtting procedure converges in 25684 events out of 25786 events passed to it. In 38 events,
the ﬁtting procedure converges to a local maximum, while in 64 events this procedure does not
converge. The corresponding ﬁt convergence histogram and chi-square distribution are shown in
ﬁgures 27a and 27b, respectively.

Figure 27c shows the distributions of the two-photon invariant mass. Since one of the photons
is lost in the considered hypothesis, the ﬁtting leads to a smaller improvement in the resolution
of the two-photon invariant mass than in the case of 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis (see ﬁgure 26c
for comparison). Figure 27d shows the distributions of the two-pion invariant mass. For the
reasons described in section 8.5.2, the ﬁtting procedure does not lead to signiﬁcant changes in the
distribution of this mass. The description of the distributions in ﬁgures 27c and 27d is the same as
in the case of ﬁgures 26c and 26d, respectively. The last two ﬁgures are described in section 8.5.2.

– 49 –

0123errorcode01000020000Entries25786Mean0.0054StdDev0.091402040χ20500Entries25684Mean5.2336StdDev6.13630.00.51.0Mγγ(GeV/c2)0500Entries25684Mean0.5801StdDev0.1285Entries25684Mean0.5955StdDev0.1343beforeﬁtafterﬁt0.00.51.01.5Mπ+π−(GeV/c2)02000Entries25684Mean0.7677StdDev0.1262Entries25684Mean0.7642StdDev0.1149beforeﬁtafterﬁt8.7 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0

lost

8.7.1 Description of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0

lost hypothesis

As an example of a hypothesis involving a lost massive particle, let us consider the 𝑒+𝑒− →
𝜋+𝜋−𝜋+𝜋−𝜋0

lost hypothesis. This hypothesis has the following structure.

• The hypothesis has a single vertex. This vertex is the 𝑒+𝑒− interaction vertex. The 𝑥- and 𝑦-
coordinates of this vertex are ﬁxed at the beam position, while the 𝑧-coordinate of this vertex
is free.

• The hypothesis contain ﬁve ﬁnal particles. The four ﬁnal particles are charged pions 6.2.1,
and the ﬁfth particle is a lost 𝜋0. This 𝜋0 is represented as the lost massive particle 6.4.1.
In order to provide the four-momentum of initial particles, the hypothesis also contains the
initial pseudo-particle 6.1.

• All of the particles listed above are involved in four energy-momentum conservation con-

straints.

• Each charged pion has three vertex constraints. In total, the hypothesis contains 12 vertex

constraints.

In total, the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0
lost hypothesis contains 16 constraints. This hypothesis contains
28 free parameters. Among these parameters, 20 parameters are measurable and 8 parameters are
non-measurable.

8.7.2 Fitting procedure details

The ﬁtting procedure in the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0
lost hypothesis is quite simple. For demonstration
purposes, only events with four tracks are passed to the input of this procedure. Moreover, these
tracks must correspond to a neutral combination of charged particles. Since pions of the same
charge are equivalent in this hypothesis, it makes sense to consider a single mapping of these pions
into their tracks. Thus, only one ﬁt is performed in each event. It is important to note that in order
for the point of initial optimization parameters to lie closer to the conditional minimum point, the
initial momentum of the lost 𝜋0 is set equal to the initial missing momentum of four charged pions.

8.7.3 Fitting the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0 events

In this subsection, we present the results of applying the ﬁtting procedure 8.7.2 to the events of the
𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0 → 𝜋+𝜋−𝛾𝛾 simulation. For demonstration purposes, we completely
ignore the information about the presence of photons, i.e. even if photons from the 𝜋0 → 𝛾𝛾 decay
were detected, we still consider the neutral pion to be lost. The ﬁtting procedure converged in
12665 events out of 12796 events passed to its input. This procedure converged to a local maximum
in 43 events and did not converge in 88 events. The corresponding ﬁt convergence histogram and
chi-square distribution are shown in ﬁgures 28a and 28b, respectively.

Since the decay 𝜂 → 𝜋+𝜋−𝜋0 occurs in the considered process, the three-pion (𝜋+𝜋−𝜋0
lost)
invariant mass distribution should have a peak corresponding to the 𝜂-meson. Despite the fact that
the hypothesis with the lost particle is considered, the ﬁtting under this hypothesis allows one to

– 50 –

(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 28: Fit convergence histogram (a) and chi-square distribution (b) obtained by applying the
ﬁtting procedure 8.7.2 to the events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0, 𝜋0 → 𝛾𝛾 simulation.

Figure 29: Three-pion invariant mass distributions obtained for the events of the 𝑒+𝑒− →
𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0, 𝜋0 → 𝛾𝛾 simulation. The histogram indicated by the solid line was
obtained using the measured particle parameters. The histogram indicated by the dashed line was
obtained using the particle parameters found with the ﬁtting procedure 8.7.2. Both histograms have
four entries per event, corresponding to the number of diﬀerent 𝜋+𝜋−𝜋0 combinations.

signiﬁcantly improve the resolution of the three-pion invariant mass near the 𝜂-meson peak. The
distributions of the three-pion invariant mass are shown in ﬁgure 29. The dashed line, as usual,
denotes the distribution of the invariant mass obtained using the parameters found with the ﬁtting
procedure. The solid line denotes the invariant mass distribution obtained using the measured
particle parameters. In this case, since the momentum of the lost neutral pion is not measured,
the missing momentum of the four charged pions is used instead. In the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0
lost
hypothesis, there is no diﬀerence between charged pions of the same sign. Therefore, there are

– 51 –

0123errorcode0500010000Entries12796Mean0.0136StdDev0.1419050100χ20250500Entries12665Mean22.9099StdDev23.87790.500.751.001.251.501.75Mπ+π−π0(GeV/c2)050010001500Entries50660Mean0.9343StdDev0.2876Entries50660Mean0.9531StdDev0.2896beforeﬁtafterﬁtTable 2: Mappings between charged particles and their tracks in the case of the 𝑒+𝑒− →
𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0
1 and
𝑡−
2 are tracks of negatively charged particles.

2 are tracks of positively charged particles, 𝑡−

lost hypothesis.

1 and 𝑡+
𝑡+

Intermediate particle
Final particle

Track com-
binations

𝜋0

lost

𝜋+
𝑡+
1
𝑡+
1
𝑡+
2
𝑡+
2

𝜋−
𝑡−
1
𝑡−
2
𝑡−
1
𝑡−
2

𝜋+
𝑡+
2
𝑡+
2
𝑡+
1
𝑡+
1

𝜂
𝜋−
𝑡−
2
𝑡−
1
𝑡−
2
𝑡−
1

four diﬀerent neutral three-pion 𝜋+𝜋−𝜋0 combinations corresponding to diﬀerent charged pions.
The histograms shown in ﬁgure 29 are ﬁlled with invariant masses corresponding to all such
combinations. Thus, these histograms have four entries per event.

8.8 Hypothesis 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0

lost

8.8.1 Description of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0

lost hypothesis

In section 8.8, we discuss the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0
lost hypothesis. It should be noted that
in this hypothesis the 𝜂-meson is not explicitly contained in the form of an intermediate particle.
This is due to its short life time. The presence of a short-lived intermediate particle in this case is
emulated by the mass constraint (7.2). Thus, this hypothesis is a good example of how the mass
constraint works. In this case, the mass constraint is imposed on the invariant mass of three pions
(𝜋+𝜋−𝜋0) in order to require that this invariant mass be equal to the mass of the 𝜂-meson. In other
aspects, the structure of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0
lost hypothesis coincides with the structure
of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0
lost hypothesis. A detailed description of the 𝑒+𝑒− → 𝜋+𝜋−𝜋+𝜋−𝜋0
lost
hypothesis can be found in section 8.7.1.

8.8.2 Fitting procedure details

Due to the presence of the mass constraint, charged pions are not equivalent in the 𝑒+𝑒− →
𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0
lost hypothesis. This is due to the fact that only two charged pions are involved
in this constraint. Therefore, the ﬁtting procedure under the considered hypothesis must take into
account diﬀerent mappings of charged pions into their tracks. Only four-track events are passed to
the input of the ﬁtting procedure. Thus, there are four possible mappings of four charged pions into
their tracks, i.e. four ﬁts are performed in each event. These mappings are listed in table 2.

8.8.3 Fitting the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−𝜋0 events

The ﬁtting procedure described above is applied to the events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 →
𝜋+𝜋−𝜋0, 𝜋0 → 𝛾𝛾 simulation. As in section 8.7.3, information about detected photons is com-
pletely ignored in this example. The ﬁtting procedure converged to a local minimum in 12722 events
out of 12796. This procedure converged to a local maximum in 14 events and did not converge in
60 events. The corresponding ﬁt convergence histogram and chi-square distribution are shown in
ﬁgures 30a and 30b, respectively.

– 52 –

(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

Figure 30: Fit convergence histogram (a) and chi-square distribution (b) obtained by applying the
ﬁtting procedure 8.8.2 to the events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝜋+𝜋−, 𝜋0 → 𝛾𝛾 simulation.

Figure 31: Three-pion invariant mass distributions obtained for the events of the 𝑒+𝑒− →
𝜂𝜋+𝜋, 𝜂 → 𝜋+𝜋−𝜋0, 𝜋0 → 𝛾𝛾 simulation. The histogram indicated by the solid line was ob-
tained using the measured particle parameters, but the mappings of charged pions to their tracks
were found using a ﬁtting procedure 8.8.2. The histogram indicated by the dashed line was obtained
using the particle parameters found with the ﬁtting procedure 8.8.2. Both histograms have one
entry per event.

– 53 –

0123errorcode0500010000Entries12796Mean0.0069StdDev0.0950050100χ20200400Entries12722Mean24.0050StdDev24.09030.40.60.81.01.21.4Mπ+π−π0(GeV/c2)100101102103104Entries12722Mean0.5884StdDev0.1000Entries12722Mean0.5479StdDev0.0000beforeﬁtafterﬁtFigure 31 shows the distributions of the three-pion invariant mass. These three pions are the
𝜂 → 𝜋+𝜋−𝜋0 decay products. The distribution indicated by the dashed line was obtained using the
particle parameters found with the ﬁtting procedure. This distribution turned out to be ﬁxed on the
𝜂-meson mass, since the corresponding mass constraint is used in the hypothesis. The distribution
indicated by the solid line was obtained using the measured particle parameters, but the mappings
of charged pions into their tracks were found with the ﬁtting procedure. To obtain this distribution,
the momentum of the lost neutral pion was set equal to the missing momentum of four charged
pions. The histograms in ﬁgure 31 contain only one entry per event.

8.9 Hypothesis 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋−

8.9.1 Description of the 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis

The 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis is an example of a three-vertex hypothesis. As in
the previous sections, by particle 𝑋 we mean a long-lived intermediate particle with an unknown
mass. This hypothesis is a signal hypothesis for the 𝑒+𝑒− → 𝐾𝑆𝐾𝑆 𝜋+𝜋−, 𝐾𝑆 → 𝜋+𝜋− events, for
example. The structure of this hypothesis is the following.

• The hypothesis has three vertices. The ﬁrst vertex is the 𝑒+𝑒− interaction vertex, the other
two vertices are the 𝑋-particle decay vertices. All coordinates of the 𝑋 decay vertices are
free. The 𝑥- and 𝑦- coordinates of the 𝑒+𝑒− interaction vertex are ﬁxed at the beam position,
while the 𝑧-coordinate of this vertex is free.

• The 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis contains six ﬁnal particles, two intermediate
neutral particles 6.3.1 and an initial pseudo-particle 6.1. The ﬁnal particles are charged pions.
The parametrizations of four-momentum and trajectory of a charged particle can be found in
section 6.2.1.

• At each vertex, three-dimensional momentum conservation constraints are imposed. In total,

the hypothesis contains 9 constraints related to conservation of momentum.

• The hypothesis contains a single energy conservation constraint. Only the ﬁnal particles and

the initial pseudo-particle are involved in this constraint.

• Three separate vertex constraints are imposed to each ﬁnal pion and each intermediate particle.

So the hypothesis contains 24 vertex constraints.

In total, the 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis contains 34 constraints. This hypothesis
contains 39 free parameters. Among these parameters, 20 parameters are measurable and 19
parameters are non-measurable.

8.9.2 Fitting procedure details

For demonstration purposes, only six-track events are passed to the input of the ﬁtting procedure
under the 𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis. In these events, all possible mappings of
charged pions into their tracks are considered. For each mapping, a separate ﬁt is performed. The
number of diﬀerent mappings of the ﬁnal pions into their tracks in the considered hypothesis is
18. These mappings are shown in table 3. The considered hypothesis clearly shows that as the

– 54 –

Table 3: Mappings between charged particles and their tracks in the case of the 𝑒+𝑒− →
𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis. 1 — the 𝑒+𝑒− interaction vertex, 2 and 3 — the 𝑋 → 𝜋+𝜋−
decay vertices, 𝑡+
1,2,3 are tracks of negatively charged
particles.

1,2,3 are tracks of positively charged particles, 𝑡−

Origin vertex
Final particle

Track com-
binations

1

2

3

1

2

3

𝜋+
𝑡+
1
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
2

𝜋−
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
3
𝑡−
3
𝑡−
3

𝜋+
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
2
𝑡+
1
𝑡+
3

𝜋−
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
1
𝑡−
1
𝑡−
1

𝜋+
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
3
𝑡+
2
𝑡+
1

𝜋−
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
2
𝑡−
2
𝑡−
2

𝜋+
𝑡+
1
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
2

𝜋−
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
2

𝜋+
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
3
𝑡+
2
𝑡+
1

𝜋−
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
3
𝑡−
3

𝜋+
𝑡+
2
𝑡+
1
𝑡+
3
𝑡+
3
𝑡+
2
𝑡+
1
𝑡+
2
𝑡+
1
𝑡+
3

𝜋−
𝑡−
2
𝑡−
2
𝑡−
2
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
1
𝑡−
1

number of particles and vertices increases, the number of ﬁts per event increases dramatically.
This increase leads to a signiﬁcant slowdown in the ﬁtting procedure. Therefore, in such or more
complex hypotheses, before the ﬁtting procedure, it may be necessary to perform some preliminary
procedure that reduces the number of track permutations. This procedure can be based on the
analysis of track parameters. With the help of such a preliminary procedure, one can make an
approximate conclusion about whether a certain pair of tracks originates from the same vertex or
not. In this work, we do not use such a preliminary procedure. Instead, we consider all mappings
from table 3 for demonstration purposes, i.e. perform 18 ﬁts per event.

8.9.3 Fitting the 𝑒+𝑒− → 𝐾𝑆𝐾𝑆 𝜋+𝜋−, 𝐾𝑆 → 𝜋+𝜋− events

Let us present the results of applying the ﬁtting procedure 8.9.2 to the events of the 𝑒+𝑒− →
𝐾𝑆𝐾𝑆 𝜋+𝜋− process, where both 𝐾𝑆-mesons decay into two charged pions. As noted above, the
𝑒+𝑒− → 𝑋 𝑋 𝜋+𝜋−, 𝑋 → 𝜋+𝜋− hypothesis is a signal hypothesis for the considered process.
The ﬁtting procedure converges to a local minimum in 9002 events out of 9194. This procedure
converges to a local maximum in 16 events and does not converge in 176 events. The corresponding
ﬁt convergence histogram and chi-square distribution are shown in ﬁgures 32a and 32b, respectively.
Figure 32c shows the invariant mass distributions of the decay products of the ﬁrst intermediate
particle. Similar invariant-mass distributions corresponding to the decay products of the second
intermediate particle are shown in ﬁgure 32d. The solid line in these ﬁgures denotes the distributions
obtained using the measured particle parameters, but the mappings of charged pions into their tracks
were found with the ﬁtting procedure. The dashed line denotes the invariant mass distributions
obtained using the particle parameters found with the ﬁtting procedure. It can be seen from both
ﬁgures that the use of the ﬁtting procedure leads to an improvement in the resolution of the invariant
mass.

Figure 33a shows the distribution of the distance between the 𝑒+𝑒− interaction vertex and the

– 55 –

(a) Fit convergence histogram. See description in
ﬁgure 4a.

(b) Chi-square distribution.

(c) Two-pion invariant mass distributions. These
two pions are the decay products of the ﬁrst inter-
mediate particle. The histogram indicated by the
solid line was obtained using the measured parti-
cle parameters, but the mappings of charged par-
ticles into their tracks were found using the ﬁtting
procedure 8.9.2. The histogram indicated by the
dashed line was obtained using the particle param-
eters found with this ﬁtting procedure.

(d) Two-pion invariant mass distributions. These
two pions are the decay products of the second
intermediate particle. Diﬀerent line styles have the
same meaning as in ﬁgure 32c.

Figure 32: Some results of applying the ﬁtting procedure 8.9.2 to the events of the 𝑒+𝑒− →
𝐾𝑆𝐾𝑆 𝜋+𝜋−, 𝐾𝑆 → 𝜋+𝜋− simulation.

decay vertex of the ﬁrst intermediate particle. Figure 33b shows a similar distribution corresponding
to the second intermediate particle. In both cases, the vertex coordinates were found using the ﬁtting
procedure. These distributions are similar to those shown in some of the previous examples (see
ﬁgure 9a, for example).

– 56 –

0123errorcode05000Entries9194Mean0.0226StdDev0.16000100200χ20200400Entries9002Mean50.3013StdDev51.72820.40.50.6Mπ+π−(GeV/c2)0250500Entries9002Mean0.4969StdDev0.0256Entries9002Mean0.4978StdDev0.0216beforeﬁtafterﬁt0.40.50.6Mπ+π−(GeV/c2)0200400Entries9002Mean0.4966StdDev0.0260Entries9002Mean0.4977StdDev0.0220beforeﬁtafterﬁt(a) Distance between the 𝑒+𝑒− interaction vertex
and the decay vertex of the ﬁrst intermediate parti-
cle.

(b) Distance between the 𝑒+𝑒− interaction vertex
and the decay vertex of the second intermediate
particle.

Figure 33: Distances between the 𝑒+𝑒− interaction vertex and the decay vertex of one of the
intermediate particles. The vertex coordinates are found with the ﬁtting procedure 8.9.2.

9 Examples of Gaussian simulation

In this section, we discuss kinematic and vertex ﬁtting of events obtained using Gaussian simula-
tion 4.1. Subsection 9.1 provides examples of Gaussian simulations of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾
process. The events of these simulations are ﬁtted under the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis. Subsec-
tion 9.2 provides examples of Gaussian simulations of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− process.
The events of these simulations are ﬁtted under the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋− hypotheses.

The event of the corresponding Monte Carlo simulation was chosen as the initial event for
each of Gaussian simulations discussed in this section. The examples in this section are of interest
for testing the ﬁtting package, as well as for observing how constraint non-linearity distorts the 𝜒2
distribution.

9.1 Hypothesis 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾

This subsection presents the results of ﬁtting the events of the Gaussian simulation of the 𝑒+𝑒− →
𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 process. As the initial event, a certain event of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾
Monte Carlo simulation is chosen. It should be noted that the same Monte Carlo simulation is used
as in section 8.5.2. The ﬁtting procedure under the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis 8.5.1 was applied
once to the initial event. This procedure made it possible to obtain measurable particle parameters
satisfying the constraints. Then the initial event was redeﬁned: the measured parameters of the
particles were replaced by the corresponding parameters obtained with the ﬁtting procedure (see
section 4.1). Then these parameters were drawn multiple times according to the corresponding
multivariate normal distribution. As a result of such draws, the Gaussian simulation events were
obtained. These events were ﬁtted under the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis. The ﬁgure 34 shows
the 𝜒2 distribution for the events of this Gaussian simulation. This distribution corresponds to
the case when all constraints are enabled in the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis. A list of these
constraints is given in section 34. The hypothesis contains 𝑚 = 10 constraints and 𝑙 = 3 free
non-measurable parameters. If all constraints were linear, one would expect the 𝜒2 distribution to

– 57 –

0510∆rﬁt(cm)0250500Entries9002Mean1.2541StdDev1.39090510∆rﬁt(cm)0250500Entries9002Mean1.2491StdDev1.4061Figure 34: Chi-square distribution in the case of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 Gaussian simulation.
The events of this simulation were ﬁtted under the 𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis 8.5.1. All the
constraints corresponding to this hypothesis were enabled. The solid line is the 𝜒2 histogram, and
the dashed line is the ﬁtting function.

be described by the chi-square probability density function (4.1) with 𝑚 − 𝑙 = 7 degrees of freedom
(see section 4.2.2). However, all the constraints of the considered hypothesis are nonlinear. Despite
this, the 𝜒2 distribution is well described by the chi-square probability density function. This
statement was veriﬁed by ﬁtting the distribution to a probability density function (4.1) multiplied
by the normalization factor 𝑏𝑁, where 𝑏 is the bin width of the 𝜒2 histogram and 𝑁 is the number
of events in the Gaussian simulation. In the ﬁtting function, the number degrees of freedom and 𝑁
are considered as free parameters. The 𝜒2 histogram in ﬁgure 34 is indicated by a solid line, while
the ﬁtting function is indicated by a dashed line. The ﬁtting parameters are shown in the ﬁgure in
the dashed box. The ﬁtting function indeed describes the histogram well. The number of degrees
found with the ﬁt is 6.9974 ± 0.0035, i.e. it is equal to 7 with good accuracy.

To estimate the magnitude of the non-linearity of the constraints, one can obtain the distribution
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚, where ˆ𝑄 is the ˆ𝑄𝑠−1 from equations (2.8) and (2.9) calculated after
of the quadratic form 1
the minimization is completed. As noted above, the matrix ˆ𝑄 contains the constraint Hessians. In
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚
the case of linear constraints, this matrix is zero. The distribution of the quadratic form 1
is shown in ﬁgure 35a. This distribution was obtained under the conditions described in the
previous paragraph.
It can be seen from the ﬁgure that the mean value of the quadratic form
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 is approximately equal to zero, while its standard deviation is approximately equal to
1
0.4. From equation (2.8) it is clear that in order to estimate the magnitude of the non-linearity of the
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 should be compared with the chi-square 𝜒2 = Δ𝒙(cid:124) ˆ𝐶−1Δ𝒙.
constraints, the quadratic form 1
The corresponding two-dimensional histogram is shown in ﬁgure 35b. It can be seen from the ﬁgure
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 is always several times less than the chi-square. It is shown below
that the quadratic form 1
that in those cases where the non-linearity of the constraints leads to a signiﬁcant distortion of the

– 58 –

051015202530χ205000100001500020000Entries1000000Mean6.9764StdDev3.6847N999880±1001NDFparameter6.9974±0.0035χ2/NDF134.4366/126(a) Distribution of the quadratic form 1

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚.

(b) Two-dimensional distribution:
𝜒2.

1

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 vs

Figure 35: Figures showing the non-linearity of constraints. These ﬁgures correspond to the
events of the 𝑒+𝑒− → 𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 Gaussian simulation. These events were ﬁtted under
𝑒+𝑒− → 𝜋+𝜋−𝛾𝛾 hypothesis 8.5.1. All constraints of this hypothesis were enabled.

chi-square distribution, the 1

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 distribution is signiﬁcantly wider.
The 𝜒2 distributions similar to those shown in ﬁgure 34 can be obtained when some of the
constraints are disabled while ﬁtting the events of the Gaussian simulation. So, for example,
ﬁgure 36a shows the distribution in the case when the energy conservation constraint is disabled.
Figure 36b shows the 𝜒2 distribution in the case when the energy conservation and 𝑧-momentum
conservation constraints are disabled. Figure 36c shows the 𝜒2 distribution in the case when the
energy, 𝑥-momentum, and 𝑦-momentum conservation constraints are disabled. Finally, ﬁgure 36d
shows the distribution in the case when all four-momentum conservation constraints are disabled.
If the constraints were linear, one would expect the listed distributions to follow the chi-square
distribution (4.1) with 𝑚 − 𝑙 degrees of freedom. Despite the fact that the constraints are nonlinear,
the distributions in ﬁgures 36a, 36b and 36c correspond to the probability density function (4.1). The
number of degrees of freedom in these cases is 6, 5 and 4, respectively. In the case of ﬁgure (36d),
the chi-square distribution is less well described by a probability density function (4.1). The ratio
𝜒2/NDF ≈ 180.7/125 obtained by ﬁtting this distribution is large. Despite this, the ﬁtting function
visually describes the 𝜒2 histogram. The number of degrees of freedom found with the ﬁtting is
the same as 𝑚 − 𝑙 and equal to 3.

As mentioned above, a certain single event of the 𝑒+𝑒− → 𝜋+𝜋−𝜂, 𝜂 → 𝛾𝛾 Monte Carlo
simulation was chosen as the initial event. However, it should be noted that the ﬁtting results given
in this subsection do not depend on the choice of the initial event. However, in cases where the
non-linearity of the constraints can manifest itself strongly, the results of the Gaussian simulation
can signiﬁcantly depend on the choice of the initial event. Such a case is described in detail in the
next subsection.

9.2 Hypotheses 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋−

This subsection discuss the ﬁtting results corresponds to a number of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓,
𝐾𝑆 → 𝜋+𝜋− Gaussian simulations. Each Gaussian simulation corresponds to diﬀerent initial
events. As in the previous subsection, the events of the corresponding Monte Carlo simulation

– 59 –

0512∆y⊺ˆQ∆y01000020000Entries1000000Mean0.0108StdDev0.41651020χ2−2.50.02.512∆y⊺ˆQ∆y0.0001.0672.1333.2004.2675.3336.4007.467(a) The energy conservation constraint is disabled.

(b) The energy and 𝑧-momentum conservation con-
straints are disabled.

(c) The energy, 𝑥- and 𝑦-momentum conservation
constraints are disabled.

(d) All four-momentum conservation constraints
are disabled.

Figure 36: Chi-square distributions. These distributions correspond to the events of the 𝑒+𝑒− →
𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 Gaussian simulation. The events of this simulation were ﬁtted under the 𝑒+𝑒− →
𝜋+𝜋−𝛾𝛾 hypothesis 8.5.1. During the ﬁtting, some constraints were disabled. The solid line
indicates the 𝜒2 histogram, while the dashed line indicates the ﬁtting function, similar to that used
in ﬁgure 34. The parameters of the ﬁtting functions, as well as the ﬁt quality ratios 𝜒2/NDF, are
shown in the dashed boxes.

– 60 –

0102030χ201000020000Entries1000000Mean5.9883StdDev3.4343N999886±1000NDFparameter5.9968±0.0032χ2/NDF137.1225/1260102030χ2020000Entries1000000Mean4.9958StdDev3.1499N999834±1000NDFparameter4.9981±0.0029χ2/NDF125.3302/1260102030χ2020000Entries1000000Mean3.9974StdDev2.8215N999504±999NDFparameter4.0012±0.0025χ2/NDF146.5867/1260102030χ202000040000Entries1000000Mean2.9994StdDev2.4499N997930±998NDFparameter3.0097±0.0021χ2/NDF180.7732/125(a) A case of the Gaussian simulation based on one
of the Monte Carlo simulation events.

(b) A case of the Gaussian simulation based on
another Monte Carlo simulation event.

(c) A case of the Gaussian simulation based on the
third event of the Monte Carlo simulation.

(d) A case of the Gaussian simulation based on all
Monte Carlo simulation events.

Figure 37: Chi-square distributions corresponding to the events of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 →
𝜋+𝜋− Gaussian simulations. These events were ﬁtted under the correct signal hypothesis: 𝑒+𝑒− →
𝑋𝐾 +𝜋−, 𝑋 → 𝜋+𝜋− or 𝑒+𝑒− → 𝑋𝐾 −𝜋+, 𝑋 → 𝜋+𝜋−. The 𝜒2 histogram is indicated by a solid line,
while the dashed line is the ﬁtting function. This ﬁtting function is proportional to the probability
density function (4.1) of the chi-square distribution from statistics. The ﬁtting function describes
the histogram well only in ﬁgure (a).

– 61 –

0204060χ202000040000Entries999981Mean10.0255StdDev4.4837N999893±1000NDFparameter10.0209±0.0043χ2/NDF91.5048/810204060χ2020000Entries998666Mean16.4860StdDev10.6346N788678±888NDFparameter13.0698±0.0101χ2/NDF205727.0004/1260200400χ2050000Entries989308Mean66.6045StdDev71.7267N337402±581NDFparameter16.9579±0.0317χ2/NDF640779.8118/126050100150χ20500Entries20533Mean22.8963StdDev25.5822N13671±117NDFparameter11.4774±0.0568χ2/NDF5102.2019/253(see section 8.1.3) were used as these initial events. Further, to obtain the events of each Gaussian
simulation, a procedure similar to that described in the ﬁrst paragraph of the previous subsection
was performed. However, in this case, one of the 𝑒+𝑒− → 𝑋𝐾 ±𝜋∓, 𝑋 → 𝜋+𝜋− hypotheses is used,
while ﬁtting the simulated events. Moreover, when ﬁtting each simulation event, only the correct
signal hypothesis is used to avoid mixing of kaons and pions.

Figure 37a shows the 𝜒2 distribution corresponding to the events of the ﬁrst Gaussian simula-
tion. The parameters of the particles and their covariance matrices in the corresponding initial event
are such that the eﬀects of the constraints non-linearity are not large enough to lead to a signiﬁcant
distortion of the chi-square distribution. It is seen from the ﬁgure that the 𝜒2 histogram is well
described by the probability density function (4.1). Moreover, the number of degrees of freedom is
equal to 10, as expected.

In the case of a Gaussian simulation obtained using another initial event, the parameters of the
particles in this initial event turned out to be such that they led to signiﬁcant non-linearity eﬀects.
The corresponding 𝜒2 histogram is shown in ﬁgure 37b. It can be seen from the ﬁgure that this
histogram is not described by the probability density function 4.1.

Figure 37c shows the 𝜒2 histogram for an even more dramatic case than in ﬁgure 37b. This
ﬁgure corresponds to the events of the third Gaussian simulation obtained using a third initial event
diﬀerent from the ﬁrst two. In this case, the distribution is much wider than in ﬁgures 37a and 37b.
This distribution is not described by the probability density function (4.1).

Although the non-linearity of the constraints tends to a wider chi-square distribution, even
in the worst case shown in ﬁgure 37c, the 𝜒2 distribution peaks at 𝜒2 ∼ 10. Comparing this
distribution with the 𝜒2 distribution shown in ﬁgure 13b and obtained for background events, one
can conclude that even in the worst case, signal and background events can be separated using a
chi-square selection criterion. However, it is clear that the separation power is the smaller, the wider
the signal 𝜒2 distribution.

In connection with the above, the question arises, what is the ratio between the number of
events in the Monte Carlo simulation, leading to the distributions in ﬁgure 37a and ﬁgures 37b, 37c.
This question can be answered using a slightly diﬀerent kind of Gaussian simulation than the one
described above. Instead of doing a Gaussian simulation based on a single Monte Carlo simulation
event, let us draw one Gaussian simulation event for each event of the Monte Carlo simulation. The
𝜒2 distribution corresponding to such a Gaussian simulation is shown in ﬁgure 37d. Although this
distribution is not consistent with the probability density function (4.1), it can be concluded that
the Monte Carlo simulation is dominated by events that correspond to distributions in ﬁgures 37a
and 37b.

Figure 38a shows the 1

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 distribution. This distribution corresponds to the Gaussian
simulation in the case of ﬁgure 37a. As in the case of ﬁgure 35a, the peak of this distribution is
approximately at zero. The standard deviation is equal to 1.6, which is about four times greater
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚
than in the case of ﬁgure 35a. Figure 38b shows the two-dimensional distribution of the 1
versus the 𝜒2. This distribution is similar to that shown in ﬁgure 35b in the case of the 𝑒+𝑒− →
𝜂𝜋+𝜋−, 𝜂 → 𝛾𝛾 Gaussian simulation.

Figure 39 shows distributions similar to those shown in ﬁgure 38, but corresponds to the case of
the second and third Gaussian simulations, i.e. ﬁgures 37b and 37c, respectively. Figure 39a shows
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 distribution for the events of the second Gaussian simulation. The standard deviation
the 1

– 62 –

(a) Distribution of the quadratic form 1

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚.

(b) Two-dimensional distribution:
𝜒2.

1

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 vs

Figure 38: Figures showing the nonlinearity of constraints. These ﬁgures correspond to the events
of the 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− Gaussian simulation. This Gaussian simulation corresponds
to the case of the 𝜒2 distribution shown in ﬁgure 37a.

(a) Distribution of the quadratic form 1
the case of the second Gaussian simulation.

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 in

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 vs
(b) Two-dimensional distribution ( 1
𝜒2) in the case of the second Gaussian simulation.

(c) Distribution of the quadratic form 1
the case of the third Gaussian simulation.

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 in

(d) Two-dimensional distribution ( 1
𝜒2) in the case of the third Gaussian simulation.

2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 vs

Figure 39: Figures showing the nonlinearity of constraints. These ﬁgures correspond to the events
of the two diﬀerent 𝑒+𝑒− → 𝐾𝑆𝐾 ±𝜋∓, 𝐾𝑆 → 𝜋+𝜋− Gaussian simulations (second and third).
Figures (a) and (b) correspond to the events of the second simulation, while ﬁgures (c) and (d)
correspond to the events of the third simulation. The second Gaussian simulation corresponds to
the 𝜒2 distribution shown in ﬁgure 37b, while the third Gaussian simulation corresponds to the
distribution shown in ﬁgure 37c.

– 63 –

0255012∆y⊺ˆQ∆y02000040000Entries999981Mean-0.0781StdDev1.62982040χ2−2502512∆y⊺ˆQ∆y0.0001.3332.6674.0005.3336.6678.0009.333−250255012∆y⊺ˆQ∆y0500010000Entries998666Mean0.0474StdDev4.83272550χ205012∆y⊺ˆQ∆y0.0001.3332.6674.0005.3336.6678.0009.333010020012∆y⊺ˆQ∆y0500010000Entries989308Mean40.1802StdDev48.7027100200χ2020012∆y⊺ˆQ∆y0.0001.3332.6674.0005.3336.6678.0009.333of this distribution is about three times larger than in the case of the distribution shown in ﬁgure 38a.
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 is suﬃcient to skew the corresponding
As shown in ﬁgure 37b, such a deviation of the 1
2 Δ𝒚(cid:124) ˆ𝑄Δ𝒚 versus the 𝜒2
𝜒2 distribution. Figure 39b shows the two-dimensional distribution of the 1
for the case of the second Gaussian simulation. Figures 39c and 39d show distributions similar to
those shown in ﬁgures 39a and 37b, respectively. Figures 39c and 39d correspond to the case of the
third Gaussian simulation. Figure 39c shows that the distribution in this case is much wider than
in the case of the ﬁrst and second Gaussian simulations. In addition, this distribution is strongly
asymmetric with respect to zero. Moreover, the long tail on the right slope of this distribution
corresponds to large chi-square values. This can be seen from the two-dimensional distribution
shown in ﬁgure 39d.

10 Fitting package

The kinematic and vertex ﬁtting package consists of two parts. The ﬁrst part is the base ﬁtting
package KFBase. The KFBase package contains the optimizer class and an abstract base hypothesis
class. This package also contains classes for all constraints, vertices and particles, except for charged
particles and photons. The second part is the package of kinematic and vertex ﬁtting for the CMD-3
experiment. This package is called KFCmd and depends on the base ﬁtting package. The KFCmd
package contains classes of charged particles and photons. It also contains a class responsible for
reading input data, as well as classes with the implementation of some hypotheses. The packages
KFBase and KFCmd, as well as their documentation, can be found in the repositories https://
github.com/sergeigribanov/KFBase and https://github.com/sergeigribanov/KFCmd,
respectively.

Both packages are written in the C++ programming language and depend on a number of
other packages such as ROOT [25] and Eigen 3 [26]. The Eigen 3 header only library is used
for matrix computations, while the ROOT framework is mainly used for ﬁle manipulations. The
authors also provide a docker image that contains a number of examples of using the ﬁtting
package. The examples can be run in Jupiter notebooks based on the python 3 kernel. The
ﬁtting package does not currently have a python API. Instead of such an API, the PyROOT [27]
functionality is currently used. The repository with the docker image can be found at the link https:
//github.com/sergeigribanov/kinfit-cmd3-docker.

11 Summary

In this paper, the authors reviewed in detail the algorithm of operation and the capabilities of the
kinematic and vertex ﬁtting package for the CMD-3 experiment. The paper provides a description
of the constraints available in the ﬁtting package, as well as the parameterizations of particles
and vertices. The work provides a number of examples that show the operation of the ﬁtting
package using most of the constraints and particle parametrizations. These examples consider
hypotheses containing charged particles and photons in the ﬁnal state, hypotheses with intermediate
and lost particles. It should be noted that the ﬁtting package can be easily extended with additional
constraints, particle and vertex parameterizations. Despite the fact that this package was developed

– 64 –

for the CMD-3 experiment, the authors believe that after some adaptation the package can be used
in other similar experiments.

In addition, the ﬁtting package was tested using the Gaussian simulation technique. This kind
of testing is very useful, as it helps to eliminate some issues at the stage of package development.
Typos in the gradients and Hessians of constraints, as well as of the particle four-momentum and
trajectories, can be examples of such issues. Since some gradients and Hessians can be very
cumbersome, testing for this kind of issues requires special attention.

The authors consider the discussed kinematic and vertex ﬁtting package as their ﬁrst step
towards a more rigorous and universal ﬁtting package. In the future, it is planned to pay special
attention to the optimization algorithm. The ﬁtting package currently uses Newton’s method. This
requires inverting the Hessian matrix at each iteration of the optimization procedure. The more
optimization parameters the hypothesis contains, the more resource-intensive the Hessian inversion
becomes. The authors plan to consider the possibility of using quasi-Newtonian methods [17, 18],
in which the Hessian inversion does not occur at every iteration. In the case of hypotheses with
a large number of vertices, the authors also plan to study optimization algorithms based on the
Kalman ﬁltering, similar to the one discussed in the paper [8]. In addition, the authors plan to also
explore the possibility of using inequality constraints [17, 20, 21] in some kinematic and vertex
ﬁtting cases.

12 Acknowledgments

The authors are grateful to the members of the CMD-3 collaboration for discussion of the considered
topic and numerous suggestions. The authors also express special gratitude to the members of the
collaboration who are already actively using and testing the ﬁtting package. The work described in
sections 2-7 is supported by Russian Science Foundation grant No. 19-72-20114. The work related
to the testing of the ﬁtting package is supported by the Russian Foundation for Basic Research grant
No. 20-02-00496 A.

References

[1] J.M. Bauer, Kinematic Fit for the Radiative Bhabha Calibration of BaBar’s Electromagnetic

Calorimeter, 2000. 10.48550/ARXIV.HEP-EX/0011019.

[2] K. Prokoﬁev and T. Speer, “A kinematic and a decay chain reconstruction library.” https://twiki.
cern.ch/twiki/pub/CMSPublic/SWGuideKinematicVertexFit/CMS_IN_2004_20.pdf, 2004.

[3] K. Prokoﬁev and T. Speer, A kinematic and a decay chain reconstruction library, in 14th

International Conference on Computing in High-Energy and Nuclear Physics, pp. 411–414, 2005.

[4] Y. Liang, H. Rang-Lin, L. Wei-Guo, B. Jian-Ming, F. Cheng-Dong, H. Bin et al., Lagrange multiplier

method used in BESIII kinematic ﬁtting, Chinese Physics C 34 (2010) 204.

[5] P. Jörg, The kinematically constrained ﬁt, in Exploring the Size of the Proton: by Means of Deeply

Virtual Compton Scattering at CERN, (Cham), pp. 61–76, Springer International Publishing (2018),
DOI.

[6] J. Sundermann and T. Göpfert, “KinFitter – A Kinematic Fit with Constraints.”

https://github.com/goepfert/KinFitter.

– 65 –

[7] R. Smith and J. Bishop, A Fast Universal Kinematic Fitting Code for Low-Energy Nuclear Physics:

FUNKI_FIT, Physics 1 (2019) .

[8] J.-F. Krohn, F. Tenchini, P. Urquĳo, F. Abudinén, S. Cunliﬀe, T. Ferber et al., Global decay chain

vertex ﬁtting at Belle II, Nuclear Instruments and Methods in Physics Research Section A:
Accelerators, Spectrometers, Detectors and Associated Equipment 976 (2020) 164269.

[9] Y. Radkhorrami and J. List, Kinematic ﬁtting for particle ﬂow detectors at future higgs factories,

2021. 10.48550/ARXIV.2111.14775.

[10] B. Khazin, Physics and detectors for VEPP-2000, Nucl. Phys. B Proc. Suppl. 181-182 (2008) 376.

[11] G.P. Razuvaev et al., Calorimetry at the CMD-3 Detector, in CERN-BINP Workshop for Young

Scientists in 𝑒+𝑒− Colliders, pp. 71–76, 2017, DOI.

[12] V.V. Danilov, P.M. Ivanov, I.A. Koop, I.N. Nesterenko, E.A. Perevedentsev, D.N. Shatilov et al., “The

Concept of Round Colliding Beams.” https://cds.cern.ch/record/860802, 1996.

[13] D. Berkaev, A. Kirpotin, I. Koop, A. Lysenko, I. Nesterenko, A. Otboyev et al., VEPP-2000 Operation

with Round Beams in the Energy Range from 1 to 2 GeV, Nuclear Physics B - Proceedings
Supplements 225-227 (2012) 303.

[14] A. Ioﬀe and V. Tihomirov, Theory of Extremal Problems, Studies in mathematics and its applications

6, North-Holland (1979).

[15] D.P. Bertsekas, Constrained optimization and Lagrange multiplier methods, Optimization and neural

computation series, Athena Scientiﬁc, 1 ed. (1996).

[16] E. Herman and G. Strang, Calculus, vol. Volume 3, OpenStax (2018).

[17] P.E. Gill, W. Murray and M.H. Wright, Practical Optimization, Emerald Group Publishing Limited

(1982).

[18] A.F. Izmailov and M.V. Solodov, Newton-Type Methods for Optimization and Variational Problems,

Springer Series in Operations Research and Financial Engineering, Springer Cham (2014),
https://doi.org/10.1007/978-3-319-04247-3.

[19] N.K. Vishnoi, Algorithms for Convex Optimization, Cambridge University Press (2021),

https://doi.org/10.1017/9781108699211.

[20] E.G. Birgin and J.M. Martínez, Practical augmented Lagrangian methods for constrained

optimization, Fundamentals of Algorithms, Society for Industrial and Applied Mathematics (2014),
https://doi.org/10.1137/1.9781611973365.

[21] H.A. Eiselt and C.-L. Sandblom, Nonlinear Optimization, International Series in Operations Research
and Management Science, Springer Cham, 1 ed. (2019), https://doi.org/10.1007/978-3-030-19462-8.

[22] V.N. Bukov and S.V. Goryunov, Inversion and canonization of block matrices, Mathematical Notes 79

(2006) 614.

[23] S.S. Gribanov, A.S. Popov, R.R. Akhmetshin, A.N. Amirkhanov, A.V. Anisenkov, V.M. Aulchenko
et al., Measurement of the 𝑒+𝑒− → 𝜂𝜋+𝜋− cross section with the CMD-3 detector at the VEPP-2000
collider, JHEP 01 (2020) 112 [1907.08002].

[24] V.M. Aulchenko, M.N. Achasov, A.Y. Barnyakov, K.I. Beloborodov, A.V. Berdyugin,

A.G. Bogdanchikov et al., Measurement of the 𝑒+𝑒− → 𝜂𝜋+𝜋− cross section in the center-of-mass
energy range 1.22–2.00 gev with the snd detector at the vepp-2000 collider, Phys. Rev. D 91 (2015)
052013.

– 66 –

[25] R. Brun and F. Rademakers, ROOT: An object oriented data analysis framework, Nucl. Instrum. Meth.

A 389 (1997) 81.

[26] G. Guennebaud, B. Jacob et al., “Eigen v3.” http://eigen.tuxfamily.org, 2010.

[27] M. Galli, E. Tejedor and S. Wunsch, A New PyROOT: Modern, Interoperable and More Pythonic, EPJ

Web Conf. 245 (2020) 06004.

– 67 –

