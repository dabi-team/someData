funcharts:ControlchartsformultivariatefunctionaldatainRChristianCapezzaUniv.ofNaplesFedericoIICorrespondingauthor:christian.capezza@unina.itFabioCentofantiUniv.ofNaplesFedericoIIAntonioLeporeUniv.ofNaplesFedericoIIAlessandraMenafoglioPolitecnicodiMilanoBiagioPalumboUniv.ofNaplesFedericoIISimoneVantiniPolitecnicodiMilanoAbstractModernstatisticalprocessmonitoring(SPM)applicationsfocusonproﬁlemonitor-ing,i.e.,themonitoringofprocessqualitycharacteristicsthatcanbemodeledasproﬁles,alsoknownasfunctionaldata.Despitethelargeinterestintheproﬁlemonitoringliter-ature,thereisstillalackofsoftwaretofacilitateitspracticalapplication.ThisarticleintroducesthefunchartsRpackagethatimplementsrecentdevelopmentsontheSPMofmultivariatefunctionalqualitycharacteristics,possiblyadjustedbytheinﬂuenceofad-ditionalvariables,referredtoascovariates.Thepackagealsoimplementsthereal-timeversionofallcontrolchartingprocedurestomonitorproﬁlespartiallyobserveduptoanintermediatedomainpoint.Thepackageisillustratedboththroughitsbuilt-indatagen-eratorandareal-casestudyontheSPMofRo-PaxshipCO2emissionsduringnavigation,whichisbasedontheShipNavigationdataprovidedintheSupplementaryMaterial.Keywords:functionaldataanalysis,statisticalprocesscontrol,proﬁlemonitoring,multivariatefunctionallinearregression,R.arXiv:2207.09321v1  [stat.CO]  19 Jul 20222funcharts:ControlchartsformultivariatefunctionaldatainR1.IntroductionRecentacquisitiontechnologiesarebasedonmultipleandhigh-frequencysensorsinstalledonboardofdevicesormachinesandallowtheacquisitionofalargeamountofdataaboutmanyprocessvariablesandqualitycharacteristics.Inthiscontext,statisticalprocessmonitoring(SPM)callsformethodsabletomodelandanalyzequalitycharacteristicsintheformofmultiplecurves,i.e.,continuousfunctionsdeﬁnedoncompactsetsoftenreferredtoasfunc-tionaldataorproﬁles.Fordetailsonfunctionaldataanalysis(FDA),thereaderisreferredtoRamsayandSilverman(2005);HorváthandKokoszka(2012);FerratyandVieu(2006);KokoszkaandReimherr(2017).Thelargeavailabilityoffunctionaldataisleadingtoagrow-inginterestinproﬁlemonitoring(Noorossana,Saghaei,andAmiri2011),whichaimstocheckthestabilityovertimeoftheprocessbasedonobservationsofoneormorefunctionalqualitycharacteristicsofinterest,thatis,asinthetraditionalSPM,totestwhetherornotthepro-cessisaﬀectedalsobyspecialandnotonlybycommoncausesofvariations.Intheformercase,theprocessissaidtobeoutofcontrol(OC),whileinthelattercase,itissaidtobeincontrol(IC).OneoftheﬁrstreviewsonthistopicisthepaperofWoodall,Spitzner,Mont-gomery,andGupta(2004).Forotherrelevantcontributions,seeJinandShi(1999),ColosimoandPacella(2010),Grasso,Menafoglio,Colosimo,andSecchi(2016),Grasso,Colosimo,andTsung(2017),Menafoglio,Grasso,Secchi,andColosimo(2018),Maleki,Amiri,andCastagli-ola(2018),andJones,Abdel-Salam,andMays(2021).TheavailableapproachestoproﬁlemonitoringaregenerallybasedonbuildingcontrolchartscapableofdetectingOCconditions,withoutnecessarilyconsideringtherelationshipbetweenthequalitycharacteristicandvariablesthatmayhaveaninﬂuenceonit,referredtoasco-variates.AfewexceptionsaretherecentworksofCapezza,Lepore,Menafoglio,Palumbo,andVantini(2020)andCentofanti,Lepore,Menafoglio,Palumbo,andVantini(2021),whoproposemethodstoextendtheregressioncontrolchart(Mandel1969)tofunctionaldatasettings,wherethequalitycharacteristicisinﬂuencedbyscalarorfunctionalcovariates,withtheaimtoimprovetheeﬀectivenessofthemonitoringstrategy.Inparticular,theyproposeacontrolchartingschemebasedontheresidualsofalinearregressionwithmultivariatefunc-tionalcovariatesusedasregressorsandthescalar(Capezzaetal.2020)orfunctionalqualitycharacteristicsusedastheresponse(Centofantietal.2021).Surprisingly,despitethelargeinterestintheproﬁlemonitoringliterature,thereisalackofsoftwarespeciﬁcallydesignedforthistypeofapplicationinmoderndata-richscenarios.TheqccRpackage(Scrucca,Snow,andBloomﬁeld2017),whichisoneofthemostpopularfortheSPM,focusesindeedoncontrolchartsforunivariateandmultivariatedata,only.Alsointhecontextofbatchprocessmonitoring,thedvqcc(Valk,Filho,andCybis2020)Rpackageprovidesanicesetofcontrolchartsbasedonthevectorautoregressivemodel(MarcondesFilhoandValk2020)relatedtomonitoringmultiplevariablesobservedovertimebutrequiresaligneddata,whileoftenproﬁlesareobservedoverirregulargridswithadiﬀerentnumberofdiscretepointsforeachcurve.Moreover,noneoftheaforementionedpackagesimplementSPMmethodsabletoaccountforoneormorecovariates,possiblyfunctional,whichmayinﬂuencethequalitycharacteristicofinterest.ThefunchartsRpackageintroducedinthisworkandavailableonCRAN(Capezza,Cento-fanti,Lepore,Menafoglio,Palumbo,andVantini2022)isinsteadtheﬁrstoﬀ-the-shelftoolkitabletoperformSPMoffunctionalqualitycharacteristicsaloneoradjustedbytheinﬂu-enceofcovariates.Inparticular,intheformercase,weprovidetheimplementationofthe3methodologyproposedinColosimoandPacella(2010)forproﬁlemonitoringofunivariatefunctionaldatabasedonfunctionalprincipalcomponentanalysisanditsextensiontothecaseofmultivariatefunctionaldata.Whereas,inthelattercase,weimplementtheaforemen-tionedmethodsproposedbyCapezzaetal.(2020)andCentofantietal.(2021).Thefunchartspackagefocusesontheprospectivemonitoringoftheprocess,referredtoasPhaseII.Thatis,givenacleandatasetwithnobservationsassumedtoberepresentativeofICprocessperformance,referredtoasreferencedataset,theobjectiveistobuildappropriatecontrolchartsabletoissueanalarmwhentheprocessisOCbasedonfutureindividualobservationsdrawnfromit,hereinafterreferredtoasOCobservations.Accordingly,wewillrefertoanyfutureindividualobservationsdrawnfromtheICprocessasICobservations.Inalltheconsideredsettings,thefunchartspackageimplementsalsoareal-timeversionofthefunctionalcontrolchartsbyacceptingasinputalsoproﬁlesthatarepartiallyobserveduptoanintermediatedomainpointandadaptingthereal-timemonitoringoriginallyproposedbyCapezzaetal.(2020)inthecaseofscalarresponsetothecaseoffunctionalresponse.Theremainderofthisarticleisorganizedasfollows.Section2brieﬂyoverviewsthemeth-odsthatareimplementedinthefunchartspackage.Comprehensiveusageofthefunchartspackageiscoveredwithabuilt-insimulationexampleinSection3andareal-casestudyinthemonitoringofCO2emissionsofaRo-PaxshipduringnavigationinSection4.Section5concludesthisarticle.2.OverviewofthemethodsimplementedinfunchartsThissectionprovidesdetailsofthemethodsimplementedinfuncharts.Section2.1describeshowmultivariatefunctionalprincipalcomponentanalysis(MFPCA)isperformedtorepresentfunctionaldata.Section2.2reviewsthemethodologiesforSPMofmultivariatefunctionaldatawithoutcovariatesandextendsthemethodproposedbyColosimoandPacella(2010)forunivariateproﬁlestothemultivariatesetting.ThecontrolchartsproposedbyCapezzaetal.(2020)andCentofantietal.(2021)areintroducedinSection2.3.1and2.3.2,respectively.Finally,inSection2.4,thereal-timeimplementationofthesemethodsisillustrated.2.1.MultivariatefunctionalprincipalcomponentanalysisLetXi={(Xi1,...,XiP)>}i=1,...,ndenotenobservationsofavectorofPfunctionalvariables,intheHilbertspaceL2(T)P,whosecomponentsXi1,...XiPbelongtoL2(T),thespaceofsquareintegrablefunctionsdeﬁnedonthecompactintervalT.Morespeciﬁcally,thefunchartspackageassumesthatthesefunctionaldataaredenselyobservedonasetofdiscretegridpoints(usuallyintimeorspace)andcanberepresentedthroughcubicB-splinebasisexpansionwithorderfourandequallyspacedknots.TheB-splinebasissystemhasshowntoenjoyremarkabletheoreticalaswellascomputationalpropertiesintheproblemofrecoveringasmoothsignalfromnoisymeasurements(DeBoor1978;Wahba1990;GreenandSilverman1994).Togetafunctionalobservationfromthediscretegridpoints,alargenumberofbasisfunctionsischosenandbasiscoeﬃcientsareestimatedusingpenalizedleastsquares.Thepenaltytermistheintegratedsquaredsecondderivativewithsmoothingparameterselectedthroughgeneralizedcross-validation(GCV)(RamsayandSilverman2005).MFPCA(RamsayandSilverman2005;JacquesandPreda2014;HappandGreven2018)isthenusedtogetaﬁniterepresentationoffunctionaldata.Moreover,totakeintoaccount4funcharts:ControlchartsformultivariatefunctionaldatainRthepossiblediﬀerentrangesofvariationofthePfunctionalvariables,theseareempiricallystandardized,asinChiou,Chen,andYang(2014),i.e.,byﬁrstlysubtractingpointwisefromeachoriginalvariablethecorrespondingsamplemeanfunctionandthendividingtheresultpointwisebytherelativesamplestandarddeviationfunction.Then,MFPCAconsistsinﬁndingtheeigenvaluesλmandthecorrespondingeigenfunctionsψm=(ψm1,...,ψmP)>∈L2(T)P,with1≤m≤n−1,asthesolutionsoftheeigenvalueequationZTV(s,t)ψm(s)ds=λmψm(t),∀t∈T,(1)whereV(s,t)=1n−1Pni=1Xi(s)Xi(t)>istheempiricalcovariancefunctionofthemultivariatefunctionaldata.Eigenvaluesarearrangedinanon-increasingorder,i.e.λ1≥λ2≥···≥0.Eigenfunctionsareorthogonaltoeachother,i.e.,PPp=1RTψm1p(t)ψm2p(t)dt=1(m1=m2),where1(·)istheindicatorfunction,andarealsoknownasmultivariatefunctionalprincipalcomponents,orprincipalcomponents(PCs).Forcomputationaldetails,thereaderisreferredtoSection8.4.2ofRamsayandSilverman(2005).ByprojectingeachobservationontothethePCs,wegetthemultivariatefunctionalPCscores,orsimplyscoresξim=PPp=1RTXip(t)ψmp(t)dt,whichaccordinglysatisfyPni=1ξim=0andPni=1ξim1ξim2/(n−1)=λm11(m1=m2).AﬁniterepresentationoftheoriginaldataisobtainedbyretainingaﬁnitesubsetofthePCs.Inthefollowing,weconsiderthemostpopularchoicetoretaintheﬁrstMPCs,i.e.,theonesassociatedwiththelargestMeigenvalues.AlternativechoicesarediscussedinCapezzaetal.(2020).Thus,XiisapproximatedwithˆXi=(ˆXi1,...,ˆXiP)>,deﬁnedasˆXip(t)=MXm=1ξimψmp(t),t∈T,p=1,...,P.(2)2.2.FunctionalcontrolchartsformultivariatequalitycharacteristicsLetusconsideravectorofPfunctionalvariablesasafunctionalqualitycharacteristicsofinteresttobemonitored.Tothisaim,foreachobservation{Xi∈L2(T)P}i=1,...,n,twocontrolchartsarerespectivelybuiltontheHotelling’sT2andsquaredpredictionerror(SPE)statistics,deﬁnedasT2i=MXm=1ξ2im/λm,SPEi=PXp=1ZT(Xip(t)−ˆXip(t))2dt.(3)wheretheSPEstatisticcanbealsocalculatedasSPEi=Pn−1M+1ξ2m.TheHotelling’sT2statisticmonitorsˆXideﬁnedinEquation(2)throughtheretainedPCs,whiletheSPEstatis-ticmonitorstheapproximationerrorduetothedimensionreduction.WhileinColosimoandPacella(2010)controlchartlimitsT2limandSPElimarecalculatedbasedontheas-sumptionthatscoresarenormallydistributed,inthefunchartspackagetheyarecalculatednon-parametricallybymeansofempiricalquantilesofthereferencedatasetdistributionoftheHotelling’sT2andSPEstatistics.ThefunchartspackageusestheBonferronicorrection(Hsu1996)toconstrainthefamily-wiseerrorratetobesmallerthanadesiredvalueα∈(0,1)bysettingtheTypeIerrorrateineachofthetwocontrolchartsequaltoα/2,thatforeachcontrolchartisthenominalprobabilitythatanin-controlpointfallsoutsideofthecontrol5limits.Moreover,asshowninCapezzaetal.(2020),theHotelling’sT2andSPEstatisticscanbedecomposedassumsoverthePfunctionalvariables.Inthisway,thecontributionsofthep-thvariable,p=1,...,P,ofthei-thobservation,i=1,...,n,toeachmonitoringstatisticcanbe,respectively,measuredbyCONTT2i,pandCONTSPEi,pasfollowsCONTT2i,p=MXm=1ξimλmZTXip(t)ψmp(t)dt,CONTSPEi,p=ZT(Xip(t)−ˆXip(t))2dt.(4)Thesequantitiesallowtoidentifywhichfunctionalvariableshavebeenresponsibleofespe-ciallylargevaluesofamonitoringstatisticandarethenanimportanttoolforfaultdetection.Capezzaetal.(2020)notedthatthesecontributiontermsmayhaveverydiﬀerentvariability,foreachp=1,...,P.Therefore,largevariablecontributionsareidentiﬁedasthosethatexceedtherelativeempiricalupperlimits.LetusdenotebyX∗=(X∗1,...,X∗P)>afutureobservationtobemonitoredinPhaseII.Afterstandardizationwithrespecttothesamplemeanandstandarddeviationfunctionscalculatedonthereferencedataset,scoresarecalculatedbyprojectingX∗ontothethePCs.ThisallowsonetocalculatetheapproximationˆX∗usingEquation(2)andthetwomonitoringstatistics,whichwedenoteasT2∗andSPE∗,usingEquation(3).IfeithertheT2∗orSPE∗monitoringstatisticobservationislargerthanthecorrespondingcontrollimit,analarmisissued.Then,contributionstotheOCmonitoringstatisticarecalculatedthroughEquation(4)andvariableswithacontributionthatislargerthanthecorrespondinglimitneedtobeinvestigated.2.3.FunctionalcontrolchartsforaunivariatequalitycharacteristicadjustedbytheinﬂuenceofcovariatesDiﬀerentlyfromSection2.2,letusconsideraunivariatequalitycharacteristic,intheformofascalarorafunction,tobemonitoredwhenfunctionalcovariatesareavailable.Afterthequalitycharacteristicisadjustedbythefunctionalcovariates,thecontrolchartisimprovedbecausethemonitoringisconditionalontheobservedvalueofthefunctionalcovariates.Sec-tion2.3.1and2.3.2showthecontrolchartsproposedbyCapezzaetal.(2020)andCentofantietal.(2021)forascalarandfunctionalqualitycharacteristic,respectively.2.3.1Controlchartsbasedonscalar-on-functionregressionCapezzaetal.(2020)buildcontrolchartsbasedonthescalar-on-functionlinearregressionmodel,betweenobservationsofascalarresponsevariable,denotedbyyi,andobservationsofavectoroffunctionalcovariatesXi=(Xi1,...,XiP)>∈L2(T)P.Thatis,themodelisdeﬁnedasyi=β0+PXp=1ZTXip(t)βp(t)dt+εi,i=1,...,n,(5)whereβ=(β1,...,βP)>∈L2(T)Parethefunctionalcoeﬃcients,β0isthescalarintercept,andε1,...,εnaretheindependenterrortermswithidenticaldistributionN(0,σ2).Withoutlossofgenerality,weassumethatthefunctionalcovariateshavealreadybeenstandardizedasshowninSection2.1.Becauseoftheinﬁnitedimensionalityofthefunctionaldata,thismodel6funcharts:ControlchartsformultivariatefunctionaldatainRcannotbeestimateddirectlyusingleastsquares.ByapplyingMFPCAtothefunctionalco-variatesfordimensionreductionasshowninSection2.1,functionalcovariatescanbeapprox-imatedbyˆXiasinEquation(2).Moreover,eigenfunctionscanbeusedforbasisexpansionofthefunctionalcoeﬃcients,leadingtothetruncatedversionβM=(βM1,...,βMP)>∈L2(T)PβMp(t)=MXm=1bmψmp(t),t∈T,p=1,...,P.(6)Inthisway,model(5)isreplacedbythefollowingapproximatemodelyi=β0+MXm=1ξimbm+εMi,(7)whereleast-squaresestimatesareobtainedasˆβ0=1nnXi=1yi,ˆbm=nXi=1yiξim/nXi=1ξ2im,m=1,...,M.(8)Finally,theestimateˆβ=(ˆβ1,...,ˆβP)>ofβMandthenofβisobtaineduponreplacingb1...,bMinEquation(6)withtheleast-squaresestimatesinEquation(8),andhencethepredictionofthescalarresponsevariableisgivenbyˆyi=ˆβ0+PXp=1ZTXip(t)ˆβp(t)dt.(9)Giventheestimatedmodel,afutureobservationofthescalarresponsevariabley∗andthecor-respondingfunctionalcovariatevectorX∗=(X∗1,...,X∗P)>ismonitoredinPhaseIIthroughthreecontrolchartsbuilton(i)theHotelling’sT2∗and(ii)SPE∗monitoringstatistics,asshowninSection2.2,aswellas(iii)theresponsepredictionerrory∗−ˆy∗,withˆy∗obtainedthroughEquation(9).Theresponsepredictionerrorcontrolchartintendstomonitorthescalarresponsevariableconditionallyonthefunctionalcovariates.GivenanoverallTypeIerrorprobabilityα,theBonferronicorrectionisusedbysettingineachcontrolcharttheTypeIerrorrateequaltoα/3.ThelimitsoftheHotelling’sT2andSPEcontrolchartsarecalculatednon-parametricallyasdescribedinSection2.2.Becauseofthenormalityassump-tionontheerrorterms,controllimitsofthecontrolchartontheresponsepredictionerrorarecalculatedas±tn−M−1,1−α/6ˆσ 1+T2∗n−1!1/2,(10)wheretν,γistheγ-quantileoftheStudent’sdistributionwithνdegreesoffreedomandˆσ2=Pni=1(yi−ˆyi)2/(n−M−1).Ifatleastoneofthethreemonitoringstatisticsexceedstherelativecontrollimits,thenanOCalarmisissued.ThecontributionstotheHotelling’sT2andSPEstatisticspresentedinSection2.2cansupporttheinspectionoffunctionalcovariatesresponsibleoftheOCalarm.Incontrast,whenanOCisissuedbytheresponsepredictionerrorcontrolchart,causesshouldbepossiblyinvestigatedoutsideofthesetofvariablesincludedinthemodelascovariates.72.3.2Controlchartsbasedonfunction-on-functionregressionTheresponsepredictionerrorcontrolchartpresentedinSection2.3.1canberegardedasaparticularcaseofthefunctionalregressioncontrolchart(FRCC),whichisageneralframeworkforproﬁlemonitoringproposedbyCentofantietal.(2021).TheFRCCisbasedonthefollowingthreemainsteps,inwhichoneshoulddeﬁne(i)thefunctionalregressionmodeltobeﬁtted;(ii)theestimationmethodofthechosenmodel;(iii)themonitoringstrategyofthefunctionalresiduals.Speciﬁcally,Centofantietal.(2021)describeaparticularimplementationoftheFRCCframeworkobtainedbyconsidering(step(i))thefunction-on-functionlinearregressionmodelyi(t)=β0(t)+PXp=1ZSXip(s)βp(s,t)ds+εi(t),i=1,...,n,t∈T,(11)whereyi∈L2(T),diﬀerentlyfromCapezzaetal.(2020),isallowedtobeafunctionalre-sponsevariable.ThemultivariatefunctionalcovariatesXi=(Xi1,...,XiP)>∈L2(S)P,i.e.,areallowedtobedeﬁnedonacompactdomainS,notnecessarilyequaltoT,andβ=(β1,...,βP)>∈L2(S×T)Parethefunctionalcoeﬃcients,β0∈L2(T)isthefunctionalintercept.InEquation(11),ε1,...,εndenotetheindependentfunctionalerrortermswithzeromeanandcovariancefunctionVε∈L2(S×T).Withoutlossofgenerality,weassumethatboththefunctionalresponseandcovariateshavealreadybeenempiricallystandard-izedasshowninSection2.1.Accordingly,thefunctionalinterceptissetequaltozeroinmodel(11).Then,thestep(ii)isperformedbyapplyingMFPCAtoboththesetoffunc-tionalcovariatesandtotheresponsefunctionseparately,asdescribedinSection2.1,yieldingrespectivelyeigenfunctionsψXl=(ψXl1,...ψXlP)>∈L2(S)PandψYm∈L2(T),towhichcorre-spondeigenvaluesλXlandλYm.ThecovariatesXipandtheresponseYi,i=1,...,n,canbethenapproximatedbytherelativetruncatedversionˆXLip(s)=LXl=1ξXilψXlp(s),p=1,...,P,s∈S,ˆYMi(t)=MXm=1ξYimψYm(t),t∈T,(12)whereξYim=RTYi(t)ψYm(t)dt,ξXil=PPp=1RSXip(s)ψXlp(s)ds,andLandMdenotethenumberofPCsretainedtorepresentXipandYi,respectively.Moreover,inthesamefashion,thefunctionalcoeﬃcientsβinEquation(11),canberepresentedbythetruncatedversionβLM=(βLM1,...,βLMP)>,whereeachcomponentisobtainedasβp(s,t)LM=LXl=1MXm=1blmψXmp(s)ψYl(t),s∈S,t∈T,p=1,...,P.(13)Then,model(11)isreplacedbythefollowingapproximatemodelξYim=LXl=1ξXilblm+(cid:15)im,m=1,...,M.(14)Basiscoeﬃcientsblmareestimatedthroughleastsquaresasˆblm=Pni=1(ξYimξXil)/Pni=1(ξXil)2.ThelattercanbepluggedintoEquation(13)inplaceofblmtoobtainˆβp(s,t)LM,andthus8funcharts:ControlchartsformultivariatefunctionaldatainRtheestimateˆβ=(ˆβ1,...,ˆβP)ofβ,whereˆβp=ˆβp(s,t)LM,s∈S,t∈T,p=1,...,P.PredictionsofthefunctionalresponseYi(t)areobtainedasˆYi(t)=PXp=1ZSXip(s)ˆβp(s,t)ds,t∈T.(15)Finally,inthelaststep(iii)oftheFRCC,themoststandardchoiceproposedbyCentofantietal.(2021)istorepresentthefunctionalresidualsei(t)=Yi(t)−ˆYi(t),t∈T,(16)withrespecttotheﬁrstKretainedfunctionalprincipalcomponents.Kcanbechosenaccord-inglytoagivenpercentage,say95%or99%,oftotalvariabilityexplained.Eigenfunctions,eigenvalues,andscoresarerespectivelydenotedbyψek∈L2(T),λek,andξek,withk=1,...,K.Analternativechoiceinstep(iii)isbasedonastudentizedversionofthefunctionalresidualssuggestedbyCentofantietal.(2021),whenNisnotparticularlylargeandinpresenceofcovariatemeanshifts.Thestudentizedfunctionalresidualsaredeﬁnedasei,stu(t)=Yi(t)−ˆYi(t)(cid:16)ˆvε(t)+ψY(t)>ˆΣεψY(t)PLl=1(ξXil)2/λXl(cid:17)1/2,t∈T,(17)whereψY=(ψY1,...,ψYM)>,(cid:15)i=((cid:15)i1,...,(cid:15)iM)>,ˆv2ε(t)=Pni=1ei(t)2/(n−1),t∈Tistheestimatorofthevarianceoftheresidualfunction,andˆΣε=Pni=1(cid:15)i(cid:15)>i/nistheestimatorofthecovariancematrixoftheerrors(cid:15)iminEquation(14).Toconcludestep(iii),apartfromtheresidualversionused,themonitoringstrategyoftheresidualsisbasedonHotelling’sT2andSPEcontrolchartsconstructedontheKscoresξek.Then,giventheestimatedmodel,afutureobservationofthefunctionalresponsevariableandthecorrespondingfunctionalcovariatesismonitoredinPhaseIIbycalculatingthefunctionalresidual(asinEquation(16)orEquation(17));byprojectingitontoψektoobtainfuturescores;andcalculatingtheHotelling’sT2andSPEmonitoringstatistics.Ifatleastoneofthetwomonitoringstatisticsisoutofthecontrollimits,thenanOCalarmisissued.2.4.Real-timefunctionalcontrolchartsThemethodspresentedsofarcanbeextendedtomonitorinrealtimefunctionaldatathatarepartiallyobserveduptoanintermediate,e.g.,thecurrent,domainpoint.LetthefunctionaldomainbetheintervalT=(a,b)forallobservationsanddenotewitht∗∈Ttheintermediatedomainpointuptowhichafuturefunctionalobservationisavailable.Thereferencedatasetuptot∗isobtainedbytruncatingthereferenceobservationsofthefunctionaldatasuchthatthefunctionaldomainis(a,t∗).Thisisusedtoestimatethereferencedistributionofthemonitoringstatisticsatt∗andhence,thelimitsofeachcontrolchart,asdescribedinSections2.1,2.2and2.3.Theselimitsareusedtocomparethemonitoringstatisticsobservationatt∗,whichiscalculatedonthefuturefunctionalobservation.Asbefore,analarmisissuedifatleastonemonitoringstatisticplotsoutsideofthecorrespondingcontrollimits.ThisstrategyhasbeenproposedfortheﬁrsttimebyCapezzaetal.(2020),whichthereaderisreferredtofordetails,toperformreal-timemonitoringoffunctionaldatainthescalar-on-functionregressioncaseofSection2.3.1.93.UsingfunchartsInthissection,thefunchartspackageisillustratedwithreferencetothemethodsdescribedinSection2.Itusesthefdapackage(Ramsay,Graves,andHooker2021)togetfunctionaldatafromthediscretepointsandtoperformMFPCA.Inparticular,Section3.1illustrateshowthefunchartspackagebuilt-indatageneratorworksinsimulatingfunctionaldatadrawnformeithertheICprocessorfromagivenOCscenariointermsofprocessmeanshift.Section3.2showsthemfdclasstodealwithmultivariatefunctionaldata.Sections3.3and3.4applythefunchartspackagetoimplementthemethodsdescribedinSections2.2and2.3,respectively.Finally,thereal-timeversionsofthemainfunctionsofthefunchartspackagearegiveninSection3.5fortheimplementationofthereal-timemonitoringmentionedinSection2.4.3.1.SimulatingfunctionaldataThedatagenerationmechanismisbasedonthesimulationstudyshowninCentofantietal.(2021)forthefunction-on-functionregressioncaseandworkssimilarlyforthescalar-on-functionregressioncase.Trivially,togetamultivariatefunctionaldatasettobeused,e.g.,asinSection2.2,onecansimplyextractthegeneratedobservationsofthefunctionalcovariatesdiscardingtheresponse.Thefunctionsim_funcharts()generatesanoutputlistwiththreeelements.Theﬁrstone,datI,containsthereferencedatasetofnIobservationstobeusedformodelﬁtting.Thesecond,datI_tun,containsadditionalntunICobservationstobeusedtoestimatecontrolchartlimits,giventhemodelestimatedusingdatI.Thethird,datII,containsadatasettobemonitoredinPhaseII,whichismadeupofnIIobservations,splittedintothreegroupsofequalsize.Bydefault,nI=ntun=1000andnII=60.TheﬁrstgroupismadeofdatafromanICprocess,thesecondgroupismadeupofOCobservationswithamodestmeanshift,whilethethirdgroupismadeupofobservationswithmoreseveremeanshifts.Fourtypesofshiftsareavailable,labelledasA,B,C,DasinCentofantietal.(2021).ShiftAisrepresentativeofachangeinthemeanfunctioncurvature,whereasshiftsBandCrepresentslopemodiﬁcationandtranslationoftheproﬁlepattern,respectively.ShiftDconsistsofbothcurvatureandslopemodiﬁcationsofthemeanfunction.Thedegreeofseverityiscontrolledbyaparameterd.Foradditionaldetails,werefertoCentofantietal.(2021).Moreover,detailsonsimulate_mfd()andthedatagenerationareavailableinSupplementaryMaterialS1.EachdatasetcontainsobservationsofthreefunctionalcovariatesX1,X2andX3,afunctionalresponseYandascalarresponsey_scalar,wherefunctionalvariablesareobservedon150discretepointequallyspacedonthefunctionaldomainT=(0,1).Tochangethesimulationscenario,suchasthesamplesizeorthemeanshifttypes,thesimulate_mfd()function,onwhichsim_funcharts()relies,canbeused.AnRcodeexampletogeneratethespeciﬁcdatasetsanalyzedinthenextsubsectionsisasfollowsR>library(funcharts)R>set.seed(0);d<-sim_funcharts()3.2.Themfdclass10funcharts:ControlchartsformultivariatefunctionaldatainRYX10.000.250.500.751.000.000.250.500.751.0001020302025t                                                                      tFigure1:Plotof20simulatedobservationsfromthereferencedatasetoftheﬁrstfunctionalcovariatesandthefunctionalresponse.Thefunchartspackageprovidesthemfdclassformultivariatefunctionaldata,whichinheritsthefdclassfromthefdapackageandprovidessomeadditionalfeatures.AdditionaldetailsonthemfdclassareavailableinSupplementaryMaterialS2.Letusshowhowtogetfunctionaldatawiththegenerateddatasets.Sincesim_funcharts()provideslistsofmatricesasoutput,weusetheget_mfd_list()functionasfollowsR>mfdI<-get_mfd_list(d$datI[1:4]$)R>mfdI_tun<-get_mfd_list(d$datI_tun[1:4]$)R>mfdII<-get_mfd_list(d$datII[1:4]$)Forplottingobjectsofclassmfd,thefunchartspackageprovidestheplot_mfd()functionbasedontheggplot2package.Figure1showstheplotoftheﬁrst20replicationsofthefunctionalvariablesX1andYforareferencedataset.R>plot_mfd(mfdI[1:20,c("X1","Y")])3.3.ControlchartsformultivariatefunctionaldataInthissectionweshowhowtousethefunchartspackagetobuildcontrolchartsinthesettingdescribedinSection2.2withthesimulateddata.NotethatinthesecondgroupofPhaseIIdata,thethirdfunctionalvariablehasamoderatemeanshiftoftypeAwithseverityd=20,whileinthethirdgroupofPhaseIIdatathethirdfunctionalvariablehasamoreseveremeanshiftoftypeAwithseverityd=40.Forclassmfd,thefunchartspackageprovidesthepca_mfd()functiontoperformMFPCA,whichisawrappertopca.fd()fromthefdapackage.Notethatpca_mfd()iscalledinternallybythefunctionscontrol_charts_pca(),sof_pc(),andfof_pc(),thatwillbeshowninthenextsections,beforebuildingthecorrespondingcontrolcharts.Thefunchartsprovidesalsotheplot_pca_mfd()functiontoplottheeigenfunctionsselectedbywheretheargumentharm.Forexample,inFigure2weplottheﬁrsttwoeigenfunctionsofthecovarianceoperatorofthethreefunctionalcovariates,calculatedonthereferencedatasetobservationsintheobjectmfdI.11X3X2X10.000.250.500.751.000.000.250.500.751.000.000.250.500.751.00−0.50.00.5−0.50.00.5−0.50.00.5t                                                                       t                                                                       tPC1PC2Figure2:Plotoftheﬁrsttwoeigenfunctions(PC1andPC2)ψ1(t)=(ψ11(t),ψ12(t),ψ13(t))>andψ2(t)=(ψ21(t),ψ22(t),ψ23(t))>oftheempiricalcovarianceoperatorofthethreefunc-tionalcovariatesX1,X2andX3,reportedineachofthethreepanels,respectively.R>pca<-pca_mfd(mfdI[,c("X1","X2","X3")])R>plot_pca_mfd(pca,harm=1:2)Atthisstage,thefunchartspackagecanbesuitablyusedtogetadataframewithalltheinformationrequiredtoplotthePhaseIIHotelling’sT2andSPEcontrolchartsasexplainedinSection2.2.Themainargumentsofcontrol_charts_pca()are:•pca,theﬁttedMFPCAmodelobtainedasoutputofpca_mfd()onthereferencedataset.•components,avectoroftheeigenfunctionstoberetainedintheMFPCAmodel.•tuning_data,anoptionaldatasetofICobservationstobeusedforcontrolchartslimitsestimation.Ifnoargumentisprovided,limitswillbecalculatedasquantilesofthestatisticscomputedonthereferencedataset.•newdata,themfdobjectcontainingthesimulatedobservationstobemonitoredinPhaseII.•alpha,anumericlistcontainingtheTypeIerrorstobeusedtoestimatetheHotelling’sT2andSPEcontrolchartlimits.Thedefaultvalueislist(T2=0.025,spe=0.025),whichusestheBonferronicorrectiontoensurethattheoverallTypeIerrorαisnotlargerthan0.05.Then,theplot_control_charts()functioncanbeusedwiththedataframeobtainedtoplotthethreecontrolchartsshowninFigure3.Inthefollowing,weselecttheﬁrstcomponentsthatexplainatleast95%ofthetotalvariabilityinthedata,asthedefaultoption.Weaddtwoverticaldashedlinestodistinguishthreegroupsof20PhaseIIdata,generatedunderdiﬀerentscenarios.Notethatplot_control_charts()reliesonthepatchworkpackage(Pedersen2020)toarrangetheggplotobjects,andtoaddaverticallinetoallplotsthroughtheoperator&,asfollowsR>cclist_pca<-control_charts_pca(+pca=pca,12funcharts:ControlchartsformultivariatefunctionaldatainR−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−44515401020301357911131517192123252729313335373941434547495153555759ObservationT2 statisticHOTELLING T2 CONTROL CHART−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−21223132333842434445464748495354555658590.00.51.01.52.01357911131517192123252729313335373941434547495153555759ObservationSPE statisticSPE CONTROL CHARTFigure3:Controlchartsformultivariatefunctionaldatawithoutcovariates.VerticallinesseparatethethreegroupsofsimulatedPhaseIIdata,generatedasdescribedinSection3.1.Horizontallinescorrespondtocontrolchartlimits,pointscorrespondtotheobservationsofthemonitoringstatisticsforeachPhaseIIobservation.Redpointshighlightsmonitoringstatisticsthatareoutofthecorrespondingcontrollimits;aboveeachofthemisreportedthecorrespondingOCobservationindex.+tuning_data=mfdI_tun[,c("X1","X2","X3")],+newdata=mfdII_pca)R>plot_control_charts(cclist_pca)&+geom_vline(aes(xintercept=c(20.5)),lty=2)&+geom_vline(aes(xintercept=c(40.5)),lty=2)FromFigure3,weseethattheﬁrstgroupof20PhaseIIobservations,whichhavebeengen-eratedfromtheICdistributionrightlydonotshowupasOCpoints.Whereas,thesecondgroupof20PhaseIIobservations,whereameanshiftonthethirdfunctionalvariablewassimulatedcontainsOCpoints.Ultimately,thelastgroupof20PhaseIIobservations,whereamoresevereshiftonthethirdfunctionalvariablewasset,showsupasOC,exceptfor3points.ThefunchartspackageallowsonetoinvestigatealsowhichoriginalvariablecontributesthemostandsomayberesponsibleofanyOCsignal,throughthecont_plot()function,whichdisplayssignalcontributionstotheHotelling’sT2andSPEmonitoringstatistics.Forex-ample,letusconsiderobservation59,whichisOCintheSPEcontrolchart.Themainargumentsofcont_plot()are:•cclist,thedataframereturnedbycontrol_charts_sof_pc.•id_num,theindexoftheobservationwhosecontributionsaretobeplotted.•which_plot,avectorcontainingthedesiredcontributiontobeplotted,where"T2"denotestheHotelling’sT2statisticand"spe"denotestheSPEstatistic.Thecontributionsareshownasbarplots,whereuppercontrollimitsareaddedaslines13Contribution to SPEX1X2X30.00.20.40.6Figure4:ContributionofthefunctionalcovariatestotheHotelling’sSPEstatisticforthePhaseIIobservation59.Contributionsexceedinguppercontrollimitsdepictedbyhorizontallinesareplottedinred.estimatedonthePhaseItuningdata.Contributionsthatexceedthelimitsareplottedinredcolorotherwisebarareplottedingray.ThecontributionsinFigure4showthesecondandthirdfunctionalvariablesasthemainresponsibleoftheOCintheSPEstatistic,thuscorrectlysignalingthesimulatedmeanshift.Notethat,eventhoughwesimulatedameanshiftinvaraibleX3,contributionofthefunctionalvariableX2isalsoparticularlylarge.ThisisreasonablebecausevariableX3aﬀectstheentirecovariancestructureinthedata,whichcanturnintolargecontributionstothemonitoringstatisticsalsofromothervariablescorrelatedwithit.R>cont_plot(cclist=cclist_pca,id_num=59,which_plot="spe")Finally,wecanalsoplotanyfutureobservationagainstthereferencedatasetbyusingtheplot_mon()function,asshowninFigure5.Itsmainargumentsare:•cclist,thedataframereturnedbycontrol_charts_pca.•fd_train,anmfdobjectcontainingthedatasettobeplottedinthebackgroundingray.UsuallythereferencedatasetoffunctionalvariablesrepresentingtheICperformanceisprovided.•fd_test,anmfdobjectcontainingthedatatobemonitoredinPhaseIIandplottedontheforeground.FunctionswhosecontributiontoeithertheHotelling’sT2andSPEstatisticsisoutofcontrolareplottedinred.R>plot_mon(cclist=cclist_pca,+fd_train=mfdI[,c("X1","X2","X3")],+fd_test=mfdII_pca[59])3.4.Functionalcontrolchartsforaunivariatequalitycharacteristicadjustedbytheinﬂuenceofcovariates14funcharts:ControlchartsformultivariatefunctionaldatainRFigure5:Observation59ofthefunctionalcovariatesinthePhaseIIdataset,plottedagainsttheobservationsofthereferencedatasetusedformodelﬁtting,plottedingray.Redcurvescorrespondtofunctionalvariableswhosecontributiontoatleastonemonitoringstatisticexceedsitslimit,whiletheothercurvesareplottedasblacklines.Theuseofthefunchartspackagetoimplementfunctionalcontrolchartsforaunivariatequal-itycharacteristicadjustedbytheinﬂuenceofcovariatesisillustratedinSections3.4.1and3.4.2withreferencetoscalar-on-functionandfunction-on-functionregressioncases,respec-tivelyintroducedinSections2.3.1and2.3.2.3.4.1Controlchartsbasedonscalar-on-functionregressionToﬁtascalar-on-functionregressionmodelwiththereferencedataset,thefunchartspackageprovidesthesof_pc()function.Itsmainargumentsare:•y,thevectorcontainingthescalarresponsevariableobservations.•mfdobj_x,anmfdobjectcontainingtheobservationsofthefunctionalcovariates.•tot_variance_explained,theminimumdesiredfractionofvariancetobeexplainedbythesetofPCsretainedintotheMFPCAmodelﬁttedonthefunctionalcovariates.Defaultvalueis0.9.•selection,thecriteriontochoosethePCstoretainaspredictorsinregressionmodel."variance"(default)retainstheﬁrstMPCssuchthattogethertheyexplainafractionofvariancegreaterthantot_variance_explained,"PRESS"selectsthej-thfunctionalPCif,byaddingittothecurrentsetofselectedPCs,thepredictedresidualerrorsumofsquares(PRESS)statisticdecreases."gcv"issimilarto"PRESS",wherethePRESSstatisticissubstitutedbytheGCVscore.Thefollowingcodeusesdefaultargumentsandestimatesthescalar-on-functionregressionmodelwiththereferencedataset:R>mod_sof<-sof_pc(y=d$datI$y_scalar,mfdobj_x=mfdI[,c("X1","X2","X3")])Theoutputofsof_pcisalistincludingtheresultsoftheregressionofthescalarresponseonthescores,theresultsoftheMFPCAobtainedusingpca_mfd()andtheestimatedfunctional15X3X2X10.000.250.500.751.000.000.250.500.751.000.000.250.500.751.00−1012−1012−1012t                                                                       t                                                                       tFigure6:Estimatedfunctionalcoeﬃcientsofthescalar-on-functionregressionmodelonthesimulatedreferencedataset,plottedinblack,alongwithestimatesoffunctionalcoeﬃcientson10bootstrapsamples,plottedingray,foruncertaintyquantiﬁcation.regressioncoeﬃcient,asanobjectofclassmfd.Thelattercanbeplottedusingtheplot_mfd()function.Moreover,thefunchartspackageallowsthegraphicaluncertaintyquantiﬁcationofthefunctionalcoeﬃcientestimatesviatheplot_bootstrap_sof_pc()function,whichplotsthecoeﬃcientsestimatedonthereferencedatasetalongwithestimatesobtainedonbootstrapsamplesofthesamedataset,asinFigure6:R>plot_bootstrap_sof_pc(mod_sof,nboot=100)Oncethemodelhasbeenestimatedonthereferencedataset,itispossibletobuildthecontrolchartsandplotthemfortheprospectivemonitoringoftheprocess,giventhenewPhaseIIdataset.AsstatedinSection3.1,theﬁrstgroupofdatacontainsICobservations,inthesecondgroupofdata,thescalarresponsehasamoderatemean(d=1),whileinthethirdgroupofdata,thescalarresponsehasamoreseveremeanshift(d=2).MeanshiftsofcovariatesarethesameasinSection3.3.AsexplainedinSection2.3.1,Capezzaetal.(2020)proposethreecontrolchartsbasedontheHotelling’sT2andSPEtomonitorthemultivariatefunctionalcovariates,togetherwiththepredictionerroronthescalarresponsevariabletomonitorthescalarresponsevariable,conditionallyonthecovariates.Thecontrol_charts_sof_pc()functionprovidesadataframewithalltheinformationrequiredtoplotthedesiredcontrolcharts.Ithasthefollowingmainarguments:•mod,theﬁttedmodelobtainedasoutputofsof_pc.•mfdobj_x_tuning,anoptionaldatasetofICobservationsofthefunctionalcovariatestobeusedforcontrolchartstuning.Ifnoargumentisprovided,limitswillbecalculatedasquantilesofthestatisticscomputedonthereferencedataset.•y_test,thevectorcontainingtheobservationsofthescalarresponsevariabletobemonitoredinPhaseII.•mfdobj_x_test,themfdobjectcontainingtheobservationsofthemultivariatefunc-tionalcovariates,correspondingtoy_test.•alpha,alistcontainingtheTypeIerrorforeachcontrolchart.Thedefaultvalueislist(T2=0.0125,spe=0.0125,y=0.025),whichusestheBonferronicorrec-tiontoensurethattheoverallTypeIerrorαisnotlargerthan0.05.16funcharts:ControlchartsformultivariatefunctionaldatainR−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−515401020301357911131517192123252729313335373941434547495153555759ObservationT2 statisticHOTELLING T2 CONTROL CHART−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−223133384243444647485354555658590.00.51.01.52.01357911131517192123252729313335373941434547495153555759ObservationSPE statisticSPE CONTROL CHART233235394041424344454647484950515253545556575859600121357911131517192123252729313335373941434547495153555759ObservationPrediction error [t]REGRESSION CONTROL CHARTFigure7:Functionalcontrolchartsforthescalar-on-functionregressioncase.VerticallinesseparatethethreegroupsofsimulatedPhaseIIdata.Horizontallinescorrespondtocontrolchartlimits,pointscorrespondtotheobservationsofthemonitoringstatisticsforeachPhaseIIobservation.Redpointshighlightsmonitoringstatisticsthatareoutofthecorrespondingcontrollimits;aboveeachofthemisreportedthecorrespondingOCobservationindex.Theplot_control_charts()functioncanbeusedwiththeobtaineddataframetoplotthethreecontrolchartsasshowninFigure7.R>cclist_sof_pc<-control_charts_sof_pc(+mod=mod_sof,+mfdobj_x_tuning=mfdI_tun[,c("X1","X2","X3")],+y_test=d$datII_sof$y_scalar,+mfdobj_x_test=mfdII[,c("X1","X2","X3")])R>plot_control_charts(cclist_sof_pc)&+geom_vline(aes(xintercept=c(20.5)),lty=2)&+geom_vline(aes(xintercept=c(40.5)),lty=2)SincethemultivariatefunctionalcovariatesobservationsarethesameasthedatausedinSec-tion3.3,bycomparingFigures7and3,noticethattheHotelling’sT2andSPEcontrolchartsplotthesamevaluesofthemonitoringstatistics.Thecontrol_charts_sof_pc()function17callsinfactcontrol_charts_pca()onthemultivariatefunctionalcovariates.ControllimitsinFigure7arehigherthanthoseofFigure3becausetheBonferronicorrectiontakesintoaccounttheuseofthreecontrolchartsinsteadoftwo.Thethirdcontrolchart(forthescalarpredictionerrormonitoring)signals5OCalarmsoverthesecondgroupof20data,whileall20observationsinthethirdgroupareabovetheuppercontrollimit.WhenanOCalarmissignaledbytheHotelling’sT2orSPEcontrolcharts,onecanbuildcontributionplotsonthemultivariatefunctionalcovariatesasshowninSection3.3andfurthervisualizeanymultivariatefunctionalobservationagainstareferencedatasettoperformfaultdetectiononmultivariatefunctionalcovariates.WheninsteadtheresponsepredictionerrorcontrolchartissuesanOCalarm,whiletheHotelling’sT2andSPEchartsdonot,oneconcludesthatpossibleanomaliesmayhaveoccurredoutsideofthesetofvariableschosenasfunctionalcovariates.3.4.2Controlchartsbasedonfunction-on-functionregressionToﬁtafunction-on-functionregressionmodelwithareferencedataset,thefunchartspackageprovidesthefof_pc()function,havingarguments•mfdobj_yandmfdobj_x,themfdobjectswiththePhaseIobservationsofthefunctionalresponseandcovariates,respectively.•tot_variance_explained_x,tot_variance_explained_yandtot_variance_explained_res,theminimumfractionofvariancethathavetobeexplainedbythesetofPCsretainedintotheMFPCAmodelﬁttedonthefunctionalcovariates,responseandresiduals,respectively.Defaultvalueis0.95.•type_residuals,thefunctionalresidualtobemonitored(seechoice(iii)ofCentofantietal.(2021)).If"standard"(default),theMFPCAiscalculatedonthefunctionalresiduals.If"studentized",theMFPCAiscalculatedonthestudentizedresiduals.Thefollowingcodeusesdefaultargumentsandestimatesthefunction-on-functionregressionmodelwiththereferencedataset:R>mod_fof<-fof_pc(mfdobj_y=mfdI[,"Y"],+mfdobj_x=mfdI[,c("X1","X2","X3")])Asoutput,fof_pcreturnsalistincludingtheresultsoftheregressionofthefunctionalresponsescoresonthefunctionalcovariatescores,theresultsoftheMFPCAobtainedusingpca_mfd()onthefunctionalresponse,thefunctionalcovariatesandresiduals.Moreover,theoutputlistcontainstheestimatedregressioncoeﬃcientfunction,asanobjectofclassbifdfromthefdapackage.Thus,itcanbeplottedviatheplot_bifd()functionprovidedbythefunchartspackage,asinFigure8.R>plot_bifd(mod_fof$beta_fd)Oncethemodelhasbeenestimatedonthereferencedataset,itispossibletobuildthecontrolchartsfortheprospectivemonitoringoftheprocess,giventhenewPhaseIIdataset.AsstatedinSection3.1,theﬁrstgroupofdatacontainsICobservations,whereas,inthe18funcharts:ControlchartsformultivariatefunctionaldatainRY vs X1Y vs X2Y vs X30.000.250.500.751.000.000.250.500.751.000.000.250.500.751.000.000.250.500.751.00s                                                      s                                                      st−1.0−0.50.00.51.0valueFigure8:Plotofthethefunction-on-functionregressioncoeﬃcientestimatedonthesimulatedreferencedataset.secondandthirdgroupsofdata,thefunctionalresponsehasamoderatemeanshiftoftypeDwithseverityd=0.5andd=1.5,respectively.TheconsideredmeanshiftsofcovariatesarethesameasinSection3.3.AsexplainedinSection2.3.2,twocontrolchartsareusedforSPMinthiscase,basedontheHotelling’sT2andthesquaredpredictionerrormonitoringstatistics,calculatedonthefunctionalresidualsofthefunction-on-functionregressionmodel.Theregr_cc_fof()functionprovidesadataframewithalltheinformationrequiredtoplotthecontrolchart.Ithasthefollowingmainarguments:•object,theﬁttedmodelobtainedasoutputoffof_pc.•mfdobj_y_tuningandmfdobj_x_tuning,optionalmfdobjectsofreferenceobservationsofthefunctionalresponseandcovariates,respectively,tobeusedforcontrolcharttuning.Ifnoargumentisprovided,limitswillbecalculatedasquantilesofthestatisticscomputedonthereferencedataset.•mfdobj_y_newandmfdobj_x_new,themfdobjectswiththeobservationstobemoni-toredinPhaseIIofthefunctionalresponseandcovariates,respectively.•alpha,thelistcontainingtheTypeIerrorfortheHotelling’sT2andtheSPEcon-trolcharts.Thedefaultvalueislist(T2=0.025,spe=0.025),whichusestheBonferronicorrectiontoensuretheoverallTypeIerrorαisnotlargerthan0.05.Theplot_control_charts()functioncanbeusedtoplotthecontrolchartsasinFigure9.R>cclist_fof_pc<-regr_cc_fof(+object=mod_fof,+mfdobj_y_tuning=mfdI_tun[,"Y"],+mfdobj_x_tuning=mfdI_tun[,c("X1","X2","X3")],+mfdobj_y_new=mfdII_fof[,"Y"],+mfdobj_x_new=mfdII_fof[,c("X1","X2","X3")])R>plot_control_charts(cclist_fof_pc)&+geom_vline(aes(xintercept=c(20.5)),lty=2)&+geom_vline(aes(xintercept=c(40.5)),lty=2)Intheﬁrstgroupofobservations(generatedfromICprocess)thereisafalsealarmsignaledbytheSPEcontrolchart,inthesecondgroupofobservations(whicharegeneratedwith19−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−2122232425272829303133343536373840414243444546474849505152535455565758596002550751001357911131517192123252729313335373941434547495153555759ObservationT2 statisticHOTELLING T2 CONTROL CHART−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−172528424547485255560.0000.0050.0100.0150.0200.0251357911131517192123252729313335373941434547495153555759ObservationSPE statisticSPE CONTROL CHARTFigure9:PhaseIIcontrolchartingforthefunction-on-functionregressioncase.VerticallinesseparatethethreegroupsofsimulatedPhaseIIdata.Horizontallinescorrespondtocontrolchartlimits,pointscorrespondtotheobservationsofthemonitoringstatisticsforeachobservation.Redpointsandobservationindexhighlightmonitoringstatisticsthatareoutofthecorrespondingcontrollimits.moderatemeanshiftonboththethirdfunctionalcovariateandthefunctionalresponse),onlythreeobservationswithinthecontrollimits,whileinthelastgroup(withmoreseveremeanshifts)allobservationsaresignaledasOC.Notethatregr_cc_fof()providescontrolchartsonthepredictionerrorofthefunctionalresponse,withoutmonitoringdirectlythemultivariatefunctionalcovariates.Thismeansthat,forexample,anobservationwithparticularlyanomalousvaluesofsomefunctionalcovariatesthatstillproducesgoodpredictionofthefunctionalresponse,suchthatthepredictionerrorplotsIC.ThishappensbecauseCentofantietal.(2021)focusedonansweringtotheresearchquestion:giventhevalueofthefunctionalcovariates,istheobservedresponseproﬁleasexpected?3.5.Real-timefunctionalcontrolchartsThefunchartspackageprovidesthereal-timefunctionalcontrolchartsstatedinSection2.4throughthefunctionscontrol_charts_pca_mfd_real_time(),control_charts_sof_pc_real_time(),andregr_cc_fof_real_time(),whicharethereal-timeversionofthemainfunctionspre-sentedinSection2.2,2.3.1and2.3.2,respectively.Forshortness,inthissectionweillustrateonlythereal-timeversionofthefunctionalcontrolchartbasedonfunction-on-functionregres-sionintroducedinSection2.3.2andimplementedinSection3.4.2.StartingfromthefunctionaldomainT=(a,b),inthefollowing,weconsidertheevolutionofthefunctionaldataoverthesubintervals(a,a+k(b−a))),withkvaryingalongk_seq,whichisanadditionalinputvectorcontainingvaluesdeﬁningthefractionofdomainoverwhichfunctionaldataarepartiallyobserved.Bydefault,k_seqisthesequenceofvalues0.2,0.3,...,1.Inthesamewayasthe20funcharts:ControlchartsformultivariatefunctionaldatainRcorrespondingfunctionsdevelopedforthecompletelyobservedfunctionaldata,thefunchartspackageprovidesthefunctionsget_mfd_array_real_time(),get_mfd_list_real_time()andget_mfd_df_real_time(),whichacceptasinputlistsofmatrices,arraysanddataframesinthelongformat.Thesefunctionsreturnasoutputalistofmfdobjects,eachpartiallyob-servedontheinterval(a,a+k(b−a)))andcreatethedatasetsrequiredtoperformthereal-timefunctionalcontrolcharts,asperthefollowingcode.R>xI<-get_mfd_list_real_time(d$datI[c("X1","X2","X3")])R>yI<-get_mfd_list_real_time(d$datI["Y"])R>xI_tun<-get_mfd_list_real_time(d$datI_tun[c("X1","X2","X3")])R>yI_tun<-get_mfd_list_real_time(d$datI_tun["Y"])R>xII<-get_mfd_list_real_time(d$datII[c("X1","X2","X3")])R>yII<-get_mfd_list_real_time(d$datII["Y"])Then,thefof_pc_real_time()functionappliesthefof_pc()functiontoeachelementinthelistisyIandxI,andreturnsalistofequallength.R>mod_realtime<-fof_pc_real_time(yI,xI)Theregr_cc_fof_real_time()functionisusedtoapplyregr_cc_fof()toeachelementinthelistmod_realtimeandproduceadataframetoplotthecontrolchartsforthereal-timePhaseIImonitoringofdatasetsyIIandxII.R>cc_realtime<-regr_cc_fof_real_time(+mod_list=mod_realtime,+mfdobj_y_new_list=yII,+mfdobj_x_new_list=xII,+mfdobj_y_tuning_list=yI_tun,+mfdobj_x_tuning_list=xI_tun)Wecanﬁnallyplotthereal-timefunctionalcontrolchartsforasingleobservation,whichshows,foreachk,themonitoringstatisticscalculatedonthedataobservedin(a,a+k(b−a))).Figure10showsanexampleforthefutureobservation30,belongingtothesecondgroupofPhaseIIobservations(seeSection3.1).Becauseofthemeanshiftinboththethirdcovariateandtheresponse,ananomalousbehaviourissignalledintheﬁnalpartofthefunctionaldomainbytheHotelling’sT2.AlsonoteinFigure10thatthemonitoringstatisticscorrespondingtok=1,i.e.,whentheproﬁlesarefullyobserved,areequaltothemonitoringstatisticsofthefutureobservation30shownonthecontrolchartinFigure9.R>plot_control_charts_real_time(cc_realtime,id_num=30)4.Areal-casestudy:shipCO2emissionmonitoringToillustratetheuseofthefunchartspackageinpracticalcases,wepresentinthissectionareal-casestudyontheSPMofRo-PaxshipCO2emissionsduringnavigation,whichis21051015200.20.30.40.50.60.70.80.91.0tT2UCLHOTELLING T2 CONTROL CHART0.0000.0020.0040.0060.0080.20.30.40.50.60.70.80.91.0tSPEUCLSPE CONTROL CHARTFigure10:Real-timecontrolchartsbasedonfunction-on-functionregressiontomonitorthesimulatedPhaseIIobservation30.Solidlinesshowtheproﬁlesofthemonitoringstatistics(T2andSPE),colouredinrediftheyareabovethecorrespondinguppercontrollimits(UCL),drawnasdashedlines.deﬁnedasthetimeintervalbetweentheﬁnishedwithengineorder(whentheshipleavesthedepartureport)andthestandbyengineorder(whentheshipentersthearrivalport).Thetopichasbecomeextremelyrelevantintherecentyearsinviewofthedramaticclimatechange.AttheEuropeanlevel,theRegulationEU2015/757oftheEuropeanUnion(EU)Council,byfollowingtheguidelinesoftheInternationalMaritimeOrganization,hasurgedshipsoperatingintheMediterraneanSeatoadoptsystemsformonitoring,reportingandveriﬁcationofCO2emissions.Eventhoughonlysummarystatisticsarestrictlyrequiredbythisregulation,shippingcompaniesareequippingtheirﬂeetwithmulti-sensorsystemsthatmakeavailablelargeamountsofhigh-frequencyoperationaldata,whichcanbenaturallyregardedasfunctionaldata.Inthisreal-casestudy,weuseapartoftheShipNavigationdataset,whichiscourtesyofthemultinationallogisticgroupandshippingcompanyGrimaldiGroupandisavailableintheSupplementaryMaterial.Thecompletedatasetcontainsfouryears’worthofdatacollectedinrealtimewithﬁve-minutefrequencyonboardofaRo-PaxshipconnectingthreemainportsoftheMediterraneansea,eventhoughsomeminorportsarerarelyusedasintermediatesteps.Forconﬁdentialityreason,thenameoftheshipandportsaswellasthegpsdataareomit-ted.Thedatetimevariablecountsthenumberofsecondsfromareferenceomitteddate.Mostofthevariablesarescaledbydividingbythemaximumabsolutevalue.Inparticular,CO2_emissionsaremeasuredindirectlybasedonthefuelconsumption,whichinturniscal-culatedbasedontheenginepowermeasurements.Eachvariableproﬁlereferstoashipvoyageconnectingadepartureandanarrivalportandisdeﬁnedasafunctionofthefractionofthetotalnavigationdistancetraveledbytheshipateachvoyage,i.e.,onthedomainT=(0,1).Voyagesofthecompletedatasetareidentiﬁedbyauniquevoyagenumber(VN)labelwithaprogressivenumberandisstoredintheVNcolumn,sothattimeorderispreserved.More-22funcharts:ControlchartsformultivariatefunctionaldatainRCO2pm vs sogCO2pm vs w_longCO2pm vs w_trasvCO2pm vs trim0.000.250.500.751.000.000.250.500.751.000.000.250.500.751.000.000.250.500.751.000.000.250.500.751.00s                                            s                                            s                                            st−15−10−5051015valueFigure11:Estimatedfunctionalcoeﬃcientofthefunction-on-functionregressionmodelonthePhaseInavigationdataset.over,itisknownthatanenergyeﬃciencyinitiative(EEI)wasperformedontheshipbetweenVN1251andVN1252andplausiblyproducedameanshiftintheCO2emissions.FormoredetailsonthevariabledescriptionthereadermayrefertoErto,Lepore,Palumbo,andVitiello(2015);Bocchetti,Lepore,Palumbo,andVitiello(2015).Inthisreal-casestudy,wefocusonthePhaseIImonitoringofCO2emissionsaftertheEEIduringnavigationonaspeciﬁcroutefromportCtoportA,throughproﬁlesoftheCO2emissionspermile(identiﬁedbythevariableCO2pm)adjustedbytheinﬂuenceoffourfunctionalcovariates,namelytheshipspeedovergroundsogandthetrim,aswellasthelongitudinal(w_long)andtransverse(w_trasv)componentsofthewind.Thus,wecanapplythemethodsdescribedinSection2.3.2.Ifinsteadtheinterestisinascalarresponse,suchasthetotalCO2emissionsateachvoyage,thereadermaywanttorefertothemethodsdescribedinSection2.3.1.Thereferencedatasetofthisreal-casestudyisthenobtainedbyincludingoneyear’sworthofdatauptothelastvoyagebeforetheEEIpertainingtotheconsideredroute,i.e.,the159voyagesbetweenVN0519andVN1248.Then,PhaseIImonitoringstartsfromVN1257.IntheSupplementaryMaterialS3weprovidethepre-processingcodethatloadstheShipNavigationdatasetandreturnsthemfdobjectsy1,x1,y2andx2,whichcontaintheobservationsofthefunctionalresponseandcovariates,dividedintoreferencedatasetandfutureobservationstobeusedinPhaseII.Giventhesedata,thefunction-on-functionregressionmodelcanbeﬁtasfollowsandthefunctionalcontrolchartbasedonstudentizedresidualsisbuilt.R>mod<-fof_pc(y1,x1,type_residuals="studentized")R>plot_bifd(mod$beta_fd)R>cc<-regr_cc_fof(mod,mfdobj_y_new=y2,mfdobj_x_new=x2,+alpha=list(T2=0.005,spe=0.005))R>cutpoint<-which(c(obs1,obs2)>"VN1248")[1]R>plot_control_charts(cc)&geom_vline(aes(xintercept=cutpoint),lty=2)Figure11showstheestimatedfunctionalregressioncoeﬃcients,whileFigure12showsthePhaseIIcontrolcharts.Notethatthemonitoringstatisticscalculatedonthereferencedatasetareplotted,forconvenienceofgraphicalcomparison,onthelefthandsideoftheverticaldashedlineingray.WesetanoverallTypeIerrorα=0.01andusetheBonferronicorrectiontotakeintoaccountthesimultaneoususeofthetwocontrolcharts.Asexpected,both23−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−160161164165166167168169171172173174178179180182183185188189190191192193194200201202206207210211214215219221222223229230231232235236237238239240241242243246247248249250251253256257258261268269270271273278279282290293307310311312313316317318319320322323324325326328329333−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−050100150200191725334149576573818997105113121129137145153161169177185193201209217225233241249257265273281289297305313321329ObservationT2 statisticHOTELLING T2 CONTROL CHART−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−160165167171179180182186188189197199200201202204206214219221222223224226227229230231234235236239242251252253254255257258260261264265266267268269270272273277280286290292296303307311317325328333−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−0.000.020.040.06191725334149576573818997105113121129137145153161169177185193201209217225233241249257265273281289297305313321329ObservationSPE statisticSPE CONTROL CHARTFigure12:Functionalcontrolchartforthereal-casestudyontheShipNavigationdata.Theverticaldashedlineseparatesthereferencedataset,whosepointsarereportedingray,fromthePhaseIIdataset.Horizontallinescorrespondtocontrolchartlimits,pointscorrespondtotheobservationsofthemonitoringstatisticsforeachobservation.Redpointsandobservationindexhighlightmonitoringstatisticsthatplotoutsideofthecorrespondingcontrollimits.Hotelling’sT2andSPEcontrolchartsshowaclearmeanshiftinthefunctionalstudentizedresidualsafterEEI,whichismarkedbyadashedverticalline.Toillustratethereal-timeapplicationofthesecontrolcharts,weconsiderthelastobservationshowninFigure12,thatisobservation333(identiﬁedbyVN2054).Thereal-timeHotelling’sT2andSPEcontrolchartsforthisobservation,plottedinFigure13,areobtainedthroughthefollowingcode.R>modl<-fof_pc_real_time(mfdobj_y_list=y1l,+mfdobj_x_list=x1l,+type_residuals="studentized")R>ccl<-regr_cc_fof_real_time(mod_list=modl,+mfdobj_y_new_list=y2l,+mfdobj_x_new_list=x2l,+alpha=list(T2=0.005,spe=0.005))R>plot_control_charts_real_time(ccl,333)Thelistsofmfdobjectsy1l,x1l,y2landx2l,containingthereal-timeobservationsofthefunctionalresponseandcovariatesareobtainedthroughthepre-processingcodeprovidedbySupplementaryMaterialS3.Figure13showsthereal-timefunctionalcontrolchartplottedfortheobservation333.Wecannoticethatthemonitoringstatisticsgoverylargeinthecentralpartofthedomain,wherethefunctionalresidualproﬁleisshowntobeparticularlylow(Figure14).Oncethevoyageiscompleted,thepredict_fof_pc()functioncanbeusedtoobtainthefunc-tionalstudentizedresidualsofagivenvoyage,e.g.,theOCproﬁleofthestudentizedresidual24funcharts:ControlchartsformultivariatefunctionaldatainR02550751000.250.330.420.500.580.670.750.830.921.00fraction of distance travelledT2UCLHOTELLING T2 CONTROL CHART0.000.020.040.250.330.420.500.580.670.750.830.921.00fraction of distance travelledSPEUCLSPE CONTROL CHARTFigure13:Real-timefunctionalcontrolcharttomonitorthePhaseIIobservation333inthenavigationdataset.Solidlinesshowtheproﬁlesofthemonitoringstatistics(T2andSPE),colouredinrediftheyareabovethecorrespondinguppercontrollimits(UCL),drawnasdashedlines.correspondingtoobservation333.Usingthefunctionplot_mon,inFigure14thisproﬁleissuperimposedonthefunctionalstudentizedresidualproﬁlescalculatedonthereferencedatasetandstoredintheobjectmodbythefollowingcode.R>yhat<-predict_fof_pc(object=mod,mfdobj_y_new=y2,mfdobj_x_new=x2)R>plot_mon(cc,mod$residuals,yhat$pred_error[333])InaccordancewithFigure13,Figure14showsalargenegativepredictionerrorforCO2emissionsofobservation333inthecentralpartofthevoyage,whichhaveledtolargevaluesofthemonitoringstatistics.Thishighlightsthat,conditionallyonthefunctionalcovariates,inthatpartofthevoyage,theproﬁleoftheCO2emissionspermileisparticularlylowerthanexpected.5.ConclusionsThisarticleillustratesthefunchartsRpackage,whichistheﬁrstoﬀ-the-shelftoolkitfortheSPMofprocessescharacterizedbyqualitycharacteristicsintheformoffunctionaldata.Inparticular,funchartsimplementsthemethodsproposedbyColosimoandPacella(2010)andtherecentSPMframeworksofCapezzaetal.(2020)andCentofantietal.(2021).Thepackageprovidespractitionerswithtoolstogeneratefunctionaldata,toperformmultivariatefunctionalprincipalcomponentanalysis,tobuildcontrolchartsforthemonitoringofshiftsintheprocessfunctionmean.Thereal-timeversionofthesetoolsisalsoprovidedwhenfunctionaldataareobservedonlyuptoagivenpoint.Wedemonstratethepackagethroughitsbuilt-indatageneratoraswellasareal-casestudyonthemonitoringofCO2emissions25CO2pm0.000.250.500.751.00−2024fraction of distance travelledFigure14:TheOCproﬁleofthestudentizedresidualcorrespondingtotheobservation333,superimposedinredonthefunctionalstudentizedresidualproﬁlescalculatedonthereferencedataset.duringthenavigationofaRo-Paxship,courtesyoftheItalianshippingcompanyGrimaldiGroup.6.ComputationaldetailsTheresultsinthisarticleareobtainedusing64-bitR4.1.2withthefuncharts1.2.0packageandacomputerwithanIntel©CoreTMi9-9980HKCPUat2.40GHz32GBofRAMonUbuntu20.04.Thispackagemakesuseofthefda5.5.1packagetogetfunctionaldatafromdiscreteobservationsandtoﬁtthemultivariatefunctionalprincipalcomponent.Thepackagedependsontheggplot23.3.5andpatchwork1.1.1packages,forplottingfunctionaldataandcontrolcharts,andparallel4.1.2package,fortheparallelcomputation.RitselfandthesepackagesareavailablefromtheComprehensiveRArchiveNetwork(CRAN)athttps://CRAN.R-project.org/.Onthiscomputer,thecomputationtimerequiredtoproducealltheresultsshowninSection3wasabout90seconds,whiletherealcase-studyinSection4requiredabout25minutesofcomputationtime.7.AbouttheauthorsChristianCapezzaisaresearcherinStatisticsforexperimentalandtechnologicalresearchattheDepartmentofIndustrialEngineeringoftheUniversityofNaplesFedericoII.Heworksonadvancedstatisticalmethodologiesforengineeringapplicationsandhisresearchprojectre-gardsthedevelopmentofinterpretablestatisticalmethodsfortheanalysisofcomplexsystemsinIndustry4.0.FabioCentofantiisapost-docresearcherattheDepartmentofCivil,BuildingandEnviro-mentalEngineeringoftheUniversityofNaplesFedericoII,Italy.Hismainresearchinterestsincludefunctionaldataanalysisandstatisticalprocessmonitoringforindustrialapplications.AntonioLeporeisanAssociateProfessorofStatisticsforexperimentalandtechnologicalresearchattheDepartmentofIndustrialEngineeringoftheUniversityofNaplesFedericoII,Italy.Hismainresearchinterestsincludetheindustrialapplicationofstatisticaltechniquesto26funcharts:ControlchartsformultivariatefunctionaldatainRthemonitoringofcomplexmeasurementproﬁlesfrommultisensoracquisitionsystems,withparticularattentiontorenewableenergyandharmfulemissions.AlessandraMenafoglioisanAssistantProfessoratMOX,DepartmentofMathematics,PolitecnicodiMilano.Herresearchinterestsfocusonthedevelopmentofinnovativestatisticalmodelsandmethodsfortheanalysisandstatisticalprocesscontrolofcomplexobservations(e.g.curves,imagesandfunctionalsignals),possiblycharacterizedbyspatialdependence.BiagioPalumboisanAssociateProfessorofStatisticsforexperimentalandtechnologicalresearchattheDepartmentofIndustrialEngineeringoftheUniversityofNaplesFedericoII,Italy.Hismajorresearchinterestsincludereliability,designandanalysisofexperiments,statisticalmethodsforprocessmonitoringandoptimizationanddatasciencefortechnology.SimoneVantiniisanAssociateProfessorofStatisticsatthePolitecnicodiMilano,Italy.HehasbeenpublishingwidelyinFunctionalandObject-OrientedDataAnalysis.Hiscurrentresearchinterestsincludepermutationtesting,non-parametricforecasting,processcontrol,non-Euclideandataandingeneralstatisticalmethodsandapplicationsmotivatedbybusinessorindustrialproblems.8.AcknowledgementsTheauthorsareextremelygratefultotheGrimaldiGroup’sEnergySavingDepartmentengi-neersDarioBocchettiandAndreaD’AmbrafortheaccesstotheShipNavigationdataandthegeneralsupportoverthecourseoftheseactivities.9.FundingThepresentworkwaspartlydevelopedwithintheactivitiesoftheproject“FunctionalDataAnalysisforTraﬃcOperations”fundedby“ProgrammaperilﬁnanziamentodellaricercadiAteneo–LineaB”oftheUniversityofNaplesFedericoII(ref.ALTRI_CdA_75_2021_FRA_LINEA_B).ReferencesBocchettiD,LeporeA,PalumboB,VitielloL(2015).“Astatisticalapproachtoshipfuelconsumptionmonitoring.”JournalofShipResearch,59(3),162–171.CapezzaC,CentofantiF,LeporeA,MenafoglioA,PalumboB,VantiniS(2022).funcharts:FunctionalControlCharts.Rpackageversion1.2.0,URLhttps://CRAN.R-project.org/package=funcharts.CapezzaC,LeporeA,MenafoglioA,PalumboB,VantiniS(2020).“Controlchartsformoni-toringshipoperatingconditionsandCO2emissionsbasedonscalar-on-functionregression.”AppliedStochasticModelsinBusinessandIndustry,36(3),477–500.CentofantiF,LeporeA,MenafoglioA,PalumboB,VantiniS(2021).“FunctionalRegressionControlChart.”Technometrics,63(3),281–294.ChiouJM,ChenYT,YangYF(2014).“Multivariatefunctionalprincipalcomponentanalysis:Anormalizationapproach.”StatisticaSinica,pp.1571–1596.27ColosimoBM,PacellaM(2010).“Acomparisonstudyofcontrolchartsforstatisticalmoni-toringoffunctionaldata.”InternationalJournalofProductionResearch,48(6),1575–1601.DeBoorC(1978).Apracticalguidetosplines.Springer-VerlagNewYork.ErtoP,LeporeA,PalumboB,VitielloL(2015).“AProcedureforPredictingandControl-lingtheShipFuelConsumption:ItsImplementationandTest.”QualityandReliabilityEngineeringInternational,31(7),1177–1184.FerratyF,VieuP(2006).Nonparametricfunctionaldataanalysis:theoryandpractice.SpringerScience&BusinessMedia.GrassoM,ColosimoBM,TsungF(2017).“AphaseImulti-modellingapproachforproﬁlemonitoringofsignaldata.”InternationalJournalofProductionResearch,55(15),4354–4377.GrassoM,MenafoglioA,ColosimoBM,SecchiP(2016).“Usingcurve-registrationinforma-tionforproﬁlemonitoring.”JournalofQualityTechnology,48(2),99–127.GreenPJ,SilvermanBW(1994).Nonparametricregressionandgeneralizedlinearmodels:aroughnesspenaltyapproach.ChapmanandHall/CRC.HappC,GrevenS(2018).“Multivariatefunctionalprincipalcomponentanalysisfordataob-servedondiﬀerent(dimensional)domains.”JournaloftheAmericanStatisticalAssociation,113(522),649–659.HorváthL,KokoszkaP(2012).Inferenceforfunctionaldatawithapplications.SpringerScience&BusinessMedia.HsuJ(1996).Multiplecomparisons:theoryandmethods.CRCPress.JacquesJ,PredaC(2014).“Model-basedclusteringformultivariatefunctionaldata.”Com-putationalStatistics&DataAnalysis,71,92–106.JinJ,ShiJ(1999).“Feature-preservingdatacompressionofstampingtonnageinformationusingwavelets.”Technometrics,41(4),327–339.JonesCL,Abdel-SalamASG,MaysD(2021).“Practitionersguideonparametric,non-parametric,andsemiparametricproﬁlemonitoring.”QualityandReliabilityEngineeringInternational,37(3),857–881.KokoszkaP,ReimherrM(2017).Introductiontofunctionaldataanalysis.CRCPress.MalekiMR,AmiriA,CastagliolaP(2018).“Anoverviewonrecentproﬁlemonitoringpapers(2008–2018)basedonconceptualclassiﬁcationscheme.”Computers&IndustrialEngineer-ing,126,705–728.MandelB(1969).“Theregressioncontrolchart.”JournalofQualityTechnology,1(1),1–9.MarcondesFilhoD,ValkM(2020).“DynamicVARmodel-basedcontrolchartsforbatchprocessmonitoring.”EuropeanJournalofOperationalResearch,285(1),296–305.28funcharts:ControlchartsformultivariatefunctionaldatainRMenafoglioA,GrassoM,SecchiP,ColosimoBM(2018).“ProﬁlemonitoringofprobabilitydensityfunctionsviasimplicialfunctionalPCAwithapplicationtoimagedata.”Techno-metrics,60(4),497–510.NoorossanaR,SaghaeiA,AmiriA(2011).Statisticalanalysisofproﬁlemonitoring,volume865.JohnWiley&Sons.PedersenTL(2020).patchwork:TheComposerofPlots.Rpackageversion1.1.1,URLhttps://CRAN.R-project.org/package=patchwork.RamsayJO,GravesS,HookerG(2021).fda:FunctionalDataAnalysis.Rpackageversion5.4.0,URLhttps://CRAN.R-project.org/package=fda.RamsayJO,SilvermanBW(2005).Functionaldataanalysis.Springer.ScruccaLS,SnowG,BloomﬁeldP(2017).qcc:QualityControlCharts.Rpackageversion2.7,URLhttps://CRAN.R-project.org/package=pcc.ValkM,FilhoDM,CybisG(2020).dvqcc:DynamicVAR-BasedControlChartsforBatchProcessMonitoring.Rpackageversion0.1.0,URLhttps://CRAN.R-project.org/package=dvqcc.WahbaG(1990).Splinemodelsforobservationaldata,volume59.SIAM.WoodallWH,SpitznerDJ,MontgomeryDC,GuptaS(2004).“Usingcontrolchartstomonitorprocessandproductqualityproﬁles.”JournalofQualityTechnology,36(3),309–320.SupplementaryMaterial:funcharts:ControlchartsformultivariatefunctionaldatainRS1DetailsonsimulationS1.1MathematicaldetailsForthecontrolchartsbasedonscalar-on-functionregression,describedinSec-tion2.3.1,mathematicaldetailsonhowdataaregeneratedaregivenasfollows.Togeneratethescalarresponse,weneedtodeﬁnetheregressioncoeﬃcientsinEquation(5).Thescalarinterceptissetasβ0=0,while,asshowninEqua-tion(6),afterbasisexpansionfunctionalcoeﬃcientsweneedtosetcoeﬃcientsb1,...,bM,wherewesetM=50,dependingonthedesiredvalueofR2,whereR2=var(E(y|X1(s),...,XP(s))/var(y).WeconsiderthreevaluesforR2.Inparticular,forl=1,...,10,toachieveR2=0.97wesetbl=0.587709,whiletoachieveR2=0.86wesetbl=0.5533828,andtoachieveR2=0.74wesetbl=0.5133249.Notethatwesetbl=0forl>10.Then,inordertoensurethevalidityofthemodelinEquation(5),realizationsofthescalarresponsevariableareobtainedasyi=PMm=1ξimbm+εi,whereξimarethescoresofthemultivariatefunctionalcovariatesandwegenerateεi∼N(0,σ2ε)independentofthefunctionalcovariates,withσ2ε=σ2−PMm=1b2mλm,whereλmarethevariancesofthescores.Finally,ameanshiftonthescalarresponseisobtainedbyaddingtothesimulatedvaluesaﬁxedquantityequaltotheseverityd.Formathematicaldetailsonthefunction-on-functionregressioncase,thereaderisreferredtoCentofanti,Lepore,Menafoglio,Palumbo,andVantini(2021).S1.2ImplementationdetailsThefunctionsim_funcharts()reliesonthefunctionsimulate_mfd()tosim-ulatefunctionaldatawithfuncharts.Thefunctionsimulate_mfd()generatesadatasetwiththreefunctionalcovariates,afunctionalresponsegeneratedasafunctionofthethreefunctionalcovariatesthroughafunction-on-functionlinearmodel,andascalarresponse(independentofthefunctionalone)generatedasafunctionofthethreefunctionalcovariatesthroughascalar-on-functionlinearmodel.1arXiv:2207.09321v1  [stat.CO]  19 Jul 2022Inparticular,eachsimulatedobservationofafunctionalvariableconsistsofavectorof150discretepoints,equallyspacedonthefunctionaldomainT=(0,1),generatedwithnoise.Inthedefaultcase,thefunctiongeneratesdatafromtheprocesswhenitisincontrol.Additionalargumentscanbeusedtogeneratedatafromanout-of-controlprocess,withmeanshiftsaccordingtothescenariosproposedbyCentofantietal.(2021).Sincefunctionaldataareobservedonaregulargrid,thefunctionreturnsalistofmatrices,eachcorrespondingtoafunctionalvariable,andavectorforthescalarresponse.Thematriceshavethenumberofrowsequaltothesamplesizeandthenumberofcolumnsequalto150,i.e.,thenumberofdiscretepointsofeachfunctionalobservation.Themainargumentsofsimulate_mfd()are:•nobs:thenumberofobservationstobegenerated.•R2:theR2oftheregressionmodel.•shift_type_y,shift_type_x1,shift_type_x2,shift_type_x3:theshifttypeonthemeanofthecorrespondingfunctionalvariable,accordingtoAppendixS1.•d_y,d_x1,d_x2,d_x3,d_y_scalar:theseverityofthemeanshiftofthecorrespondingvariable.Inthefollowing,wereportthecodeofthefunctionsim_funcharts():R>datI<-simulate_mfd(nobs=1000)R>datI_tun<-simulate_mfd(1000)R>datII_ic<-simulate_mfd(20)R>datII_oc1<-simulate_mfd(20,shift_type_x3="A",d_x3=20,+d_y_scalar=1,shift_type_y="D",d_y=0.5)R>datII_oc2<-simulate_mfd(20,shift_type_x3="A",d_x3=40,+d_y_scalar=2,shift_type_y="D",d_y=1.5)R>datII<-list()R>for(iiin1:4){+datII[[ii]]<-rbind(datII_ic[[ii]],datII_oc1[[ii]],datII_oc2[[ii]])+datII[[ii]]<-rbind(datII_ic[[ii]],datII_oc1[[ii]],datII_oc2[[ii]])+datII[[ii]]<-rbind(datII_ic[[ii]],datII_oc1[[ii]],datII_oc2[[ii]])+}R>datII[[5]]<-c(datII_ic[[5]],datII_oc1[[5]],datII_oc2[[5]])R>names(datII)<-names(datI)R>return(list(datI=datI,datI_tun=datI_tun,datII=datII))S2DetailsonthemfdclassThefunchartspackageprovidesthemfdclassformultivariatefunctionaldata,whichinheritsfromthefdclassofthefdapackageandprovidessomeadditionalfeatures.Inparticular,itforcesthecoefargumenttobeathree-dimensionalarrayevenwhendealingwithsinglefunctionalobservationsand/orvariablesand2itprovidesabettersubsetfunction[thatneverdropsdimensions,i.e.,italwaysreturnsamfdobjectwiththree-dimensionalarrayargument,moreoveritallowsextractingobservations/variablesalsobyname;whenpossible,itstorestheoriginalrawdatainthelongdataframeformat,whichisusefulforplottingtherawdiscretedatainsteadofthesmoothedproﬁleswiththefunctionsprovidedbythepackage.Theﬁrststepinfunctionaldataanalysisisusuallytogetsmoothfunctionaldatafromtheoriginaldiscreteobservations.ThefunchartspackageobtainssmoothfunctionaldataasdescribedinSection2.1,whereinparticularthesmoothingparameterisselectedbyminimizingthegeneralizedcross-validationcriterionoveragridofvalues.Tothispurpose,thefunchartspackageprovidesseveralfunctionsdependingonthedatatypepassedasinput:•get_mfd_df():foradataframeinthelongformat,withonecolumnwhosenamemustbepassedasastringtotheargargument,givingthedomainvalues,onecolumnwhosenamemustbepassedasastringtotheidargument,denotingacategoricalvariableindicatingthefunctionalobservation,andonecolumnpereachfunctionalvariableindicatingthecorrespondingyvalues.Namesoffunctionalvariablesmustbepassedasavectorofstringstothevariablesargument•get_mfd_list():foralistofmatrices,inthecaseallfunctionaldataareobservedonthesamegrid,where,foreachmatrix,eachrowcorrespondstoafunctionalobservationandeachcolumncorrespondstoapointonthegrid.•get_mfd_array():forathree-dimensionalarray,inthecaseallfunctionaldataareobservedonthesamegrid,wheretheﬁrstdimensioncorrespondstogridpoints,thesecondtoreplications,andthethirdtovariableswithinreplications.Themainargumentsofthesefunctionsare:•n_basis:thenumberofB-splinebasisfunctions,defaultis30.•lambda_grid:agridofvaluesfromwhichthesmoothingparametershavetobechosenforeachfunctionaldatum.Inthefunchartspackage,weassumefunctionaldataaredenselyobservedovertheircompactdomain.However,itisimportanttodistinguishthetwocaseswhereallfunctionaldataareobservedonacommongrid,fromtheonewhereeachfunctionalobservationhasaitsownsetofgridpoints.Infuncharts,theformercaseiscoveredbythefunctionsget_mfd_array()andget_mfd_list(),whilethelatterrequirestousethefunctionget_mfd_df()withadataframeinthelongformat,asinthereal-casestudyshowninSection4.Fromacomputationalpointofview,havingdiﬀerentgridpointsforeachfunctionalobservationrequireslongercalculations.Letusfocusonthei-thsampleofasinglefunctionalvariableyi(t)observedonagridti1,...,tigiofgidomainpoints.Letusestimatethefunctionalobservationgivenaﬁxedsmoothingpa-rameterλ.IfwehaveKB-splinebasisfunctionsB1(t),...,BK(t),wecan3denotethegi×KdesignmatrixcontainingthebasisfunctionevaluationsasZi=(zi1,...,ziK),wherezik=(Bk(ti1),...,Bk(tigi))>andthevectoroftheobservedfunctionalvaluesasyi=(yi(ti1),...,yi(tigi))>.IfwedenotetheK×KmatrixpenalizingtheintegratedsquaredsecondderivativesasSwhose(i,j)-thelementisSi,j=RTB(2)i(t)B(2)j(t)dt,thenwecanestimatethefunctionasyi(t)=PKk=1bikBk(t),wherebi=(bi1,...,biK)>=(Z>iZi+λS)−1Z>iyi.Ifthegridscontainingthedomainpointsoverwhichfunctionaldataareobservedarediﬀerent,werequireasmanymatrixinversionsasthesamplesizentogetallfunctionaldataforaﬁxedsmoothingparameter.Ifinsteadallfunctionaldataareobservedonthesamegridt1,...,tg,thenallisubscriptsabovedisappearandwecanarrangeallfunctionalvaluesintoag×nmatrixY=(y1,...,yn),whereyi=(yi(t1),...,yi(tg)).ThismeansthatwithasinglematrixinversionwegetallbasiscoeﬃcientstogetherintheK×nmatrixB=(b1,...,bn),wherebi=(bi1,...,biK)>,i.e.,B=(Z>Z+λS)−1Z>Y.Inordertosavecomputa-tionaltimewiththelongdataframecasethroughget_mfd_df(),wecanuseparallelcomputationbysettingtheargumentncoresgreaterthan1.S3Pre-processingoftheShipNavigationdatasetInthisSection,weshowhowtheShipNavigationdataset,providedasSup-plementaryMaterial,isloadedandpre-processedinordertoobtainthedataanalysedinSection4.First,letusloadthedata,thenweneedtocalculatetheCO2emissionspermileandﬁlteronlytherequiredrows,correspondingtotheconsideredroutefromportCtoportA.R>load("ShipNavigation.RData")R>dft<-ShipNavigation%>%+group_by(VN)%>%+mutate(CO2pm=CO2_emissions/nautic_miles)%>%+ungroup()%>%+filter(position=="C->A")%>%+na.omit()Nowwecanusethefunchartspackagetogetfunctionaldatafromtheoriginalobservations.Inthisapplicationwechoose100B-splinebasisfunctions.NotethatfromthePhaseIanalysis,whichwedonotincludehereforbrevityandbecausethefocusoffunchartsisonPhaseIImonitoring,weremovetwooutliervoyages,VN0920andVN0533.Thefollowingcodebuildsthemfdobjectthatwillbeusedintheanalysis,itremovestheoutliers,anditcreatesthefunctionalresponseandcovariatesmfdobjectsforPhaseIandII,i.e.y1,x1,y2,x2.R>yvar<-"CO2pm"R>xvar<-c("sog","w_long","w_trasv","trim")R>R>x<-get_mfd_df(dt=dft,4+arg="percent_miles",+domain=c(0,1),+id="VN",+variables=c(xvar,yvar),+n_basis=100)R>outliers<-c("VN0920","VN0533")R>obs<-unique(dft$VN)R>obs<-obs[!(obs%in%outliers)]R>x<-x[obs]R>obs1<-obs[obs<="VN1249"&obs>="VN0517"]R>obs2<-obs[obs>"VN1249"&obs<="VN2054"]R>x1<-x[obs1,xvar]R>y1<-x[obs1,yvar]R>x2<-x[c(obs1,obs2),xvar]R>y2<-x[c(obs1,obs2),yvar]Notethatiny2,x2weincludebothobservationsobs1andobs2areincluded.Therefore,controlchartsusingtheseobjectswillshowbothPhaseIandPhaseIIdata.Fortheimplementationofthereal-timefunctionalcontrolcharts,theregis-trationoffunctionaldata,whichisaproblembeyondthescopeofthefunchartspackage,hasalreadybeenappliedinadvance,thentheShipNavigationdatasetalreadyincludesthecolumnpercent_miles_hatthatestimatesthefractionofdistancetraveledinrealtimeasproposedbyCapezza,Lepore,Menafoglio,Palumbo,andVantini(2020).Notethattheprocedurehasonlybeenappliedontherouteswithatleast10voyages.Thefollowingcodebuildsthelistsofmfdobjectsy1l,x1l,y2landx2l,containingthereal-timeobservationsofthefunctionalresponseandcovariates,dividedbetweenPhaseIandPhaseII.R>xl<-get_mfd_df_real_time(dt=dft,+domain=c(0,1),+arg="percent_miles_hat",+id="VN",+variables=c(xvar,yvar),+n_basis=100)R>y1l<-lapply(xl,function(x)x[obs1,yvar])R>x1l<-lapply(xl,function(x)x[obs1,xvar])R>y2l<-lapply(xl,function(x)x[c(obs1,obs2),yvar])R>x2l<-lapply(xl,function(x)x[c(obs1,obs2),xvar])ReferencesCapezzaC,LeporeA,MenafoglioA,PalumboB,VantiniS(2020).“ControlchartsformonitoringshipoperatingconditionsandCO2emissionsbasedon5scalar-on-functionregression.”AppliedStochasticModelsinBusinessandIndustry,36(3),477–500.CentofantiF,LeporeA,MenafoglioA,PalumboB,VantiniS(2021).“FunctionalRegressionControlChart.”Technometrics,63(3),281–294.6